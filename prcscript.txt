Press <Enter> to continue...
CREATE OR REPLACE PROCEDURE CUST_INS AS
M_CUST_CODE          VARCHAR2(6);
M_CUST_CTL_ACNT_CODE VARCHAR2(20);
CURSOR C1 IS
SELECT CUST_CODE FROM PM_CUSTOMER
MINUS
SELECT CUST_CODE FROM FM_CUSTOMER;
CURSOR C2 IS
SELECT CCLAS_CTL_ACNT_CODE
FROM PM_CUST_CLASS
WHERE CCLAS_CODE = (SELECT CUST_CLASS
                    FROM PM_CUSTOMER
                    WHERE CUST_CODE = M_CUST_CODE);
BEGIN
   OPEN C1;
   LOOP
      FETCH C1 INTO M_CUST_CODE;
      EXIT WHEN C1%NOTFOUND;
      OPEN C2;
      FETCH C2 INTO M_CUST_CTL_ACNT_CODE;
      CLOSE C2;
      INSERT INTO FM_CUSTOMER (CUST_CODE,
                              CUST_NAME,
                              CUST_SHORT_NAME,
                              CUST_ADD_1,
                              CUST_ADD_2,
                              CUST_ADD_3,
                              CUST_COUNTRY,
                              CUST_PHONE,
                              CUST_TELEX_FAX,
                              CUST_MAIN_ACNT_CODE,
                              CUST_CONTACT,
                              CUST_AREA,
                              CUST_CR_UID,
                              CUST_CR_DT,
                              CUST_FRZ_FLAG)
              SELECT 	      CUST_CODE,
                              CUST_SHORT_NAME,
                              SUBSTR(CUST_SHORT_NAME,1,15),
                              CUST_ADDR1,
			      CUST_ADDR2,
                              CUST_ADDR3,
                              CUST_COUNTRY,
                              CUST_PHONE,
                              CUST_FAX,
                              M_CUST_CTL_ACNT_CODE,
                              SUBSTR(CUST_CONTACT,1,15),
                              CUST_AREA,
                              CUST_CR_UID,
                              CUST_CR_DT,
                              CUST_FRZ_FLAG
              FROM PM_CUSTOMER
              where CUST_CODE = M_CUST_CODE;
    END LOOP;
    CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE DELALL ( P_POL_NO IN VARCHAR) IS
m_pol_sys_Id  number(10);
m_clm_sys_Id  number(10);
m_temp        number ;
m_ctr         number := 0;
cursor c1 is
       select pol_sys_Id
       from   pt_policy
       where  pol_no =  p_pol_no ;
cursor c2 is
       select 1
       from   ps_drcr, ft_cur_trans_header
       where  drcr_pol_sys_id = m_pol_sys_id
       and    drcr_txn_code = th_tran_code
       and    drcr_doc_no   = th_doc_no
       and    drcr_doc_dt   = th_doc_dt ;
cursor c3 is
       select clm_sys_Id
       from   pt_claim
       where  clm_pol_sys_id = m_pol_sys_id ;
begin
   open c1 ;
   fetch c1 into m_pol_sys_Id ;
   close c1 ;
   if m_pol_sys_Id is null then
      dbms_output.put_line('***********************************************');
      dbms_output.put_line('*                                             *');
      dbms_output.put_line('*  ERROR :  Invalid Policy Number. Try Again. *');
      dbms_output.put_line('*                                             *');
      dbms_output.put_line('***********************************************');
      return;
   else
      open c2 ;
      fetch c2 into m_temp ;
      close c2 ;
      if m_temp is not null then
         dbms_output.put_line('********************************************');
         dbms_output.put_line('*                                          *');
         dbms_output.put_line('*  STOP : Policy Has Posted Accounting     *');
         dbms_output.put_line('*         Transactions.  Cannot Delete.    *');
         dbms_output.put_line('*                                          *');
         dbms_output.put_line('********************************************');
         return ;
      else
         delete pt_cheque_detl where cqd_pol_sys_id = m_pol_sys_id;
         delete pt_op_appl_cust where opac_pol_sys_id = m_pol_sys_id;
         delete ph_op_appl_cust where opach_pol_sys_id = m_pol_sys_id;
         delete pt_aircraft where air_pol_sys_Id  = m_pol_sys_Id;
         delete ph_aircraft where airh_pol_sys_Id  = m_pol_sys_Id;
         delete from pt_pol_charge where chg_pol_sys_Id  = m_pol_sys_Id;
         delete from ph_pol_charge where chgh_pol_sys_Id = m_pol_sys_Id;
         delete pt_pol_assured_dtl where pad_pol_sys_id = m_pol_sys_Id ;
         delete ph_pol_assured_dtl where padh_pol_sys_id = m_pol_sys_Id ;
         delete pt_pol_broker where pb_pol_sys_Id  = m_pol_sys_id;
         delete ph_pol_broker where pbh_pol_sys_Id = m_pol_sys_id;
         delete pt_vehicle_addl_dtl
         where  vad_veh_sys_id in (select veh_sys_id
                                   from   pt_vehicle
                                   where  veh_pol_sys_id = m_pol_sys_Id);
         delete ph_vehicle_addl_dtl
         where  vadh_veh_sys_id in (select veh_sys_id
                                   from   pt_vehicle
                                   where  veh_pol_sys_id = m_pol_sys_Id);
         delete  pt_vehicle  where veh_pol_sys_Id  = m_pol_sys_Id ;
         delete  ph_vehicle  where vehh_pol_sys_Id = m_pol_sys_Id ;
         delete  pt_driver where drv_pol_sys_id  = m_pol_sys_Id ;
         delete  ph_driver where drvh_pol_sys_id = m_pol_sys_Id ;
         delete  pt_cover_discount
         where   cd_cover_sys_id in (select pcvr_sys_id
                                     from   pt_pol_cover
                                     where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  ph_cover_discount
         where   cdh_cover_sys_id in (select pcvr_sys_id
                                      from   pt_pol_cover
                                      where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  pt_ded_loss
         where   dl_cover_sys_id in (select pcvr_sys_id
                                     from   pt_pol_cover
                                     where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  ph_ded_loss
         where   dlh_cover_sys_id in (select pcvr_sys_id
                                      from   pt_pol_cover
                                      where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete pt_pol_cover where pcvr_pol_sys_id  = m_pol_sys_Id ;
         delete ph_pol_cover where pcvrh_pol_sys_id = m_pol_sys_Id ;
         delete pt_condition where cond_pol_sys_id  = m_pol_sys_Id ;
         delete ph_condition where condh_pol_sys_id = m_pol_sys_Id ;
         delete pt_policy_schedule where psc_pol_sys_id  = m_pol_sys_id ;
         delete pt_inst_prem where ip_pol_sys_id  = m_pol_sys_id ;
         delete ph_inst_prem where iph_pol_sys_id = m_pol_sys_id ;
         delete pt_risk where risk_pol_sys_id = m_pol_sys_id ;
         delete ph_risk where riskh_pol_sys_id = m_pol_sys_id ;
         delete pt_fac_in_comm_tax
         where  fict_fi_sys_id in (select fi_sys_id
                                   from   pt_fac_in
                                   where  fi_pol_sys_id = m_pol_sys_id );
         delete ph_fac_in_comm_tax
         where  ficth_fi_sys_id in (select fi_sys_id
                                    from   pt_fac_in
                                    where  fi_pol_sys_id = m_pol_sys_id );
         delete pt_fac_in where fi_pol_sys_id  = m_pol_sys_id ;
         delete ph_fac_in where fih_pol_sys_id = m_pol_sys_id ;
         delete pt_fac_cust_retro
         where  fcr_fpcu_sys_id in (select fpcu_sys_id
                                    from   pt_fac_part_cust , pt_fac_out
                                    where  fpcu_fo_sys_id = fo_sys_Id
                                    and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete ph_fac_cust_retro
         where  fcrh_fpcu_sys_id in (select fpcu_sys_id
                                     from   pt_fac_part_cust , pt_fac_out
                                     where  fpcu_fo_sys_id = fo_sys_Id
                                     and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete pt_fac_Deduction
         where  fd_fpcu_sys_id in (select fpcu_sys_id
                                   from   pt_fac_part_cust , pt_fac_out
                                   where  fpcu_fo_sys_id = fo_sys_Id
                                   and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete ph_fac_Deduction
         where  fdh_fpcu_sys_id in (select fpcu_sys_id
                                    from   pt_fac_part_cust , pt_fac_out
                                    where  fpcu_fo_sys_id = fo_sys_Id
                                    and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete pt_fac_part_cust
         where  fpcu_fo_sys_id in (select fo_sys_id
  	         	          from   pt_fac_out
                                   where  fo_pol_sys_id = m_pol_sys_id) ;
         delete ph_fac_part_cust
         where  fpcuh_fo_sys_id in (select fo_sys_id
  	        	           from   pt_fac_out
                                    where  fo_pol_sys_id = m_pol_sys_id) ;
         delete pt_fac_out where fo_pol_sys_id  = m_pol_sys_Id ;
         delete ph_fac_out where foh_pol_sys_id = m_pol_sys_Id ;
         delete pt_maint_period  where mp_pol_sys_id  = m_pol_sys_id ;
         delete ph_maint_period  where mph_pol_sys_id = m_pol_sys_id ;
         delete pt_open_policy  where op_pol_sys_id  = m_pol_sys_Id ;
         delete ph_open_policy  where oph_pol_sys_id = m_pol_sys_Id ;
         delete pt_ship_good
         where  sg_ship_sys_id in (select ship_sys_id
                                   from   pt_shipment
 		        	  where  ship_pol_sys_id = m_pol_sys_Id ) ;
         delete ph_ship_good
         where  sgh_ship_sys_id in (select ship_sys_id
                                    from   pt_shipment
 	                           where  ship_pol_sys_id = m_pol_sys_Id ) ;
         delete pt_shipment where ship_pol_sys_id  = m_pol_sys_id ;
         delete ph_shipment where shiph_pol_sys_id = m_pol_sys_id ;
         delete pt_vessel  where ves_pol_sys_id  = m_pol_sys_id ;
         delete ph_vessel  where vesh_pol_sys_id = m_pol_sys_id ;
         delete pt_policy_appl_curr where pac_pol_sys_id  = m_pol_sys_Id ;
         delete ph_policy_appl_curr where pach_pol_sys_id = m_pol_sys_Id ;
         delete ps_audit_trail where at_pol_sys_id = m_pol_sys_id;
         delete ps_fac_prem_part_cust where fppc_pol_sys_id = m_pol_sys_id;
         delete ps_prem_reg_si where prs_pol_sys_Id = m_pol_sys_Id ;
         delete pt_ri_Cession  where rc_pol_sys_Id  = m_pol_sys_Id ;
         delete ps_prem_reg  where  pr_pol_sys_Id = m_pol_sys_Id ;
         delete ps_prem_ri_reg  where  prr_pol_sys_Id = m_pol_sys_Id ;
         delete ps_fac_ri where fr_pol_sys_Id = m_pol_sys_Id ;
         delete ps_drcr where drcr_pol_sys_Id  = m_pol_sys_Id ;
         delete pt_ri_prem_alloc  where rpa_pol_sys_id = m_pol_sys_Id;
         delete pt_xl_prem_alloc  where xpa_pol_sys_Id = m_pol_sys_Id ;
----- Claims Related Tables Begin -------
         open c3 ;
         loop
         fetch c3 into m_clm_sys_Id ;
         exit when c3%notfound ;
            m_ctr := m_ctr + 1 ;
            delete pt_claim_invoice_detail
            where  cid_cih_sys_id in (select cih_sys_id
                                      from   pt_claim_invoice_head
                                      where  cih_clm_sys_id = m_clm_sys_id);
            delete pt_claim_invoice_head where  cih_clm_sys_id = m_clm_sys_id;
            delete pt_claim_lpo_detail
            where  cld_clh_sys_id in (select clh_sys_id
                                      from   pt_claim_lpo_head
                                      where  clh_clm_sys_id = m_clm_sys_id);
            delete pt_claim_lpo_head where clh_clm_sys_id = m_clm_sys_id;
            delete pt_claim_status where cs_clm_sys_id = m_clm_sys_id;
            delete pt_accident where acc_clm_sys_Id = m_clm_sys_Id ;
            delete pt_injured where inj_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_recovery where cr_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claims_tp where ctp_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_paid  where cp_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_estimate where ce_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_schedule where cs_clm_sys_Id = m_clm_sys_Id ;
            delete pt_ri_claim_alloc where rca_clm_sys_Id = m_clm_sys_Id ;
            delete pt_xl_claim_alloc where xca_clm_sys_Id = m_clm_sys_Id ;
            delete ps_fac_claim_part_cust where fcpc_clm_sys_Id = m_clm_sys_Id ;
            delete pt_fac_claim_part_cust_paid where fcpcp_clm_sys_id = m_clm_sys_id;
            delete pt_fac_claim_part_cust_est  where fcpce_clm_sys_id = m_clm_sys_id;
            delete ps_ri_claim_reg where rcr_clm_sys_Id = m_clm_sys_id ;
            delete ps_xl_claim_reg where xcr_clm_sys_Id = m_clm_sys_id ;
         end loop ;
         close c3 ;
         if m_ctr > 0 then
            dbms_output.put_line( chr(10));
            dbms_output.put_line( '!! ' || to_char(m_ctr) ||' Claims encountered for deletion. ');
            dbms_output.put_line( chr(10));
         end if ;
         delete pt_claim where clm_pol_sys_Id = m_pol_sys_id ;
----  Claims Related Tables End --------
         delete pt_policy  where  pol_sys_Id   =  m_pol_sys_Id  ;
         delete ph_policy  where  polh_sys_Id  =  m_pol_sys_Id  ;
         dbms_output.put_line('**************************************************');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('*  !!!   Policy (Endts./Claims if any) Is        *');
         dbms_output.put_line('*        Being Totally Removed From PREMIA.      *');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('*  Type  COMMIT;    - Confirm Deletion           *');
         dbms_output.put_line('*        ROLLBACK;  - Undo Deletion              *');
         dbms_output.put_line('*        EXIT;      - Confirm Deletion and Exit  *');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('**************************************************');
      end if ;
   end if;
end;
/
CREATE OR REPLACE PROCEDURE DRCR_UPD
is
cursor c1 is
select pol_sys_Id,pol_cust_code, drcr_doc_no,drcr_txn_code
from  pt_policy, ps_drcr
where pol_sys_Id = drcr_pol_sys_id
and   drcr_end_no_idx = 0
and   drcr_claim_no is not null
and   drcr_sub_acnt_code is not null
and   drcr_cust_code is null;
ctr number(3) := 0;
begin
   for c1_rec in c1
   loop
       dbms_output.put_line('entering  ');
        exit when c1%notfound;
       dbms_output.put_line('ctr  ' || to_char(ctr));
       update ps_drcr set drcr_cust_code = c1_rec.pol_cust_code
       where drcr_pol_sys_Id = c1_rec.pol_sys_Id
       and drcr_doc_no = c1_rec.drcr_doc_no
       and drcr_txn_code = c1_rec.drcr_txn_code
       and drcr_end_no_idx = 0
       and drcr_sub_acnt_code is not null
       and drcr_cust_code is null;
   dbms_output.put_line(to_char(c1_rec.drcr_doc_no) || '   ' || c1_rec.drcr_txn_code);
   ctr := ctr + 1;
   end loop;
   dbms_output.put_line(to_char(ctr) || 'rows updated');
end;
/
CREATE OR REPLACE FUNCTION EUL_GET_ITEM_NAME(QSID IN NUMBER) RETURN VARCHAR2 IS ITMID VARCHAR2(2000):=NULL; STARTPT BINARY_INTEGER :=1; BMP LONG RAW; POS BINARY_INTEGER :=0; CTR BINARY_INTEGER :=0; CHKLGTH BINARY_INTEGER; HEXSTRING VARCHAR2(10); HEXID BINARY_INTEGER :=0; DECNIBBLE1 NUMBER; DECNIBBLE2
 BINARY_INTEGER; DECNIBBLE3 BINARY_INTEGER; DECNIBBLE4 BINARY_INTEGER; DECNIBBLE5 BINARY_INTEGER; DECNIBBLE6 BINARY_INTEGER; DECNIBBLE7 BINARY_INTEGER; DECNIBBLE8 BINARY_INTEGER; DECNIBBLE9 BINARY_INTEGER; DECNIBBLE10 BINARY_INTEGER; HEXCHAR VARCHAR2(1); EXPID BINARY_INTEGER; AGGTYPE BINARY_INTEGER;
NIBBLEZERO BOOLEAN; NOEMPTYBLKS BINARY_INTEGER:=10; CURSOR DBMP IS SELECT QS_DBMP0||QS_DBMP1||QS_DBMP2||QS_DBMP3||QS_DBMP4||QS_DBMP5||QS_DBMP6||QS_DBMP7 FROM EUL_QPP_STATISTICS WHERE QS_ID = QSID; CURSOR MBMP IS SELECT QS_MBMP0||QS_MBMP1||QS_MBMP2||QS_MBMP3||QS_MBMP4||QS_MBMP5||QS_MBMP6||QS_MBMP7 FRO
M EUL_QPP_STATISTICS WHERE QS_ID = QSID; BEGIN FOR ITYPE IN 1..2 LOOP IF ITYPE = 1 THEN OPEN DBMP; ELSE OPEN MBMP; END IF; HEXID:=0; WHILE HEXID <> NOEMPTYBLKS LOOP IF ITYPE = 1 THEN FETCH DBMP INTO BMP; ELSE FETCH MBMP INTO BMP; END IF; CTR:=CTR+1; POS:=POS+10; IF POS=4090 THEN HEXID:= NOEMPTYBLKS;
STARTPT:=1; POS:=0; ELSE HEXSTRING:=NVL(SUBSTR(RAWTOHEX(BMP),STARTPT,10),'0000000000'); IF HEXSTRING = '0000000000' THEN HEXID:=HEXID + 1; DECNIBBLE1:=0; DECNIBBLE2:=0; DECNIBBLE3:=0; DECNIBBLE4:=0; DECNIBBLE5:=0; DECNIBBLE6:=0; D

ecnibble7:=0; decnibble8:=0; decnibble9:=0; decnibble10:=0; nibblezero:= TRUE; if hexid = noemptyblks then startpt:=1; pos:=0; end if; else nibblezero:=FALSE; hexchar:=substr(rawtohex(BMP),startpt,1); if hexchar = '0' then decnibble1:=0; elsif hexchar ='A' then decnibble1:=10; elsif hexchar ='B' then
 decnibble1:=11; elsif hexchar ='C' then decnibble1:=12; elsif hexchar ='D' then decnibble1:=13; elsif hexchar ='E' then decnibble1:=14; elsif hexchar ='F' then decnibble1:=15; else decnibble1:=to_number(hexchar); end if; hexchar:=substr(rawtohex(BMP),startpt+1,1); if hexchar = '0' then decnibble2:=0
; elsif hexchar ='A' then decnibble2:=10; elsif hexchar ='B' then decnibble2:=11; elsif hexchar ='C' then decnibble2:=12; elsif hexchar ='D' then decnibble2:=13; elsif hexchar ='E' then decnibble2:=14; elsif hexchar ='F' then decnibble2:=15; else decnibble2:=to_number(hexchar); end if; hexchar:=subst
r(rawtohex(BMP),startpt+2,1); if hexchar = '0' then decnibble3:=0; elsif hexchar ='A' then decnibble3:=10; elsif hexchar ='B' then decnibble3:=11; elsif hexchar ='C' then decnibble3:=12; elsif hexchar ='D' then decnibble3:=13; elsif hexchar ='E' then decnibble3:=14; elsif hexchar ='F' then decnibble3
:=15; else decnibble3:=to_number(hexchar); end if; hexchar:= substr(rawtohex(BMP),startpt+3,1); if hexchar = '0' then decnibble4:=0; elsif hexchar ='A' then decnibble4:=10; elsif hexchar ='B' then decnibble4:=11;

 elsif hexchar ='C' then decnibble4:=12; elsif hexchar ='D' then decnibble4:=13; elsif hexchar ='E' then decnibble4:=14; elsif hexchar ='F' then decnibble4:=15; else decnibble4:=to_number(hexchar); end if; hexchar :=substr(rawtohex(BMP),startpt+4,1); if hexchar = '0' then decnibble5:=0; elsif hexchar
 ='A' then decnibble5:=10; elsif hexchar ='B' then decnibble5:=11; elsif hexchar ='C' then decnibble5:=12; elsif hexchar ='D' then decnibble5:=13; elsif hexchar ='E' then decnibble5:=14; elsif hexchar ='F' then decnibble5:=15; else decnibble5:=to_number(hexchar ); end if; hexchar := substr(rawtohex(B
MP),startpt+5,1); if hexchar = '0' then decnibble6:=0; elsif hexchar ='A' then decnibble6:=10; elsif hexchar='B' then decnibble6:=11; elsif hexchar='C' then decnibble6:=12; elsif hexchar='D' then decnibble6:=13; elsif hexchar='E' then decnibble6:=14; elsif hexchar='F' then decnibble6:=15; else decnib
ble6:=to_number(hexchar); end if; hexchar := substr(rawtohex(BMP),startpt+6,1); if hexchar = '0' then decnibble7:=0; elsif hexchar ='A' then decnibble7:=10; elsif hexchar='B' then decnibble7:=11; elsif hexchar='C' then decnibble7:=12; elsif hexchar='D' then decnibble7:=13; elsif hexchar='E' then decn
ibble7:=14; elsif hexchar='F' then decnibble7:=15; else decnibble7:=to_number(hexchar); end if; hexchar :=substr(rawtohex(BMP),startpt+7,1); if hexchar = '0' then decnibble8:=0; elsif hexchar ='A' then decnibble8

:=10; elsif hexchar='B' then decnibble8:=11; elsif hexchar='C' then decnibble8:=12; elsif hexchar='D' then decnibble8:=13; elsif hexchar='E' then decnibble8:=14; elsif hexchar='F' then decnibble8:=15; else decnibble8:=to_number(hexchar); end if; hexchar:= substr(rawtohex(BMP),startpt+8,1); if hexchar
 = '0' then decnibble9:=0; elsif hexchar ='A' then decnibble9:=10; elsif hexchar='B' then decnibble9:=11; elsif hexchar='C' then decnibble9:=12; elsif hexchar='D' then decnibble9:=13; elsif hexchar='E' then decnibble9:=14; elsif hexchar='F' then decnibble9:=15; else decnibble9:=to_number(hexchar); en
d if; if itype = 2 then hexchar :=substr(rawtohex(BMP),startpt+9,1); if hexchar = '0' then decnibble10:=0; elsif hexchar ='A' then decnibble10:=10; elsif hexchar='B' then decnibble10:=11; elsif hexchar='C' then decnibble10:=12; elsif hexchar='D' then decnibble10:=13; elsif hexchar='E' then decnibble1
0:=14; elsif hexchar='F' then decnibble10:=15; else decnibble10:=to_number(hexchar); end if; end if; if nibblezero = FALSE then decnibble1:=decnibble1*2; if decnibble2 > 7 then decnibble1:=decnibble1+1; decnibble2:=decnibble2-8; end if; decnibble1:=decnibble1 * 268435456; decnibble2:=decnibble2 * 2;
if decnibble3 > 7 then decnibble2:=decnibble2+1; decnibble3:=decnibble3-8; end if; decnibble2:=decnibble2 * 16777216; decnibble3:=decnibble3*2; if decnibble4 > 7 then decnibble3:=decnibble3+1; decnibble4:=decnibb

le4-8; end if; decnibble3:=decnibble3 * 1048576; decnibble4:=decnibble4*2; if decnibble5 > 7 then decnibble4:=decnibble4+1; decnibble5:=decnibble5-8; end if; decnibble4:=decnibble4 * 65536; decnibble5:=decnibble5*2; if decnibble6 > 7 then decnibble5:=decnibble5+1; decnibble6:=decnibble6-8; end if; de
cnibble5:=decnibble5 * 4096; decnibble6:=decnibble6*2; if decnibble7 > 7 then decnibble6:=decnibble6+1; decnibble7:=decnibble7-8; end if; decnibble6:=decnibble6 * 256; decnibble7:=decnibble7*2; if decnibble8 > 7 then decnibble7:=decnibble7+1; decnibble8:=decnibble8-8; end if; decnibble7:=decnibble7 *
 16; decnibble8:=decnibble8*2; if decnibble9 > 7 then decnibble8:=decnibble8+1; decnibble9:=decnibble9-8; end if; if itype=2 then if decnibble9>0 then decnibble9:=(decnibble9-2)*8; end if; decnibble10:=decnibble9+(decnibble10/2); end if; expid:= decnibble1 + decnibble2 + decnibble3 + decnibble4 + dec
nibble5 + decnibble6 + decnibble7 + decnibble8; end if; end if; end if; startpt:=pos+1; if nibblezero = FALSE then if itype =1 then if nvl(length(itmid),0)=0 then itmid:=to_char(expid)||',0'; else chklgth:= length(itmid)+length(to_char(expid))+3; if chklgth > 1999 then itmid:=itmid||'*'; exit; else i
tmid:=itmid||'.'||to_char(expid)||',0'; end if; end if; else chklgth:= nvl(length(itmid),0)+length(to_char(expid))+3; if chklgth > 1999 then itmid:=itmid||'*'; exit; elsif chklgth =length(to_char(expid))+3 then i

tmid:=to_char(expid)||','||to_char(decnibble10); else itmid:=itmid||'.'||to_char(expid)||','||to_char(decnibble10); end if; end if; end if; end loop; if itype = 1 then close dbmp; else close mbmp; end if; end loop; return itmid; end EUL_GET_ITEM_NAME;
/
CREATE OR REPLACE FUNCTION EUL_GET_OBJECT_NAME(USEKEY IN VARCHAR2, TYPEKEY IN VARCHAR2) RETURN VARCHAR2 IS ONAME VARCHAR2(2000); STARTPT NUMBER :=1; ENDPT NUMBER :=LENGTH(USEKEY); POS NUMBER :=1; CTR NUMBER :=0; CHKLGTH NUMBER; OBJID NUMBER; AGGTYPE NUMBER; OBJNAME VARCHAR2(100); CURSOR FOLDER IS SEL
ECT OBJ_NAME FROM EUL_OBJS WHERE OBJ_ID = OBJID; CURSOR ITEM IS SELECT EXP_NAME FROM EUL_EXPRESSIONS WHERE EXP_ID = OBJID; BEGIN WHILE POS <> 0 LOOP AGGTYPE:=0; CTR:=CTR+1; POS:=INSTR(USEKEY,'.',1,CTR); IF POS=0 THEN IF UPPER(TYPEKEY)='F' THEN OBJID:= TO_NUMBER(SUBSTR(USEKEY,STARTPT,(ENDPT-STARTPT+1)
)); ELSE OBJID:= TO_NUMBER(SUBSTR(USEKEY,STARTPT,(ENDPT-STARTPT-1))); AGGTYPE:= TO_NUMBER(SUBSTR(USEKEY,ENDPT,1)); END IF; ELSE IF UPPER(TYPEKEY)='F' THEN OBJID:= TO_NUMBER(SUBSTR(USEKEY,STARTPT,(POS-STARTPT))); ELSE OBJID:= TO_NUMBER(SUBSTR(USEKEY,STARTPT,(POS-STARTPT-2))); AGGTYPE:= TO_NUMBER(SUBST
R(USEKEY,POS-1,1)); END IF; STARTPT:=POS+1; END IF; IF UPPER(TYPEKEY) ='F' THEN OPEN FOLDER; FETCH FOLDER INTO OBJNAME; CLOSE FOLDER; END IF; IF UPPER(TYPEKEY)='I' THEN OPEN ITEM; FETCH ITEM INTO OBJNAME; CLOSE ITEM; END IF; IF CTR=1 THEN IF AGGTYPE=0 THEN ONAME:=OBJNAME; ELSIF AGGTYPE=1 THEN ONAME:=
OBJNAME||' SUM'; ELSIF AGGTYPE=2 THEN ONAME:=OBJNAME||' AVG'; ELSIF AGGTYPE=3 THEN ONAME:=OBJNAME||' COUNT'; ELSIF AGGTYPE=4 THEN ONAME:=OBJNAME||' MAX'; ELSIF AGGTYPE=5 THEN ONAME:=OBJNAME||' MIN'; ELSE ONAME:=OBJNAME; END IF; EL

se if aggtype=0 then chklgth:= length(oname)+length(objname)+2; elsif aggtype=1 then chklgth:= length(oname)+length(objname)+6; elsif aggtype=2 then chklgth:= length(oname)+length(objname)+6; elsif aggtype=3 then chklgth:= length(oname)+length(objname)+8; elsif aggtype=4 then chklgth:= length(oname)+
length(objname)+6; elsif aggtype=5 then chklgth:= length(oname)+length(objname)+6; else chklgth:= length(oname)+length(objname)+2; end if; if chklgth > 1999 then oname:=oname||'*'; exit; else if aggtype = 0 then oname:=oname||', '||objname; elsif aggtype=1 then oname:=oname||', '||objname||' SUM'; el
sif aggtype=2 then oname:=oname||', '||objname||' AVG'; elsif aggtype=3 then oname:=oname||', '||objname||' COUNT'; elsif aggtype=4 then oname:=oname||', '||objname||' MAX'; elsif aggtype=5 then oname:=oname||', '||objname||' MIN'; else oname:=oname||', '||objname; end if; end if; end if; end loop; r
eturn oname; end EUL_GET_OBJECT_NAME;

CREATE OR REPLACE PROCEDURE FOREX_ADJ
/
          (M_COMP_CODE       IN  VARCHAR2,
           M_USER_ID         IN  VARCHAR2) AS
S_OST_KEY_NO                         NUMBER(8);
S_OST_COMP_CODE                      VARCHAR2(3);
S_OST_TRAN_CODE                      VARCHAR2(3);
S_OST_DOC_NO                         NUMBER(6);
S_OST_SEQ_NO                         NUMBER(3);
S_OST_ACNT_YEAR                      NUMBER(2);
S_OST_DOC_DT                         DATE;
S_OST_DOC_CAL_YEAR                   NUMBER(2);
S_OST_DOC_CAL_MONTH                  NUMBER(2);
S_OST_DUE_DT                         DATE;
S_OST_MAIN_ACNT_CODE                 VARCHAR2(6);
S_OST_SUB_ACNT_CODE                  VARCHAR2(6);
S_OST_DIVN_CODE                      VARCHAR2(6);
S_OST_DEPT_CODE                      VARCHAR2(6);
S_OST_HEAD_NO_1                      NUMBER(1);
S_OST_ANLY_CODE_1                    VARCHAR2(6);
S_OST_HEAD_NO_2                      NUMBER(1);
S_OST_ANLY_CODE_2                    VARCHAR2(6);
S_OST_ACTY_CODE_1                    VARCHAR2(6);
S_OST_ACTY_CODE_2                    VARCHAR2(6);
S_OST_CURR_CODE                      VARCHAR2(3);
S_OST_LC_AMT                         NUMBER(14,3);
S_OST_FC_AMT                         NUMBER(14,3);
S_OST_DRCR_FLAG                      VARCHAR2(1);
S_OST_DOC_REF                        VARCHAR2(15);
S_OST_DOC_REF_DT                     DATE;
S_OST_OTH_REF                        VARCHAR2(15);
S_OST_LC_ADJ_AMT                     NUMBER(14,3);
S_OST_FC_ADJ_AMT                     NUMBER(14,3);
S_OST_LC_PDC_AMT                     NUMBER(14,3);
S_OST_FC_PDC_AMT                     NUMBER(14,3);
S_OST_LC_UNP_AMT                     NUMBER(14,3);
S_OST_FC_UNP_AMT                     NUMBER(14,3);
S_OST_LC_UNDEP_AMT                   NUMBER(14,3);
S_OST_FC_UNDEP_AMT                   NUMBER(14,3);
S_OST_LC_ORG_AMT                     NUMBER(14,3);
S_OST_FC_ORG_AMT                     NUMBER(14,3);
S_OST_REF_KEY_NO                     NUMBER(8);
S_OST_REF_COMP_CODE                  VARCHAR2(3);
S_OST_REF_ACNT_YEAR                  NUMBER(2);
S_OST_REF_TRAN_CODE                  VARCHAR2(3);
S_OST_REF_SEQ_NO                     NUMBER(3);
S_OST_REF_DOC_NO                     NUMBER(6);
S_OST_REF_DOC_DT                     DATE;
S_OST_REF_DOC_CAL_YEAR               NUMBER(2);
S_OST_REF_DOC_CAL_MONTH              NUMBER(2);
S_OST_REF_DUE_DT                     DATE;
S_OST_LAST_MATCH_DT                  DATE;
S_OST_TYPE                           VARCHAR2(1);
S_OST_CR_UID                         VARCHAR2(10);
S_OST_CR_DT                          DATE;
T_OST_KEY_NO                         NUMBER(8);
T_OST_COMP_CODE                      VARCHAR2(3);
T_OST_TRAN_CODE                      VARCHAR2(3);
T_OST_DOC_NO                         NUMBER(6);
T_OST_SEQ_NO                         NUMBER(3);
T_OST_ACNT_YEAR                      NUMBER(2);
T_OST_DOC_DT                         DATE;
T_OST_DOC_CAL_YEAR                   NUMBER(2);
T_OST_DOC_CAL_MONTH                  NUMBER(2);
T_OST_DUE_DT                         DATE;
T_OST_MAIN_ACNT_CODE                 VARCHAR2(6);
T_OST_SUB_ACNT_CODE                  VARCHAR2(6);
T_OST_DIVN_CODE                      VARCHAR2(6);
T_OST_DEPT_CODE                      VARCHAR2(6);
T_OST_HEAD_NO_1                      NUMBER(1);
T_OST_ANLY_CODE_1                    VARCHAR2(6);
T_OST_HEAD_NO_2                      NUMBER(1);
T_OST_ANLY_CODE_2                    VARCHAR2(6);
T_OST_ACTY_CODE_1                    VARCHAR2(6);
T_OST_ACTY_CODE_2                    VARCHAR2(6);
T_OST_CURR_CODE                      VARCHAR2(3);
T_OST_LC_AMT                         NUMBER(14,3);
T_OST_FC_AMT                         NUMBER(14,3);
T_OST_DRCR_FLAG                      VARCHAR2(1);
T_OST_DOC_REF                        VARCHAR2(15);
T_OST_DOC_REF_DT                     DATE;
T_OST_OTH_REF                        VARCHAR2(15);
T_OST_LC_ADJ_AMT                     NUMBER(14,3);
T_OST_FC_ADJ_AMT                     NUMBER(14,3);
T_OST_LC_PDC_AMT                     NUMBER(14,3);
T_OST_FC_PDC_AMT                     NUMBER(14,3);
T_OST_LC_UNP_AMT                     NUMBER(14,3);
T_OST_FC_UNP_AMT                     NUMBER(14,3);
T_OST_LC_UNDEP_AMT                   NUMBER(14,3);
T_OST_FC_UNDEP_AMT                   NUMBER(14,3);
T_OST_LC_ORG_AMT                     NUMBER(14,3);
T_OST_FC_ORG_AMT                     NUMBER(14,3);
T_OST_REF_KEY_NO                     NUMBER(8);
T_OST_REF_COMP_CODE                  VARCHAR2(3);
T_OST_REF_ACNT_YEAR                  NUMBER(2);
T_OST_REF_TRAN_CODE                  VARCHAR2(3);
T_OST_REF_SEQ_NO                     NUMBER(3);
T_OST_REF_DOC_NO                     NUMBER(6);
T_OST_REF_DOC_DT                     DATE;
T_OST_REF_DOC_CAL_YEAR               NUMBER(2);
T_OST_REF_DOC_CAL_MONTH              NUMBER(2);
T_OST_REF_DUE_DT                     DATE;
T_OST_LAST_MATCH_DT                  DATE;
T_OST_TYPE                           VARCHAR2(1);
T_OST_CR_UID                         VARCHAR2(10);
T_OST_CR_DT                          DATE;
P_OST_KEY_NO          NUMBER(8);
Q_OST_KEY_NO          NUMBER(8);
REF_OST_KEY_NO        NUMBER(8);
P_CUR_ACNT_YEAR                      NUMBER(3);
P_ACNT_YEAR                          NUMBER(3);
P_ERR_NO                             NUMBER(6);
P_FIRST                              VARCHAR2(1);
P_XDIFF_MAIN_ACNT_CODE               VARCHAR2(6);
P_XDIFF_TRAN_CODE                    VARCHAR2(3);
P_XDIFF_DOC_NO                       NUMBER(6);
P_XDIFF_DOC_DT                       DATE;
P_XDIFF_SEQ_NO                       NUMBER(3);
P_XDIFF_DOC_CAL_YEAR                 NUMBER(2);
P_XDIFF_DOC_CAL_MONTH                NUMBER(2);
P_XDIFF_CURR_CODE                    VARCHAR2(3);
P_XDIFF_CURR_COUNT                   NUMBER(3);
P_XDIFF_LC_AMT                       NUMBER(14,3);
P_XDIFF_DRCR_FLAG                    VARCHAR2(1);
ORGL_R_ENTRY_LC_AMT                  NUMBER(14,3);
CURR_R_ENTRY_LC_AMT                  NUMBER(14,3);
CURSOR SEL_XDIFF_TC IS
       SELECT SUBSTR(PARA_VALUE,1,3)
       FROM   FP_PARAMETER
       WHERE  PARA_ID = 'XDIFF.JV';
CURSOR SEL_XDIFF_AC IS
       SELECT SUBSTR(PARA_VALUE,1,6)
       FROM   FP_PARAMETER
       WHERE  PARA_ID = 'XDIFF.AC';
CURSOR SEL_MATCH_OS IS
       SELECT OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE,
              OST_DOC_NO, OST_SEQ_NO, OST_ACNT_YEAR,
              OST_DOC_DT, OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
              OST_DUE_DT, OST_MAIN_ACNT_CODE, OST_SUB_ACNT_CODE,
              OST_DIVN_CODE, OST_DEPT_CODE, OST_HEAD_NO_1,
              OST_ANLY_CODE_1, OST_HEAD_NO_2, OST_ANLY_CODE_2,
              OST_ACTY_CODE_1, OST_ACTY_CODE_2, OST_CURR_CODE,
              OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
              OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
              OST_LC_ADJ_AMT, OST_FC_ADJ_AMT, OST_LC_PDC_AMT,
              OST_FC_PDC_AMT, OST_LC_UNP_AMT, OST_FC_UNP_AMT,
              OST_LC_UNDEP_AMT, OST_FC_UNDEP_AMT, OST_LC_ORG_AMT,
              OST_FC_ORG_AMT, OST_REF_KEY_NO, OST_REF_COMP_CODE,
              OST_REF_ACNT_YEAR, OST_REF_TRAN_CODE, OST_REF_SEQ_NO,
              OST_REF_DOC_NO, OST_REF_DOC_DT, OST_REF_DOC_CAL_YEAR,
              OST_REF_DOC_CAL_MONTH, OST_REF_DUE_DT, OST_LAST_MATCH_DT,
              OST_TYPE, OST_CR_UID, OST_CR_DT
       FROM   FS_MATCH_OS
       ORDER BY NVL(OST_TYPE,'A')
       FOR UPDATE OF OST_TYPE;
CURSOR SEL_REF_OS IS
       SELECT OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE,
              OST_DOC_NO, OST_SEQ_NO, OST_ACNT_YEAR,
              OST_DOC_DT, OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
              OST_DUE_DT, OST_MAIN_ACNT_CODE, OST_SUB_ACNT_CODE,
              OST_DIVN_CODE, OST_DEPT_CODE, OST_HEAD_NO_1,
              OST_ANLY_CODE_1, OST_HEAD_NO_2, OST_ANLY_CODE_2,
              OST_ACTY_CODE_1, OST_ACTY_CODE_2, OST_CURR_CODE,
              OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
              OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
              OST_LC_ADJ_AMT, OST_FC_ADJ_AMT, OST_LC_PDC_AMT,
              OST_FC_PDC_AMT, OST_LC_UNP_AMT, OST_FC_UNP_AMT,
              OST_LC_UNDEP_AMT, OST_FC_UNDEP_AMT, OST_LC_ORG_AMT,
              OST_FC_ORG_AMT, OST_REF_KEY_NO, OST_REF_COMP_CODE,
              OST_REF_ACNT_YEAR, OST_REF_TRAN_CODE, OST_REF_SEQ_NO,
              OST_REF_DOC_NO, OST_REF_DOC_DT, OST_REF_DOC_CAL_YEAR,
              OST_REF_DOC_CAL_MONTH, OST_REF_DUE_DT, OST_LAST_MATCH_DT,
              OST_TYPE, OST_CR_UID, OST_CR_DT
       FROM FT_OS
       WHERE OST_KEY_NO = S_OST_REF_KEY_NO;
BEGIN
   LOCK TABLE FT_OS IN SHARE UPDATE MODE ;
   IF SEL_MATCH_OS%ISOPEN THEN
      CLOSE SEL_MATCH_OS;
   END IF;
   OPEN SEL_MATCH_OS;
   LOOP
      FETCH SEL_MATCH_OS INTO
            S_OST_KEY_NO, S_OST_COMP_CODE, S_OST_TRAN_CODE,
            S_OST_DOC_NO, S_OST_SEQ_NO, S_OST_ACNT_YEAR,
            S_OST_DOC_DT, S_OST_DOC_CAL_YEAR, S_OST_DOC_CAL_MONTH,
            S_OST_DUE_DT, S_OST_MAIN_ACNT_CODE, S_OST_SUB_ACNT_CODE,
            S_OST_DIVN_CODE, S_OST_DEPT_CODE, S_OST_HEAD_NO_1,
            S_OST_ANLY_CODE_1, S_OST_HEAD_NO_2, S_OST_ANLY_CODE_2,
            S_OST_ACTY_CODE_1, S_OST_ACTY_CODE_2, S_OST_CURR_CODE,
            S_OST_LC_AMT, S_OST_FC_AMT, S_OST_DRCR_FLAG,
            S_OST_DOC_REF, S_OST_DOC_REF_DT, S_OST_OTH_REF,
            S_OST_LC_ADJ_AMT, S_OST_FC_ADJ_AMT, S_OST_LC_PDC_AMT,
            S_OST_FC_PDC_AMT, S_OST_LC_UNP_AMT, S_OST_FC_UNP_AMT,
            S_OST_LC_UNDEP_AMT, S_OST_FC_UNDEP_AMT, S_OST_LC_ORG_AMT,
            S_OST_FC_ORG_AMT, S_OST_REF_KEY_NO, S_OST_REF_COMP_CODE,
            S_OST_REF_ACNT_YEAR, S_OST_REF_TRAN_CODE, S_OST_REF_SEQ_NO,
            S_OST_REF_DOC_NO, S_OST_REF_DOC_DT, S_OST_REF_DOC_CAL_YEAR,
            S_OST_REF_DOC_CAL_MONTH, S_OST_REF_DUE_DT, S_OST_LAST_MATCH_DT,
            S_OST_TYPE, S_OST_CR_UID, S_OST_CR_DT;
      IF SEL_MATCH_OS%NOTFOUND THEN
         EXIT;
      END IF;
      F_OS(P_OST_KEY_NO);
      INSERT INTO FT_OS
             (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE,
              OST_DOC_NO, OST_SEQ_NO, OST_ACNT_YEAR,
              OST_DOC_DT, OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
              OST_DUE_DT, OST_MAIN_ACNT_CODE, OST_SUB_ACNT_CODE,
              OST_DIVN_CODE, OST_DEPT_CODE, OST_HEAD_NO_1,
              OST_ANLY_CODE_1, OST_HEAD_NO_2, OST_ANLY_CODE_2,
              OST_ACTY_CODE_1, OST_ACTY_CODE_2, OST_CURR_CODE,
              OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
              OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
              OST_LC_ADJ_AMT, OST_FC_ADJ_AMT, OST_LC_PDC_AMT,
              OST_FC_PDC_AMT, OST_LC_UNP_AMT, OST_FC_UNP_AMT,
              OST_LC_UNDEP_AMT, OST_FC_UNDEP_AMT, OST_LC_ORG_AMT,
              OST_FC_ORG_AMT, OST_REF_KEY_NO, OST_REF_COMP_CODE,
              OST_REF_ACNT_YEAR, OST_REF_TRAN_CODE, OST_REF_SEQ_NO,
              OST_REF_DOC_NO, OST_REF_DOC_DT, OST_REF_DOC_CAL_YEAR,
              OST_REF_DOC_CAL_MONTH, OST_REF_DUE_DT, OST_LAST_MATCH_DT,
              OST_TYPE, OST_CR_UID, OST_CR_DT)
      VALUES
             (P_OST_KEY_NO, S_OST_COMP_CODE, S_OST_TRAN_CODE,
              S_OST_DOC_NO, S_OST_SEQ_NO, S_OST_ACNT_YEAR,
              S_OST_DOC_DT, S_OST_DOC_CAL_YEAR, S_OST_DOC_CAL_MONTH,
              S_OST_DUE_DT, S_OST_MAIN_ACNT_CODE, S_OST_SUB_ACNT_CODE,
              S_OST_DIVN_CODE, S_OST_DEPT_CODE, S_OST_HEAD_NO_1,
              S_OST_ANLY_CODE_1, S_OST_HEAD_NO_2, S_OST_ANLY_CODE_2,
              S_OST_ACTY_CODE_1, S_OST_ACTY_CODE_2, S_OST_CURR_CODE,
              S_OST_LC_AMT, S_OST_FC_AMT, S_OST_DRCR_FLAG,
              S_OST_DOC_REF, S_OST_DOC_REF_DT, S_OST_OTH_REF,
              S_OST_LC_ADJ_AMT, S_OST_FC_ADJ_AMT, S_OST_LC_PDC_AMT,
              S_OST_FC_PDC_AMT, S_OST_LC_UNP_AMT, S_OST_FC_UNP_AMT,
              S_OST_LC_UNDEP_AMT, S_OST_FC_UNDEP_AMT, S_OST_LC_ORG_AMT,
              S_OST_FC_ORG_AMT, S_OST_REF_KEY_NO, S_OST_REF_COMP_CODE,
              S_OST_REF_ACNT_YEAR, S_OST_REF_TRAN_CODE, S_OST_REF_SEQ_NO,
              S_OST_REF_DOC_NO, S_OST_REF_DOC_DT, S_OST_REF_DOC_CAL_YEAR,
              S_OST_REF_DOC_CAL_MONTH, S_OST_REF_DUE_DT, S_OST_LAST_MATCH_DT,
              S_OST_TYPE, S_OST_CR_UID, S_OST_CR_DT);
      IF S_OST_TYPE IS NULL THEN
         NULL;
      ELSE
         IF S_OST_CURR_CODE IS NULL THEN
            NULL;
         ELSE
            REF_OST_KEY_NO := P_OST_KEY_NO;
            IF SEL_REF_OS%ISOPEN THEN
               CLOSE SEL_REF_OS;
            END IF;
            OPEN SEL_REF_OS;
            FETCH SEL_REF_OS INTO
                  T_OST_KEY_NO, T_OST_COMP_CODE, T_OST_TRAN_CODE,
                  T_OST_DOC_NO, T_OST_SEQ_NO, T_OST_ACNT_YEAR,
                  T_OST_DOC_DT, T_OST_DOC_CAL_YEAR, T_OST_DOC_CAL_MONTH,
                  T_OST_DUE_DT, T_OST_MAIN_ACNT_CODE, T_OST_SUB_ACNT_CODE,
                  T_OST_DIVN_CODE, T_OST_DEPT_CODE, T_OST_HEAD_NO_1,
                  T_OST_ANLY_CODE_1, T_OST_HEAD_NO_2, T_OST_ANLY_CODE_2,
                  T_OST_ACTY_CODE_1, T_OST_ACTY_CODE_2, T_OST_CURR_CODE,
                  T_OST_LC_AMT, T_OST_FC_AMT, T_OST_DRCR_FLAG,
                  T_OST_DOC_REF, T_OST_DOC_REF_DT, T_OST_OTH_REF,
                  T_OST_LC_ADJ_AMT, T_OST_FC_ADJ_AMT, T_OST_LC_PDC_AMT,
                  T_OST_FC_PDC_AMT, T_OST_LC_UNP_AMT, T_OST_FC_UNP_AMT,
                  T_OST_LC_UNDEP_AMT, T_OST_FC_UNDEP_AMT, T_OST_LC_ORG_AMT,
                  T_OST_FC_ORG_AMT, T_OST_REF_KEY_NO, T_OST_REF_COMP_CODE,
                  T_OST_REF_ACNT_YEAR, T_OST_REF_TRAN_CODE, T_OST_REF_SEQ_NO,
                  T_OST_REF_DOC_NO, T_OST_REF_DOC_DT, T_OST_REF_DOC_CAL_YEAR,
                  T_OST_REF_DOC_CAL_MONTH, T_OST_REF_DUE_DT,
                  T_OST_LAST_MATCH_DT, T_OST_TYPE, T_OST_CR_UID, T_OST_CR_DT;
            /* LC Value of the R Entry at the original document rate */
            ORGL_R_ENTRY_LC_AMT := ROUND(S_OST_FC_AMT *
                                         S_OST_LC_ORG_AMT /
                                         S_OST_FC_ORG_AMT, 2);
            CURR_R_ENTRY_LC_AMT := ROUND(S_OST_FC_AMT *
                                         T_OST_LC_ORG_AMT /
                                         T_OST_FC_ORG_AMT, 2);
            IF ORGL_R_ENTRY_LC_AMT = CURR_R_ENTRY_LC_AMT THEN
               NULL;
            ELSE
            P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(M_COMP_CODE);
            IF P_CUR_ACNT_YEAR < 0 THEN
               RAISE_APPLICATION_ERROR(-20468,
                       'Invalid Current Accounting Year') ;
            END IF;
            IF SEL_XDIFF_AC%ISOPEN THEN
                 CLOSE SEL_XDIFF_AC;
            END IF;
            OPEN SEL_XDIFF_AC;
            FETCH SEL_XDIFF_AC INTO P_XDIFF_MAIN_ACNT_CODE;
            IF SEL_XDIFF_AC%NOTFOUND THEN
               CLOSE SEL_XDIFF_AC;
               RAISE_APPLICATION_ERROR(-20999,
                       'Exchange Gain/Loss account not parameterised');
            END IF;
            CLOSE SEL_XDIFF_AC;
            IF SEL_XDIFF_TC%ISOPEN THEN
                 CLOSE SEL_XDIFF_TC;
            END IF;
            OPEN SEL_XDIFF_TC;
            FETCH SEL_XDIFF_TC INTO P_XDIFF_TRAN_CODE;
            IF SEL_XDIFF_TC%NOTFOUND THEN
               CLOSE SEL_XDIFF_TC;
               RAISE_APPLICATION_ERROR(-20999,
                       'Exchange Gain/Loss TC not parameterised');
            END IF;
            CLOSE SEL_XDIFF_TC;
            P_XDIFF_CURR_CODE := NULL;
            P_XDIFF_DOC_DT := TO_DATE(TO_CHAR(SYSDATE,'DD-MON-YY'),'DD-MON-YY');
            F_VAL_OPCL(M_COMP_CODE, P_XDIFF_DOC_DT,
                        P_ERR_NO, P_XDIFF_DOC_CAL_YEAR,
                        P_XDIFF_DOC_CAL_MONTH, P_ACNT_YEAR);
            IF P_ERR_NO != 0 THEN
               RAISE_APPLICATION_ERROR(-20999, 'Period not open');
            END IF;
            P_XDIFF_SEQ_NO := 1;
            F_GEN_DOC_NO(M_COMP_CODE, P_XDIFF_TRAN_CODE,
                          P_XDIFF_DOC_NO);
            IF P_XDIFF_DOC_NO = 0 THEN
               RAISE_APPLICATION_ERROR(-20999,
                       'Error in Document number generation');
            END IF;
            INSERT INTO FT_CUR_TRANS_HEADER
                  (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE, TH_DOC_NO,
                   TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH, TH_DOC_DUE_DT,
                   TH_CR_UID, TH_CR_DT)
            VALUES
                  (M_COMP_CODE, P_CUR_ACNT_YEAR, P_XDIFF_TRAN_CODE,
                   P_XDIFF_DOC_NO, P_XDIFF_DOC_DT, P_XDIFF_DOC_CAL_YEAR,
                   P_XDIFF_DOC_CAL_MONTH, P_XDIFF_DOC_DT,
                   M_USER_ID, SYSDATE);
            IF ORGL_R_ENTRY_LC_AMT > CURR_R_ENTRY_LC_AMT THEN
               P_XDIFF_LC_AMT := ORGL_R_ENTRY_LC_AMT -
                                 CURR_R_ENTRY_LC_AMT;
               SELECT DECODE(S_OST_DRCR_FLAG,'D','C','C','D','X')
               INTO   P_XDIFF_DRCR_FLAG
               FROM   DUAL;
            ELSE
               P_XDIFF_LC_AMT := CURR_R_ENTRY_LC_AMT -
                                 ORGL_R_ENTRY_LC_AMT;
               P_XDIFF_DRCR_FLAG := S_OST_DRCR_FLAG;
            END IF;
            INSERT INTO FT_CUR_TRANS_DETAIL
                   (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO,
                    TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
                    TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
                    TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
                    TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT,
                    TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
                    TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
                    TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
              VALUES
                   (M_COMP_CODE, P_CUR_ACNT_YEAR, P_XDIFF_TRAN_CODE,
                    P_XDIFF_DOC_NO, P_XDIFF_SEQ_NO, S_OST_MAIN_ACNT_CODE,
                    S_OST_SUB_ACNT_CODE, S_OST_DIVN_CODE, S_OST_DEPT_CODE, 1,
                    S_OST_ANLY_CODE_1, 2, S_OST_ANLY_CODE_2, S_OST_CURR_CODE,
                    P_XDIFF_LC_AMT, P_XDIFF_DRCR_FLAG, 0, NULL, P_XDIFF_DOC_DT,
                    S_OST_ACTY_CODE_1, S_OST_ACTY_CODE_2,
                    'FX ADJ OF ENTRY ' || S_OST_TRAN_CODE || '-' ||
                    TO_CHAR(S_OST_DOC_NO) || '-' || TO_CHAR(S_OST_SEQ_NO),
                    'N', 'N', 'N', '0', M_USER_ID, SYSDATE);
              IF ORGL_R_ENTRY_LC_AMT > CURR_R_ENTRY_LC_AMT THEN
                 SELECT OST_KEY_NO
                 INTO   P_OST_KEY_NO
                 FROM   FT_OS
                 WHERE  OST_COMP_CODE = M_COMP_CODE
                 AND    OST_ACNT_YEAR = P_CUR_ACNT_YEAR
                 AND    OST_TRAN_CODE = P_XDIFF_TRAN_CODE
                 AND    OST_DOC_NO    = P_XDIFF_DOC_NO
                 AND    OST_SEQ_NO    = P_XDIFF_SEQ_NO;
                 F_OS(Q_OST_KEY_NO);
                 INSERT INTO FT_OS
                       (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                        OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                        OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                        OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                        OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                        OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                        OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                        OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                        OST_REF_KEY_NO, OST_LC_ORG_AMT, OST_FC_ORG_AMT,
                        OST_REF_COMP_CODE, OST_REF_ACNT_YEAR,
                        OST_REF_TRAN_CODE, OST_REF_SEQ_NO, OST_REF_DOC_NO,
                        OST_REF_DOC_DT, OST_REF_DOC_CAL_YEAR,
                        OST_REF_DOC_CAL_MONTH, OST_REF_DUE_DT, OST_TYPE,
                        OST_CR_UID, OST_CR_DT)
                 VALUES
                       (Q_OST_KEY_NO, S_OST_COMP_CODE, S_OST_TRAN_CODE,
                        S_OST_DOC_NO, S_OST_SEQ_NO, S_OST_ACNT_YEAR,
                        S_OST_DOC_DT, S_OST_DOC_CAL_YEAR, S_OST_DOC_CAL_MONTH,
                        S_OST_DUE_DT, S_OST_MAIN_ACNT_CODE, S_OST_SUB_ACNT_CODE,
                        S_OST_DIVN_CODE, S_OST_DEPT_CODE, 1, S_OST_ANLY_CODE_1,
                        2, S_OST_ANLY_CODE_2, S_OST_ACTY_CODE_1,
                        S_OST_ACTY_CODE_2, S_OST_CURR_CODE, P_XDIFF_LC_AMT,
                        0, S_OST_DRCR_FLAG, S_OST_DOC_REF, S_OST_DOC_REF_DT,
                        S_OST_OTH_REF, P_OST_KEY_NO, S_OST_LC_ORG_AMT,
                        S_OST_FC_ORG_AMT, M_COMP_CODE, P_CUR_ACNT_YEAR,
                        P_XDIFF_TRAN_CODE, P_XDIFF_SEQ_NO, P_XDIFF_DOC_NO,
                        S_OST_DOC_DT, P_XDIFF_DOC_CAL_YEAR,
                        P_XDIFF_DOC_CAL_MONTH, S_OST_DOC_DT, 'R', M_USER_ID,
                        SYSDATE);
              ELSE
                 SELECT OST_KEY_NO
                 INTO   P_OST_KEY_NO
                 FROM   FT_OS
                 WHERE  OST_COMP_CODE = M_COMP_CODE
                 AND    OST_ACNT_YEAR = P_CUR_ACNT_YEAR
                 AND    OST_TRAN_CODE = P_XDIFF_TRAN_CODE
                 AND    OST_DOC_NO    = P_XDIFF_DOC_NO
                 AND    OST_SEQ_NO    = P_XDIFF_SEQ_NO;
                 F_OS(Q_OST_KEY_NO);
                 INSERT INTO FT_OS
                     (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                      OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                      OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                      OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                      OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                      OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                      OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                      OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                      OST_REF_KEY_NO, OST_LC_ORG_AMT, OST_FC_ORG_AMT,
                      OST_REF_COMP_CODE, OST_REF_ACNT_YEAR,
                      OST_REF_TRAN_CODE, OST_REF_SEQ_NO,
                      OST_REF_DOC_NO, OST_REF_DOC_DT,
                      OST_REF_DOC_CAL_YEAR, OST_REF_DOC_CAL_MONTH,
                      OST_REF_DUE_DT,
                      OST_TYPE, OST_CR_UID, OST_CR_DT)
                 SELECT
                      Q_OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                      OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                      OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                      OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                      OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                      OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                      OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                      OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                      T_OST_KEY_NO, OST_LC_ORG_AMT, OST_FC_ORG_AMT,
                      T_OST_COMP_CODE, T_OST_ACNT_YEAR, T_OST_TRAN_CODE,
                      T_OST_SEQ_NO, T_OST_DOC_NO, T_OST_DOC_DT,
                      T_OST_DOC_CAL_YEAR, T_OST_DOC_CAL_MONTH, T_OST_DUE_DT,
                      'R', OST_CR_UID, OST_CR_DT
                 FROM  FT_OS
                 WHERE OST_KEY_NO = P_OST_KEY_NO;
                 DELETE FROM FT_OS
                 WHERE  OST_KEY_NO = P_OST_KEY_NO;
                 /* Putting the key no of the JV into the R document */
                 UPDATE FT_OS
                 SET OST_OTH_REF = Q_OST_KEY_NO
                 WHERE OST_KEY_NO = REF_OST_KEY_NO;
               END IF;
               P_XDIFF_SEQ_NO := NVL(P_XDIFF_SEQ_NO,0) + 1;
               INSERT INTO FT_CUR_TRANS_DETAIL
                     (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO,
                      TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
                      TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
                      TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
                      TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT,
                      TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
                      TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
                      TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
              VALUES
                   (M_COMP_CODE, P_CUR_ACNT_YEAR, P_XDIFF_TRAN_CODE,
                    P_XDIFF_DOC_NO, P_XDIFF_SEQ_NO, P_XDIFF_MAIN_ACNT_CODE,
                    NULL, S_OST_DIVN_CODE, S_OST_DEPT_CODE, 1,
                    S_OST_ANLY_CODE_1, 2, S_OST_ANLY_CODE_2, NULL,
                    P_XDIFF_LC_AMT,
                    DECODE(P_XDIFF_DRCR_FLAG,'D','C','C','D','X'),
                    0, NULL, P_XDIFF_DOC_DT, NULL, NULL,
                    'FX ADJ OF ENTRY ' || S_OST_TRAN_CODE || '-' ||
                    TO_CHAR(S_OST_DOC_NO) || '-' || TO_CHAR(S_OST_SEQ_NO),
                    'N', 'N', 'N', '0', M_USER_ID, SYSDATE);
            END IF;
         END IF;
      END IF;
      DELETE FROM FS_MATCH_OS
      WHERE  CURRENT OF SEL_MATCH_OS;
  END LOOP;
END;
CREATE OR REPLACE PROCEDURE F_AJV_DETAIL
/
                 (P_AJD_KEY_NO      OUT      NUMBER) AS
BEGIN
     SELECT SEQ_AJD_KEY_NO.NEXTVAL
     INTO   P_AJD_KEY_NO
     FROM   SYS.DUAL;
END;
CREATE OR REPLACE PROCEDURE F_ALLOCATION_JV
/
                 (P_AJV_KEY_NO      OUT      NUMBER) AS
BEGIN
      SELECT SEQ_AJV_KEY_NO.NEXTVAL
      INTO   P_AJV_KEY_NO
      FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_CHK_DRCR_SUM
                       (P_COMP_CODE           IN          VARCHAR2,
                        P_ACNT_YEAR           IN          NUMBER,
                        P_TRAN_CODE           IN          VARCHAR2,
                        P_DOC_NO              IN          NUMBER)  AS
      P_TOT_DR_AMT       NUMBER;
      P_TOT_CR_AMT       NUMBER;
      P_CUR_ACNT_YEAR    NUMBER;
      CURSOR GET_CUR_DR_CR_AMT IS
         SELECT SUM(DECODE(TD_DOC_DRCR_FLAG,'D',TD_DOC_AMT,0)),
                SUM(DECODE(TD_DOC_DRCR_FLAG,'C',TD_DOC_AMT,0))
         FROM   FT_CUR_TRANS_DETAIL
         WHERE  TD_COMP_CODE = P_COMP_CODE
         AND    TD_ACNT_YEAR = P_ACNT_YEAR
         AND    TD_TRAN_CODE = P_TRAN_CODE
         AND    TD_DOC_NO    = P_DOC_NO ;
      CURSOR GET_PRV_DR_CR_AMT IS
         SELECT SUM(DECODE(TD_DOC_DRCR_FLAG,'D',TD_DOC_AMT,0)),
                SUM(DECODE(TD_DOC_DRCR_FLAG,'C',TD_DOC_AMT,0))
         FROM   FT_PRV_TRANS_DETAIL
         WHERE  TD_COMP_CODE = P_COMP_CODE
         AND    TD_ACNT_YEAR = P_ACNT_YEAR
         AND    TD_TRAN_CODE = P_TRAN_CODE
         AND    TD_DOC_NO    = P_DOC_NO ;
      BEGIN
         P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
         IF P_CUR_ACNT_YEAR = P_ACNT_YEAR THEN
            IF GET_CUR_DR_CR_AMT%ISOPEN THEN
               CLOSE GET_CUR_DR_CR_AMT ;
            END IF ;
            OPEN  GET_CUR_DR_CR_AMT;
            FETCH GET_CUR_DR_CR_AMT INTO P_TOT_DR_AMT, P_TOT_CR_AMT ;
            CLOSE GET_CUR_DR_CR_AMT;
            IF NVL(P_TOT_DR_AMT, 0) != NVL(P_TOT_CR_AMT,0) THEN
               RAISE_APPLICATION_ERROR(-20015, 'Debit and Credit not tallying');
            END IF;
         ELSE
            IF GET_PRV_DR_CR_AMT%ISOPEN THEN
               CLOSE GET_PRV_DR_CR_AMT ;
            END IF ;
            OPEN  GET_PRV_DR_CR_AMT;
            FETCH GET_PRV_DR_CR_AMT INTO P_TOT_DR_AMT, P_TOT_CR_AMT ;
            CLOSE GET_PRV_DR_CR_AMT;
            IF NVL(P_TOT_DR_AMT, 0) != NVL(P_TOT_CR_AMT,0) THEN
               RAISE_APPLICATION_ERROR(-20015, 'Debit and Credit not tallying');
            END IF;
         END IF;
      END ;
/
CREATE OR REPLACE PROCEDURE F_CREATE_AJV_DETAIL
       (P_AJV_KEY_NO      NUMBER,
        P_AJV_START_DT    DATE,
        P_AJV_UPTO_DT     DATE,
        P_COMP_CODE       VARCHAR2,
        P_AJV_DOC_AMT     NUMBER,
        P_AJV_CR_UID      VARCHAR2,
        P_AJV_CR_DT       DATE,
        P_ERR_NO          IN OUT NUMBER) IS
M_DUMMY                 VARCHAR2(1) ;
M_FIRST_MTH_AMT         FT_ALLOCATION_JV.AJV_DOC_AMT%TYPE ;
M_MTHLY_AMT             FT_ALLOCATION_JV.AJV_DOC_AMT%TYPE ;
M_THIS_MTH_AMT          FT_ALLOCATION_JV.AJV_DOC_AMT%TYPE ;
M_TOT_ALLOC_AMT         FT_ALLOCATION_JV.AJV_DOC_AMT%TYPE ;
M_SER_NO                FT_AJV_DETAIL.AJD_SEQ_NO%TYPE ;
M_NO_OF_MTH             FT_AJV_DETAIL.AJD_SEQ_NO%TYPE ;
M_DOC_DT                DATE ;
M_FIRST_MTH_LAST_DT     DATE ;
M_CFED_DT               DATE ;
M_MAX_DT                DATE ;
M_CAL_YEAR              NUMBER(2) ;
M_CAL_MTH               NUMBER(2) ;
M_ACNT_YEAR             NUMBER(2) ;
M_PREV_CAL_YEAR         NUMBER(2) ;
M_PREV_CAL_MTH          NUMBER(2) ;
M_DAYS                  NUMBER(3) ;
CURSOR C1 IS
       SELECT APER_TO_DT
       FROM   FM_ACNT_PERIOD
       WHERE  APER_COMP_CODE = P_COMP_CODE
         AND  APER_CAL_YEAR  = M_CAL_YEAR
         AND  APER_CAL_MONTH = M_CAL_MTH ;
CURSOR C2 IS
       SELECT 'X'
       FROM   FT_AJV_DETAIL
       WHERE  AJD_KEY_NO = P_AJV_KEY_NO
       AND    AJD_STATUS IS NOT NULL ;
CURSOR C3 IS
       SELECT M_FIRST_MTH_LAST_DT - APER_TO_DT
       FROM   FM_ACNT_PERIOD
       WHERE  APER_COMP_CODE = P_COMP_CODE
         AND  APER_CAL_YEAR  = M_PREV_CAL_YEAR
         AND  APER_CAL_MONTH = M_PREV_CAL_MTH ;
BEGIN
   OPEN C2 ;
   FETCH C2 INTO M_DUMMY ;
   IF C2%FOUND THEN
      GOTO GOTO_END ;
   END IF ;
   DELETE FROM FT_AJV_DETAIL
   WHERE  AJD_KEY_NO = P_AJV_KEY_NO ;
   F_VAL_OPCL(P_COMP_CODE, P_AJV_START_DT, P_ERR_NO,
              M_CAL_YEAR, M_CAL_MTH, M_ACNT_YEAR);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20000 - P_ERR_NO, 'Invalid Start Date');
   END IF;
   SELECT MAX(TO_DATE(TO_CHAR(APER_TO_DT)))
   INTO   M_CFED_DT
   FROM   FM_ACNT_PERIOD
   WHERE  APER_COMP_CODE = P_COMP_CODE  ;
   SELECT COUNT(*), MAX(TO_DATE(TO_CHAR(APER_TO_DT))),
          MIN(TO_DATE(TO_CHAR(APER_TO_DT)))
   INTO   M_NO_OF_MTH, M_MAX_DT, M_FIRST_MTH_LAST_DT
   FROM   FM_ACNT_PERIOD
   WHERE  APER_COMP_CODE = P_COMP_CODE
     AND  TO_DATE(TO_CHAR(APER_TO_DT)) BETWEEN P_AJV_START_DT
                                           AND P_AJV_UPTO_DT ;
   DBMS_OUTPUT.PUT_LINE('CFED ' || TO_CHAR(M_CFED_DT) ) ;
   DBMS_OUTPUT.PUT_LINE('FIRST_MTH_LAST_DT ' || TO_CHAR(M_FIRST_MTH_LAST_DT) ) ;
   IF P_AJV_UPTO_DT > M_CFED_DT THEN
      M_NO_OF_MTH := NVL(M_NO_OF_MTH,0) +
                     CEIL(MONTHS_BETWEEN(LAST_DAY(P_AJV_UPTO_DT), M_CFED_DT + 1)) ;
   ELSE
      IF M_MAX_DT != P_AJV_UPTO_DT THEN
         M_NO_OF_MTH := NVL(M_NO_OF_MTH,0) + 1 ;
      END IF ;
   END IF ;
   DBMS_OUTPUT.PUT_LINE('TOTAL # OF MTH IS ' || TO_CHAR(M_NO_OF_MTH) ) ;
   /* The starting date is included in the first month for calculation
      The logic for first month amount is
      No_of_days_in_first_month
      -------------------------   * Amount
      Total_no_of_days_opted
   */
   M_MTHLY_AMT := ROUND(P_AJV_DOC_AMT /
                   MONTHS_BETWEEN(TO_DATE(TO_CHAR(P_AJV_UPTO_DT + 1)),
                                  TO_DATE(TO_CHAR(P_AJV_START_DT))), 0) ;
   DBMS_OUTPUT.PUT_LINE('MTHLY AMT ' || TO_CHAR(M_MTHLY_AMT) ) ;
   M_SER_NO := 1 ;
   WHILE M_SER_NO <= M_NO_OF_MTH
   LOOP
      DBMS_OUTPUT.PUT_LINE('SRNO ' || TO_CHAR(M_SER_NO) ) ;
      DBMS_OUTPUT.PUT_LINE('SRNO AMOUNT ' || TO_CHAR(M_THIS_MTH_AMT) ) ;
      M_CAL_YEAR := TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(TO_CHAR(
                    M_FIRST_MTH_LAST_DT,'YYMM'),'YYMM'),M_SER_NO-1),'YY')) ;
      M_CAL_MTH  := TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(TO_CHAR(
                    M_FIRST_MTH_LAST_DT,'YYMM'),'YYMM'),M_SER_NO-1),'MM')) ;
      IF M_SER_NO = 1 THEN
         M_PREV_CAL_YEAR := TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(TO_CHAR(
                        M_FIRST_MTH_LAST_DT,'YYMM'),'YYMM'),M_SER_NO-2),'YY')) ;
         M_PREV_CAL_MTH  := TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(TO_CHAR(
                        M_FIRST_MTH_LAST_DT,'YYMM'),'YYMM'),M_SER_NO-2),'MM')) ;
      DBMS_OUTPUT.PUT_LINE('CAL YEAR ' || TO_CHAR(M_PREV_CAL_YEAR) ) ;
      DBMS_OUTPUT.PUT_LINE('CAL MONTH ' || TO_CHAR(M_PREV_CAL_MTH) ) ;
         IF C3%ISOPEN THEN
            CLOSE C3 ;
         END IF ;
         OPEN C3 ;
         FETCH C3 INTO M_DAYS ;
         IF C3%NOTFOUND THEN
Press <Enter> to continue...
            M_DAYS := 31 ;
         END IF ;
         CLOSE C3 ;
         DBMS_OUTPUT.PUT_LINE('DAYS IN MONTH ' || TO_CHAR(M_DAYS) );
         M_FIRST_MTH_AMT :=
            ROUND((M_FIRST_MTH_LAST_DT - TO_DATE(TO_CHAR(P_AJV_START_DT)) + 1) *
              (M_MTHLY_AMT / M_DAYS), 0) ;
         M_THIS_MTH_AMT  := M_FIRST_MTH_AMT ;
         M_TOT_ALLOC_AMT := M_FIRST_MTH_AMT ;
         DBMS_OUTPUT.PUT_LINE('FIRST MONTH AMT'|| TO_CHAR(M_FIRST_MTH_AMT) );
      ELSE
         IF M_SER_NO = M_NO_OF_MTH THEN
            M_THIS_MTH_AMT  := NVL(P_AJV_DOC_AMT,0) - NVL(M_TOT_ALLOC_AMT,0) ;
         ELSE
            M_THIS_MTH_AMT  := M_MTHLY_AMT ;
            M_TOT_ALLOC_AMT := NVL(M_TOT_ALLOC_AMT,0) + NVL(M_MTHLY_AMT,0) ;
         END IF ;
      END IF ;
      OPEN C1 ;
      FETCH C1 INTO M_DOC_DT ;
      IF C1%NOTFOUND THEN
         M_DOC_DT := LAST_DAY(TO_DATE(LTRIM(TO_CHAR(M_CAL_YEAR,'09')) ||
                                      LTRIM(TO_CHAR(M_CAL_MTH,'09')),'YYMM')) ;
      END IF ;
      CLOSE C1 ;
      DBMS_OUTPUT.PUT_LINE('DOCUMENT DATE IS ' || TO_CHAR(M_DOC_DT) ) ;
      DBMS_OUTPUT.PUT_LINE('CAL MM IS' || TO_CHAR(M_CAL_MTH) );
      DBMS_OUTPUT.PUT_LINE('DOCUMENT AMT IS ' || TO_CHAR(M_THIS_MTH_AMT) ) ;
      INSERT INTO FT_AJV_DETAIL
             (AJD_KEY_NO, AJD_SEQ_NO, AJD_DOC_DT, AJD_DOC_CAL_YEAR,
              AJD_DOC_CAL_MONTH, AJD_ALLOC_AMT, AJD_CR_UID, AJD_CR_DT)
      VALUES
             (P_AJV_KEY_NO, M_SER_NO, M_DOC_DT, M_CAL_YEAR, M_CAL_MTH,
              NVL(M_THIS_MTH_AMT,0), P_AJV_CR_UID, P_AJV_CR_DT) ;
      M_SER_NO  := NVL(M_SER_NO,0) + 1 ;
   END LOOP ;
   <<GOTO_END>>
     NULL ;
END ;
/
CREATE OR REPLACE PROCEDURE F_FT_FIXED_JV (P_FJV_REF OUT NUMBER) AS
BEGIN
      SELECT SEQ_FJV_REF.NEXTVAL
      INTO   P_FJV_REF
      FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_GEN_DOC_NO
                 (P_COMP_CODE IN     VARCHAR2,
                  P_TRAN_CODE IN     VARCHAR2,
                  P_DOC_NO    IN OUT NUMBER) AS
P_CUR_NO      NUMBER(6);
P_MAX_NO      NUMBER(6);
CURSOR SEL_TDOC IS
       SELECT NVL(TDOC_CUR_NO,1), TDOC_MAX_NO
       FROM   FM_TRAN_DOC_NO
       WHERE  TDOC_TRAN_CODE = P_TRAN_CODE
       AND    TDOC_COMP_CODE = P_COMP_CODE
       FOR UPDATE OF TDOC_CUR_NO;
BEGIN
   IF SEL_TDOC%ISOPEN THEN
      CLOSE SEL_TDOC;
   END IF;
   OPEN SEL_TDOC;
   FETCH SEL_TDOC INTO P_CUR_NO, P_MAX_NO;
   IF SEL_TDOC%NOTFOUND THEN
      P_DOC_NO := 0;
      CLOSE SEL_TDOC;
      RETURN;
   END IF;
   IF NVL(P_CUR_NO,0) >= NVL(P_MAX_NO,0) THEN
      P_DOC_NO := 0;
   ELSE
      P_DOC_NO := P_CUR_NO;
      UPDATE FM_TRAN_DOC_NO
      SET    TDOC_CUR_NO = NVL(TDOC_CUR_NO,0) + 1
      WHERE  CURRENT OF SEL_TDOC;
   END IF;
   CLOSE SEL_TDOC;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_ACNT_YEAR_2DATES
                               ( P_FROM_DATE DATE,
                                 P_TO_DATE   DATE)
                             RETURN NUMBER IS
CURSOR F_FROM_DT_YEAR IS
       SELECT APER_ACNT_YEAR
       FROM   FM_ACNT_PERIOD
       WHERE  P_FROM_DATE BETWEEN APER_FRM_DT  AND APER_TO_DT ;
CURSOR F_TO_DT_YEAR IS
       SELECT APER_ACNT_YEAR
       FROM   FM_ACNT_PERIOD
       WHERE  P_TO_DATE BETWEEN APER_FRM_DT AND APER_TO_DT ;
P_FROM_ACNT_YEAR     NUMBER(2);
P_TO_ACNT_YEAR       NUMBER(2);
BEGIN
     IF F_FROM_DT_YEAR%ISOPEN THEN
           CLOSE F_FROM_DT_YEAR;
     END IF;
     IF F_TO_DT_YEAR%ISOPEN THEN
           CLOSE F_TO_DT_YEAR;
     END IF;
     OPEN F_FROM_DT_YEAR ;
     FETCH F_FROM_DT_YEAR  INTO P_FROM_ACNT_YEAR;
     IF F_FROM_DT_YEAR%NOTFOUND THEN
        CLOSE F_FROM_DT_YEAR;
        RETURN(-1);
     ELSE
        CLOSE F_FROM_DT_YEAR;
     END IF;
     OPEN F_TO_DT_YEAR ;
     FETCH F_TO_DT_YEAR  INTO P_TO_ACNT_YEAR;
     IF F_TO_DT_YEAR%NOTFOUND THEN
        CLOSE F_TO_DT_YEAR;
        RETURN(-1);
     ELSE
        CLOSE F_TO_DT_YEAR;
     END IF;
     IF P_FROM_ACNT_YEAR = P_TO_ACNT_YEAR THEN
        RETURN(P_FROM_ACNT_YEAR);
     ELSE
        RETURN ( -2 ) ;
     END IF ;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_BASE_CURR RETURN VARCHAR2 IS
CURSOR F_PARA IS
       SELECT SUBSTR(PARA_VALUE,1,3)
       FROM   FP_PARAMETER
       WHERE  PARA_ID = 'BASE.CURR';
P_BASE_CURR_CODE     VARCHAR2(3);
BEGIN
     IF F_PARA%ISOPEN THEN
           CLOSE F_PARA;
     END IF;
     OPEN F_PARA;
     FETCH F_PARA INTO P_BASE_CURR_CODE;
     IF F_PARA%NOTFOUND THEN
        CLOSE F_PARA;
        RETURN('ERR');
     ELSE
        CLOSE F_PARA;
        RETURN(P_BASE_CURR_CODE);
     END IF;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_COMP_CODE
                            ( P_R_KEY_NO  IN NUMBER )
                              RETURN VARCHAR2 IS
CURSOR  F_COMP_CODE    IS
   SELECT SUBSTR( REP_VALUE_1,1,3)
     FROM FP_REP_INFO
    WHERE REP_KEY_NO  = P_R_KEY_NO ;
P_COMP_CODE VARCHAR2(3) ;
BEGIN
     IF F_COMP_CODE%ISOPEN THEN
           CLOSE F_COMP_CODE;
     END IF;
     OPEN F_COMP_CODE;
     FETCH F_COMP_CODE    INTO P_COMP_CODE        ;
     IF F_COMP_CODE%NOTFOUND THEN
        CLOSE F_COMP_CODE     ;
        RETURN  ( '' ) ;
     ELSE
        CLOSE F_COMP_CODE   ;
        RETURN  ( P_COMP_CODE ) ;
     END IF;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_CUR_ACNT_YEAR
                                       (P_COMP_CODE   VARCHAR2)
                                        RETURN NUMBER IS
CURSOR F_PARA IS
       SELECT CAY_ACNT_YEAR
       FROM   FM_COMP_ACNT_YEAR
       WHERE  CAY_COMP_CODE = P_COMP_CODE
       AND    CAY_PREV_CURR_NEXT = 'C';
P_ACNT_YEAR     NUMBER(2);
Q_ACNT_YEAR     NUMBER(2);
BEGIN
     IF F_PARA%ISOPEN THEN
           CLOSE F_PARA;
     END IF;
     OPEN F_PARA;
     FETCH F_PARA INTO P_ACNT_YEAR;
     IF F_PARA%NOTFOUND THEN
        CLOSE F_PARA;
        RETURN(-1);
     ELSE
        FETCH F_PARA INTO Q_ACNT_YEAR;
        IF F_PARA%FOUND THEN
           CLOSE F_PARA;
           RETURN(-1);
        END IF;
        CLOSE F_PARA;
        RETURN(P_ACNT_YEAR);
     END IF;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_FC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_SUB_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_OP_BAL   NUMBER(14,3);
BEGIN
     IF P_CURR_CODE IS NULL THEN
           RETURN(0);
     END IF;
     IF P_SUB_ACNT_CODE IS NULL THEN
       P_OP_BAL := F_GET_MAIN_FC_OPBAL( P_COMP_CODE ,
                              P_ASOF_DT , P_MAIN_ACNT_CODE, P_CURR_CODE );
     ELSE
       P_OP_BAL := F_GET_SUB_FC_OPBAL( P_COMP_CODE , P_ASOF_DT ,
                         P_MAIN_ACNT_CODE, P_SUB_ACNT_CODE, P_CURR_CODE );
     END IF;
     RETURN(P_OP_BAL);
END;
/
CREATE OR REPLACE PROCEDURE F_GET_LC_BAL
                 (P_COMP_CODE        IN      VARCHAR2,
                  P_ACNT_YEAR        IN      NUMBER,
                  P_MAIN_ACNT_CODE   IN      VARCHAR2,
                  P_SUB_ACNT_CODE    IN      VARCHAR2,
                  P_DIVN_CODE        IN      VARCHAR2,
                  P_DEPT_CODE        IN      VARCHAR2,
                  P_ANLY_CODE_1      IN      VARCHAR2,
                  P_ANLY_CODE_2      IN      VARCHAR2,
                  P_CAL_YEAR         IN      NUMBER,
                  P_CAL_MONTH        IN      NUMBER,
                  P_LC_AMT           OUT     NUMBER,
                  P_ERR_NO           OUT     NUMBER) AS
CURSOR F_PRV_ACNT_BAL IS
       SELECT SUM(ABAL_LC_MTD_DR), SUM(ABAL_LC_MTD_CR)
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_SUB_ACNT_CODE,'000000') =
              NVL(P_SUB_ACNT_CODE,'000000')
       AND    NVL(ABAL_DIVN_CODE,'000000') =
              NVL(P_DIVN_CODE,'000000')
       AND    NVL(ABAL_DEPT_CODE,'000000') =
              NVL(P_DEPT_CODE,'000000')
       AND    NVL(ABAL_ANLY_CODE_1,'000000') =
              NVL(P_ANLY_CODE_1,'000000')
       AND    NVL(ABAL_ANLY_CODE_2,'000000') =
              NVL(P_ANLY_CODE_2,'000000')
       AND    (ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) <=
              (P_CAL_YEAR * 100 + P_CAL_MONTH)
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR;
CURSOR F_CUR_ACNT_BAL IS
       SELECT SUM(ABAL_LC_MTD_DR), SUM(ABAL_LC_MTD_CR)
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_SUB_ACNT_CODE,'000000') =
              NVL(P_SUB_ACNT_CODE,'000000')
       AND    NVL(ABAL_DIVN_CODE,'000000') =
              NVL(P_DIVN_CODE,'000000')
       AND    NVL(ABAL_DEPT_CODE,'000000') =
              NVL(P_DEPT_CODE,'000000')
       AND    NVL(ABAL_ANLY_CODE_1,'000000') =
              NVL(P_ANLY_CODE_1,'000000')
       AND    NVL(ABAL_ANLY_CODE_2,'000000') =
              NVL(P_ANLY_CODE_2,'000000')
       AND    (ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) <=
              (P_CAL_YEAR * 100 + P_CAL_MONTH)
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR;
P_CUR_ACNT_YEAR  NUMBER(2);
P_LC_BAL_DR      NUMBER(14,3);
P_LC_BAL_CR      NUMBER(14,3);
BEGIN
   P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
   P_ERR_NO := 0;
   P_LC_AMT := 0;
   IF P_ACNT_YEAR IS NULL OR P_COMP_CODE IS NULL OR
      P_CAL_MONTH IS NULL OR P_CAL_YEAR IS NULL OR
      P_MAIN_ACNT_CODE IS NULL THEN
      RAISE_APPLICATION_ERROR(-20460,
            'Company or Main account or Year and month cannot be null') ;
   END IF;
   P_LC_BAL_DR := 0;
   P_LC_BAL_CR := 0;
   IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
        IF F_CUR_ACNT_BAL%ISOPEN THEN
             CLOSE F_CUR_ACNT_BAL;
        END IF;
        OPEN  F_CUR_ACNT_BAL;
        FETCH F_CUR_ACNT_BAL INTO P_LC_BAL_DR, P_LC_BAL_CR;
        IF F_CUR_ACNT_BAL%NOTFOUND THEN
             P_LC_BAL_DR := 0;
             P_LC_BAL_CR := 0;
        END IF;
        CLOSE  F_CUR_ACNT_BAL;
   ELSE
        IF F_PRV_ACNT_BAL%ISOPEN THEN
             CLOSE F_PRV_ACNT_BAL;
        END IF;
        OPEN  F_PRV_ACNT_BAL;
        FETCH F_PRV_ACNT_BAL INTO P_LC_BAL_DR, P_LC_BAL_CR;
        IF F_PRV_ACNT_BAL%NOTFOUND THEN
             P_LC_BAL_DR := 0;
             P_LC_BAL_CR := 0;
        END IF;
        CLOSE  F_PRV_ACNT_BAL;
   END IF;
   P_LC_AMT := NVL(P_LC_BAL_DR,0) - NVL(P_LC_BAL_CR,0);
END;
/
CREATE OR REPLACE FUNCTION  F_GET_LC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_SUB_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_OP_BAL   NUMBER(14,3);
BEGIN
     IF P_SUB_ACNT_CODE IS NULL THEN
       P_OP_BAL := F_GET_MAIN_LC_OPBAL( P_COMP_CODE ,
                              P_ASOF_DT , P_MAIN_ACNT_CODE, P_CURR_CODE);
     ELSE
       P_OP_BAL := F_GET_SUB_LC_OPBAL( P_COMP_CODE , P_ASOF_DT ,
                        P_MAIN_ACNT_CODE, P_SUB_ACNT_CODE, P_CURR_CODE);
     END IF;
     RETURN(P_OP_BAL);
END;
/
CREATE OR REPLACE FUNCTION  F_GET_LOGO_NAME
                            ( P_R_KEY_NO  NUMBER  )
                              RETURN VARCHAR2 IS
CURSOR F_LOGO_NAME   IS
    SELECT LG_LOGO_NAME
      FROM FM_COMPANY_LOGO, FP_REP_INFO
     WHERE LG_COMP_CODE = SUBSTR( REP_VALUE_1, 1, 3 )
       AND REP_KEY_NO  = P_R_KEY_NO    ;
P_LOGO_NAME VARCHAR2( 30 ) ;
BEGIN
     IF F_LOGO_NAME%ISOPEN THEN
           CLOSE F_LOGO_NAME  ;
     END IF;
     OPEN F_LOGO_NAME ;
     FETCH F_LOGO_NAME INTO P_LOGO_NAME ;
     IF F_LOGO_NAME%NOTFOUND THEN
        CLOSE F_LOGO_NAME ;
        P_LOGO_NAME := '' ;
     ELSE
        CLOSE F_LOGO_NAME ;
     END IF;
     RETURN  P_LOGO_NAME ;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_MAIN_FC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_CUR_ACNT_YEAR NUMBER(2);
P_ACNT_YEAR     NUMBER(2);
P_CAL_YEAR      NUMBER(2);
P_CAL_MONTH     NUMBER(2);
P_FRM_DT        DATE;
P_TMP_ASOF_DT   DATE;
P_OP_BAL  NUMBER(14,3);
P_TRAN    NUMBER(14,3);
CURSOR F_ACNT_PERIOD IS
       SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
              TO_DATE(TO_CHAR(APER_FRM_DT))
       FROM   FM_ACNT_PERIOD
       WHERE  (APER_COMP_CODE = P_COMP_CODE)
       AND    (P_TMP_ASOF_DT BETWEEN APER_FRM_DT AND APER_TO_DT);
CURSOR F_CUR_OP_BAL  IS
       SELECT SUM(NVL(ABAL_FC_MTD_DR,0) - NVL(ABAL_FC_MTD_CR,0))
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_CURR_CODE = P_CURR_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_PRV_OP_BAL  IS
       SELECT SUM(NVL(ABAL_FC_MTD_DR,0) - NVL(ABAL_FC_MTD_CR,0))
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_CURR_CODE = P_CURR_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_CUR_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_CURR_CODE = P_CURR_CODE
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
CURSOR F_PRV_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_CURR_CODE = P_CURR_CODE
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
BEGIN
     P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
     P_TMP_ASOF_DT := TO_DATE(TO_CHAR(P_ASOF_DT));
     IF F_ACNT_PERIOD%ISOPEN THEN
           CLOSE F_ACNT_PERIOD;
     END IF;
     OPEN F_ACNT_PERIOD;
     FETCH F_ACNT_PERIOD INTO P_ACNT_YEAR, P_CAL_YEAR,
                              P_CAL_MONTH, P_FRM_DT   ;
     IF F_ACNT_PERIOD%NOTFOUND THEN
          CLOSE F_ACNT_PERIOD;
          RETURN(0);
     END IF;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
         IF F_CUR_OP_BAL%ISOPEN THEN
               CLOSE F_CUR_OP_BAL ;
         END IF;
         OPEN F_CUR_OP_BAL ;
         FETCH F_CUR_OP_BAL INTO P_OP_BAL ;
         IF F_CUR_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_CUR_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_CUR_TRAN%ISOPEN THEN
               CLOSE F_CUR_TRAN ;
         END IF;
         OPEN F_CUR_TRAN ;
         FETCH F_CUR_TRAN INTO P_TRAN ;
         IF F_CUR_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_CUR_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     ELSE
         IF F_PRV_OP_BAL%ISOPEN THEN
               CLOSE F_PRV_OP_BAL ;
         END IF;
         OPEN F_PRV_OP_BAL ;
         FETCH F_PRV_OP_BAL INTO P_OP_BAL ;
         IF F_PRV_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_PRV_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_PRV_TRAN%ISOPEN THEN
               CLOSE F_PRV_TRAN ;
         END IF;
         OPEN F_PRV_TRAN ;
         FETCH F_PRV_TRAN INTO P_TRAN ;
         IF F_PRV_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_PRV_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     END IF;
END;
/
CREATE OR REPLACE FUNCTION  F_GET_MAIN_LC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_CUR_ACNT_YEAR NUMBER(2);
P_ACNT_YEAR     NUMBER(2);
P_CAL_YEAR      NUMBER(2);
P_CAL_MONTH     NUMBER(2);
P_FRM_DT        DATE;
P_TMP_ASOF_DT   DATE;
P_OP_BAL  NUMBER(14,3);
P_TRAN    NUMBER(14,3);
CURSOR F_ACNT_PERIOD IS
       SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
              TO_DATE(TO_CHAR(APER_FRM_DT))
       FROM   FM_ACNT_PERIOD
       WHERE  (APER_COMP_CODE = P_COMP_CODE)
       AND    (P_TMP_ASOF_DT BETWEEN APER_FRM_DT AND APER_TO_DT);
CURSOR F_CUR_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_CURR_CODE, 'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_PRV_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_CUR_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
CURSOR F_PRV_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
BEGIN
     P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
     P_TMP_ASOF_DT := TO_DATE(TO_CHAR(P_ASOF_DT));
     IF F_ACNT_PERIOD%ISOPEN THEN
           CLOSE F_ACNT_PERIOD;
     END IF;
     OPEN F_ACNT_PERIOD;
     FETCH F_ACNT_PERIOD INTO P_ACNT_YEAR, P_CAL_YEAR,
                              P_CAL_MONTH, P_FRM_DT   ;
     IF F_ACNT_PERIOD%NOTFOUND THEN
          CLOSE F_ACNT_PERIOD;
          RETURN(0);
     END IF;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
         IF F_CUR_OP_BAL%ISOPEN THEN
               CLOSE F_CUR_OP_BAL ;
         END IF;
         OPEN F_CUR_OP_BAL ;
         FETCH F_CUR_OP_BAL INTO P_OP_BAL ;
         IF F_CUR_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_CUR_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_CUR_TRAN%ISOPEN THEN
               CLOSE F_CUR_TRAN ;
         END IF;
         OPEN F_CUR_TRAN ;
         FETCH F_CUR_TRAN INTO P_TRAN ;
         IF F_CUR_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_CUR_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     ELSE
         IF F_PRV_OP_BAL%ISOPEN THEN
               CLOSE F_PRV_OP_BAL ;
         END IF;
         OPEN F_PRV_OP_BAL ;
         FETCH F_PRV_OP_BAL INTO P_OP_BAL ;
         IF F_PRV_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_PRV_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_PRV_TRAN%ISOPEN THEN
               CLOSE F_PRV_TRAN ;
         END IF;
         OPEN F_PRV_TRAN ;
         FETCH F_PRV_TRAN INTO P_TRAN ;
         IF F_PRV_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_PRV_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     END IF;
END;
/
CREATE OR REPLACE FUNCTION F_GET_REPORTS_ERROR
                 (P_ERRNO IN NUMBER,
                  P_LANG IN VARCHAR2,
                  P_FIELD_NAME VARCHAR2 ) RETURN VARCHAR2 IS
    CURSOR ERROR_CUR IS
        SELECT EM_ERR_MSG
        FROM   FP_ERROR_MESSAGE
        WHERE  EM_ERR_NO    =  P_ERRNO
        AND    EM_LANG_CODE =  P_LANG;
    P_ERR_MSG     VARCHAR2(65);
BEGIN
    OPEN ERROR_CUR;
    FETCH ERROR_CUR INTO P_ERR_MSG;
    IF ERROR_CUR%NOTFOUND THEN
       P_ERR_MSG := TO_CHAR( P_ERRNO ) || ' Error code does not Exist in Error Table';
    ELSE
       P_ERR_MSG := P_FIELD_NAME || ' ' || P_ERR_MSG ;
    END IF;
    CLOSE ERROR_CUR;
    RETURN(P_ERR_MSG);
END;
/
CREATE OR REPLACE FUNCTION F_GET_STD_ERROR
                 (P_ERRNO     IN NUMBER,
                  P_LANG      IN VARCHAR2 )
                  RETURN VARCHAR2 IS
    CURSOR ERROR_CUR IS
        SELECT EM_ERR_MSG
        FROM   FP_ERROR_MESSAGE
        WHERE  EM_ERR_NO    =  P_ERRNO
        AND    EM_LANG_CODE =  P_LANG;
    P_ERR_MSG     VARCHAR2(65);
BEGIN
    OPEN ERROR_CUR;
    FETCH ERROR_CUR INTO P_ERR_MSG;
    IF ERROR_CUR%NOTFOUND THEN
       P_ERR_MSG := TO_CHAR( P_ERRNO ) ||
                    ' Error code does not Exist in Error Master ';
    END IF;
    CLOSE ERROR_CUR;
    RETURN(P_ERR_MSG);
END;
/
CREATE OR REPLACE FUNCTION  F_GET_SUB_FC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_SUB_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_CUR_ACNT_YEAR NUMBER(2);
P_ACNT_YEAR     NUMBER(2);
P_CAL_YEAR      NUMBER(2);
P_CAL_MONTH     NUMBER(2);
P_FRM_DT        DATE;
P_TMP_ASOF_DT   DATE;
P_OP_BAL  NUMBER(14,3);
P_TRAN    NUMBER(14,3);
CURSOR F_ACNT_PERIOD IS
       SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
              TO_DATE(TO_CHAR(APER_FRM_DT))
       FROM   FM_ACNT_PERIOD
       WHERE  (APER_COMP_CODE = P_COMP_CODE)
       AND    (P_TMP_ASOF_DT BETWEEN APER_FRM_DT AND APER_TO_DT);
CURSOR F_CUR_OP_BAL  IS
       SELECT SUM(NVL(ABAL_FC_MTD_DR,0) - NVL(ABAL_FC_MTD_CR,0))
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_CURR_CODE = P_CURR_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_PRV_OP_BAL  IS
       SELECT SUM(NVL(ABAL_FC_MTD_DR,0) - NVL(ABAL_FC_MTD_CR,0))
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_CURR_CODE = P_CURR_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_CUR_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    TD_CURR_CODE = P_CURR_CODE
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
CURSOR F_PRV_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    TD_CURR_CODE = P_CURR_CODE
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
BEGIN
     P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
     P_TMP_ASOF_DT := TO_DATE(TO_CHAR(P_ASOF_DT));
     IF F_ACNT_PERIOD%ISOPEN THEN
           CLOSE F_ACNT_PERIOD;
     END IF;
     OPEN F_ACNT_PERIOD;
     FETCH F_ACNT_PERIOD INTO P_ACNT_YEAR, P_CAL_YEAR,
                              P_CAL_MONTH, P_FRM_DT   ;
     IF F_ACNT_PERIOD%NOTFOUND THEN
          CLOSE F_ACNT_PERIOD;
          RETURN(0);
     END IF;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
         IF F_CUR_OP_BAL%ISOPEN THEN
               CLOSE F_CUR_OP_BAL ;
         END IF;
         OPEN F_CUR_OP_BAL ;
         FETCH F_CUR_OP_BAL INTO P_OP_BAL ;
         IF F_CUR_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_CUR_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_CUR_TRAN%ISOPEN THEN
               CLOSE F_CUR_TRAN ;
         END IF;
         OPEN F_CUR_TRAN ;
         FETCH F_CUR_TRAN INTO P_TRAN ;
         IF F_CUR_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_CUR_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     ELSE
         IF F_PRV_OP_BAL%ISOPEN THEN
               CLOSE F_PRV_OP_BAL ;
         END IF;
         OPEN F_PRV_OP_BAL ;
         FETCH F_PRV_OP_BAL INTO P_OP_BAL ;
         IF F_PRV_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_PRV_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_PRV_TRAN%ISOPEN THEN
               CLOSE F_PRV_TRAN ;
         END IF;
         OPEN F_PRV_TRAN ;
         FETCH F_PRV_TRAN INTO P_TRAN ;
         IF F_PRV_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_PRV_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE  F_GET_SUB_LC_BAL
                            ( P_COMP_CODE      VARCHAR2,
                              P_ASOF_DT        DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_SUB_ACNT_CODE  VARCHAR2,
                              P_CURR_CODE      VARCHAR2,
                              P_MTD_DR  OUT    NUMBER,
                              P_MTD_CR  OUT    NUMBER,
                              P_OPBAL   OUT    NUMBER,
                              P_ERR_NO  OUT    NUMBER) AS
P_CUR_ACNT_YEAR NUMBER(2);
P_ACNT_YEAR     NUMBER(2);
P_CAL_YEAR      NUMBER(2);
P_CAL_MONTH     NUMBER(2);
P_FRM_DT        DATE;
P_TMP_ASOF_DT   DATE;
P_DR_MTD        NUMBER(14,3);
P_CR_MTD        NUMBER(14,3);
P_OP_BAL        NUMBER(14,3);
P_TRAN_DR       NUMBER(14,3);
P_TRAN_CR       NUMBER(14,3);
CURSOR F_ACNT_PERIOD IS
       SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
              TO_DATE(TO_CHAR(APER_FRM_DT))
       FROM   FM_ACNT_PERIOD
       WHERE  (APER_COMP_CODE = P_COMP_CODE)
       AND    (P_TMP_ASOF_DT BETWEEN APER_FRM_DT AND APER_TO_DT);
CURSOR F_CUR_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0)),
              SUM(NVL(ABAL_LC_MTD_CR,0)),
              SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_PRV_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0)),
              SUM(NVL(ABAL_LC_MTD_CR,0)),
              SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_CUR_TRAN_DR  IS
       SELECT SUM(NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO
       AND    TD_DOC_DRCR_FLAG = 'D';
CURSOR F_CUR_TRAN_CR  IS
       SELECT SUM(NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO
       AND    TD_DOC_DRCR_FLAG = 'C';
CURSOR F_PRV_TRAN_DR  IS
       SELECT SUM(NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO
       AND    TD_DOC_DRCR_FLAG = 'D';
CURSOR F_PRV_TRAN_CR  IS
       SELECT SUM(NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO
       AND    TD_DOC_DRCR_FLAG = 'C';
BEGIN
     P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
     P_TMP_ASOF_DT := TO_DATE(TO_CHAR(P_ASOF_DT));
     IF F_ACNT_PERIOD%ISOPEN THEN
           CLOSE F_ACNT_PERIOD;
     END IF;
     OPEN F_ACNT_PERIOD;
     FETCH F_ACNT_PERIOD INTO P_ACNT_YEAR, P_CAL_YEAR,
                              P_CAL_MONTH, P_FRM_DT   ;
     IF F_ACNT_PERIOD%NOTFOUND THEN
        CLOSE F_ACNT_PERIOD;
        RAISE_APPLICATION_ERROR(-20120,
            'Invalid Accounting period') ;
     END IF;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
         IF F_CUR_OP_BAL%ISOPEN THEN
               CLOSE F_CUR_OP_BAL ;
         END IF;
         OPEN F_CUR_OP_BAL ;
         FETCH F_CUR_OP_BAL INTO P_DR_MTD, P_CR_MTD, P_OP_BAL ;
         IF F_CUR_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_CUR_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            P_MTD_DR  :=  NVL(P_DR_MTD,0) + NVL(P_TRAN_DR,0) ;
            P_MTD_CR  :=  NVL(P_CR_MTD,0) + NVL(P_TRAN_CR,0) ;
           P_OP_BAL := NVL(P_OP_BAL,0) + (NVL(P_TRAN_DR,0) - NVL(P_TRAN_CR,0));
         END IF;
         IF F_CUR_TRAN_DR%ISOPEN THEN
               CLOSE F_CUR_TRAN_DR ;
         END IF;
         OPEN F_CUR_TRAN_DR ;
         FETCH F_CUR_TRAN_DR INTO P_TRAN_DR ;
         IF F_CUR_TRAN_DR%NOTFOUND THEN
            P_TRAN_DR := 0;
         END IF;
         CLOSE F_CUR_TRAN_DR ;
         IF F_CUR_TRAN_CR%ISOPEN THEN
               CLOSE F_CUR_TRAN_CR ;
         END IF;
         OPEN F_CUR_TRAN_CR ;
         FETCH F_CUR_TRAN_CR INTO P_TRAN_CR ;
         IF F_CUR_TRAN_CR%NOTFOUND THEN
            P_TRAN_CR := 0;
         END IF;
         CLOSE F_CUR_TRAN_CR ;
         P_MTD_DR  :=  NVL(P_DR_MTD,0) + NVL(P_TRAN_DR,0) ;
         P_MTD_CR  :=  NVL(P_CR_MTD,0) + NVL(P_TRAN_CR,0) ;
         P_OP_BAL := NVL(P_OP_BAL,0) + (NVL(P_TRAN_DR,0) - NVL(P_TRAN_CR,0));
     ELSE
         IF F_PRV_OP_BAL%ISOPEN THEN
               CLOSE F_PRV_OP_BAL ;
         END IF;
         OPEN F_PRV_OP_BAL ;
         FETCH F_PRV_OP_BAL INTO P_DR_MTD, P_CR_MTD, P_OP_BAL ;
         IF F_PRV_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_PRV_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
           P_MTD_DR  :=  NVL(P_DR_MTD,0) + NVL(P_TRAN_DR,0) ;
           P_MTD_CR  :=  NVL(P_CR_MTD,0) + NVL(P_TRAN_CR,0) ;
           P_OP_BAL := NVL(P_OP_BAL,0) + (NVL(P_TRAN_DR,0) - NVL(P_TRAN_CR,0));
         END IF;
         IF F_PRV_TRAN_DR%ISOPEN THEN
               CLOSE F_PRV_TRAN_DR ;
         END IF;
         OPEN F_PRV_TRAN_DR ;
         FETCH F_PRV_TRAN_DR INTO P_TRAN_DR ;
         IF F_PRV_TRAN_DR%NOTFOUND THEN
            P_TRAN_DR := 0;
         END IF;
         CLOSE F_PRV_TRAN_DR ;
         IF F_PRV_TRAN_CR%ISOPEN THEN
               CLOSE F_PRV_TRAN_CR ;
         END IF;
         OPEN F_PRV_TRAN_CR ;
         FETCH F_PRV_TRAN_CR INTO P_TRAN_CR ;
         IF F_PRV_TRAN_CR%NOTFOUND THEN
            P_TRAN_CR := 0;
         END IF;
         CLOSE F_PRV_TRAN_CR ;
         P_MTD_DR  :=  NVL(P_DR_MTD,0) + NVL(P_TRAN_DR,0) ;
         P_MTD_CR  :=  NVL(P_CR_MTD,0) + NVL(P_TRAN_CR,0) ;
         P_OP_BAL := NVL(P_OP_BAL,0) + (NVL(P_TRAN_DR,0) - NVL(P_TRAN_CR,0));
     END IF;
END;
Press <Enter> to continue...
/
CREATE OR REPLACE FUNCTION  F_GET_SUB_LC_OPBAL
                            ( P_COMP_CODE VARCHAR2,
                              P_ASOF_DT DATE,
                              P_MAIN_ACNT_CODE VARCHAR2,
                              P_SUB_ACNT_CODE VARCHAR2,
                              P_CURR_CODE VARCHAR2)
                              RETURN NUMBER IS
P_CUR_ACNT_YEAR NUMBER(2);
P_ACNT_YEAR     NUMBER(2);
P_CAL_YEAR      NUMBER(2);
P_CAL_MONTH     NUMBER(2);
P_FRM_DT        DATE;
P_TMP_ASOF_DT   DATE;
P_OP_BAL  NUMBER(14,3);
P_TRAN    NUMBER(14,3);
CURSOR F_ACNT_PERIOD IS
       SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
              TO_DATE(TO_CHAR(APER_FRM_DT))
       FROM   FM_ACNT_PERIOD
       WHERE  (APER_COMP_CODE = P_COMP_CODE)
       AND    (P_TMP_ASOF_DT BETWEEN APER_FRM_DT AND APER_TO_DT);
CURSOR F_CUR_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_PRV_OP_BAL  IS
       SELECT SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    ABAL_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(ABAL_CURR_CODE,'XXXX'))
       AND    (((ABAL_CAL_YEAR = P_CAL_YEAR) AND
                (ABAL_CAL_MONTH < P_CAL_MONTH)) OR
               (ABAL_CAL_YEAR < P_CAL_YEAR));
CURSOR F_CUR_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_CUR_TRANS_DETAIL, FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
CURSOR F_PRV_TRAN  IS
       SELECT SUM(DECODE(TD_DOC_DRCR_FLAG, 'D',1,'C',-1,0) *
                  NVL(TD_DOC_AMT, 0))
       FROM   FT_PRV_TRANS_DETAIL, FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE   = P_COMP_CODE
       AND    TH_DOC_DT BETWEEN P_FRM_DT AND (P_TMP_ASOF_DT - 1)
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    NVL(TD_CURR_CODE,'XXXX') =
                 NVL(P_CURR_CODE, NVL(TD_CURR_CODE,'XXXX'))
       AND    TH_COMP_CODE   = TD_COMP_CODE
       AND    TH_ACNT_YEAR   = TD_ACNT_YEAR
       AND    TH_TRAN_CODE   = TD_TRAN_CODE
       AND    TH_DOC_NO      = TD_DOC_NO;
BEGIN
     P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
     P_TMP_ASOF_DT := TO_DATE(TO_CHAR(P_ASOF_DT));
     IF F_ACNT_PERIOD%ISOPEN THEN
           CLOSE F_ACNT_PERIOD;
     END IF;
     OPEN F_ACNT_PERIOD;
     FETCH F_ACNT_PERIOD INTO P_ACNT_YEAR, P_CAL_YEAR,
                              P_CAL_MONTH, P_FRM_DT   ;
     IF F_ACNT_PERIOD%NOTFOUND THEN
          CLOSE F_ACNT_PERIOD;
          RETURN(0);
     END IF;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
         IF F_CUR_OP_BAL%ISOPEN THEN
               CLOSE F_CUR_OP_BAL ;
         END IF;
         OPEN F_CUR_OP_BAL ;
         FETCH F_CUR_OP_BAL INTO P_OP_BAL ;
         IF F_CUR_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_CUR_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_CUR_TRAN%ISOPEN THEN
               CLOSE F_CUR_TRAN ;
         END IF;
         OPEN F_CUR_TRAN ;
         FETCH F_CUR_TRAN INTO P_TRAN ;
         IF F_CUR_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_CUR_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     ELSE
         IF F_PRV_OP_BAL%ISOPEN THEN
               CLOSE F_PRV_OP_BAL ;
         END IF;
         OPEN F_PRV_OP_BAL ;
         FETCH F_PRV_OP_BAL INTO P_OP_BAL ;
         IF F_PRV_OP_BAL%NOTFOUND THEN
            P_OP_BAL := 0;
         END IF;
         CLOSE F_PRV_OP_BAL ;
         IF P_FRM_DT = P_TMP_ASOF_DT THEN
            RETURN(P_OP_BAL);
         END IF;
         IF F_PRV_TRAN%ISOPEN THEN
               CLOSE F_PRV_TRAN ;
         END IF;
         OPEN F_PRV_TRAN ;
         FETCH F_PRV_TRAN INTO P_TRAN ;
         IF F_PRV_TRAN%NOTFOUND THEN
            P_TRAN := 0;
         END IF;
         CLOSE F_PRV_TRAN ;
         P_OP_BAL := NVL(P_OP_BAL,0) + NVL(P_TRAN,0);
         RETURN(P_OP_BAL);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_LEVEL (P_FORMAT_ID IN OUT NUMBER) AS
P_PREV_FORMAT_ID  NUMBER(3);
P_LVL_CODE        VARCHAR2(6);
P_LVL_PARENT_CODE VARCHAR2(6);
P_LEVEL           NUMBER(2);
P_SEQ_NO          NUMBER(3);
P_PREV_LEVEL      NUMBER(2);
P_PARENT_SEQ      VARCHAR2(27);
P_SEQ             VARCHAR2(27);
P_LVL_ONE_SEQ     NUMBER(3);
P_LVL_TYPE        VARCHAR(1);
CURSOR  F_SEL_LEVEL IS
SELECT  LVL_FORMAT_ID, LVL_CODE, LVL_PARENT_CODE, LEVEL,
        LVL_ACNT_TYPE
FROM    FM_COA_LEVEL
WHERE   LVL_FORMAT_ID = P_FORMAT_ID
CONNECT BY PRIOR NVL(LVL_CODE,0) = NVL(LVL_PARENT_CODE,0) AND
           PRIOR NVL(LVL_FORMAT_ID,0) = NVL(LVL_FORMAT_ID,0)
START WITH LVL_PARENT_CODE IS NULL
ORDER BY LVL_FORMAT_ID, 4,
         DECODE(LVL_ACNT_TYPE,'A',1,'L',2,'I',3,'E',4,9), LVL_CODE;
CURSOR F_SEL_SEQ IS
SELECT LS_LVL_SEQ, LS_LVL_TYPE
FROM   FW_LEVEL
WHERE  LS_FORMAT_ID = P_FORMAT_ID
AND    LS_LVL_CODE = P_LVL_PARENT_CODE;
CURSOR F_SEQ_KEY IS
SELECT LS_FORMAT_ID, LS_LVL_CODE
FROM   FW_LEVEL
WHERE  LS_FORMAT_ID = P_FORMAT_ID
ORDER BY LS_LVL_SEQ;
BEGIN
DELETE FROM FW_LEVEL
       WHERE LS_FORMAT_ID = P_FORMAT_ID;
IF F_SEL_LEVEL%ISOPEN THEN
     CLOSE F_SEL_LEVEL;
END IF;
OPEN F_SEL_LEVEL;
P_LVL_ONE_SEQ := 100;
P_PREV_LEVEL := 0;
LOOP
FETCH F_SEL_LEVEL INTO P_FORMAT_ID, P_LVL_CODE, P_LVL_PARENT_CODE, P_LEVEL,
                       P_LVL_TYPE;
EXIT WHEN F_SEL_LEVEL%NOTFOUND;
IF P_PREV_LEVEL = 0 THEN
   P_SEQ_NO := 100;
   P_PREV_FORMAT_ID := P_FORMAT_ID;
   P_PREV_LEVEL := P_LEVEL;
ELSE
     IF P_FORMAT_ID != P_PREV_FORMAT_ID THEN
        P_SEQ_NO := 100;
        P_PREV_FORMAT_ID := P_FORMAT_ID;
        P_PREV_LEVEL := P_LEVEL;
     ELSE
        IF P_LEVEL != P_PREV_LEVEL THEN
           P_SEQ_NO := 100;
           P_PREV_LEVEL := P_LEVEL;
        END IF;
     END IF;
END IF;
IF P_LEVEL != 1 THEN
     IF F_SEL_SEQ%ISOPEN THEN
          CLOSE F_SEL_SEQ;
     END IF;
     OPEN F_SEL_SEQ;
     FETCH F_SEL_SEQ INTO P_PARENT_SEQ, P_LVL_TYPE;
     IF F_SEL_SEQ%NOTFOUND THEN
          P_PARENT_SEQ := NULL;
     END IF;
     CLOSE F_SEL_SEQ;
ELSE
     P_PARENT_SEQ := P_LVL_ONE_SEQ;
     P_SEQ_NO     := NULL;
     P_LVL_ONE_SEQ := NVL(P_LVL_ONE_SEQ,0) + 1;
END IF;
P_SEQ := P_PARENT_SEQ || LTRIM(RTRIM(TO_CHAR(P_SEQ_NO)));
P_SEQ_NO := P_SEQ_NO + 1;
INSERT INTO FW_LEVEL
(LS_FORMAT_ID, LS_LVL_CODE, LS_LVL_SEQ, LS_LVL_TYPE)
VALUES
(P_FORMAT_ID, P_LVL_CODE, P_SEQ, P_LVL_TYPE);
END LOOP;
CLOSE F_SEL_LEVEL;
IF F_SEQ_KEY%ISOPEN THEN
     CLOSE F_SEQ_KEY;
END IF;
OPEN F_SEQ_KEY;
P_SEQ_NO := 1;
LOOP
FETCH F_SEQ_KEY INTO P_FORMAT_ID, P_LVL_CODE;
EXIT WHEN F_SEQ_KEY%NOTFOUND;
UPDATE FM_COA_LEVEL
SET    LVL_SEQ_NO = P_SEQ_NO
WHERE  LVL_FORMAT_ID = P_FORMAT_ID
AND    LVL_CODE = P_LVL_CODE;
P_SEQ_NO := P_SEQ_NO + 1;
END LOOP;
CLOSE F_SEQ_KEY;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_DEPT_SUM_REP
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_DEPT_1           IN    VARCHAR2,
                  P_DEPT_2           IN    VARCHAR2,
                  P_DEPT_3           IN    VARCHAR2,
                  P_DEPT_4           IN    VARCHAR2,
                  P_DEPT_5           IN    VARCHAR2,
                  P_DEPT_6           IN    VARCHAR2,
                  P_DEPT_7           IN    VARCHAR2,
                  P_INCL_ACNT        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
   PREV_STR             VARCHAR2(27);
   RECORD_SEQ           NUMBER(6);
   HEAD_FLAG            VARCHAR2(1);
   FIRST_REC            NUMBER(1);
   BLANK_REC_FLAG       VARCHAR2(1);
   LVL_TYPE             VARCHAR2(1);
   P_LVL_CODE           VARCHAR2(6);
   P_LVL_NAME           VARCHAR2(50);
   P_LVL_TYPE           VARCHAR2(1);
   P_PARENT_LVL_CODE    VARCHAR2(6);
   P_TOTAL_FLAG         VARCHAR2(1);
   P_YTD_BAL_1          NUMBER(14,3);
   P_YR_OPEN_BAL_1      NUMBER(14,3);
   P_YTD_BAL_2          NUMBER(14,3);
   P_YR_OPEN_BAL_2      NUMBER(14,3);
   P_YTD_BAL_3          NUMBER(14,3);
   P_YR_OPEN_BAL_3      NUMBER(14,3);
   P_YTD_BAL_4          NUMBER(14,3);
   P_YR_OPEN_BAL_4      NUMBER(14,3);
   P_YTD_BAL_5          NUMBER(14,3);
   P_YR_OPEN_BAL_5      NUMBER(14,3);
   P_YTD_BAL_6          NUMBER(14,3);
   P_YR_OPEN_BAL_6      NUMBER(14,3);
   P_YTD_BAL_7          NUMBER(14,3);
   P_YR_OPEN_BAL_7      NUMBER(14,3);
   P_YTD_BAL_O          NUMBER(14,3);
   P_YR_OPEN_BAL_O      NUMBER(14,3);
   T_LVL_CODE           VARCHAR2(6);
   T_LVL_NAME           VARCHAR2(50);
   T_LVL_TYPE           VARCHAR2(1);
   T_LVL_SEQ            NUMBER(6);
   T_PARENT_LVL_CODE    VARCHAR2(6);
   T_MAIN_ACNT_CODE     VARCHAR2(6);
   T_TOTAL_FLAG         VARCHAR2(1);
   T_LVL_STR            VARCHAR2(27);
   T_YTD_BAL_1          NUMBER(14,3);
   T_YR_OPEN_BAL_1      NUMBER(14,3);
   T_YTD_BAL_2          NUMBER(14,3);
   T_YR_OPEN_BAL_2      NUMBER(14,3);
   T_YTD_BAL_3          NUMBER(14,3);
   T_YR_OPEN_BAL_3      NUMBER(14,3);
   T_YTD_BAL_4          NUMBER(14,3);
   T_YR_OPEN_BAL_4      NUMBER(14,3);
   T_YTD_BAL_5          NUMBER(14,3);
   T_YR_OPEN_BAL_5      NUMBER(14,3);
   T_YTD_BAL_6          NUMBER(14,3);
   T_YR_OPEN_BAL_6      NUMBER(14,3);
   T_YTD_BAL_7          NUMBER(14,3);
   T_YR_OPEN_BAL_7      NUMBER(14,3);
   T_YTD_BAL_O          NUMBER(14,3);
   T_YR_OPEN_BAL_O      NUMBER(14,3);
   TEMP_LVL_CODE           VARCHAR2(6);
   TEMP_LVL_NAME           VARCHAR2(50);
   TEMP_LVL_TYPE           VARCHAR2(1);
   TEMP_LVL_SEQ            NUMBER(6);
   TEMP_PARENT_LVL_CODE    VARCHAR2(6);
   TEMP_MAIN_ACNT_CODE     VARCHAR2(6);
   TEMP_TOTAL_FLAG         VARCHAR2(1);
   TEMP_LVL_STR            VARCHAR2(27);
   TEMP_YTD_BAL_1          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_1      NUMBER(14,3);
   TEMP_YTD_BAL_2          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_2      NUMBER(14,3);
   TEMP_YTD_BAL_3          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_3      NUMBER(14,3);
   TEMP_YTD_BAL_4          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_4      NUMBER(14,3);
   TEMP_YTD_BAL_5          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_5      NUMBER(14,3);
   TEMP_YTD_BAL_6          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_6      NUMBER(14,3);
   TEMP_YTD_BAL_7          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_7      NUMBER(14,3);
   TEMP_YTD_BAL_O          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_O      NUMBER(14,3);
   CURSOR C1 IS
          SELECT MYS_LVL_CODE, MYS_LVL_NAME, MYS_LVL_TYPE,
                 MYS_PARENT_LVL_CODE,
                 DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0'),
                 LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_2, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_2, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_3, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_3, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_4, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_4, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_5, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_5, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_6, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_6, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_7, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_7, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 0,
                     P_DEPT_2, 0, P_DEPT_3, 0, P_DEPT_4, 0, P_DEPT_5, 0,
                     P_DEPT_6, 0, P_DEPT_7, 0, 1) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 0,
                     P_DEPT_2, 0, P_DEPT_3, 0, P_DEPT_4, 0, P_DEPT_5, 0,
                     P_DEPT_6, 0, P_DEPT_7, 0, 1) * MYS_YR_OPEN_BAL_1)
          FROM   FW_LEVEL, FM_COA_LEVEL, FW_MAIN_YEAR_SUM
          WHERE  MYS_KEY_NO = P_KEY_NO
          AND    MYS_FORMAT_ID = P_FORMAT_ID
          AND    LVL_FORMAT_ID = MYS_FORMAT_ID
          AND    LVL_CODE = MYS_LVL_CODE
          AND    LS_FORMAT_ID = LVL_FORMAT_ID
          AND    LS_LVL_CODE = LVL_CODE
          GROUP BY MYS_LVL_CODE, MYS_LVL_NAME, MYS_LVL_TYPE,
                   MYS_PARENT_LVL_CODE,
                   DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0'),
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N')
          ORDER  BY LS_LVL_SEQ,
                   DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0');
   CURSOR C2 IS
          SELECT MYS_LVL_CODE, '   TOTAL ' || MYS_LVL_NAME, MYS_LVL_TYPE,
                 MYS_PARENT_LVL_CODE,
                 NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_2, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_2, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_3, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_3, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_4, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_4, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_5, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_5, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_6, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_6, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_7, 1, 0) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_7, 1, 0) * MYS_YR_OPEN_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 0,
                     P_DEPT_2, 0, P_DEPT_3, 0, P_DEPT_4, 0, P_DEPT_5, 0,
                     P_DEPT_6, 0, P_DEPT_7, 0, 1) * MYS_YTD_BAL_1),
                 SUM(DECODE(MYS_DEPT_CODE, P_DEPT_1, 0,
                     P_DEPT_2, 0, P_DEPT_3, 0, P_DEPT_4, 0, P_DEPT_5, 0,
                     P_DEPT_6, 0, P_DEPT_7, 0, 1) * MYS_YR_OPEN_BAL_1)
          FROM   FM_COA_LEVEL, FW_MAIN_YEAR_SUM, FW_LEVEL
          WHERE  LS_FORMAT_ID = P_FORMAT_ID
          AND    LS_LVL_SEQ = PREV_STR
          AND    MYS_KEY_NO = P_KEY_NO
          AND    MYS_FORMAT_ID = LS_FORMAT_ID
          AND    MYS_LVL_CODE = LS_LVL_CODE
          AND    LVL_FORMAT_ID = MYS_FORMAT_ID
          AND    LVL_CODE = MYS_LVL_CODE
          GROUP BY MYS_LVL_CODE, '   TOTAL ' || MYS_LVL_NAME, MYS_LVL_TYPE,
                   MYS_PARENT_LVL_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N');
  PROCEDURE INSERT_BLANK_REC IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     LVL_TYPE := T_LVL_TYPE;
     INSERT INTO FW_MAIN_DEPT_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_SEQ, MYS_LVL_TYPE)
     VALUES (P_KEY_NO, P_FORMAT_ID, RECORD_SEQ, LVL_TYPE);
  END;
  PROCEDURE INSERT_HEAD IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     INSERT INTO FW_MAIN_DEPT_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
            MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
            MYS_PARENT_LVL_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, T_LVL_CODE,
             T_LVL_NAME, T_LVL_TYPE, RECORD_SEQ,
             T_PARENT_LVL_CODE);
     INSERT_BLANK_REC;
  END;
  PROCEDURE INSERT_REC IS
     CURSOR C3 IS
       SELECT MAIN_ACNT_NAME
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = T_MAIN_ACNT_CODE;
     C3_LVL_NAME	VARCHAR2(30);
     M_DIFF             NUMBER(2);
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     IF NVL(T_MAIN_ACNT_CODE, '0') != '0' THEN
        IF C3%ISOPEN THEN
           CLOSE C3;
        END IF;
        OPEN C3;
        FETCH C3 INTO C3_LVL_NAME;
        IF C3%FOUND THEN
             M_DIFF := LENGTH(T_LVL_NAME) - LENGTH(LTRIM(T_LVL_NAME));
             T_LVL_NAME := LPAD(C3_LVL_NAME, LENGTH(C3_LVL_NAME) + M_DIFF);
        ELSE
           CLOSE C3;
           GOTO END_LABEL;
        END IF;
        CLOSE C3;
     END IF;
     INSERT INTO FW_MAIN_DEPT_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
            MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
            MYS_PARENT_LVL_CODE, MYS_MAIN_ACNT_CODE,
            MYS_YTD_BAL_1, MYS_YR_OPEN_BAL_1,
            MYS_YTD_BAL_2, MYS_YR_OPEN_BAL_2,
            MYS_YTD_BAL_3, MYS_YR_OPEN_BAL_3,
            MYS_YTD_BAL_4, MYS_YR_OPEN_BAL_4,
            MYS_YTD_BAL_5, MYS_YR_OPEN_BAL_5,
            MYS_YTD_BAL_6, MYS_YR_OPEN_BAL_6,
            MYS_YTD_BAL_7, MYS_YR_OPEN_BAL_7,
            MYS_YTD_BAL_O, MYS_YR_OPEN_BAL_O)
     VALUES (P_KEY_NO, P_FORMAT_ID,
            T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
            RECORD_SEQ, T_PARENT_LVL_CODE,
            T_MAIN_ACNT_CODE,
            T_YTD_BAL_1, T_YR_OPEN_BAL_1,
            T_YTD_BAL_2, T_YR_OPEN_BAL_2,
            T_YTD_BAL_3, T_YR_OPEN_BAL_3,
            T_YTD_BAL_4, T_YR_OPEN_BAL_4,
            T_YTD_BAL_5, T_YR_OPEN_BAL_5,
            T_YTD_BAL_6, T_YR_OPEN_BAL_6,
            T_YTD_BAL_7, T_YR_OPEN_BAL_7,
            T_YTD_BAL_O, T_YR_OPEN_BAL_O);
    <<END_LABEL>>
      NULL;
  END;
  PROCEDURE PROCESS_TOTAL IS
  BEGIN
    IF C2%ISOPEN THEN
       CLOSE C2;
    END IF;
    OPEN C2;
    FETCH C2 INTO P_LVL_CODE, P_LVL_NAME, P_LVL_TYPE,
                  P_PARENT_LVL_CODE,
                  P_TOTAL_FLAG,
                  P_YTD_BAL_1, P_YR_OPEN_BAL_1,
                  P_YTD_BAL_2, P_YR_OPEN_BAL_2,
                  P_YTD_BAL_3, P_YR_OPEN_BAL_3,
                  P_YTD_BAL_4, P_YR_OPEN_BAL_4,
                  P_YTD_BAL_5, P_YR_OPEN_BAL_5,
                  P_YTD_BAL_6, P_YR_OPEN_BAL_6,
                  P_YTD_BAL_7, P_YR_OPEN_BAL_7,
                  P_YTD_BAL_O, P_YR_OPEN_BAL_O;
    IF C2%FOUND AND P_TOTAL_FLAG = 'Y' THEN
       RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
       INSERT INTO FW_MAIN_DEPT_SUM_REP (
              MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
              MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
              MYS_PARENT_LVL_CODE,
              MYS_YTD_BAL_1, MYS_YR_OPEN_BAL_1,
              MYS_YTD_BAL_2, MYS_YR_OPEN_BAL_2,
              MYS_YTD_BAL_3, MYS_YR_OPEN_BAL_3,
              MYS_YTD_BAL_4, MYS_YR_OPEN_BAL_4,
              MYS_YTD_BAL_5, MYS_YR_OPEN_BAL_5,
              MYS_YTD_BAL_6, MYS_YR_OPEN_BAL_6,
              MYS_YTD_BAL_7, MYS_YR_OPEN_BAL_7,
              MYS_YTD_BAL_O, MYS_YR_OPEN_BAL_O)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE,
              P_LVL_NAME, P_LVL_TYPE, RECORD_SEQ,
              P_PARENT_LVL_CODE,
              P_YTD_BAL_1, P_YR_OPEN_BAL_1,
              P_YTD_BAL_2, P_YR_OPEN_BAL_2,
              P_YTD_BAL_3, P_YR_OPEN_BAL_3,
              P_YTD_BAL_4, P_YR_OPEN_BAL_4,
              P_YTD_BAL_5, P_YR_OPEN_BAL_5,
              P_YTD_BAL_6, P_YR_OPEN_BAL_6,
              P_YTD_BAL_7, P_YR_OPEN_BAL_7,
              P_YTD_BAL_O, P_YR_OPEN_BAL_O);
       INSERT_BLANK_REC;
    END IF;
    CLOSE C2;
    HEAD_FLAG := 'N';
END;
BEGIN
   DELETE FROM FW_MAIN_DEPT_SUM_REP
          WHERE MYS_KEY_NO = P_KEY_NO;
   PREV_STR := '';
   RECORD_SEQ := 0;
   HEAD_FLAG := 'N';
   FIRST_REC := 0;
   BLANK_REC_FLAG := 'N';
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF;
   OPEN C1;
LOOP
   FETCH C1 INTO TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
                 TEMP_PARENT_LVL_CODE,
                 TEMP_MAIN_ACNT_CODE,
                 TEMP_LVL_STR, TEMP_TOTAL_FLAG,
                 TEMP_YTD_BAL_1, TEMP_YR_OPEN_BAL_1,
                 TEMP_YTD_BAL_2, TEMP_YR_OPEN_BAL_2,
                 TEMP_YTD_BAL_3, TEMP_YR_OPEN_BAL_3,
                 TEMP_YTD_BAL_4, TEMP_YR_OPEN_BAL_4,
                 TEMP_YTD_BAL_5, TEMP_YR_OPEN_BAL_5,
                 TEMP_YTD_BAL_6, TEMP_YR_OPEN_BAL_6,
                 TEMP_YTD_BAL_7, TEMP_YR_OPEN_BAL_7,
                 TEMP_YTD_BAL_O, TEMP_YR_OPEN_BAL_O;
    IF FIRST_REC = 0 THEN
       IF C1%NOTFOUND THEN
          EXIT;
       END IF;
       FIRST_REC := 1;
    ELSE
      IF C1%NOTFOUND THEN
         INSERT_REC;
         EXIT;
      END IF;
      IF LENGTH(T_LVL_STR) > LENGTH(TEMP_LVL_STR) THEN
         INSERT_REC;
         INSERT_BLANK_REC;
	 PROCESS_TOTAL;
         LOOP
            PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
            IF LENGTH(PREV_STR) >= LENGTH(TEMP_LVL_STR) THEN
	       PROCESS_TOTAL;
            ELSE
               EXIT;
            END IF;
         END LOOP;
         BLANK_REC_FLAG := 'N';
      ELSIF LENGTH(T_LVL_STR) < LENGTH(TEMP_LVL_STR) THEN
            PREV_STR := T_LVL_STR;
            IF T_TOTAL_FLAG = 'Y' THEN
               IF BLANK_REC_FLAG = 'D' THEN
                  INSERT_BLANK_REC;
                  BLANK_REC_FLAG := 'N';
               END IF;
               INSERT_HEAD;
            END IF;
      ELSE
        BLANK_REC_FLAG := 'D';
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           INSERT_REC;
           IF NVL(SUBSTR(T_LVL_STR, 1, LENGTH(T_LVL_STR) - 3), '1') !=
              NVL(SUBSTR(TEMP_LVL_STR, 1, LENGTH(TEMP_LVL_STR) - 3), '2') THEN
                INSERT_BLANK_REC;
                BLANK_REC_FLAG := 'N';
           END IF;
        END IF;
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           NULL;
        ELSIF T_LVL_STR != TEMP_LVL_STR THEN
              INSERT_REC;
              INSERT_BLANK_REC;
              IF HEAD_FLAG = 'T' THEN
                 PROCESS_TOTAL;
                 PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
              END IF;
        ELSIF T_LVL_STR = TEMP_LVL_STR THEN
              IF T_TOTAL_FLAG = 'Y' AND HEAD_FLAG = 'N' THEN
                 INSERT_HEAD;
                 PREV_STR := T_LVL_STR;
                 HEAD_FLAG := 'T';
              END IF;
              INSERT_REC;
        END IF;
      END IF;
   END IF;
      SELECT TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
             TEMP_LVL_SEQ, TEMP_PARENT_LVL_CODE,
             TEMP_MAIN_ACNT_CODE,
             TEMP_LVL_STR, TEMP_TOTAL_FLAG,
             TEMP_YTD_BAL_1, TEMP_YR_OPEN_BAL_1,
             TEMP_YTD_BAL_2, TEMP_YR_OPEN_BAL_2,
             TEMP_YTD_BAL_3, TEMP_YR_OPEN_BAL_3,
             TEMP_YTD_BAL_4, TEMP_YR_OPEN_BAL_4,
             TEMP_YTD_BAL_5, TEMP_YR_OPEN_BAL_5,
             TEMP_YTD_BAL_6, TEMP_YR_OPEN_BAL_6,
             TEMP_YTD_BAL_7, TEMP_YR_OPEN_BAL_7,
             TEMP_YTD_BAL_O, TEMP_YR_OPEN_BAL_O
      INTO   T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
             T_LVL_SEQ, T_PARENT_LVL_CODE,
             T_MAIN_ACNT_CODE,
             T_LVL_STR, T_TOTAL_FLAG,
             T_YTD_BAL_1, T_YR_OPEN_BAL_1,
             T_YTD_BAL_2, T_YR_OPEN_BAL_2,
             T_YTD_BAL_3, T_YR_OPEN_BAL_3,
             T_YTD_BAL_4, T_YR_OPEN_BAL_4,
             T_YTD_BAL_5, T_YR_OPEN_BAL_5,
             T_YTD_BAL_6, T_YR_OPEN_BAL_6,
             T_YTD_BAL_7, T_YR_OPEN_BAL_7,
             T_YTD_BAL_O, T_YR_OPEN_BAL_O
      FROM   DUAL;
END LOOP;
   CLOSE C1;
   INSERT_BLANK_REC;
   IF PREV_STR IS NOT NULL THEN
      PROCESS_TOTAL;
   END IF;
   LOOP
      PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
      IF LENGTH(PREV_STR) > 0 THEN
	 PROCESS_TOTAL;
      ELSE
         EXIT;
      END IF;
   END LOOP;
END;
CREATE OR REPLACE PROCEDURE F_MAIN_LEVEL_BC_SUM_REP
/
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_ERR_NO          OUT    NUMBER) AS
   PREV_STR             VARCHAR2(27);
   RECORD_SEQ           NUMBER(6);
   HEAD_FLAG            VARCHAR2(1);
   FIRST_REC            NUMBER(1);
   BLANK_REC_FLAG       VARCHAR2(1);
   LVL_TYPE             VARCHAR2(1);
   P_LVL_CODE           VARCHAR2(6);
   P_LVL_NAME           VARCHAR2(50);
   P_LVL_TYPE           VARCHAR2(1);
   P_PARENT_LVL_CODE    VARCHAR2(6);
   P_TOTAL_FLAG         VARCHAR2(1);
   P_MTD_BAL            NUMBER(14,3);
   P_YTD_BAL            NUMBER(14,3);
   P_ANN_BAL            NUMBER(14,3);
   P_YR_OPEN_BAL        NUMBER(14,3);
   P_PREV_MTD_BAL       NUMBER(14,3);
   P_PREV_YTD_BAL       NUMBER(14,3);
   P_PREV_ANN_BAL       NUMBER(14,3);
   P_PREV_YR_OPEN_BAL   NUMBER(14,3);
   P_MTD_BUD            NUMBER(14,3);
   P_YTD_BUD            NUMBER(14,3);
   P_ANN_BUD            NUMBER(14,3);
   P_NEXT_MTD_BUD       NUMBER(14,3);
   P_NEXT_YTD_BUD       NUMBER(14,3);
   P_NEXT_ANN_BUD       NUMBER(14,3);
   P_M01_BUD            NUMBER(14,3);
   P_M02_BUD            NUMBER(14,3);
   P_M03_BUD            NUMBER(14,3);
   P_M04_BUD            NUMBER(14,3);
   P_M05_BUD            NUMBER(14,3);
   P_M06_BUD            NUMBER(14,3);
   P_M07_BUD            NUMBER(14,3);
   P_M08_BUD            NUMBER(14,3);
   P_M09_BUD            NUMBER(14,3);
   P_M10_BUD            NUMBER(14,3);
   P_M11_BUD            NUMBER(14,3);
   P_M12_BUD            NUMBER(14,3);
   T_DIVN_CODE          VARCHAR2(6);
   T_DEPT_CODE          VARCHAR2(6);
   T_LVL_CODE           VARCHAR2(6);
   T_LVL_NAME           VARCHAR2(50);
   T_LVL_TYPE           VARCHAR2(1);
   T_LVL_SEQ            NUMBER(6);
   T_PARENT_LVL_CODE    VARCHAR2(6);
   T_MAIN_ACNT_CODE     VARCHAR2(6);
   T_TOTAL_FLAG         VARCHAR2(1);
   T_LVL_STR            VARCHAR2(27);
   T_MTD_BAL            NUMBER(14,3);
   T_YTD_BAL            NUMBER(14,3);
   T_ANN_BAL            NUMBER(14,3);
   T_YR_OPEN_BAL        NUMBER(14,3);
   T_PREV_MTD_BAL       NUMBER(14,3);
   T_PREV_YTD_BAL       NUMBER(14,3);
   T_PREV_ANN_BAL       NUMBER(14,3);
   T_PREV_YR_OPEN_BAL   NUMBER(14,3);
   T_MTD_BUD            NUMBER(14,3);
   T_YTD_BUD            NUMBER(14,3);
   T_ANN_BUD            NUMBER(14,3);
   T_NEXT_MTD_BUD       NUMBER(14,3);
   T_NEXT_YTD_BUD       NUMBER(14,3);
   T_NEXT_ANN_BUD       NUMBER(14,3);
   T_M01_BUD            NUMBER(14,3);
   T_M02_BUD            NUMBER(14,3);
   T_M03_BUD            NUMBER(14,3);
   T_M04_BUD            NUMBER(14,3);
   T_M05_BUD            NUMBER(14,3);
   T_M06_BUD            NUMBER(14,3);
   T_M07_BUD            NUMBER(14,3);
   T_M08_BUD            NUMBER(14,3);
   T_M09_BUD            NUMBER(14,3);
   T_M10_BUD            NUMBER(14,3);
   T_M11_BUD            NUMBER(14,3);
   T_M12_BUD            NUMBER(14,3);
   TEMP_DIVN_CODE          VARCHAR2(6);
   TEMP_DEPT_CODE          VARCHAR2(6);
   TEMP_LVL_CODE           VARCHAR2(6);
   TEMP_LVL_NAME           VARCHAR2(50);
   TEMP_LVL_TYPE           VARCHAR2(1);
   TEMP_LVL_SEQ            NUMBER(6);
   TEMP_PARENT_LVL_CODE    VARCHAR2(6);
   TEMP_MAIN_ACNT_CODE     VARCHAR2(6);
   TEMP_TOTAL_FLAG         VARCHAR2(1);
   TEMP_LVL_STR            VARCHAR2(27);
   TEMP_MTD_BAL            NUMBER(14,3);
   TEMP_YTD_BAL            NUMBER(14,3);
   TEMP_ANN_BAL            NUMBER(14,3);
   TEMP_YR_OPEN_BAL        NUMBER(14,3);
   TEMP_PREV_MTD_BAL       NUMBER(14,3);
   TEMP_PREV_YTD_BAL       NUMBER(14,3);
   TEMP_PREV_ANN_BAL       NUMBER(14,3);
   TEMP_PREV_YR_OPEN_BAL   NUMBER(14,3);
   TEMP_MTD_BUD            NUMBER(14,3);
   TEMP_YTD_BUD            NUMBER(14,3);
   TEMP_ANN_BUD            NUMBER(14,3);
   TEMP_NEXT_MTD_BUD       NUMBER(14,3);
   TEMP_NEXT_YTD_BUD       NUMBER(14,3);
   TEMP_NEXT_ANN_BUD       NUMBER(14,3);
   TEMP_M01_BUD            NUMBER(14,3);
   TEMP_M02_BUD            NUMBER(14,3);
   TEMP_M03_BUD            NUMBER(14,3);
   TEMP_M04_BUD            NUMBER(14,3);
   TEMP_M05_BUD            NUMBER(14,3);
   TEMP_M06_BUD            NUMBER(14,3);
   TEMP_M07_BUD            NUMBER(14,3);
   TEMP_M08_BUD            NUMBER(14,3);
   TEMP_M09_BUD            NUMBER(14,3);
   TEMP_M10_BUD            NUMBER(14,3);
   TEMP_M11_BUD            NUMBER(14,3);
   TEMP_M12_BUD            NUMBER(14,3);
   CURSOR C1 IS
          SELECT DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DIVN_CODE),
                 DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DEPT_CODE),
                 MLS_LVL_CODE, MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 MLS_MAIN_ACNT_CODE,
                 LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FW_LEVEL, FM_COA_LEVEL, FW_MAIN_LEVEL_SUM
          WHERE  MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = P_FORMAT_ID
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          AND    LS_FORMAT_ID = LVL_FORMAT_ID
          AND    LS_LVL_CODE = LVL_CODE
          GROUP BY DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DIVN_CODE),
                   DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DEPT_CODE),
		   MLS_LVL_CODE,
                   MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   MLS_MAIN_ACNT_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N')
          ORDER  BY LS_LVL_SEQ,
                   MLS_MAIN_ACNT_CODE,
                   DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DIVN_CODE),
                   DECODE(MLS_MAIN_ACNT_CODE, '0', '0', MLS_DEPT_CODE);
   CURSOR C2 IS
          SELECT MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FM_COA_LEVEL, FW_MAIN_LEVEL_SUM, FW_LEVEL
          WHERE  LS_FORMAT_ID = P_FORMAT_ID
          AND    LS_LVL_SEQ = PREV_STR
          AND    MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = LS_FORMAT_ID
          AND    MLS_LVL_CODE = LS_LVL_CODE
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          GROUP BY MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N');
  PROCEDURE INSERT_BLANK_REC IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     LVL_TYPE := T_LVL_TYPE;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_SEQ,
             MLS_LVL_TYPE)
     VALUES (P_KEY_NO, P_FORMAT_ID, RECORD_SEQ,
             LVL_TYPE);
  END;
  PROCEDURE INSERT_HEAD IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, T_LVL_CODE,
             T_LVL_NAME, T_LVL_TYPE, RECORD_SEQ,
             T_PARENT_LVL_CODE);
     INSERT_BLANK_REC;
  END;
  PROCEDURE INSERT_REC IS
     CURSOR C3 IS
       SELECT MAIN_ACNT_NAME
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = T_MAIN_ACNT_CODE;
     C3_LVL_NAME	VARCHAR2(30);
     M_DIFF             NUMBER(2);
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     IF NVL(T_MAIN_ACNT_CODE, '0') != '0' THEN
        IF C3%ISOPEN THEN
           CLOSE C3;
        END IF;
        OPEN C3;
        FETCH C3 INTO C3_LVL_NAME;
        IF C3%FOUND THEN
             M_DIFF := LENGTH(T_LVL_NAME) - LENGTH(LTRIM(T_LVL_NAME));
             T_LVL_NAME := LPAD(C3_LVL_NAME, LENGTH(C3_LVL_NAME) + M_DIFF);
        END IF;
        CLOSE C3;
     END IF;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE,
            MLS_MAIN_ACNT_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
            MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
            MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL, MLS_PREV_ANN_BAL,
            MLS_PREV_YR_OPEN_BAL, MLS_MTD_BUD, MLS_YTD_BUD,
            MLS_ANN_BUD,
            MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
            MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
            MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
            MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
     VALUES (P_KEY_NO, P_FORMAT_ID,
            T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
            RECORD_SEQ, T_PARENT_LVL_CODE,
            T_MAIN_ACNT_CODE, T_DIVN_CODE, T_DEPT_CODE,
            T_MTD_BAL, T_YTD_BAL, T_ANN_BAL,
            T_YR_OPEN_BAL, T_PREV_MTD_BAL,
            T_PREV_YTD_BAL, T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
            T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
            T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
            T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
            T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
            T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD);
  END;
  PROCEDURE PROCESS_TOTAL IS
  BEGIN
    IF C2%ISOPEN THEN
       CLOSE C2;
    END IF;
    OPEN C2;
    FETCH C2 INTO P_LVL_CODE, P_LVL_NAME, P_LVL_TYPE,
                  P_PARENT_LVL_CODE,
                  P_TOTAL_FLAG,
                  P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
                  P_PREV_MTD_BAL, P_PREV_YTD_BAL,
                  P_PREV_ANN_BAL, P_PREV_YR_OPEN_BAL,
                  P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
                  P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
                  P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
                  P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
                  P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD;
    IF C2%FOUND AND P_TOTAL_FLAG = 'Y' THEN
       RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
       INSERT INTO FW_MAIN_LEVEL_SUM_REP (
              MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
              MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
              MLS_PARENT_LVL_CODE,
              MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
              MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
              MLS_PREV_ANN_BAL, MLS_PREV_YR_OPEN_BAL,
              MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD,
              MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
              MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
              MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
              MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE,
              P_LVL_NAME, P_LVL_TYPE, RECORD_SEQ,
              P_PARENT_LVL_CODE,
              P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
              P_PREV_MTD_BAL, P_PREV_YTD_BAL,
              P_PREV_ANN_BAL, P_PREV_YR_OPEN_BAL,
              P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
              P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
              P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
              P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
              P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD);
       INSERT_BLANK_REC;
    END IF;
    CLOSE C2;
    HEAD_FLAG := 'N';
END;
BEGIN
   DELETE FROM FW_MAIN_LEVEL_SUM_REP
          WHERE MLS_KEY_NO = P_KEY_NO;
   PREV_STR := '';
   RECORD_SEQ := 0;
   HEAD_FLAG := 'N';
   FIRST_REC := 0;
   BLANK_REC_FLAG := 'N';
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF;
   OPEN C1;
LOOP
   FETCH C1 INTO TEMP_DIVN_CODE, TEMP_DEPT_CODE,
                 TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
                 TEMP_PARENT_LVL_CODE,
                 TEMP_MAIN_ACNT_CODE,
                 TEMP_LVL_STR, TEMP_TOTAL_FLAG,
                 TEMP_MTD_BAL, TEMP_YTD_BAL, TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
                 TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
                 TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
                 TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
                 TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
                 TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
                 TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
                 TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD;
    IF FIRST_REC = 0 THEN
       IF C1%NOTFOUND THEN
          EXIT;
       END IF;
       FIRST_REC := 1;
    ELSE
      IF C1%NOTFOUND THEN
         INSERT_REC;
         EXIT;
      END IF;
      IF LENGTH(T_LVL_STR) > LENGTH(TEMP_LVL_STR) THEN
         INSERT_REC;
         INSERT_BLANK_REC;
	 PROCESS_TOTAL;
         LOOP
            PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
            IF LENGTH(PREV_STR) >= LENGTH(TEMP_LVL_STR) THEN
	       PROCESS_TOTAL;
            ELSE
               EXIT;
            END IF;
         END LOOP;
         BLANK_REC_FLAG := 'N';
      ELSIF LENGTH(T_LVL_STR) < LENGTH(TEMP_LVL_STR) THEN
            PREV_STR := T_LVL_STR;
            IF T_TOTAL_FLAG = 'Y' THEN
               IF BLANK_REC_FLAG = 'D' THEN
                  INSERT_BLANK_REC;
                  BLANK_REC_FLAG := 'N';
Press <Enter> to continue...
               END IF;
               INSERT_HEAD;
            END IF;
      ELSE
        BLANK_REC_FLAG := 'D';
        IF T_LVL_STR != TEMP_LVL_STR THEN
              INSERT_REC;
              INSERT_BLANK_REC;
              IF HEAD_FLAG = 'T' THEN
                 PROCESS_TOTAL;
                 PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
              END IF;
        ELSIF T_LVL_STR = TEMP_LVL_STR THEN
              IF T_TOTAL_FLAG = 'Y' AND HEAD_FLAG = 'N' THEN
                 INSERT_HEAD;
                 PREV_STR := T_LVL_STR;
                 HEAD_FLAG := 'T';
              END IF;
              INSERT_REC;
        END IF;
      END IF;
   END IF;
      SELECT TEMP_DIVN_CODE, TEMP_DEPT_CODE,
             TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
             TEMP_LVL_SEQ, TEMP_PARENT_LVL_CODE,
             TEMP_MAIN_ACNT_CODE,
             TEMP_LVL_STR, TEMP_TOTAL_FLAG,
             TEMP_MTD_BAL, TEMP_YTD_BAL, TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
             TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
             TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
             TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
             TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
             TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
             TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
             TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD
      INTO   T_DIVN_CODE, T_DEPT_CODE, T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
             T_LVL_SEQ, T_PARENT_LVL_CODE,
             T_MAIN_ACNT_CODE,
             T_LVL_STR, T_TOTAL_FLAG,
             T_MTD_BAL, T_YTD_BAL, T_ANN_BAL, T_YR_OPEN_BAL,
             T_PREV_MTD_BAL, T_PREV_YTD_BAL,
             T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
             T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
             T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
             T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
             T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
             T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD
      FROM   DUAL;
END LOOP;
   CLOSE C1;
   INSERT_BLANK_REC;
   IF PREV_STR IS NOT NULL THEN
      PROCESS_TOTAL;
   END IF;
   LOOP
      PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
      IF LENGTH(PREV_STR) > 0 THEN
	 PROCESS_TOTAL;
      ELSE
         EXIT;
      END IF;
   END LOOP;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_LEVEL_DEPT_SUM_REP
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_INCL_ACNT        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
   PREV_STR             VARCHAR2(27);
   RECORD_SEQ           NUMBER(6);
   HEAD_FLAG            VARCHAR2(1);
   FIRST_REC            NUMBER(1);
   BLANK_REC_FLAG       VARCHAR2(1);
   LVL_TYPE             VARCHAR2(1);
   P_LVL_CODE           VARCHAR2(6);
   P_LVL_NAME           VARCHAR2(50);
   P_LVL_TYPE           VARCHAR2(1);
   P_PARENT_LVL_CODE    VARCHAR2(6);
   P_TOTAL_FLAG         VARCHAR2(1);
   P_MTD_BAL            NUMBER(14,3);
   P_YTD_BAL            NUMBER(14,3);
   P_ANN_BAL            NUMBER(14,3);
   P_YR_OPEN_BAL        NUMBER(14,3);
   P_PREV_MTD_BAL       NUMBER(14,3);
   P_PREV_YTD_BAL       NUMBER(14,3);
   P_PREV_ANN_BAL       NUMBER(14,3);
   P_PREV_YR_OPEN_BAL   NUMBER(14,3);
   P_MTD_BUD            NUMBER(14,3);
   P_YTD_BUD            NUMBER(14,3);
   P_ANN_BUD            NUMBER(14,3);
   P_NEXT_MTD_BUD       NUMBER(14,3);
   P_NEXT_YTD_BUD       NUMBER(14,3);
   P_NEXT_ANN_BUD       NUMBER(14,3);
   P_M01_BUD            NUMBER(14,3);
   P_M02_BUD            NUMBER(14,3);
   P_M03_BUD            NUMBER(14,3);
   P_M04_BUD            NUMBER(14,3);
   P_M05_BUD            NUMBER(14,3);
   P_M06_BUD            NUMBER(14,3);
   P_M07_BUD            NUMBER(14,3);
   P_M08_BUD            NUMBER(14,3);
   P_M09_BUD            NUMBER(14,3);
   P_M10_BUD            NUMBER(14,3);
   P_M11_BUD            NUMBER(14,3);
   P_M12_BUD            NUMBER(14,3);
   T_DIVN_CODE          VARCHAR2(6);
   T_DEPT_CODE          VARCHAR2(6);
   T_LVL_CODE           VARCHAR2(6);
   T_LVL_NAME           VARCHAR2(50);
   T_LVL_TYPE           VARCHAR2(1);
   T_LVL_SEQ            NUMBER(6);
   T_PARENT_LVL_CODE    VARCHAR2(6);
   T_MAIN_ACNT_CODE     VARCHAR2(6);
   T_TOTAL_FLAG         VARCHAR2(1);
   T_LVL_STR            VARCHAR2(27);
   T_MTD_BAL            NUMBER(14,3);
   T_YTD_BAL            NUMBER(14,3);
   T_ANN_BAL            NUMBER(14,3);
   T_YR_OPEN_BAL        NUMBER(14,3);
   T_PREV_MTD_BAL       NUMBER(14,3);
   T_PREV_YTD_BAL       NUMBER(14,3);
   T_PREV_ANN_BAL       NUMBER(14,3);
   T_PREV_YR_OPEN_BAL   NUMBER(14,3);
   T_MTD_BUD            NUMBER(14,3);
   T_YTD_BUD            NUMBER(14,3);
   T_ANN_BUD            NUMBER(14,3);
   T_NEXT_MTD_BUD       NUMBER(14,3);
   T_NEXT_YTD_BUD       NUMBER(14,3);
   T_NEXT_ANN_BUD       NUMBER(14,3);
   T_M01_BUD            NUMBER(14,3);
   T_M02_BUD            NUMBER(14,3);
   T_M03_BUD            NUMBER(14,3);
   T_M04_BUD            NUMBER(14,3);
   T_M05_BUD            NUMBER(14,3);
   T_M06_BUD            NUMBER(14,3);
   T_M07_BUD            NUMBER(14,3);
   T_M08_BUD            NUMBER(14,3);
   T_M09_BUD            NUMBER(14,3);
   T_M10_BUD            NUMBER(14,3);
   T_M11_BUD            NUMBER(14,3);
   T_M12_BUD            NUMBER(14,3);
   TEMP_DIVN_CODE          VARCHAR2(6);
   TEMP_DEPT_CODE          VARCHAR2(6);
   TEMP_LVL_CODE           VARCHAR2(6);
   TEMP_LVL_NAME           VARCHAR2(50);
   TEMP_LVL_TYPE           VARCHAR2(1);
   TEMP_LVL_SEQ            NUMBER(6);
   TEMP_PARENT_LVL_CODE    VARCHAR2(6);
   TEMP_MAIN_ACNT_CODE     VARCHAR2(6);
   TEMP_TOTAL_FLAG         VARCHAR2(1);
   TEMP_LVL_STR            VARCHAR2(27);
   TEMP_MTD_BAL            NUMBER(14,3);
   TEMP_YTD_BAL            NUMBER(14,3);
   TEMP_ANN_BAL            NUMBER(14,3);
   TEMP_YR_OPEN_BAL        NUMBER(14,3);
   TEMP_PREV_MTD_BAL       NUMBER(14,3);
   TEMP_PREV_YTD_BAL       NUMBER(14,3);
   TEMP_PREV_ANN_BAL       NUMBER(14,3);
   TEMP_PREV_YR_OPEN_BAL   NUMBER(14,3);
   TEMP_MTD_BUD            NUMBER(14,3);
   TEMP_YTD_BUD            NUMBER(14,3);
   TEMP_ANN_BUD            NUMBER(14,3);
   TEMP_NEXT_MTD_BUD       NUMBER(14,3);
   TEMP_NEXT_YTD_BUD       NUMBER(14,3);
   TEMP_NEXT_ANN_BUD       NUMBER(14,3);
   TEMP_M01_BUD            NUMBER(14,3);
   TEMP_M02_BUD            NUMBER(14,3);
   TEMP_M03_BUD            NUMBER(14,3);
   TEMP_M04_BUD            NUMBER(14,3);
   TEMP_M05_BUD            NUMBER(14,3);
   TEMP_M06_BUD            NUMBER(14,3);
   TEMP_M07_BUD            NUMBER(14,3);
   TEMP_M08_BUD            NUMBER(14,3);
   TEMP_M09_BUD            NUMBER(14,3);
   TEMP_M10_BUD            NUMBER(14,3);
   TEMP_M11_BUD            NUMBER(14,3);
   TEMP_M12_BUD            NUMBER(14,3);
   CURSOR C1 IS
          SELECT MLS_DIVN_CODE, MLS_DEPT_CODE,
                 MLS_LVL_CODE, MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0'),
                 LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FW_LEVEL, FM_COA_LEVEL, FW_MAIN_LEVEL_SUM
          WHERE  MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = P_FORMAT_ID
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          AND    LS_FORMAT_ID = LVL_FORMAT_ID
          AND    LS_LVL_CODE = LVL_CODE
          GROUP BY MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_LVL_CODE,
                   MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0'),
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N')
          ORDER  BY MLS_DIVN_CODE, MLS_DEPT_CODE, LS_LVL_SEQ,
                   DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0');
   CURSOR C2 IS
          SELECT MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FM_COA_LEVEL, FW_MAIN_LEVEL_SUM, FW_LEVEL
          WHERE  LS_FORMAT_ID = P_FORMAT_ID
          AND    LS_LVL_SEQ = PREV_STR
          AND    MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = LS_FORMAT_ID
          AND    MLS_LVL_CODE = LS_LVL_CODE
          AND    MLS_DIVN_CODE = T_DIVN_CODE
          AND    MLS_DEPT_CODE = T_DEPT_CODE
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          GROUP BY MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N');
  PROCEDURE INSERT_BLANK_REC IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     LVL_TYPE := T_LVL_TYPE;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_SEQ,
             MLS_LVL_TYPE, MLS_DIVN_CODE, MLS_DEPT_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, RECORD_SEQ,
             LVL_TYPE, T_DIVN_CODE, T_DEPT_CODE);
  END;
  PROCEDURE INSERT_HEAD IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, T_LVL_CODE,
             T_LVL_NAME, T_LVL_TYPE, RECORD_SEQ,
             T_PARENT_LVL_CODE, T_DIVN_CODE, T_DEPT_CODE);
     INSERT_BLANK_REC;
  END;
  PROCEDURE INSERT_REC IS
     CURSOR C3 IS
       SELECT MAIN_ACNT_NAME
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = T_MAIN_ACNT_CODE;
     C3_LVL_NAME	VARCHAR2(30);
     M_DIFF             NUMBER(2);
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     IF NVL(T_MAIN_ACNT_CODE, '0') != '0' THEN
        IF C3%ISOPEN THEN
           CLOSE C3;
        END IF;
        OPEN C3;
        FETCH C3 INTO C3_LVL_NAME;
        IF C3%FOUND THEN
             M_DIFF := LENGTH(T_LVL_NAME) - LENGTH(LTRIM(T_LVL_NAME));
             T_LVL_NAME := LPAD(C3_LVL_NAME, LENGTH(C3_LVL_NAME) + M_DIFF);
        END IF;
        CLOSE C3;
     END IF;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE,
            MLS_MAIN_ACNT_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
            MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
            MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL, MLS_PREV_ANN_BAL,
            MLS_PREV_YR_OPEN_BAL, MLS_MTD_BUD, MLS_YTD_BUD,
            MLS_ANN_BUD,
            MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
            MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
            MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
            MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
     VALUES (P_KEY_NO, P_FORMAT_ID,
            T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
            RECORD_SEQ, T_PARENT_LVL_CODE,
            T_MAIN_ACNT_CODE, T_DIVN_CODE, T_DEPT_CODE,
            T_MTD_BAL, T_YTD_BAL, T_ANN_BAL,
            T_YR_OPEN_BAL, T_PREV_MTD_BAL,
            T_PREV_YTD_BAL, T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
            T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
            T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
            T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
            T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
            T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD);
  END;
  PROCEDURE PROCESS_TOTAL IS
  BEGIN
    IF C2%ISOPEN THEN
       CLOSE C2;
    END IF;
    OPEN C2;
    FETCH C2 INTO P_LVL_CODE, P_LVL_NAME, P_LVL_TYPE,
                  P_PARENT_LVL_CODE,
                  P_TOTAL_FLAG,
                  P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
                  P_PREV_MTD_BAL, P_PREV_YTD_BAL,
                  P_PREV_ANN_BAL, P_PREV_YR_OPEN_BAL,
                  P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
                  P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
                  P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
                  P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
                  P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD;
    IF C2%FOUND AND P_TOTAL_FLAG = 'Y' THEN
       RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
       INSERT INTO FW_MAIN_LEVEL_SUM_REP (
              MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
              MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
              MLS_PARENT_LVL_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
              MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
              MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
              MLS_PREV_ANN_BAL, MLS_PREV_YR_OPEN_BAL,
              MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD,
              MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
              MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
              MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
              MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE,
              P_LVL_NAME, P_LVL_TYPE, RECORD_SEQ,
              P_PARENT_LVL_CODE, T_DIVN_CODE, T_DEPT_CODE,
              P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
              P_PREV_MTD_BAL, P_PREV_YTD_BAL,
              P_PREV_ANN_BAL, P_PREV_YR_OPEN_BAL,
              P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
              P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
              P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
              P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
              P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD);
       INSERT_BLANK_REC;
    END IF;
    CLOSE C2;
    HEAD_FLAG := 'N';
END;
BEGIN
   DELETE FROM FW_MAIN_LEVEL_SUM_REP
          WHERE MLS_KEY_NO = P_KEY_NO;
   PREV_STR := '';
   RECORD_SEQ := 0;
   HEAD_FLAG := 'N';
   FIRST_REC := 0;
   BLANK_REC_FLAG := 'N';
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF;
   OPEN C1;
LOOP
   FETCH C1 INTO TEMP_DIVN_CODE, TEMP_DEPT_CODE,
                 TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
                 TEMP_PARENT_LVL_CODE,
                 TEMP_MAIN_ACNT_CODE,
                 TEMP_LVL_STR, TEMP_TOTAL_FLAG,
                 TEMP_MTD_BAL, TEMP_YTD_BAL, TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
                 TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
                 TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
                 TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
                 TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
                 TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
                 TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
                 TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD;
    IF FIRST_REC = 0 THEN
       IF C1%NOTFOUND THEN
          EXIT;
       END IF;
       FIRST_REC := 1;
    ELSE
      IF C1%NOTFOUND THEN
         INSERT_REC;
         EXIT;
      END IF;
      IF LENGTH(T_LVL_STR) > LENGTH(TEMP_LVL_STR) THEN
         INSERT_REC;
         INSERT_BLANK_REC;
	 PROCESS_TOTAL;
         LOOP
            PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
            IF LENGTH(PREV_STR) >= LENGTH(TEMP_LVL_STR) THEN
	       PROCESS_TOTAL;
            ELSE
               EXIT;
            END IF;
         END LOOP;
         BLANK_REC_FLAG := 'N';
      ELSIF LENGTH(T_LVL_STR) < LENGTH(TEMP_LVL_STR) THEN
            PREV_STR := T_LVL_STR;
            IF T_TOTAL_FLAG = 'Y' THEN
               IF BLANK_REC_FLAG = 'D' THEN
                  INSERT_BLANK_REC;
                  BLANK_REC_FLAG := 'N';
               END IF;
               INSERT_HEAD;
            END IF;
      ELSE
        BLANK_REC_FLAG := 'D';
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           INSERT_REC;
           IF NVL(SUBSTR(T_LVL_STR, 1, LENGTH(T_LVL_STR) - 3), '1') !=
              NVL(SUBSTR(TEMP_LVL_STR, 1, LENGTH(TEMP_LVL_STR) - 3), '2') THEN
                INSERT_BLANK_REC;
                BLANK_REC_FLAG := 'N';
           END IF;
        END IF;
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           NULL;
        ELSIF T_LVL_STR != TEMP_LVL_STR THEN
              INSERT_REC;
              INSERT_BLANK_REC;
              IF HEAD_FLAG = 'T' THEN
                 PROCESS_TOTAL;
                 PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
              END IF;
        ELSIF T_LVL_STR = TEMP_LVL_STR THEN
              IF T_TOTAL_FLAG = 'Y' AND HEAD_FLAG = 'N' THEN
                 INSERT_HEAD;
                 PREV_STR := T_LVL_STR;
                 HEAD_FLAG := 'T';
              END IF;
              INSERT_REC;
        END IF;
      END IF;
   END IF;
      SELECT TEMP_DIVN_CODE, TEMP_DEPT_CODE,
             TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
             TEMP_LVL_SEQ, TEMP_PARENT_LVL_CODE,
             TEMP_MAIN_ACNT_CODE,
             TEMP_LVL_STR, TEMP_TOTAL_FLAG,
             TEMP_MTD_BAL, TEMP_YTD_BAL, TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
             TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
             TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
             TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
             TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
             TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
             TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
             TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD
      INTO   T_DIVN_CODE, T_DEPT_CODE, T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
             T_LVL_SEQ, T_PARENT_LVL_CODE,
             T_MAIN_ACNT_CODE,
             T_LVL_STR, T_TOTAL_FLAG,
             T_MTD_BAL, T_YTD_BAL, T_ANN_BAL, T_YR_OPEN_BAL,
             T_PREV_MTD_BAL, T_PREV_YTD_BAL,
             T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
             T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
             T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
             T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
             T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
             T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD
      FROM   DUAL;
END LOOP;
   CLOSE C1;
   INSERT_BLANK_REC;
   IF PREV_STR IS NOT NULL THEN
      PROCESS_TOTAL;
   END IF;
   LOOP
      PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
      IF LENGTH(PREV_STR) > 0 THEN
	 PROCESS_TOTAL;
      ELSE
         EXIT;
      END IF;
   END LOOP;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_LEVEL_SUM
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_FRM_DT           IN    DATE,
                  P_TO_DT            IN    DATE,
                  P_INCL_BUD         IN    VARCHAR2,
                  P_INCL_MTH         IN    VARCHAR2,
                  P_INCL_ANN         IN    VARCHAR2,
                  P_INCL_ZERO        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
P_CUR_ACNT_YEAR        NUMBER(2);
P_AS_OF_DT             DATE;
P_FRM_ACNT_YEAR        NUMBER(2);
P_FRM_CAL_YEAR         NUMBER(2);
P_FRM_CAL_MONTH        NUMBER(2);
P_FRM_BEGIN_DT         DATE;
P_FRM_END_DT           DATE;
P_TO_BEGIN_DT          DATE;
P_TO_END_DT            DATE;
P_WORK_FRM_DT          DATE;
P_WORK_TO_DT           DATE;
P_FRM_READ_TRAN_FLAG   VARCHAR2(1);
P_FRM_CUR_YEAR_FLAG    VARCHAR2(1);
P_TO_ACNT_YEAR         NUMBER(2);
P_TO_CAL_YEAR          NUMBER(2);
P_TO_CAL_MONTH         NUMBER(2);
P_TO_READ_TRAN_FLAG    VARCHAR2(1);
P_TO_CUR_YEAR_FLAG     VARCHAR2(1);
P_FRM_CAL_YEAR_MONTH   NUMBER(4);
P_TO_CAL_YEAR_MONTH    NUMBER(4);
P_MAX_LENGTH           NUMBER(3);
P_LENGTH               NUMBER(3);
P_PAD_LENGTH           NUMBER(2);
P_LVL_CODE             VARCHAR2(6);
P_ACNT_CODE            VARCHAR2(6);
P_DIVN_CODE            VARCHAR2(6);
P_DEPT_CODE            VARCHAR2(6);
P_HEAD_NO_1            NUMBER(1);
P_ANLY_CODE_1          VARCHAR(6);
P_HEAD_NO_2            NUMBER(1);
P_ANLY_CODE_2          VARCHAR(6);
P_ANN_BAL              NUMBER(14,3);
P_YTD_BAL              NUMBER(14,3);
P_MTD_BAL              NUMBER(14,3);
P_YR_OPEN_BAL          NUMBER(14,3);
P_CL_BAL               NUMBER(14,3);
P_MTD_BAL_SUB_1        NUMBER(14,3);
P_MTD_BAL_SUB_2        NUMBER(14,3);
P_M01_BUD              NUMBER(14,3);
P_M02_BUD              NUMBER(14,3);
P_M03_BUD              NUMBER(14,3);
P_M04_BUD              NUMBER(14,3);
P_M05_BUD              NUMBER(14,3);
P_M06_BUD              NUMBER(14,3);
P_M07_BUD              NUMBER(14,3);
P_M08_BUD              NUMBER(14,3);
P_M09_BUD              NUMBER(14,3);
P_M10_BUD              NUMBER(14,3);
P_M11_BUD              NUMBER(14,3);
P_M12_BUD              NUMBER(14,3);
CURSOR F_FRM_PERIOD IS
SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
       APER_FRM_DT, APER_TO_DT,
       DECODE(TO_DATE(TO_CHAR(P_AS_OF_DT)), TO_DATE(TO_CHAR(APER_FRM_DT)),
              'N', 'Y'),
       DECODE(APER_ACNT_YEAR, P_CUR_ACNT_YEAR, 'Y', 'N')
FROM   FM_ACNT_PERIOD
WHERE  APER_COMP_CODE = P_COMP_CODE
AND    TO_NUMBER(TO_CHAR(P_AS_OF_DT,'J'))
       BETWEEN TO_NUMBER(TO_CHAR(APER_FRM_DT,'J'))
           AND TO_NUMBER(TO_CHAR(APER_TO_DT,'J'));
CURSOR F_TO_PERIOD IS
SELECT APER_ACNT_YEAR, APER_CAL_YEAR, APER_CAL_MONTH,
       APER_FRM_DT, APER_TO_DT,
       DECODE(TO_DATE(TO_CHAR(P_AS_OF_DT)), TO_DATE(TO_CHAR(APER_TO_DT)), 'N',
              TO_DATE(TO_CHAR(SYSDATE)), 'N', 'Y'),
       DECODE(APER_ACNT_YEAR, P_CUR_ACNT_YEAR, 'Y', 'N')
FROM   FM_ACNT_PERIOD
WHERE  APER_COMP_CODE = P_COMP_CODE
AND    TO_NUMBER(TO_CHAR(P_AS_OF_DT,'J'))
       BETWEEN TO_NUMBER(TO_CHAR(APER_FRM_DT,'J'))
           AND TO_NUMBER(TO_CHAR(APER_TO_DT,'J'));
CURSOR F_SUMM_CUR IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0'),
       SUM(DECODE(ABAL_CAL_MONTH, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0), 0)),
       SUM(DECODE(SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                       P_FRM_CAL_YEAR_MONTH),
                  -1, 0,
                  DECODE(
                         SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0)))),
       SUM(DECODE(SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                    P_TO_CAL_YEAR_MONTH), 1, 0,
                    NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))),
       DECODE(P_INCL_ANN, 'Y',
              SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0)), 0)
FROM   FS_CUR_ACNT_BAL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = ABAL_MAIN_ACNT_CODE
AND    ABAL_COMP_CODE = P_COMP_CODE
AND    ABAL_ACNT_YEAR = P_TO_ACNT_YEAR
AND    ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH <=
         DECODE(P_INCL_ANN, 'Y', ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH,
                                 P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH)
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0');
CURSOR F_DETL_CUR IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(TD_DIVN_CODE, '0'),
       NVL(TD_DEPT_CODE, '0'),
       NVL(TD_HEAD_NO_1, 0),
       NVL(TD_ANLY_CODE_1, '0'),
       NVL(TD_HEAD_NO_2, 0),
       NVL(TD_ANLY_CODE_2, '0'),
       SUM(DECODE(SIGN(TO_DATE(TO_CHAR(TH_DOC_DT)) -
               TO_DATE(TO_CHAR(P_WORK_FRM_DT))),
               -1, DECODE(TD_DOC_DRCR_FLAG,'D',1,-1) * NVL(TD_DOC_AMT,0), 0)),
       SUM(DECODE(SIGN(TO_DATE(TO_CHAR(TH_DOC_DT)) -
               TO_DATE(TO_CHAR(P_WORK_TO_DT))),
               1, DECODE(TD_DOC_DRCR_FLAG,'D',1,-1) * NVL(TD_DOC_AMT,0), 0))
FROM   FT_CUR_TRANS_HEADER, FT_CUR_TRANS_DETAIL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = TD_MAIN_ACNT_CODE
AND    TO_DATE(TO_CHAR(TH_DOC_DT)) BETWEEN TO_DATE(TO_CHAR(P_FRM_BEGIN_DT)) AND
                                           TO_DATE(TO_CHAR(P_TO_END_DT))
AND    TH_COMP_CODE = P_COMP_CODE
AND    TH_ACNT_YEAR = P_TO_ACNT_YEAR
AND    TH_COMP_CODE = TD_COMP_CODE
AND    TH_TRAN_CODE = TD_TRAN_CODE
AND    TH_DOC_NO = TD_DOC_NO
AND    TH_ACNT_YEAR = TD_ACNT_YEAR
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(TD_DIVN_CODE, '0'),
       NVL(TD_DEPT_CODE, '0'),
       NVL(TD_HEAD_NO_1, 0),
       NVL(TD_ANLY_CODE_1, '0'),
       NVL(TD_HEAD_NO_2, 0),
       NVL(TD_ANLY_CODE_2, '0');
CURSOR F_SUMM_PRV IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0'),
       SUM(DECODE(ABAL_CAL_MONTH, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0), 0)),
       SUM(DECODE(SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                       P_FRM_CAL_YEAR_MONTH),
                  -1, 0,
                  DECODE(
                         SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0)))),
       SUM(DECODE(SIGN((ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH) -
                    P_TO_CAL_YEAR_MONTH), 1, 0,
                    NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))),
       DECODE(P_INCL_ANN, 'Y',
              SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0)), 0)
FROM   FS_PRV_ACNT_BAL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = ABAL_MAIN_ACNT_CODE
AND    ABAL_COMP_CODE = P_COMP_CODE
AND    ABAL_ACNT_YEAR = P_TO_ACNT_YEAR
AND    ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH <=
         DECODE(P_INCL_ANN, 'Y', ABAL_CAL_YEAR * 100 + ABAL_CAL_MONTH,
                                 P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH)
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0');
CURSOR F_DETL_PRV IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(TD_DIVN_CODE, '0'),
       NVL(TD_DEPT_CODE, '0'),
       NVL(TD_HEAD_NO_1, 0),
       NVL(TD_ANLY_CODE_1, '0'),
       NVL(TD_HEAD_NO_2, 0),
       NVL(TD_ANLY_CODE_2, '0'),
       SUM(DECODE(SIGN(TO_DATE(TO_CHAR(TH_DOC_DT)) -
               TO_DATE(TO_CHAR(P_WORK_FRM_DT))),
               -1, DECODE(TD_DOC_DRCR_FLAG,'D',1,-1) * NVL(TD_DOC_AMT,0), 0)),
       SUM(DECODE(SIGN(TO_DATE(TO_CHAR(TH_DOC_DT)) -
               TO_DATE(TO_CHAR(P_WORK_TO_DT))),
               1, DECODE(TD_DOC_DRCR_FLAG,'D',1,-1) * NVL(TD_DOC_AMT,0), 0))
FROM   FT_PRV_TRANS_HEADER, FT_PRV_TRANS_DETAIL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = TD_MAIN_ACNT_CODE
AND    TH_COMP_CODE = P_COMP_CODE
AND    TH_ACNT_YEAR = P_TO_ACNT_YEAR
AND    TO_DATE(TO_CHAR(TH_DOC_DT)) BETWEEN TO_DATE(TO_CHAR(P_FRM_BEGIN_DT)) AND
                                           TO_DATE(TO_CHAR(P_TO_END_DT))
AND    TH_COMP_CODE = TD_COMP_CODE
AND    TH_TRAN_CODE = TD_TRAN_CODE
AND    TH_DOC_NO = TD_DOC_NO
AND    TH_ACNT_YEAR = TD_ACNT_YEAR
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(TD_DIVN_CODE, '0'),
       NVL(TD_DEPT_CODE, '0'),
       NVL(TD_HEAD_NO_1, 0),
       NVL(TD_ANLY_CODE_1, '0'),
       NVL(TD_HEAD_NO_2, 0),
       NVL(TD_ANLY_CODE_2, '0');
CURSOR BUD_FIGURES IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0'),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                       P_FRM_CAL_YEAR_MONTH),
                  -1, 0,
                  DECODE(
                         SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(MBUD_ORGL_AMT,0)))),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE( SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(MBUD_ORGL_AMT,0))),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   NVL(MBUD_ORGL_AMT,0))
FROM   FM_YEARLY_BUDGET, FM_MONTHLY_BUDGET, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    MBUD_COMP_CODE = P_COMP_CODE
AND    MBUD_ACNT_YEAR = P_TO_ACNT_YEAR
AND    MBUD_YEAR_FLAG = 'C'
AND    YBUD_COMP_CODE = MBUD_COMP_CODE
AND    YBUD_ACNT_YEAR = MBUD_ACNT_YEAR
AND    YBUD_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    NVL(YBUD_SUB_ACNT_CODE,'0') = NVL(MBUD_SUB_ACNT_CODE,'0')
AND    NVL(YBUD_DIVN_CODE,'0') = NVL(MBUD_DIVN_CODE,'0')
AND    NVL(YBUD_DEPT_CODE,'0') = NVL(MBUD_DEPT_CODE,'0')
AND    NVL(YBUD_HEAD_NO_1,0) = NVL(MBUD_HEAD_NO_1,0)
AND    NVL(YBUD_ANLY_CODE_1,'0') = NVL(MBUD_ANLY_CODE_1,'0')
AND    NVL(YBUD_HEAD_NO_2,0) = NVL(MBUD_HEAD_NO_2,0)
AND    NVL(YBUD_ANLY_CODE_2,'0') = NVL(MBUD_ANLY_CODE_2,'0')
GROUP  BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0');
CURSOR NEXT_BUD_FIGURES IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0'),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                       P_FRM_CAL_YEAR_MONTH),
                  -1, 0,
                  DECODE(
                         SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(MBUD_ORGL_AMT,0)))),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE( SIGN((MBUD_CAL_YEAR * 100 + MBUD_CAL_MONTH) -
                              P_TO_CAL_YEAR_MONTH),
                         1, 0,
                         NVL(MBUD_ORGL_AMT,0))),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   NVL(MBUD_ORGL_AMT,0))
FROM   FM_YEARLY_BUDGET, FM_MONTHLY_BUDGET, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    MBUD_COMP_CODE = P_COMP_CODE
AND    MBUD_ACNT_YEAR = (P_TO_ACNT_YEAR + 1)
AND    MBUD_YEAR_FLAG = 'N'
AND    YBUD_COMP_CODE = MBUD_COMP_CODE
AND    YBUD_ACNT_YEAR = MBUD_ACNT_YEAR
AND    YBUD_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    NVL(YBUD_SUB_ACNT_CODE,'0') = NVL(MBUD_SUB_ACNT_CODE,'0')
AND    NVL(YBUD_DIVN_CODE,'0') = NVL(MBUD_DIVN_CODE,'0')
AND    NVL(YBUD_DEPT_CODE,'0') = NVL(MBUD_DEPT_CODE,'0')
AND    NVL(YBUD_HEAD_NO_1,0) = NVL(MBUD_HEAD_NO_1,0)
AND    NVL(YBUD_ANLY_CODE_1,'0') = NVL(MBUD_ANLY_CODE_1,'0')
AND    NVL(YBUD_HEAD_NO_2,0) = NVL(MBUD_HEAD_NO_2,0)
AND    NVL(YBUD_ANLY_CODE_2,'0') = NVL(MBUD_ANLY_CODE_2,'0')
GROUP  BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0');
CURSOR BUD_MONTHS IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0'),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 1, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 2, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 3, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 4, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 5, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 6, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 7, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 8, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 9, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 10, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 11, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 12, NVL(MBUD_ORGL_AMT,0), 0))
FROM   FM_YEARLY_BUDGET, FM_MONTHLY_BUDGET, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    MBUD_COMP_CODE = P_COMP_CODE
AND    MBUD_ACNT_YEAR = P_TO_ACNT_YEAR
AND    MBUD_YEAR_FLAG = 'C'
AND    YBUD_COMP_CODE = MBUD_COMP_CODE
AND    YBUD_ACNT_YEAR = MBUD_ACNT_YEAR
AND    YBUD_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    NVL(YBUD_SUB_ACNT_CODE,'0') = NVL(MBUD_SUB_ACNT_CODE,'0')
AND    NVL(YBUD_DIVN_CODE,'0') = NVL(MBUD_DIVN_CODE,'0')
AND    NVL(YBUD_DEPT_CODE,'0') = NVL(MBUD_DEPT_CODE,'0')
AND    NVL(YBUD_HEAD_NO_1,0) = NVL(MBUD_HEAD_NO_1,0)
AND    NVL(YBUD_ANLY_CODE_1,'0') = NVL(MBUD_ANLY_CODE_1,'0')
AND    NVL(YBUD_HEAD_NO_2,0) = NVL(MBUD_HEAD_NO_2,0)
AND    NVL(YBUD_ANLY_CODE_2,'0') = NVL(MBUD_ANLY_CODE_2,'0')
GROUP  BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0');
CURSOR NEXT_BUD_MONTHS IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0'),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 1, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 2, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 3, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 4, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 5, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 6, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 7, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 8, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 9, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 10, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 11, NVL(MBUD_ORGL_AMT,0), 0)),
       SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	   DECODE(MBUD_CAL_MONTH, 12, NVL(MBUD_ORGL_AMT,0), 0))
FROM   FM_YEARLY_BUDGET, FM_MONTHLY_BUDGET, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    MBUD_COMP_CODE = P_COMP_CODE
AND    MBUD_ACNT_YEAR = (P_TO_ACNT_YEAR + 1)
AND    MBUD_YEAR_FLAG = 'N'
AND    YBUD_COMP_CODE = MBUD_COMP_CODE
AND    YBUD_ACNT_YEAR = MBUD_ACNT_YEAR
AND    YBUD_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
AND    NVL(YBUD_SUB_ACNT_CODE,'0') = NVL(MBUD_SUB_ACNT_CODE,'0')
AND    NVL(YBUD_DIVN_CODE,'0') = NVL(MBUD_DIVN_CODE,'0')
AND    NVL(YBUD_DEPT_CODE,'0') = NVL(MBUD_DEPT_CODE,'0')
AND    NVL(YBUD_HEAD_NO_1,0) = NVL(MBUD_HEAD_NO_1,0)
AND    NVL(YBUD_ANLY_CODE_1,'0') = NVL(MBUD_ANLY_CODE_1,'0')
AND    NVL(YBUD_HEAD_NO_2,0) = NVL(MBUD_HEAD_NO_2,0)
AND    NVL(YBUD_ANLY_CODE_2,'0') = NVL(MBUD_ANLY_CODE_2,'0')
GROUP  BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(MBUD_DIVN_CODE, '0'),
       NVL(MBUD_DEPT_CODE, '0'),
       NVL(MBUD_HEAD_NO_1, 0),
       NVL(MBUD_ANLY_CODE_1, '0'),
       NVL(MBUD_HEAD_NO_2, 0),
       NVL(MBUD_ANLY_CODE_2, '0');
BEGIN
DELETE FROM FW_MAIN_LEVEL_SUM_TEMP
       WHERE MLS_KEY_NO = P_KEY_NO;
DELETE FROM FW_MAIN_LEVEL_SUM
       WHERE MLS_KEY_NO = P_KEY_NO;
P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
P_WORK_FRM_DT := P_FRM_DT;
P_WORK_TO_DT  := P_TO_DT;
P_AS_OF_DT := P_WORK_FRM_DT;
IF F_FRM_PERIOD%ISOPEN THEN
     CLOSE F_FRM_PERIOD;
END IF;
OPEN F_FRM_PERIOD;
FETCH F_FRM_PERIOD INTO P_FRM_ACNT_YEAR, P_FRM_CAL_YEAR, P_FRM_CAL_MONTH,
                    P_FRM_BEGIN_DT, P_FRM_END_DT,
                    P_FRM_READ_TRAN_FLAG, P_FRM_CUR_YEAR_FLAG;
IF F_FRM_PERIOD%NOTFOUND THEN
     P_ERR_NO := 909;
     CLOSE F_FRM_PERIOD;
     RETURN;
END IF;
CLOSE F_FRM_PERIOD;
P_AS_OF_DT := P_WORK_TO_DT;
IF F_TO_PERIOD%ISOPEN THEN
     CLOSE F_TO_PERIOD;
END IF;
OPEN F_TO_PERIOD;
FETCH F_TO_PERIOD INTO P_TO_ACNT_YEAR, P_TO_CAL_YEAR, P_TO_CAL_MONTH,
                    P_TO_BEGIN_DT, P_TO_END_DT,
                    P_TO_READ_TRAN_FLAG, P_TO_CUR_YEAR_FLAG;
IF F_TO_PERIOD%NOTFOUND THEN
     P_ERR_NO := 909;
     CLOSE F_TO_PERIOD;
     RETURN;
END IF;
CLOSE F_TO_PERIOD;
IF P_FRM_ACNT_YEAR != P_TO_ACNT_YEAR THEN
     P_ERR_NO := 910;
     RETURN;
END IF;
P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
IF P_TO_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
     IF F_SUMM_CUR%ISOPEN THEN
          CLOSE F_SUMM_CUR;
     END IF;
     OPEN F_SUMM_CUR;
     <<INS_DET_LEVEL_SUMM_CUR>>
     LOOP
     FETCH F_SUMM_CUR INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_YR_OPEN_BAL,
                           P_MTD_BAL, P_YTD_BAL, P_ANN_BAL;
     EXIT WHEN F_SUMM_CUR%NOTFOUND;
     INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
            MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
            MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
            MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
            MLS_MAIN_ACNT_CODE,
            MLS_YR_OPEN_BAL, MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_MTD_BAL, P_YTD_BAL, P_ANN_BAL);
     END LOOP INS_DET_LEVEL_SUMM_CUR;
     CLOSE F_SUMM_CUR;
     IF P_TO_READ_TRAN_FLAG = 'Y' THEN
          IF F_DETL_CUR%ISOPEN THEN
               CLOSE F_DETL_CUR;
          END IF;
          OPEN F_DETL_CUR;
          <<INS_DET_LEVEL_DET_CUR>>
          LOOP
          FETCH F_DETL_CUR INTO P_LVL_CODE, P_ACNT_CODE,
                                P_DIVN_CODE, P_DEPT_CODE,
                                P_HEAD_NO_1, P_ANLY_CODE_1,
                                P_HEAD_NO_2, P_ANLY_CODE_2,
                                P_MTD_BAL_SUB_1, P_MTD_BAL_SUB_2;
          EXIT WHEN F_DETL_CUR%NOTFOUND;
          P_MTD_BAL := -1 * (NVL(P_MTD_BAL_SUB_1,0) + NVL(P_MTD_BAL_SUB_2,0));
          P_YTD_BAL := -1 * NVL(P_MTD_BAL_SUB_2,0);
Press <Enter> to continue...
          INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
                MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
                MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
                MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
                MLS_MAIN_ACNT_CODE,
                MLS_MTD_OPBAL, MLS_MTD_BAL, MLS_YTD_BAL)
          VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
                P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
                P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
                P_MTD_BAL_SUB_1, P_MTD_BAL, P_YTD_BAL);
          END LOOP INS_DET_LEVEL_DET_CUR;
          CLOSE F_DETL_CUR;
     END IF;
ELSE
     IF F_SUMM_PRV%ISOPEN THEN
          CLOSE F_SUMM_PRV;
     END IF;
     OPEN F_SUMM_PRV;
     <<INS_DET_LEVEL_SUMM_PRV>>
     LOOP
     FETCH F_SUMM_PRV INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_YR_OPEN_BAL, P_MTD_BAL, P_YTD_BAL, P_ANN_BAL;
     EXIT WHEN F_SUMM_PRV%NOTFOUND;
     INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
            MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
            MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
            MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
            MLS_MAIN_ACNT_CODE,
            MLS_YR_OPEN_BAL, MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_MTD_BAL, P_YTD_BAL, P_ANN_BAL);
     END LOOP INS_DET_LEVEL_SUMM_PRV;
     CLOSE F_SUMM_PRV;
     IF P_TO_READ_TRAN_FLAG = 'Y' THEN
          IF F_DETL_PRV%ISOPEN THEN
               CLOSE F_DETL_PRV;
          END IF;
          OPEN F_DETL_PRV;
          <<INS_DET_LEVEL_DET_PRV>>
          LOOP
          FETCH F_DETL_PRV INTO P_LVL_CODE, P_ACNT_CODE,
                                P_DIVN_CODE, P_DEPT_CODE,
                                P_HEAD_NO_1, P_ANLY_CODE_1,
                                P_HEAD_NO_2, P_ANLY_CODE_2,
                                P_MTD_BAL_SUB_1, P_MTD_BAL_SUB_2;
          EXIT WHEN F_DETL_PRV%NOTFOUND;
          P_MTD_BAL := -1 * (NVL(P_MTD_BAL_SUB_1,0) + NVL(P_MTD_BAL_SUB_2,0));
          P_YTD_BAL := -1 * NVL(P_MTD_BAL_SUB_2,0);
          END LOOP INS_DET_LEVEL_DET_PRV;
          INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
                 MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
                 MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
                 MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
                 MLS_MAIN_ACNT_CODE,
                 MLS_MTD_OPBAL, MLS_MTD_BAL, MLS_YTD_BAL)
          VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
                 P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
                 P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
                 P_MTD_BAL_SUB_1, P_MTD_BAL, P_YTD_BAL);
          CLOSE F_DETL_PRV;
     END IF;
END IF;
P_WORK_FRM_DT := TO_DATE(SUBSTR(TO_CHAR(P_FRM_DT),1,7) ||
                         TO_CHAR(TO_NUMBER(TO_CHAR(P_FRM_DT,'YY')) - 1));
P_WORK_TO_DT := TO_DATE(SUBSTR(TO_CHAR(P_TO_DT),1,7) ||
                         TO_CHAR(TO_NUMBER(TO_CHAR(P_TO_DT,'YY')) - 1));
P_AS_OF_DT := P_WORK_FRM_DT;
IF F_FRM_PERIOD%ISOPEN THEN
     CLOSE F_FRM_PERIOD;
END IF;
OPEN F_FRM_PERIOD;
FETCH F_FRM_PERIOD INTO P_FRM_ACNT_YEAR, P_FRM_CAL_YEAR, P_FRM_CAL_MONTH,
                    P_FRM_BEGIN_DT, P_FRM_END_DT,
                    P_FRM_READ_TRAN_FLAG, P_FRM_CUR_YEAR_FLAG;
IF F_FRM_PERIOD%NOTFOUND THEN
     CLOSE F_FRM_PERIOD;
     GOTO  CALC_BUDGET;
END IF;
CLOSE F_FRM_PERIOD;
P_AS_OF_DT := P_WORK_TO_DT;
IF F_TO_PERIOD%ISOPEN THEN
     CLOSE F_TO_PERIOD;
END IF;
OPEN F_TO_PERIOD;
FETCH F_TO_PERIOD INTO P_TO_ACNT_YEAR, P_TO_CAL_YEAR, P_TO_CAL_MONTH,
                    P_TO_BEGIN_DT, P_TO_END_DT,
                    P_TO_READ_TRAN_FLAG, P_TO_CUR_YEAR_FLAG;
IF F_TO_PERIOD%NOTFOUND THEN
     CLOSE F_TO_PERIOD;
     GOTO  CALC_BUDGET;
END IF;
CLOSE F_TO_PERIOD;
IF P_FRM_ACNT_YEAR != P_TO_ACNT_YEAR THEN
     GOTO  CALC_BUDGET;
END IF;
P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
IF F_SUMM_PRV%ISOPEN THEN
     CLOSE F_SUMM_PRV;
END IF;
OPEN F_SUMM_PRV;
<<INS_DET_LEVEL_SUMM_PRV>>
LOOP
     FETCH F_SUMM_PRV INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_YR_OPEN_BAL, P_MTD_BAL, P_YTD_BAL, P_ANN_BAL;
     EXIT WHEN F_SUMM_PRV%NOTFOUND;
     INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
            MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
            MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
            MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
            MLS_MAIN_ACNT_CODE,
            MLS_PREV_YR_OPEN_BAL, MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
            MLS_PREV_ANN_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_MTD_BAL, P_YTD_BAL, P_ANN_BAL);
EXIT WHEN F_SUMM_PRV%NOTFOUND;
END LOOP INS_DET_LEVEL_SUMM_PRV;
CLOSE F_SUMM_PRV;
IF P_TO_READ_TRAN_FLAG = 'Y' THEN
     IF F_DETL_PRV%ISOPEN THEN
          CLOSE F_DETL_PRV;
     END IF;
     OPEN F_DETL_PRV;
     <<INS_DET_LEVEL_DET_PRV>>
     LOOP
     FETCH F_DETL_PRV INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_MTD_BAL_SUB_1, P_MTD_BAL_SUB_2;
     EXIT WHEN F_DETL_PRV%NOTFOUND;
     P_MTD_BAL := -1 * (NVL(P_MTD_BAL_SUB_1,0) + NVL(P_MTD_BAL_SUB_2,0));
     P_YTD_BAL := -1 * NVL(P_MTD_BAL_SUB_2,0);
     INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
            MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
            MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
            MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
            MLS_MAIN_ACNT_CODE,
            MLS_PREV_YR_OPEN_BAL, MLS_PREV_MTD_OPBAL,
	    MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_MTD_BAL_SUB_1, P_MTD_BAL, P_YTD_BAL);
     END LOOP INS_DET_LEVEL_DET_PRV;
     CLOSE F_DETL_PRV;
END IF;
<<CALC_BUDGET>>
P_WORK_FRM_DT := P_FRM_DT;
P_WORK_TO_DT  := P_TO_DT;
P_AS_OF_DT := P_WORK_FRM_DT;
IF F_FRM_PERIOD%ISOPEN THEN
     CLOSE F_FRM_PERIOD;
END IF;
OPEN F_FRM_PERIOD;
FETCH F_FRM_PERIOD INTO P_FRM_ACNT_YEAR, P_FRM_CAL_YEAR, P_FRM_CAL_MONTH,
                        P_FRM_BEGIN_DT, P_FRM_END_DT,
                        P_FRM_READ_TRAN_FLAG, P_FRM_CUR_YEAR_FLAG;
IF F_FRM_PERIOD%NOTFOUND THEN
     P_ERR_NO := 909;
     CLOSE F_FRM_PERIOD;
     RETURN;
END IF;
CLOSE F_FRM_PERIOD;
P_AS_OF_DT := P_WORK_TO_DT;
IF F_TO_PERIOD%ISOPEN THEN
     CLOSE F_TO_PERIOD;
END IF;
OPEN F_TO_PERIOD;
FETCH F_TO_PERIOD INTO P_TO_ACNT_YEAR, P_TO_CAL_YEAR, P_TO_CAL_MONTH,
                       P_TO_BEGIN_DT, P_TO_END_DT,
                       P_TO_READ_TRAN_FLAG, P_TO_CUR_YEAR_FLAG;
IF F_TO_PERIOD%NOTFOUND THEN
     P_ERR_NO := 909;
     CLOSE F_TO_PERIOD;
     RETURN;
END IF;
CLOSE F_TO_PERIOD;
      IF P_INCL_BUD IN ('C', 'B') THEN
         P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
         P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
         IF BUD_FIGURES%ISOPEN THEN
            CLOSE BUD_FIGURES;
         END IF;
         OPEN BUD_FIGURES;
         <<BUD_FIG_SUMMARY>>
         LOOP
         FETCH BUD_FIGURES INTO P_LVL_CODE, P_ACNT_CODE,
                                P_DIVN_CODE, P_DEPT_CODE,
                                P_HEAD_NO_1, P_ANLY_CODE_1,
                                P_HEAD_NO_2, P_ANLY_CODE_2,
                                P_MTD_BAL, P_YTD_BAL, P_ANN_BAL;
         EXIT WHEN BUD_FIGURES%NOTFOUND;
         INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
                MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
                MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
                MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
                MLS_MAIN_ACNT_CODE,
                MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD)
         VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
                P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
                P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
                P_MTD_BAL, P_YTD_BAL, P_ANN_BAL);
         END LOOP BUD_FIG_SUMMARY;
         CLOSE BUD_FIGURES;
      END IF;
      IF P_INCL_BUD IN ('N', 'B') THEN
         P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
         P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
         IF NEXT_BUD_FIGURES%ISOPEN THEN
            CLOSE NEXT_BUD_FIGURES;
         END IF;
         OPEN NEXT_BUD_FIGURES;
         <<NEXT_BUD_FIG_SUMMARY>>
         LOOP
         FETCH NEXT_BUD_FIGURES INTO P_LVL_CODE, P_ACNT_CODE,
                                     P_DIVN_CODE, P_DEPT_CODE,
                                     P_HEAD_NO_1, P_ANLY_CODE_1,
                                     P_HEAD_NO_2, P_ANLY_CODE_2,
                                     P_MTD_BAL, P_YTD_BAL, P_ANN_BAL;
         EXIT WHEN NEXT_BUD_FIGURES%NOTFOUND;
         INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
                MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
                MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
                MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
                MLS_MAIN_ACNT_CODE,
                MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD)
         VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
                P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
                P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
                P_MTD_BAL, P_YTD_BAL, P_ANN_BAL);
         END LOOP NEXT_BUD_FIG_SUMMARY;
         CLOSE NEXT_BUD_FIGURES;
      END IF;
    IF P_INCL_MTH = 'C' THEN
       P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
       P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
       IF BUD_MONTHS%ISOPEN THEN
          CLOSE BUD_MONTHS;
       END IF;
       OPEN BUD_MONTHS;
       <<BUD_MON_SUMMARY>>
       LOOP
       FETCH BUD_MONTHS INTO  P_LVL_CODE, P_ACNT_CODE,
                              P_DIVN_CODE, P_DEPT_CODE,
                              P_HEAD_NO_1, P_ANLY_CODE_1,
                              P_HEAD_NO_2, P_ANLY_CODE_2,
                              P_M01_BUD, P_M02_BUD, P_M03_BUD,
                              P_M04_BUD, P_M05_BUD, P_M06_BUD,
                              P_M07_BUD, P_M08_BUD, P_M09_BUD,
                              P_M10_BUD, P_M11_BUD, P_M12_BUD;
       EXIT WHEN BUD_MONTHS%NOTFOUND;
       INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
              MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
              MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
              MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
              MLS_MAIN_ACNT_CODE,
              MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
              MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
              MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
              P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
              P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
              P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
              P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
              P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD);
       END LOOP BUD_MON_SUMMARY;
       CLOSE BUD_MONTHS;
    END IF;
    IF P_INCL_MTH = 'N' THEN
       P_FRM_CAL_YEAR_MONTH := P_FRM_CAL_YEAR * 100 + P_FRM_CAL_MONTH;
       P_TO_CAL_YEAR_MONTH  := P_TO_CAL_YEAR * 100 + P_TO_CAL_MONTH;
       IF NEXT_BUD_MONTHS%ISOPEN THEN
          CLOSE NEXT_BUD_MONTHS;
       END IF;
       OPEN NEXT_BUD_MONTHS;
       <<NEXT_BUD_MON_SUMMARY>>
       LOOP
       FETCH NEXT_BUD_MONTHS INTO  P_LVL_CODE, P_ACNT_CODE,
                              P_DIVN_CODE, P_DEPT_CODE,
                              P_HEAD_NO_1, P_ANLY_CODE_1,
                              P_HEAD_NO_2, P_ANLY_CODE_2,
                              P_M01_BUD, P_M02_BUD, P_M03_BUD,
                              P_M04_BUD, P_M05_BUD, P_M06_BUD,
                              P_M07_BUD, P_M08_BUD, P_M09_BUD,
                              P_M10_BUD, P_M11_BUD, P_M12_BUD;
       EXIT WHEN NEXT_BUD_MONTHS%NOTFOUND;
       INSERT INTO FW_MAIN_LEVEL_SUM_TEMP (
              MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_ACNT_YEAR,
              MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
              MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
              MLS_MAIN_ACNT_CODE,
              MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
              MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
              MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_TO_ACNT_YEAR,
              P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
              P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
              P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
              P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
              P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD);
       END LOOP NEXT_BUD_MON_SUMMARY;
       CLOSE NEXT_BUD_MONTHS;
    END IF;
SELECT MAX(LENGTH(LS_LVL_SEQ))
INTO   P_MAX_LENGTH
FROM   FW_LEVEL
WHERE  LS_FORMAT_ID = P_FORMAT_ID;
IF P_MAX_LENGTH > 18 THEN
     P_PAD_LENGTH := 1;
ELSE
     P_PAD_LENGTH := 2;
END IF;
INSERT INTO FW_MAIN_LEVEL_SUM (
    MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_LVL_NAME,
    MLS_LVL_TYPE, MLS_LVL_SEQ, MLS_PARENT_LVL_CODE, MLS_ACNT_YEAR,
    MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
    MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
    MLS_MAIN_ACNT_CODE,
    MLS_YR_OPEN_BAL, MLS_MTD_OPBAL,
    MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL,
    MLS_PREV_YR_OPEN_BAL, MLS_PREV_MTD_OPBAL,
    MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
    MLS_PREV_ANN_BAL,
    MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD,
    MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
    MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
    MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
    MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
SELECT MLS_KEY_NO, MLS_FORMAT_ID, LVL_CODE,
    LPAD(' ', P_PAD_LENGTH * ((LENGTH(LS_LVL_SEQ) / 3) - 1), ' ') ||
    LVL_NAME, LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
    MLS_ACNT_YEAR, MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
    MLS_HEAD_NO_1, MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
    MLS_MAIN_ACNT_CODE, SUM(MLS_YR_OPEN_BAL),
    SUM(MLS_MTD_OPBAL),
    SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
    SUM(MLS_PREV_YR_OPEN_BAL),
    SUM(MLS_PREV_MTD_OPBAL), SUM(MLS_PREV_MTD_BAL),
    SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
    SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
    SUM(MLS_ANN_BUD),
    SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
    SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
    SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
    SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
    SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
    SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
    SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
    SUM(MLS_M12_BUD)
FROM   FM_COA_LEVEL, FW_LEVEL, FW_MAIN_LEVEL_SUM_TEMP
WHERE  MLS_KEY_NO = P_KEY_NO
AND    MLS_FORMAT_ID = P_FORMAT_ID
AND    LS_FORMAT_ID = MLS_FORMAT_ID
AND    LS_LVL_CODE = MLS_LVL_CODE
AND    LVL_FORMAT_ID = LS_FORMAT_ID
AND    LVL_CODE = LS_LVL_CODE
GROUP BY MLS_KEY_NO, MLS_FORMAT_ID, LVL_CODE,
    LPAD(' ', P_PAD_LENGTH * ((LENGTH(LS_LVL_SEQ) / 3) - 1), ' ') ||
    LVL_NAME, LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
    MLS_ACNT_YEAR, MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
    MLS_HEAD_NO_1, MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
    MLS_MAIN_ACNT_CODE;
P_LENGTH := 0;
<<INS_LEVEL_SUM>>
LOOP
    P_MAX_LENGTH := P_MAX_LENGTH - 3;
    P_LENGTH := P_LENGTH + 3;
    IF P_MAX_LENGTH <= 0 THEN
       EXIT INS_LEVEL_SUM;
    END IF;
    INSERT INTO FW_MAIN_LEVEL_SUM (
           MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE, MLS_LVL_NAME,
           MLS_LVL_TYPE, MLS_LVL_SEQ, MLS_PARENT_LVL_CODE, MLS_ACNT_YEAR,
           MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE, MLS_HEAD_NO_1,
           MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
           MLS_MAIN_ACNT_CODE,
           MLS_YR_OPEN_BAL, MLS_MTD_OPBAL,
	   MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL,
           MLS_PREV_YR_OPEN_BAL, MLS_PREV_MTD_OPBAL,
	   MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
           MLS_PREV_ANN_BAL,
           MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD,
           MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
           MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
           MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
           MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
    SELECT MLS_KEY_NO, MLS_FORMAT_ID, LVL_CODE,
           LPAD(' ', P_PAD_LENGTH * ((LENGTH(B.LS_LVL_SEQ) / 3) - 1), ' ') ||
           LVL_NAME, B.LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
           MLS_ACNT_YEAR, MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
           MLS_HEAD_NO_1, MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2,
           '0', SUM(MLS_YR_OPEN_BAL),
           SUM(MLS_MTD_OPBAL),
	   SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
           SUM(MLS_PREV_YR_OPEN_BAL), SUM(MLS_PREV_MTD_OPBAL),
	   SUM(MLS_PREV_MTD_BAL),
           SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
           SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
           SUM(MLS_ANN_BUD),
           SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
           SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
           SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
           SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
           SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
           SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
           SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
           SUM(MLS_M12_BUD)
    FROM   FM_COA_LEVEL, FW_LEVEL B, FW_LEVEL A,
           FW_MAIN_LEVEL_SUM_TEMP
    WHERE  MLS_KEY_NO = P_KEY_NO
    AND    MLS_FORMAT_ID = P_FORMAT_ID
    AND    A.LS_FORMAT_ID = MLS_FORMAT_ID
    AND    A.LS_LVL_CODE = MLS_LVL_CODE
    AND    NVL(LENGTH(A.LS_LVL_SEQ), 0) - P_LENGTH > 0
    AND    B.LS_FORMAT_ID = A.LS_FORMAT_ID
    AND    B.LS_LVL_SEQ = SUBSTR(A.LS_LVL_SEQ, 1,
                          NVL(LENGTH(A.LS_LVL_SEQ), 0) - P_LENGTH)
    AND    LVL_FORMAT_ID = B.LS_FORMAT_ID
    AND    LVL_CODE = B.LS_LVL_CODE
    GROUP BY MLS_KEY_NO, MLS_FORMAT_ID, LVL_CODE,
        LPAD(' ', P_PAD_LENGTH * ((LENGTH(B.LS_LVL_SEQ) / 3) - 1), ' ') ||
        LVL_NAME, B.LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
        MLS_ACNT_YEAR, MLS_COMP_CODE, MLS_DIVN_CODE, MLS_DEPT_CODE,
        MLS_HEAD_NO_1, MLS_ANLY_CODE_1, MLS_HEAD_NO_2, MLS_ANLY_CODE_2;
END LOOP INS_LEVEL_SUM;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_LEVEL_SUM_REP
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_INCL_ACNT        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
   PREV_STR             VARCHAR2(27);
   RECORD_SEQ           NUMBER(6);
   HEAD_FLAG            VARCHAR2(1);
   FIRST_REC            NUMBER(1);
   BLANK_REC_FLAG       VARCHAR2(1);
   LVL_TYPE             VARCHAR2(1);
   P_LVL_CODE           VARCHAR2(6);
   P_LVL_NAME           VARCHAR2(50);
   P_LVL_TYPE           VARCHAR2(1);
   P_PARENT_LVL_CODE    VARCHAR2(6);
   P_TOTAL_FLAG         VARCHAR2(1);
   P_MTD_BAL            NUMBER(14,3);
   P_YTD_BAL            NUMBER(14,3);
   P_ANN_BAL            NUMBER(14,3);
   P_YR_OPEN_BAL        NUMBER(14,3);
   P_PREV_MTD_BAL       NUMBER(14,3);
   P_PREV_YTD_BAL       NUMBER(14,3);
   P_PREV_ANN_BAL       NUMBER(14,3);
   P_PREV_YR_OPEN_BAL   NUMBER(14,3);
   P_MTD_BUD            NUMBER(14,3);
   P_YTD_BUD            NUMBER(14,3);
   P_ANN_BUD            NUMBER(14,3);
   P_NEXT_MTD_BUD       NUMBER(14,3);
   P_NEXT_YTD_BUD       NUMBER(14,3);
   P_NEXT_ANN_BUD       NUMBER(14,3);
   P_M01_BUD            NUMBER(14,3);
   P_M02_BUD            NUMBER(14,3);
   P_M03_BUD            NUMBER(14,3);
   P_M04_BUD            NUMBER(14,3);
   P_M05_BUD            NUMBER(14,3);
   P_M06_BUD            NUMBER(14,3);
   P_M07_BUD            NUMBER(14,3);
   P_M08_BUD            NUMBER(14,3);
   P_M09_BUD            NUMBER(14,3);
   P_M10_BUD            NUMBER(14,3);
   P_M11_BUD            NUMBER(14,3);
   P_M12_BUD            NUMBER(14,3);
   T_LVL_CODE           VARCHAR2(6);
   T_LVL_NAME           VARCHAR2(50);
   T_LVL_TYPE           VARCHAR2(1);
   T_LVL_SEQ            NUMBER(6);
   T_PARENT_LVL_CODE    VARCHAR2(6);
   T_MAIN_ACNT_CODE     VARCHAR2(6);
   T_TOTAL_FLAG         VARCHAR2(1);
   T_LVL_STR            VARCHAR2(27);
   T_MTD_BAL            NUMBER(14,3);
   T_YTD_BAL            NUMBER(14,3);
   T_ANN_BAL            NUMBER(14,3);
   T_YR_OPEN_BAL        NUMBER(14,3);
   T_PREV_MTD_BAL       NUMBER(14,3);
   T_PREV_YTD_BAL       NUMBER(14,3);
   T_PREV_ANN_BAL       NUMBER(14,3);
   T_PREV_YR_OPEN_BAL   NUMBER(14,3);
   T_MTD_BUD            NUMBER(14,3);
   T_YTD_BUD            NUMBER(14,3);
   T_ANN_BUD            NUMBER(14,3);
   T_NEXT_MTD_BUD       NUMBER(14,3);
   T_NEXT_YTD_BUD       NUMBER(14,3);
   T_NEXT_ANN_BUD       NUMBER(14,3);
   T_M01_BUD            NUMBER(14,3);
   T_M02_BUD            NUMBER(14,3);
   T_M03_BUD            NUMBER(14,3);
   T_M04_BUD            NUMBER(14,3);
   T_M05_BUD            NUMBER(14,3);
   T_M06_BUD            NUMBER(14,3);
   T_M07_BUD            NUMBER(14,3);
   T_M08_BUD            NUMBER(14,3);
   T_M09_BUD            NUMBER(14,3);
   T_M10_BUD            NUMBER(14,3);
   T_M11_BUD            NUMBER(14,3);
   T_M12_BUD            NUMBER(14,3);
   TEMP_LVL_CODE           VARCHAR2(6);
   TEMP_LVL_NAME           VARCHAR2(50);
   TEMP_LVL_TYPE           VARCHAR2(1);
   TEMP_LVL_SEQ            NUMBER(6);
   TEMP_PARENT_LVL_CODE    VARCHAR2(6);
   TEMP_MAIN_ACNT_CODE     VARCHAR2(6);
   TEMP_TOTAL_FLAG         VARCHAR2(1);
   TEMP_LVL_STR            VARCHAR2(27);
   TEMP_MTD_BAL            NUMBER(14,3);
   TEMP_YTD_BAL            NUMBER(14,3);
   TEMP_ANN_BAL            NUMBER(14,3);
   TEMP_YR_OPEN_BAL        NUMBER(14,3);
   TEMP_PREV_MTD_BAL       NUMBER(14,3);
   TEMP_PREV_YTD_BAL       NUMBER(14,3);
   TEMP_PREV_ANN_BAL       NUMBER(14,3);
   TEMP_PREV_YR_OPEN_BAL   NUMBER(14,3);
   TEMP_MTD_BUD            NUMBER(14,3);
   TEMP_YTD_BUD            NUMBER(14,3);
   TEMP_ANN_BUD            NUMBER(14,3);
   TEMP_NEXT_MTD_BUD       NUMBER(14,3);
   TEMP_NEXT_YTD_BUD       NUMBER(14,3);
   TEMP_NEXT_ANN_BUD       NUMBER(14,3);
   TEMP_M01_BUD            NUMBER(14,3);
   TEMP_M02_BUD            NUMBER(14,3);
   TEMP_M03_BUD            NUMBER(14,3);
   TEMP_M04_BUD            NUMBER(14,3);
   TEMP_M05_BUD            NUMBER(14,3);
   TEMP_M06_BUD            NUMBER(14,3);
   TEMP_M07_BUD            NUMBER(14,3);
   TEMP_M08_BUD            NUMBER(14,3);
   TEMP_M09_BUD            NUMBER(14,3);
   TEMP_M10_BUD            NUMBER(14,3);
   TEMP_M11_BUD            NUMBER(14,3);
   TEMP_M12_BUD            NUMBER(14,3);
   CURSOR C1 IS
          SELECT MLS_LVL_CODE, MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0'),
                 LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FW_LEVEL, FM_COA_LEVEL, FW_MAIN_LEVEL_SUM
          WHERE  MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = P_FORMAT_ID
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          AND    LS_FORMAT_ID = LVL_FORMAT_ID
          AND    LS_LVL_CODE = LVL_CODE
          GROUP BY MLS_LVL_CODE, MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0'),
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N')
          ORDER  BY LS_LVL_SEQ,
                   DECODE(P_INCL_ACNT, 'Y', MLS_MAIN_ACNT_CODE, '0');
   CURSOR C2 IS
          SELECT MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                 MLS_PARENT_LVL_CODE,
                 NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MLS_MTD_BAL), SUM(MLS_YTD_BAL), SUM(MLS_ANN_BAL),
                 SUM(MLS_YR_OPEN_BAL), SUM(MLS_PREV_MTD_BAL),
                 SUM(MLS_PREV_YTD_BAL), SUM(MLS_PREV_ANN_BAL),
                 SUM(MLS_PREV_YR_OPEN_BAL),
                 SUM(MLS_MTD_BUD), SUM(MLS_YTD_BUD),
                 SUM(MLS_ANN_BUD),
                 SUM(MLS_NEXT_MTD_BUD), SUM(MLS_NEXT_YTD_BUD),
                 SUM(MLS_NEXT_ANN_BUD), SUM(MLS_M01_BUD),
                 SUM(MLS_M02_BUD), SUM(MLS_M03_BUD),
                 SUM(MLS_M04_BUD), SUM(MLS_M05_BUD),
                 SUM(MLS_M06_BUD), SUM(MLS_M07_BUD),
                 SUM(MLS_M08_BUD), SUM(MLS_M09_BUD),
                 SUM(MLS_M10_BUD), SUM(MLS_M11_BUD),
                 SUM(MLS_M12_BUD)
          FROM   FM_COA_LEVEL, FW_MAIN_LEVEL_SUM, FW_LEVEL
          WHERE  LS_FORMAT_ID = P_FORMAT_ID
          AND    LS_LVL_SEQ = PREV_STR
          AND    MLS_KEY_NO = P_KEY_NO
          AND    MLS_FORMAT_ID = LS_FORMAT_ID
          AND    MLS_LVL_CODE = LS_LVL_CODE
          AND    LVL_FORMAT_ID = MLS_FORMAT_ID
          AND    LVL_CODE = MLS_LVL_CODE
          GROUP BY MLS_LVL_CODE, '   TOTAL ' || MLS_LVL_NAME, MLS_LVL_TYPE,
                   MLS_PARENT_LVL_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N');
  PROCEDURE INSERT_BLANK_REC IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     LVL_TYPE := T_LVL_TYPE;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_SEQ, MLS_LVL_TYPE)
     VALUES (P_KEY_NO, P_FORMAT_ID, RECORD_SEQ, LVL_TYPE);
  END;
  PROCEDURE INSERT_HEAD IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, T_LVL_CODE,
             T_LVL_NAME, T_LVL_TYPE, RECORD_SEQ,
             T_PARENT_LVL_CODE);
     INSERT_BLANK_REC;
  END;
  PROCEDURE INSERT_REC IS
     CURSOR C3 IS
       SELECT MAIN_ACNT_NAME
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = T_MAIN_ACNT_CODE;
     C3_LVL_NAME	VARCHAR2(30);
     M_DIFF             NUMBER(2);
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     IF NVL(T_MAIN_ACNT_CODE, '0') != '0' THEN
        IF C3%ISOPEN THEN
           CLOSE C3;
        END IF;
        OPEN C3;
        FETCH C3 INTO C3_LVL_NAME;
        IF C3%FOUND THEN
             M_DIFF := LENGTH(T_LVL_NAME) - LENGTH(LTRIM(T_LVL_NAME));
             T_LVL_NAME := LPAD(C3_LVL_NAME, LENGTH(C3_LVL_NAME) + M_DIFF);
        END IF;
        CLOSE C3;
     END IF;
     INSERT INTO FW_MAIN_LEVEL_SUM_REP
            (MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
            MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
            MLS_PARENT_LVL_CODE, MLS_MAIN_ACNT_CODE,
            MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
            MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL, MLS_PREV_ANN_BAL,
            MLS_PREV_YR_OPEN_BAL, MLS_MTD_BUD, MLS_YTD_BUD,
            MLS_ANN_BUD,
            MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
            MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
            MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
            MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
     VALUES (P_KEY_NO, P_FORMAT_ID,
            T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
            RECORD_SEQ, T_PARENT_LVL_CODE,
            T_MAIN_ACNT_CODE, T_MTD_BAL, T_YTD_BAL, T_ANN_BAL,
            T_YR_OPEN_BAL, T_PREV_MTD_BAL,
            T_PREV_YTD_BAL, T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
            T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
            T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
            T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
            T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
            T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD);
  END;
  PROCEDURE PROCESS_TOTAL IS
  BEGIN
    IF C2%ISOPEN THEN
       CLOSE C2;
    END IF;
    OPEN C2;
    FETCH C2 INTO P_LVL_CODE, P_LVL_NAME, P_LVL_TYPE,
                  P_PARENT_LVL_CODE,
                  P_TOTAL_FLAG,
                  P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
                  P_PREV_MTD_BAL, P_PREV_YTD_BAL, P_PREV_ANN_BAL,
                  P_PREV_YR_OPEN_BAL,
                  P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
                  P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
                  P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
                  P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
                  P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD;
    IF C2%FOUND AND P_TOTAL_FLAG = 'Y' THEN
       RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
       INSERT INTO FW_MAIN_LEVEL_SUM_REP (
              MLS_KEY_NO, MLS_FORMAT_ID, MLS_LVL_CODE,
              MLS_LVL_NAME, MLS_LVL_TYPE, MLS_LVL_SEQ,
              MLS_PARENT_LVL_CODE,
              MLS_MTD_BAL, MLS_YTD_BAL, MLS_ANN_BAL, MLS_YR_OPEN_BAL,
              MLS_PREV_MTD_BAL, MLS_PREV_YTD_BAL,
              MLS_PREV_ANN_BAL, MLS_PREV_YR_OPEN_BAL,
              MLS_MTD_BUD, MLS_YTD_BUD, MLS_ANN_BUD,
              MLS_NEXT_MTD_BUD, MLS_NEXT_YTD_BUD, MLS_NEXT_ANN_BUD,
              MLS_M01_BUD, MLS_M02_BUD, MLS_M03_BUD, MLS_M04_BUD,
              MLS_M05_BUD, MLS_M06_BUD, MLS_M07_BUD, MLS_M08_BUD,
              MLS_M09_BUD, MLS_M10_BUD, MLS_M11_BUD, MLS_M12_BUD)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE,
              P_LVL_NAME, P_LVL_TYPE, RECORD_SEQ,
              P_PARENT_LVL_CODE,
              P_MTD_BAL, P_YTD_BAL, P_ANN_BAL, P_YR_OPEN_BAL,
              P_PREV_MTD_BAL, P_PREV_YTD_BAL,
              P_PREV_ANN_BAL, P_PREV_YR_OPEN_BAL,
              P_MTD_BUD, P_YTD_BUD, P_ANN_BUD,
              P_NEXT_MTD_BUD, P_NEXT_YTD_BUD, P_NEXT_ANN_BUD,
              P_M01_BUD, P_M02_BUD, P_M03_BUD, P_M04_BUD,
              P_M05_BUD, P_M06_BUD, P_M07_BUD, P_M08_BUD,
              P_M09_BUD, P_M10_BUD, P_M11_BUD, P_M12_BUD);
       INSERT_BLANK_REC;
    END IF;
    CLOSE C2;
    HEAD_FLAG := 'N';
END;
BEGIN
   DELETE FROM FW_MAIN_LEVEL_SUM_REP
          WHERE MLS_KEY_NO = P_KEY_NO;
   PREV_STR := '';
   RECORD_SEQ := 0;
   HEAD_FLAG := 'N';
   FIRST_REC := 0;
   BLANK_REC_FLAG := 'N';
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF;
   OPEN C1;
LOOP
   FETCH C1 INTO TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
                 TEMP_PARENT_LVL_CODE,
                 TEMP_MAIN_ACNT_CODE,
                 TEMP_LVL_STR, TEMP_TOTAL_FLAG,
                 TEMP_MTD_BAL, TEMP_YTD_BAL,
                 TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
                 TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
                 TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
                 TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
                 TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
                 TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
                 TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
                 TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD;
    IF FIRST_REC = 0 THEN
       IF C1%NOTFOUND THEN
          EXIT;
       END IF;
       FIRST_REC := 1;
    ELSE
      IF C1%NOTFOUND THEN
         INSERT_REC;
         EXIT;
      END IF;
      IF LENGTH(T_LVL_STR) > LENGTH(TEMP_LVL_STR) THEN
         INSERT_REC;
         INSERT_BLANK_REC;
	 PROCESS_TOTAL;
         LOOP
            PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
            IF LENGTH(PREV_STR) >= LENGTH(TEMP_LVL_STR) THEN
	       PROCESS_TOTAL;
            ELSE
               EXIT;
            END IF;
         END LOOP;
         BLANK_REC_FLAG := 'N';
      ELSIF LENGTH(T_LVL_STR) < LENGTH(TEMP_LVL_STR) THEN
            PREV_STR := T_LVL_STR;
            IF T_TOTAL_FLAG = 'Y' THEN
               IF BLANK_REC_FLAG = 'D' THEN
                  INSERT_BLANK_REC;
                  BLANK_REC_FLAG := 'N';
               END IF;
               INSERT_HEAD;
            END IF;
      ELSE
        BLANK_REC_FLAG := 'D';
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           INSERT_REC;
           IF NVL(SUBSTR(T_LVL_STR, 1, LENGTH(T_LVL_STR) - 3), '1') !=
              NVL(SUBSTR(TEMP_LVL_STR, 1, LENGTH(TEMP_LVL_STR) - 3), '2') THEN
                INSERT_BLANK_REC;
                BLANK_REC_FLAG := 'N';
           END IF;
        END IF;
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           NULL;
        ELSIF T_LVL_STR != TEMP_LVL_STR THEN
              INSERT_REC;
              INSERT_BLANK_REC;
              IF HEAD_FLAG = 'T' THEN
                 PROCESS_TOTAL;
                 PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
              END IF;
        ELSIF T_LVL_STR = TEMP_LVL_STR THEN
              IF T_TOTAL_FLAG = 'Y' AND HEAD_FLAG = 'N' THEN
                 INSERT_HEAD;
                 PREV_STR := T_LVL_STR;
                 HEAD_FLAG := 'T';
              END IF;
              INSERT_REC;
        END IF;
      END IF;
   END IF;
      SELECT TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
             TEMP_LVL_SEQ, TEMP_PARENT_LVL_CODE,
             TEMP_MAIN_ACNT_CODE,
             TEMP_LVL_STR, TEMP_TOTAL_FLAG,
             TEMP_MTD_BAL, TEMP_YTD_BAL,
             TEMP_ANN_BAL, TEMP_YR_OPEN_BAL,
             TEMP_PREV_MTD_BAL, TEMP_PREV_YTD_BAL,
             TEMP_PREV_ANN_BAL, TEMP_PREV_YR_OPEN_BAL,
             TEMP_MTD_BUD, TEMP_YTD_BUD, TEMP_ANN_BUD,
             TEMP_NEXT_MTD_BUD, TEMP_NEXT_YTD_BUD, TEMP_NEXT_ANN_BUD,
             TEMP_M01_BUD, TEMP_M02_BUD, TEMP_M03_BUD, TEMP_M04_BUD,
             TEMP_M05_BUD, TEMP_M06_BUD, TEMP_M07_BUD, TEMP_M08_BUD,
             TEMP_M09_BUD, TEMP_M10_BUD, TEMP_M11_BUD, TEMP_M12_BUD
      INTO   T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
             T_LVL_SEQ, T_PARENT_LVL_CODE,
             T_MAIN_ACNT_CODE,
             T_LVL_STR, T_TOTAL_FLAG,
             T_MTD_BAL, T_YTD_BAL, T_ANN_BAL, T_YR_OPEN_BAL,
             T_PREV_MTD_BAL, T_PREV_YTD_BAL,
             T_PREV_ANN_BAL, T_PREV_YR_OPEN_BAL,
             T_MTD_BUD, T_YTD_BUD, T_ANN_BUD,
             T_NEXT_MTD_BUD, T_NEXT_YTD_BUD, T_NEXT_ANN_BUD,
             T_M01_BUD, T_M02_BUD, T_M03_BUD, T_M04_BUD,
             T_M05_BUD, T_M06_BUD, T_M07_BUD, T_M08_BUD,
             T_M09_BUD, T_M10_BUD, T_M11_BUD, T_M12_BUD
      FROM   DUAL;
END LOOP;
   CLOSE C1;
   INSERT_BLANK_REC;
   IF PREV_STR IS NOT NULL THEN
      PROCESS_TOTAL;
   END IF;
   LOOP
      PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
      IF LENGTH(PREV_STR) > 0 THEN
	 PROCESS_TOTAL;
      ELSE
         EXIT;
      END IF;
   END LOOP;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_YEAR_SUM
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_ACNT_YEAR        IN    NUMBER,
                  P_YEARS            IN    NUMBER,
                  P_INCL_BUD         IN    VARCHAR2,
                  P_INCL_ZERO        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
P_CUR_ACNT_YEAR        NUMBER(2);
P_WORK_ACNT_YEAR       NUMBER(2);
P_TEMP_ACNT_YEAR       NUMBER(2);
P_NO_YEARS             NUMBER(2);
P_LVL_CODE             VARCHAR2(6);
P_ACNT_CODE            VARCHAR2(6);
P_DIVN_CODE            VARCHAR2(6);
P_DEPT_CODE            VARCHAR2(6);
P_HEAD_NO_1            NUMBER(1);
P_ANLY_CODE_1          VARCHAR(6);
P_HEAD_NO_2            NUMBER(1);
P_ANLY_CODE_2          VARCHAR(6);
P_ANN_BAL              NUMBER(14,3);
P_YTD_BAL              NUMBER(14,3);
P_YR_OPEN_BAL          NUMBER(14,3);
P_MAX_LENGTH           NUMBER(3);
P_LENGTH               NUMBER(3);
P_PAD_LENGTH           NUMBER(2);
CURSOR F_SUMM_CUR IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0'),
       SUM(DECODE(ABAL_CAL_MONTH, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0), 0)),
       SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
FROM   FS_CUR_ACNT_BAL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = ABAL_MAIN_ACNT_CODE
AND    ABAL_COMP_CODE = P_COMP_CODE
AND    ABAL_ACNT_YEAR = P_WORK_ACNT_YEAR
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0');
CURSOR F_SUMM_PRV IS
SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0'),
       SUM(DECODE(ABAL_CAL_MONTH, 0,
                         NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0), 0)),
       SUM(NVL(ABAL_LC_MTD_DR,0) - NVL(ABAL_LC_MTD_CR,0))
FROM   FS_PRV_ACNT_BAL, FM_COA_ACNT_FORMAT
WHERE  CAF_FORMAT_ID = P_FORMAT_ID
AND    CAF_MAIN_ACNT_CODE = ABAL_MAIN_ACNT_CODE
AND    ABAL_COMP_CODE = P_COMP_CODE
AND    ABAL_ACNT_YEAR = P_WORK_ACNT_YEAR
GROUP BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
       NVL(ABAL_DIVN_CODE, '0'),
       NVL(ABAL_DEPT_CODE, '0'),
       NVL(ABAL_HEAD_NO_1, 0),
       NVL(ABAL_ANLY_CODE_1, '0'),
       NVL(ABAL_HEAD_NO_2, 0),
       NVL(ABAL_ANLY_CODE_2, '0');
PROCEDURE BUDGET_SELECT IS
  CURSOR BUD_FIGURES IS
  SELECT CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
         NVL(MBUD_DIVN_CODE, '0'),
         NVL(MBUD_DEPT_CODE, '0'),
         NVL(MBUD_HEAD_NO_1, 0),
         NVL(MBUD_ANLY_CODE_1, '0'),
         NVL(MBUD_HEAD_NO_2, 0),
         NVL(MBUD_ANLY_CODE_2, '0'),
         SUM(DECODE(YBUD_ORGL_DRCR_FLAG,'D',1,-1) *
	     NVL(MBUD_ORGL_AMT,0))
  FROM   FM_YEARLY_BUDGET, FM_MONTHLY_BUDGET, FM_COA_ACNT_FORMAT
  WHERE  CAF_FORMAT_ID = P_FORMAT_ID
  AND    CAF_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
  AND    MBUD_COMP_CODE = P_COMP_CODE
  AND    MBUD_ACNT_YEAR = P_WORK_ACNT_YEAR
  AND    MBUD_YEAR_FLAG = 'C'
  AND    YBUD_COMP_CODE = MBUD_COMP_CODE
  AND    YBUD_ACNT_YEAR = MBUD_ACNT_YEAR
  AND    YBUD_MAIN_ACNT_CODE = MBUD_MAIN_ACNT_CODE
  AND    NVL(YBUD_SUB_ACNT_CODE,'0') = NVL(MBUD_SUB_ACNT_CODE,'0')
  AND    NVL(YBUD_DIVN_CODE,'0') = NVL(MBUD_DIVN_CODE,'0')
  AND    NVL(YBUD_DEPT_CODE,'0') = NVL(MBUD_DEPT_CODE,'0')
  AND    NVL(YBUD_HEAD_NO_1,0) = NVL(MBUD_HEAD_NO_1,0)
  AND    NVL(YBUD_ANLY_CODE_1,'0') = NVL(MBUD_ANLY_CODE_1,'0')
  AND    NVL(YBUD_HEAD_NO_2,0) = NVL(MBUD_HEAD_NO_2,0)
  AND    NVL(YBUD_ANLY_CODE_2,'0') = NVL(MBUD_ANLY_CODE_2,'0')
  GROUP  BY CAF_LVL_CODE, CAF_MAIN_ACNT_CODE,
         NVL(MBUD_DIVN_CODE, '0'),
         NVL(MBUD_DEPT_CODE, '0'),
         NVL(MBUD_HEAD_NO_1, 0),
         NVL(MBUD_ANLY_CODE_1, '0'),
         NVL(MBUD_HEAD_NO_2, 0),
         NVL(MBUD_ANLY_CODE_2, '0');
BEGIN
  IF BUD_FIGURES%ISOPEN THEN
     CLOSE BUD_FIGURES;
  END IF;
  OPEN BUD_FIGURES;
  <<BUD_FIG_SUMMARY>>
  LOOP
  FETCH BUD_FIGURES INTO P_LVL_CODE, P_ACNT_CODE,
                         P_DIVN_CODE, P_DEPT_CODE,
                         P_HEAD_NO_1, P_ANLY_CODE_1,
                         P_HEAD_NO_2, P_ANLY_CODE_2,
                         P_ANN_BAL;
  EXIT WHEN BUD_FIGURES%NOTFOUND;
  INSERT INTO FW_MAIN_YEAR_SUM_TEMP (
         MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE, MYS_ACNT_YEAR,
         MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE, MYS_HEAD_NO_1,
         MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
         MYS_MAIN_ACNT_CODE,
         MYS_ANN_BUD)
  VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_NO_YEARS,
         P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
         P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
         P_ANN_BAL);
  END LOOP BUD_FIG_SUMMARY;
  CLOSE BUD_FIGURES;
END;
BEGIN
DELETE FROM FW_MAIN_YEAR_SUM_TEMP
       WHERE MYS_KEY_NO = P_KEY_NO;
DELETE FROM FW_MAIN_YEAR_SUM
       WHERE MYS_KEY_NO = P_KEY_NO;
P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
P_TEMP_ACNT_YEAR := P_ACNT_YEAR;
P_NO_YEARS := 0;
<<YEARS_LOOP>>
LOOP
    P_WORK_ACNT_YEAR := P_TEMP_ACNT_YEAR;
    P_NO_YEARS := P_NO_YEARS + 1;
    IF (P_NO_YEARS > P_YEARS) OR (P_TEMP_ACNT_YEAR <= 0) THEN
       EXIT YEARS_LOOP;
    END IF;
Press <Enter> to continue...
  IF P_WORK_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
     IF F_SUMM_CUR%ISOPEN THEN
          CLOSE F_SUMM_CUR;
     END IF;
     OPEN F_SUMM_CUR;
     <<INS_DET_YEAR_SUMM_CUR>>
     LOOP
     IF P_WORK_ACNT_YEAR = P_TEMP_ACNT_YEAR THEN
        P_TEMP_ACNT_YEAR := P_TEMP_ACNT_YEAR - 1;
     END IF;
     FETCH F_SUMM_CUR INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_YR_OPEN_BAL,
                           P_YTD_BAL;
     EXIT WHEN F_SUMM_CUR%NOTFOUND;
     INSERT INTO FW_MAIN_YEAR_SUM_TEMP (
            MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE, MYS_ACNT_YEAR,
            MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE, MYS_HEAD_NO_1,
            MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
            MYS_MAIN_ACNT_CODE,
            MYS_YR_OPEN_BAL, MYS_YTD_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_NO_YEARS,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_YTD_BAL);
     END LOOP INS_DET_YEAR_SUMM_CUR;
     CLOSE F_SUMM_CUR;
     IF P_INCL_BUD = 'Y' THEN
        BUDGET_SELECT;
     END IF;
  ELSE
     IF F_SUMM_PRV%ISOPEN THEN
          CLOSE F_SUMM_PRV;
     END IF;
     OPEN F_SUMM_PRV;
     <<INS_DET_YEAR_SUMM_PRV>>
     LOOP
     IF P_WORK_ACNT_YEAR = P_TEMP_ACNT_YEAR THEN
        P_TEMP_ACNT_YEAR := P_TEMP_ACNT_YEAR - 1;
     END IF;
     FETCH F_SUMM_PRV INTO P_LVL_CODE, P_ACNT_CODE,
                           P_DIVN_CODE, P_DEPT_CODE,
                           P_HEAD_NO_1, P_ANLY_CODE_1,
                           P_HEAD_NO_2, P_ANLY_CODE_2,
                           P_YR_OPEN_BAL, P_YTD_BAL;
     EXIT WHEN F_SUMM_PRV%NOTFOUND;
     INSERT INTO FW_MAIN_YEAR_SUM_TEMP (
            MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE, MYS_ACNT_YEAR,
            MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE, MYS_HEAD_NO_1,
            MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
            MYS_MAIN_ACNT_CODE,
            MYS_YR_OPEN_BAL, MYS_YTD_BAL)
     VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE, P_NO_YEARS,
            P_COMP_CODE, P_DIVN_CODE, P_DEPT_CODE, P_HEAD_NO_1,
            P_ANLY_CODE_1, P_HEAD_NO_2, P_ANLY_CODE_2, P_ACNT_CODE,
            P_YR_OPEN_BAL, P_YTD_BAL);
     END LOOP INS_DET_YEAR_SUMM_PRV;
     CLOSE F_SUMM_PRV;
     IF P_INCL_BUD = 'Y' THEN
        BUDGET_SELECT;
     END IF;
  END IF;
    IF P_TEMP_ACNT_YEAR = P_WORK_ACNT_YEAR THEN
       EXIT YEARS_LOOP;
    END IF;
END LOOP YEARS_LOOP;
    IF NVL(P_INCL_ZERO, 'N') = 'Y' THEN
       DELETE FROM FW_MAIN_YEAR_SUM_TEMP
              WHERE MYS_KEY_NO = P_KEY_NO
              AND   MYS_FORMAT_ID = P_FORMAT_ID
              AND   MYS_YR_OPEN_BAL = 0
              AND   MYS_YTD_BAL = 0
              AND   MYS_ANN_BUD = 0;
    END IF;
  SELECT MAX(LENGTH(LS_LVL_SEQ))
  INTO   P_MAX_LENGTH
  FROM   FW_LEVEL
  WHERE  LS_FORMAT_ID = P_FORMAT_ID;
  IF P_MAX_LENGTH > 18 THEN
       P_PAD_LENGTH := 1;
  ELSE
       P_PAD_LENGTH := 2;
  END IF;
  INSERT INTO FW_MAIN_YEAR_SUM (
      MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE, MYS_LVL_NAME,
      MYS_LVL_TYPE, MYS_LVL_SEQ, MYS_PARENT_LVL_CODE, MYS_ACNT_YEAR,
      MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE, MYS_HEAD_NO_1,
      MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
      MYS_MAIN_ACNT_CODE,
      MYS_YR_OPEN_BAL_1, MYS_YTD_BAL_1, MYS_ANN_BUD_1,
      MYS_YR_OPEN_BAL_2, MYS_YTD_BAL_2, MYS_ANN_BUD_2,
      MYS_YR_OPEN_BAL_3, MYS_YTD_BAL_3, MYS_ANN_BUD_3,
      MYS_YR_OPEN_BAL_4, MYS_YTD_BAL_4, MYS_ANN_BUD_4,
      MYS_YR_OPEN_BAL_5, MYS_YTD_BAL_5, MYS_ANN_BUD_5)
  SELECT MYS_KEY_NO, MYS_FORMAT_ID, LVL_CODE,
      LPAD(' ', P_PAD_LENGTH * ((LENGTH(LS_LVL_SEQ) / 3) - 1), ' ') ||
      LVL_NAME, LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
      P_ACNT_YEAR, MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE,
      MYS_HEAD_NO_1, MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
      MYS_MAIN_ACNT_CODE,
      SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_YR_OPEN_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_YTD_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_ANN_BUD),
      SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_YR_OPEN_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_YTD_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_ANN_BUD),
      SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_YR_OPEN_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_YTD_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_ANN_BUD),
      SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_YR_OPEN_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_YTD_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_ANN_BUD),
      SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_YR_OPEN_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_YTD_BAL),
      SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_ANN_BUD)
  FROM   FM_COA_LEVEL, FW_LEVEL, FW_MAIN_YEAR_SUM_TEMP
  WHERE  MYS_KEY_NO = P_KEY_NO
  AND    MYS_FORMAT_ID = P_FORMAT_ID
  AND    LS_FORMAT_ID = MYS_FORMAT_ID
  AND    LS_LVL_CODE = MYS_LVL_CODE
  AND    LVL_FORMAT_ID = LS_FORMAT_ID
  AND    LVL_CODE = LS_LVL_CODE
  GROUP BY MYS_KEY_NO, MYS_FORMAT_ID, LVL_CODE,
      LPAD(' ', P_PAD_LENGTH * ((LENGTH(LS_LVL_SEQ) / 3) - 1), ' ') ||
      LVL_NAME, LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
      P_ACNT_YEAR, MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE,
      MYS_HEAD_NO_1, MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
      MYS_MAIN_ACNT_CODE;
  P_LENGTH := 0;
  <<INS_YEAR_SUM>>
  LOOP
      P_MAX_LENGTH := P_MAX_LENGTH - 3;
      P_LENGTH := P_LENGTH + 3;
      IF P_MAX_LENGTH <= 0 THEN
         EXIT INS_YEAR_SUM;
      END IF;
      INSERT INTO FW_MAIN_YEAR_SUM (
             MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE, MYS_LVL_NAME,
             MYS_LVL_TYPE, MYS_LVL_SEQ, MYS_PARENT_LVL_CODE, MYS_ACNT_YEAR,
             MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE, MYS_HEAD_NO_1,
             MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
             MYS_MAIN_ACNT_CODE,
             MYS_YR_OPEN_BAL_1, MYS_YTD_BAL_1, MYS_ANN_BUD_1,
             MYS_YR_OPEN_BAL_2, MYS_YTD_BAL_2, MYS_ANN_BUD_2,
             MYS_YR_OPEN_BAL_3, MYS_YTD_BAL_3, MYS_ANN_BUD_3,
             MYS_YR_OPEN_BAL_4, MYS_YTD_BAL_4, MYS_ANN_BUD_4,
             MYS_YR_OPEN_BAL_5, MYS_YTD_BAL_5, MYS_ANN_BUD_5)
      SELECT MYS_KEY_NO, MYS_FORMAT_ID, LVL_CODE,
             LPAD(' ', P_PAD_LENGTH * ((LENGTH(B.LS_LVL_SEQ) / 3) - 1), ' ') ||
             LVL_NAME, B.LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
             MYS_ACNT_YEAR, MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE,
             MYS_HEAD_NO_1, MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2,
             '0',
             SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_YR_OPEN_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_YTD_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 1, 1, 0) * MYS_ANN_BUD),
             SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_YR_OPEN_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_YTD_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 2, 1, 0) * MYS_ANN_BUD),
             SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_YR_OPEN_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_YTD_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 3, 1, 0) * MYS_ANN_BUD),
             SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_YR_OPEN_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_YTD_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 4, 1, 0) * MYS_ANN_BUD),
             SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_YR_OPEN_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_YTD_BAL),
             SUM(DECODE(MYS_ACNT_YEAR, 5, 1, 0) * MYS_ANN_BUD)
      FROM   FM_COA_LEVEL, FW_LEVEL B, FW_LEVEL A,
             FW_MAIN_YEAR_SUM_TEMP
      WHERE  MYS_KEY_NO = P_KEY_NO
      AND    MYS_FORMAT_ID = P_FORMAT_ID
      AND    A.LS_FORMAT_ID = MYS_FORMAT_ID
      AND    A.LS_LVL_CODE = MYS_LVL_CODE
      AND    NVL(LENGTH(A.LS_LVL_SEQ), 0) - P_LENGTH > 0
      AND    B.LS_FORMAT_ID = A.LS_FORMAT_ID
      AND    B.LS_LVL_SEQ = SUBSTR(A.LS_LVL_SEQ, 1,
                            NVL(LENGTH(A.LS_LVL_SEQ), 0) - P_LENGTH)
      AND    LVL_FORMAT_ID = B.LS_FORMAT_ID
      AND    LVL_CODE = B.LS_LVL_CODE
      GROUP BY MYS_KEY_NO, MYS_FORMAT_ID, LVL_CODE,
          LPAD(' ', P_PAD_LENGTH * ((LENGTH(B.LS_LVL_SEQ) / 3) - 1), ' ') ||
          LVL_NAME, B.LS_LVL_TYPE, LVL_SEQ_NO, LVL_PARENT_CODE,
          MYS_ACNT_YEAR, MYS_COMP_CODE, MYS_DIVN_CODE, MYS_DEPT_CODE,
          MYS_HEAD_NO_1, MYS_ANLY_CODE_1, MYS_HEAD_NO_2, MYS_ANLY_CODE_2;
  END LOOP INS_YEAR_SUM;
END;
/
CREATE OR REPLACE PROCEDURE F_MAIN_YEAR_SUM_REP
                 (P_KEY_NO           IN    NUMBER,
                  P_COMP_CODE        IN    VARCHAR2,
                  P_FORMAT_ID        IN    NUMBER,
                  P_INCL_ACNT        IN    VARCHAR2,
                  P_ERR_NO          OUT    NUMBER) AS
   PREV_STR             VARCHAR2(27);
   RECORD_SEQ           NUMBER(6);
   HEAD_FLAG            VARCHAR2(1);
   FIRST_REC            NUMBER(1);
   BLANK_REC_FLAG       VARCHAR2(1);
   LVL_TYPE             VARCHAR2(1);
   P_LVL_CODE           VARCHAR2(6);
   P_LVL_NAME           VARCHAR2(50);
   P_LVL_TYPE           VARCHAR2(1);
   P_PARENT_LVL_CODE    VARCHAR2(6);
   P_TOTAL_FLAG         VARCHAR2(1);
   P_YTD_BAL_1          NUMBER(14,3);
   P_YR_OPEN_BAL_1      NUMBER(14,3);
   P_ANN_BUD_1          NUMBER(14,3);
   P_YTD_BAL_2          NUMBER(14,3);
   P_YR_OPEN_BAL_2      NUMBER(14,3);
   P_ANN_BUD_2          NUMBER(14,3);
   P_YTD_BAL_3          NUMBER(14,3);
   P_YR_OPEN_BAL_3      NUMBER(14,3);
   P_ANN_BUD_3          NUMBER(14,3);
   P_YTD_BAL_4          NUMBER(14,3);
   P_YR_OPEN_BAL_4      NUMBER(14,3);
   P_ANN_BUD_4          NUMBER(14,3);
   P_YTD_BAL_5          NUMBER(14,3);
   P_YR_OPEN_BAL_5      NUMBER(14,3);
   P_ANN_BUD_5          NUMBER(14,3);
   T_LVL_CODE           VARCHAR2(6);
   T_LVL_NAME           VARCHAR2(50);
   T_LVL_TYPE           VARCHAR2(1);
   T_LVL_SEQ            NUMBER(6);
   T_PARENT_LVL_CODE    VARCHAR2(6);
   T_MAIN_ACNT_CODE     VARCHAR2(6);
   T_TOTAL_FLAG         VARCHAR2(1);
   T_LVL_STR            VARCHAR2(27);
   T_YTD_BAL_1          NUMBER(14,3);
   T_YR_OPEN_BAL_1      NUMBER(14,3);
   T_ANN_BUD_1          NUMBER(14,3);
   T_YTD_BAL_2          NUMBER(14,3);
   T_YR_OPEN_BAL_2      NUMBER(14,3);
   T_ANN_BUD_2          NUMBER(14,3);
   T_YTD_BAL_3          NUMBER(14,3);
   T_YR_OPEN_BAL_3      NUMBER(14,3);
   T_ANN_BUD_3          NUMBER(14,3);
   T_YTD_BAL_4          NUMBER(14,3);
   T_YR_OPEN_BAL_4      NUMBER(14,3);
   T_ANN_BUD_4          NUMBER(14,3);
   T_YTD_BAL_5          NUMBER(14,3);
   T_YR_OPEN_BAL_5      NUMBER(14,3);
   T_ANN_BUD_5          NUMBER(14,3);
   TEMP_LVL_CODE           VARCHAR2(6);
   TEMP_LVL_NAME           VARCHAR2(50);
   TEMP_LVL_TYPE           VARCHAR2(1);
   TEMP_LVL_SEQ            NUMBER(6);
   TEMP_PARENT_LVL_CODE    VARCHAR2(6);
   TEMP_MAIN_ACNT_CODE     VARCHAR2(6);
   TEMP_TOTAL_FLAG         VARCHAR2(1);
   TEMP_LVL_STR            VARCHAR2(27);
   TEMP_YTD_BAL_1          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_1      NUMBER(14,3);
   TEMP_ANN_BUD_1          NUMBER(14,3);
   TEMP_YTD_BAL_2          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_2      NUMBER(14,3);
   TEMP_ANN_BUD_2          NUMBER(14,3);
   TEMP_YTD_BAL_3          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_3      NUMBER(14,3);
   TEMP_ANN_BUD_3          NUMBER(14,3);
   TEMP_YTD_BAL_4          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_4      NUMBER(14,3);
   TEMP_ANN_BUD_4          NUMBER(14,3);
   TEMP_YTD_BAL_5          NUMBER(14,3);
   TEMP_YR_OPEN_BAL_5      NUMBER(14,3);
   TEMP_ANN_BUD_5          NUMBER(14,3);
   CURSOR C1 IS
          SELECT MYS_LVL_CODE, MYS_LVL_NAME, MYS_LVL_TYPE,
                 MYS_PARENT_LVL_CODE,
                 DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0'),
                 LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MYS_YTD_BAL_1),
                 SUM(MYS_YR_OPEN_BAL_1),
                 SUM(MYS_ANN_BUD_1),
                 SUM(MYS_YTD_BAL_2),
                 SUM(MYS_YR_OPEN_BAL_2),
                 SUM(MYS_ANN_BUD_2),
                 SUM(MYS_YTD_BAL_3),
                 SUM(MYS_YR_OPEN_BAL_3),
                 SUM(MYS_ANN_BUD_3),
                 SUM(MYS_YTD_BAL_4),
                 SUM(MYS_YR_OPEN_BAL_4),
                 SUM(MYS_ANN_BUD_4),
                 SUM(MYS_YTD_BAL_5),
                 SUM(MYS_YR_OPEN_BAL_5),
                 SUM(MYS_ANN_BUD_5)
          FROM   FW_LEVEL, FM_COA_LEVEL, FW_MAIN_YEAR_SUM
          WHERE  MYS_KEY_NO = P_KEY_NO
          AND    MYS_FORMAT_ID = P_FORMAT_ID
          AND    LVL_FORMAT_ID = MYS_FORMAT_ID
          AND    LVL_CODE = MYS_LVL_CODE
          AND    LS_FORMAT_ID = LVL_FORMAT_ID
          AND    LS_LVL_CODE = LVL_CODE
          GROUP BY MYS_LVL_CODE, MYS_LVL_NAME, MYS_LVL_TYPE,
                   MYS_PARENT_LVL_CODE,
                   DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0'),
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N')
          ORDER  BY LS_LVL_SEQ,
                   DECODE(P_INCL_ACNT, 'Y', MYS_MAIN_ACNT_CODE, '0');
   CURSOR C2 IS
          SELECT MYS_LVL_CODE, '   TOTAL ' || MYS_LVL_NAME, MYS_LVL_TYPE,
                 MYS_PARENT_LVL_CODE,
                 NVL(LVL_TOTAL_FLAG, 'N'),
                 SUM(MYS_YTD_BAL_1),
                 SUM(MYS_YR_OPEN_BAL_1),
                 SUM(MYS_ANN_BUD_1),
                 SUM(MYS_YTD_BAL_2),
                 SUM(MYS_YR_OPEN_BAL_2),
                 SUM(MYS_ANN_BUD_2),
                 SUM(MYS_YTD_BAL_3),
                 SUM(MYS_YR_OPEN_BAL_3),
                 SUM(MYS_ANN_BUD_3),
                 SUM(MYS_YTD_BAL_4),
                 SUM(MYS_YR_OPEN_BAL_4),
                 SUM(MYS_ANN_BUD_4),
                 SUM(MYS_YTD_BAL_5),
                 SUM(MYS_YR_OPEN_BAL_5),
                 SUM(MYS_ANN_BUD_5)
          FROM   FM_COA_LEVEL, FW_MAIN_YEAR_SUM, FW_LEVEL
          WHERE  LS_FORMAT_ID = P_FORMAT_ID
          AND    LS_LVL_SEQ = PREV_STR
          AND    MYS_KEY_NO = P_KEY_NO
          AND    MYS_FORMAT_ID = LS_FORMAT_ID
          AND    MYS_LVL_CODE = LS_LVL_CODE
          AND    LVL_FORMAT_ID = MYS_FORMAT_ID
          AND    LVL_CODE = MYS_LVL_CODE
          GROUP BY MYS_LVL_CODE, '   TOTAL ' || MYS_LVL_NAME, MYS_LVL_TYPE,
                   MYS_PARENT_LVL_CODE,
                   LS_LVL_SEQ, NVL(LVL_TOTAL_FLAG, 'N');
  PROCEDURE INSERT_BLANK_REC IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     LVL_TYPE := T_LVL_TYPE;
     INSERT INTO FW_MAIN_YEAR_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_SEQ, MYS_LVL_TYPE)
     VALUES (P_KEY_NO, P_FORMAT_ID, RECORD_SEQ, LVL_TYPE);
  END;
  PROCEDURE INSERT_HEAD IS
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     INSERT INTO FW_MAIN_YEAR_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
            MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
            MYS_PARENT_LVL_CODE)
     VALUES (P_KEY_NO, P_FORMAT_ID, T_LVL_CODE,
             T_LVL_NAME, T_LVL_TYPE, RECORD_SEQ,
             T_PARENT_LVL_CODE);
     INSERT_BLANK_REC;
  END;
  PROCEDURE INSERT_REC IS
     CURSOR C3 IS
       SELECT MAIN_ACNT_NAME
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = T_MAIN_ACNT_CODE;
     C3_LVL_NAME	VARCHAR2(30);
     M_DIFF             NUMBER(2);
  BEGIN
     RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
     IF NVL(T_MAIN_ACNT_CODE, '0') != '0' THEN
        IF C3%ISOPEN THEN
           CLOSE C3;
        END IF;
        OPEN C3;
        FETCH C3 INTO C3_LVL_NAME;
        IF C3%FOUND THEN
             M_DIFF := LENGTH(T_LVL_NAME) - LENGTH(LTRIM(T_LVL_NAME));
             T_LVL_NAME := LPAD(C3_LVL_NAME, LENGTH(C3_LVL_NAME) + M_DIFF);
        END IF;
        CLOSE C3;
     END IF;
     INSERT INTO FW_MAIN_YEAR_SUM_REP
            (MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
            MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
            MYS_PARENT_LVL_CODE, MYS_MAIN_ACNT_CODE,
            MYS_YTD_BAL_1, MYS_YR_OPEN_BAL_1, MYS_ANN_BUD_1,
            MYS_YTD_BAL_2, MYS_YR_OPEN_BAL_2, MYS_ANN_BUD_2,
            MYS_YTD_BAL_3, MYS_YR_OPEN_BAL_3, MYS_ANN_BUD_3,
            MYS_YTD_BAL_4, MYS_YR_OPEN_BAL_4, MYS_ANN_BUD_4,
            MYS_YTD_BAL_5, MYS_YR_OPEN_BAL_5, MYS_ANN_BUD_5)
     VALUES (P_KEY_NO, P_FORMAT_ID,
            T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
            RECORD_SEQ, T_PARENT_LVL_CODE,
            T_MAIN_ACNT_CODE,
            T_YTD_BAL_1, T_YR_OPEN_BAL_1, T_ANN_BUD_1,
            T_YTD_BAL_2, T_YR_OPEN_BAL_2, T_ANN_BUD_2,
            T_YTD_BAL_3, T_YR_OPEN_BAL_3, T_ANN_BUD_3,
            T_YTD_BAL_4, T_YR_OPEN_BAL_4, T_ANN_BUD_4,
            T_YTD_BAL_5, T_YR_OPEN_BAL_5, T_ANN_BUD_5);
  END;
  PROCEDURE PROCESS_TOTAL IS
  BEGIN
    IF C2%ISOPEN THEN
       CLOSE C2;
    END IF;
    OPEN C2;
    FETCH C2 INTO P_LVL_CODE, P_LVL_NAME, P_LVL_TYPE,
                  P_PARENT_LVL_CODE,
                  P_TOTAL_FLAG,
                  P_YTD_BAL_1, P_YR_OPEN_BAL_1, P_ANN_BUD_1,
                  P_YTD_BAL_2, P_YR_OPEN_BAL_2, P_ANN_BUD_2,
                  P_YTD_BAL_3, P_YR_OPEN_BAL_3, P_ANN_BUD_3,
                  P_YTD_BAL_4, P_YR_OPEN_BAL_4, P_ANN_BUD_4,
                  P_YTD_BAL_5, P_YR_OPEN_BAL_5, P_ANN_BUD_5;
    IF C2%FOUND AND P_TOTAL_FLAG = 'Y' THEN
       RECORD_SEQ := NVL(RECORD_SEQ,0) + 1;
       INSERT INTO FW_MAIN_YEAR_SUM_REP (
              MYS_KEY_NO, MYS_FORMAT_ID, MYS_LVL_CODE,
              MYS_LVL_NAME, MYS_LVL_TYPE, MYS_LVL_SEQ,
              MYS_PARENT_LVL_CODE,
              MYS_YTD_BAL_1, MYS_YR_OPEN_BAL_1, MYS_ANN_BUD_1,
              MYS_YTD_BAL_2, MYS_YR_OPEN_BAL_2, MYS_ANN_BUD_2,
              MYS_YTD_BAL_3, MYS_YR_OPEN_BAL_3, MYS_ANN_BUD_3,
              MYS_YTD_BAL_4, MYS_YR_OPEN_BAL_4, MYS_ANN_BUD_4,
              MYS_YTD_BAL_5, MYS_YR_OPEN_BAL_5, MYS_ANN_BUD_5)
       VALUES (P_KEY_NO, P_FORMAT_ID, P_LVL_CODE,
              P_LVL_NAME, P_LVL_TYPE, RECORD_SEQ,
              P_PARENT_LVL_CODE,
              P_YTD_BAL_1, P_YR_OPEN_BAL_1, P_ANN_BUD_1,
              P_YTD_BAL_2, P_YR_OPEN_BAL_2, P_ANN_BUD_2,
              P_YTD_BAL_3, P_YR_OPEN_BAL_3, P_ANN_BUD_3,
              P_YTD_BAL_4, P_YR_OPEN_BAL_4, P_ANN_BUD_4,
              P_YTD_BAL_5, P_YR_OPEN_BAL_5, P_ANN_BUD_5);
       INSERT_BLANK_REC;
    END IF;
    CLOSE C2;
    HEAD_FLAG := 'N';
END;
BEGIN
   DELETE FROM FW_MAIN_YEAR_SUM_REP
          WHERE MYS_KEY_NO = P_KEY_NO;
   PREV_STR := '';
   RECORD_SEQ := 0;
   HEAD_FLAG := 'N';
   FIRST_REC := 0;
   BLANK_REC_FLAG := 'N';
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF;
   OPEN C1;
LOOP
   FETCH C1 INTO TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
                 TEMP_PARENT_LVL_CODE,
                 TEMP_MAIN_ACNT_CODE,
                 TEMP_LVL_STR, TEMP_TOTAL_FLAG,
                 TEMP_YTD_BAL_1, TEMP_YR_OPEN_BAL_1, TEMP_ANN_BUD_1,
                 TEMP_YTD_BAL_2, TEMP_YR_OPEN_BAL_2, TEMP_ANN_BUD_2,
                 TEMP_YTD_BAL_3, TEMP_YR_OPEN_BAL_3, TEMP_ANN_BUD_3,
                 TEMP_YTD_BAL_4, TEMP_YR_OPEN_BAL_4, TEMP_ANN_BUD_4,
                 TEMP_YTD_BAL_5, TEMP_YR_OPEN_BAL_5, TEMP_ANN_BUD_5;
    IF FIRST_REC = 0 THEN
       IF C1%NOTFOUND THEN
          EXIT;
       END IF;
       FIRST_REC := 1;
    ELSE
      IF C1%NOTFOUND THEN
         INSERT_REC;
         EXIT;
      END IF;
      IF LENGTH(T_LVL_STR) > LENGTH(TEMP_LVL_STR) THEN
         INSERT_REC;
         INSERT_BLANK_REC;
	 PROCESS_TOTAL;
         LOOP
            PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
            IF LENGTH(PREV_STR) >= LENGTH(TEMP_LVL_STR) THEN
	       PROCESS_TOTAL;
            ELSE
               EXIT;
            END IF;
         END LOOP;
         BLANK_REC_FLAG := 'N';
      ELSIF LENGTH(T_LVL_STR) < LENGTH(TEMP_LVL_STR) THEN
            PREV_STR := T_LVL_STR;
            IF T_TOTAL_FLAG = 'Y' THEN
               IF BLANK_REC_FLAG = 'D' THEN
                  INSERT_BLANK_REC;
                  BLANK_REC_FLAG := 'N';
               END IF;
               INSERT_HEAD;
            END IF;
      ELSE
        BLANK_REC_FLAG := 'D';
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           INSERT_REC;
           IF NVL(SUBSTR(T_LVL_STR, 1, LENGTH(T_LVL_STR) - 3), '1') !=
              NVL(SUBSTR(TEMP_LVL_STR, 1, LENGTH(TEMP_LVL_STR) - 3), '2') THEN
                INSERT_BLANK_REC;
                BLANK_REC_FLAG := 'N';
           END IF;
        END IF;
        IF NVL(P_INCL_ACNT, 'N') = 'N' THEN
           NULL;
        ELSIF T_LVL_STR != TEMP_LVL_STR THEN
              INSERT_REC;
              INSERT_BLANK_REC;
              IF HEAD_FLAG = 'T' THEN
                 PROCESS_TOTAL;
                 PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
              END IF;
        ELSIF T_LVL_STR = TEMP_LVL_STR THEN
              IF T_TOTAL_FLAG = 'Y' AND HEAD_FLAG = 'N' THEN
                 INSERT_HEAD;
                 PREV_STR := T_LVL_STR;
                 HEAD_FLAG := 'T';
              END IF;
              INSERT_REC;
        END IF;
      END IF;
   END IF;
      SELECT TEMP_LVL_CODE, TEMP_LVL_NAME, TEMP_LVL_TYPE,
             TEMP_LVL_SEQ, TEMP_PARENT_LVL_CODE,
             TEMP_MAIN_ACNT_CODE,
             TEMP_LVL_STR, TEMP_TOTAL_FLAG,
             TEMP_YTD_BAL_1, TEMP_YR_OPEN_BAL_1, TEMP_ANN_BUD_1,
             TEMP_YTD_BAL_2, TEMP_YR_OPEN_BAL_2, TEMP_ANN_BUD_2,
             TEMP_YTD_BAL_3, TEMP_YR_OPEN_BAL_3, TEMP_ANN_BUD_3,
             TEMP_YTD_BAL_4, TEMP_YR_OPEN_BAL_4, TEMP_ANN_BUD_4,
             TEMP_YTD_BAL_5, TEMP_YR_OPEN_BAL_5, TEMP_ANN_BUD_5
      INTO   T_LVL_CODE, T_LVL_NAME, T_LVL_TYPE,
             T_LVL_SEQ, T_PARENT_LVL_CODE,
             T_MAIN_ACNT_CODE,
             T_LVL_STR, T_TOTAL_FLAG,
             T_YTD_BAL_1, T_YR_OPEN_BAL_1, T_ANN_BUD_1,
             T_YTD_BAL_2, T_YR_OPEN_BAL_2, T_ANN_BUD_2,
             T_YTD_BAL_3, T_YR_OPEN_BAL_3, T_ANN_BUD_3,
             T_YTD_BAL_4, T_YR_OPEN_BAL_4, T_ANN_BUD_4,
             T_YTD_BAL_5, T_YR_OPEN_BAL_5, T_ANN_BUD_5
      FROM   DUAL;
END LOOP;
   CLOSE C1;
   INSERT_BLANK_REC;
   IF PREV_STR IS NOT NULL THEN
      PROCESS_TOTAL;
   END IF;
   LOOP
      PREV_STR := SUBSTR(PREV_STR, 1, LENGTH(PREV_STR)-3);
      IF LENGTH(PREV_STR) > 0 THEN
	 PROCESS_TOTAL;
      ELSE
         EXIT;
      END IF;
   END LOOP;
END;
CREATE OR REPLACE PROCEDURE F_OS
/
                 (P_OST_KEY_NO      OUT      NUMBER) AS
BEGIN
      SELECT SEQ_OST_KEY_NO.NEXTVAL
      INTO   P_OST_KEY_NO
      FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_PDC_OS (P_POS_KEY_NO OUT NUMBER) AS
BEGIN
       SELECT SEQ_POS_KEY_NO.NEXTVAL
       INTO   P_POS_KEY_NO
       FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_PROC_DETAIL
                  (P_PDS_KEY_NO      OUT      NUMBER) AS
BEGIN
      SELECT SEQ_PDS_KEY_NO.NEXTVAL
      INTO   P_PDS_KEY_NO
      FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_SUPP_DETAIL
                 (P_SDET_KEY_NO OUT NUMBER) AS
BEGIN
       SELECT SEQ_SDET_KEY_NO.NEXTVAL
       INTO   P_SDET_KEY_NO
       FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_UPD_ACNT_BAL
                 (P_COMP_CODE        IN      VARCHAR2,
                  P_ACNT_YEAR        IN      NUMBER,
                  P_MAIN_ACNT_CODE   IN      VARCHAR2,
                  P_SUB_ACNT_CODE    IN      VARCHAR2,
                  P_DIVN_CODE        IN      VARCHAR2,
                  P_DEPT_CODE        IN      VARCHAR2,
                  P_ANLY_CODE_1      IN      VARCHAR2,
                  P_ANLY_CODE_2      IN      VARCHAR2,
                  P_CAL_YEAR         IN      NUMBER,
                  P_CAL_MONTH        IN      NUMBER,
                  P_CURR_CODE        IN      VARCHAR2,
                  P_LC_AMT           IN      NUMBER,
                  P_FC_AMT           IN      NUMBER,
                  P_DOC_DRCR_FLAG    IN      VARCHAR2,
                  P_POST_FLAG        IN      VARCHAR2,
                  P_ADD_SUB_FLAG     IN      VARCHAR2,
                  P_UID              IN      VARCHAR2,
                  P_ERR_NO           OUT     NUMBER) AS
/* Details of Additional flags :-
   Post Flag            : To specify whether to update the Unposted
                          amount or Posted amount (U/P).
   Add / Sub            : To specify whether the amount supplied is
                          to be added or subtracted (A/S). Subtraction
                          will not be done if Amount currently present
                          is less than the Amount to be subtracted */
CURSOR F_PRV_ACNT_BAL IS
       SELECT ABAL_LC_MTD_DR, ABAL_LC_MTD_CR, ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
              ABAL_LC_UNP_DR, ABAL_LC_UNP_CR, ABAL_FC_UNP_DR, ABAL_FC_UNP_CR
       FROM   FS_PRV_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_SUB_ACNT_CODE,'0000000') =
              NVL(P_SUB_ACNT_CODE,'0000000')
       AND    NVL(ABAL_DIVN_CODE,'0000000') =
              NVL(P_DIVN_CODE,'0000000')
       AND    NVL(ABAL_DEPT_CODE,'0000000') =
              NVL(P_DEPT_CODE,'0000000')
       AND    NVL(ABAL_ANLY_CODE_1,'0000000') =
              NVL(P_ANLY_CODE_1,'0000000')
       AND    NVL(ABAL_ANLY_CODE_2,'0000000') =
              NVL(P_ANLY_CODE_2,'0000000')
       AND    ABAL_CAL_YEAR = P_CAL_YEAR
       AND    ABAL_CAL_MONTH = P_CAL_MONTH
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'0000') =
              NVL(P_CURR_CODE,'0000')
       FOR UPDATE OF ABAL_LC_MTD_DR, ABAL_LC_MTD_CR,
                     ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
                     ABAL_LC_UNP_DR, ABAL_LC_UNP_CR,
                     ABAL_FC_UNP_DR, ABAL_FC_UNP_CR;
CURSOR F_CUR_ACNT_BAL IS
       SELECT ABAL_LC_MTD_DR, ABAL_LC_MTD_CR, ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
              ABAL_LC_UNP_DR, ABAL_LC_UNP_CR, ABAL_FC_UNP_DR, ABAL_FC_UNP_CR
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_COMP_CODE = P_COMP_CODE
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    NVL(ABAL_SUB_ACNT_CODE,'0000000') =
              NVL(P_SUB_ACNT_CODE,'0000000')
       AND    NVL(ABAL_DIVN_CODE,'0000000') =
              NVL(P_DIVN_CODE,'0000000')
       AND    NVL(ABAL_DEPT_CODE,'0000000') =
              NVL(P_DEPT_CODE,'0000000')
       AND    NVL(ABAL_ANLY_CODE_1,'0000000') =
              NVL(P_ANLY_CODE_1,'0000000')
       AND    NVL(ABAL_ANLY_CODE_2,'0000000') =
              NVL(P_ANLY_CODE_2,'0000000')
       AND    ABAL_CAL_YEAR = P_CAL_YEAR
       AND    ABAL_CAL_MONTH = P_CAL_MONTH
       AND    ABAL_ACNT_YEAR = P_ACNT_YEAR
       AND    NVL(ABAL_CURR_CODE,'0000') =
              NVL(P_CURR_CODE,'0000')
       FOR UPDATE OF ABAL_LC_MTD_DR, ABAL_LC_MTD_CR,
                     ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
                     ABAL_LC_UNP_DR, ABAL_LC_UNP_CR,
                     ABAL_FC_UNP_DR, ABAL_FC_UNP_CR;
P_CUR_ACNT_YEAR  NUMBER(2);
P_LC_MTD_DR      NUMBER(14,3);
P_LC_MTD_CR      NUMBER(14,3);
P_FC_MTD_DR      NUMBER(14,3);
P_FC_MTD_CR      NUMBER(14,3);
P_LC_UNP_DR      NUMBER(14,3);
P_LC_UNP_CR      NUMBER(14,3);
P_FC_UNP_DR      NUMBER(14,3);
P_FC_UNP_CR      NUMBER(14,3);
P_TEMP_POST_FLAG     VARCHAR2(1);
P_TEMP_DOC_DRCR_FLAG VARCHAR2(1);
P_TEMP_ADD_SUB_FLAG  VARCHAR2(1);
P_TEMP_LC_AMT        NUMBER(14,3);
P_TEMP_FC_AMT        NUMBER(14,3);
Q_ACNT_YEAR        NUMBER(14,3);
Q_MAIN_ACNT_CODE   VARCHAR2(6);
Q_SUB_ACNT_CODE    VARCHAR2(6);
Q_CAL_YEAR         NUMBER(2);
Q_CAL_MONTH        NUMBER(2);
Q_ERR_NO           NUMBER(6);
BEGIN
   P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
   P_ERR_NO := 0;
   IF P_ACNT_YEAR IS NULL OR P_COMP_CODE IS NULL OR
      P_CAL_MONTH IS NULL OR P_CAL_YEAR IS NULL OR
      P_MAIN_ACNT_CODE IS NULL THEN
      RAISE_APPLICATION_ERROR(-20460,
            'Company or Main account or Year and month cannot be null') ;
   END IF;
   P_TEMP_ADD_SUB_FLAG := UPPER(P_ADD_SUB_FLAG);
   P_TEMP_POST_FLAG := UPPER(P_POST_FLAG);
   P_TEMP_DOC_DRCR_FLAG := UPPER(P_DOC_DRCR_FLAG);
   IF P_TEMP_ADD_SUB_FLAG NOT IN ('A','S') THEN
      RAISE_APPLICATION_ERROR(-20461,
            'Add / Subtract flag is not supplied') ;
   END IF;
   IF P_TEMP_POST_FLAG NOT IN ('P','U') THEN
      RAISE_APPLICATION_ERROR(-20462,
            'To update Posted / Unposted flag is not supplied') ;
   END IF;
   IF P_TEMP_DOC_DRCR_FLAG NOT IN ('D','C') THEN
      RAISE_APPLICATION_ERROR(-20463,
            'To debit / credit balances is not supplied') ;
   END IF;
   P_LC_MTD_DR := 0;
   P_FC_MTD_DR := 0;
   P_LC_MTD_CR := 0;
   P_LC_MTD_DR := 0;
   P_LC_UNP_DR := 0;
   P_FC_UNP_DR := 0;
   P_LC_UNP_CR := 0;
   P_LC_UNP_DR := 0;
   P_TEMP_LC_AMT := NVL(P_LC_AMT,0);
   P_TEMP_FC_AMT := NVL(P_FC_AMT,0);
   IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
        IF F_CUR_ACNT_BAL%ISOPEN THEN
             CLOSE F_CUR_ACNT_BAL;
        END IF;
        OPEN  F_CUR_ACNT_BAL;
        FETCH F_CUR_ACNT_BAL INTO P_LC_MTD_DR, P_LC_MTD_CR,
                                  P_FC_MTD_DR, P_FC_MTD_CR,
                                  P_LC_UNP_DR, P_LC_UNP_CR,
                                  P_FC_UNP_DR, P_FC_UNP_CR;
        IF F_CUR_ACNT_BAL%NOTFOUND THEN
             IF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                CLOSE F_CUR_ACNT_BAL;
                RAISE_APPLICATION_ERROR(-20467,
                      'Cannot subtract from non-existing balances') ;
             END IF;
             P_LC_MTD_DR := 0;
             P_FC_MTD_DR := 0;
             P_LC_MTD_CR := 0;
             P_LC_MTD_DR := 0;
             P_LC_UNP_DR := 0;
             P_FC_UNP_DR := 0;
             P_LC_UNP_CR := 0;
             P_LC_UNP_DR := 0;
        END IF;
   ELSE
        IF F_PRV_ACNT_BAL%ISOPEN THEN
             CLOSE F_PRV_ACNT_BAL;
        END IF;
        OPEN  F_PRV_ACNT_BAL;
        FETCH F_PRV_ACNT_BAL INTO P_LC_MTD_DR, P_LC_MTD_CR,
                                  P_FC_MTD_DR, P_FC_MTD_CR,
                                  P_LC_UNP_DR, P_LC_UNP_CR,
                                  P_FC_UNP_DR, P_FC_UNP_CR;
        IF F_PRV_ACNT_BAL%NOTFOUND THEN
             IF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                CLOSE F_PRV_ACNT_BAL;
                RAISE_APPLICATION_ERROR(-20467,
                      'Cannot subtract from non-existing balances') ;
             END IF;
             P_LC_MTD_DR := 0;
             P_FC_MTD_DR := 0;
             P_LC_MTD_CR := 0;
             P_LC_MTD_DR := 0;
             P_LC_UNP_DR := 0;
             P_FC_UNP_DR := 0;
             P_LC_UNP_CR := 0;
             P_LC_UNP_DR := 0;
        END IF;
   END IF;
   IF P_TEMP_POST_FLAG = 'P' THEN
        IF P_TEMP_DOC_DRCR_FLAG = 'C' THEN
           IF P_TEMP_ADD_SUB_FLAG = 'A' THEN
                 P_FC_MTD_CR  := NVL(P_FC_MTD_CR,0)  + NVL(P_TEMP_FC_AMT,0);
                 P_LC_MTD_CR  := NVL(P_LC_MTD_CR,0)  + NVL(P_TEMP_LC_AMT,0);
           ELSIF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                 P_FC_MTD_CR  := NVL(P_FC_MTD_CR,0)  - NVL(P_TEMP_FC_AMT,0);
                 P_LC_MTD_CR  := NVL(P_LC_MTD_CR,0)  - NVL(P_TEMP_LC_AMT,0);
                 IF (NVL(P_FC_MTD_CR,0) < 0) OR
                    (NVL(P_LC_MTD_CR,0) < 0) THEN
                     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
                        CLOSE F_CUR_ACNT_BAL;
                     ELSE
                        CLOSE F_PRV_ACNT_BAL;
                     END IF;
                     RAISE_APPLICATION_ERROR(-20466,
                           'Amount cannot be negative after subtraction' ||
'1.   '   || to_char(p_fc_mtd_cr) || '   ' || to_Char(p_temp_fc_amt) ) ;
                 END IF;
           END IF;
        ELSIF P_TEMP_DOC_DRCR_FLAG = 'D' THEN
           IF P_TEMP_ADD_SUB_FLAG = 'A' THEN
                 P_FC_MTD_DR  := NVL(P_FC_MTD_DR,0)  + NVL(P_TEMP_FC_AMT,0);
                 P_LC_MTD_DR  := NVL(P_LC_MTD_DR,0)  + NVL(P_TEMP_LC_AMT,0);
           ELSIF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                 P_FC_MTD_DR  := NVL(P_FC_MTD_DR,0)  - NVL(P_TEMP_FC_AMT,0);
                 P_LC_MTD_DR  := NVL(P_LC_MTD_DR,0)  - NVL(P_TEMP_LC_AMT,0);
                 IF (P_FC_MTD_DR < 0) OR (P_LC_MTD_DR < 0) THEN
                     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
                        CLOSE F_CUR_ACNT_BAL;
                     ELSE
                        CLOSE F_PRV_ACNT_BAL;
                     END IF;
                     RAISE_APPLICATION_ERROR(-20466,
                           'Amount cannot be negative after subtraction' ||
'2.   '   || to_char(p_fc_mtd_dr) || '   ' || to_Char(p_temp_fc_amt) ) ;

                 END IF;
           END IF;
        END IF;
   ELSIF P_TEMP_POST_FLAG = 'U' THEN
        IF P_TEMP_DOC_DRCR_FLAG = 'C' THEN
           IF P_TEMP_ADD_SUB_FLAG = 'A' THEN
                 P_FC_UNP_CR  := NVL(P_FC_UNP_CR,0)  + NVL(P_TEMP_FC_AMT,0);
                 P_LC_UNP_CR  := NVL(P_LC_UNP_CR,0)  + NVL(P_TEMP_LC_AMT,0);
           ELSIF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                 P_FC_UNP_CR  := NVL(P_FC_UNP_CR,0)  - NVL(P_TEMP_FC_AMT,0);
                 P_LC_UNP_CR  := NVL(P_LC_UNP_CR,0)  - NVL(P_TEMP_LC_AMT,0);
                 IF (P_FC_UNP_CR < 0) OR (P_LC_UNP_CR < 0) THEN
                     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
                        CLOSE F_CUR_ACNT_BAL;
                     ELSE
                        CLOSE F_PRV_ACNT_BAL;
                     END IF;
                     RAISE_APPLICATION_ERROR(-20466,
                           'Amount cannot be negative after subtraction' ||
'3.   '   || to_char(p_fc_unp_cr) || '   ' || to_Char(p_temp_fc_amt) ) ;
                 END IF;
           END IF;
        ELSIF P_TEMP_DOC_DRCR_FLAG = 'D' THEN
           IF P_TEMP_ADD_SUB_FLAG = 'A' THEN
                 P_FC_UNP_DR  := NVL(P_FC_UNP_DR,0)  + NVL(P_TEMP_FC_AMT,0);
                 P_LC_UNP_DR  := NVL(P_LC_UNP_DR,0)  + NVL(P_TEMP_LC_AMT,0);
           ELSIF P_TEMP_ADD_SUB_FLAG = 'S' THEN
                 P_FC_UNP_DR  := NVL(P_FC_UNP_DR,0)  - NVL(P_TEMP_FC_AMT,0);
                 P_LC_UNP_DR  := NVL(P_LC_UNP_DR,0)  - NVL(P_TEMP_LC_AMT,0);
                 IF (P_FC_UNP_DR < 0) OR (P_LC_UNP_DR < 0) THEN
                     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
                        CLOSE F_CUR_ACNT_BAL;
                     ELSE
                        CLOSE F_PRV_ACNT_BAL;
                     END IF;
                     RAISE_APPLICATION_ERROR(-20466,
                           'Amount cannot be negative after subtraction'  ||
'1.   '   || to_char(p_fc_mtd_dr) || '   ' || to_Char(p_temp_fc_amt) ) ;
                 END IF;
           END IF;
        END IF;
   END IF;
   IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
        IF F_CUR_ACNT_BAL%NOTFOUND THEN
               INSERT INTO FS_CUR_ACNT_BAL
                      (ABAL_COMP_CODE, ABAL_ACNT_YEAR, ABAL_MAIN_ACNT_CODE,
                       ABAL_SUB_ACNT_CODE, ABAL_DIVN_CODE, ABAL_DEPT_CODE,
                       ABAL_ANLY_CODE_1, ABAL_ANLY_CODE_2, ABAL_CURR_CODE,
                       ABAL_CAL_YEAR, ABAL_CAL_MONTH,
                       ABAL_LC_UNP_DR, ABAL_LC_UNP_CR,
                       ABAL_FC_UNP_DR, ABAL_FC_UNP_CR, ABAL_LC_MTD_DR,
                       ABAL_LC_MTD_CR, ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
                       ABAL_CR_UID, ABAL_CR_DT)
               VALUES
                      (P_COMP_CODE, P_ACNT_YEAR, P_MAIN_ACNT_CODE,
                       P_SUB_ACNT_CODE, P_DIVN_CODE, P_DEPT_CODE,
                       P_ANLY_CODE_1, P_ANLY_CODE_2, P_CURR_CODE,
                       P_CAL_YEAR, P_CAL_MONTH,
                       P_LC_UNP_DR, P_LC_UNP_CR, P_FC_UNP_DR, P_FC_UNP_CR,
                       P_LC_MTD_DR, P_LC_MTD_CR, P_FC_MTD_DR, P_FC_MTD_CR,
                       P_UID, SYSDATE);
        ELSE
               UPDATE FS_CUR_ACNT_BAL
               SET    ABAL_LC_MTD_DR = P_LC_MTD_DR,
                      ABAL_LC_MTD_CR = P_LC_MTD_CR,
                      ABAL_FC_MTD_DR = P_FC_MTD_DR,
                      ABAL_FC_MTD_CR = P_FC_MTD_CR,
                      ABAL_LC_UNP_DR = P_LC_UNP_DR,
                      ABAL_LC_UNP_CR = P_LC_UNP_CR,
                      ABAL_FC_UNP_DR = P_FC_UNP_DR,
                      ABAL_FC_UNP_CR = P_FC_UNP_CR
               WHERE CURRENT OF F_CUR_ACNT_BAL;
        END IF;
        CLOSE F_CUR_ACNT_BAL;
     ELSE
        IF F_PRV_ACNT_BAL%NOTFOUND THEN
               INSERT INTO FS_PRV_ACNT_BAL
                      (ABAL_COMP_CODE, ABAL_ACNT_YEAR, ABAL_MAIN_ACNT_CODE,
                       ABAL_SUB_ACNT_CODE, ABAL_DIVN_CODE, ABAL_DEPT_CODE,
                       ABAL_ANLY_CODE_1, ABAL_ANLY_CODE_2, ABAL_CURR_CODE,
                       ABAL_CAL_YEAR, ABAL_CAL_MONTH,
                       ABAL_LC_UNP_DR, ABAL_LC_UNP_CR,
                       ABAL_FC_UNP_DR, ABAL_FC_UNP_CR, ABAL_LC_MTD_DR,
                       ABAL_LC_MTD_CR, ABAL_FC_MTD_DR, ABAL_FC_MTD_CR,
                       ABAL_CR_UID, ABAL_CR_DT)
               VALUES
                      (P_COMP_CODE, P_ACNT_YEAR, P_MAIN_ACNT_CODE,
                       P_SUB_ACNT_CODE, P_DIVN_CODE, P_DEPT_CODE,
                       P_ANLY_CODE_1, P_ANLY_CODE_2, P_CURR_CODE,
                       P_CAL_YEAR, P_CAL_MONTH,
                       P_LC_UNP_DR, P_LC_UNP_CR, P_FC_UNP_DR, P_FC_UNP_CR,
                       P_LC_MTD_DR, P_LC_MTD_CR, P_FC_MTD_DR, P_FC_MTD_CR,
                       P_UID, SYSDATE);
        ELSE
               UPDATE FS_PRV_ACNT_BAL
               SET    ABAL_LC_MTD_DR = P_LC_MTD_DR,
                      ABAL_LC_MTD_CR = P_LC_MTD_CR,
                      ABAL_FC_MTD_DR = P_FC_MTD_DR,
                      ABAL_FC_MTD_CR = P_FC_MTD_CR,
                      ABAL_LC_UNP_DR = P_LC_UNP_DR,
                      ABAL_LC_UNP_CR = P_LC_UNP_CR,
                      ABAL_FC_UNP_DR = P_FC_UNP_DR,
                      ABAL_FC_UNP_CR = P_FC_UNP_CR
               WHERE CURRENT OF F_PRV_ACNT_BAL;
        END IF;
        CLOSE F_PRV_ACNT_BAL;
     END IF;
     /*   Code for recursive posting of all years between date of document
          and  current accounting year
     */
     IF P_ACNT_YEAR != P_CUR_ACNT_YEAR THEN
        Q_ACNT_YEAR := P_ACNT_YEAR + 1;
        Q_MAIN_ACNT_CODE := P_MAIN_ACNT_CODE;
        Q_SUB_ACNT_CODE := P_SUB_ACNT_CODE;
        DECLARE
             CURSOR C1 IS
             SELECT MAIN_ACNT_TYPE
             FROM   FM_MAIN_ACCOUNT
             WHERE  MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
             CURSOR C2 IS
             SELECT CAY_MAIN_ACNT_CODE, CAY_SUB_ACNT_CODE
             FROM   FM_COMP_ACNT_YEAR
             WHERE  CAY_COMP_CODE = P_COMP_CODE
             AND    CAY_ACNT_YEAR = P_ACNT_YEAR;
             CURSOR C3 IS
             SELECT MIN(APER_CAL_YEAR)
             FROM   FM_ACNT_PERIOD
             WHERE  APER_COMP_CODE = P_COMP_CODE
             AND    APER_ACNT_YEAR = Q_ACNT_YEAR;
             P_ACNT_TYPE      VARCHAR2(1);
             Q_ACNT_TYPE      VARCHAR2(1);
        BEGIN
             IF C1%ISOPEN THEN
                CLOSE C1;
             END IF;
             OPEN C1;
             FETCH C1 INTO P_ACNT_TYPE;
             IF C1%NOTFOUND THEN
                CLOSE C1;
                RAISE_APPLICATION_ERROR(-20464,
                       'Invalid main account code') ;
             ELSE
                FETCH C1 INTO Q_ACNT_TYPE;
                IF C1%FOUND THEN
                   CLOSE C1;
                   RAISE_APPLICATION_ERROR(-20464,
                          'Invalid main account code') ;
                END IF;
             END IF;
             CLOSE C1;
             IF P_ACNT_TYPE IN ('I','E') THEN
                IF C2%ISOPEN THEN
                   CLOSE C2;
                END IF;
                OPEN C2;
                FETCH C2 INTO Q_MAIN_ACNT_CODE, Q_SUB_ACNT_CODE;
                IF C2%NOTFOUND OR
                   Q_MAIN_ACNT_CODE IS NULL THEN
                   CLOSE C2;
                   RAISE_APPLICATION_ERROR(-20464,
                          'Invalid main account code') ;
                ELSE
                   FETCH C2 INTO Q_MAIN_ACNT_CODE, Q_SUB_ACNT_CODE;
                   IF C2%FOUND THEN
                      CLOSE C2;
                      RAISE_APPLICATION_ERROR(-20464,
                             'Invalid main account code') ;
                   END IF;
                END IF;
                CLOSE C2;
              END IF;
              IF C3%ISOPEN THEN
                 CLOSE C3;
              END IF;
              OPEN C3;
              FETCH C3 INTO Q_CAL_YEAR;
              IF C3%NOTFOUND THEN
                 CLOSE C3;
                 RAISE_APPLICATION_ERROR(-20465,
                        'Accounting period not set-up for this company') ;
              END IF;
              CLOSE C3;
              Q_CAL_MONTH := 0;
        END;
        F_UPD_ACNT_BAL(P_COMP_CODE, Q_ACNT_YEAR, Q_MAIN_ACNT_CODE,
                       Q_SUB_ACNT_CODE, P_DIVN_CODE, P_DEPT_CODE,
                       P_ANLY_CODE_1, P_ANLY_CODE_2, Q_CAL_YEAR,
                       Q_CAL_MONTH, P_CURR_CODE, P_LC_AMT, P_FC_AMT,
                       P_DOC_DRCR_FLAG, P_POST_FLAG, P_ADD_SUB_FLAG,
                       P_UID, Q_ERR_NO);
        IF Q_ERR_NO != 0 THEN
           RETURN;
        END IF;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_UPD_COMP_ACNT_PERIOD
                  (P_COMP_CODE      IN      VARCHAR2,
                   P_UID            IN      VARCHAR2) AS
CURSOR FC_UPD_ACNT_PERIOD IS
       SELECT  APER_COMP_CODE, APER_ACNT_YEAR
       FROM    FM_ACNT_PERIOD
       ORDER BY APER_ACNT_YEAR DESC;
P_APER_COMP_CODE      VARCHAR2(3);
P_APER_ACNT_YEAR      NUMBER(2);
Press <Enter> to continue...
BEGIN
IF FC_UPD_ACNT_PERIOD%ISOPEN THEN
     CLOSE FC_UPD_ACNT_PERIOD;
END IF;
OPEN FC_UPD_ACNT_PERIOD;
FETCH FC_UPD_ACNT_PERIOD INTO P_APER_COMP_CODE, P_APER_ACNT_YEAR;
IF FC_UPD_ACNT_PERIOD%FOUND THEN
   INSERT INTO FM_ACNT_PERIOD
          SELECT P_COMP_CODE, APER_ACNT_YEAR, APER_CAL_YEAR,
                 APER_CAL_MONTH, APER_FRM_DT, APER_TO_DT, APER_QTLY,
                 '','',P_UID, SYSDATE
          FROM   FM_ACNT_PERIOD
          WHERE  APER_COMP_CODE = P_APER_COMP_CODE
          AND    APER_ACNT_YEAR = P_APER_ACNT_YEAR;
END IF;
CLOSE FC_UPD_ACNT_PERIOD;
END;
/
CREATE OR REPLACE PROCEDURE F_UPD_DOC_DT_CHANGE
                     (P_TH_COMP_CODE     IN        VARCHAR2,
                      P_TH_TRAN_CODE     IN        VARCHAR2,
                      P_TH_DOC_NO        IN        NUMBER,
                      P_TH_ACNT_YEAR     IN        NUMBER,
                      P_OLD_TH_DOC_DT    IN        DATE,
                      P_OLD_TH_DUE_DT    IN        DATE,
                      P_NEW_TH_DOC_DT    IN        DATE,
                      P_NEW_TH_DUE_DT    IN        DATE,
                      P_UID              IN        VARCHAR2,
                      P_ERR_NO           IN OUT    NUMBER) AS
P_OLD_ACNT_YEAR                      NUMBER(2);
P_OLD_CAL_YEAR                       NUMBER(2);
P_OLD_CAL_MONTH                      NUMBER(2);
P_NEW_ACNT_YEAR                      NUMBER(2);
P_NEW_CAL_YEAR                       NUMBER(2);
P_NEW_CAL_MONTH                      NUMBER(2);
P_CUR_ACNT_YEAR                      NUMBER(2);
P_TD_COMP_CODE                       VARCHAR2(3);
P_TD_SEQ_NO                          NUMBER(3);
P_TD_MAIN_ACNT_CODE                  VARCHAR2(6);
P_TD_SUB_ACNT_CODE                   VARCHAR2(6);
P_TD_DIVN_CODE                       VARCHAR2(6);
P_TD_DEPT_CODE                       VARCHAR2(6);
P_TD_ANLY_CODE_1                     VARCHAR2(6);
P_TD_ANLY_CODE_2                     VARCHAR2(6);
P_TD_CURR_CODE                       VARCHAR2(3);
P_TD_DOC_AMT                         NUMBER(13,2);
P_TD_DOC_DRCR_FLAG                   VARCHAR2(1);
P_TD_FC_AMT                          NUMBER(13,2);
P_TD_DOC_DUE_DT                      DATE;
P_OPEN_ENTRY_FLAG                    VARCHAR2(1);
P_NEW_DUE_DT                         DATE;
CURSOR SEL_TD IS
       SELECT TD_COMP_CODE, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
              TD_DIVN_CODE, TD_DEPT_CODE, TD_ANLY_CODE_1, TD_ANLY_CODE_2,
              TD_CURR_CODE, TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_FC_AMT,
              TD_DOC_DUE_DT
       FROM   FT_UNPOSTED_TRANS_DETAIL
       WHERE  (TD_COMP_CODE = P_TH_COMP_CODE)
       AND    (TD_ACNT_YEAR = P_TH_ACNT_YEAR)
       AND    (TD_TRAN_CODE = P_TH_TRAN_CODE)
       AND    (TD_DOC_NO    = P_TH_DOC_NO)
       FOR UPDATE OF TD_ACNT_YEAR, TD_DOC_DUE_DT, TD_CR_UID, TD_CR_DT;
CURSOR SEL_MAIN IS
       SELECT MAIN_OPEN_ENTRY_FLAG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = P_TD_MAIN_ACNT_CODE;
BEGIN
P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_TH_COMP_CODE);
P_ERR_NO := 0;
F_VAL_OPCL(P_TH_COMP_CODE, P_OLD_TH_DOC_DT, P_ERR_NO,
           P_OLD_CAL_YEAR, P_OLD_CAL_MONTH, P_OLD_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20000 - P_ERR_NO, '');
END IF;
F_VAL_OPCL(P_TH_COMP_CODE, P_NEW_TH_DOC_DT, P_ERR_NO,
           P_NEW_CAL_YEAR, P_NEW_CAL_MONTH, P_NEW_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20000 - P_ERR_NO, '');
END IF;
IF (P_OLD_TH_DOC_DT != P_NEW_TH_DOC_DT) OR
   (P_OLD_TH_DUE_DT != P_NEW_TH_DUE_DT) THEN
   IF SEL_TD%ISOPEN THEN
        CLOSE SEL_TD;
   END IF;
   OPEN SEL_TD;
   <<UPDATE_TRAN>>
   LOOP
        FETCH SEL_TD INTO
              P_TD_COMP_CODE, P_TD_SEQ_NO, P_TD_MAIN_ACNT_CODE,
              P_TD_SUB_ACNT_CODE, P_TD_DIVN_CODE, P_TD_DEPT_CODE,
              P_TD_ANLY_CODE_1, P_TD_ANLY_CODE_2, P_TD_CURR_CODE,
              P_TD_DOC_AMT, P_TD_DOC_DRCR_FLAG, P_TD_FC_AMT,
              P_TD_DOC_DUE_DT;
   EXIT WHEN SEL_TD%NOTFOUND;
        IF (P_NEW_CAL_MONTH != P_OLD_CAL_MONTH) OR
           (P_NEW_CAL_YEAR  != P_OLD_CAL_YEAR)  THEN
            F_UPD_ACNT_BAL (P_TD_COMP_CODE, P_OLD_ACNT_YEAR,
                      P_TD_MAIN_ACNT_CODE, P_TD_SUB_ACNT_CODE,
                      P_TD_DIVN_CODE, P_TD_DEPT_CODE,
                      P_TD_ANLY_CODE_1, P_TD_ANLY_CODE_2,
                      P_OLD_CAL_YEAR, P_OLD_CAL_MONTH,
                      P_TD_CURR_CODE, P_TD_DOC_AMT, P_TD_FC_AMT,
                      P_TD_DOC_DRCR_FLAG, 'U', 'S', P_UID, P_ERR_NO);
            IF P_ERR_NO != 0 THEN
                   RETURN;
            END IF;
            F_UPD_ACNT_BAL (P_TD_COMP_CODE, P_NEW_ACNT_YEAR,
                      P_TD_MAIN_ACNT_CODE, P_TD_SUB_ACNT_CODE,
                      P_TD_DIVN_CODE, P_TD_DEPT_CODE,
                      P_TD_ANLY_CODE_1, P_TD_ANLY_CODE_2,
                      P_NEW_CAL_YEAR, P_NEW_CAL_MONTH,
                      P_TD_CURR_CODE, P_TD_DOC_AMT, P_TD_FC_AMT,
                      P_TD_DOC_DRCR_FLAG, 'U', 'A', P_UID, P_ERR_NO);
            IF P_ERR_NO != 0 THEN
                   RETURN;
            END IF;
        END IF;
        IF P_TD_DOC_DUE_DT IS NULL THEN
             P_NEW_DUE_DT := NULL;
        ELSE
             IF P_TD_DOC_DUE_DT = P_OLD_TH_DUE_DT THEN
                P_NEW_DUE_DT := P_NEW_TH_DUE_DT;
             ELSE
                IF P_TD_DOC_DUE_DT > P_NEW_TH_DOC_DT THEN
                   P_NEW_DUE_DT := P_TD_DOC_DUE_DT;
                ELSE
                   P_NEW_DUE_DT := P_NEW_TH_DOC_DT +
                                   (P_TD_DOC_DUE_DT - P_OLD_TH_DOC_DT);
                END IF;
             END IF;
        END IF;
        IF P_NEW_ACNT_YEAR != P_OLD_ACNT_YEAR THEN
           /* Change in Accounting years */
           UPDATE FT_UNPOSTED_TRANS_DETAIL
           SET    TD_ACNT_YEAR = P_NEW_ACNT_YEAR,
                  TD_DOC_DUE_DT = P_NEW_DUE_DT,
                  TD_CR_UID     = P_UID,
                  TD_CR_DT      = SYSDATE
           WHERE  CURRENT OF SEL_TD;
        ELSE
             IF P_TD_DOC_DUE_DT IS NOT NULL THEN
                  IF P_TD_DOC_DUE_DT != P_NEW_DUE_DT THEN
                     UPDATE FT_UNPOSTED_TRANS_DETAIL
                     SET    TD_DOC_DUE_DT = P_NEW_DUE_DT,
                            TD_CR_UID     = P_UID,
                            TD_CR_DT      = SYSDATE
                     WHERE  CURRENT OF SEL_TD;
                  END IF;
             END IF;
        END IF;
        IF SEL_MAIN%ISOPEN THEN
             CLOSE SEL_MAIN;
        END IF;
        OPEN SEL_MAIN;
        FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG;
        IF SEL_MAIN%FOUND THEN
             IF P_OPEN_ENTRY_FLAG = 'Y' THEN
                UPDATE FT_UNPOSTED_OS
                SET    OST_ACNT_YEAR = P_NEW_ACNT_YEAR,
                       OST_DOC_DT    = P_NEW_TH_DOC_DT,
                       OST_DUE_DT    = P_NEW_DUE_DT,
                       OST_CR_UID    = P_UID,
                       OST_CR_DT     = SYSDATE
                WHERE  OST_COMP_CODE = P_TH_COMP_CODE
                AND    OST_TRAN_CODE = P_TH_TRAN_CODE
                AND    OST_DOC_NO    = P_TH_DOC_NO
                AND    OST_SEQ_NO    = P_TD_SEQ_NO
                AND    OST_ACNT_YEAR = P_TH_ACNT_YEAR;
             END IF;
        END IF;
        CLOSE SEL_MAIN;
   END LOOP UPDATE_TRAN;
   CLOSE SEL_TD;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_UPD_SUB_NAME
                 (P_SUB_ACNT_CODE    IN      VARCHAR2 ,
                  P_SUB_ACNT_NAME    IN      VARCHAR2 ,
                  P_SUB_ACNT_SHORT_NAME IN   VARCHAR2 ,
                  P_ERR_NO           OUT     NUMBER) AS
CURSOR MAIN_SUB IS
SELECT MS_SUB_ACNT_NAME , MS_SUB_ACNT_SHORT_NAME
FROM   FM_MAIN_SUB
WHERE  MS_SUB_ACNT_CODE = P_SUB_ACNT_CODE
AND    MS_MAIN_ACNT_CODE IS NOT NULL
FOR UPDATE OF MS_SUB_ACNT_NAME , MS_SUB_ACNT_SHORT_NAME ;
P_TEMP_SUB_NAME         VARCHAR2(30) ;
P_TEMP_SUB_SHORT_NAME   VARCHAR2(30) ;
BEGIN
        IF MAIN_SUB%ISOPEN THEN
             CLOSE MAIN_SUB;
        END IF;
        OPEN MAIN_SUB ;
        LOOP
        FETCH MAIN_SUB INTO P_TEMP_SUB_NAME , P_TEMP_SUB_SHORT_NAME ;
        IF MAIN_SUB%NOTFOUND THEN
           EXIT;
        END IF ;
        UPDATE FM_MAIN_SUB
        SET MS_SUB_ACNT_NAME = P_SUB_ACNT_NAME ,
        MS_SUB_ACNT_SHORT_NAME = P_SUB_ACNT_SHORT_NAME
        WHERE CURRENT OF MAIN_SUB ;
        END LOOP ;
        CLOSE MAIN_SUB ;
END;
/
CREATE OR REPLACE PROCEDURE F_VALID_COMB
                 (P_VCM_SEQ_NO      OUT      NUMBER) AS
BEGIN
      SELECT SEQ_VCM_SEQ_NO.NEXTVAL
      INTO   P_VCM_SEQ_NO
      FROM   SYS.DUAL;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_ACNT_ANLY_COMBN
                 (P_HEAD_NO          IN      NUMBER,
                  P_MAIN_ACNT_CODE   IN      VARCHAR2,
                  P_SUB_ACNT_CODE    IN      VARCHAR2,
                  P_ERR              OUT     NUMBER) AS
CURSOR F_VAL_ACNT_1 IS
       SELECT PARA_VALUE
       FROM FP_PARAMETER
       WHERE PARA_ID = 'UNIQUE.ANLY.1';
CURSOR F_VAL_ACNT_2 IS
       SELECT PARA_VALUE
       FROM FP_PARAMETER
       WHERE PARA_ID = 'UNIQUE.ANLY.2';
P_PARA_VALUE VARCHAR2(1);
BEGIN
          P_ERR := 0;
          IF P_HEAD_NO = 1 THEN
             IF F_VAL_ACNT_1%ISOPEN THEN
                CLOSE F_VAL_ACNT_1;
             END IF;
             OPEN F_VAL_ACNT_1;
             FETCH F_VAL_ACNT_1 INTO P_PARA_VALUE;
             CLOSE F_VAL_ACNT_1;
          ELSIF P_HEAD_NO = 2 THEN
              IF F_VAL_ACNT_2%ISOPEN THEN
                   CLOSE F_VAL_ACNT_2;
              END IF;
              OPEN F_VAL_ACNT_2;
              FETCH F_VAL_ACNT_2 INTO P_PARA_VALUE;
              CLOSE F_VAL_ACNT_2;
          END IF;
          IF P_PARA_VALUE = 'Y' AND
             (P_MAIN_ACNT_CODE IS NOT NULL OR
              P_SUB_ACNT_CODE IS NOT NULL) THEN
                 P_ERR := 22;
          END IF;
          IF P_PARA_VALUE != 'Y' AND
             (P_MAIN_ACNT_CODE IS NULL OR
              P_SUB_ACNT_CODE IS NULL) THEN
                 P_ERR := 23;
          END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_ACNT_CURR_COMBN
                 (P_MAIN_ACNT_CODE     IN      VARCHAR2,
                  P_SUB_ACNT_CODE      IN      VARCHAR2,
                  P_ERR_NO             IN OUT  NUMBER) AS
BEGIN
      P_ERR_NO := 0;
      F_VAL_MAIN_IS_CTL_ACNT(P_MAIN_ACNT_CODE, P_ERR_NO);
      IF P_SUB_ACNT_CODE IS NULL  THEN
          /* Check for the Reverse i.e. Must be a Main Account */
          IF P_ERR_NO = 0 THEN
             RAISE_APPLICATION_ERROR(-20013,
                  'Sub account is mandatory') ;
          ELSE
             P_ERR_NO := 0;
          END IF;
      END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_ANLY_DETAIL_LEVEL
                 (P_HEAD_NO          IN      NUMBER,
                  P_FORMAT_ID        IN      NUMBER,
                  P_LEVEL_CODE       IN      NUMBER,
                  P_ERR_NO           OUT     NUMBER) AS
CURSOR F_VAL_ANLY_DETAIL_LEVEL IS
       SELECT 1
       FROM   FM_ANLY_LEVEL
       WHERE  ALM_PARENT_CODE = P_LEVEL_CODE
       AND    ALM_HEAD_NO = P_HEAD_NO
       AND    ALM_FORMAT_ID = P_FORMAT_ID;
P_LOCAL NUMBER(1);
BEGIN
     IF F_VAL_ANLY_DETAIL_LEVEL%ISOPEN THEN
           CLOSE F_VAL_ANLY_DETAIL_LEVEL;
     END IF;
     OPEN F_VAL_ANLY_DETAIL_LEVEL;
     FETCH F_VAL_ANLY_DETAIL_LEVEL INTO P_LOCAL;
     IF F_VAL_ANLY_DETAIL_LEVEL%FOUND THEN
        RAISE_APPLICATION_ERROR(-20015,
                  'Analysis account format already exists') ;
     END IF;
     CLOSE F_VAL_ANLY_DETAIL_LEVEL;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_ANLY_LEVEL
                 (P_ALM_FORMAT_ID     IN       NUMBER,
                  P_ALM_LVL_CODE      IN       NUMBER,
                  P_INDIC             IN       VARCHAR2,
                  P_NAME              OUT      VARCHAR2,
                  P_ERR_NO            OUT      NUMBER) AS
CURSOR F_ANLY_LEVEL IS
       SELECT ALM_LVL_NAME, ALM_FRZ_FLAG
       FROM   FM_ANLY_LEVEL
       WHERE  ALM_FORMAT_ID  = P_ALM_FORMAT_ID
       AND    ALM_LVL_CODE = P_ALM_LVL_CODE;
P_FULL_NAME       VARCHAR2(30);
P_SHORT_NAME      VARCHAR2(15);
P_FRZ_FLAG        VARCHAR2(1);
P_SER_NO          NUMBER(2);
BEGIN
      P_SER_NO := 11;
      IF F_ANLY_LEVEL%ISOPEN THEN
         CLOSE F_ANLY_LEVEL;
      END IF;
      OPEN F_ANLY_LEVEL;
      FETCH F_ANLY_LEVEL INTO P_FULL_NAME,P_FRZ_FLAG;
      IF F_ANLY_LEVEL%NOTFOUND THEN
         P_NAME := '';
         RAISE_APPLICATION_ERROR(-20011,
             'Analysis level code does not exist in Analysis level master') ;
      ELSE
         IF P_FRZ_FLAG = 'Y' THEN
            RAISE_APPLICATION_ERROR(-20011,
                 'Analysis level code is frozen') ;
         ELSE
            P_ERR_NO := 0;
         END IF;
      P_NAME := P_FULL_NAME;
      END IF;
      CLOSE F_ANLY_LEVEL;
      RETURN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_ANLY_PARENT_LEVEL
                 (P_HEAD_NO          IN      NUMBER,
                  P_FORMAT_ID        IN      NUMBER,
                  P_PARENT_CODE      IN      NUMBER,
                  P_ERR_NO           OUT     NUMBER) AS
CURSOR F_VAL_ANLY_PARENT_LEVEL IS
       SELECT 1
       FROM   FM_ACNT_ANLY_LEVEL
       WHERE  AAL_LVL_CODE = P_PARENT_CODE
       AND    AAL_HEAD_NO = P_HEAD_NO
       AND    AAL_FORMAT_ID = P_FORMAT_ID;
P_LOCAL NUMBER(1);
BEGIN
     IF F_VAL_ANLY_PARENT_LEVEL%ISOPEN THEN
           CLOSE F_VAL_ANLY_PARENT_LEVEL;
     END IF;
     OPEN F_VAL_ANLY_PARENT_LEVEL;
     FETCH F_VAL_ANLY_PARENT_LEVEL INTO P_LOCAL;
     IF F_VAL_ANLY_PARENT_LEVEL%FOUND THEN
        RAISE_APPLICATION_ERROR(-20011,
             'Analysis Account format already exists') ;
     END IF;
     CLOSE F_VAL_ANLY_PARENT_LEVEL;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_CHANGE_ACNT_TYPE
                 (P_MAIN_ACNT_CODE        IN       VARCHAR2,
                  P_ERR_NO                OUT      NUMBER)  AS
CURSOR F_VAL_CH_ACNT_TYPE IS
       SELECT 'X'
       FROM   FS_CUR_ACNT_BAL
       WHERE  ABAL_CAL_MONTH = 0
       AND    ABAL_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    (NVL(ABAL_LC_MTD_DR,0) != 0 OR
               NVL(ABAL_LC_MTD_CR,0) != 0);
P_OPEN_BAL_FLAG VARCHAR2(1);
BEGIN
       P_ERR_NO := 0;
       IF F_VAL_CH_ACNT_TYPE%ISOPEN THEN
           CLOSE F_VAL_CH_ACNT_TYPE;
       END IF;
       OPEN F_VAL_CH_ACNT_TYPE;
       FETCH F_VAL_CH_ACNT_TYPE INTO P_OPEN_BAL_FLAG;
       IF F_VAL_CH_ACNT_TYPE%FOUND THEN
         RAISE_APPLICATION_ERROR(-20003,
         'This account has opening balance, Cannot be Income/Expense account') ;
       END IF;
       CLOSE F_VAL_CH_ACNT_TYPE;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_CHANGE_MC_FLAG
                 (P_MAIN_ACNT_CODE      IN      VARCHAR2,
                  P_ERR_NO              OUT     NUMBER) AS
CURSOR F_VAL_CHANGE_MC_FLAG1 IS
       SELECT 1
       FROM   FM_MAIN_SUB
       WHERE  MS_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
CURSOR F_VAL_CHANGE_MC_FLAG2 IS
       SELECT 1
       FROM   FM_ACNT_CURR
       WHERE  ACURR_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
P_FOUND1    NUMBER;
P_SET       NUMBER;
BEGIN
       P_ERR_NO := 0;
       IF F_VAL_CHANGE_MC_FLAG1%ISOPEN THEN
           CLOSE F_VAL_CHANGE_MC_FLAG1;
       END IF;
       OPEN F_VAL_CHANGE_MC_FLAG1;
       FETCH F_VAL_CHANGE_MC_FLAG1 INTO P_FOUND1;
       IF F_VAL_CHANGE_MC_FLAG1%FOUND THEN
          RAISE_APPLICATION_ERROR(-20004,
             'Sub account exists, Cannot be made as main account') ;
          P_SET := 1;
       END IF;
       CLOSE F_VAL_CHANGE_MC_FLAG1;
       IF P_SET = 1 THEN
           RETURN;
       END IF;
       P_SET := 0;
       IF F_VAL_CHANGE_MC_FLAG2%ISOPEN  THEN
           CLOSE F_VAL_CHANGE_MC_FLAG2;
       END IF;
       OPEN F_VAL_CHANGE_MC_FLAG2;
       FETCH F_VAL_CHANGE_MC_FLAG2 INTO P_FOUND1;
       IF F_VAL_CHANGE_MC_FLAG2%FOUND THEN
          RAISE_APPLICATION_ERROR(-20005,
             'Currency exists, Cannot be made as main account') ;
          P_SET := 1;
       END IF;
       CLOSE F_VAL_CHANGE_MC_FLAG2;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_CHANGE_OE_FLAG
                 (P_MAIN_ACNT_CODE      IN      VARCHAR2,
                  P_ERR_NO              OUT     NUMBER) AS
CURSOR F_VAL_CHANGE_OE_FLAG1 IS
       SELECT 1
       FROM   FT_UNPOSTED_TRANS_DETAIL
       WHERE  TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
CURSOR F_VAL_CHANGE_OE_FLAG2 IS
       SELECT 1
       FROM   FT_CUR_TRANS_DETAIL
       WHERE  TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
CURSOR F_VAL_CHANGE_OE_FLAG3 IS
       SELECT 1
       FROM   FT_PRV_TRANS_DETAIL
       WHERE  TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE;
P_FOUND1    NUMBER;
P_SET       NUMBER;
BEGIN
       P_ERR_NO := 0;
       P_SET := 0;
       IF F_VAL_CHANGE_OE_FLAG1%ISOPEN THEN
           CLOSE F_VAL_CHANGE_OE_FLAG1;
       END IF;
       OPEN F_VAL_CHANGE_OE_FLAG1;
       FETCH F_VAL_CHANGE_OE_FLAG1 INTO P_FOUND1;
       IF F_VAL_CHANGE_OE_FLAG1%FOUND THEN
          RAISE_APPLICATION_ERROR(-20006,
             'Unposted balances exists') ;
           P_SET := 1;
       END IF;
       CLOSE F_VAL_CHANGE_OE_FLAG1;
       IF P_SET = 1 THEN
          RETURN;
       END IF;
       IF F_VAL_CHANGE_OE_FLAG2%ISOPEN THEN
           CLOSE F_VAL_CHANGE_OE_FLAG2;
       END IF;
       OPEN F_VAL_CHANGE_OE_FLAG2;
       FETCH F_VAL_CHANGE_OE_FLAG2 INTO P_FOUND1;
       IF F_VAL_CHANGE_OE_FLAG2%FOUND THEN
          RAISE_APPLICATION_ERROR(-20006,
             'Confirmed balances exists') ;
           P_SET := 1;
       END IF;
       CLOSE F_VAL_CHANGE_OE_FLAG2;
       IF P_SET = 1 THEN
          RETURN;
       END IF;
       IF F_VAL_CHANGE_OE_FLAG3%ISOPEN THEN
           CLOSE F_VAL_CHANGE_OE_FLAG3;
       END IF;
       OPEN F_VAL_CHANGE_OE_FLAG3;
       FETCH F_VAL_CHANGE_OE_FLAG3 INTO P_FOUND1;
       IF F_VAL_CHANGE_OE_FLAG3%FOUND THEN
          RAISE_APPLICATION_ERROR(-20007,
             'Balances exists in previous year') ;
       END IF;
       CLOSE F_VAL_CHANGE_OE_FLAG3;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_COA_LEVEL
                  (P_COA_LEVEL_FORMAT_ID     IN      NUMBER,
                  P_LEVEL_CODE               IN      NUMBER,
                  P_INDIC                    IN      VARCHAR2,
                  P_NAME                     OUT     VARCHAR2,
                  P_ERR_NO                   OUT     NUMBER) AS
CURSOR F_COA_LEVEL IS
       SELECT LVL_NAME, LVL_FRZ_FLAG
       FROM   FM_COA_LEVEL
       WHERE  LVL_FORMAT_ID = P_COA_LEVEL_FORMAT_ID
       AND    LVL_CODE = P_LEVEL_CODE;
P_FULL_NAME       VARCHAR2(30);
P_FRZ_FLAG        VARCHAR2(1);
P_SER_NO          NUMBER(2);
BEGIN
      P_SER_NO := 6;
      IF F_COA_LEVEL%ISOPEN THEN
         CLOSE F_COA_LEVEL;
      END IF;
      OPEN F_COA_LEVEL;
      FETCH F_COA_LEVEL INTO P_FULL_NAME,P_FRZ_FLAG;
      IF F_COA_LEVEL%NOTFOUND THEN
         P_NAME := '';
         RAISE_APPLICATION_ERROR(-20106,
             'COA Level code does not exists in COA Level master') ;
      ELSE
         P_NAME := P_FULL_NAME;
         IF P_FRZ_FLAG = 'Y' THEN
            RAISE_APPLICATION_ERROR(-20106,
                'COA Level code is frozen') ;
         ELSE
            P_ERR_NO := 0;
         END IF;
      END IF;
      CLOSE F_COA_LEVEL;
      RETURN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_COMB
                 (P_COMP_CODE IN VARCHAR2,
                  P_DIVN_CODE IN VARCHAR2,
                  P_DEPT_CODE IN VARCHAR2,
                  P_MAIN_ACNT_CODE IN VARCHAR2,
                  P_SUB_ACNT_CODE IN VARCHAR2,
                  P_ANLY_CODE_1 IN VARCHAR2,
                  P_ANLY_CODE_2 IN VARCHAR2,
                  P_ERR_NO OUT NUMBER,
                  P_KEY OUT NUMBER) AS
   CURSOR CUR_VAL_COMB IS
         SELECT VCM_IE_CODE, VCM_SEQ_NO
         FROM FM_VALID_COMB
         WHERE VCM_LOW_COMP_CODE <= NVL(P_COMP_CODE,'  0')
         AND VCM_HIGH_COMP_CODE  >= NVL(P_COMP_CODE,'  0')
         AND VCM_LOW_DEPT_CODE <= NVL(P_DEPT_CODE,'     0')
         AND VCM_HIGH_DEPT_CODE >= NVL(P_DEPT_CODE,'     0')
         AND VCM_LOW_DIVN_CODE <= NVL(P_DIVN_CODE,'     0')
         AND VCM_HIGH_DIVN_CODE >= NVL(P_DIVN_CODE,'     0')
         AND VCM_LOW_MAIN_ACNT_CODE <= NVL(P_MAIN_ACNT_CODE,'     0')
         AND VCM_HIGH_MAIN_ACNT_CODE >= NVL(P_MAIN_ACNT_CODE,'     0')
         AND VCM_LOW_SUB_ACNT_CODE <= NVL(P_SUB_ACNT_CODE,'     0')
         AND VCM_HIGH_SUB_ACNT_CODE >= NVL(P_SUB_ACNT_CODE,'     0')
         AND VCM_LOW_ANLY_CODE_1 <= NVL(P_ANLY_CODE_1,'     0')
         AND VCM_HIGH_ANLY_CODE_1 >= NVL(P_ANLY_CODE_1,'     0')
         AND VCM_LOW_ANLY_CODE_2 <= NVL(P_ANLY_CODE_2,'     0')
         AND VCM_HIGH_ANLY_CODE_2 >= NVL(P_ANLY_CODE_2,'     0')
         ORDER BY VCM_IE_CODE;
 P_FLAG CHAR;
 P_SEQ_NO NUMBER;
BEGIN
     IF CUR_VAL_COMB%ISOPEN THEN
           CLOSE CUR_VAL_COMB;
     END IF;
     OPEN CUR_VAL_COMB;
     FETCH CUR_VAL_COMB INTO P_FLAG,P_SEQ_NO;
     IF CUR_VAL_COMB%FOUND THEN
         IF P_FLAG = 'E' THEN
            RAISE_APPLICATION_ERROR(-20275,
                'Invalid combination, Exclusion defined') ;
            P_KEY   := P_SEQ_NO;
         ELSE
            P_ERR_NO := 0;
         END IF;
     ELSE
        RAISE_APPLICATION_ERROR(-20274,
                'Invalid combination, No Inclusion defined') ;
     END IF;
     CLOSE CUR_VAL_COMB;
END;
/
CREATE OR REPLACE FUNCTION  F_VAL_DATA_TYPE
                           (P_DATA VARCHAR2,
                            P_TYPE    VARCHAR2)
                            RETURN NUMBER IS
P_NUM     NUMBER(30,15);
P_DT      DATE;
BEGIN
     IF P_TYPE = 'D' THEN
          P_DT := TO_DATE(P_DATA,'DD/MM/YY');
     ELSE
          IF P_TYPE = 'N' THEN
               P_NUM := TO_NUMBER(P_DATA);
          END IF;
     END IF;
     RETURN(0);
EXCEPTION
     WHEN OTHERS THEN
     RETURN(SQLCODE);
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_DETAIL_LEVEL
                 (P_FORMAT_ID      IN      NUMBER,
                  P_LVL_CODE       IN      NUMBER ,
                  P_ERR_NO         OUT     NUMBER) AS
CURSOR F_VAL_DETAIL_LEVEL IS
       SELECT 1
       FROM   FM_COA_LEVEL
       WHERE  LVL_FORMAT_ID = P_FORMAT_ID
       AND    LVL_PARENT_CODE = P_LVL_CODE;
P_VALUE NUMBER;
BEGIN
      IF F_VAL_DETAIL_LEVEL%ISOPEN THEN
            CLOSE F_VAL_DETAIL_LEVEL;
      END IF;
      OPEN F_VAL_DETAIL_LEVEL;
      FETCH F_VAL_DETAIL_LEVEL INTO P_VALUE;
      IF F_VAL_DETAIL_LEVEL%FOUND THEN
         RAISE_APPLICATION_ERROR(-20014,
                 'COA Level code referenced by Parent code in COA Level') ;
      ELSE
         P_ERR_NO := 0;
      END IF;
      CLOSE F_VAL_DETAIL_LEVEL;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_DUP_ANLY_LEVEL
            (P_ALM_FORMAT_ID      IN      NUMBER,
             P_ALM_LVL_CODE       IN      VARCHAR2,
             P_ERR_NO             OUT     NUMBER) AS
     CURSOR F_ANLY_LEVEL IS
             SELECT 'X'
             FROM   FM_ANLY_LEVEL
             WHERE  ALM_FORMAT_ID  = P_ALM_FORMAT_ID
             AND    ALM_LVL_CODE = P_ALM_LVL_CODE;
     P_SER_NO         NUMBER(2);
     P_DUMMY          VARCHAR2(1);
BEGIN
       P_SER_NO := 11;
       IF F_ANLY_LEVEL%ISOPEN THEN
          CLOSE F_ANLY_LEVEL;
       END IF;
       OPEN F_ANLY_LEVEL;
       FETCH F_ANLY_LEVEL INTO P_DUMMY;
       IF F_ANLY_LEVEL%FOUND THEN
          RAISE_APPLICATION_ERROR(-20211,
                 'Duplicate Analysis level') ;
       ELSE
          P_ERR_NO := 0;
       END IF;
      CLOSE F_ANLY_LEVEL;
      RETURN;
  END;
/
CREATE OR REPLACE PROCEDURE F_VAL_DUP_CUST
            (P_CUST_CODE      IN      VARCHAR2,
             P_ERR_NO         OUT     NUMBER) AS
     CURSOR F_CUST IS
             SELECT 'X'
             FROM   FM_CUSTOMER
             WHERE  CUST_CODE = P_CUST_CODE;
     P_SER_NO         NUMBER(2);
     P_DUMMY          VARCHAR2(1);
BEGIN
       P_SER_NO := 15;
       IF F_CUST%ISOPEN THEN
           CLOSE F_CUST;
       END IF;
       OPEN F_CUST;
       FETCH F_CUST INTO P_DUMMY;
       IF F_CUST%FOUND THEN
          RAISE_APPLICATION_ERROR(-20215,
                 'Duplicate Customer code') ;
       ELSE
          P_ERR_NO := 0;
       END IF;
       CLOSE F_CUST;
       RETURN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_DUP_DOC
                 (P_COMP_CODE    IN      VARCHAR2,
                  P_ACNT_YEAR    IN      NUMBER ,
                  P_TRAN_CODE    IN      VARCHAR2 ,
                  P_DOC_NO       IN      NUMBER ,
                  P_ERR_NO        OUT    NUMBER) AS
P_CUR_ACNT_YEAR        NUMBER(2);
P_DUMMY                CHAR(1);
CURSOR SEL_CUR_TRAN IS
       SELECT 'X'
       FROM   FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
CURSOR SEL_PRV_TRAN IS
       SELECT 'X'
       FROM   FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
CURSOR SEL_UNP_TRAN IS
       SELECT 'X'
       FROM   FT_UNPOSTED_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
BEGIN
P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(P_COMP_CODE);
P_ERR_NO := 0;
IF P_CUR_ACNT_YEAR = -1 THEN
   RAISE_APPLICATION_ERROR(-20468, 'Invalid Current Year') ;
END IF;
IF SEL_UNP_TRAN%ISOPEN THEN
     CLOSE SEL_UNP_TRAN;
END IF;
OPEN SEL_UNP_TRAN;
FETCH SEL_UNP_TRAN INTO P_DUMMY;
IF SEL_UNP_TRAN%FOUND THEN
   CLOSE SEL_UNP_TRAN;
   RAISE_APPLICATION_ERROR(-20469, 'Unposted transactions exists') ;
END IF;
CLOSE SEL_UNP_TRAN;
IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
    IF SEL_CUR_TRAN%ISOPEN THEN
         CLOSE SEL_CUR_TRAN;
    END IF;
    OPEN SEL_CUR_TRAN;
    FETCH SEL_CUR_TRAN INTO P_DUMMY;
    IF SEL_CUR_TRAN%FOUND THEN
       RAISE_APPLICATION_ERROR(-20470, 'Confirmed transaction exists') ;
    END IF;
    CLOSE SEL_CUR_TRAN;
ELSE
    IF SEL_PRV_TRAN%ISOPEN THEN
         CLOSE SEL_PRV_TRAN;
    END IF;
    OPEN SEL_PRV_TRAN;
    FETCH SEL_PRV_TRAN INTO P_DUMMY;
    IF SEL_PRV_TRAN%FOUND THEN
       RAISE_APPLICATION_ERROR(-20470,
               'Confirmed Previous Year transactions exists') ;
    END IF;
    CLOSE SEL_PRV_TRAN;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_DUP_SUPP
            (P_SUPP_CODE      IN      VARCHAR2,
             P_ERR_NO         OUT     NUMBER) AS
     CURSOR F_SUPP IS
        SELECT 'X'
        FROM   FM_SUPPLIER
        WHERE  SUPP_CODE = P_SUPP_CODE;
     P_SER_NO         NUMBER(2);
     P_DUMMY          VARCHAR2(1);
BEGIN
       P_SER_NO := 16;
       IF F_SUPP%ISOPEN THEN
          CLOSE F_SUPP;
       END IF;
       CLOSE F_SUPP;
       FETCH F_SUPP INTO P_DUMMY;
       IF F_SUPP%FOUND THEN
          RAISE_APPLICATION_ERROR(-20216,
                  'Duplicate supplier code') ;
       ELSE
          P_ERR_NO := 0;
       END IF;
       CLOSE F_SUPP;
       RETURN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_MAIN_ACTY
                 (P_ACTY_CODE_1      IN      VARCHAR2,
                  P_ACTY_CODE_2      IN      VARCHAR2,
                  P_ERR              OUT     NUMBER) AS
BEGIN
     P_ERR := 0;
     IF (NVL(P_ACTY_CODE_1,'     0') = NVL(P_ACTY_CODE_2,'     0')) AND
        P_ACTY_CODE_1 IS NOT NULL THEN
             P_ERR := 20;
     END IF;
     IF P_ACTY_CODE_1 IS NULL AND P_ACTY_CODE_2 IS NOT NULL THEN
             P_ERR := 21;
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_MAIN_IS_CTL_ACNT
                 (P_MAIN_ACNT_CODE      IN      VARCHAR2,
                  P_ERR_NO              OUT     NUMBER) AS
CURSOR F_VAL_MAIN_IS_CTL_ACNT IS
       SELECT 1
       FROM FM_MAIN_ACCOUNT
       WHERE MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND MAIN_CTL_ACNT_FLAG = 'C';
P_LOCAL NUMBER;
BEGIN
     IF F_VAL_MAIN_IS_CTL_ACNT%ISOPEN THEN
           CLOSE F_VAL_MAIN_IS_CTL_ACNT;
     END IF;
     OPEN F_VAL_MAIN_IS_CTL_ACNT;
     FETCH F_VAL_MAIN_IS_CTL_ACNT INTO P_LOCAL;
     IF F_VAL_MAIN_IS_CTL_ACNT%NOTFOUND THEN
        P_ERR_NO := 12;
     ELSE
        P_ERR_NO := 0;
     END IF;
     CLOSE F_VAL_MAIN_IS_CTL_ACNT;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_MAIN_SUB_COMBN
                 (P_MAIN_ACNT_CODE     IN      VARCHAR2,
                  P_SUB_ACNT_CODE      IN      VARCHAR2,
                  P_ERR_NO             IN OUT  NUMBER) AS
BEGIN
      P_ERR_NO := 0;
      F_VAL_MAIN_IS_CTL_ACNT(P_MAIN_ACNT_CODE, P_ERR_NO);
      IF P_SUB_ACNT_CODE IS NULL  THEN
          /* Check for the Reverse i.e. Must be a Main Account */
          IF P_ERR_NO = 0 THEN
             RAISE_APPLICATION_ERROR(-20026,
                   'Sub account code is mandatory') ;
          ELSE
             P_ERR_NO := 0;
          END IF;
      END IF;
END;
CREATE OR REPLACE PROCEDURE F_VAL_NARRATION
/
                 (P_TRAN_CODE    IN      VARCHAR2,
                  P_DESC         IN      VARCHAR2 ,
                  P_ERR_NO       IN OUT     NUMBER) AS
P_DATA              VARCHAR2(15);
P_DATA_TYPE         VARCHAR2(1);
P_LENGTH            NUMBER(2);
P_START_POSN        NUMBER(4);
CURSOR F_SEL_NARRN_DEFN IS
       SELECT NARR_TYPE, NARR_LENGTH
       FROM   FM_NARRATION_DEFN
       WHERE  NARR_TRAN_CODE = P_TRAN_CODE
       ORDER BY NARR_SEQ_NO;
BEGIN
    IF F_SEL_NARRN_DEFN%ISOPEN THEN
           CLOSE F_SEL_NARRN_DEFN;
    END IF;
    OPEN F_SEL_NARRN_DEFN;
    P_START_POSN := 1;
    P_ERR_NO := 0;
    <<NARRN_CHK>>
    LOOP
         FETCH F_SEL_NARRN_DEFN INTO P_DATA_TYPE, P_LENGTH;
    EXIT WHEN F_SEL_NARRN_DEFN%NOTFOUND;
         P_DATA := RTRIM(LTRIM(SUBSTR(P_DESC,P_START_POSN,P_LENGTH)));
         IF P_DATA IS NOT NULL THEN
              P_ERR_NO := F_VAL_DATA_TYPE(P_DATA, P_DATA_TYPE);
         END IF;
         IF P_ERR_NO != 0 THEN
              EXIT;
         END IF;
         P_START_POSN := P_START_POSN + P_LENGTH;
    END LOOP NARRN_CHK;
   CLOSE F_SEL_NARRN_DEFN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_NO_TRAN_EXIST
                  (P_TRAN_CODE      IN      VARCHAR2,
                   P_FLAG           IN      VARCHAR2,
                   P_ERR_NO         OUT     NUMBER) AS
CURSOR F_VAL_CUR1 IS
       SELECT 1
       FROM FT_UNPOSTED_TRANS_DETAIL
       WHERE TD_TRAN_CODE = P_TRAN_CODE;
CURSOR F_VAL_CUR2 IS
       SELECT 1
       FROM FT_CUR_TRANS_DETAIL
       WHERE TD_TRAN_CODE = P_TRAN_CODE;
CURSOR F_VAL_CUR3 IS
       SELECT 1
       FROM FT_PRV_TRANS_DETAIL
       WHERE TD_TRAN_CODE = P_TRAN_CODE;
P_NUMBER NUMBER;
BEGIN
        P_ERR_NO := 0;
        P_NUMBER := 0;
        IF P_FLAG = 'U' OR P_FLAG = 'B' THEN
            IF F_VAL_CUR1%ISOPEN THEN
                   CLOSE F_VAL_CUR1;
            END IF;
            OPEN F_VAL_CUR1;
            FETCH F_VAL_CUR1 INTO P_NUMBER;
            IF F_VAL_CUR1%FOUND THEN
               RAISE_APPLICATION_ERROR(-20024,
                     'Unposted transactions exists') ;
            END IF;
            CLOSE F_VAL_CUR1;
        END IF;
        IF (P_FLAG = 'P' OR P_FLAG = 'B') AND (NVL(P_NUMBER,0) = 0 ) THEN
             IF F_VAL_CUR2%ISOPEN THEN
                   CLOSE F_VAL_CUR2;
             END IF;
             OPEN F_VAL_CUR2;
             FETCH F_VAL_CUR2 INTO P_NUMBER;
             IF F_VAL_CUR2%FOUND THEN
                RAISE_APPLICATION_ERROR(-20025,
                     'Confirmed transactions exists') ;
             ELSE
                 IF F_VAL_CUR3%ISOPEN THEN
                     CLOSE F_VAL_CUR3;
                 END IF;
                 OPEN F_VAL_CUR3;
                 FETCH F_VAL_CUR3 INTO P_NUMBER;
                 IF F_VAL_CUR3%FOUND THEN
                    RAISE_APPLICATION_ERROR(-20025,
                         'Confirmed previous year transactions exists') ;
                 END IF;
                 CLOSE F_VAL_CUR3;
             END IF;
             CLOSE F_VAL_CUR2;
        END IF;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_OPCL
                 (P_COMP_CODE      IN       VARCHAR2,
                  P_DT             IN       DATE,
                  P_ERR_NO         OUT      NUMBER,
                  P_CAL_YEAR       OUT      NUMBER,
                  P_CAL_MONTH      OUT      NUMBER,
                  P_ACNT_YEAR      OUT      NUMBER) AS
CURSOR F_OPCL IS
       SELECT APER_CLO_DT, APER_CAL_YEAR,
              APER_CAL_MONTH, APER_ACNT_YEAR
       FROM   FM_ACNT_PERIOD
       WHERE  APER_FRM_DT <= P_DT
       AND    APER_TO_DT >= P_DT
       AND    APER_COMP_CODE = P_COMP_CODE;
P_CLO_DATE              DATE;
BEGIN
       IF F_OPCL%ISOPEN THEN
           CLOSE F_OPCL;
       END IF;
       OPEN F_OPCL;
       FETCH F_OPCL INTO P_CLO_DATE, P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR;
       IF F_OPCL%NOTFOUND THEN
          P_ERR_NO := 251;
          P_CAL_YEAR := NULL;
          P_CAL_MONTH := NULL;
          P_ACNT_YEAR := NULL;
          RAISE_APPLICATION_ERROR(-20251,
                'Accounting period not defined') ;
       ELSE
            IF P_CLO_DATE IS NULL THEN
               P_ERR_NO := 0;
            ELSE
               P_CAL_YEAR := NULL;
               P_CAL_MONTH := NULL;
               P_ACNT_YEAR := NULL;
               RAISE_APPLICATION_ERROR(-20252,
                     'Accounting period is closed') ;
            END IF;
       END IF;
       CLOSE F_OPCL;
       RETURN;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_PARENT_LEVEL
                 (P_LVL_FORMAT_ID      IN      NUMBER,
                  P_LVL_PARENT_CODE    IN      NUMBER,
                  P_ERR_NO             OUT     NUMBER) AS
CURSOR F_VAL_PARENT_LEVEL IS
       SELECT 'X'
       FROM   FM_COA_ACNT_FORMAT
       WHERE  CAF_FORMAT_ID = P_LVL_FORMAT_ID
       AND    CAF_LVL_CODE = P_LVL_PARENT_CODE;
P_MAIN_ACNT_FLAG      VARCHAR2(1);
BEGIN
    P_ERR_NO := 0;
    IF F_VAL_PARENT_LEVEL%ISOPEN THEN
        CLOSE F_VAL_PARENT_LEVEL;
    END IF;
    OPEN F_VAL_PARENT_LEVEL;
    FETCH F_VAL_PARENT_LEVEL INTO P_MAIN_ACNT_FLAG;
    IF F_VAL_PARENT_LEVEL%FOUND THEN
       RAISE_APPLICATION_ERROR(-20002,
             'Has sub levels defined, Cannot have main accounts under it') ;
    ELSE
       P_ERR_NO := 0;
    END IF;
    CLOSE F_VAL_PARENT_LEVEL;
END;
/
CREATE OR REPLACE PROCEDURE F_VAL_SUB_ACNT
                 (P_MAIN_ACNT_CODE     IN      VARCHAR2,
                  P_SUB_ACNT_CODE      IN      VARCHAR2,
                  P_INDIC              IN      VARCHAR2,
                  P_NAME               OUT     VARCHAR2,
Press <Enter> to continue...
                  P_ERR_NO             OUT     NUMBER) AS
CURSOR F_SUB_ACNT1 IS
       SELECT SUB_ACNT_NAME, SUB_ACNT_SHORT_NAME, SUB_FRZ_FLAG
       FROM   FM_SUB_ACCOUNT
       WHERE  SUB_ACNT_CODE = P_SUB_ACNT_CODE;
CURSOR F_SUB_ACNT2 IS
       SELECT MS_SUB_ACNT_NAME, MS_SUB_ACNT_SHORT_NAME , SUB_FRZ_FLAG
       FROM   FM_MAIN_SUB, FM_SUB_ACCOUNT
       WHERE  MS_SUB_ACNT_CODE = P_SUB_ACNT_CODE
       AND    MS_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE
       AND    SUB_ACNT_CODE = MS_SUB_ACNT_CODE;
P_FULL_NAME       VARCHAR2(30);
P_SHORT_NAME      VARCHAR2(15);
P_FRZ_FLAG        VARCHAR2(1);
P_SER_NO          NUMBER(2);
BEGIN
      P_SER_NO := 8;
      IF P_MAIN_ACNT_CODE IS NULL THEN
         IF F_SUB_ACNT1%ISOPEN THEN
            CLOSE F_SUB_ACNT1;
         END IF;
         OPEN F_SUB_ACNT1;
         FETCH F_SUB_ACNT1 INTO P_FULL_NAME,P_SHORT_NAME,P_FRZ_FLAG;
         IF F_SUB_ACNT1%NOTFOUND THEN
            P_NAME := '';
            RAISE_APPLICATION_ERROR(-20108,
                  'Sub account does not exists in sub account master') ;
         ELSE
            IF P_FRZ_FLAG = 'Y' THEN
               RAISE_APPLICATION_ERROR(-20158,
                     'Sub account code is frozen') ;
            ELSE
               P_ERR_NO := 0;
            END IF;
            IF P_INDIC = 'N' THEN
                 P_NAME := P_FULL_NAME;
            ELSE
                 P_NAME := P_SHORT_NAME;
            END IF;
         END IF;
         CLOSE F_SUB_ACNT1;
      ELSE
         IF F_SUB_ACNT2%ISOPEN THEN
            CLOSE F_SUB_ACNT2;
         END IF;
         OPEN F_SUB_ACNT2;
         FETCH F_SUB_ACNT2 INTO P_FULL_NAME,P_SHORT_NAME, P_FRZ_FLAG;
         IF F_SUB_ACNT2%NOTFOUND THEN
            P_NAME := '';
            RAISE_APPLICATION_ERROR(-20108,
                  'Sub account does not exists in sub account master') ;
         ELSE
            IF P_FRZ_FLAG = 'Y' THEN
               RAISE_APPLICATION_ERROR(-20108,
                     'Sub account code is frozen') ;
            ELSE
               P_ERR_NO := 0;
            END IF;
            IF P_INDIC = 'N' THEN
                P_NAME := P_FULL_NAME;
            ELSE
                P_NAME := P_SHORT_NAME;
            END IF;
         END IF;
         CLOSE F_SUB_ACNT2;
      END IF;
      RETURN;
END;
/
CREATE OR REPLACE PROCEDURE  F_VAL_SUB_ACNT_NAME
                 (P_SUB_ACNT_CODE           IN      VARCHAR2,
                  P_SUB_ACNT_NAME           IN      VARCHAR2,
                  P_SUB_ACNT_SHORT_NAME     IN      VARCHAR2,
                  P_ERR_NO                  OUT     NUMBER) AS
CURSOR F_PARA IS
       SELECT SUBSTR(PARA_VALUE,1,1)
       FROM   FP_PARAMETER
       WHERE  PARA_ID = 'UNIQUE.SUBACNT';
P_NAME1        VARCHAR2(30);
P_NAME2        VARCHAR2(30);
P_ERR          NUMBER;
P_PARA_VALUE   VARCHAR2(1);
P_INDIC        VARCHAR2(1);
BEGIN
     P_ERR_NO := 0;
     IF F_PARA%ISOPEN THEN
           CLOSE F_PARA;
     END IF;
     OPEN F_PARA;
     FETCH F_PARA INTO P_PARA_VALUE;
     IF F_PARA%NOTFOUND THEN
        RAISE_APPLICATION_ERROR(-20011,
                     'UNIQUE.SUBACNT parameter not found') ;
     ELSE
        IF P_PARA_VALUE = 'Y' THEN
            P_INDIC := 'N';
            F_VAL_SUB_ACNT('',P_SUB_ACNT_CODE,P_INDIC,P_NAME1, P_ERR);
            /* Error 158 corresponds to Frozen Sub Account */
            IF P_ERR != 0 AND P_ERR!= 158 THEN
                P_ERR_NO := P_ERR;
                CLOSE F_PARA;
                RETURN;
            END IF;
            P_INDIC := 'S';
            F_VAL_SUB_ACNT('',P_SUB_ACNT_CODE, P_INDIC, P_NAME2, P_ERR);
            /* Error 158 corresponds to Frozen Sub Account */
            IF P_ERR != 0 AND P_ERR != 158 THEN
                P_ERR_NO := P_ERR;
                CLOSE F_PARA;
                RETURN;
            END IF;
            IF P_SUB_ACNT_NAME != P_NAME1 OR
               P_SUB_ACNT_SHORT_NAME != P_NAME2 THEN
               RAISE_APPLICATION_ERROR(-20010,
                 'Sub account name must be same across all control accounts') ;
            END IF;
        END IF;
     END IF;
     CLOSE F_PARA;
END;
/
CREATE OR REPLACE PROCEDURE INS45 IS
M_DEPT       pt_policy.pol_dept_code%type;
m_pol_sys_id pt_policy.pol_sys_id%type;
m_sub        ps_drcr.drcr_sub_acnt_code%type;
c            number(4);
cursor c1 is
      select pol_dept_code, pol_sys_id,
             drcr_sub_acnt_code
      from pt_policy,ps_drcr
      where pol_sys_id    = drcr_pol_sys_id ;
begin
open c1;
     c := 0;
loop
    fetch c1 into m_dept, m_pol_sys_id,m_sub;
    exit when c1%notfound;
    if m_sub is null then
       update ps_drcr
          set drcr_dept_code = m_dept
          where drcr_pol_sys_id = m_pol_sys_id;
       c := c+1;
    end if;
end loop;
dbms_output.put_line(c);
close c1;
end;
/
CREATE OR REPLACE PROCEDURE                     PDELALL ( P_POL_NO IN VARCHAR) IS
m_pol_sys_Id  number(10);
m_clm_sys_Id  number(10);
m_temp        number ;
m_ctr         number := 0;
cursor c1 is
       select pol_sys_Id
       from   pt_policy
       where  pol_no =  p_pol_no ;

cursor c2 is
       select 1
       from   ps_drcr, ft_cur_trans_header
       where  drcr_pol_sys_id = m_pol_sys_id
       and    drcr_txn_code = th_tran_code
       and    drcr_doc_no   = th_doc_no ;

cursor c3 is
       select clm_sys_Id
       from   pt_claim
       where  clm_pol_sys_id = m_pol_sys_id ;

begin
   open c1 ;
   fetch c1 into m_pol_sys_Id ;
   close c1 ;

   if m_pol_sys_Id is null then
      dbms_output.put_line('***********************************************');
      dbms_output.put_line('*                                             *');
      dbms_output.put_line('*  ERROR :  Invalid Policy Number. Try Again. *');
      dbms_output.put_line('*                                             *');
      dbms_output.put_line('***********************************************');
      return;
   else
/*
      open c2 ;
      fetch c2 into m_temp ;
      close c2 ;
      if m_temp is not null then
         dbms_output.put_line('********************************************');
         dbms_output.put_line('*                                          *');
         dbms_output.put_line('*  STOP : Policy Has Posted Accounting     *');
         dbms_output.put_line('*         Transactions.  Cannot Delete.    *');
         dbms_output.put_line('*                                          *');
         dbms_output.put_line('********************************************');
         return ;

      else
*/
         delete pt_aircraft where air_pol_sys_Id  = m_pol_sys_Id;
         delete ph_aircraft where airh_pol_sys_Id  = m_pol_sys_Id;
         delete from pt_pol_charge where chg_pol_sys_Id  = m_pol_sys_Id;
         delete from ph_pol_charge where chgh_pol_sys_Id = m_pol_sys_Id;
         delete pt_pol_assured_dtl where pad_pol_sys_id = m_pol_sys_Id ;
         delete ph_pol_assured_dtl where padh_pol_sys_id = m_pol_sys_Id ;
         delete pt_pol_broker where pb_pol_sys_Id  = m_pol_sys_id;
         delete ph_pol_broker where pbh_pol_sys_Id = m_pol_sys_id;
         delete pt_vehicle_addl_dtl
         where vad_veh_sys_id in (select veh_sys_id
                                  from   pt_vehicle
                                  where  veh_pol_sys_id = m_pol_sys_Id);
         delete ph_vehicle_addl_dtl
         where vadh_veh_sys_id in (select veh_sys_id
                                   from   pt_vehicle
                                   where  veh_pol_sys_id = m_pol_sys_Id);
         delete  pt_vehicle  where veh_pol_sys_Id  = m_pol_sys_Id ;
         delete  ph_vehicle  where vehh_pol_sys_Id = m_pol_sys_Id ;
         delete  pt_driver where drv_pol_sys_id  = m_pol_sys_Id ;
         delete  ph_driver where drvh_pol_sys_id = m_pol_sys_Id ;
         delete  pt_cover_discount
         where   cd_cover_sys_id in (select pcvr_sys_id
                                     from   pt_pol_cover
                                     where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  ph_cover_discount
         where   cdh_cover_sys_id in (select pcvr_sys_id
                                      from   pt_pol_cover
                                      where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  pt_ded_loss
         where   dl_cover_sys_id in (select pcvr_sys_id
                                     from   pt_pol_cover
                                     where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete  ph_ded_loss
         where   dlh_cover_sys_id in (select pcvr_sys_id
                                      from   pt_pol_cover
                                      where  pcvr_pol_sys_id = m_pol_sys_Id);
         delete pt_pol_cover where pcvr_pol_sys_id  = m_pol_sys_Id ;
         delete ph_pol_cover where pcvrh_pol_sys_id = m_pol_sys_Id ;
         delete pt_condition where cond_pol_sys_id  = m_pol_sys_Id ;
         delete ph_condition where condh_pol_sys_id = m_pol_sys_Id ;
         delete pt_policy_schedule where psc_pol_sys_id  = m_pol_sys_id ;
         delete pt_inst_prem where ip_pol_sys_id  = m_pol_sys_id ;
         delete ph_inst_prem where iph_pol_sys_id = m_pol_sys_id ;
         delete pt_risk where risk_pol_sys_id = m_pol_sys_id ;
         delete ph_risk where riskh_pol_sys_id = m_pol_sys_id ;
         delete pt_fac_in_comm_tax
         where  fict_fi_sys_id in (select fi_sys_id
                                   from   pt_fac_in
                                   where  fi_pol_sys_id = m_pol_sys_id );
         delete ph_fac_in_comm_tax
         where  ficth_fi_sys_id in (select fi_sys_id
                                    from   pt_fac_in
                                    where  fi_pol_sys_id = m_pol_sys_id );
         delete pt_fac_in where fi_pol_sys_id  = m_pol_sys_id ;
         delete ph_fac_in where fih_pol_sys_id = m_pol_sys_id ;
         delete pt_fac_cust_retro
         where  fcr_fpcu_sys_id in (select fpcu_sys_id
                                    from   pt_fac_part_cust , pt_fac_out
                                    where  fpcu_fo_sys_id = fo_sys_Id
                                    and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete ph_fac_cust_retro
         where  fcrh_fpcu_sys_id in (select fpcu_sys_id
                                     from   pt_fac_part_cust , pt_fac_out
                                     where  fpcu_fo_sys_id = fo_sys_Id
                                     and    fo_pol_sys_Id  = m_pol_sys_Id ) ;

         delete pt_fac_Deduction
         where  fd_fpcu_sys_id in (select fpcu_sys_id
                                   from   pt_fac_part_cust , pt_fac_out
                                   where  fpcu_fo_sys_id = fo_sys_Id
                                   and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete ph_fac_Deduction
         where  fdh_fpcu_sys_id in (select fpcu_sys_id
                                    from   pt_fac_part_cust , pt_fac_out
                                    where  fpcu_fo_sys_id = fo_sys_Id
                                    and    fo_pol_sys_Id  = m_pol_sys_Id ) ;
         delete pt_fac_part_cust
         where  fpcu_fo_sys_id in (select fo_sys_id
  	         	          from   pt_fac_out
                                   where  fo_pol_sys_id = m_pol_sys_id) ;
         delete ph_fac_part_cust
         where  fpcuh_fo_sys_id in (select fo_sys_id
  	        	           from   pt_fac_out
                                    where  fo_pol_sys_id = m_pol_sys_id) ;
         delete pt_fac_out where fo_pol_sys_id  = m_pol_sys_Id ;
         delete ph_fac_out where foh_pol_sys_id = m_pol_sys_Id ;
         delete pt_maint_period  where mp_pol_sys_id  = m_pol_sys_id ;
         delete ph_maint_period  where mph_pol_sys_id = m_pol_sys_id ;
         delete pt_open_policy  where op_pol_sys_id  = m_pol_sys_Id ;
         delete ph_open_policy  where oph_pol_sys_id = m_pol_sys_Id ;
         delete pt_ship_good
         where  sg_ship_sys_id in (select ship_sys_id
                                   from   pt_shipment
 		        	  where  ship_pol_sys_id = m_pol_sys_Id ) ;
         delete ph_ship_good
         where  sgh_ship_sys_id in (select ship_sys_id
                                    from   pt_shipment
 	                           where  ship_pol_sys_id = m_pol_sys_Id ) ;
         delete pt_shipment where ship_pol_sys_id  = m_pol_sys_id ;
         delete ph_shipment where shiph_pol_sys_id = m_pol_sys_id ;
         delete pt_vessel  where ves_pol_sys_id  = m_pol_sys_id ;
         delete ph_vessel  where vesh_pol_sys_id = m_pol_sys_id ;
         delete pt_policy_appl_curr where pac_pol_sys_id  = m_pol_sys_Id ;
         delete ph_policy_appl_curr where pach_pol_sys_id = m_pol_sys_Id ;
         delete ps_prem_reg_si where prs_pol_sys_Id = m_pol_sys_Id ;
         delete pt_ri_Cession  where rc_pol_sys_Id  = m_pol_sys_Id ;
         delete ps_prem_reg  where  pr_pol_sys_Id = m_pol_sys_Id ;
         delete ps_prem_ri_reg  where  prr_pol_sys_Id = m_pol_sys_Id ;
         delete ps_fac_ri where fr_pol_sys_Id = m_pol_sys_Id ;
--       delete ps_drcr where drcr_pol_sys_Id  = m_pol_sys_Id ;
         delete pt_ri_prem_alloc  where rpa_pol_sys_id = m_pol_sys_Id;
         delete pt_xl_prem_alloc  where xpa_pol_sys_Id = m_pol_sys_Id ;
----- Claims Related Tables Begin -------
         open c3 ;
         loop
         fetch c3 into m_clm_sys_Id ;
         exit when c3%notfound ;
            m_ctr := m_ctr + 1 ;
            delete pt_accident where acc_clm_sys_Id = m_clm_sys_Id ;
            delete pt_injured where inj_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_recovery where cr_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claims_tp where ctp_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_paid  where cp_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_estimate where ce_clm_sys_Id = m_clm_sys_Id ;
            delete pt_claim_schedule where cs_clm_sys_Id = m_clm_sys_Id ;
            delete pt_ri_claim_alloc where rca_clm_sys_Id = m_clm_sys_Id ;
            delete pt_xl_claim_alloc where xca_clm_sys_Id = m_clm_sys_Id ;
            delete ps_fac_claim_part_cust where fcpc_clm_sys_Id = m_clm_sys_Id ;
            delete ps_ri_claim_reg where rcr_clm_sys_Id = m_clm_sys_id ;
            delete ps_xl_claim_reg where xcr_clm_sys_Id = m_clm_sys_id ;
         end loop ;
         close c3 ;
         if m_ctr > 0 then
            dbms_output.put_line( chr(10));
            dbms_output.put_line( '!! ' || to_char(m_ctr) ||' Claims encountered for deletion. ');
            dbms_output.put_line( chr(10));
         end if ;
         delete pt_claim where clm_pol_sys_Id = m_pol_sys_id ;

----  Claims Related Tables End --------
         delete pt_policy  where  pol_sys_Id   =  m_pol_sys_Id  ;
         delete ph_policy  where  polh_sys_Id  =  m_pol_sys_Id  ;
         dbms_output.put_line('**************************************************');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('*  !!!   Policy (Endts./Claims if any) Is        *');
         dbms_output.put_line('*        Being Totally Removed From PREMIA.      *');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('*  Type  COMMIT;    - Confirm Deletion           *');
         dbms_output.put_line('*        ROLLBACK;  - Undo Deletion              *');
         dbms_output.put_line('*        EXIT;      - Confirm Deletion and Exit  *');
         dbms_output.put_line('*                                                *');
         dbms_output.put_line('**************************************************');
-----      end if ; --------
   end if;
end;

/
CREATE OR REPLACE PROCEDURE PP_CREATE_INSERT_STMT
			(P_TABLE_NAME	IN VARCHAR2 ) IS
BEGIN
 DECLARE
  CURSOR Cur_SelColumns IS
	SELECT column_name, data_type, column_id
	FROM user_tab_columns
	WHERE  table_name = P_TABLE_NAME ;
  TabName			Varchar2(30)	:= P_TABLE_NAME ;
  InitSel			Varchar2(60) ;
  LastSel			Varchar2(40) ;
  ColNames			Varchar2(30) ;
  ColType			varchar2(10) ;
  ColId				number(3) := 0 ;
  MaxColId			number(3) := 0 ;
  SelString			Long ;
  EndString			Varchar2(60) ;
  JnStString			Varchar2(30) := '''''''''' || ' || ' ;
  JnFsString			Varchar2(30) := ' || ' || '''''''''' ;
  JnCmString			Varchar2(30) := ' || ' || '''' || ',' || ''''  ;
BEGIN
  SELECT Max(Column_Id)
  INTO   MaxColId
  FROM   User_Tab_Columns
  WHERE  Table_name = TabName ;
  -- InitSel  := '''' || 'INSERT INTO ' || TabName || ' VALUES (' || '''' ;
  InitSel  := '''' || 'INSERT INTO ' || TabName || ' VALUES ('|| ''''|| ',' ;
  LastSel  := '''' || ') ;' || '''' ;
  SelString := 'SELECT ' ;
  SelString := SelString || InitSel ;
  EndString := ' FROM ' || TabName || ' ; '  ;
  OPEN Cur_SelColumns ;
  LOOP
     FETCH Cur_SelColumns INTO ColNames, ColType, ColId ;
     Exit when Cur_SelColumns%NOTFOUND ;
     SelString := SelString || JnStString || ' ' || ColNames ;
     dbms_output.put_line(to_char(MaxColId) || ' - ' || to_char(ColId) ) ;
     If ColId != MaxColId then
        SelString := SelString || ' ' || JnFsString || JnCmString  ;
	SelString := SelString || ',' ;
     Else
        SelString := SelString || ' ' ||  JnFsString  ;
	SelString := SelString || ',' || LastSel ;
     End If ;
  END LOOP ;
  SelString := SelString || EndString ;
  INSERT INTO premia_ins_val(piv_table_name, piv_ins_text)
  VALUES (P_Table_Name, SelString) ;
  Close Cur_SelColumns ;
 END ;
END ;
/
CREATE OR REPLACE PROCEDURE P_GET_CUST_ACC_SETUP
    (P_CUST_CLASS      IN       VARCHAR2,
     P_DIVN_CODE       IN       VARCHAR2,
     P_DEPT_CODE       IN       VARCHAR2,
     P_CUST_CODE       IN       VARCHAR2,
     M_MAIN_ACNT_CODE  IN OUT   VARCHAR2)
 IS
BEGIN
DECLARE
M_FORCE_DIVN_YN          PM_PREM_ACCOUNT_SETUP.PAS_FORCE_DIVN_YN%TYPE;
M_FORCE_DEPT_YN          PM_PREM_ACCOUNT_SETUP.PAS_FORCE_DEPT_YN%TYPE;
M_MAIN_CTL_ACNT_FLAG     VARCHAR2(1);
CURSOR MAIN IS
       SELECT CAS_MAIN_ACNT_CODE
       FROM   PM_CUST_ACCOUNT_SETUP
       WHERE  P_CUST_CLASS BETWEEN CAS_CUST_FM_CLASS AND CAS_CUST_TO_CLASS
       AND    P_DIVN_CODE BETWEEN CAS_DIVN_FM_CODE  AND CAS_DIVN_TO_CODE
       AND    P_DEPT_CODE BETWEEN CAS_DEPT_FM_CODE  AND CAS_DEPT_TO_CODE;
CURSOR C2 IS
       SELECT MAIN_CTL_ACNT_FLAG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = M_MAIN_ACNT_CODE;
BEGIN

   OPEN MAIN;
   FETCH MAIN INTO M_MAIN_ACNT_CODE;

   IF MAIN%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20011,'ACCOUNT SET UP NOT AVAILABLE FOR THIS CUSTOMER');
   END IF;
   CLOSE MAIN;
   OPEN C2;
   FETCH C2 INTO M_MAIN_CTL_ACNT_FLAG;
   CLOSE C2;

END;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACNT_ANLY (
 OLD_AANLY_ANLY_HEAD_NO    IN      NUMBER,
 OLD_AANLY_ANLY_CODE       IN      VARCHAR2,
 OLD_AANLY_MAIN_ACNT_CODE  IN      VARCHAR2,
 OLD_AANLY_SUB_ACNT_CODE   IN      VARCHAR2,
 OLD_AANLY_ANLY_NAME       IN      VARCHAR2,
 OLD_AANLY_ANLY_SHORT_NAME IN      VARCHAR2,
 OLD_AANLY_CR_UID          IN      VARCHAR2,
 OLD_AANLY_CR_DT           IN      DATE,
 OLD_AANLY_FRZ_FLAG        IN      VARCHAR2,
 NEW_AANLY_ANLY_HEAD_NO    IN OUT  NUMBER,
 NEW_AANLY_ANLY_CODE       IN OUT  VARCHAR2,
 NEW_AANLY_MAIN_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_AANLY_SUB_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_AANLY_ANLY_NAME       IN OUT  VARCHAR2,
 NEW_AANLY_ANLY_SHORT_NAME IN OUT  VARCHAR2,
 NEW_AANLY_CR_UID          IN OUT  VARCHAR2,
 NEW_AANLY_CR_DT           IN OUT  DATE,
 NEW_AANLY_FRZ_FLAG        IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2 ,
 OLD_AANLY_BL_ANLY_NAME       IN      VARCHAR2,
 NEW_AANLY_BL_ANLY_NAME       IN OUT  VARCHAR2,
 OLD_AANLY_BL_ANLY_SHORT_NAME IN      VARCHAR2,
 NEW_AANLY_BL_ANLY_SHORT_NAME IN OUT  VARCHAR2) AS
T_ERR_NO NUMBER;
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
          NEW_AANLY_CR_DT := SYSDATE;
          NEW_AANLY_CR_UID := NVL(NEW_AANLY_CR_UID,
                               NVL(OLD_AANLY_CR_UID, 'UNDEF'));
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'I' THEN
         IF (NVL(NEW_AANLY_MAIN_ACNT_CODE, '000000') !=
            NVL(OLD_AANLY_MAIN_ACNT_CODE, '000000'))
                          OR
            NVL(NEW_AANLY_ANLY_HEAD_NO, '000000') !=
            NVL(OLD_AANLY_ANLY_HEAD_NO, '000000')
                          OR
            (NVL(NEW_AANLY_SUB_ACNT_CODE, '000000') !=
            NVL(OLD_AANLY_SUB_ACNT_CODE, '000000')) THEN
               F_VAL_ACNT_ANLY_COMBN(NEW_AANLY_ANLY_HEAD_NO,
                                     NEW_AANLY_MAIN_ACNT_CODE,
                                     NEW_AANLY_SUB_ACNT_CODE,
                                      T_ERR_NO);
                 IF T_ERR_NO != 0 THEN
                     RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,
                         'Invalid Account - Analysis code combination');
                 END IF;
         END IF;
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
         INSERT INTO FH_ACNT_ANLY_HIST  VALUES (OLD_AANLY_ANLY_HEAD_NO,
                                                OLD_AANLY_ANLY_CODE,
                                                OLD_AANLY_MAIN_ACNT_CODE,
                                                OLD_AANLY_SUB_ACNT_CODE,
                                                OLD_AANLY_ANLY_NAME,
                                                OLD_AANLY_ANLY_SHORT_NAME,
                                                OLD_AANLY_CR_UID,
                                                OLD_AANLY_CR_DT,
                                                OLD_AANLY_FRZ_FLAG ,
                                                OLD_AANLY_BL_ANLY_NAME,
                                                OLD_AANLY_BL_ANLY_SHORT_NAME) ;
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACNT_ANLY_LEVEL (
 OLD_AAL_HEAD_NO           IN      NUMBER,
 OLD_AAL_FORMAT_ID         IN      NUMBER,
 OLD_AAL_LVL_CODE          IN      NUMBER,
 OLD_AAL_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_AAL_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_AAL_ANLY_CODE         IN      VARCHAR2,
 OLD_AAL_CR_UID            IN      VARCHAR2,
 OLD_AAL_CR_DT             IN      DATE,
 NEW_AAL_HEAD_NO           IN OUT  NUMBER,
 NEW_AAL_FORMAT_ID         IN OUT  NUMBER,
 NEW_AAL_LVL_CODE          IN OUT  NUMBER,
 NEW_AAL_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_AAL_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_AAL_ANLY_CODE         IN OUT  VARCHAR2,
 NEW_AAL_CR_UID            IN OUT  VARCHAR2,
 NEW_AAL_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
T_MSG    VARCHAR2(80);
T_ERR_NO NUMBER(6);
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
   IF NVL(NEW_AAL_FORMAT_ID, 0) != NVL(OLD_AAL_FORMAT_ID,0) OR
      NVL(NEW_AAL_LVL_CODE,0)   != NVL(OLD_AAL_LVL_CODE,0)      THEN
      F_VAL_ANLY_DETAIL_LEVEL(NEW_AAL_HEAD_NO, NEW_AAL_FORMAT_ID,
                              NEW_AAL_LVL_CODE, T_ERR_NO);
      IF T_ERR_NO != 0 THEN
         RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
      END IF;
   END IF;
   NEW_AAL_CR_DT := SYSDATE;
   NEW_AAL_CR_UID := NVL(NEW_AAL_CR_UID, NVL(OLD_AAL_CR_UID, 'UNDEF'));
END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
         INSERT INTO FH_ACNT_ANLY_LEVEL_HIST VALUES (OLD_AAL_HEAD_NO,
                                                     OLD_AAL_FORMAT_ID,
                                                     OLD_AAL_LVL_CODE,
                                                     OLD_AAL_MAIN_ACNT_CODE,
                                                     OLD_AAL_SUB_ACNT_CODE,
                                                     OLD_AAL_ANLY_CODE,
                                                     OLD_AAL_CR_UID,
                                                     OLD_AAL_CR_DT);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACNT_COMP (
 OLD_ACOMP_COMP_CODE       IN      VARCHAR2,
 OLD_ACOMP_MAIN_ACNT_CODE  IN      VARCHAR2,
 OLD_ACOMP_SUB_ACNT_CODE   IN      VARCHAR2,
 OLD_ACOMP_CR_UID          IN      VARCHAR2,
 OLD_ACOMP_CR_DT           IN      DATE,
 NEW_ACOMP_COMP_CODE       IN OUT  VARCHAR2,
 NEW_ACOMP_MAIN_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_ACOMP_SUB_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_ACOMP_CR_UID          IN OUT  VARCHAR2,
 NEW_ACOMP_CR_DT           IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
T_ERR_NO NUMBER;
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
         IF NVL(NEW_ACOMP_MAIN_ACNT_CODE, '000000') !=
            NVL(OLD_ACOMP_MAIN_ACNT_CODE , '000000') OR
            NVL(NEW_ACOMP_SUB_ACNT_CODE, '000000') !=
            NVL(OLD_ACOMP_SUB_ACNT_CODE, '000000') THEN
               F_VAL_MAIN_SUB_COMBN(NEW_ACOMP_MAIN_ACNT_CODE,
                            NEW_ACOMP_SUB_ACNT_CODE, T_ERR_NO);
               IF T_ERR_NO != 0 THEN
                  RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,
                     'Main - Sub account combination not valid for company');
               END IF;
         END IF;
        NEW_ACOMP_CR_DT := SYSDATE;
        NEW_ACOMP_CR_UID := NVL(NEW_ACOMP_CR_UID,
                   NVL(OLD_ACOMP_CR_UID, 'UNDEF'));
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
         INSERT INTO FH_ACNT_COMP_HIST VALUES (OLD_ACOMP_COMP_CODE,
                                               OLD_ACOMP_MAIN_ACNT_CODE,
                                               OLD_ACOMP_SUB_ACNT_CODE,
                                               OLD_ACOMP_CR_UID,
                                               OLD_ACOMP_CR_DT);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACNT_CURR (
 OLD_ACURR_CURR_CODE       IN      VARCHAR2,
 OLD_ACURR_MAIN_ACNT_CODE  IN      VARCHAR2,
 OLD_ACURR_SUB_ACNT_CODE   IN      VARCHAR2,
 OLD_ACURR_CR_UID          IN      VARCHAR2,
 OLD_ACURR_CR_DT           IN      DATE,
 NEW_ACURR_CURR_CODE       IN OUT  VARCHAR2,
 NEW_ACURR_MAIN_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_ACURR_SUB_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_ACURR_CR_UID          IN OUT  VARCHAR2,
 NEW_ACURR_CR_DT           IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
T_ERR_NO NUMBER;
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
         IF NVL(NEW_ACURR_MAIN_ACNT_CODE, '000000') !=
            NVL(OLD_ACURR_MAIN_ACNT_CODE , '000000') OR
            NVL(NEW_ACURR_SUB_ACNT_CODE, '000000')
             != NVL(OLD_ACURR_SUB_ACNT_CODE, '000000') THEN
               F_VAL_ACNT_CURR_COMBN(NEW_ACURR_MAIN_ACNT_CODE,
              NEW_ACURR_SUB_ACNT_CODE, T_ERR_NO);
             IF T_ERR_NO != 0 THEN
                RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,
                           'Invalid Account - Currency combination');
             END IF;
         END IF;
         NEW_ACURR_CR_DT := SYSDATE;
         NEW_ACURR_CR_UID := NVL(NEW_ACURR_CR_UID,
                              NVL(OLD_ACURR_CR_UID, 'UNDEF'));
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
         INSERT INTO FH_ACNT_CURR_HIST VALUES (OLD_ACURR_CURR_CODE,
                                               OLD_ACURR_MAIN_ACNT_CODE,
                                               OLD_ACURR_SUB_ACNT_CODE,
                                               OLD_ACURR_CR_UID,
                                               OLD_ACURR_CR_DT);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACTIVITY (
 OLD_ACTY_CODE             IN      VARCHAR2,
 OLD_ACTY_NAME             IN      VARCHAR2,
 OLD_ACTY_CR_UID           IN      VARCHAR2,
 OLD_ACTY_CR_DT            IN      DATE,
 OLD_ACTY_FRZ_FLAG         IN      VARCHAR2,
 NEW_ACTY_CODE             IN OUT  VARCHAR2,
 NEW_ACTY_NAME             IN OUT  VARCHAR2,
 NEW_ACTY_CR_UID           IN OUT  VARCHAR2,
 NEW_ACTY_CR_DT            IN OUT  DATE,
 NEW_ACTY_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2 ,
 OLD_ACTY_BL_NAME          IN      VARCHAR2,
 NEW_ACTY_BL_NAME          IN OUT  VARCHAR2 ) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_ACTY_CR_DT := SYSDATE;
     NEW_ACTY_CR_UID := NVL(NEW_ACTY_CR_UID, NVL(OLD_ACTY_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
        INSERT INTO FH_ACTIVITY_HIST VALUES (OLD_ACTY_CODE,
                                             OLD_ACTY_NAME,
                                             OLD_ACTY_CR_UID,
                                             OLD_ACTY_CR_DT,
                                             OLD_ACTY_FRZ_FLAG ,
                                             OLD_ACTY_BL_NAME);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ACTY_VALUE (
 OLD_AVAL_ACTY_CODE        IN      VARCHAR2,
 OLD_AVAL_CODE             IN      VARCHAR2,
 OLD_AVAL_VALUE_NAME       IN      VARCHAR2,
 OLD_AVAL_SHORT_NAME       IN      VARCHAR2,
 OLD_AVAL_CR_UID           IN      VARCHAR2,
 OLD_AVAL_CR_DT            IN      DATE,
 OLD_AVAL_FRZ_FLAG         IN      VARCHAR2,
 NEW_AVAL_ACTY_CODE        IN OUT  VARCHAR2,
 NEW_AVAL_CODE             IN OUT  VARCHAR2,
 NEW_AVAL_VALUE_NAME       IN OUT  VARCHAR2,
 NEW_AVAL_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_AVAL_CR_UID           IN OUT  VARCHAR2,
 NEW_AVAL_CR_DT            IN OUT  DATE,
 NEW_AVAL_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2 ,
 OLD_AVAL_BL_VALUE_NAME    IN      VARCHAR2,
 NEW_AVAL_BL_VALUE_NAME    IN OUT  VARCHAR2,
 OLD_AVAL_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_AVAL_BL_SHORT_NAME    IN OUT  VARCHAR2 ) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_AVAL_CR_DT := SYSDATE;
     NEW_AVAL_CR_UID := NVL(NEW_AVAL_CR_UID, NVL(OLD_AVAL_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
      INSERT INTO FH_ACTY_VALUE_HIST VALUES (OLD_AVAL_ACTY_CODE,
                                             OLD_AVAL_CODE,
                                             OLD_AVAL_VALUE_NAME,
                                             OLD_AVAL_SHORT_NAME,
                                             OLD_AVAL_CR_UID,
                                             OLD_AVAL_CR_DT,
                                             OLD_AVAL_FRZ_FLAG,
                                             OLD_AVAL_BL_VALUE_NAME,
                                             OLD_AVAL_BL_SHORT_NAME);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ANALYSIS (
 OLD_ANLY_HEAD_NO          IN      NUMBER,
 OLD_ANLY_CODE             IN      VARCHAR2,
 OLD_ANLY_NAME             IN      VARCHAR2,
 OLD_ANLY_SHORT_NAME       IN      VARCHAR2,
 OLD_ANLY_DESC             IN      VARCHAR2,
 OLD_ANLY_CR_UID           IN      VARCHAR2,
 OLD_ANLY_CR_DT            IN      DATE,
 OLD_ANLY_FRZ_FLAG         IN      VARCHAR2,
 NEW_ANLY_HEAD_NO          IN OUT  NUMBER,
 NEW_ANLY_CODE             IN OUT  VARCHAR2,
 NEW_ANLY_NAME             IN OUT  VARCHAR2,
 NEW_ANLY_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_ANLY_DESC             IN OUT  VARCHAR2,
 NEW_ANLY_CR_UID           IN OUT  VARCHAR2,
 NEW_ANLY_CR_DT            IN OUT  DATE,
 NEW_ANLY_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_ANLY_BL_NAME          IN      VARCHAR2,
 NEW_ANLY_BL_NAME          IN OUT  VARCHAR2,
 OLD_ANLY_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_ANLY_BL_SHORT_NAME    IN OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_ANLY_CR_DT := SYSDATE;
     NEW_ANLY_CR_UID := NVL(NEW_ANLY_CR_UID, NVL(OLD_ANLY_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_ANALYSIS_HIST VALUES (OLD_ANLY_HEAD_NO,    OLD_ANLY_CODE,
                                          OLD_ANLY_NAME,
                                          OLD_ANLY_SHORT_NAME, OLD_ANLY_DESC,
                                          OLD_ANLY_CR_UID,
                                          OLD_ANLY_CR_DT,
                                          OLD_ANLY_FRZ_FLAG,
                                          OLD_ANLY_BL_NAME,
                                          OLD_ANLY_BL_SHORT_NAME) ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ANLY_FORMAT (
 OLD_AFM_HEAD_NO           IN      NUMBER,
 OLD_AFM_FORMAT_ID         IN      NUMBER,
 OLD_AFM_FORMAT_NAME       IN      VARCHAR2,
 OLD_AFM_CR_UID            IN      VARCHAR2,
 OLD_AFM_CR_DT             IN      DATE,
 OLD_AFM_FRZ_FLAG          IN      VARCHAR2,
 NEW_AFM_HEAD_NO           IN OUT  NUMBER,
 NEW_AFM_FORMAT_ID         IN OUT  NUMBER,
 NEW_AFM_FORMAT_NAME       IN OUT  VARCHAR2,
 NEW_AFM_CR_UID            IN OUT  VARCHAR2,
 NEW_AFM_CR_DT             IN OUT  DATE,
 NEW_AFM_FRZ_FLAG          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_AFM_BL_FORMAT_NAME    IN      VARCHAR2,
 NEW_AFM_BL_FORMAT_NAME    IN OUT  VARCHAR2) AS
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
          NEW_AFM_CR_DT := SYSDATE;
          NEW_AFM_CR_UID := NVL(NEW_AFM_CR_UID,
                               NVL(OLD_AFM_CR_UID, 'UNDEF'));
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
        INSERT INTO FH_ANLY_FORMAT_HIST VALUES (OLD_AFM_HEAD_NO,
                                                OLD_AFM_FORMAT_ID,
                                                OLD_AFM_FORMAT_NAME,
                                                OLD_AFM_CR_UID,
                                                OLD_AFM_CR_DT,
                                                OLD_AFM_FRZ_FLAG,
                                                OLD_AFM_BL_FORMAT_NAME) ;
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_ANLY_LEVEL (
 OLD_ALM_HEAD_NO           IN      NUMBER,
 OLD_ALM_FORMAT_ID         IN      NUMBER,
 OLD_ALM_LVL_CODE          IN      NUMBER,
 OLD_ALM_LVL_NAME          IN      VARCHAR2,
 OLD_ALM_PARENT_CODE       IN      NUMBER,
 OLD_ALM_CR_UID            IN      VARCHAR2,
 OLD_ALM_CR_DT             IN      DATE,
 OLD_ALM_FRZ_FLAG          IN      VARCHAR2,
 NEW_ALM_HEAD_NO           IN OUT  NUMBER,
 NEW_ALM_FORMAT_ID         IN OUT  NUMBER,
 NEW_ALM_LVL_CODE          IN OUT  NUMBER,
 NEW_ALM_LVL_NAME          IN OUT  VARCHAR2,
 NEW_ALM_PARENT_CODE       IN OUT  NUMBER,
 NEW_ALM_CR_UID            IN OUT  VARCHAR2,
 NEW_ALM_CR_DT             IN OUT  DATE,
 NEW_ALM_FRZ_FLAG          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_ALM_BL_LVL_NAME       IN      VARCHAR2,
 NEW_ALM_BL_LVL_NAME       IN OUT  VARCHAR2) AS
   T_ERR_NO NUMBER;
   T_MSG   CHAR;
BEGIN
T_MSG := '';
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NVL(NEW_ALM_FORMAT_ID, 0)   != NVL(OLD_ALM_FORMAT_ID, 0)   OR
        NVL(NEW_ALM_PARENT_CODE, 0) != NVL(OLD_ALM_PARENT_CODE, 0)    THEN
        F_VAL_ANLY_PARENT_LEVEL(NEW_ALM_HEAD_NO, NEW_ALM_FORMAT_ID,
                                NEW_ALM_PARENT_CODE, T_ERR_NO);
       IF T_ERR_NO != 0 THEN
           RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
       END IF;
     END IF;
     NEW_ALM_CR_DT := SYSDATE;
     NEW_ALM_CR_UID := NVL(NEW_ALM_CR_UID, NVL(OLD_ALM_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_ANLY_LEVEL_HIST VALUES (OLD_ALM_HEAD_NO,
                                            OLD_ALM_FORMAT_ID,
                                            OLD_ALM_LVL_CODE,
                                            OLD_ALM_LVL_NAME,
                                            OLD_ALM_PARENT_CODE,
                                            OLD_ALM_CR_UID,
                                            OLD_ALM_CR_DT,
                                            OLD_ALM_FRZ_FLAG,
                                            OLD_ALM_BL_LVL_NAME) ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_COA_ACNT_FORMAT (
 OLD_CAF_FORMAT_ID         IN      NUMBER,
 OLD_CAF_LVL_CODE          IN      NUMBER,
 OLD_CAF_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_CAF_CR_UID            IN      VARCHAR2,
 OLD_CAF_CR_DT             IN      DATE,
 NEW_CAF_FORMAT_ID         IN OUT  NUMBER,
 NEW_CAF_LVL_CODE          IN OUT  NUMBER,
 NEW_CAF_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_CAF_CR_UID            IN OUT  VARCHAR2,
 NEW_CAF_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
T_ERR_NO NUMBER(6);
T_MSG    VARCHAR2(80);
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
   IF NVL(NEW_CAF_FORMAT_ID, 0) != NVL(OLD_CAF_FORMAT_ID,0) OR
      NVL(NEW_CAF_LVL_CODE,0)   != NVL(OLD_CAF_LVL_CODE,0)      THEN
      F_VAL_DETAIL_LEVEL(NEW_CAF_FORMAT_ID, NEW_CAF_LVL_CODE, T_ERR_NO);
      IF T_ERR_NO != 0 THEN
         RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
      END IF;
   END IF;
   NEW_CAF_CR_DT := SYSDATE;
   NEW_CAF_CR_UID := NVL(NEW_CAF_CR_UID, NVL(OLD_CAF_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_COA_ACNT_FORMAT_HIST VALUES (OLD_CAF_FORMAT_ID,
                                                 OLD_CAF_LVL_CODE,
                                                 OLD_CAF_MAIN_ACNT_CODE,
                                                 OLD_CAF_CR_UID,
                                                 OLD_CAF_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_COA_FORMAT (
 OLD_COA_FORMAT_ID         IN      NUMBER,
 OLD_COA_FORMAT_NAME       IN      VARCHAR2,
 OLD_COA_CR_UID            IN      VARCHAR2,
 OLD_COA_CR_DT             IN      DATE,
 OLD_COA_FRZ_FLAG          IN      VARCHAR2,
 NEW_COA_FORMAT_ID         IN OUT  NUMBER,
 NEW_COA_FORMAT_NAME       IN OUT  VARCHAR2,
 NEW_COA_CR_UID            IN OUT  VARCHAR2,
 NEW_COA_CR_DT             IN OUT  DATE,
 NEW_COA_FRZ_FLAG          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_COA_BL_FORMAT_NAME    IN      VARCHAR2,
 NEW_COA_BL_FORMAT_NAME    IN OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_COA_CR_DT := SYSDATE;
     NEW_COA_CR_UID := NVL(NEW_COA_CR_UID, NVL(OLD_COA_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_COA_FORMAT_HIST VALUES
         (OLD_COA_FORMAT_ID,OLD_COA_FORMAT_NAME,
          OLD_COA_CR_UID, OLD_COA_CR_DT, OLD_COA_FRZ_FLAG,
          OLD_COA_BL_FORMAT_NAME);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_COA_LEVEL (
 OLD_LVL_FORMAT_ID         IN      NUMBER,
 OLD_LVL_CODE              IN      NUMBER,
 OLD_LVL_NAME              IN      VARCHAR2,
 OLD_LVL_PARENT_CODE       IN      NUMBER,
 OLD_LVL_ACNT_TYPE         IN      VARCHAR2,
 OLD_LVL_TOTAL_FLAG        IN      VARCHAR2,
 OLD_LVL_NOTE_NO           IN      VARCHAR2,
 OLD_LVL_SEQ_NO            IN      NUMBER,
 OLD_LVL_CR_UID            IN      VARCHAR2,
 OLD_LVL_CR_DT             IN      DATE,
 OLD_LVL_FRZ_FLAG          IN      VARCHAR2,
 NEW_LVL_FORMAT_ID         IN OUT  NUMBER,
 NEW_LVL_CODE              IN OUT  NUMBER,
 NEW_LVL_NAME              IN OUT  VARCHAR2,
 NEW_LVL_PARENT_CODE       IN OUT  NUMBER,
 NEW_LVL_ACNT_TYPE         IN OUT  VARCHAR2,
 NEW_LVL_TOTAL_FLAG        IN OUT  VARCHAR2,
 NEW_LVL_NOTE_NO           IN OUT  VARCHAR2,
 NEW_LVL_SEQ_NO            IN OUT  NUMBER,
 NEW_LVL_CR_UID            IN OUT  VARCHAR2,
 NEW_LVL_CR_DT             IN OUT  DATE,
 NEW_LVL_FRZ_FLAG          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_LVL_BL_NAME           IN      VARCHAR2,
 NEW_LVL_BL_NAME           IN OUT  VARCHAR2) AS
T_ERR_NO NUMBER;
T_MSG   CHAR;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NEW_LVL_PARENT_CODE != NVL(OLD_LVL_PARENT_CODE,0) THEN
          F_VAL_PARENT_LEVEL(NEW_LVL_FORMAT_ID,
                     NEW_LVL_PARENT_CODE, T_ERR_NO);
          IF T_ERR_NO != 0 THEN
             RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
          END IF;
     END IF;
     NEW_LVL_CR_DT := SYSDATE;
     NEW_LVL_CR_UID := NVL(NEW_LVL_CR_UID, NVL(OLD_LVL_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_COA_LEVEL_HIST VALUES
          (OLD_LVL_FORMAT_ID,   OLD_LVL_CODE,     OLD_LVL_NAME,
           OLD_LVL_PARENT_CODE, OLD_LVL_ACNT_TYPE, OLD_LVL_TOTAL_FLAG,
           OLD_LVL_NOTE_NO,     OLD_LVL_SEQ_NO,    OLD_LVL_CR_UID,
           OLD_LVL_CR_DT,       OLD_LVL_FRZ_FLAG, OLD_LVL_BL_NAME);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_COMPANY (
 OLD_COMP_CODE             IN      VARCHAR2,
 OLD_COMP_NAME             IN      VARCHAR2,
 OLD_COMP_SHORT_NAME       IN      VARCHAR2,
 OLD_COMP_CTL_ACNT_CODE    IN      VARCHAR2,
 OLD_COMP_HEADER           IN      VARCHAR2,
 OLD_COMP_ADD_1            IN      VARCHAR2,
 OLD_COMP_ADD_2            IN      VARCHAR2,
 OLD_COMP_ADD_3            IN      VARCHAR2,
 OLD_COMP_DFLT_DIVN_CODE   IN      VARCHAR2,
 OLD_COMP_DFLT_DEPT_CODE   IN      VARCHAR2,
 OLD_COMP_CR_UID           IN      VARCHAR2,
 OLD_COMP_CR_DT            IN      DATE,
 OLD_COMP_FRZ_FLAG         IN      VARCHAR2,
 NEW_COMP_CODE             IN OUT  VARCHAR2,
 NEW_COMP_NAME             IN OUT  VARCHAR2,
 NEW_COMP_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_COMP_CTL_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_COMP_HEADER           IN OUT  VARCHAR2,
 NEW_COMP_ADD_1            IN OUT  VARCHAR2,
 NEW_COMP_ADD_2            IN OUT  VARCHAR2,
 NEW_COMP_ADD_3            IN OUT  VARCHAR2,
 NEW_COMP_DFLT_DIVN_CODE   IN OUT  VARCHAR2,
 NEW_COMP_DFLT_DEPT_CODE   IN OUT  VARCHAR2,
 NEW_COMP_CR_UID           IN OUT  VARCHAR2,
 NEW_COMP_CR_DT            IN OUT  DATE,
 NEW_COMP_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_COMP_BL_NAME          IN      VARCHAR2,
 NEW_COMP_BL_NAME          IN OUT  VARCHAR2,
 OLD_COMP_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_COMP_BL_SHORT_NAME    IN OUT  VARCHAR2,
 OLD_COMP_BL_ADD_1         IN      VARCHAR2,
 NEW_COMP_BL_ADD_1         IN OUT  VARCHAR2,
 OLD_COMP_BL_ADD_2         IN      VARCHAR2,
 NEW_COMP_BL_ADD_2         IN OUT  VARCHAR2,
 OLD_COMP_BL_ADD_3         IN      VARCHAR2,
 NEW_COMP_BL_ADD_3         IN OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_COMP_CR_DT := SYSDATE;
Press <Enter> to continue...
     NEW_COMP_CR_UID := NVL(NEW_COMP_CR_UID, NVL(OLD_COMP_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
    INSERT INTO FH_COMPANY_HIST VALUES
           (OLD_COMP_CODE, OLD_COMP_NAME, OLD_COMP_SHORT_NAME,
            OLD_COMP_CTL_ACNT_CODE, OLD_COMP_HEADER, OLD_COMP_ADD_1,
            OLD_COMP_ADD_2,  OLD_COMP_ADD_3, OLD_COMP_DFLT_DIVN_CODE,
            OLD_COMP_DFLT_DEPT_CODE, OLD_COMP_CR_UID, OLD_COMP_CR_DT,
            OLD_COMP_FRZ_FLAG,OLD_COMP_BL_NAME, OLD_COMP_BL_SHORT_NAME,
            OLD_COMP_BL_ADD_1 , OLD_COMP_BL_ADD_2, OLD_COMP_BL_ADD_3);
    IF TRG_MODE = 'D' THEN
          DELETE FROM FM_ACNT_PERIOD
          WHERE  APER_COMP_CODE = OLD_COMP_CODE;
    END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_CURRENCY (
 OLD_CURR_CODE             IN      VARCHAR2,
 OLD_CURR_NAME             IN      VARCHAR2,
 OLD_CURR_DECIMAL          IN      NUMBER,
 OLD_CURR_UNIT_NAME        IN      VARCHAR2,
 OLD_CURR_CR_UID           IN      VARCHAR2,
 OLD_CURR_CR_DT            IN      DATE,
 OLD_CURR_FRZ_FLAG         IN      VARCHAR2,
 NEW_CURR_CODE             IN OUT  VARCHAR2,
 NEW_CURR_NAME             IN OUT  VARCHAR2,
 NEW_CURR_DECIMAL          IN OUT  NUMBER,
 NEW_CURR_UNIT_NAME        IN OUT  VARCHAR2,
 NEW_CURR_CR_UID           IN OUT  VARCHAR2,
 NEW_CURR_CR_DT            IN OUT  DATE,
 NEW_CURR_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_CURR_BL_NAME          IN      VARCHAR2,
 NEW_CURR_BL_NAME          IN OUT  VARCHAR2,
 OLD_CURR_BL_UNIT_NAME     IN      VARCHAR2,
 NEW_CURR_BL_UNIT_NAME     IN OUT  VARCHAR2) AS
           P_PARA_VALUE VARCHAR2(50);
            CURSOR FET_BASE_CURR IS
                 SELECT PARA_VALUE
                 FROM FP_PARAMETER
                 WHERE PARA_ID = 'BASE.CURR';
BEGIN
             IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
                  NEW_CURR_CR_DT := SYSDATE;
                  NEW_CURR_CR_UID := NVL(NEW_CURR_CR_UID,
                                       NVL(OLD_CURR_CR_UID, 'UNDEF'));
             END IF;
            IF FET_BASE_CURR%ISOPEN THEN
                 CLOSE FET_BASE_CURR;
            END IF;
            OPEN FET_BASE_CURR;
            IF TRG_MODE = 'D' THEN
                FETCH FET_BASE_CURR INTO P_PARA_VALUE;
                  IF FET_BASE_CURR%FOUND THEN
                     IF P_PARA_VALUE = OLD_CURR_CODE THEN
                        CLOSE FET_BASE_CURR;
                        RAISE_APPLICATION_ERROR
                                   (-20004, 'Cannot delete base currency');
                     END IF;
                  END IF;
            END IF;
           IF TRG_MODE = 'I' THEN
            FETCH FET_BASE_CURR INTO P_PARA_VALUE;
            IF FET_BASE_CURR%FOUND THEN
                IF P_PARA_VALUE = NEW_CURR_CODE THEN
                 INSERT INTO FM_EXCHANGE_RATE (CER_CURR_CODE,
                                               CER_EFF_FRM_DT,
                                               CER_EFF_TO_DT,
                                               CER_BUY_EXGE_RATE,
                                               CER_SELL_EXGE_RATE,
                                               CER_CR_UID,
                                               CER_CR_DT)
                                       VALUES (NEW_CURR_CODE,
                                               '01-JAN-01',
                                               '31-DEC-99',
                                               1 ,
                                               1,
                                               NEW_CURR_CR_UID,
                                               NEW_CURR_CR_DT);
               END IF;
            END IF;
            CLOSE FET_BASE_CURR;
            END IF;
            IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
                  INSERT INTO FH_CURRENCY_HIST VALUES (OLD_CURR_CODE,
                                                       OLD_CURR_NAME,
                                                       OLD_CURR_DECIMAL,
                                                       OLD_CURR_UNIT_NAME,
                                                       OLD_CURR_CR_UID,
                                                       OLD_CURR_CR_DT,
                                                       OLD_CURR_FRZ_FLAG,
                                                       OLD_CURR_BL_NAME,
                                                       OLD_CURR_BL_UNIT_NAME) ;
            END IF;
          END;
/
CREATE OR REPLACE PROCEDURE STP_FM_CUSTOMER (
 OLD_CUST_CODE             IN      VARCHAR2,
 OLD_CUST_NAME             IN      VARCHAR2,
 OLD_CUST_SHORT_NAME       IN      VARCHAR2,
 OLD_CUST_ADD_1            IN      VARCHAR2,
 OLD_CUST_ADD_2            IN      VARCHAR2,
 OLD_CUST_ADD_3            IN      VARCHAR2,
 OLD_CUST_COUNTRY          IN      VARCHAR2,
 OLD_CUST_PHONE            IN      VARCHAR2,
 OLD_CUST_TELEX_FAX        IN      VARCHAR2,
 OLD_CUST_MAIN_ACNT_CODE   IN      VARCHAR2,
 OLD_CUST_CR_LMT_AMT       IN      NUMBER,
 OLD_CUST_CR_LMT_DAYS      IN      NUMBER,
 OLD_CUST_CONTACT          IN      VARCHAR2,
 OLD_CUST_AREA             IN      VARCHAR2,
 OLD_CUST_SM               IN      VARCHAR2,
 OLD_CUST_DESC             IN      VARCHAR2,
 OLD_CUST_CR_UID           IN      VARCHAR2,
 OLD_CUST_CR_DT            IN      DATE,
 OLD_CUST_FRZ_FLAG         IN      VARCHAR2,
 OLD_CUST_FAX              IN      VARCHAR2,
 NEW_CUST_CODE             IN OUT  VARCHAR2,
 NEW_CUST_NAME             IN OUT  VARCHAR2,
 NEW_CUST_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_CUST_ADD_1            IN OUT  VARCHAR2,
 NEW_CUST_ADD_2            IN OUT  VARCHAR2,
 NEW_CUST_ADD_3            IN OUT  VARCHAR2,
 NEW_CUST_COUNTRY          IN OUT  VARCHAR2,
 NEW_CUST_PHONE            IN OUT  VARCHAR2,
 NEW_CUST_TELEX_FAX        IN OUT  VARCHAR2,
 NEW_CUST_MAIN_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_CUST_CR_LMT_AMT       IN OUT  NUMBER,
 NEW_CUST_CR_LMT_DAYS      IN OUT  NUMBER,
 NEW_CUST_CONTACT          IN OUT  VARCHAR2,
 NEW_CUST_AREA             IN OUT  VARCHAR2,
 NEW_CUST_SM               IN OUT  VARCHAR2,
 NEW_CUST_DESC             IN OUT  VARCHAR2,
 NEW_CUST_CR_UID           IN OUT  VARCHAR2,
 NEW_CUST_CR_DT            IN OUT  DATE,
 NEW_CUST_FRZ_FLAG         IN OUT  VARCHAR2,
 NEW_CUST_FAX              IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_CUST_BL_NAME          IN      VARCHAR2,
 NEW_CUST_BL_NAME          IN OUT  VARCHAR2,
 OLD_CUST_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_CUST_BL_SHORT_NAME    IN OUT  VARCHAR2,
 OLD_CUST_BL_ADD_1         IN      VARCHAR2,
 NEW_CUST_BL_ADD_1         IN OUT  VARCHAR2,
 OLD_CUST_BL_ADD_2         IN      VARCHAR2,
 NEW_CUST_BL_ADD_2         IN OUT  VARCHAR2,
 OLD_CUST_BL_ADD_3         IN      VARCHAR2,
 NEW_CUST_BL_ADD_3         IN OUT  VARCHAR2) AS
CURSOR F_PARA IS
SELECT PARA_VALUE
FROM   FP_PARAMETER
WHERE  PARA_ID = 'UNIQUE.SUBACNT' ;
P_ERR_NO      NUMBER ;
P_PARA_VALUE  VARCHAR2(1);
CURSOR SEL_SUB IS
SELECT SUB_ACNT_NAME, SUB_ACNT_SHORT_NAME
FROM   FM_SUB_ACCOUNT
WHERE  SUB_ACNT_CODE = NEW_CUST_CODE
FOR UPDATE OF SUB_ACNT_NAME, SUB_ACNT_SHORT_NAME;
P_SUB_ACNT_NAME        VARCHAR2(30);
P_SUB_ACNT_SHORT_NAME  VARCHAR2(30);
CURSOR SEL_MS IS
SELECT 'X'
FROM   FM_MAIN_SUB
WHERE  MS_SUB_ACNT_CODE = OLD_CUST_CODE;
P_DUMMY          VARCHAR2(1);
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
        NEW_CUST_CR_DT := SYSDATE;
        NEW_CUST_CR_UID := NVL(NEW_CUST_CR_UID,
                             NVL(OLD_CUST_CR_UID, 'UNDEF'));
        IF SEL_SUB%ISOPEN THEN
             CLOSE SEL_SUB;
        END IF;
        OPEN SEL_SUB;
        FETCH SEL_SUB INTO P_SUB_ACNT_NAME, P_SUB_ACNT_SHORT_NAME;
        IF SEL_SUB%NOTFOUND THEN
            INSERT INTO FM_SUB_ACCOUNT (SUB_ACNT_CODE,
                                        SUB_ACNT_NAME,
                                        SUB_ACNT_SHORT_NAME,
                                        SUB_CR_UID,
                                        SUB_CR_DT,
                                        SUB_FRZ_FLAG,
                                        SUB_BL_ACNT_NAME,
                                        SUB_BL_ACNT_SHORT_NAME)
                                VALUES (NEW_CUST_CODE,
                                        NEW_CUST_NAME,
                                        NEW_CUST_SHORT_NAME,
                                        NEW_CUST_CR_UID,
                                        NEW_CUST_CR_DT,'N',
                                        NEW_CUST_BL_NAME,
                                        NEW_CUST_BL_SHORT_NAME);
        ELSE
            OPEN F_PARA ;
            FETCH F_PARA INTO P_PARA_VALUE ;
            IF F_PARA%NOTFOUND THEN
               CLOSE SEL_SUB ;
               CLOSE F_PARA ;
               RAISE_APPLICATION_ERROR(-20011,'Parameter not defined');
            END IF;
            CLOSE F_PARA ;
            IF P_PARA_VALUE = 'Y' THEN
                 IF NEW_CUST_NAME != P_SUB_ACNT_NAME OR
                    NVL(NEW_CUST_SHORT_NAME,'X') !=
                    NVL(P_SUB_ACNT_SHORT_NAME,'X') THEN
                    UPDATE FM_SUB_ACCOUNT
                    SET    SUB_ACNT_NAME = NEW_CUST_NAME,
                           SUB_ACNT_SHORT_NAME = NEW_CUST_SHORT_NAME,
                           SUB_BL_ACNT_NAME = NEW_CUST_BL_NAME,
                           SUB_BL_ACNT_SHORT_NAME = NEW_CUST_BL_SHORT_NAME
                    WHERE  CURRENT OF SEL_SUB;
                 END IF;
            END IF;
        END IF;
        CLOSE SEL_SUB;
     END IF;
     IF TRG_MODE = 'I' THEN
        INSERT INTO FM_MAIN_SUB    (MS_MAIN_ACNT_CODE,
                                    MS_SUB_ACNT_CODE,
                                    MS_SUB_ACNT_NAME,
                                    MS_SUB_ACNT_SHORT_NAME,
                                    MS_CR_UID,
                                    MS_CR_DT,
                                    MS_BL_SUB_ACNT_NAME,
                                    MS_BL_SUB_ACNT_SHORT_NAME)
                            VALUES (NEW_CUST_MAIN_ACNT_CODE,
                                    NEW_CUST_CODE,
                                    NEW_CUST_NAME,
                                    NEW_CUST_SHORT_NAME,
                                    NEW_CUST_CR_UID,
                                    NEW_CUST_CR_DT,
                                    NEW_CUST_BL_NAME,
                                    NEW_CUST_BL_SHORT_NAME);
    END IF;
    IF TRG_MODE = 'U' THEN
        IF NEW_CUST_MAIN_ACNT_CODE  != OLD_CUST_MAIN_ACNT_CODE THEN
            UPDATE  FM_MAIN_SUB
               SET  MS_MAIN_ACNT_CODE = NEW_CUST_MAIN_ACNT_CODE
             WHERE  MS_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE
             AND    MS_SUB_ACNT_CODE  = NEW_CUST_CODE;
            UPDATE  FM_ACNT_COMP
               SET  ACOMP_MAIN_ACNT_CODE = NEW_CUST_MAIN_ACNT_CODE
             WHERE  ACOMP_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE;
            UPDATE  FM_ACNT_CURR
               SET  ACURR_MAIN_ACNT_CODE = NEW_CUST_MAIN_ACNT_CODE
             WHERE  ACURR_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE
             AND    ACURR_SUB_ACNT_CODE  = NEW_CUST_CODE;
         END IF;
     END IF;
     IF TRG_MODE = 'D' THEN
        DELETE  FM_MAIN_SUB
        WHERE   MS_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE
        AND     MS_SUB_ACNT_CODE  = OLD_CUST_CODE;
        IF SEL_MS%ISOPEN THEN
             CLOSE SEL_MS;
        END IF;
        OPEN SEL_MS;
        FETCH SEL_MS INTO P_DUMMY;
        IF SEL_MS%NOTFOUND THEN
             DELETE  FM_SUB_ACCOUNT
             WHERE   SUB_ACNT_CODE     = OLD_CUST_CODE;
        END IF;
        CLOSE SEL_MS;
        DELETE  FM_ACNT_COMP
        WHERE   ACOMP_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE
        AND     ACOMP_SUB_ACNT_CODE  = OLD_CUST_CODE;
        DELETE  FM_ACNT_CURR
        WHERE   ACURR_MAIN_ACNT_CODE = OLD_CUST_MAIN_ACNT_CODE
        AND     ACURR_SUB_ACNT_CODE  = OLD_CUST_CODE;
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
        INSERT INTO FH_CUSTOMER_HIST  VALUES
                     (OLD_CUST_CODE, OLD_CUST_NAME,
                      OLD_CUST_SHORT_NAME, OLD_CUST_ADD_1,
                      OLD_CUST_ADD_2, OLD_CUST_ADD_3,
                      OLD_CUST_COUNTRY, OLD_CUST_PHONE,
                      OLD_CUST_TELEX_FAX, OLD_CUST_MAIN_ACNT_CODE,
                      OLD_CUST_CR_LMT_AMT, OLD_CUST_CR_LMT_DAYS,
                      OLD_CUST_CONTACT, OLD_CUST_AREA, OLD_CUST_SM,
                      OLD_CUST_DESC, OLD_CUST_CR_UID,
                      OLD_CUST_CR_DT, OLD_CUST_FRZ_FLAG, OLD_CUST_FAX,
                      OLD_CUST_BL_NAME, OLD_CUST_BL_SHORT_NAME,
                      OLD_CUST_BL_ADD_1,OLD_CUST_BL_ADD_2,OLD_CUST_BL_ADD_3);
      END IF;
 END;
/
CREATE OR REPLACE PROCEDURE STP_FM_DEPARTMENT (
 OLD_DEPT_COMP_CODE        IN      VARCHAR2,
 OLD_DEPT_DIVN_CODE        IN      VARCHAR2,
 OLD_DEPT_CODE             IN      VARCHAR2,
 OLD_DEPT_NAME             IN      VARCHAR2,
 OLD_DEPT_SHORT_NAME       IN      VARCHAR2,
 OLD_DEPT_HEADER           IN      VARCHAR2,
 OLD_DEPT_INCHARGE         IN      VARCHAR2,
 OLD_DEPT_CR_UID           IN      VARCHAR2,
 OLD_DEPT_CR_DT            IN      DATE,
 OLD_DEPT_FRZ_FLAG         IN      VARCHAR2,
 NEW_DEPT_COMP_CODE        IN OUT  VARCHAR2,
 NEW_DEPT_DIVN_CODE        IN OUT  VARCHAR2,
 NEW_DEPT_CODE             IN OUT  VARCHAR2,
 NEW_DEPT_NAME             IN OUT  VARCHAR2,
 NEW_DEPT_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_DEPT_HEADER           IN OUT  VARCHAR2,
 NEW_DEPT_INCHARGE         IN OUT  VARCHAR2,
 NEW_DEPT_CR_UID           IN OUT  VARCHAR2,
 NEW_DEPT_CR_DT            IN OUT  DATE,
 NEW_DEPT_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_DEPT_BL_NAME          IN      VARCHAR2,
 NEW_DEPT_BL_NAME          IN OUT  VARCHAR2,
 OLD_DEPT_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_DEPT_BL_SHORT_NAME    IN OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_DEPT_CR_DT := SYSDATE;
     NEW_DEPT_CR_UID := NVL(NEW_DEPT_CR_UID, NVL(OLD_DEPT_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_DEPARTMENT_HIST VALUES
           (OLD_DEPT_COMP_CODE, OLD_DEPT_DIVN_CODE,
            OLD_DEPT_CODE,      OLD_DEPT_NAME,      OLD_DEPT_SHORT_NAME,
            OLD_DEPT_HEADER,    OLD_DEPT_INCHARGE,  OLD_DEPT_CR_UID,
            OLD_DEPT_CR_DT,     OLD_DEPT_FRZ_FLAG,
	    OLD_DEPT_BL_NAME,   OLD_DEPT_BL_SHORT_NAME) ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_DIVISION (
 OLD_DIVN_COMP_CODE        IN      VARCHAR2,
 OLD_DIVN_CODE             IN      VARCHAR2,
 OLD_DIVN_NAME             IN      VARCHAR2,
 OLD_DIVN_SHORT_NAME       IN      VARCHAR2,
 OLD_DIVN_HEADER           IN      VARCHAR2,
 OLD_DIVN_INCHARGE         IN      VARCHAR2,
 OLD_DIVN_CR_UID           IN      VARCHAR2,
 OLD_DIVN_CR_DT            IN      DATE,
 OLD_DIVN_FRZ_FLAG         IN      VARCHAR2,
 NEW_DIVN_COMP_CODE        IN OUT  VARCHAR2,
 NEW_DIVN_CODE             IN OUT  VARCHAR2,
 NEW_DIVN_NAME             IN OUT  VARCHAR2,
 NEW_DIVN_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_DIVN_HEADER           IN OUT  VARCHAR2,
 NEW_DIVN_INCHARGE         IN OUT  VARCHAR2,
 NEW_DIVN_CR_UID           IN OUT  VARCHAR2,
 NEW_DIVN_CR_DT            IN OUT  DATE,
 NEW_DIVN_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_DIVN_BL_NAME          IN      VARCHAR2,
 NEW_DIVN_BL_NAME          IN OUT  VARCHAR2,
 OLD_DIVN_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_DIVN_BL_SHORT_NAME    IN OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_DIVN_CR_DT := SYSDATE;
     NEW_DIVN_CR_UID := NVL(NEW_DIVN_CR_UID, NVL(OLD_DIVN_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_DIVISION_HIST  VALUES
          (OLD_DIVN_COMP_CODE,  OLD_DIVN_CODE,   OLD_DIVN_NAME ,
           OLD_DIVN_SHORT_NAME, OLD_DIVN_HEADER, OLD_DIVN_INCHARGE,
           OLD_DIVN_CR_UID,     OLD_DIVN_CR_DT,  OLD_DIVN_FRZ_FLAG,
           OLD_DIVN_BL_NAME, OLD_DIVN_BL_SHORT_NAME);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_MAIN_ACCOUNT (
 OLD_MAIN_ACNT_CODE        IN      VARCHAR2,
 OLD_MAIN_ACNT_NAME        IN      VARCHAR2,
 OLD_MAIN_ACNT_SHORT_NAME  IN      VARCHAR2,
 OLD_MAIN_ACNT_CATG        IN      VARCHAR2,
 OLD_MAIN_CTL_ACNT_FLAG    IN      VARCHAR2,
 OLD_MAIN_ACTY_CODE_1      IN      VARCHAR2,
 OLD_MAIN_ACTY_CODE_2      IN      VARCHAR2,
 OLD_MAIN_ACNT_TYPE        IN      VARCHAR2,
 OLD_MAIN_OPEN_ENTRY_FLAG  IN      VARCHAR2,
 OLD_MAIN_DESC             IN      VARCHAR2,
 OLD_MAIN_CR_UID           IN      VARCHAR2,
 OLD_MAIN_CR_DT            IN      DATE,
 OLD_MAIN_FRZ_FLAG         IN      VARCHAR2,
 NEW_MAIN_ACNT_CODE        IN OUT  VARCHAR2,
 NEW_MAIN_ACNT_NAME        IN OUT  VARCHAR2,
 NEW_MAIN_ACNT_SHORT_NAME  IN OUT  VARCHAR2,
 NEW_MAIN_ACNT_CATG        IN OUT  VARCHAR2,
 NEW_MAIN_CTL_ACNT_FLAG    IN OUT  VARCHAR2,
 NEW_MAIN_ACTY_CODE_1      IN OUT  VARCHAR2,
 NEW_MAIN_ACTY_CODE_2      IN OUT  VARCHAR2,
 NEW_MAIN_ACNT_TYPE        IN OUT  VARCHAR2,
 NEW_MAIN_OPEN_ENTRY_FLAG  IN OUT  VARCHAR2,
 NEW_MAIN_DESC             IN OUT  VARCHAR2,
 NEW_MAIN_CR_UID           IN OUT  VARCHAR2,
 NEW_MAIN_CR_DT            IN OUT  DATE,
 NEW_MAIN_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_MAIN_BL_ACNT_NAME        IN      VARCHAR2,
 NEW_MAIN_BL_ACNT_NAME        IN OUT  VARCHAR2,
 OLD_MAIN_BL_ACNT_SHORT_NAME  IN      VARCHAR2,
 NEW_MAIN_BL_ACNT_SHORT_NAME  IN OUT  VARCHAR2) AS
T_ERR_NO NUMBER;
T_MSG CHAR;
T_FLAG CHAR;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
       IF NVL(NEW_MAIN_ACTY_CODE_1,'000000') !=
          NVL(OLD_MAIN_ACTY_CODE_1, '000000') OR
          NVL(NEW_MAIN_ACTY_CODE_2,'000000') !=
          NVL(OLD_MAIN_ACTY_CODE_2, '000000') THEN
           F_VAL_MAIN_ACTY(NEW_MAIN_ACTY_CODE_1,
                       NEW_MAIN_ACTY_CODE_2, T_ERR_NO);
           IF T_ERR_NO != 0 THEN
              RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
           END IF;
       END IF;
       NEW_MAIN_CR_DT := SYSDATE;
       NEW_MAIN_CR_UID := NVL(NEW_MAIN_CR_UID,
                                NVL(OLD_MAIN_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' THEN
       IF NEW_MAIN_ACNT_TYPE != OLD_MAIN_ACNT_TYPE THEN
           F_VAL_CHANGE_ACNT_TYPE(NEW_MAIN_ACNT_CODE, T_ERR_NO);
           IF T_ERR_NO != 0 THEN
               RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
           END IF;
       END IF;
       IF (NEW_MAIN_CTL_ACNT_FLAG != OLD_MAIN_CTL_ACNT_FLAG) THEN
           F_VAL_CHANGE_MC_FLAG(NEW_MAIN_ACNT_CODE, T_ERR_NO);
           IF T_ERR_NO != 0 THEN
              RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO, T_MSG);
           END IF;
       END IF;
       IF (NEW_MAIN_OPEN_ENTRY_FLAG != OLD_MAIN_OPEN_ENTRY_FLAG) THEN
          F_VAL_CHANGE_OE_FLAG(NEW_MAIN_ACNT_CODE, T_ERR_NO);
          IF T_ERR_NO != 0 THEN
               RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,T_MSG);
          END IF;
       END IF;
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_MAIN_ACCOUNT_HIST VALUES
          (OLD_MAIN_ACNT_CODE,       OLD_MAIN_ACNT_NAME,
           OLD_MAIN_ACNT_SHORT_NAME, OLD_MAIN_ACNT_CATG,
           OLD_MAIN_CTL_ACNT_FLAG,   OLD_MAIN_ACTY_CODE_1,
           OLD_MAIN_ACTY_CODE_2,     OLD_MAIN_ACNT_TYPE,
           OLD_MAIN_OPEN_ENTRY_FLAG, OLD_MAIN_DESC,       OLD_MAIN_CR_UID,
           OLD_MAIN_CR_DT,           OLD_MAIN_FRZ_FLAG,
           OLD_MAIN_BL_ACNT_NAME,    OLD_MAIN_BL_ACNT_SHORT_NAME );
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_MAIN_SUB (
 OLD_MS_MAIN_ACNT_CODE     IN      VARCHAR2,
 OLD_MS_SUB_ACNT_CODE      IN      VARCHAR2,
 OLD_MS_SUB_ACNT_NAME      IN      VARCHAR2,
 OLD_MS_SUB_ACNT_SHORT_NAME IN      VARCHAR2,
 OLD_MS_CR_UID             IN      VARCHAR2,
 OLD_MS_CR_DT              IN      DATE,
 NEW_MS_MAIN_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_MS_SUB_ACNT_CODE      IN OUT  VARCHAR2,
 NEW_MS_SUB_ACNT_NAME      IN OUT  VARCHAR2,
 NEW_MS_SUB_ACNT_SHORT_NAME IN OUT  VARCHAR2,
 NEW_MS_CR_UID             IN OUT  VARCHAR2,
 NEW_MS_CR_DT              IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_MS_BL_SUB_ACNT_NAME       IN      VARCHAR2,
 NEW_MS_BL_SUB_ACNT_NAME       IN OUT  VARCHAR2,
 OLD_MS_BL_SUB_ACNT_SHORT_NAME IN      VARCHAR2,
 NEW_MS_BL_SUB_ACNT_SHORT_NAME IN OUT  VARCHAR2) AS
P_CURR_CODE     VARCHAR2(3);
P_COMP_CODE     VARCHAR2(3);
CURSOR SEL_COMP IS
SELECT SCOMP_COMP_CODE
FROM   FM_SUB_COMP
WHERE  SCOMP_SUB_ACNT_CODE = NEW_MS_SUB_ACNT_CODE;
CURSOR SEL_CURR IS
SELECT SCURR_CURR_CODE
FROM   FM_SUB_CURR
WHERE  SCURR_SUB_ACNT_CODE = NEW_MS_SUB_ACNT_CODE;
T_ERR_NO NUMBER;
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
          NEW_MS_CR_DT := SYSDATE;
          NEW_MS_CR_UID := NVL(NEW_MS_CR_UID, NVL(OLD_MS_CR_UID, 'UNDEF'));
     END IF;
     IF TRG_MODE = 'I' THEN
        IF NVL(NEW_MS_MAIN_ACNT_CODE,'000000')
                  != NVL(OLD_MS_MAIN_ACNT_CODE,'000000') THEN
           F_VAL_MAIN_IS_CTL_ACNT(NEW_MS_MAIN_ACNT_CODE, T_ERR_NO);
           IF T_ERR_NO != 0 THEN
              RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,
                      'Main account is required to be a Control account');
           END IF;
         END IF;
        IF NVL(NEW_MS_SUB_ACNT_NAME,'000000') !=
           NVL(OLD_MS_SUB_ACNT_NAME,'000000')           OR
           NVL(NEW_MS_SUB_ACNT_SHORT_NAME,'000000') !=
           NVL(OLD_MS_SUB_ACNT_SHORT_NAME,'000000')     THEN
             F_VAL_SUB_ACNT_NAME(NEW_MS_SUB_ACNT_CODE,
                                 NEW_MS_SUB_ACNT_NAME,
                                 NEW_MS_SUB_ACNT_SHORT_NAME, T_ERR_NO);
             IF T_ERR_NO != 0 THEN
                 RAISE_APPLICATION_ERROR(-20500 - T_ERR_NO,
                             'Invalid Main - Sub account combination') ;
             END IF;
        END IF;
        IF SEL_COMP%ISOPEN THEN
             CLOSE SEL_COMP;
        END IF;
        OPEN SEL_COMP;
        <<COMP_LOOP>>
        LOOP
        FETCH SEL_COMP INTO P_COMP_CODE;
        EXIT WHEN SEL_COMP%NOTFOUND;
        INSERT INTO FM_ACNT_COMP
        (ACOMP_COMP_CODE, ACOMP_MAIN_ACNT_CODE, ACOMP_SUB_ACNT_CODE,
         ACOMP_CR_UID, ACOMP_CR_DT)
        VALUES
        (P_COMP_CODE, NEW_MS_MAIN_ACNT_CODE, NEW_MS_SUB_ACNT_CODE,
         NEW_MS_CR_UID, SYSDATE);
        END LOOP COMP_LOOP;
        CLOSE SEL_COMP;
        IF SEL_CURR%ISOPEN THEN
             CLOSE SEL_CURR;
        END IF;
        OPEN SEL_CURR;
        <<CURR_LOOP>>
        LOOP
        FETCH SEL_CURR INTO P_CURR_CODE;
        EXIT WHEN SEL_CURR%NOTFOUND;
        INSERT INTO FM_ACNT_CURR
        (ACURR_CURR_CODE, ACURR_MAIN_ACNT_CODE, ACURR_SUB_ACNT_CODE,
         ACURR_CR_UID, ACURR_CR_DT)
        VALUES
        (P_CURR_CODE, NEW_MS_MAIN_ACNT_CODE, NEW_MS_SUB_ACNT_CODE,
         NEW_MS_CR_UID, SYSDATE);
        END LOOP CURR_LOOP;
        CLOSE SEL_CURR;
     END IF;
     IF TRG_MODE = 'D' THEN
          DELETE FROM FM_ACNT_COMP
          WHERE  ACOMP_MAIN_ACNT_CODE = OLD_MS_MAIN_ACNT_CODE
          AND    ACOMP_SUB_ACNT_CODE = OLD_MS_SUB_ACNT_CODE;
          DELETE FROM FM_ACNT_CURR
          WHERE  ACURR_MAIN_ACNT_CODE = OLD_MS_MAIN_ACNT_CODE
          AND    ACURR_SUB_ACNT_CODE = OLD_MS_SUB_ACNT_CODE;
          INSERT INTO FH_MAIN_SUB_HIST VALUES
          (OLD_MS_MAIN_ACNT_CODE, OLD_MS_SUB_ACNT_CODE,
           OLD_MS_SUB_ACNT_NAME,  OLD_MS_SUB_ACNT_SHORT_NAME,
           OLD_MS_CR_UID,         OLD_MS_CR_DT,
           OLD_MS_BL_SUB_ACNT_NAME,  OLD_MS_BL_SUB_ACNT_SHORT_NAME);
     END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_SUB_ACCOUNT (
 OLD_SUB_ACNT_CODE         IN      VARCHAR2,
 OLD_SUB_ACNT_NAME         IN      VARCHAR2,
 OLD_SUB_ACNT_SHORT_NAME   IN      VARCHAR2,
 OLD_SUB_DESC              IN      VARCHAR2,
 OLD_SUB_CR_UID            IN      VARCHAR2,
 OLD_SUB_CR_DT             IN      DATE,
 OLD_SUB_FRZ_FLAG          IN      VARCHAR2,
 NEW_SUB_ACNT_CODE         IN OUT  VARCHAR2,
 NEW_SUB_ACNT_NAME         IN OUT  VARCHAR2,
 NEW_SUB_ACNT_SHORT_NAME   IN OUT  VARCHAR2,
 NEW_SUB_DESC              IN OUT  VARCHAR2,
 NEW_SUB_CR_UID            IN OUT  VARCHAR2,
 NEW_SUB_CR_DT             IN OUT  DATE,
 NEW_SUB_FRZ_FLAG          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_SUB_BL_ACNT_NAME         IN      VARCHAR2,
 NEW_SUB_BL_ACNT_NAME         IN OUT  VARCHAR2,
 OLD_SUB_BL_ACNT_SHORT_NAME   IN      VARCHAR2,
 NEW_SUB_BL_ACNT_SHORT_NAME   IN OUT  VARCHAR2) AS
CURSOR F_PARA IS
SELECT PARA_VALUE
FROM   FP_PARAMETER
WHERE  PARA_ID = 'UNIQUE.SUBACNT' ;
P_ERR_NO      NUMBER ;
P_PARA_VALUE  VARCHAR2(1);
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_SUB_CR_DT := SYSDATE;
     NEW_SUB_CR_UID := NVL(NEW_SUB_CR_UID, NVL(OLD_SUB_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_SUB_ACCOUNT_HIST VALUES
          (OLD_SUB_ACNT_CODE,       OLD_SUB_ACNT_NAME,
           OLD_SUB_ACNT_SHORT_NAME, OLD_SUB_DESC,
           OLD_SUB_CR_UID,          OLD_SUB_CR_DT,      OLD_SUB_FRZ_FLAG,
           OLD_SUB_BL_ACNT_NAME, OLD_SUB_BL_ACNT_SHORT_NAME);
END IF;
IF TRG_MODE = 'U' THEN
   IF OLD_SUB_ACNT_NAME != NEW_SUB_ACNT_NAME OR
      OLD_SUB_ACNT_SHORT_NAME != NEW_SUB_ACNT_SHORT_NAME THEN
      OPEN F_PARA ;
      FETCH F_PARA INTO P_PARA_VALUE ;
          IF F_PARA%NOTFOUND THEN
             CLOSE F_PARA ;
             RAISE_APPLICATION_ERROR(-20011,'Parameter not defined');
          END IF;
      CLOSE F_PARA ;
     IF P_PARA_VALUE = 'Y' THEN
        F_UPD_SUB_NAME(NEW_SUB_ACNT_CODE,NEW_SUB_ACNT_NAME,
                       NEW_SUB_ACNT_SHORT_NAME,P_ERR_NO);
        IF P_ERR_NO != 0 THEN
       RAISE_APPLICATION_ERROR(-20500-P_ERR_NO,'Invalid Main Sub Combination');
        END IF;
     END IF ;
END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_SUB_COMP (
 OLD_SCOMP_COMP_CODE       IN      VARCHAR2,
 OLD_SCOMP_SUB_ACNT_CODE   IN      VARCHAR2,
 OLD_SCOMP_CR_UID          IN      VARCHAR2,
 OLD_SCOMP_CR_DT           IN      DATE,
 NEW_SCOMP_COMP_CODE       IN OUT  VARCHAR2,
 NEW_SCOMP_SUB_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_SCOMP_CR_UID          IN OUT  VARCHAR2,
 NEW_SCOMP_CR_DT           IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_SUB_ACNT_CODE      VARCHAR2(6);
P_MAIN_ACNT_CODE     VARCHAR2(6);
CURSOR SEL_MAIN_OF_SUB IS
       SELECT MS_MAIN_ACNT_CODE
       FROM   FM_MAIN_SUB
       WHERE  MS_SUB_ACNT_CODE = P_SUB_ACNT_CODE;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_SCOMP_CR_DT := SYSDATE;
     NEW_SCOMP_CR_UID := NVL(NEW_SCOMP_CR_UID,
                          NVL(OLD_SCOMP_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' THEN
   RAISE_APPLICATION_ERROR(-20001, 'Cannot update');
END IF;
IF TRG_MODE = 'I' THEN
   P_SUB_ACNT_CODE := NEW_SCOMP_SUB_ACNT_CODE;
   IF SEL_MAIN_OF_SUB%ISOPEN THEN
        CLOSE SEL_MAIN_OF_SUB;
   END IF;
   OPEN SEL_MAIN_OF_SUB;
   <<MAIN_LOOP>>
   LOOP
   FETCH SEL_MAIN_OF_SUB INTO P_MAIN_ACNT_CODE;
   EXIT WHEN SEL_MAIN_OF_SUB%NOTFOUND;
   INSERT INTO FM_ACNT_COMP
   (ACOMP_COMP_CODE, ACOMP_MAIN_ACNT_CODE, ACOMP_SUB_ACNT_CODE,
    ACOMP_CR_UID, ACOMP_CR_DT)
   VALUES
   (NEW_SCOMP_COMP_CODE, P_MAIN_ACNT_CODE, P_SUB_ACNT_CODE,
    NEW_SCOMP_CR_UID, SYSDATE);
   END LOOP MAIN_LOOP;
   CLOSE SEL_MAIN_OF_SUB;
END IF;
IF TRG_MODE = 'D' THEN
   DELETE FROM FM_ACNT_COMP
   WHERE  (ACOMP_COMP_CODE = OLD_SCOMP_COMP_CODE)
   AND    (ACOMP_SUB_ACNT_CODE = OLD_SCOMP_SUB_ACNT_CODE);
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
   INSERT INTO FH_SUB_COMP_HIST VALUES
        (OLD_SCOMP_COMP_CODE, OLD_SCOMP_SUB_ACNT_CODE,
         OLD_SCOMP_CR_UID, OLD_SCOMP_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_SUB_CURR (
 OLD_SCURR_CURR_CODE       IN      VARCHAR2,
 OLD_SCURR_SUB_ACNT_CODE   IN      VARCHAR2,
 OLD_SCURR_CR_UID          IN      VARCHAR2,
 OLD_SCURR_CR_DT           IN      DATE,
 NEW_SCURR_CURR_CODE       IN OUT  VARCHAR2,
 NEW_SCURR_SUB_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_SCURR_CR_UID          IN OUT  VARCHAR2,
 NEW_SCURR_CR_DT           IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_SUB_ACNT_CODE      VARCHAR2(6);
P_MAIN_ACNT_CODE     VARCHAR2(6);
CURSOR SEL_MAIN_OF_SUB IS
       SELECT MS_MAIN_ACNT_CODE
       FROM   FM_MAIN_SUB
       WHERE  MS_SUB_ACNT_CODE = P_SUB_ACNT_CODE;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_SCURR_CR_DT := SYSDATE;
     NEW_SCURR_CR_UID := NVL(NEW_SCURR_CR_UID,
                             NVL(OLD_SCURR_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' THEN
    RAISE_APPLICATION_ERROR(-20002, 'Cannot update');
END IF;
IF TRG_MODE = 'I' THEN
   P_SUB_ACNT_CODE := NEW_SCURR_SUB_ACNT_CODE;
   IF SEL_MAIN_OF_SUB%ISOPEN THEN
        CLOSE SEL_MAIN_OF_SUB;
   END IF;
   OPEN SEL_MAIN_OF_SUB;
   <<MAIN_LOOP>>
   LOOP
   FETCH SEL_MAIN_OF_SUB INTO P_MAIN_ACNT_CODE;
   EXIT WHEN SEL_MAIN_OF_SUB%NOTFOUND;
   INSERT INTO FM_ACNT_CURR
   (ACURR_CURR_CODE, ACURR_MAIN_ACNT_CODE, ACURR_SUB_ACNT_CODE,
    ACURR_CR_UID, ACURR_CR_DT)
   VALUES
   (NEW_SCURR_CURR_CODE, P_MAIN_ACNT_CODE, P_SUB_ACNT_CODE,
    NEW_SCURR_CR_UID, SYSDATE);
   END LOOP MAIN_LOOP;
   CLOSE SEL_MAIN_OF_SUB;
END IF;
IF TRG_MODE = 'D' THEN
   DELETE FROM FM_ACNT_CURR
   WHERE  (ACURR_CURR_CODE = OLD_SCURR_CURR_CODE)
   AND    (ACURR_SUB_ACNT_CODE = OLD_SCURR_SUB_ACNT_CODE);
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_SUB_CURR_HIST VALUES
          (OLD_SCURR_CURR_CODE, OLD_SCURR_SUB_ACNT_CODE,
           OLD_SCURR_CR_UID, OLD_SCURR_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_SUPPLIER (
 OLD_SUPP_CODE             IN      VARCHAR2,
 OLD_SUPP_NAME             IN      VARCHAR2,
 OLD_SUPP_SHORT_NAME       IN      VARCHAR2,
 OLD_SUPP_ADD_1            IN      VARCHAR2,
 OLD_SUPP_ADD_2            IN      VARCHAR2,
 OLD_SUPP_ADD_3            IN      VARCHAR2,
 OLD_SUPP_COUNTRY          IN      VARCHAR2,
 OLD_SUPP_PHONE            IN      VARCHAR2,
 OLD_SUPP_TELEX_FAX        IN      VARCHAR2,
 OLD_SUPP_MAIN_ACNT_CODE   IN      VARCHAR2,
 OLD_SUPP_CR_LMT_AMT       IN      NUMBER,
 OLD_SUPP_CR_LMT_DAYS      IN      NUMBER,
 OLD_SUPP_CONTACT          IN      VARCHAR2,
 OLD_SUPP_AREA             IN      VARCHAR2,
 OLD_SUPP_SM               IN      VARCHAR2,
 OLD_SUPP_CATG             IN      VARCHAR2,
 OLD_SUPP_MODE_PYMT        IN      VARCHAR2,
 OLD_SUPP_BANK_ACNT        IN      VARCHAR2,
 OLD_SUPP_BANK_NAME        IN      VARCHAR2,
 OLD_SUPP_BANK_BRANCH      IN      VARCHAR2,
 OLD_SUPP_DESC             IN      VARCHAR2,
 OLD_SUPP_CR_UID           IN      VARCHAR2,
 OLD_SUPP_CR_DT            IN      DATE,
 OLD_SUPP_FRZ_FLAG         IN      VARCHAR2,
 OLD_SUPP_FAX              IN      VARCHAR2,
 OLD_SUPP_BANK_ADD1        IN      VARCHAR2,
 OLD_SUPP_BANK_ADD2        IN      VARCHAR2,
 OLD_SUPP_BANK_ADD3        IN      VARCHAR2,
 NEW_SUPP_CODE             IN OUT  VARCHAR2,
 NEW_SUPP_NAME             IN OUT  VARCHAR2,
 NEW_SUPP_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_SUPP_ADD_1            IN OUT  VARCHAR2,
 NEW_SUPP_ADD_2            IN OUT  VARCHAR2,
 NEW_SUPP_ADD_3            IN OUT  VARCHAR2,
 NEW_SUPP_COUNTRY          IN OUT  VARCHAR2,
 NEW_SUPP_PHONE            IN OUT  VARCHAR2,
 NEW_SUPP_TELEX_FAX        IN OUT  VARCHAR2,
 NEW_SUPP_MAIN_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_SUPP_CR_LMT_AMT       IN OUT  NUMBER,
 NEW_SUPP_CR_LMT_DAYS      IN OUT  NUMBER,
 NEW_SUPP_CONTACT          IN OUT  VARCHAR2,
 NEW_SUPP_AREA             IN OUT  VARCHAR2,
 NEW_SUPP_SM               IN OUT  VARCHAR2,
 NEW_SUPP_CATG             IN OUT  VARCHAR2,
 NEW_SUPP_MODE_PYMT        IN OUT  VARCHAR2,
 NEW_SUPP_BANK_ACNT        IN OUT  VARCHAR2,
 NEW_SUPP_BANK_NAME        IN OUT  VARCHAR2,
 NEW_SUPP_BANK_BRANCH      IN OUT  VARCHAR2,
 NEW_SUPP_DESC             IN OUT  VARCHAR2,
 NEW_SUPP_CR_UID           IN OUT  VARCHAR2,
 NEW_SUPP_CR_DT            IN OUT  DATE,
 NEW_SUPP_FRZ_FLAG         IN OUT  VARCHAR2,
 NEW_SUPP_FAX              IN OUT  VARCHAR2,
 NEW_SUPP_BANK_ADD1        IN OUT  VARCHAR2,
 NEW_SUPP_BANK_ADD2        IN OUT  VARCHAR2,
 NEW_SUPP_BANK_ADD3        IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_SUPP_BL_NAME          IN      VARCHAR2,
 NEW_SUPP_BL_NAME          IN OUT  VARCHAR2,
 OLD_SUPP_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_SUPP_BL_SHORT_NAME    IN OUT  VARCHAR2,
 OLD_SUPP_BL_ADD_1         IN      VARCHAR2,
 NEW_SUPP_BL_ADD_1         IN OUT  VARCHAR2,
 OLD_SUPP_BL_ADD_2         IN      VARCHAR2,
 NEW_SUPP_BL_ADD_2         IN OUT  VARCHAR2,
 OLD_SUPP_BL_ADD_3         IN      VARCHAR2,
 NEW_SUPP_BL_ADD_3         IN OUT  VARCHAR2) AS
CURSOR F_PARA IS
SELECT PARA_VALUE
FROM   FP_PARAMETER
WHERE  PARA_ID = 'UNIQUE.SUBACNT' ;
P_ERR_NO      NUMBER ;
P_PARA_VALUE  VARCHAR2(1);
CURSOR SEL_SUB IS
SELECT SUB_ACNT_NAME, SUB_ACNT_SHORT_NAME
FROM   FM_SUB_ACCOUNT
WHERE  SUB_ACNT_CODE = NEW_SUPP_CODE
FOR UPDATE OF SUB_ACNT_NAME, SUB_ACNT_SHORT_NAME;
P_SUB_ACNT_NAME        VARCHAR2(30);
P_SUB_ACNT_SHORT_NAME  VARCHAR2(30);
CURSOR SEL_MS IS
SELECT 'X'
FROM   FM_MAIN_SUB
WHERE  MS_SUB_ACNT_CODE = OLD_SUPP_CODE;
P_DUMMY          VARCHAR2(1);
BEGIN
     IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
        NEW_SUPP_CR_DT := SYSDATE;
        NEW_SUPP_CR_UID := NVL(NEW_SUPP_CR_UID,
                             NVL(OLD_SUPP_CR_UID, 'UNDEF'));
        IF SEL_SUB%ISOPEN THEN
             CLOSE SEL_SUB;
        END IF;
        OPEN SEL_SUB;
        FETCH SEL_SUB INTO P_SUB_ACNT_NAME, P_SUB_ACNT_SHORT_NAME;
        IF SEL_SUB%NOTFOUND THEN
            INSERT INTO FM_SUB_ACCOUNT (SUB_ACNT_CODE,
                                        SUB_ACNT_NAME,
                                        SUB_ACNT_SHORT_NAME,
                                        SUB_CR_UID,
                                        SUB_CR_DT,
                                        SUB_FRZ_FLAG,
                                        SUB_BL_ACNT_NAME,
                                        SUB_BL_ACNT_SHORT_NAME)
                                VALUES (NEW_SUPP_CODE,
                                        NEW_SUPP_NAME,
                                        NEW_SUPP_SHORT_NAME,
                                        NEW_SUPP_CR_UID,
                                        NEW_SUPP_CR_DT,'N',
                                        NEW_SUPP_BL_NAME,
                                        NEW_SUPP_BL_SHORT_NAME);
        ELSE
            OPEN F_PARA ;
            FETCH F_PARA INTO P_PARA_VALUE ;
            IF F_PARA%NOTFOUND THEN
               CLOSE SEL_SUB ;
               CLOSE F_PARA ;
               RAISE_APPLICATION_ERROR(-20011,'Parameter not defined');
            END IF;
            CLOSE F_PARA ;
            IF P_PARA_VALUE = 'Y' THEN
                 IF NEW_SUPP_NAME != P_SUB_ACNT_NAME OR
                    NVL(NEW_SUPP_SHORT_NAME,'X') !=
                    NVL(P_SUB_ACNT_SHORT_NAME,'X') THEN
                    UPDATE FM_SUB_ACCOUNT
                    SET    SUB_ACNT_NAME = NEW_SUPP_NAME,
                           SUB_ACNT_SHORT_NAME = NEW_SUPP_SHORT_NAME,
                           SUB_BL_ACNT_NAME = NEW_SUPP_BL_NAME,
                           SUB_BL_ACNT_SHORT_NAME = NEW_SUPP_BL_SHORT_NAME
                    WHERE  CURRENT OF SEL_SUB;
                 END IF;
            END IF;
        END IF;
        CLOSE SEL_SUB;
     END IF;
     IF TRG_MODE = 'I' THEN
        INSERT INTO FM_MAIN_SUB    (MS_MAIN_ACNT_CODE,
                                    MS_SUB_ACNT_CODE,
                                    MS_SUB_ACNT_NAME,
                                    MS_SUB_ACNT_SHORT_NAME,
                                    MS_CR_UID,
                                    MS_CR_DT,
                                    MS_BL_SUB_ACNT_NAME,
                                    MS_BL_SUB_ACNT_SHORT_NAME)
                            VALUES (NEW_SUPP_MAIN_ACNT_CODE,
                                    NEW_SUPP_CODE,
                                    NEW_SUPP_NAME,
                                    NEW_SUPP_SHORT_NAME,
                                    NEW_SUPP_CR_UID,
                                    NEW_SUPP_CR_DT,
                                    NEW_SUPP_BL_NAME,
                                    NEW_SUPP_BL_SHORT_NAME) ;
    END IF;
    IF TRG_MODE = 'U' THEN
          IF NEW_SUPP_MAIN_ACNT_CODE != OLD_SUPP_MAIN_ACNT_CODE THEN
              UPDATE  FM_MAIN_SUB
                 SET  MS_MAIN_ACNT_CODE = NEW_SUPP_MAIN_ACNT_CODE
               WHERE  MS_MAIN_ACNT_CODE = OLD_SUPP_MAIN_ACNT_CODE
               AND    MS_SUB_ACNT_CODE  = NEW_SUPP_CODE;
              UPDATE  FM_ACNT_COMP
                 SET  ACOMP_MAIN_ACNT_CODE = NEW_SUPP_MAIN_ACNT_CODE
               WHERE  ACOMP_MAIN_ACNT_CODE = OLD_SUPP_MAIN_ACNT_CODE
               AND    ACOMP_SUB_ACNT_CODE  = NEW_SUPP_CODE;
              UPDATE  FM_ACNT_CURR
                 SET  ACURR_MAIN_ACNT_CODE = NEW_SUPP_MAIN_ACNT_CODE
               WHERE  ACURR_MAIN_ACNT_CODE = OLD_SUPP_MAIN_ACNT_CODE
               AND    ACURR_SUB_ACNT_CODE  = NEW_SUPP_CODE;
           END IF;
     END IF;
     IF TRG_MODE = 'D' THEN
        DELETE  FM_MAIN_SUB
         WHERE  MS_MAIN_ACNT_CODE    = OLD_SUPP_MAIN_ACNT_CODE
         AND    MS_SUB_ACNT_CODE     = OLD_SUPP_CODE;
        OPEN SEL_MS;
        FETCH SEL_MS INTO P_DUMMY;
        IF SEL_MS%NOTFOUND THEN
             DELETE  FM_SUB_ACCOUNT
             WHERE   SUB_ACNT_CODE     = OLD_SUPP_CODE;
        END IF;
        CLOSE SEL_MS;
        DELETE  FM_ACNT_COMP
         WHERE  ACOMP_MAIN_ACNT_CODE = OLD_SUPP_MAIN_ACNT_CODE
         AND    ACOMP_SUB_ACNT_CODE  = OLD_SUPP_CODE;
        DELETE  FM_ACNT_CURR
         WHERE  ACURR_MAIN_ACNT_CODE = OLD_SUPP_MAIN_ACNT_CODE
         AND    ACURR_SUB_ACNT_CODE  = OLD_SUPP_CODE;
     END IF;
     IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
        INSERT INTO FH_SUPPLIER_HIST VALUES
                    (OLD_SUPP_CODE, OLD_SUPP_NAME,
                     OLD_SUPP_SHORT_NAME, OLD_SUPP_ADD_1,
                     OLD_SUPP_ADD_2, OLD_SUPP_ADD_3,
                     OLD_SUPP_COUNTRY, OLD_SUPP_PHONE,
                     OLD_SUPP_TELEX_FAX,
                     OLD_SUPP_MAIN_ACNT_CODE,
                     OLD_SUPP_CR_LMT_AMT ,
                     OLD_SUPP_CR_LMT_DAYS, OLD_SUPP_CONTACT,
                     OLD_SUPP_AREA, OLD_SUPP_SM,
                     OLD_SUPP_CATG, OLD_SUPP_MODE_PYMT,
                     OLD_SUPP_BANK_ACNT, OLD_SUPP_BANK_NAME,
                     OLD_SUPP_BANK_BRANCH,OLD_SUPP_DESC,
                     OLD_SUPP_CR_UID, OLD_SUPP_CR_DT,
                     OLD_SUPP_FRZ_FLAG, OLD_SUPP_FAX,
                     OLD_SUPP_BANK_ADD1, OLD_SUPP_BANK_ADD2,
                     OLD_SUPP_BANK_ADD3,
                     OLD_SUPP_BL_NAME,
                     OLD_SUPP_BL_SHORT_NAME, OLD_SUPP_BL_ADD_1,
                     OLD_SUPP_BL_ADD_2, OLD_SUPP_BL_ADD_3) ;
      END IF;
 END;
/
CREATE OR REPLACE PROCEDURE STP_FM_TRANSACTION (
 OLD_TRAN_CODE             IN      VARCHAR2,
 OLD_TRAN_TYPE             IN      VARCHAR2,
 OLD_TRAN_NAME             IN      VARCHAR2,
 OLD_TRAN_DR_HEADER        IN      VARCHAR2,
 OLD_TRAN_CR_HEADER        IN      VARCHAR2,
 OLD_TRAN_CASH_BANK_FLAG   IN      VARCHAR2,
 OLD_TRAN_DFLT_MAIN_ACNT_CODE IN      VARCHAR2,
 OLD_TRAN_DFLT_SUB_ACNT_CODE  IN      VARCHAR2,
 OLD_TRAN_MODE_POSTING     IN      VARCHAR2,
 OLD_TRAN_ACNT_CATG        IN      VARCHAR2,
 OLD_TRAN_MIN_AMT          IN      NUMBER,
 OLD_TRAN_MAX_AMT          IN      NUMBER,
 OLD_TRAN_SELF_REV         IN      VARCHAR2,
 OLD_TRAN_EXGE_RATE_APPLY  IN      VARCHAR2,
 OLD_TRAN_AUTO_PRINT_FLAG  IN      VARCHAR2,
 OLD_TRAN_CTL_TOTAL        IN      VARCHAR2,
 OLD_TRAN_DOC_NO_GENERATE  IN      VARCHAR2,
 OLD_TRAN_PRINT_NARR_FLAG  IN      VARCHAR2,
 OLD_TRAN_CR_UID           IN      VARCHAR2,
 OLD_TRAN_CR_DT            IN      DATE,
 OLD_TRAN_FRZ_FLAG         IN      VARCHAR2,
 NEW_TRAN_CODE             IN OUT  VARCHAR2,
 NEW_TRAN_TYPE             IN OUT  VARCHAR2,
 NEW_TRAN_NAME             IN OUT  VARCHAR2,
 NEW_TRAN_DR_HEADER        IN OUT  VARCHAR2,
 NEW_TRAN_CR_HEADER        IN OUT  VARCHAR2,
 NEW_TRAN_CASH_BANK_FLAG   IN OUT  VARCHAR2,
 NEW_TRAN_DFLT_MAIN_ACNT_CODE IN OUT  VARCHAR2,
 NEW_TRAN_DFLT_SUB_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_TRAN_MODE_POSTING     IN OUT  VARCHAR2,
 NEW_TRAN_ACNT_CATG        IN OUT  VARCHAR2,
 NEW_TRAN_MIN_AMT          IN OUT  NUMBER,
 NEW_TRAN_MAX_AMT          IN OUT  NUMBER,
 NEW_TRAN_SELF_REV         IN OUT  VARCHAR2,
 NEW_TRAN_EXGE_RATE_APPLY  IN OUT  VARCHAR2,
 NEW_TRAN_AUTO_PRINT_FLAG  IN OUT  VARCHAR2,
 NEW_TRAN_CTL_TOTAL        IN OUT  VARCHAR2,
 NEW_TRAN_DOC_NO_GENERATE  IN OUT  VARCHAR2,
 NEW_TRAN_PRINT_NARR_FLAG  IN OUT  VARCHAR2,
 NEW_TRAN_CR_UID           IN OUT  VARCHAR2,
 NEW_TRAN_CR_DT            IN OUT  DATE,
 NEW_TRAN_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
Press <Enter> to continue...
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2,
 OLD_TRAN_BL_NAME          IN      VARCHAR2,
 NEW_TRAN_BL_NAME          IN OUT  VARCHAR2) AS
T_ERR_NO  NUMBER;
T_MSG    CHAR  ;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_TRAN_CR_DT := SYSDATE;
     NEW_TRAN_CR_UID := NVL(NEW_TRAN_CR_UID, NVL(OLD_TRAN_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' THEN
         IF NEW_TRAN_MODE_POSTING != OLD_TRAN_MODE_POSTING      OR
            OLD_TRAN_ACNT_CATG    != NEW_TRAN_ACNT_CATG         OR
            OLD_TRAN_ACNT_CATG    != NEW_TRAN_ACNT_CATG         OR
            OLD_TRAN_MIN_AMT      != NEW_TRAN_MIN_AMT           OR
            OLD_TRAN_MAX_AMT      != NEW_TRAN_MAX_AMT           OR
            OLD_TRAN_CTL_TOTAL    != NEW_TRAN_CTL_TOTAL            THEN
             F_VAL_NO_TRAN_EXIST(NEW_TRAN_CODE, 'U', T_ERR_NO);
             IF T_ERR_NO != 0 THEN
                  RAISE_APPLICATION_ERROR (-20500 - T_ERR_NO, T_MSG);
              END IF;
          END IF;
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
INSERT INTO FH_TRANSACTION_HIST VALUES (OLD_TRAN_CODE,
                                        OLD_TRAN_TYPE,
                                        OLD_TRAN_NAME,
                                        OLD_TRAN_DR_HEADER,
                                        OLD_TRAN_CR_HEADER,
                                        OLD_TRAN_CASH_BANK_FLAG,
                                        OLD_TRAN_DFLT_MAIN_ACNT_CODE,
                                        OLD_TRAN_DFLT_SUB_ACNT_CODE,
                                        OLD_TRAN_MODE_POSTING,
                                        OLD_TRAN_ACNT_CATG,
                                        OLD_TRAN_MIN_AMT,
                                        OLD_TRAN_MAX_AMT,
                                        OLD_TRAN_SELF_REV,
                                        OLD_TRAN_EXGE_RATE_APPLY,
                                        OLD_TRAN_AUTO_PRINT_FLAG,
                                        OLD_TRAN_CTL_TOTAL,
                                        OLD_TRAN_DOC_NO_GENERATE,
                                        OLD_TRAN_PRINT_NARR_FLAG,
                                        OLD_TRAN_CR_UID,
                                        OLD_TRAN_CR_DT,
                                        OLD_TRAN_FRZ_FLAG,
                                        OLD_TRAN_BL_NAME) ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_TRAN_APPR_GROUP (
 OLD_TAG_TRAN_CODE         IN      VARCHAR2,
 OLD_TAG_GROUP_CODE        IN      VARCHAR2,
 OLD_TAG_CR_UID            IN      VARCHAR2,
 OLD_TAG_CR_DT             IN      DATE,
 NEW_TAG_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_TAG_GROUP_CODE        IN OUT  VARCHAR2,
 NEW_TAG_CR_UID            IN OUT  VARCHAR2,
 NEW_TAG_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_TAG_CR_DT := SYSDATE;
     NEW_TAG_CR_UID := NVL(NEW_TAG_CR_UID, NVL(OLD_TAG_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     INSERT INTO FH_TRAN_APPR_GROUP_HIST VALUES (OLD_TAG_TRAN_CODE,
                                                 OLD_TAG_GROUP_CODE,
                                                 OLD_TAG_CR_UID,
                                                 OLD_TAG_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_TRAN_APPR_LEVEL (
 OLD_ALVL_TRAN_CODE        IN      VARCHAR2,
 OLD_ALVL_USR_LVL          IN      NUMBER,
 OLD_ALVL_USR_AMT_FRM      IN      NUMBER,
 OLD_ALVL_USR_AMT_TO       IN      NUMBER,
 OLD_ALVL_CR_UID           IN      VARCHAR2,
 OLD_ALVL_CR_DT            IN      DATE,
 NEW_ALVL_TRAN_CODE        IN OUT  VARCHAR2,
 NEW_ALVL_USR_LVL          IN OUT  NUMBER,
 NEW_ALVL_USR_AMT_FRM      IN OUT  NUMBER,
 NEW_ALVL_USR_AMT_TO       IN OUT  NUMBER,
 NEW_ALVL_CR_UID           IN OUT  VARCHAR2,
 NEW_ALVL_CR_DT            IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     NEW_ALVL_CR_DT := SYSDATE;
     NEW_ALVL_CR_UID := NVL(NEW_ALVL_CR_UID, NVL(OLD_ALVL_CR_UID, 'UNDEF'));
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
    INSERT INTO FH_TRAN_APPR_LEVEL_HIST VALUES (OLD_ALVL_TRAN_CODE,
                                                OLD_ALVL_USR_LVL,
                                                OLD_ALVL_USR_AMT_FRM,
                                                OLD_ALVL_USR_AMT_TO,
                                                OLD_ALVL_CR_UID,
                                                OLD_ALVL_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_VALID_COMB (
 OLD_VCM_SEQ_NO                IN      NUMBER,
 OLD_VCM_LOW_COMP_CODE         IN      VARCHAR2,
 OLD_VCM_LOW_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_VCM_LOW_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_VCM_LOW_DIVN_CODE         IN      VARCHAR2,
 OLD_VCM_LOW_DEPT_CODE         IN      VARCHAR2,
 OLD_VCM_LOW_ANLY_CODE_1       IN      VARCHAR2,
 OLD_VCM_LOW_ANLY_CODE_2       IN      VARCHAR2,
 OLD_VCM_HIGH_COMP_CODE        IN      VARCHAR2,
 OLD_VCM_HIGH_MAIN_ACNT_CODE   IN      VARCHAR2,
 OLD_VCM_HIGH_SUB_ACNT_CODE    IN      VARCHAR2,
 OLD_VCM_HIGH_DIVN_CODE        IN      VARCHAR2,
 OLD_VCM_HIGH_DEPT_CODE        IN      VARCHAR2,
 OLD_VCM_HIGH_ANLY_CODE_1      IN      VARCHAR2,
 OLD_VCM_HIGH_ANLY_CODE_2      IN      VARCHAR2,
 OLD_VCM_IE_CODE               IN      VARCHAR2,
 OLD_VCM_ERROR_MSG             IN      VARCHAR2,
 OLD_VCM_CR_UID                IN      VARCHAR2,
 OLD_VCM_CR_DT                 IN      DATE,
 NEW_VCM_SEQ_NO                IN OUT  NUMBER,
 NEW_VCM_LOW_COMP_CODE         IN OUT  VARCHAR2,
 NEW_VCM_LOW_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_VCM_LOW_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_VCM_LOW_DIVN_CODE         IN OUT  VARCHAR2,
 NEW_VCM_LOW_DEPT_CODE         IN OUT  VARCHAR2,
 NEW_VCM_LOW_ANLY_CODE_1       IN OUT  VARCHAR2,
 NEW_VCM_LOW_ANLY_CODE_2       IN OUT  VARCHAR2,
 NEW_VCM_HIGH_COMP_CODE        IN OUT  VARCHAR2,
 NEW_VCM_HIGH_MAIN_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_VCM_HIGH_SUB_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_VCM_HIGH_DIVN_CODE        IN OUT  VARCHAR2,
 NEW_VCM_HIGH_DEPT_CODE        IN OUT  VARCHAR2,
 NEW_VCM_HIGH_ANLY_CODE_1      IN OUT  VARCHAR2,
 NEW_VCM_HIGH_ANLY_CODE_2      IN OUT  VARCHAR2,
 NEW_VCM_IE_CODE               IN OUT  VARCHAR2,
 NEW_VCM_ERROR_MSG             IN OUT  VARCHAR2,
 NEW_VCM_CR_UID                IN OUT  VARCHAR2,
 NEW_VCM_CR_DT                 IN OUT  DATE,
 TRG_MODE                      IN OUT  VARCHAR2,
 TRG_ERR_NO                       OUT  NUMBER,
 TRG_ERR_MSG                      OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'I'  OR TRG_MODE = 'U' THEN
     NEW_VCM_CR_UID := NVL(NEW_VCM_CR_UID,NVL(OLD_VCM_CR_UID,'UNDEF'));
     NEW_VCM_CR_DT  := SYSDATE;
END IF;
IF TRG_MODE = 'I' THEN
   IF NEW_VCM_SEQ_NO IS NULL THEN
        F_VALID_COMB(NEW_VCM_SEQ_NO);
   END IF;
END IF;
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
      INSERT INTO FH_VALID_COMB_HIST VALUES
                  (OLD_VCM_SEQ_NO, OLD_VCM_LOW_COMP_CODE,
                   OLD_VCM_LOW_MAIN_ACNT_CODE, OLD_VCM_LOW_SUB_ACNT_CODE,
                   OLD_VCM_LOW_DIVN_CODE, OLD_VCM_LOW_DEPT_CODE,
                   OLD_VCM_LOW_ANLY_CODE_1, OLD_VCM_LOW_ANLY_CODE_2,
                   OLD_VCM_HIGH_COMP_CODE, OLD_VCM_HIGH_MAIN_ACNT_CODE,
                   OLD_VCM_HIGH_SUB_ACNT_CODE, OLD_VCM_HIGH_DIVN_CODE,
                   OLD_VCM_HIGH_DEPT_CODE, OLD_VCM_HIGH_ANLY_CODE_1,
                   OLD_VCM_HIGH_ANLY_CODE_2,
                   OLD_VCM_IE_CODE, OLD_VCM_ERROR_MSG,
                   OLD_VCM_CR_UID, OLD_VCM_CR_DT);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FM_YEARLY_BUDGET (
 OLD_YBUD_COMP_CODE        IN      VARCHAR2,
 OLD_YBUD_ACNT_YEAR        IN      NUMBER,
 OLD_YBUD_MAIN_ACNT_CODE   IN      VARCHAR2,
 OLD_YBUD_SUB_ACNT_CODE    IN      VARCHAR2,
 OLD_YBUD_DIVN_CODE        IN      VARCHAR2,
 OLD_YBUD_DEPT_CODE        IN      VARCHAR2,
 OLD_YBUD_HEAD_NO_1        IN      NUMBER,
 OLD_YBUD_ANLY_CODE_1      IN      VARCHAR2,
 OLD_YBUD_HEAD_NO_2        IN      NUMBER,
 OLD_YBUD_ANLY_CODE_2      IN      VARCHAR2,
 OLD_YBUD_ORGL_AMT         IN      NUMBER,
 OLD_YBUD_ORGL_DRCR_FLAG   IN      VARCHAR2,
 OLD_YBUD_REVI_AMT         IN      NUMBER,
 OLD_YBUD_REVI_DRCR_FLAG   IN      VARCHAR2,
 OLD_YBUD_YEAR_FLAG        IN      VARCHAR2,
 OLD_YBUD_CR_UID           IN      VARCHAR2,
 OLD_YBUD_CR_DT            IN      DATE,
 NEW_YBUD_COMP_CODE        IN OUT  VARCHAR2,
 NEW_YBUD_ACNT_YEAR        IN OUT  NUMBER,
 NEW_YBUD_MAIN_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_YBUD_SUB_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_YBUD_DIVN_CODE        IN OUT  VARCHAR2,
 NEW_YBUD_DEPT_CODE        IN OUT  VARCHAR2,
 NEW_YBUD_HEAD_NO_1        IN OUT  NUMBER,
 NEW_YBUD_ANLY_CODE_1      IN OUT  VARCHAR2,
 NEW_YBUD_HEAD_NO_2        IN OUT  NUMBER,
 NEW_YBUD_ANLY_CODE_2      IN OUT  VARCHAR2,
 NEW_YBUD_ORGL_AMT         IN OUT  NUMBER,
 NEW_YBUD_ORGL_DRCR_FLAG   IN OUT  VARCHAR2,
 NEW_YBUD_REVI_AMT         IN OUT  NUMBER,
 NEW_YBUD_REVI_DRCR_FLAG   IN OUT  VARCHAR2,
 NEW_YBUD_YEAR_FLAG        IN OUT  VARCHAR2,
 NEW_YBUD_CR_UID           IN OUT  VARCHAR2,
 NEW_YBUD_CR_DT            IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
 P_COUNT NUMBER;
 P_CURR_ACNT_YEAR NUMBER;
BEGIN
P_CURR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_YBUD_COMP_CODE);
IF NEW_YBUD_YEAR_FLAG = 'C' THEN
   NEW_YBUD_ACNT_YEAR := P_CURR_ACNT_YEAR;
ELSE
   NEW_YBUD_ACNT_YEAR := P_CURR_ACNT_YEAR + 1;
END IF;
SELECT COUNT(*)
INTO   P_COUNT
FROM   FM_ACNT_PERIOD
WHERE  APER_COMP_CODE = NEW_YBUD_COMP_CODE
AND    APER_ACNT_YEAR = NEW_YBUD_ACNT_YEAR;
IF P_COUNT = 0 THEN
  IF TRG_MODE IN ('I','U') THEN
  RAISE_APPLICATION_ERROR(-20008,'Accounting Period not set up for this Year');
  ELSE
   P_COUNT := 1;
  END IF;
END IF;
IF TRG_MODE = 'I' THEN
     INSERT INTO FM_MONTHLY_BUDGET
           (MBUD_COMP_CODE, MBUD_ACNT_YEAR, MBUD_MAIN_ACNT_CODE,
            MBUD_SUB_ACNT_CODE, MBUD_DIVN_CODE, MBUD_DEPT_CODE, MBUD_HEAD_NO_1,
            MBUD_ANLY_CODE_1, MBUD_HEAD_NO_2, MBUD_ANLY_CODE_2, MBUD_YEAR_FLAG,
            MBUD_CAL_YEAR, MBUD_CAL_MONTH, MBUD_ORGL_AMT, MBUD_REVI_AMT,
            MBUD_CR_UID, MBUD_CR_DT)
     SELECT NEW_YBUD_COMP_CODE, NEW_YBUD_ACNT_YEAR, NEW_YBUD_MAIN_ACNT_CODE,
            NEW_YBUD_SUB_ACNT_CODE, NEW_YBUD_DIVN_CODE, NEW_YBUD_DEPT_CODE,
            NEW_YBUD_HEAD_NO_1, NEW_YBUD_ANLY_CODE_1, NEW_YBUD_HEAD_NO_2,
            NEW_YBUD_ANLY_CODE_2, NEW_YBUD_YEAR_FLAG,
            APER_CAL_YEAR, APER_CAL_MONTH,
            NVL(NEW_YBUD_ORGL_AMT/P_COUNT, 0),
            NVL(NEW_YBUD_REVI_AMT/P_COUNT, 0),
            NEW_YBUD_CR_UID, SYSDATE
     FROM   FM_ACNT_PERIOD
     WHERE  APER_COMP_CODE = NEW_YBUD_COMP_CODE
     AND    APER_ACNT_YEAR = NEW_YBUD_ACNT_YEAR;
IF SQLCODE != 0 THEN
    RAISE_APPLICATION_ERROR(-20007,'Error in inserting budget entries');
END IF;
END IF;
IF TRG_MODE = 'U' THEN
    IF NEW_YBUD_ORGL_AMT != OLD_YBUD_ORGL_AMT
       OR NEW_YBUD_REVI_AMT != OLD_YBUD_REVI_AMT THEN
          UPDATE FM_MONTHLY_BUDGET
                SET MBUD_ORGL_AMT = NVL(NEW_YBUD_ORGL_AMT/P_COUNT,0),
                MBUD_REVI_AMT = NVL(NEW_YBUD_REVI_AMT/P_COUNT,0)
          WHERE MBUD_COMP_CODE = OLD_YBUD_COMP_CODE
          AND   MBUD_ACNT_YEAR = OLD_YBUD_ACNT_YEAR
          AND   MBUD_MAIN_ACNT_CODE = OLD_YBUD_MAIN_ACNT_CODE
          AND   NVL(MBUD_SUB_ACNT_CODE,'XXXXXXX') =
                NVL(OLD_YBUD_SUB_ACNT_CODE,'XXXXXXX')
          AND   NVL(MBUD_DIVN_CODE,'XXXXXXX') =
                NVL(OLD_YBUD_DIVN_CODE,'XXXXXXX')
          AND   NVL(MBUD_DEPT_CODE,'XXXXXXX') =
                NVL(OLD_YBUD_DEPT_CODE,'XXXXXXX')
          AND   NVL(MBUD_HEAD_NO_1,99) =
                NVL(OLD_YBUD_HEAD_NO_1,99)
          AND   NVL(MBUD_ANLY_CODE_1,'XXXXXXX') =
                NVL(OLD_YBUD_ANLY_CODE_1,'XXXXXXX')
          AND   NVL(MBUD_HEAD_NO_2,99) =
                NVL(OLD_YBUD_HEAD_NO_2,99)
          AND   NVL(MBUD_ANLY_CODE_2,'XXXXXXX') =
                NVL(OLD_YBUD_ANLY_CODE_2,'XXXXXXX')
          AND   MBUD_YEAR_FLAG = OLD_YBUD_YEAR_FLAG;
    END IF;
END IF;
IF  TRG_MODE = 'D' THEN
    DELETE FROM FM_MONTHLY_BUDGET
    WHERE  MBUD_COMP_CODE      = OLD_YBUD_COMP_CODE
    AND    MBUD_ACNT_YEAR      = OLD_YBUD_ACNT_YEAR
    AND    MBUD_MAIN_ACNT_CODE = OLD_YBUD_MAIN_ACNT_CODE
    AND    NVL(MBUD_SUB_ACNT_CODE,'XXXXXXX')  =
           NVL(OLD_YBUD_SUB_ACNT_CODE,'XXXXXXX')
    AND    NVL(MBUD_DIVN_CODE,'XXXXXXX')      =
           NVL(OLD_YBUD_DIVN_CODE,'XXXXXXX')
    AND    NVL(MBUD_DEPT_CODE,'XXXXXXX')      =
           NVL(OLD_YBUD_DEPT_CODE,'XXXXXXX')
    AND    NVL(MBUD_HEAD_NO_1,99) =
           NVL(OLD_YBUD_HEAD_NO_1,99)
    AND    NVL(MBUD_ANLY_CODE_1,'XXXXXXX')    =
           NVL(OLD_YBUD_ANLY_CODE_1,'XXXXXXX')
    AND    NVL(MBUD_HEAD_NO_2,99) =
           NVL(OLD_YBUD_HEAD_NO_2,99)
    AND    NVL(MBUD_ANLY_CODE_2,'XXXXXXX')    =
           NVL(OLD_YBUD_ANLY_CODE_2,'XXXXXXX')    ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FS_PURGE_AUDIT_TRAIL (
 OLD_PAT_KEY_NO            IN      NUMBER,
 OLD_PAT_ALL_CR_DT         IN      DATE,
 OLD_PAT_ORGN_CR_DT        IN      DATE,
 OLD_PAT_COMP_CR_DT        IN      DATE,
 OLD_PAT_DIVN_CR_DT        IN      DATE,
 OLD_PAT_DEPT_CR_DT        IN      DATE,
 OLD_PAT_TC_CR_DT          IN      DATE,
 OLD_PAT_TRAN_CR_DT        IN      DATE,
 OLD_PAT_TAG_CR_DT         IN      DATE,
 OLD_PAT_ALVL_CR_DT        IN      DATE,
 OLD_PAT_NARR_CR_DT        IN      DATE,
 OLD_PAT_ALL_COA_CR_DT     IN      DATE,
 OLD_PAT_COA_CR_DT         IN      DATE,
 OLD_PAT_LVL_CR_DT         IN      DATE,
 OLD_PAT_CAF_CR_DT         IN      DATE,
 OLD_PAT_MAIN_CR_DT        IN      DATE,
 OLD_PAT_SUB_CR_DT         IN      DATE,
 OLD_PAT_MS_CR_DT          IN      DATE,
 OLD_PAT_SCOMP_CR_DT       IN      DATE,
 OLD_PAT_SCURR_CR_DT       IN      DATE,
 OLD_PAT_ACOMP_CR_DT       IN      DATE,
 OLD_PAT_ACURR_CR_DT       IN      DATE,
 OLD_PAT_SUPP_CR_DT        IN      DATE,
 OLD_PAT_CUST_CR_DT        IN      DATE,
 OLD_PAT_CATG_CR_DT        IN      DATE,
 OLD_PAT_ALS_CR_DT         IN      DATE,
 OLD_PAT_ALL_ANLY_CR_DT    IN      DATE,
 OLD_PAT_ANLY_CR_DT        IN      DATE,
 OLD_PAT_AANLY_CR_DT       IN      DATE,
 OLD_PAT_AFM_CR_DT         IN      DATE,
 OLD_PAT_ALM_CR_DT         IN      DATE,
 OLD_PAT_AAL_CR_DT         IN      DATE,
 OLD_PAT_AAF_CR_DT         IN      DATE,
 OLD_PAT_ACTY_CR_DT        IN      DATE,
 OLD_PAT_AVAL_CR_DT        IN      DATE,
 OLD_PAT_PROC_CR_DT        IN      DATE,
 OLD_PAT_PHS_CR_DT         IN      DATE,
 OLD_PAT_PDS_CR_DT         IN      DATE,
 OLD_PAT_MISC_CR_DT        IN      DATE,
 OLD_PAT_CURR_CR_DT        IN      DATE,
 OLD_PAT_CER_CR_DT         IN      DATE,
 OLD_PAT_RHS_CR_DT         IN      DATE,
 OLD_PAT_RATIO_CR_DT       IN      DATE,
 OLD_PAT_VCM_CR_DT         IN      DATE,
 OLD_PAT_APER_CR_DT        IN      DATE,
 OLD_PAT_CR_UID            IN      VARCHAR2,
 OLD_PAT_CR_DT             IN      DATE,
 NEW_PAT_KEY_NO            IN OUT  NUMBER,
 NEW_PAT_ALL_CR_DT         IN OUT  DATE,
 NEW_PAT_ORGN_CR_DT        IN OUT  DATE,
 NEW_PAT_COMP_CR_DT        IN OUT  DATE,
 NEW_PAT_DIVN_CR_DT        IN OUT  DATE,
 NEW_PAT_DEPT_CR_DT        IN OUT  DATE,
 NEW_PAT_TC_CR_DT          IN OUT  DATE,
 NEW_PAT_TRAN_CR_DT        IN OUT  DATE,
 NEW_PAT_TAG_CR_DT         IN OUT  DATE,
 NEW_PAT_ALVL_CR_DT        IN OUT  DATE,
 NEW_PAT_NARR_CR_DT        IN OUT  DATE,
 NEW_PAT_ALL_COA_CR_DT     IN OUT  DATE,
 NEW_PAT_COA_CR_DT         IN OUT  DATE,
 NEW_PAT_LVL_CR_DT         IN OUT  DATE,
 NEW_PAT_CAF_CR_DT         IN OUT  DATE,
 NEW_PAT_MAIN_CR_DT        IN OUT  DATE,
 NEW_PAT_SUB_CR_DT         IN OUT  DATE,
 NEW_PAT_MS_CR_DT          IN OUT  DATE,
 NEW_PAT_SCOMP_CR_DT       IN OUT  DATE,
 NEW_PAT_SCURR_CR_DT       IN OUT  DATE,
 NEW_PAT_ACOMP_CR_DT       IN OUT  DATE,
 NEW_PAT_ACURR_CR_DT       IN OUT  DATE,
 NEW_PAT_SUPP_CR_DT        IN OUT  DATE,
 NEW_PAT_CUST_CR_DT        IN OUT  DATE,
 NEW_PAT_CATG_CR_DT        IN OUT  DATE,
 NEW_PAT_ALS_CR_DT         IN OUT  DATE,
 NEW_PAT_ALL_ANLY_CR_DT    IN OUT  DATE,
 NEW_PAT_ANLY_CR_DT        IN OUT  DATE,
 NEW_PAT_AANLY_CR_DT       IN OUT  DATE,
 NEW_PAT_AFM_CR_DT         IN OUT  DATE,
 NEW_PAT_ALM_CR_DT         IN OUT  DATE,
 NEW_PAT_AAL_CR_DT         IN OUT  DATE,
 NEW_PAT_AAF_CR_DT         IN OUT  DATE,
 NEW_PAT_ACTY_CR_DT        IN OUT  DATE,
 NEW_PAT_AVAL_CR_DT        IN OUT  DATE,
 NEW_PAT_PROC_CR_DT        IN OUT  DATE,
 NEW_PAT_PHS_CR_DT         IN OUT  DATE,
 NEW_PAT_PDS_CR_DT         IN OUT  DATE,
 NEW_PAT_MISC_CR_DT        IN OUT  DATE,
 NEW_PAT_CURR_CR_DT        IN OUT  DATE,
 NEW_PAT_CER_CR_DT         IN OUT  DATE,
 NEW_PAT_RHS_CR_DT         IN OUT  DATE,
 NEW_PAT_RATIO_CR_DT       IN OUT  DATE,
 NEW_PAT_VCM_CR_DT         IN OUT  DATE,
 NEW_PAT_APER_CR_DT        IN OUT  DATE,
 NEW_PAT_CR_UID            IN OUT  VARCHAR2,
 NEW_PAT_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
BEGIN
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     RAISE_APPLICATION_ERROR(-20001,'Cannot Update or Delete');
END IF;
IF TRG_MODE = 'I' THEN
    IF NEW_PAT_COMP_CR_DT IS NOT NULL THEN
          DELETE FROM FH_COMPANY_HIST
          WHERE COMP_CR_DT <= NEW_PAT_COMP_CR_DT;
    END IF;
    IF NEW_PAT_DIVN_CR_DT IS NOT NULL THEN
          DELETE FROM FH_DIVISION_HIST
          WHERE DIVN_CR_DT <= NEW_PAT_DIVN_CR_DT;
    END IF;
    IF NEW_PAT_DEPT_CR_DT IS NOT NULL THEN
          DELETE FROM FH_DEPARTMENT_HIST
          WHERE DEPT_CR_DT <= NEW_PAT_DEPT_CR_DT;
    END IF;
    IF NEW_PAT_TRAN_CR_DT IS NOT NULL THEN
          DELETE FROM FH_TRANSACTION_HIST
          WHERE TRAN_CR_DT <= NEW_PAT_TRAN_CR_DT;
    END IF;
    IF NEW_PAT_TAG_CR_DT IS NOT NULL THEN
          DELETE FROM FH_TRAN_APPR_GROUP_HIST
          WHERE TAG_CR_DT <= NEW_PAT_TAG_CR_DT;
    END IF;
    IF NEW_PAT_ALVL_CR_DT IS NOT NULL THEN
          DELETE FROM FH_TRAN_APPR_LEVEL_HIST
          WHERE ALVL_CR_DT <= NEW_PAT_ALVL_CR_DT;
    END IF;
    IF NEW_PAT_NARR_CR_DT IS NOT NULL THEN
          DELETE FROM FH_NARRATION_DEFN_HIST
          WHERE NARR_CR_DT <= NEW_PAT_NARR_CR_DT;
    END IF;
    IF NEW_PAT_MAIN_CR_DT IS NOT NULL THEN
          DELETE FROM FH_MAIN_ACCOUNT_HIST
          WHERE MAIN_CR_DT <= NEW_PAT_MAIN_CR_DT;
    END IF;
    IF NEW_PAT_SUB_CR_DT IS NOT NULL THEN
          DELETE FROM FH_SUB_ACCOUNT_HIST
          WHERE SUB_CR_DT <= NEW_PAT_SUB_CR_DT;
    END IF;
    IF NEW_PAT_MS_CR_DT IS NOT NULL THEN
          DELETE FROM FH_MAIN_SUB_HIST
          WHERE MS_CR_DT <= NEW_PAT_MS_CR_DT;
    END IF;
    IF NEW_PAT_SCOMP_CR_DT IS NOT NULL THEN
          DELETE FROM FH_SUB_COMP_HIST
          WHERE SCOMP_CR_DT <= NEW_PAT_SCOMP_CR_DT;
    END IF;
    IF NEW_PAT_SCURR_CR_DT IS NOT NULL THEN
          DELETE FROM FH_SUB_CURR_HIST
          WHERE SCURR_CR_DT <= NEW_PAT_SCURR_CR_DT;
    END IF;
    IF NEW_PAT_ACOMP_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_COMP_HIST
          WHERE ACOMP_CR_DT <= NEW_PAT_ACOMP_CR_DT;
    END IF;
    IF NEW_PAT_ACURR_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_CURR_HIST
          WHERE ACURR_CR_DT <= NEW_PAT_ACURR_CR_DT;
    END IF;
    IF NEW_PAT_SUPP_CR_DT IS NOT NULL THEN
          DELETE FROM FH_SUPPLIER_HIST
          WHERE SUPP_CR_DT <= NEW_PAT_SUPP_CR_DT;
    END IF;
    IF NEW_PAT_CUST_CR_DT IS NOT NULL THEN
          DELETE FROM FH_CUSTOMER_HIST
          WHERE CUST_CR_DT <= NEW_PAT_CUST_CR_DT;
    END IF;
    IF NEW_PAT_COA_CR_DT IS NOT NULL THEN
          DELETE FROM FH_COA_FORMAT_HIST
          WHERE COA_CR_DT <= NEW_PAT_COA_CR_DT;
    END IF;
    IF NEW_PAT_LVL_CR_DT IS NOT NULL THEN
          DELETE FROM FH_COA_LEVEL_HIST
          WHERE LVL_CR_DT <= NEW_PAT_LVL_CR_DT;
    END IF;
    IF NEW_PAT_CAF_CR_DT IS NOT NULL THEN
          DELETE FROM FH_COA_ACNT_FORMAT_HIST
          WHERE CAF_CR_DT <= NEW_PAT_CAF_CR_DT;
    END IF;
    IF NEW_PAT_ACTY_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACTIVITY_HIST
          WHERE ACTY_CR_DT <= NEW_PAT_ACTY_CR_DT;
    END IF;
    IF NEW_PAT_AVAL_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACTY_VALUE_HIST
          WHERE AVAL_CR_DT <= NEW_PAT_AVAL_CR_DT;
    END IF;
    IF NEW_PAT_CURR_CR_DT IS NOT NULL THEN
          DELETE FROM FH_CURRENCY_HIST
          WHERE CURR_CR_DT <= NEW_PAT_CURR_CR_DT;
    END IF;
    IF NEW_PAT_CER_CR_DT IS NOT NULL THEN
          DELETE FROM FH_EXCHANGE_RATE_HIST
          WHERE CER_CR_DT <= NEW_PAT_CER_CR_DT;
    END IF;
    IF NEW_PAT_CATG_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_CATG_HIST
          WHERE CATG_CR_DT <= NEW_PAT_CATG_CR_DT;
    END IF;
    IF NEW_PAT_ALS_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_LINK_HIST
          WHERE ALS_CR_DT <= NEW_PAT_ALS_CR_DT;
    END IF;
    IF NEW_PAT_ANLY_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ANALYSIS_HIST
          WHERE ANLY_CR_DT <= NEW_PAT_ANLY_CR_DT;
    END IF;
    IF NEW_PAT_AANLY_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_ANLY_HIST
          WHERE AANLY_CR_DT <= NEW_PAT_AANLY_CR_DT;
    END IF;
    IF NEW_PAT_AFM_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ANLY_FORMAT_HIST
          WHERE AFM_CR_DT <= NEW_PAT_AFM_CR_DT;
    END IF;
    IF NEW_PAT_ALM_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ANLY_LEVEL_HIST
          WHERE ALM_CR_DT <= NEW_PAT_ALM_CR_DT;
    END IF;
    IF NEW_PAT_AAL_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_ANLY_LEVEL_HIST
          WHERE AAL_CR_DT <= NEW_PAT_AAL_CR_DT;
    END IF;
    IF NEW_PAT_AAF_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ANLY_ACNT_FORMAT_HIST
          WHERE AAF_CR_DT <= NEW_PAT_AAF_CR_DT;
    END IF;
    IF NEW_PAT_VCM_CR_DT IS NOT NULL THEN
          DELETE FROM FH_VALID_COMB_HIST
          WHERE VCM_CR_DT <= NEW_PAT_VCM_CR_DT;
    END IF;
    IF NEW_PAT_APER_CR_DT IS NOT NULL THEN
          DELETE FROM FH_ACNT_PERIOD_HIST
          WHERE APER_CR_DT <= NEW_PAT_APER_CR_DT;
    END IF;
    IF NEW_PAT_PHS_CR_DT IS NOT NULL THEN
          DELETE FROM FS_PROC_HEADER
          WHERE PHS_CR_DT <= NEW_PAT_PHS_CR_DT;
    END IF;
    IF NEW_PAT_PDS_CR_DT IS NOT NULL THEN
          DELETE FROM FS_PROC_DETAIL
          WHERE PDS_CR_DT <= NEW_PAT_PDS_CR_DT;
    END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_ALLOCATION_JV (
 OLD_AJV_KEY_NO            IN      NUMBER,
 OLD_AJV_REF_COMP_CODE     IN      VARCHAR2,
 OLD_AJV_REF_ACNT_YEAR     IN      NUMBER,
 OLD_AJV_REF_TRAN_CODE     IN      VARCHAR2,
 OLD_AJV_REF_DOC_NO        IN      NUMBER,
 OLD_AJV_REF_SEQ_NO        IN      NUMBER,
 OLD_AJV_COMP_CODE         IN      VARCHAR2,
 OLD_AJV_TRAN_CODE         IN      VARCHAR2,
 OLD_AJV_START_DT          IN      DATE,
 OLD_AJV_UPTO_DT           IN      DATE,
 OLD_AJV_DOC_AMT           IN      NUMBER,
 OLD_AJV_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_AJV_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_AJV_DEPT_CODE         IN      VARCHAR2,
 OLD_AJV_DIVN_CODE         IN      VARCHAR2,
 OLD_AJV_HEAD_NO_1         IN      NUMBER,
 OLD_AJV_ANLY_CODE_1       IN      VARCHAR2,
 OLD_AJV_HEAD_NO_2         IN      NUMBER,
 OLD_AJV_ANLY_CODE_2       IN      VARCHAR2,
 OLD_AJV_ACTY_CODE_1       IN      VARCHAR2,
 OLD_AJV_ACTY_CODE_2       IN      VARCHAR2,
 OLD_AJV_CR_UID            IN      VARCHAR2,
 OLD_AJV_CR_DT             IN      DATE,
 NEW_AJV_KEY_NO            IN OUT  NUMBER,
 NEW_AJV_REF_COMP_CODE     IN OUT  VARCHAR2,
 NEW_AJV_REF_ACNT_YEAR     IN OUT  NUMBER,
 NEW_AJV_REF_TRAN_CODE     IN OUT  VARCHAR2,
 NEW_AJV_REF_DOC_NO        IN OUT  NUMBER,
 NEW_AJV_REF_SEQ_NO        IN OUT  NUMBER,
 NEW_AJV_COMP_CODE         IN OUT  VARCHAR2,
 NEW_AJV_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_AJV_START_DT          IN OUT  DATE,
 NEW_AJV_UPTO_DT           IN OUT  DATE,
 NEW_AJV_DOC_AMT           IN OUT  NUMBER,
 NEW_AJV_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_AJV_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_AJV_DEPT_CODE         IN OUT  VARCHAR2,
 NEW_AJV_DIVN_CODE         IN OUT  VARCHAR2,
 NEW_AJV_HEAD_NO_1         IN OUT  NUMBER,
 NEW_AJV_ANLY_CODE_1       IN OUT  VARCHAR2,
 NEW_AJV_HEAD_NO_2         IN OUT  NUMBER,
 NEW_AJV_ANLY_CODE_2       IN OUT  VARCHAR2,
 NEW_AJV_ACTY_CODE_1       IN OUT  VARCHAR2,
 NEW_AJV_ACTY_CODE_2       IN OUT  VARCHAR2,
 NEW_AJV_CR_UID            IN OUT  VARCHAR2,
 NEW_AJV_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
T_ERR_NO    NUMBER(6) ;
BEGIN
IF TRG_MODE = 'I' THEN
   F_CREATE_AJV_DETAIL(NEW_AJV_KEY_NO, NEW_AJV_START_DT, NEW_AJV_UPTO_DT,
                       NEW_AJV_REF_COMP_CODE, NEW_AJV_DOC_AMT,
                       NEW_AJV_CR_UID, NEW_AJV_CR_DT, T_ERR_NO) ;
END IF ;
IF TRG_MODE = 'U' THEN
   F_CREATE_AJV_DETAIL(NEW_AJV_KEY_NO, NEW_AJV_START_DT, NEW_AJV_UPTO_DT,
                       NEW_AJV_REF_COMP_CODE, NEW_AJV_DOC_AMT,
                       NEW_AJV_CR_UID, NEW_AJV_CR_DT, T_ERR_NO) ;
END IF ;
IF TRG_MODE = 'D' THEN
   DELETE FROM FT_AJV_DETAIL
   WHERE  AJD_KEY_NO = OLD_AJV_KEY_NO ;
END IF ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_FT_BOUNCED_CHEQUE (
 OLD_BCT_KEY_NO            IN      NUMBER,
 OLD_BCT_COMP_CODE         IN      VARCHAR2,
 OLD_BCT_TRAN_CODE         IN      VARCHAR2,
 OLD_BCT_ACNT_YEAR         IN      NUMBER,
 OLD_BCT_DOC_NO            IN      NUMBER,
 OLD_BCT_SEQ_NO            IN      NUMBER,
 OLD_BCT_DOC_DT            IN      DATE,
 OLD_BCT_DOC_REF           IN      VARCHAR2,
 OLD_BCT_DESC              IN      VARCHAR2,
 OLD_BCT_REF_TRAN_CODE     IN      VARCHAR2,
 OLD_BCT_REF_ACNT_YEAR     IN      NUMBER,
 OLD_BCT_REF_DOC_NO        IN      NUMBER,
 OLD_BCT_REF_SEQ_NO        IN      NUMBER,
 OLD_BCT_CR_UID            IN      VARCHAR2,
 OLD_BCT_CR_DT             IN      DATE,
 OLD_BANK_MAIN_ACNT_CODE   IN      VARCHAR2,
 OLD_BANK_SUB_ACNT_CODE    IN      VARCHAR2,
 OLD_BANK_CURR_CODE        IN      VARCHAR2,
 NEW_BCT_KEY_NO            IN OUT  NUMBER,
 NEW_BCT_COMP_CODE         IN OUT  VARCHAR2,
 NEW_BCT_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_BCT_ACNT_YEAR         IN OUT  NUMBER,
 NEW_BCT_DOC_NO            IN OUT  NUMBER,
 NEW_BCT_SEQ_NO            IN OUT  NUMBER,
 NEW_BCT_DOC_DT            IN OUT  DATE,
 NEW_BCT_DOC_REF           IN OUT  VARCHAR2,
 NEW_BCT_DESC              IN OUT  VARCHAR2,
 NEW_BCT_REF_TRAN_CODE     IN OUT  VARCHAR2,
 NEW_BCT_REF_ACNT_YEAR     IN OUT  NUMBER,
 NEW_BCT_REF_DOC_NO        IN OUT  NUMBER,
 NEW_BCT_REF_SEQ_NO        IN OUT  NUMBER,
 NEW_BCT_CR_UID            IN OUT  VARCHAR2,
 NEW_BCT_CR_DT             IN OUT  DATE,
 NEW_BANK_MAIN_ACNT_CODE   IN OUT  VARCHAR2,
 NEW_BANK_SUB_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_BANK_CURR_CODE        IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
CURSOR SEL_RCPT_ENTRY IS
        SELECT TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO,
               TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
               TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
               TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
               TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT,
               TD_OTH_REF, TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2,
               TD_DESC, TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG,
               TD_MONTH_PRC_FLAG, TD_BILL_FC_AMT, TD_BILL_LC_AMT,
               TD_BILL_STATUS, TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT
        FROM   FT_CUR_TRANS_DETAIL
        WHERE  TD_COMP_CODE = NEW_BCT_COMP_CODE
          AND  TD_ACNT_YEAR = NEW_BCT_REF_ACNT_YEAR
          AND  TD_TRAN_CODE = NEW_BCT_REF_TRAN_CODE
          AND  TD_DOC_NO    = NEW_BCT_REF_DOC_NO
          AND  TD_SEQ_NO    = NEW_BCT_REF_SEQ_NO;
CURSOR SEL_FROM_OST(M_BCT_SEQ_NO NUMBER) IS
       SELECT OST_KEY_NO, OST_DOC_DT, OST_DUE_DT,
              OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH
       FROM   FT_OS
       WHERE  OST_COMP_CODE = NEW_BCT_COMP_CODE
       AND    OST_ACNT_YEAR = NEW_BCT_ACNT_YEAR
       AND    OST_TRAN_CODE = NEW_BCT_TRAN_CODE
       AND    OST_DOC_NO    = NEW_BCT_DOC_NO
       AND    OST_SEQ_NO    = M_BCT_SEQ_NO ;
CURSOR SEL_BANK_ENTRY IS
        SELECT TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
               TD_HEAD_NO_2, TD_ANLY_CODE_2
        FROM   FT_CUR_TRANS_DETAIL
        WHERE  TD_COMP_CODE = NEW_BCT_COMP_CODE
          AND  TD_ACNT_YEAR = NEW_BCT_REF_ACNT_YEAR
          AND  TD_TRAN_CODE = NEW_BCT_REF_TRAN_CODE
          AND  TD_DOC_NO    = NEW_BCT_REF_DOC_NO
          AND  TD_MAIN_ACNT_CODE = NEW_BANK_MAIN_ACNT_CODE
          AND  TD_SUB_ACNT_CODE = NEW_BANK_SUB_ACNT_CODE;
       P_REF_DOC_DT           DATE;
       P_REF_DUE_DT           DATE;
       P_REF_CAL_YEAR         NUMBER(2);
       P_REF_CAL_MONTH        NUMBER(2);
       TEMP_FC_AMT        NUMBER;
       TEMP_LC_AMT        NUMBER;
         P_CAL_YEAR           NUMBER(2) ;
         P_CAL_MONTH          NUMBER(2) ;
         P_ACNT_YEAR          NUMBER(2) ;
         P_ERR_NO             NUMBER(10) ;
         P_KEY_NO             NUMBER(8) ;
         P_TD_COMP_CODE       VARCHAR2(3) ;
         P_TD_ACNT_YEAR       NUMBER(2) ;
         P_TD_TRAN_CODE       VARCHAR2(3) ;
         P_TD_DOC_NO          NUMBER(6) ;
         P_TD_SEQ_NO          NUMBER(3) ;
         P_TD_MAIN_ACNT_CODE  VARCHAR2(6) ;
         P_TD_SUB_ACNT_CODE   VARCHAR2(6) ;
         P_TD_DIVN_CODE       VARCHAR2(6) ;
         P_TD_DEPT_CODE       VARCHAR2(6) ;
         P_TD_HEAD_NO_1       NUMBER(1) ;
         P_TD_ANLY_CODE_1     VARCHAR2(6);
         P_TD_HEAD_NO_2       NUMBER(1);
         P_TD_ANLY_CODE_2     VARCHAR2(6);
         P_TD_CURR_CODE       VARCHAR2(3) ;
         P_TD_DOC_AMT         NUMBER(14,3) ;
         P_TD_DOC_DRCR_FLAG   VARCHAR2(1) ;
         P_TD_FC_AMT          NUMBER(14,3) ;
         P_TD_DOC_REF         VARCHAR2(15) ;
         P_TD_DOC_DUE_DT      DATE ;
         P_TD_OTH_REF         VARCHAR2(15) ;
         P_TD_ACTY_VALUE_CODE_1 VARCHAR2(6);
         P_TD_ACTY_VALUE_CODE_2  VARCHAR2(6);
         P_TD_DESC               VARCHAR2(2000) ;
         P_TD_DBK_PRINT_FLAG     VARCHAR2(1) ;
         P_TD_LED_PRINT_FLAG     VARCHAR2(1) ;
         P_TD_MONTH_PRC_FLAG     VARCHAR2(1) ;
         P_TD_BILL_FC_AMT        NUMBER(14,3) ;
         P_TD_BILL_LC_AMT        NUMBER(14,3) ;
         P_TD_BILL_STATUS        VARCHAR2(1) ;
         P_TD_PYMT_APPR_FLAG     VARCHAR2(1) ;
         P_TD_CR_UID             VARCHAR2(15) ;
         P_TD_CR_DT              DATE ;
         P_BCT_SEQ_NO            NUMBER(3) ;
         P2_TD_DIVN_CODE         VARCHAR2(6) ;
         P2_TD_DEPT_CODE         VARCHAR2(6) ;
         P2_TD_HEAD_NO_1         NUMBER(1) ;
         P2_TD_ANLY_CODE_1       VARCHAR2(6);
         P2_TD_HEAD_NO_2         NUMBER(1);
         P2_TD_ANLY_CODE_2       VARCHAR2(6);
         P_OST_KEY_NO            NUMBER(8);
         P_PHS_KEY_NO            NUMBER(10) ;
BEGIN
   IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
      RAISE_APPLICATION_ERROR(-20015,'Cannot Update / Delete Record');
   END IF;
   F_VAL_OPCL(NEW_BCT_COMP_CODE, NEW_BCT_DOC_DT, P_ERR_NO,
                  P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
   END IF;
IF TRG_MODE = 'I' THEN
   IF SEL_RCPT_ENTRY%ISOPEN THEN
      CLOSE SEL_RCPT_ENTRY;
   END IF;
   /* IF NEW_BCT_SEQ_NO = 1 THEN */
      F_VAL_DUP_DOC(NEW_BCT_COMP_CODE, NEW_BCT_ACNT_YEAR,
                    NEW_BCT_TRAN_CODE, NEW_BCT_DOC_NO, P_ERR_NO);
 /*   IF P_ERR_NO != 0 THEN
         STD_ERROR_ROUTINE(P_ERR_NO,'Record for Receipt already exists');
     END IF;  */
      /* Insert into audit trail header */
   IF P_ERR_NO = 0 THEN
      SELECT SEQ_PHS_KEY_NO.NEXTVAL
      INTO   P_PHS_KEY_NO
      FROM   DUAL ;
      INSERT INTO FS_PROC_HEADER
             (PHS_KEY_NO, PHS_USER_ID, PHS_PROC_DT, PHS_PROC_STATUS,
              PHS_COMP_CODE, PHS_TRAN_FRM, PHS_TRAN_TO, PHS_TRAN_DT_FRM,
              PHS_TRAN_DT_TO, PHS_DOC_NO_FRM, PHS_DOC_NO_TO,
              PHS_USER_PATTERN, PHS_HEAD_REC_TOT, PHS_DETAIL_REC_TOT,
              PHS_AMT_TOT, PHS_ERROR_NAME, PHS_CR_UID, PHS_CR_DT)
      VALUES (P_PHS_KEY_NO, NEW_BCT_CR_UID, SYSDATE, '', NEW_BCT_COMP_CODE,
              NEW_BCT_TRAN_CODE, NEW_BCT_TRAN_CODE,
              NEW_BCT_DOC_DT, NEW_BCT_DOC_DT, NEW_BCT_DOC_NO,
              NEW_BCT_DOC_NO, NEW_BCT_CR_UID, '1', '', '', '',
              NEW_BCT_CR_UID, NEW_BCT_CR_DT) ;
      INSERT INTO FT_CUR_TRANS_HEADER
      VALUES ( NEW_BCT_COMP_CODE, NEW_BCT_ACNT_YEAR, NEW_BCT_TRAN_CODE,
               NEW_BCT_DOC_NO , NEW_BCT_DOC_DT ,P_CAL_YEAR ,
               P_CAL_MONTH ,NEW_BCT_DOC_REF ,sysdate , sysdate ,
               '','',P_PHS_KEY_NO,'','',NEW_BCT_CR_UID , NEW_BCT_CR_DT ) ;
   END IF;
       SELECT NVL(MAX(TD_SEQ_NO), 0) + 1
       INTO   P_BCT_SEQ_NO
       FROM   FT_CUR_TRANS_DETAIL
       WHERE  TD_COMP_CODE = NEW_BCT_COMP_CODE
       AND    TD_ACNT_YEAR = NEW_BCT_ACNT_YEAR
       AND    TD_TRAN_CODE = NEW_BCT_TRAN_CODE
       AND    TD_DOC_NO = NEW_BCT_DOC_NO;
   OPEN SEL_RCPT_ENTRY ;
   /* P_BCT_SEQ_NO := NEW_BCT_SEQ_NO; */
   LOOP
       FETCH SEL_RCPT_ENTRY INTO
         P_TD_COMP_CODE ,
         P_TD_ACNT_YEAR ,
         P_TD_TRAN_CODE ,
         P_TD_DOC_NO ,
         P_TD_SEQ_NO ,
         P_TD_MAIN_ACNT_CODE ,
         P_TD_SUB_ACNT_CODE  ,
         P_TD_DIVN_CODE     ,
         P_TD_DEPT_CODE    ,
         P_TD_HEAD_NO_1   ,
         P_TD_ANLY_CODE_1,
         P_TD_HEAD_NO_2 ,
         P_TD_ANLY_CODE_2,
         P_TD_CURR_CODE ,
         P_TD_DOC_AMT  ,
         P_TD_DOC_DRCR_FLAG,
         P_TD_FC_AMT      ,
         P_TD_DOC_REF    ,
         P_TD_DOC_DUE_DT,
         P_TD_OTH_REF  ,
         P_TD_ACTY_VALUE_CODE_1,
         P_TD_ACTY_VALUE_CODE_2,
         P_TD_DESC            ,
         P_TD_DBK_PRINT_FLAG ,
         P_TD_LED_PRINT_FLAG,
         P_TD_MONTH_PRC_FLAG,
         P_TD_BILL_FC_AMT  ,
         P_TD_BILL_LC_AMT ,
         P_TD_BILL_STATUS,
         P_TD_PYMT_APPR_FLAG ,
         P_TD_CR_UID ,
         P_TD_CR_DT   ;
     IF SEL_RCPT_ENTRY%NOTFOUND THEN
        EXIT;
     END IF;
     INSERT INTO FT_CUR_TRANS_DETAIL
              (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO,
               TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
               TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
               TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
               TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT,
               TD_OTH_REF, TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2,
               TD_DESC, TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG,
               TD_MONTH_PRC_FLAG, TD_BILL_FC_AMT, TD_BILL_LC_AMT,
               TD_BILL_STATUS, TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
     VALUES   (NEW_BCT_COMP_CODE,NEW_BCT_ACNT_YEAR,NEW_BCT_TRAN_CODE,
               NEW_BCT_DOC_NO ,P_BCT_SEQ_NO,
               P_TD_MAIN_ACNT_CODE ,
               P_TD_SUB_ACNT_CODE ,
               P_TD_DIVN_CODE,
               P_TD_DEPT_CODE ,
               P_TD_HEAD_NO_1,
               P_TD_ANLY_CODE_1,
               P_TD_HEAD_NO_2 ,
               P_TD_ANLY_CODE_2 ,
               P_TD_CURR_CODE ,
               P_TD_DOC_AMT ,
               DECODE(P_TD_DOC_DRCR_FLAG,'D','C','D') ,
               P_TD_FC_AMT ,
               P_TD_DOC_REF ,
               NEW_BCT_DOC_DT,
               P_TD_OTH_REF,
               P_TD_ACTY_VALUE_CODE_1,
               P_TD_ACTY_VALUE_CODE_2 ,
               P_TD_DESC ,
               P_TD_DBK_PRINT_FLAG ,
               P_TD_LED_PRINT_FLAG ,
               P_TD_MONTH_PRC_FLAG ,
               P_TD_BILL_FC_AMT  ,
               P_TD_BILL_LC_AMT ,
               P_TD_BILL_STATUS ,
               P_TD_PYMT_APPR_FLAG ,
               NEW_BCT_CR_UID ,
               NEW_BCT_CR_DT ) ;
      IF NEW_BCT_REF_SEQ_NO = P_TD_SEQ_NO THEN
         OPEN SEL_FROM_OST(P_BCT_SEQ_NO) ;
         FETCH SEL_FROM_OST
         INTO P_KEY_NO, P_REF_DOC_DT,
              P_REF_DUE_DT, P_REF_CAL_YEAR, P_REF_CAL_MONTH;
         F_OS(P_OST_KEY_NO);
         INSERT INTO FT_OS
         (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
          OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
          OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
          OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
          OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
          OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
          OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
          OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
          OST_REF_KEY_NO, OST_LC_ORG_AMT, OST_FC_ORG_AMT,
          OST_REF_COMP_CODE, OST_REF_ACNT_YEAR,
          OST_REF_TRAN_CODE, OST_REF_SEQ_NO,
          OST_REF_DOC_NO, OST_REF_DOC_DT,
          OST_REF_DOC_CAL_YEAR, OST_REF_DOC_CAL_MONTH,
          OST_REF_DUE_DT,
          OST_TYPE, OST_CR_UID, OST_CR_DT)
         SELECT
          P_OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
          OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
          OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
          OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
          OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
          OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
          OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
          OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
          P_KEY_NO, OST_LC_ORG_AMT, OST_FC_ORG_AMT,
          NEW_BCT_COMP_CODE, NEW_BCT_ACNT_YEAR,
          NEW_BCT_TRAN_CODE, P_BCT_SEQ_NO,
          NEW_BCT_DOC_NO, P_REF_DOC_DT,
          P_REF_CAL_YEAR, P_REF_CAL_MONTH,
          P_REF_DUE_DT,
          'R', OST_CR_UID, SYSDATE
         FROM FT_OS
         WHERE  OST_COMP_CODE = NEW_BCT_COMP_CODE
         AND    OST_ACNT_YEAR = NEW_BCT_ACNT_YEAR
         AND    OST_TRAN_CODE = NEW_BCT_REF_TRAN_CODE
         AND    OST_DOC_NO    = NEW_BCT_REF_DOC_NO
         AND    OST_SEQ_NO    = NEW_BCT_REF_SEQ_NO;
         DELETE FROM FT_OS
         WHERE  OST_COMP_CODE = NEW_BCT_COMP_CODE
         AND    OST_ACNT_YEAR = NEW_BCT_ACNT_YEAR
         AND    OST_TRAN_CODE = NEW_BCT_REF_TRAN_CODE
         AND    OST_DOC_NO    = NEW_BCT_REF_DOC_NO
         AND    OST_SEQ_NO    = NEW_BCT_REF_SEQ_NO
         AND    OST_TYPE IS NULL;
         CLOSE SEL_FROM_OST ;
      END IF;
     P_BCT_SEQ_NO := NVL(P_BCT_SEQ_NO,0) + 1;
   IF SEL_BANK_ENTRY%ISOPEN THEN
      CLOSE SEL_BANK_ENTRY;
   END IF;
   OPEN SEL_BANK_ENTRY ;
   FETCH SEL_BANK_ENTRY INTO
        P2_TD_DIVN_CODE, P2_TD_DEPT_CODE, P2_TD_HEAD_NO_1, P2_TD_ANLY_CODE_1,
        P2_TD_HEAD_NO_2, P2_TD_ANLY_CODE_2;
   IF SEL_BANK_ENTRY%NOTFOUND THEN
        P2_TD_DIVN_CODE := P_TD_DIVN_CODE;
        P2_TD_DEPT_CODE := P_TD_DEPT_CODE;
        P2_TD_HEAD_NO_1 := P_TD_HEAD_NO_1;
        P2_TD_ANLY_CODE_1 := P_TD_ANLY_CODE_1;
        P2_TD_HEAD_NO_2 := P_TD_HEAD_NO_2;
        P2_TD_ANLY_CODE_2 := P_TD_ANLY_CODE_2;
   END IF;
   IF NVL(P_TD_CURR_CODE,'XXXX') = NVL(NEW_BANK_CURR_CODE,'XXXX') THEN
      TEMP_FC_AMT   := P_TD_FC_AMT ;
      TEMP_LC_AMT   := P_TD_DOC_AMT ;
   ELSE   /* otherwise it is base currency */
      TEMP_FC_AMT   := P_TD_DOC_AMT ;
      TEMP_LC_AMT   := P_TD_DOC_AMT ;
   END IF;
     INSERT INTO FT_CUR_TRANS_DETAIL
              (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO,
               TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
               TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
               TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
               TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT,
               TD_OTH_REF, TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2,
               TD_DESC, TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG,
               TD_MONTH_PRC_FLAG, TD_BILL_FC_AMT, TD_BILL_LC_AMT,
               TD_BILL_STATUS, TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
     VALUES   (NEW_BCT_COMP_CODE,NEW_BCT_ACNT_YEAR,NEW_BCT_TRAN_CODE,
               NEW_BCT_DOC_NO ,P_BCT_SEQ_NO,
               NEW_BANK_MAIN_ACNT_CODE ,
               NEW_BANK_SUB_ACNT_CODE ,
               P2_TD_DIVN_CODE,
               P2_TD_DEPT_CODE ,
               P2_TD_HEAD_NO_1,
               P2_TD_ANLY_CODE_1,
               P2_TD_HEAD_NO_2 ,
               P2_TD_ANLY_CODE_2 ,
               P_TD_CURR_CODE ,
               TEMP_LC_AMT ,
               P_TD_DOC_DRCR_FLAG,
               TEMP_FC_AMT ,
               '' ,
               NEW_BCT_DOC_DT,
               '',
               '',
               '' ,
               '' ,
               'N' ,
               'N' ,
               'N' ,
               ''  ,
               '' ,
               '' ,
               '0' ,
               NEW_BCT_CR_UID ,
               NEW_BCT_CR_DT ) ;
   CLOSE SEL_BANK_ENTRY ;
  END LOOP;
  CLOSE SEL_RCPT_ENTRY ;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_CASH_RIMB (
 OLD_RIMB_KEY_NO              IN      NUMBER,
 OLD_RIMB_COMP_CODE           IN      VARCHAR2,
 OLD_RIMB_CASH_MAIN_ACNT_CODE IN      VARCHAR2,
 OLD_RIMB_DOC_NO              IN      NUMBER,
 OLD_RIMB_DOC_DT              IN      DATE,
 OLD_RIMB_BANK_MAIN_ACNT_CODE IN      VARCHAR2,
 OLD_RIMB_TOT_DISB_AMT        IN      NUMBER,
 OLD_RIMB_CR_UID              IN      VARCHAR2,
Press <Enter> to continue...
 OLD_RIMB_CR_DT               IN      DATE,
 NEW_RIMB_KEY_NO              IN OUT  NUMBER,
 NEW_RIMB_COMP_CODE           IN OUT  VARCHAR2,
 NEW_RIMB_CASH_MAIN_ACNT_CODE IN OUT  VARCHAR2,
 NEW_RIMB_DOC_NO              IN OUT  NUMBER,
 NEW_RIMB_DOC_DT              IN OUT  DATE,
 NEW_RIMB_PETTY_CASH_NO       IN OUT  VARCHAR2,
 NEW_RIMB_BANK_MAIN_ACNT_CODE IN OUT  VARCHAR2,
 NEW_RIMB_BANK_SUB_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_RIMB_BANK_DIVN_CODE      IN OUT  VARCHAR2,
 NEW_RIMB_BANK_DEPT_CODE      IN OUT  VARCHAR2,
 NEW_RIMB_BANK_HEAD_NO_1      IN OUT  NUMBER,
 NEW_RIMB_BANK_HEAD_NO_2      IN OUT  NUMBER,
 NEW_RIMB_BANK_ANLY_CODE_1    IN OUT  VARCHAR2,
 NEW_RIMB_BANK_ANLY_CODE_2    IN OUT  VARCHAR2,
 N_RIMB_BANK_ACTY_VALUE_CODE_1    IN OUT  VARCHAR2,
 N_RIMB_BANK_ACTY_VALUE_CODE_2    IN OUT  VARCHAR2,
 NEW_RIMB_TOT_DISB_AMT        IN OUT  NUMBER,
 NEW_RIMB_CR_UID              IN OUT  VARCHAR2,
 NEW_RIMB_CR_DT               IN OUT  DATE,
 TRG_MODE                     IN OUT  VARCHAR2,
 TRG_ERR_NO                      OUT  NUMBER,
 TRG_ERR_MSG                     OUT  VARCHAR2) AS
P_LC_AMT         NUMBER(14,3);
P_TOT_LC_AMT     NUMBER(14,3);
P_NAME           VARCHAR2(30);
P_ERR_NO         NUMBER(6);
P_ACNT_YEAR      NUMBER(2);
P_CUR_ACNT_YEAR  NUMBER(2);
P_RIMB_TRAN_CODE VARCHAR2(3);
P_DOC_CAL_MONTH  NUMBER(2);
P_DOC_CAL_YEAR   NUMBER(2);
P_PHS_KEY_NO     NUMBER(10) ;
P_SUB_ACNT_CODE  VARCHAR2(6);
P_DIVN_CODE      VARCHAR2(6);
P_DEPT_CODE      VARCHAR2(6);
P_ANLY_CODE_1    VARCHAR2(6);
P_ANLY_CODE_2    VARCHAR2(6);
P_ACTY_VALUE_CODE_1 VARCHAR2(6);
P_ACTY_VALUE_CODE_2 VARCHAR2(6);
CURSOR SEL_RIMB_TC IS
SELECT SUBSTR(PARA_VALUE,1,3)
FROM   FP_PARAMETER
WHERE  PARA_ID = 'RIMB.TC';
CURSOR SEL_DISB IS
SELECT DISB_LC_AMT
FROM   FT_CASH_DISB
WHERE  DISB_RIMB_KEY_NO IS NULL
FOR UPDATE OF DISB_RIMB_KEY_NO;
CURSOR SEL_CASH_ACNT_DETL IS
SELECT CS_CASH_SUB_ACNT_CODE, CS_CASH_DIVN_CODE, CS_CASH_DEPT_CODE,
       CS_CASH_ANLY_CODE_1,   CS_CASH_ANLY_CODE_2, CS_CASH_ACTY_VALUE_CODE_1,
       CS_CASH_ACTY_VALUE_CODE_2
FROM   FT_CASH_SUMMARY
WHERE  CS_PETTY_CASH_NO = NEW_RIMB_PETTY_CASH_NO
AND    CS_CASH_MAIN_ACNT_CODE = NEW_RIMB_CASH_MAIN_ACNT_CODE;
BEGIN
IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
     RAISE_APPLICATION_ERROR(-20001, 'Cannot update or delete Reimbursement');
END IF;
P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_RIMB_COMP_CODE);
F_VAL_OPCL(NEW_RIMB_COMP_CODE, NEW_RIMB_DOC_DT,
      P_ERR_NO, P_DOC_CAL_YEAR, P_DOC_CAL_MONTH,
      P_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
   RAISE_APPLICATION_ERROR(-20001,'Invalid Date - Accounting period');
END IF;
IF P_ACNT_YEAR != P_CUR_ACNT_YEAR THEN
   RAISE_APPLICATION_ERROR(-20001,'Invalid Date - Accounting year');
END IF;
IF SEL_RIMB_TC%ISOPEN THEN
   CLOSE SEL_RIMB_TC;
END IF;
OPEN SEL_RIMB_TC;
FETCH SEL_RIMB_TC INTO P_RIMB_TRAN_CODE;
IF SEL_RIMB_TC%NOTFOUND THEN
   RAISE_APPLICATION_ERROR(-20001,'Reimbursement TC not found');
END IF;
CLOSE SEL_RIMB_TC;
/* validate the transaction code
F_VAL_TRAN(P_RIMB_TRAN_CODE,'N',P_NAME, P_ERR_NO);
*/
IF SEL_DISB%ISOPEN THEN
     CLOSE SEL_DISB;
END IF;
OPEN SEL_DISB;
P_TOT_LC_AMT := 0;
<<DISB_LOOP>>
LOOP
FETCH SEL_DISB INTO P_LC_AMT;
EXIT WHEN SEL_DISB%NOTFOUND;
P_TOT_LC_AMT := NVL(P_TOT_LC_AMT,0) + NVL(P_LC_AMT,0);
UPDATE FT_CASH_DISB
SET    DISB_RIMB_KEY_NO = NEW_RIMB_KEY_NO
WHERE  CURRENT OF SEL_DISB;
END LOOP DISB_LOOP;
CLOSE SEL_DISB;
IF P_TOT_LC_AMT = 0 THEN
     RAISE_APPLICATION_ERROR(-20002, 'No Disbursements');
END IF;
UPDATE FT_CASH_SUMMARY
SET    CS_TOT_DISB_AMT = NVL(CS_TOT_DISB_AMT,0) - NVL(P_TOT_LC_AMT,0),
       CS_BAL_AMT      = NVL(CS_BAL_AMT,0) + NVL(P_TOT_LC_AMT,0)
WHERE  CS_COMP_CODE = NEW_RIMB_COMP_CODE
AND    CS_CASH_MAIN_ACNT_CODE = NEW_RIMB_CASH_MAIN_ACNT_CODE;
      SELECT SEQ_PHS_KEY_NO.NEXTVAL
      INTO   P_PHS_KEY_NO
      FROM   DUAL ;
      INSERT INTO FS_PROC_HEADER
             (PHS_KEY_NO, PHS_USER_ID, PHS_PROC_DT, PHS_PROC_STATUS,
              PHS_COMP_CODE, PHS_TRAN_FRM, PHS_TRAN_TO, PHS_TRAN_DT_FRM,
              PHS_TRAN_DT_TO, PHS_DOC_NO_FRM, PHS_DOC_NO_TO,
              PHS_USER_PATTERN, PHS_HEAD_REC_TOT, PHS_DETAIL_REC_TOT,
              PHS_AMT_TOT, PHS_ERROR_NAME, PHS_CR_UID, PHS_CR_DT)
      VALUES (P_PHS_KEY_NO, NEW_RIMB_CR_UID, SYSDATE, '', NEW_RIMB_COMP_CODE,
              P_RIMB_TRAN_CODE, P_RIMB_TRAN_CODE,
              NEW_RIMB_DOC_DT, NEW_RIMB_DOC_DT, NEW_RIMB_DOC_NO,
              NEW_RIMB_DOC_NO, NEW_RIMB_CR_UID, '1', '', '', '',
              NEW_RIMB_CR_UID, NEW_RIMB_CR_DT) ;
/* Create another voucher : cr- Bank and dr - Cash acnt */
/* Insert Transaction Header */
INSERT INTO FT_CUR_TRANS_HEADER
(TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE, TH_DOC_NO,
 TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH, TH_DOC_REF,
 TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE, TH_DEPT_CODE,
 TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION, TH_CR_UID, TH_CR_DT)
 VALUES
 (NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
  NEW_RIMB_DOC_NO, NEW_RIMB_DOC_DT, P_DOC_CAL_YEAR,
  P_DOC_CAL_MONTH, NULL, NULL, NEW_RIMB_DOC_DT, NULL, NULL, P_PHS_KEY_NO,
  'REIMBURSEMENT GENERATED BY SYSTEM', '', NEW_RIMB_CR_UID,
  NEW_RIMB_CR_DT);
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_DOC_DUE_DT,
 TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
 TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
 SELECT
 NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
 NEW_RIMB_DOC_NO, 1, NEW_RIMB_BANK_MAIN_ACNT_CODE, NEW_RIMB_BANK_SUB_ACNT_CODE,
 NEW_RIMB_BANK_DIVN_CODE, NEW_RIMB_BANK_DEPT_CODE, '1',
 NEW_RIMB_BANK_ANLY_CODE_1, '2', NEW_RIMB_BANK_ANLY_CODE_2,
 SUM(DISB_LC_AMT), 'C', NEW_RIMB_DOC_DT, N_RIMB_BANK_ACTY_VALUE_CODE_1,
 N_RIMB_BANK_ACTY_VALUE_CODE_2, NULL, 'N', 'N', 'N', '0',
 NEW_RIMB_CR_UID, NEW_RIMB_CR_DT
 FROM FT_CASH_DISB
 WHERE DISB_RIMB_KEY_NO = NEW_RIMB_KEY_NO;
 /* Get accounting details of Cash Account */
 IF SEL_CASH_ACNT_DETL%ISOPEN THEN
    CLOSE SEL_CASH_ACNT_DETL;
 END IF;
 OPEN SEL_CASH_ACNT_DETL;
 FETCH SEL_CASH_ACNT_DETL INTO P_SUB_ACNT_CODE, P_DIVN_CODE, P_DEPT_CODE,
         P_ANLY_CODE_1, P_ANLY_CODE_2, P_ACTY_VALUE_CODE_1, P_ACTY_VALUE_CODE_2;
 IF SEL_CASH_ACNT_DETL%NOTFOUND THEN
    RAISE_APPLICATION_ERROR(-20001,'Petty Cash Summary details not found');
 END IF;
 CLOSE SEL_CASH_ACNT_DETL;
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_DOC_DUE_DT,
 TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
 TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
 SELECT
 NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
 NEW_RIMB_DOC_NO, 2, NEW_RIMB_CASH_MAIN_ACNT_CODE, P_SUB_ACNT_CODE,
 P_DIVN_CODE, P_DEPT_CODE, '1',
 P_ANLY_CODE_1, '2', P_ANLY_CODE_2,
 SUM(DISB_LC_AMT), 'D', NEW_RIMB_DOC_DT, P_ACTY_VALUE_CODE_1,
 P_ACTY_VALUE_CODE_2, NULL, 'N', 'N', 'N', '0',
 NEW_RIMB_CR_UID, NEW_RIMB_CR_DT
 FROM FT_CASH_DISB
 WHERE DISB_RIMB_KEY_NO = NEW_RIMB_KEY_NO;
/* Insert Transaction Header */
INSERT INTO FT_CUR_TRANS_HEADER
(TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE, TH_DOC_NO,
 TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH, TH_DOC_REF,
 TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE, TH_DEPT_CODE,
 TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION, TH_CR_UID, TH_CR_DT)
 VALUES
 (NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
  NVL(NEW_RIMB_DOC_NO,0) + 1, NEW_RIMB_DOC_DT, P_DOC_CAL_YEAR,
  P_DOC_CAL_MONTH, NULL, NULL, NEW_RIMB_DOC_DT, NULL, NULL, P_PHS_KEY_NO,
  'REIMBURSEMENT GENERATED BY SYSTEM', '', NEW_RIMB_CR_UID,
  NEW_RIMB_CR_DT);
/* Create another voucher : cr- cash and dr - disbursement acnts */
/* Insert Transaction Details */
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_DOC_DUE_DT,
 TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
 TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
 SELECT
 NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
 NVL(NEW_RIMB_DOC_NO,0) + 1, 1 + ROWNUM, DISB_MAIN_ACNT_CODE,
 DISB_SUB_ACNT_CODE,
 DISB_DIVN_CODE, DISB_DEPT_CODE, '1', DISB_ANLY_CODE_1, '2',
 DISB_ANLY_CODE_2, DISB_LC_AMT, 'D', NEW_RIMB_DOC_DT,
 DISB_ACTY_VALUE_CODE_1, DISB_ACTY_VALUE_CODE_2, NULL, 'N', 'N', 'N', '0',
 NEW_RIMB_CR_UID, NEW_RIMB_CR_DT
 FROM FT_CASH_DISB
 WHERE DISB_RIMB_KEY_NO = NEW_RIMB_KEY_NO;
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_DOC_DUE_DT,
 TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
 TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
 SELECT
 NEW_RIMB_COMP_CODE, P_CUR_ACNT_YEAR, P_RIMB_TRAN_CODE,
 NVL(NEW_RIMB_DOC_NO,0) + 1, 1,
 NEW_RIMB_CASH_MAIN_ACNT_CODE, P_SUB_ACNT_CODE,
 P_DIVN_CODE, P_DEPT_CODE, '1',
 P_ANLY_CODE_1, '2', P_ANLY_CODE_2,
 SUM(DISB_LC_AMT), 'D', NEW_RIMB_DOC_DT, P_ACTY_VALUE_CODE_1,
 P_ACTY_VALUE_CODE_2, NULL, 'N', 'N', 'N', '0',
 NEW_RIMB_CR_UID, NEW_RIMB_CR_DT
 FROM FT_CASH_DISB
 WHERE DISB_RIMB_KEY_NO = NEW_RIMB_KEY_NO;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_CJV_DETAIL (
 OLD_CJVD_COMP_CODE           IN      VARCHAR2,
 OLD_CJVD_ORGL_ACNT_YEAR      IN      NUMBER,
 OLD_CJVD_ORGL_TRAN_CODE      IN      VARCHAR2,
 OLD_CJVD_ORGL_DOC_NO         IN      NUMBER,
 OLD_CJVD_ORGL_SEQ_NO         IN      NUMBER,
 OLD_CJVD_ORGL_MAIN_ACNT_CODE IN      VARCHAR2,
 OLD_CJVD_ORGL_SUB_ACNT_CODE  IN      VARCHAR2,
 OLD_CJVD_ORGL_DIVN_CODE      IN      VARCHAR2,
 OLD_CJVD_ORGL_DEPT_CODE      IN      VARCHAR2,
 OLD_CJVD_ORGL_ANLY_CODE_1    IN      VARCHAR2,
 OLD_CJVD_ORGL_ANLY_CODE_2    IN      VARCHAR2,
 OLD_CJVD_ORGL_ACTY_CODE_1    IN      VARCHAR2,
 OLD_CJVD_ORGL_ACTY_CODE_2    IN      VARCHAR2,
 OLD_CJVD_ORGL_CURR_CODE      IN      VARCHAR2,
 OLD_CJVD_ORGL_FC_AMT         IN      NUMBER,
 OLD_CJVD_ORGL_LC_AMT         IN      NUMBER,
 OLD_CJVD_ORGL_DOC_DRCR_FLAG  IN      VARCHAR2,
 OLD_CJVD_CORR_MAIN_ACNT_CODE IN      VARCHAR2,
 OLD_CJVD_CORR_SUB_ACNT_CODE  IN      VARCHAR2,
 OLD_CJVD_CORR_DIVN_CODE      IN      VARCHAR2,
 OLD_CJVD_CORR_DEPT_CODE      IN      VARCHAR2,
 OLD_CJVD_CORR_ANLY_CODE_1    IN      VARCHAR2,
 OLD_CJVD_CORR_ANLY_CODE_2    IN      VARCHAR2,
 OLD_CJVD_CORR_ACTY_CODE_1    IN      VARCHAR2,
 OLD_CJVD_CORR_ACTY_CODE_2    IN      VARCHAR2,
 OLD_CJVD_CR_UID              IN      VARCHAR2,
 OLD_CJVD_CR_DT               IN      DATE,
 NEW_CJVD_COMP_CODE           IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_ACNT_YEAR      IN OUT  NUMBER,
 NEW_CJVD_ORGL_TRAN_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_DOC_NO         IN OUT  NUMBER,
 NEW_CJVD_ORGL_SEQ_NO         IN OUT  NUMBER,
 NEW_CJVD_ORGL_MAIN_ACNT_CODE IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_SUB_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_DIVN_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_DEPT_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_ANLY_CODE_1    IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_ANLY_CODE_2    IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_ACTY_CODE_1    IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_ACTY_CODE_2    IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_CURR_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_ORGL_FC_AMT         IN OUT  NUMBER,
 NEW_CJVD_ORGL_LC_AMT         IN OUT  NUMBER,
 NEW_CJVD_ORGL_DOC_DRCR_FLAG  IN OUT  VARCHAR2,
 NEW_CJVD_CORR_MAIN_ACNT_CODE IN OUT  VARCHAR2,
 NEW_CJVD_CORR_SUB_ACNT_CODE  IN OUT  VARCHAR2,
 NEW_CJVD_CORR_DIVN_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_CORR_DEPT_CODE      IN OUT  VARCHAR2,
 NEW_CJVD_CORR_ANLY_CODE_1    IN OUT  VARCHAR2,
 NEW_CJVD_CORR_ANLY_CODE_2    IN OUT  VARCHAR2,
 NEW_CJVD_CORR_ACTY_CODE_1    IN OUT  VARCHAR2,
 NEW_CJVD_CORR_ACTY_CODE_2    IN OUT  VARCHAR2,
 NEW_CJVD_CR_UID              IN OUT  VARCHAR2,
 NEW_CJVD_CR_DT               IN OUT  DATE,
 TRG_MODE                     IN OUT  VARCHAR2,
 TRG_ERR_NO                      OUT  NUMBER,
 TRG_ERR_MSG                     OUT  VARCHAR2) AS
BEGIN
IF   NEW_CJVD_ORGL_MAIN_ACNT_CODE !=
     NEW_CJVD_CORR_MAIN_ACNT_CODE
   OR NVL(NEW_CJVD_ORGL_SUB_ACNT_CODE,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_SUB_ACNT_CODE,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_DIVN_CODE,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_DIVN_CODE,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_DEPT_CODE,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_DEPT_CODE,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_ANLY_CODE_1,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_ANLY_CODE_1,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_ANLY_CODE_2,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_ANLY_CODE_2,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_ACTY_CODE_1,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_ACTY_CODE_1,'ZZZZZZZ')
   OR NVL(NEW_CJVD_ORGL_ACTY_CODE_2,'ZZZZZZZ') !=
      NVL(NEW_CJVD_CORR_ACTY_CODE_2,'ZZZZZZZ') THEN
   INSERT INTO FT_CUR_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT CJV_COMP_CODE, CJV_ORGL_ACNT_YEAR, CJV_CORR_TRAN_CODE,
          CJV_CORR_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          DECODE(TD_DOC_DRCR_FLAG,'D','C','D'), TD_FC_AMT, TD_DOC_REF,
          CJV_CORR_DOC_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT
   FROM   FT_CUR_TRANS_DETAIL, FT_CORRECTION_JV
   WHERE  TD_COMP_CODE = NEW_CJVD_COMP_CODE
   AND    TD_TRAN_CODE = NEW_CJVD_ORGL_TRAN_CODE
   AND    TD_ACNT_YEAR = NEW_CJVD_ORGL_ACNT_YEAR
   AND    TD_DOC_NO = NEW_CJVD_ORGL_DOC_NO
   AND    TD_SEQ_NO = NEW_CJVD_ORGL_SEQ_NO
   AND    CJV_COMP_CODE = NEW_CJVD_COMP_CODE
   AND    CJV_ORGL_TRAN_CODE =NEW_CJVD_ORGL_TRAN_CODE
   AND    CJV_ORGL_ACNT_YEAR = NEW_CJVD_ORGL_ACNT_YEAR
   AND    CJV_ORGL_DOC_NO = NEW_CJVD_ORGL_DOC_NO;
   INSERT INTO FT_CUR_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT CJV_COMP_CODE, CJV_ORGL_ACNT_YEAR, CJV_CORR_TRAN_CODE,
          CJV_CORR_DOC_NO, TD_SEQ_NO+500, NEW_CJVD_CORR_MAIN_ACNT_CODE,
          NEW_CJVD_CORR_SUB_ACNT_CODE, NEW_CJVD_CORR_DIVN_CODE,
          NEW_CJVD_CORR_DEPT_CODE, TD_HEAD_NO_1, NEW_CJVD_CORR_ANLY_CODE_1,
          TD_HEAD_NO_2, NEW_CJVD_CORR_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF,
          CJV_CORR_DOC_DT, TD_OTH_REF,
          NEW_CJVD_CORR_ACTY_CODE_1, NEW_CJVD_CORR_ACTY_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT
   FROM   FT_CUR_TRANS_DETAIL, FT_CORRECTION_JV
   WHERE  TD_COMP_CODE = NEW_CJVD_COMP_CODE
   AND    TD_TRAN_CODE = NEW_CJVD_ORGL_TRAN_CODE
   AND    TD_ACNT_YEAR = NEW_CJVD_ORGL_ACNT_YEAR
   AND    TD_DOC_NO = NEW_CJVD_ORGL_DOC_NO
   AND    TD_SEQ_NO = NEW_CJVD_ORGL_SEQ_NO
   AND    CJV_COMP_CODE = NEW_CJVD_COMP_CODE
   AND    CJV_ORGL_TRAN_CODE =NEW_CJVD_ORGL_TRAN_CODE
   AND    CJV_ORGL_ACNT_YEAR = NEW_CJVD_ORGL_ACNT_YEAR
   AND    CJV_ORGL_DOC_NO = NEW_CJVD_ORGL_DOC_NO;
  F_CHK_DRCR_SUM(NEW_CJVD_COMP_CODE, NEW_CJVD_ORGL_ACNT_YEAR,
                 NEW_CJVD_ORGL_TRAN_CODE, NEW_CJVD_ORGL_DOC_NO);
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_CORRECTION_JV (
 OLD_CJV_COMP_CODE         IN      VARCHAR2,
 OLD_CJV_ORGL_ACNT_YEAR    IN      NUMBER,
 OLD_CJV_ORGL_TRAN_CODE    IN      VARCHAR2,
 OLD_CJV_ORGL_DOC_NO       IN      NUMBER,
 OLD_CJV_ORGL_DOC_DT       IN      DATE,
 OLD_CJV_CORR_TRAN_CODE    IN      VARCHAR2,
 OLD_CJV_CORR_DOC_NO       IN      NUMBER,
 OLD_CJV_CORR_DOC_DT       IN      DATE,
 OLD_CJV_CORR_DESC         IN      VARCHAR2,
 OLD_CJV_CR_UID            IN      VARCHAR2,
 OLD_CJV_CR_DT             IN      DATE,
 NEW_CJV_COMP_CODE         IN OUT  VARCHAR2,
 NEW_CJV_ORGL_ACNT_YEAR    IN OUT  NUMBER,
 NEW_CJV_ORGL_TRAN_CODE    IN OUT  VARCHAR2,
 NEW_CJV_ORGL_DOC_NO       IN OUT  NUMBER,
 NEW_CJV_ORGL_DOC_DT       IN OUT  DATE,
 NEW_CJV_CORR_TRAN_CODE    IN OUT  VARCHAR2,
 NEW_CJV_CORR_DOC_NO       IN OUT  NUMBER,
 NEW_CJV_CORR_DOC_DT       IN OUT  DATE,
 NEW_CJV_CORR_DESC         IN OUT  VARCHAR2,
 NEW_CJV_CR_UID            IN OUT  VARCHAR2,
 NEW_CJV_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_ERR_NO            NUMBER(6);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_ACNT_YEAR         NUMBER(2);
P_CUR_ACNT_YEAR     NUMBER(2);
P_PHS_KEY_NO        NUMBER(10);
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_CJV_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_CJV_COMP_CODE);
END IF;
P_ERR_NO := 0;
/* Validate if the document period corresponding to the document date
    is open. */
F_VAL_OPCL(NEW_CJV_COMP_CODE, NEW_CJV_CORR_DOC_DT, P_ERR_NO,
           P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
END IF;
      /* Insert into audit trail header */
      SELECT SEQ_PHS_KEY_NO.NEXTVAL
      INTO   P_PHS_KEY_NO
      FROM   DUAL ;
      INSERT INTO FS_PROC_HEADER
             (PHS_KEY_NO, PHS_USER_ID, PHS_PROC_DT, PHS_PROC_STATUS,
              PHS_COMP_CODE, PHS_TRAN_FRM, PHS_TRAN_TO, PHS_TRAN_DT_FRM,
              PHS_TRAN_DT_TO, PHS_DOC_NO_FRM, PHS_DOC_NO_TO,
              PHS_USER_PATTERN, PHS_HEAD_REC_TOT, PHS_DETAIL_REC_TOT,
              PHS_AMT_TOT, PHS_ERROR_NAME, PHS_CR_UID, PHS_CR_DT)
      VALUES (P_PHS_KEY_NO, NEW_CJV_CR_UID, SYSDATE, '', NEW_CJV_COMP_CODE,
              NEW_CJV_CORR_TRAN_CODE, NEW_CJV_CORR_TRAN_CODE,
              NEW_CJV_CORR_DOC_DT, NEW_CJV_CORR_DOC_DT, NEW_CJV_CORR_DOC_NO,
              NEW_CJV_CORR_DOC_NO, NEW_CJV_CR_UID, '1', '', '', '',
              NEW_CJV_CR_UID, NEW_CJV_CR_DT) ;
   INSERT INTO FT_CUR_TRANS_HEADER (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE,
          TH_DOC_NO, TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION,
          TH_CR_UID, TH_CR_DT)
   SELECT TH_COMP_CODE, P_ACNT_YEAR, NEW_CJV_CORR_TRAN_CODE,
          NEW_CJV_CORR_DOC_NO, NEW_CJV_CORR_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
          NEW_CJV_ORGL_TRAN_CODE || NEW_CJV_ORGL_DOC_NO,
          NEW_CJV_ORGL_DOC_DT, NEW_CJV_CORR_DOC_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, P_PHS_KEY_NO,
          'CORRECTION OF ' || NEW_CJV_ORGL_TRAN_CODE || ' ' ||
          TO_CHAR(NEW_CJV_ORGL_DOC_NO) || ' DATED ' ||
          TO_CHAR(NEW_CJV_ORGL_DOC_DT,'DD/MM/YY') || ' ' || NEW_CJV_CORR_DESC,
          TH_ANNOTATION,
          NEW_CJV_CR_UID, NEW_CJV_CR_DT
   FROM   FT_CUR_TRANS_HEADER
   WHERE  TH_COMP_CODE = NEW_CJV_COMP_CODE
   AND    TH_ACNT_YEAR = NEW_CJV_ORGL_ACNT_YEAR
   AND    TH_TRAN_CODE = NEW_CJV_ORGL_TRAN_CODE
   AND    TH_DOC_NO    = NEW_CJV_ORGL_DOC_NO;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_CUR_TRANS_DETAIL (
 OLD_TD_COMP_CODE               IN      VARCHAR2,
 OLD_TD_ACNT_YEAR               IN      NUMBER,
 OLD_TD_TRAN_CODE               IN      VARCHAR2,
 OLD_TD_DOC_NO                  IN      NUMBER,
 OLD_TD_SEQ_NO                  IN      NUMBER,
 OLD_TD_MAIN_ACNT_CODE          IN      VARCHAR2,
 OLD_TD_SUB_ACNT_CODE           IN      VARCHAR2,
 OLD_TD_DIVN_CODE               IN      VARCHAR2,
 OLD_TD_DEPT_CODE               IN      VARCHAR2,
 OLD_TD_HEAD_NO_1               IN      NUMBER,
 OLD_TD_ANLY_CODE_1             IN      VARCHAR2,
 OLD_TD_HEAD_NO_2               IN      NUMBER,
 OLD_TD_ANLY_CODE_2             IN      VARCHAR2,
 OLD_TD_CURR_CODE               IN      VARCHAR2,
 OLD_TD_DOC_AMT                 IN      NUMBER,
 OLD_TD_DOC_DRCR_FLAG           IN      VARCHAR2,
 OLD_TD_FC_AMT                  IN      NUMBER,
 OLD_TD_DOC_REF                 IN      VARCHAR2,
 OLD_TD_DOC_DUE_DT              IN      DATE,
 OLD_TD_OTH_REF                 IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_1       IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_2       IN      VARCHAR2,
 OLD_TD_DESC                    IN      VARCHAR2,
 OLD_TD_DBK_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_LED_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_MONTH_PRC_FLAG          IN      VARCHAR2,
 OLD_TD_BILL_FC_AMT             IN      NUMBER,
 OLD_TD_BILL_LC_AMT             IN      NUMBER,
 OLD_TD_BILL_STATUS             IN      VARCHAR2,
 OLD_TD_PYMT_APPR_FLAG          IN      VARCHAR2,
 OLD_TD_CR_UID                  IN      VARCHAR2,
 OLD_TD_CR_DT                   IN      DATE,
 OLD_TD_PYMT_LAST_APPR_FC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_LC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_BANK     IN      VARCHAR2,
 NEW_TD_COMP_CODE               IN OUT  VARCHAR2,
 NEW_TD_ACNT_YEAR               IN OUT  NUMBER,
 NEW_TD_TRAN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_NO                  IN OUT  NUMBER,
 NEW_TD_SEQ_NO                  IN OUT  NUMBER,
 NEW_TD_MAIN_ACNT_CODE          IN OUT  VARCHAR2,
 NEW_TD_SUB_ACNT_CODE           IN OUT  VARCHAR2,
 NEW_TD_DIVN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DEPT_CODE               IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_1               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_1             IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_2               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_2             IN OUT  VARCHAR2,
 NEW_TD_CURR_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_AMT                 IN OUT  NUMBER,
 NEW_TD_DOC_DRCR_FLAG           IN OUT  VARCHAR2,
 NEW_TD_FC_AMT                  IN OUT  NUMBER,
 NEW_TD_DOC_REF                 IN OUT  VARCHAR2,
 NEW_TD_DOC_DUE_DT              IN OUT  DATE,
 NEW_TD_OTH_REF                 IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_1       IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_2       IN OUT  VARCHAR2,
 NEW_TD_DESC                    IN OUT  VARCHAR2,
 NEW_TD_DBK_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_LED_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_MONTH_PRC_FLAG          IN OUT  VARCHAR2,
 NEW_TD_BILL_FC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_LC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_STATUS             IN OUT  VARCHAR2,
 NEW_TD_PYMT_APPR_FLAG          IN OUT  VARCHAR2,
 NEW_TD_CR_UID                  IN OUT  VARCHAR2,
 NEW_TD_CR_DT                   IN OUT  DATE,
 NEW_TD_PYMT_LAST_APPR_FC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_LC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_BANK     IN OUT  VARCHAR2,
 TRG_MODE                       IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_ACNT_YEAR         NUMBER(2);
P_TRAN_CODE         VARCHAR2(3);
P_DOC_NO            NUMBER(6);
P_CUR_ACNT_YEAR     NUMBER(2);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_DOC_DT            DATE;
P_DOC_DUE_DT        DATE;
P_DOC_REF_DT        DATE;
P_TD_MAIN_ACNT_CODE VARCHAR2(6);
P_OPEN_ENTRY_FLAG   VARCHAR2(1);
P_MAIN_ACNT_CATG    VARCHAR2(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
P_PHS_KEY_NO        FS_PROC_HEADER.PHS_KEY_NO%TYPE ;
P_CR_UID            FT_CUR_TRANS_HEADER.TH_CR_UID%TYPE ;
P_CR_DT             FT_CUR_TRANS_HEADER.TH_CR_DT%TYPE ;
P_BAL_AMT           NUMBER(20,3) ;
P_TRAN_AMT          NUMBER(20,3) ;
P_PDS_SEQ_NO        NUMBER(6) ;
P_ERR_NO            NUMBER(6);
CURSOR SEL_TH IS
       SELECT TH_DOC_DT, TH_DOC_CAL_MONTH, TH_DOC_CAL_YEAR,
              TH_DOC_DUE_DT, TH_DOC_REF_DT, TH_CTL_TOTAL,
              TH_CR_UID, TH_CR_DT
       FROM   FT_CUR_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
CURSOR SEL_TH_INFO IS
       SELECT TO_DATE(DBTI_VALUE_1), TO_NUMBER(DBTI_VALUE_2),
              TO_NUMBER(DBTI_VALUE_3), TO_DATE(DBTI_VALUE_4),
              TO_DATE(DBTI_VALUE_5), TO_NUMBER(DBTI_VALUE_10),
              DBTI_VALUE_11, TO_DATE(DBTI_VALUE_12)
       FROM   FP_DBTRG_INTERFACE
       WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
CURSOR SEL_MAIN IS
       SELECT MAIN_OPEN_ENTRY_FLAG, MAIN_ACNT_CATG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = P_TD_MAIN_ACNT_CODE;
CURSOR SEQ_NO IS
       SELECT MAX(PDS_SEQ_NO)
       FROM   FS_PROC_DETAIL
       WHERE  PDS_KEY_NO = P_PHS_KEY_NO ;
/* Declare Local procedures for repetitive use within the trigger */
PROCEDURE VALIDATE_CODE_COMBN IS
P_KEY    NUMBER(8);
BEGIN
F_VAL_COMB (NEW_TD_COMP_CODE, NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
            NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
            NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2, P_ERR_NO, P_KEY);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20016, 'Invalid Code combination');
END IF;
END;
PROCEDURE INSERT_CUR_OS IS
P_OST_KEY_NO     NUMBER(8);
P_OST_REF_KEY_NO NUMBER(8);
P_OST_LC_AMT     NUMBER(14,3);
P_OST_FC_AMT     NUMBEr(14,3);
CURSOR F_OS_DET IS
       SELECT OST_KEY_NO, OST_REF_KEY_NO,
              OST_LC_AMT, OST_FC_AMT
       FROM   FT_UNPOSTED_OS
       WHERE  (OST_COMP_CODE = NEW_TD_COMP_CODE)
       AND    (OST_ACNT_YEAR = NEW_TD_ACNT_YEAR)
       AND    (OST_TRAN_CODE = NEW_TD_TRAN_CODE)
       AND    (OST_DOC_NO    = NEW_TD_DOC_NO)
       AND    (OST_SEQ_NO    = NEW_TD_SEQ_NO);
BEGIN
   P_TD_MAIN_ACNT_CODE := NEW_TD_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG, P_MAIN_ACNT_CATG ;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
           IF F_OS_DET%ISOPEN THEN
                CLOSE F_OS_DET;
           END IF;
           OPEN F_OS_DET;
           FETCH F_OS_DET INTO P_OST_KEY_NO, P_OST_REF_KEY_NO,
                               P_OST_LC_AMT, P_OST_FC_AMT;
           IF F_OS_DET%FOUND THEN
                LOOP
                EXIT WHEN F_OS_DET%NOTFOUND;
                     INSERT INTO FS_MATCH_OS
                     SELECT FT_UNPOSTED_OS.*, 'FIN7',SYSDATE
                     FROM   FT_UNPOSTED_OS
                     WHERE  (OST_KEY_NO = P_OST_KEY_NO);
                     FETCH F_OS_DET INTO P_OST_KEY_NO, P_OST_REF_KEY_NO,
                                         P_OST_LC_AMT, P_OST_FC_AMT;
                END LOOP;
           ELSE
                F_OS(P_OST_KEY_NO);
                INSERT INTO FT_OS
                  (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                   OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                   OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                   OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                   OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                   OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                   OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                   OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                   OST_LC_ORG_AMT, OST_FC_ORG_AMT, OST_TYPE,
                   OST_CR_UID, OST_CR_DT)
                VALUES
                  (P_OST_KEY_NO, NEW_TD_COMP_CODE, NEW_TD_TRAN_CODE,
                   NEW_TD_DOC_NO, NEW_TD_SEQ_NO, NEW_TD_ACNT_YEAR,
                   P_DOC_DT, P_CAL_YEAR, P_CAL_MONTH, NEW_TD_DOC_DUE_DT,
                   NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                   NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE, NEW_TD_HEAD_NO_1,
                   NEW_TD_ANLY_CODE_1, NEW_TD_HEAD_NO_2,
                   NEW_TD_ANLY_CODE_2, NEW_TD_ACTY_VALUE_CODE_1,
                   NEW_TD_ACTY_VALUE_CODE_2,
                   NEW_TD_CURR_CODE, NEW_TD_DOC_AMT, NEW_TD_FC_AMT,
                   NEW_TD_DOC_DRCR_FLAG, NEW_TD_DOC_REF, P_DOC_REF_DT,
                   NEW_TD_OTH_REF, NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NULL,
                   NEW_TD_CR_UID, NEW_TD_CR_DT);
           END IF;
           CLOSE F_OS_DET;
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE UPDATE_CUR_OS_CODES IS
BEGIN
     UPDATE FT_OS
     SET    OST_DIVN_CODE   = NEW_TD_DIVN_CODE,
            OST_DEPT_CODE   = NEW_TD_DEPT_CODE,
            OST_ANLY_CODE_1 = NEW_TD_ANLY_CODE_1,
            OST_ANLY_CODE_2 = NEW_TD_ANLY_CODE_2,
            OST_ACTY_CODE_1 = NEW_TD_ACTY_VALUE_CODE_1,
            OST_ACTY_CODE_2 = NEW_TD_ACTY_VALUE_CODE_2,
            OST_DOC_REF     = NEW_TD_DOC_REF,
            OST_OTH_REF     = NEW_TD_OTH_REF,
            OST_DUE_DT      = NEW_TD_DOC_DUE_DT
     WHERE  (OST_COMP_CODE = OLD_TD_COMP_CODE)
     AND    (OST_ACNT_YEAR = OLD_TD_ACNT_YEAR)
     AND    (OST_TRAN_CODE = OLD_TD_TRAN_CODE)
     AND    (OST_DOC_NO    = OLD_TD_DOC_NO)
     AND    (OST_SEQ_NO    = OLD_TD_SEQ_NO);
END;
PROCEDURE INCREASE_ACNT_BAL IS
BEGIN
   F_UPD_ACNT_BAL (NEW_TD_COMP_CODE, P_ACNT_YEAR,
                   NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                   NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
                   NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2,
                   P_CAL_YEAR, P_CAL_MONTH, NEW_TD_CURR_CODE,
                   NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NEW_TD_DOC_DRCR_FLAG,
                   'P', 'A', NEW_TD_CR_UID, P_ERR_NO);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Error at balance updation');
   END IF;
END;
BEGIN
/* Main procedure */
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TD_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TD_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'U' THEN
   NEW_TD_ACNT_YEAR := OLD_TD_ACNT_YEAR;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_COMP_CODE := NEW_TD_COMP_CODE;
    P_TRAN_CODE := NEW_TD_TRAN_CODE;
    P_ACNT_YEAR := NEW_TD_ACNT_YEAR;
    P_DOC_NO := NEW_TD_DOC_NO;
ELSE
    P_COMP_CODE := OLD_TD_COMP_CODE;
    P_TRAN_CODE := OLD_TD_TRAN_CODE;
    P_ACNT_YEAR := OLD_TD_ACNT_YEAR;
    P_DOC_NO := OLD_TD_DOC_NO;
END IF;
P_DBTI_KEY_FIELD := P_COMP_CODE ||
                    TO_CHAR(P_ACNT_YEAR) ||
                    P_TRAN_CODE ||
                    TO_CHAR(P_DOC_NO);
IF SEL_TH_INFO%ISOPEN THEN
    CLOSE SEL_TH_INFO;
END IF;
OPEN SEL_TH_INFO;
FETCH SEL_TH_INFO INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                    P_DOC_DUE_DT, P_DOC_REF_DT,
                    P_PHS_KEY_NO, P_CR_UID, P_CR_DT ;
IF SEL_TH_INFO%NOTFOUND THEN
     IF SEL_TH%ISOPEN THEN
         CLOSE SEL_TH;
     END IF;
     OPEN SEL_TH;
     FETCH SEL_TH INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                         P_DOC_DUE_DT, P_DOC_REF_DT,
                         P_PHS_KEY_NO, P_CR_UID, P_CR_DT ;
     IF SEL_TH%NOTFOUND THEN
          RAISE_APPLICATION_ERROR(-20117,'Header not found');
     END IF;
     CLOSE SEL_TH;
ELSE
     /* Used for verification in DB triggers corresponding to
        FT_UNPOSTED_OS and FT_OS tables */
     IF TRG_MODE = 'I' OR TRG_MODE = 'U'  THEN
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(NEW_TD_SEQ_NO),
                 DBTI_VALUE_7 = NEW_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = NEW_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     ELSE
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(OLD_TD_SEQ_NO),
                 DBTI_VALUE_7 = OLD_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = OLD_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     END IF;
END IF;
CLOSE SEL_TH_INFO;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NEW_TD_DOC_DUE_DT IS NULL THEN
        NEW_TD_DOC_DUE_DT := P_DOC_DUE_DT;
     END IF;
END IF;
IF TRG_MODE = 'I' THEN
   VALIDATE_CODE_COMBN;
   INCREASE_ACNT_BAL;
   INSERT_CUR_OS;
/* Below are added by Selva on 18/03/95 for Audit trail */
   IF P_PHS_KEY_NO IS NOT NULL THEN
      P_BAL_AMT := 0 ;
      IF NEW_TD_DOC_DRCR_FLAG = 'D' THEN
         P_TRAN_AMT := NEW_TD_DOC_AMT ;
      ELSE
         P_TRAN_AMT := NEW_TD_DOC_AMT * - 1;
      END IF;
      F_GET_LC_BAL (NEW_TD_COMP_CODE       ,
                    NEW_TD_ACNT_YEAR       ,
                    NEW_TD_MAIN_ACNT_CODE  ,
                    NEW_TD_SUB_ACNT_CODE   ,
                    NEW_TD_DIVN_CODE       ,
                    NEW_TD_DEPT_CODE       ,
                    NEW_TD_ANLY_CODE_1     ,
                    NEW_TD_ANLY_CODE_2     ,
                    P_CAL_YEAR             ,
                    P_CAL_MONTH            ,
                    P_BAL_AMT              ,
                    P_ERR_NO);
      IF SEQ_NO%ISOPEN THEN
         CLOSE SEQ_NO ;
      END IF ;
      OPEN SEQ_NO ;
      FETCH SEQ_NO INTO P_PDS_SEQ_NO ;
      IF SEQ_NO%NOTFOUND THEN
         P_PDS_SEQ_NO := 1 ;
      ELSE
         P_PDS_SEQ_NO := NVL(P_PDS_SEQ_NO,0) + 1 ;
      END IF ;
      INSERT INTO FS_PROC_DETAIL
             (PDS_KEY_NO, PDS_SEQ_NO, PDS_COMP_CODE, PDS_CAL_MONTH,
              PDS_CAL_YEAR, PDS_MAIN_ACNT_CODE, PDS_SUB_ACNT_CODE,
              PDS_DIVN_CODE, PDS_DEPT_CODE, PDS_HEAD_NO_1, PDS_ANLY_CODE_1,
              PDS_HEAD_NO_2, PDS_ANLY_CODE_2, PDS_BEFORE_BAL_AMT,
              PDS_AFTER_BAL_AMT, PDS_PROC_UID, PDS_PROC_DT, PDS_PROC_STATUS,
              PDS_CR_UID, PDS_CR_DT)
      VALUES (P_PHS_KEY_NO, P_PDS_SEQ_NO, NEW_TD_COMP_CODE, P_CAL_MONTH,
              P_CAL_YEAR, NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
              NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE, 1, NEW_TD_ANLY_CODE_1,
              2, NEW_TD_ANLY_CODE_2, P_BAL_AMT - P_TRAN_AMT, P_BAL_AMT,
              P_CR_UID, SYSDATE, 'S', P_CR_UID, P_CR_DT) ;
   END IF ;
/* Above are added by Selva on 18/03/95 */
END IF;
IF TRG_MODE = 'U' THEN
   IF (OLD_TD_COMP_CODE != NEW_TD_COMP_CODE) OR
      (OLD_TD_TRAN_CODE != NEW_TD_TRAN_CODE) OR
      (OLD_TD_DOC_NO != NEW_TD_DOC_NO) OR
      (OLD_TD_SEQ_NO != NEW_TD_SEQ_NO) THEN
      RAISE_APPLICATION_ERROR(-20018, 'Primary key change');
   END IF;
   IF     (OLD_TD_MAIN_ACNT_CODE != NEW_TD_MAIN_ACNT_CODE) OR
          (NVL(OLD_TD_SUB_ACNT_CODE,'000000') !=
           NVL(NEW_TD_SUB_ACNT_CODE,'000000')) OR
          (NVL(OLD_TD_DOC_DRCR_FLAG,'0') !=
           NVL(NEW_TD_DOC_DRCR_FLAG,'0')) OR
          (NVL(OLD_TD_CURR_CODE,'000') !=
           NVL(NEW_TD_CURR_CODE,'000')) THEN
          RAISE_APPLICATION_ERROR(-20019, 'Significant codes change');
    ELSE
            IF  (NVL(OLD_TD_DIVN_CODE,'000000') !=
                 NVL(NEW_TD_DIVN_CODE,'000000')) OR
                (NVL(OLD_TD_DEPT_CODE,'000000') !=
                 NVL(NEW_TD_DEPT_CODE,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_1,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_1,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_2,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_2,'000000')) THEN
                    RAISE_APPLICATION_ERROR
                   (-20020, 'Significant codes change');
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0))
                    THEN
                       RAISE_APPLICATION_ERROR(-20021, 'Amount change');
                    END IF;
            ELSE
                    IF (NVL(OLD_TD_DOC_DUE_DT,'01-JAN-90') !=
                        NVL(NEW_TD_DOC_DUE_DT,'01-JAN-90')) OR
                       (NVL(OLD_TD_DOC_REF,' ') !=
                        NVL(NEW_TD_DOC_REF,' ')) OR
                       (NVL(OLD_TD_OTH_REF,' ') !=
                        NVL(NEW_TD_OTH_REF,' ')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_1,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_1,'000000')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_2,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_2,'000000')) THEN
                           VALIDATE_CODE_COMBN;
                           UPDATE_CUR_OS_CODES;
                    END IF;
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0))
                    THEN
                       RAISE_APPLICATION_ERROR(-20022, 'Amount change');
                    END IF;
            END IF;
    END IF;
END IF;
IF TRG_MODE = 'D' THEN
     RAISE_APPLICATION_ERROR(-20023, 'Cannot delete record');
END IF;
IF (TRG_MODE = 'I' AND P_MAIN_ACNT_CATG = 'WI') AND
   (NEW_TD_MONTH_PRC_FLAG != 'O') THEN
   IF NEW_TD_ACTY_VALUE_CODE_1 IS NULL OR
      NEW_TD_DOC_REF IS NULL THEN
      RAISE_APPLICATION_ERROR(-20024, 'WIP A/c should have Job number and Activity code entered') ;
   END IF ;
   INSERT INTO OT_JOB_EXPENSE
          (JEX_SYS_ID, JEX_COMP_CODE, JEX_NO, JEX_DT, JEX_ACNT_YEAR_MTH,
           JEX_JH_NO, JEX_JH_SYS_ID, JEX_JEXP_CODE, JEX_VAL,
           JEX_MAIN_ACNT_CODE, JEX_SUB_ACNT_CODE, JEX_DIVN_CODE,
           JEX_DEPT_CODE, JEX_ANLY_HEAD_NO_1, JEX_ANLY_CODE_1,
           JEX_ANLY_HEAD_NO_2, JEX_ANLY_CODE_2, JEX_ACTY_VALUE_CODE_1,
           JEX_ACTY_VALUE_CODE_2, JEX_TH_TRAN_CODE, JEX_TH_DOC_NO,
           JEX_TH_DOC_DT, JEX_STATUS, JEX_CR_DT, JEX_CR_UID)
   SELECT  JEX_SYS_ID.NEXTVAL, NEW_TD_COMP_CODE, NEW_TD_DOC_NO, P_DOC_DT,
           P_DOC_DT, NULL, NULL, NULL, 0, NULL, NULL, NULL,
           NULL, NULL, NULL, NULL, NULL, NULL, NULL,
           NEW_TD_TRAN_CODE, NEW_TD_DOC_NO,
           P_DOC_DT, 1, NEW_TD_CR_DT, NEW_TD_CR_UID
   FROM    DUAL
   WHERE   NOT EXISTS (SELECT 'X' FROM OT_JOB_EXPENSE
                       WHERE JEX_COMP_CODE    = NEW_TD_COMP_CODE
                       AND   JEX_NO           = NEW_TD_DOC_NO
                       AND   JEX_TH_TRAN_CODE = NEW_TD_TRAN_CODE
                       AND   JEX_TH_DOC_NO    = NEW_TD_DOC_NO) ;
   INSERT INTO OT_JOB_EXPENSE
          (JEX_SYS_ID, JEX_COMP_CODE, JEX_NO, JEX_DT, JEX_ACNT_YEAR_MTH,
           JEX_JH_NO, JEX_JH_SYS_ID, JEX_JEXP_CODE, JEX_VAL,
           JEX_MAIN_ACNT_CODE, JEX_SUB_ACNT_CODE, JEX_DIVN_CODE,
           JEX_DEPT_CODE, JEX_ANLY_HEAD_NO_1, JEX_ANLY_CODE_1,
           JEX_ANLY_HEAD_NO_2, JEX_ANLY_CODE_2, JEX_ACTY_VALUE_CODE_1,
           JEX_ACTY_VALUE_CODE_2, JEX_TH_TRAN_CODE, JEX_TH_DOC_NO,
           JEX_TH_DOC_DT, JEX_STATUS, JEX_CR_DT, JEX_CR_UID)
   SELECT  JEX_SYS_ID.NEXTVAL, NEW_TD_COMP_CODE, NEW_TD_DOC_NO, P_DOC_DT,
           P_DOC_DT, JH_NO, JH_SYS_ID, NEW_TD_ACTY_VALUE_CODE_1,
           (DECODE(NEW_TD_DOC_DRCR_FLAG, 'D', 1, -1) * NVL(NEW_TD_DOC_AMT,0)),
           NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE, NEW_TD_DIVN_CODE,
           NEW_TD_DEPT_CODE, NEW_TD_HEAD_NO_1, NEW_TD_ANLY_CODE_1,
           NEW_TD_HEAD_NO_2, NEW_TD_ANLY_CODE_2, NEW_TD_ACTY_VALUE_CODE_1,
           NEW_TD_ACTY_VALUE_CODE_2, NEW_TD_TRAN_CODE, NEW_TD_DOC_NO,
           P_DOC_DT, 1, NEW_TD_CR_DT, NEW_TD_CR_UID
   FROM    OT_JOB_HEAD
   WHERE   JH_COMP_CODE = NEW_TD_COMP_CODE
   AND     JH_NO        = NEW_TD_DOC_REF ;
END IF ;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_CUR_TRANS_HEADER (
 OLD_TH_COMP_CODE          IN      VARCHAR2,
 OLD_TH_ACNT_YEAR          IN      NUMBER,
 OLD_TH_TRAN_CODE          IN      VARCHAR2,
 OLD_TH_DOC_NO             IN      NUMBER,
 OLD_TH_DOC_DT             IN      DATE,
 OLD_TH_DOC_CAL_YEAR       IN      NUMBER,
 OLD_TH_DOC_CAL_MONTH      IN      NUMBER,
 OLD_TH_DOC_REF            IN      VARCHAR2,
 OLD_TH_DOC_REF_DT         IN      DATE,
 OLD_TH_DOC_DUE_DT         IN      DATE,
 OLD_TH_DIVN_CODE          IN      VARCHAR2,
 OLD_TH_DEPT_CODE          IN      VARCHAR2,
 OLD_TH_CTL_TOTAL          IN      NUMBER,
 OLD_TH_DESC               IN      VARCHAR2,
 OLD_TH_ANNOTATION         IN      VARCHAR2,
 OLD_TH_CR_UID             IN      VARCHAR2,
 OLD_TH_CR_DT              IN      DATE,
 NEW_TH_COMP_CODE          IN OUT  VARCHAR2,
 NEW_TH_ACNT_YEAR          IN OUT  NUMBER,
 NEW_TH_TRAN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DOC_NO             IN OUT  NUMBER,
 NEW_TH_DOC_DT             IN OUT  DATE,
 NEW_TH_DOC_CAL_YEAR       IN OUT  NUMBER,
 NEW_TH_DOC_CAL_MONTH      IN OUT  NUMBER,
 NEW_TH_DOC_REF            IN OUT  VARCHAR2,
 NEW_TH_DOC_REF_DT         IN OUT  DATE,
 NEW_TH_DOC_DUE_DT         IN OUT  DATE,
 NEW_TH_DIVN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DEPT_CODE          IN OUT  VARCHAR2,
 NEW_TH_CTL_TOTAL          IN OUT  NUMBER,
 NEW_TH_DESC               IN OUT  VARCHAR2,
 NEW_TH_ANNOTATION         IN OUT  VARCHAR2,
 NEW_TH_CR_UID             IN OUT  VARCHAR2,
 NEW_TH_CR_DT              IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_ERR_NO            NUMBER(6);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_ACNT_YEAR         NUMBER(2);
P_CUR_ACNT_YEAR     NUMBER(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
PROCEDURE SETUP_DBTRG_INTERFACE IS
BEGIN
          IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
              P_DBTI_KEY_FIELD := OLD_TH_COMP_CODE ||
                                  TO_CHAR(OLD_TH_ACNT_YEAR) ||
                                  OLD_TH_TRAN_CODE ||
                                  TO_CHAR(OLD_TH_DOC_NO) ;
          ELSE
              P_DBTI_KEY_FIELD := NEW_TH_COMP_CODE ||
                                  TO_CHAR(NEW_TH_ACNT_YEAR) ||
                                  NEW_TH_TRAN_CODE ||
                                  TO_CHAR(NEW_TH_DOC_NO) ;
          END IF;
          DELETE FROM FP_DBTRG_INTERFACE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
          IF TRG_MODE = 'D' THEN
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(OLD_TH_DOC_DT),
                      TO_CHAR(OLD_TH_DOC_CAL_MONTH),
                      TO_CHAR(OLD_TH_DOC_CAL_YEAR),
                      TO_CHAR(OLD_TH_DOC_DUE_DT),
                      TO_CHAR(OLD_TH_DOC_REF_DT));
          ELSE
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5,
                      DBTI_VALUE_10, DBTI_VALUE_11, DBTI_VALUE_12)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(NEW_TH_DOC_DT),
                      TO_CHAR(NEW_TH_DOC_CAL_MONTH),
                      TO_CHAR(NEW_TH_DOC_CAL_YEAR),
                      TO_CHAR(NEW_TH_DOC_DUE_DT),
                      TO_CHAR(NEW_TH_DOC_REF_DT),
                      TO_CHAR(NEW_TH_CTL_TOTAL),
                      NEW_TH_CR_UID,
                      NEW_TH_CR_DT);
          END IF;
END;
PROCEDURE VALIDATE_NARRATION IS
BEGIN
    /* Validate the data type of various components of the Narration, if
        Structuring of the narration is used. */
    IF NVL(OLD_TH_DESC,' ') != NVL(NEW_TH_DESC,' ') THEN
        F_VAL_NARRATION(NEW_TH_TRAN_CODE, NEW_TH_DESC, P_ERR_NO);
        IF P_ERR_NO != 0 THEN
            RAISE_APPLICATION_ERROR(-20012, 'Invalid Narration');
        END IF;
    END IF;
Press <Enter> to continue...
END;
BEGIN
DBMS_OUTPUT.PUT_LINE('3' || TRG_MODE) ;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TH_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TH_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'I' THEN
    /* Initialise User id. and Date */
    IF NEW_TH_CR_UID IS NULL THEN
         NEW_TH_CR_UID := NVL(NEW_TH_CR_UID,'UNDEF');
    END IF;
    NEW_TH_CR_DT := SYSDATE;
    /* Validate if the document period corresponding to the document date
        is open. */
    F_VAL_OPCL(NEW_TH_COMP_CODE, NEW_TH_DOC_DT, P_ERR_NO,
               P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
    IF P_ERR_NO != 0 THEN
         RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
    END IF;
    NEW_TH_ACNT_YEAR := P_ACNT_YEAR;
    NEW_TH_DOC_CAL_MONTH := P_CAL_MONTH;
    NEW_TH_DOC_CAL_YEAR  := P_CAL_YEAR;
     VALIDATE_NARRATION;
     /* Transfer records from UNPOSTED tables to Permanent tables */
     SETUP_DBTRG_INTERFACE;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
        INSERT INTO FT_CUR_TRANS_DETAIL
        SELECT *
        FROM   FT_UNPOSTED_TRANS_DETAIL
        WHERE  (TD_COMP_CODE = NEW_TH_COMP_CODE)
        AND    (TD_ACNT_YEAR = NEW_TH_ACNT_YEAR)
        AND    (TD_TRAN_CODE = NEW_TH_TRAN_CODE)
        AND    (TD_DOC_NO    = NEW_TH_DOC_NO);
    ELSE
        INSERT INTO FT_PRV_TRANS_DETAIL
        SELECT *
        FROM   FT_UNPOSTED_TRANS_DETAIL
        WHERE  (TD_COMP_CODE = NEW_TH_COMP_CODE)
        AND    (TD_ACNT_YEAR = NEW_TH_ACNT_YEAR)
        AND    (TD_TRAN_CODE    = NEW_TH_TRAN_CODE)
        AND    (TD_DOC_NO    = NEW_TH_DOC_NO);
    END IF;
END IF;
IF TRG_MODE = 'U' THEN
    /* Initialise User id. and Date */
    IF NEW_TH_CR_UID IS NULL THEN
         NEW_TH_CR_UID := NVL(OLD_TH_CR_UID,'UNDEF');
    END IF;
    NEW_TH_CR_DT := SYSDATE;
    IF OLD_TH_COMP_CODE != NEW_TH_COMP_CODE OR
       OLD_TH_TRAN_CODE != NEW_TH_TRAN_CODE OR
       OLD_TH_DOC_NO != NEW_TH_DOC_NO OR
       OLD_TH_ACNT_YEAR != NEW_TH_ACNT_YEAR THEN
       RAISE_APPLICATION_ERROR(-20013, 'Primary key change');
    END IF;
    IF OLD_TH_DOC_NO != NEW_TH_DOC_NO OR
       OLD_TH_DOC_DT != NEW_TH_DOC_DT  OR
       NVL(OLD_TH_DOC_DUE_DT,TO_DATE('01-JAN-1900','DD-MON-YYYY')) !=
       NVL(NEW_TH_DOC_DUE_DT,TO_DATE('01-JAN-1900','DD-MON-YYYY')) THEN
            RAISE_APPLICATION_ERROR
                  (-20014, 'Cannot update Document number or date');
    END IF;
    VALIDATE_NARRATION;
END IF;
IF TRG_MODE = 'D' THEN
RAISE_APPLICATION_ERROR(-20015, 'Cannot Delete record');
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_OS (
 OLD_OST_KEY_NO            IN      NUMBER,
 OLD_OST_COMP_CODE         IN      VARCHAR2,
 OLD_OST_TRAN_CODE         IN      VARCHAR2,
 OLD_OST_DOC_NO            IN      NUMBER,
 OLD_OST_SEQ_NO            IN      NUMBER,
 OLD_OST_ACNT_YEAR         IN      NUMBER,
 OLD_OST_DOC_DT            IN      DATE,
 OLD_OST_DOC_CAL_YEAR      IN      NUMBER,
 OLD_OST_DOC_CAL_MONTH     IN      NUMBER,
 OLD_OST_DUE_DT            IN      DATE,
 OLD_OST_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_OST_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_OST_DIVN_CODE         IN      VARCHAR2,
 OLD_OST_DEPT_CODE         IN      VARCHAR2,
 OLD_OST_HEAD_NO_1         IN      NUMBER,
 OLD_OST_ANLY_CODE_1       IN      VARCHAR2,
 OLD_OST_HEAD_NO_2         IN      NUMBER,
 OLD_OST_ANLY_CODE_2       IN      VARCHAR2,
 OLD_OST_ACTY_CODE_1       IN      VARCHAR2,
 OLD_OST_ACTY_CODE_2       IN      VARCHAR2,
 OLD_OST_CURR_CODE         IN      VARCHAR2,
 OLD_OST_LC_AMT            IN      NUMBER,
 OLD_OST_FC_AMT            IN      NUMBER,
 OLD_OST_DRCR_FLAG         IN      VARCHAR2,
 OLD_OST_DOC_REF           IN      VARCHAR2,
 OLD_OST_DOC_REF_DT        IN      DATE,
 OLD_OST_OTH_REF           IN      VARCHAR2,
 OLD_OST_LC_ADJ_AMT        IN      NUMBER,
 OLD_OST_FC_ADJ_AMT        IN      NUMBER,
 OLD_OST_LC_PDC_AMT        IN      NUMBER,
 OLD_OST_FC_PDC_AMT        IN      NUMBER,
 OLD_OST_LC_UNP_AMT        IN      NUMBER,
 OLD_OST_FC_UNP_AMT        IN      NUMBER,
 OLD_OST_LC_UNDEP_AMT      IN      NUMBER,
 OLD_OST_FC_UNDEP_AMT      IN      NUMBER,
 OLD_OST_LC_ORG_AMT        IN      NUMBER,
 OLD_OST_FC_ORG_AMT        IN      NUMBER,
 OLD_OST_REF_KEY_NO        IN      NUMBER,
 OLD_OST_REF_COMP_CODE     IN      VARCHAR2,
 OLD_OST_REF_ACNT_YEAR     IN      NUMBER,
 OLD_OST_REF_TRAN_CODE     IN      VARCHAR2,
 OLD_OST_REF_SEQ_NO        IN      NUMBER,
 OLD_OST_REF_DOC_NO        IN      NUMBER,
 OLD_OST_REF_DOC_DT        IN      DATE,
 OLD_OST_REF_DOC_CAL_YEAR  IN      NUMBER,
 OLD_OST_REF_DOC_CAL_MONTH IN      NUMBER,
 OLD_OST_REF_DUE_DT        IN      DATE,
 OLD_OST_LAST_MATCH_DT     IN      DATE,
 OLD_OST_TYPE              IN      VARCHAR2,
 OLD_OST_CR_UID            IN      VARCHAR2,
 OLD_OST_CR_DT             IN      DATE,
 NEW_OST_KEY_NO            IN OUT  NUMBER,
 NEW_OST_COMP_CODE         IN OUT  VARCHAR2,
 NEW_OST_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_OST_DOC_NO            IN OUT  NUMBER,
 NEW_OST_SEQ_NO            IN OUT  NUMBER,
 NEW_OST_ACNT_YEAR         IN OUT  NUMBER,
 NEW_OST_DOC_DT            IN OUT  DATE,
 NEW_OST_DOC_CAL_YEAR      IN OUT  NUMBER,
 NEW_OST_DOC_CAL_MONTH     IN OUT  NUMBER,
 NEW_OST_DUE_DT            IN OUT  DATE,
 NEW_OST_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_OST_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_OST_DIVN_CODE         IN OUT  VARCHAR2,
 NEW_OST_DEPT_CODE         IN OUT  VARCHAR2,
 NEW_OST_HEAD_NO_1         IN OUT  NUMBER,
 NEW_OST_ANLY_CODE_1       IN OUT  VARCHAR2,
 NEW_OST_HEAD_NO_2         IN OUT  NUMBER,
 NEW_OST_ANLY_CODE_2       IN OUT  VARCHAR2,
 NEW_OST_ACTY_CODE_1       IN OUT  VARCHAR2,
 NEW_OST_ACTY_CODE_2       IN OUT  VARCHAR2,
 NEW_OST_CURR_CODE         IN OUT  VARCHAR2,
 NEW_OST_LC_AMT            IN OUT  NUMBER,
 NEW_OST_FC_AMT            IN OUT  NUMBER,
 NEW_OST_DRCR_FLAG         IN OUT  VARCHAR2,
 NEW_OST_DOC_REF           IN OUT  VARCHAR2,
 NEW_OST_DOC_REF_DT        IN OUT  DATE,
 NEW_OST_OTH_REF           IN OUT  VARCHAR2,
 NEW_OST_LC_ADJ_AMT        IN OUT  NUMBER,
 NEW_OST_FC_ADJ_AMT        IN OUT  NUMBER,
 NEW_OST_LC_PDC_AMT        IN OUT  NUMBER,
 NEW_OST_FC_PDC_AMT        IN OUT  NUMBER,
 NEW_OST_LC_UNP_AMT        IN OUT  NUMBER,
 NEW_OST_FC_UNP_AMT        IN OUT  NUMBER,
 NEW_OST_LC_UNDEP_AMT      IN OUT  NUMBER,
 NEW_OST_FC_UNDEP_AMT      IN OUT  NUMBER,
 NEW_OST_LC_ORG_AMT        IN OUT  NUMBER,
 NEW_OST_FC_ORG_AMT        IN OUT  NUMBER,
 NEW_OST_REF_KEY_NO        IN OUT  NUMBER,
 NEW_OST_REF_COMP_CODE     IN OUT  VARCHAR2,
 NEW_OST_REF_ACNT_YEAR     IN OUT  NUMBER,
 NEW_OST_REF_TRAN_CODE     IN OUT  VARCHAR2,
 NEW_OST_REF_SEQ_NO        IN OUT  NUMBER,
 NEW_OST_REF_DOC_NO        IN OUT  NUMBER,
 NEW_OST_REF_DOC_DT        IN OUT  DATE,
 NEW_OST_REF_DOC_CAL_YEAR  IN OUT  NUMBER,
 NEW_OST_REF_DOC_CAL_MONTH IN OUT  NUMBER,
 NEW_OST_REF_DUE_DT        IN OUT  DATE,
 NEW_OST_LAST_MATCH_DT     IN OUT  DATE,
 NEW_OST_TYPE              IN OUT  VARCHAR2,
 NEW_OST_CR_UID            IN OUT  VARCHAR2,
 NEW_OST_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_ACNT_YEAR         NUMBER(2);
P_TRAN_CODE         VARCHAR2(3);
P_DOC_NO            NUMBER(6);
P_SEQ_NO            NUMBER(3);
P_MAIN_ACNT_CODE    VARCHAR2(6);
P_SUB_ACNT_CODE     VARCHAR2(6);
P_CUR_ACNT_YEAR     NUMBER(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
P_DUMMY             VARCHAR2(1);
CURSOR SEL_TD_INFO IS
SELECT 'X'
FROM   FP_DBTRG_INTERFACE
WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
CURSOR SEL_CUR_TD IS
SELECT 'X'
FROM   FT_CUR_TRANS_DETAIL
WHERE  (TD_COMP_CODE = P_COMP_CODE)
AND    (TD_TRAN_CODE = P_TRAN_CODE)
AND    (TD_DOC_NO    = P_DOC_NO)
AND    (TD_ACNT_YEAR = P_ACNT_YEAR)
AND    (TD_SEQ_NO = P_SEQ_NO)
AND    (TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE)
AND    (TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE);
CURSOR SEL_PRV_TD IS
SELECT 'X'
FROM   FT_PRV_TRANS_DETAIL
WHERE  (TD_COMP_CODE = P_COMP_CODE)
AND    (TD_TRAN_CODE = P_TRAN_CODE)
AND    (TD_DOC_NO    = P_DOC_NO)
AND    (TD_ACNT_YEAR = P_ACNT_YEAR)
AND    (TD_SEQ_NO = P_SEQ_NO)
AND    (TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE)
AND    (TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE);
PROCEDURE CHECK_TRANS_DETAIL IS
BEGIN
     P_COMP_CODE      := NEW_OST_COMP_CODE;
     P_TRAN_CODE      := NEW_OST_TRAN_CODE;
     P_DOC_NO         := NEW_OST_DOC_NO;
     P_SEQ_NO         := NEW_OST_SEQ_NO;
     P_ACNT_YEAR      := NEW_OST_ACNT_YEAR;
     P_MAIN_ACNT_CODE := NEW_OST_MAIN_ACNT_CODE;
     P_SUB_ACNT_CODE  := NEW_OST_SUB_ACNT_CODE;
     P_DBTI_KEY_FIELD := P_COMP_CODE ||
                         TO_CHAR(P_ACNT_YEAR) ||
                         P_TRAN_CODE ||
                         TO_CHAR(P_DOC_NO);
     IF SEL_TD_INFO%ISOPEN THEN
         CLOSE SEL_TD_INFO;
     END IF;
     OPEN SEL_TD_INFO;
     FETCH SEL_TD_INFO INTO P_DUMMY;
     IF SEL_TD_INFO%NOTFOUND THEN
          IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
              IF SEL_CUR_TD%ISOPEN THEN
                  CLOSE SEL_CUR_TD;
              END IF;
              OPEN SEL_CUR_TD;
              FETCH SEL_CUR_TD INTO P_DUMMY;
              IF SEL_CUR_TD%NOTFOUND THEN
                   RAISE_APPLICATION_ERROR
                           (-20033,'Transaction detail not found');
              END IF;
              CLOSE SEL_CUR_TD;
          ELSE
              IF SEL_PRV_TD%ISOPEN THEN
                  CLOSE SEL_PRV_TD;
              END IF;
              OPEN SEL_PRV_TD;
              FETCH SEL_PRV_TD INTO P_DUMMY;
              IF SEL_PRV_TD%NOTFOUND THEN
                   RAISE_APPLICATION_ERROR
                         (-20034,'Transaction detail not found');
              END IF;
              CLOSE SEL_PRV_TD;
          END IF;
     END IF;
     CLOSE SEL_TD_INFO;
END;
PROCEDURE INSERT_TEMP_OS IS
BEGIN
       /* Create record in Temporary table with Doc Type as I */
       INSERT INTO FW_TEMP_OS VALUES
        (NEW_OST_KEY_NO, NEW_OST_COMP_CODE, NEW_OST_TRAN_CODE,
         NEW_OST_DOC_NO, NEW_OST_SEQ_NO, NEW_OST_ACNT_YEAR,
         NEW_OST_DOC_DT, NEW_OST_DOC_CAL_YEAR,
         NEW_OST_DOC_CAL_MONTH, NEW_OST_DUE_DT,
         NEW_OST_MAIN_ACNT_CODE, NEW_OST_SUB_ACNT_CODE,
         NEW_OST_DIVN_CODE, NEW_OST_DEPT_CODE,
         NEW_OST_HEAD_NO_1, NEW_OST_ANLY_CODE_1,
         NEW_OST_HEAD_NO_2, NEW_OST_ANLY_CODE_2,
         NEW_OST_ACTY_CODE_1, NEW_OST_ACTY_CODE_2,
         NEW_OST_CURR_CODE, NEW_OST_LC_AMT,
         NEW_OST_FC_AMT, NEW_OST_DRCR_FLAG,
         NEW_OST_DOC_REF, NEW_OST_DOC_REF_DT,
         NEW_OST_OTH_REF, NEW_OST_LC_ADJ_AMT,
         NEW_OST_FC_ADJ_AMT, NEW_OST_LC_PDC_AMT,
         NEW_OST_FC_PDC_AMT, NEW_OST_LC_UNP_AMT,
         NEW_OST_FC_UNP_AMT, NEW_OST_LC_UNDEP_AMT,
         NEW_OST_FC_UNDEP_AMT, NEW_OST_LC_ORG_AMT,
         NEW_OST_FC_ORG_AMT, NEW_OST_REF_KEY_NO,
         NEW_OST_REF_COMP_CODE, NEW_OST_REF_ACNT_YEAR,
         NEW_OST_REF_TRAN_CODE, NEW_OST_REF_SEQ_NO,
         NEW_OST_REF_DOC_NO, NEW_OST_REF_DOC_DT,
         NEW_OST_REF_DOC_CAL_YEAR, NEW_OST_REF_DOC_CAL_MONTH,
         NEW_OST_REF_DUE_DT, NEW_OST_LAST_MATCH_DT,
         'I', NEW_OST_CR_UID, NEW_OST_CR_DT);
END;
PROCEDURE DELETE_TEMP_OS IS
BEGIN
       /* Create record in Temporary table with Doc Type as D */
       INSERT INTO FW_TEMP_OS VALUES
        (OLD_OST_KEY_NO, OLD_OST_COMP_CODE, OLD_OST_TRAN_CODE,
         OLD_OST_DOC_NO, OLD_OST_SEQ_NO, OLD_OST_ACNT_YEAR,
         OLD_OST_DOC_DT, OLD_OST_DOC_CAL_YEAR,
         OLD_OST_DOC_CAL_MONTH, OLD_OST_DUE_DT,
         OLD_OST_MAIN_ACNT_CODE, OLD_OST_SUB_ACNT_CODE,
         OLD_OST_DIVN_CODE, OLD_OST_DEPT_CODE,
         OLD_OST_HEAD_NO_1, OLD_OST_ANLY_CODE_1,
         OLD_OST_HEAD_NO_2, OLD_OST_ANLY_CODE_2,
         OLD_OST_ACTY_CODE_1, OLD_OST_ACTY_CODE_2,
         OLD_OST_CURR_CODE, OLD_OST_LC_AMT,
         OLD_OST_FC_AMT, OLD_OST_DRCR_FLAG,
         OLD_OST_DOC_REF, OLD_OST_DOC_REF_DT,
         OLD_OST_OTH_REF, OLD_OST_LC_ADJ_AMT,
         OLD_OST_FC_ADJ_AMT, OLD_OST_LC_PDC_AMT,
         OLD_OST_FC_PDC_AMT, OLD_OST_LC_UNP_AMT,
         OLD_OST_FC_UNP_AMT, OLD_OST_LC_UNDEP_AMT,
         OLD_OST_FC_UNDEP_AMT, OLD_OST_LC_ORG_AMT,
         OLD_OST_FC_ORG_AMT, OLD_OST_REF_KEY_NO,
         OLD_OST_REF_COMP_CODE, OLD_OST_REF_ACNT_YEAR,
         OLD_OST_REF_TRAN_CODE, OLD_OST_REF_SEQ_NO,
         OLD_OST_REF_DOC_NO, OLD_OST_REF_DOC_DT,
         OLD_OST_REF_DOC_CAL_YEAR, OLD_OST_REF_DOC_CAL_MONTH,
         OLD_OST_REF_DUE_DT, OLD_OST_LAST_MATCH_DT,
         'D', OLD_OST_CR_UID, OLD_OST_CR_DT);
END;
BEGIN
/* Main Procedure */
/* Skip processing of Internal updates so that there is no
   recursive looping */
/* Internal updates will return a Document Type Z,
   which will be reset to old document type  */
IF (NVL(NEW_OST_ACNT_YEAR,1) = 1 OR
    NVL(OLD_OST_ACNT_YEAR,1) = 1) AND
    NEW_OST_TYPE IS NULL AND
    OLD_OST_TYPE IS NULL AND
    NVL(NEW_OST_LC_ADJ_AMT,0) + NVL(NEW_OST_LC_PDC_AMT,0) +
    NVL(NEW_OST_LC_UNDEP_AMT,0) = 0 THEN
    RETURN ;
END IF ;
IF TRG_MODE = 'U' THEN
   IF NVL(NEW_OST_TYPE,'X') = 'Z' THEN
      NEW_OST_TYPE := OLD_OST_TYPE;
      RETURN;
   END IF;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_OST_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_OST_COMP_CODE);
END IF;
IF TRG_MODE = 'I' THEN
   CHECK_TRANS_DETAIL;
END IF;
IF TRG_MODE = 'I' THEN
     IF NVL(NEW_OST_TYPE,'R') != 'R' THEN
          RAISE_APPLICATION_ERROR(-20035, 'Invalid Document Type');
     END IF;
     IF NEW_OST_REF_KEY_NO IS NOT NULL THEN
          IF NVL(NEW_OST_TYPE,'X') = 'R' THEN
              IF NEW_OST_KEY_NO = NEW_OST_REF_KEY_NO THEN
                   RAISE_APPLICATION_ERROR
                      (-20036, ' Reference entry can refer to itself ');
              END IF;
              /* Ensure Entries relevant to P type are null */
              NEW_OST_LC_UNP_AMT     := 0;
              NEW_OST_FC_UNP_AMT     := 0;
              NEW_OST_LC_ADJ_AMT     := 0;
              NEW_OST_FC_ADJ_AMT     := 0;
              NEW_OST_LC_PDC_AMT     := 0;
              NEW_OST_FC_PDC_AMT     := 0;
              NEW_OST_LC_UNDEP_AMT   := 0;
              NEW_OST_FC_UNDEP_AMT   := 0;
              INSERT_TEMP_OS;
          ELSE
              RAISE_APPLICATION_ERROR
                 (-20037,'Invalid Doc Type or Cannot insert a Parent entry');
          END IF;
     ELSE
          IF NEW_OST_TYPE IS NOT NULL THEN
              RAISE_APPLICATION_ERROR
                      (-20038,'Inconsistent Ref key and Doc Type');
          ELSE
              /* Make sure all reference information is consistent with key */
              NEW_OST_REF_COMP_CODE     := NULL;
              NEW_OST_REF_ACNT_YEAR     := NULL;
              NEW_OST_REF_TRAN_CODE     := NULL;
              NEW_OST_REF_SEQ_NO        := NULL;
              NEW_OST_REF_DOC_NO        := NULL;
              NEW_OST_REF_DOC_DT        := NULL;
              NEW_OST_REF_DOC_CAL_YEAR  := NULL;
              NEW_OST_REF_DOC_CAL_MONTH := NULL;
              NEW_OST_REF_DUE_DT        := NULL;
              /* Ensure Entries relevant to P type are null */
              NEW_OST_LC_UNP_AMT     := 0;
              NEW_OST_FC_UNP_AMT     := 0;
              NEW_OST_LC_ADJ_AMT     := 0;
              NEW_OST_FC_ADJ_AMT     := 0;
              NEW_OST_LC_PDC_AMT     := 0;
              NEW_OST_FC_PDC_AMT     := 0;
              NEW_OST_LC_UNDEP_AMT   := 0;
              NEW_OST_FC_UNDEP_AMT   := 0;
          END IF;
     END IF;
END IF;
IF TRG_MODE = 'U' THEN
     IF NEW_OST_TYPE IS NULL THEN
              IF OLD_OST_TYPE = 'R' THEN
                 DELETE_TEMP_OS;
              END IF;
              IF (NVL(NEW_OST_LC_UNP_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_UNP_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_ADJ_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_ADJ_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_PDC_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_PDC_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_UNDEP_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_UNDEP_AMT,0) != 0) THEN
                 IF (NVL(NEW_OST_LC_AMT,0) = NVL(NEW_OST_LC_ORG_AMT,0)) AND
                    (NVL(NEW_OST_FC_AMT,0) = NVL(NEW_OST_FC_ORG_AMT,0)) THEN
                    NEW_OST_REF_KEY_NO        := NEW_OST_KEY_NO;
                    NEW_OST_REF_COMP_CODE     := NEW_OST_COMP_CODE;
                    NEW_OST_REF_ACNT_YEAR     := NEW_OST_ACNT_YEAR;
                    NEW_OST_REF_TRAN_CODE     := NEW_OST_TRAN_CODE;
                    NEW_OST_REF_SEQ_NO        := NEW_OST_SEQ_NO;
                    NEW_OST_REF_DOC_NO        := NEW_OST_DOC_NO;
                    NEW_OST_REF_DOC_DT        := NEW_OST_DOC_DT;
                    NEW_OST_REF_DOC_CAL_YEAR  := NEW_OST_DOC_CAL_YEAR;
                    NEW_OST_REF_DOC_CAL_MONTH := NEW_OST_DOC_CAL_MONTH;
                    NEW_OST_REF_DUE_DT        := NEW_OST_DUE_DT;
                    NEW_OST_TYPE              := 'P';
                ELSE
                    RAISE_APPLICATION_ERROR
                          (-20039, 'Doesnot qualify as a Parent entry');
                END IF;
             END IF;
     ELSE
         IF NEW_OST_TYPE = 'P' THEN
              IF (NVL(NEW_OST_LC_UNP_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_UNP_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_ADJ_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_ADJ_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_PDC_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_PDC_AMT,0) != 0) OR
                 (NVL(NEW_OST_LC_UNDEP_AMT,0) != 0) OR
                 (NVL(NEW_OST_FC_UNDEP_AMT,0) != 0) THEN
                 IF (NVL(NEW_OST_LC_AMT,0) = NVL(NEW_OST_LC_ORG_AMT,0)) AND
                    (NVL(NEW_OST_FC_AMT,0) = NVL(NEW_OST_FC_ORG_AMT,0)) THEN
                    NEW_OST_REF_KEY_NO        := NEW_OST_KEY_NO;
                    NEW_OST_REF_COMP_CODE     := NEW_OST_COMP_CODE;
                    NEW_OST_REF_ACNT_YEAR     := NEW_OST_ACNT_YEAR;
                    NEW_OST_REF_TRAN_CODE     := NEW_OST_TRAN_CODE;
                    NEW_OST_REF_SEQ_NO        := NEW_OST_SEQ_NO;
                    NEW_OST_REF_DOC_NO        := NEW_OST_DOC_NO;
                    NEW_OST_REF_DOC_DT        := NEW_OST_DOC_DT;
                    NEW_OST_REF_DOC_CAL_YEAR  := NEW_OST_DOC_CAL_YEAR;
                    NEW_OST_REF_DOC_CAL_MONTH := NEW_OST_DOC_CAL_MONTH;
                    NEW_OST_REF_DUE_DT        := NEW_OST_DUE_DT;
                ELSE
                    RAISE_APPLICATION_ERROR
                          (-20040, 'Doesnot qualify as a Parent entry');
                END IF;
             ELSE
                 /* Revert this P entry to a Null entry */
                 NEW_OST_TYPE              := NULL;
                 NEW_OST_REF_KEY_NO        := NULL;
                 NEW_OST_REF_COMP_CODE     := NULL;
                 NEW_OST_REF_ACNT_YEAR     := NULL;
                 NEW_OST_REF_TRAN_CODE     := NULL;
                 NEW_OST_REF_SEQ_NO        := NULL;
                 NEW_OST_REF_DOC_NO        := NULL;
                 NEW_OST_REF_DOC_DT        := NULL;
                 NEW_OST_REF_DOC_CAL_YEAR  := NULL;
                 NEW_OST_REF_DOC_CAL_MONTH := NULL;
                 NEW_OST_REF_DUE_DT        := NULL;
             END IF;
         ELSE
         /* If it is a R entry being updated,
                Carry out a Deletion and Re insert */
            DELETE_TEMP_OS;
            INSERT_TEMP_OS;
         END IF;
     END IF;
END IF;
IF TRG_MODE = 'D' THEN
     IF NVL(OLD_OST_TYPE,'R') != 'R' THEN
          RAISE_APPLICATION_ERROR(-20041, 'Invalid Document Type');
     END IF;
     IF OLD_OST_REF_KEY_NO IS NOT NULL THEN
          IF NVL(OLD_OST_TYPE,'X') = 'R' THEN
            DELETE_TEMP_OS;
          ELSE
              RAISE_APPLICATION_ERROR
                 (-20042,'Invalid Type or Cannot delete a Parent entry');
          END IF;
     END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_OS_AFTER AS
P_COPY_DIVN_REF     VARCHAR2(1);
P_COPY_DEPT_REF     VARCHAR2(1);
P_COPY_ANLY_REF_1   VARCHAR2(1);
P_COPY_ANLY_REF_2   VARCHAR2(1);
P_OST_DIVN_CODE     VARCHAR2(6);
P_OST_DEPT_CODE     VARCHAR2(6);
P_OST_ANLY_CODE_1   VARCHAR2(6);
P_OST_ANLY_CODE_2   VARCHAR2(6);
CURSOR SEL_TEMP_OS IS
SELECT *
FROM   FW_TEMP_OS
FOR UPDATE OF OST_KEY_NO;
REC_TEMP_OS     SEL_TEMP_OS%ROWTYPE;
CURSOR SEL_OS IS
  SELECT OST_DIVN_CODE, OST_DEPT_CODE,
         OST_ANLY_CODE_1, OST_ANLY_CODE_2,
         OST_COMP_CODE, OST_ACNT_YEAR,
         OST_TRAN_CODE, OST_SEQ_NO,
         OST_DOC_NO, OST_DOC_DT,
         OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
         OST_DUE_DT, OST_CURR_CODE
  FROM   FT_OS
  WHERE  OST_KEY_NO = REC_TEMP_OS.OST_REF_KEY_NO
  FOR UPDATE OF OST_FC_ADJ_AMT, OST_LC_ADJ_AMT,
                OST_LAST_MATCH_DT;
P_OST_REF_COMP_CODE       VARCHAR2(3);
P_OST_REF_ACNT_YEAR       NUMBER(2);
P_OST_REF_TRAN_CODE       VARCHAR2(3);
P_OST_REF_SEQ_NO          NUMBER(3);
P_OST_REF_DOC_NO          NUMBER(6);
P_OST_REF_DOC_DT          DATE;
P_OST_REF_DOC_CAL_YEAR    NUMBER(2);
P_OST_REF_DOC_CAL_MONTH   NUMBER(2);
P_OST_REF_DUE_DT          DATE;
P_OST_CURR_CODE           VARCHAR2(3);
CURSOR SEL_CPREF IS
SELECT NVL(SUBSTR(PARA_VALUE,1,1),'N'), NVL(SUBSTR(PARA_VALUE,2,1),'N'),
       NVL(SUBSTR(PARA_VALUE,3,1),'N'), NVL(SUBSTR(PARA_VALUE,4,1),'N')
FROM   FP_PARAMETER
WHERE  PARA_ID = 'COPY.OS.REF';
BEGIN
/* Main procedure */
IF SEL_CPREF%ISOPEN THEN
    CLOSE SEL_CPREF;
END IF;
OPEN SEL_CPREF;
FETCH SEL_CPREF INTO P_COPY_DIVN_REF, P_COPY_DEPT_REF,
                       P_COPY_ANLY_REF_1, P_COPY_ANLY_REF_2;
IF SEL_CPREF%NOTFOUND THEN
     P_COPY_DIVN_REF   := 'N';
     P_COPY_DEPT_REF   := 'N';
     P_COPY_ANLY_REF_1 := 'N';
     P_COPY_ANLY_REF_2 := 'N';
END IF;
CLOSE SEL_CPREF;
IF SEL_TEMP_OS%ISOPEN THEN
     CLOSE SEL_TEMP_OS;
END IF;
OPEN SEL_TEMP_OS;
LOOP
FETCH SEL_TEMP_OS INTO REC_TEMP_OS;
EXIT WHEN SEL_TEMP_OS%NOTFOUND;
    IF REC_TEMP_OS.OST_TYPE = 'I' THEN
         IF SEL_OS%ISOPEN THEN
              CLOSE SEL_OS;
         END IF;
         OPEN SEL_OS;
         FETCH SEL_OS INTO P_OST_DIVN_CODE, P_OST_DEPT_CODE,
                      P_OST_ANLY_CODE_1, P_OST_ANLY_CODE_2,
                      P_OST_REF_COMP_CODE, P_OST_REF_ACNT_YEAR,
                      P_OST_REF_TRAN_CODE, P_OST_REF_SEQ_NO,
                      P_OST_REF_DOC_NO, P_OST_REF_DOC_DT,
                      P_OST_REF_DOC_CAL_YEAR, P_OST_REF_DOC_CAL_MONTH,
                      P_OST_REF_DUE_DT, P_OST_CURR_CODE;
         IF SEL_OS%NOTFOUND THEN
              RAISE_APPLICATION_ERROR(-20043,'Invalid OS Reference');
         END IF;
         IF NVL(P_OST_CURR_CODE,'XXXX') !=
            NVL(REC_TEMP_OS.OST_CURR_CODE,'XXXX') THEN
              CLOSE SEL_OS;
              RAISE_APPLICATION_ERROR(-20044,'Currrency mismatch ');
         END IF;
         UPDATE FT_OS
         SET    OST_LC_ADJ_AMT     = NVL(OST_LC_ADJ_AMT,0) +
                                     NVL(REC_TEMP_OS.OST_LC_AMT,0),
                OST_FC_ADJ_AMT     = NVL(OST_FC_ADJ_AMT,0) +
                                     NVL(REC_TEMP_OS.OST_FC_AMT,0),
                OST_LAST_MATCH_DT  =
                    GREATEST(NVL(OST_LAST_MATCH_DT,TO_DATE('01-JAN-90')),
                                         REC_TEMP_OS.OST_DOC_DT)
         WHERE  CURRENT OF SEL_OS;
         UPDATE FT_OS
         SET    OST_REF_COMP_CODE     = P_OST_REF_COMP_CODE,
                OST_REF_ACNT_YEAR     = P_OST_REF_ACNT_YEAR,
                OST_REF_TRAN_CODE     = P_OST_REF_TRAN_CODE,
                OST_REF_DOC_NO        = P_OST_REF_DOC_NO,
                OST_REF_SEQ_NO        = P_OST_REF_SEQ_NO,
                OST_REF_DOC_DT        = P_OST_REF_DOC_DT,
                OST_REF_DOC_CAL_MONTH = P_OST_REF_DOC_CAL_MONTH,
                OST_REF_DOC_CAL_YEAR  = P_OST_REF_DOC_CAL_YEAR,
                OST_REF_DUE_DT        = P_OST_REF_DUE_DT,
                OST_DIVN_CODE         = DECODE(P_COPY_DIVN_REF,
                                          'Y', P_OST_DIVN_CODE,
                                          OST_DIVN_CODE),
                OST_DEPT_CODE         = DECODE(P_COPY_DEPT_REF,
                                          'Y', P_OST_DEPT_CODE,
                                          OST_DEPT_CODE),
                OST_ANLY_CODE_1       = DECODE(P_COPY_ANLY_REF_1,
                                          'Y', P_OST_ANLY_CODE_1,
                                          OST_ANLY_CODE_1),
                OST_ANLY_CODE_2       = DECODE(P_COPY_ANLY_REF_2,
                                          'Y', P_OST_ANLY_CODE_2,
                                          OST_ANLY_CODE_2),
                OST_TYPE              = 'Z'
         WHERE  OST_KEY_NO = REC_TEMP_OS.OST_KEY_NO;
         CLOSE SEL_OS;
    ELSE
         IF SEL_OS%ISOPEN THEN
              CLOSE SEL_OS;
         END IF;
         OPEN SEL_OS;
         FETCH SEL_OS INTO P_OST_DIVN_CODE, P_OST_DEPT_CODE,
                      P_OST_ANLY_CODE_1, P_OST_ANLY_CODE_2,
                      P_OST_REF_COMP_CODE, P_OST_REF_ACNT_YEAR,
                      P_OST_REF_TRAN_CODE, P_OST_REF_SEQ_NO,
                      P_OST_REF_DOC_NO, P_OST_REF_DOC_DT,
                      P_OST_REF_DOC_CAL_YEAR, P_OST_REF_DOC_CAL_MONTH,
                      P_OST_REF_DUE_DT, P_OST_CURR_CODE;
         IF SEL_OS%NOTFOUND THEN
              CLOSE SEL_OS;
              RAISE_APPLICATION_ERROR(-20045,'Invalid OS Reference');
         END IF;
         IF NVL(P_OST_CURR_CODE,'XXXX') !=
            NVL(REC_TEMP_OS.OST_CURR_CODE,'XXXX') THEN
              CLOSE SEL_OS;
              RAISE_APPLICATION_ERROR(-20046,'Currrency mismatch ');
         END IF;
         UPDATE FT_OS
         SET    OST_LC_ADJ_AMT     = NVL(OST_LC_ADJ_AMT,0) -
                                     NVL(REC_TEMP_OS.OST_LC_AMT,0),
                OST_FC_ADJ_AMT     = NVL(OST_FC_ADJ_AMT,0) -
                                     NVL(REC_TEMP_OS.OST_FC_AMT,0),
                OST_LAST_MATCH_DT  =
                     GREATEST(NVL(OST_LAST_MATCH_DT,TO_DATE('01-JAN-90')),
                                         REC_TEMP_OS.OST_DOC_DT)
         WHERE  CURRENT OF SEL_OS;
         CLOSE SEL_OS;
    END IF;
    DELETE FROM FW_TEMP_OS
    WHERE  CURRENT OF SEL_TEMP_OS;
END LOOP;
CLOSE SEL_TEMP_OS;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_PDC (
 OLD_PDC_COMP_CODE               IN      VARCHAR2,
 OLD_PDC_CHQ_NO                  IN      VARCHAR2,
 OLD_PDC_BANK_ACNT_CODE          IN      VARCHAR2,
 OLD_PDC_BANK_SUB_ACNT_CODE      IN      VARCHAR2,
 OLD_PDC_BANK_DIVN_CODE          IN      VARCHAR2,
 OLD_PDC_BANK_DEPT_CODE          IN      VARCHAR2,
 OLD_PDC_BANK_HEAD_NO_1          IN      NUMBER,
 OLD_PDC_BANK_ANLY_CODE_1        IN      VARCHAR2,
 OLD_PDC_BANK_HEAD_NO_2          IN      NUMBER,
 OLD_PDC_BANK_ANLY_CODE_2        IN      VARCHAR2,
 OLD_PDC_BANK_ACTY_VALUE_CODE_1  IN      VARCHAR2,
 OLD_PDC_BANK_ACTY_VALUE_CODE_2  IN      VARCHAR2,
 OLD_PDC_BANK_CURR_CODE          IN      VARCHAR2,
 OLD_PDC_BANK_FC_AMT             IN      NUMBER,
 OLD_PDC_BANK_NAME               IN      VARCHAR2,
 OLD_PDC_DEPOSIT_BANK            IN      VARCHAR2,
 OLD_PDC_DOC_NO                  IN      NUMBER,
 OLD_PDC_DOC_DT                  IN      DATE,
 OLD_PDC_DOC_CAL_YEAR            IN      NUMBER,
 OLD_PDC_DOC_CAL_MONTH           IN      NUMBER,
 OLD_PDC_DUE_DT                  IN      DATE,
 OLD_PDC_DIVN_CODE               IN      VARCHAR2,
 OLD_PDC_DEPT_CODE               IN      VARCHAR2,
 OLD_PDC_MAIN_ACNT_CODE          IN      VARCHAR2,
 OLD_PDC_SUB_ACNT_CODE           IN      VARCHAR2,
 OLD_PDC_HEAD_NO_1               IN      NUMBER,
 OLD_PDC_ANLY_CODE_1             IN      VARCHAR2,
 OLD_PDC_HEAD_NO_2               IN      NUMBER,
 OLD_PDC_ANLY_CODE_2             IN      VARCHAR2,
 OLD_PDC_ACTY_CODE_1             IN      VARCHAR2,
 OLD_PDC_ACTY_CODE_2             IN      VARCHAR2,
 OLD_PDC_CURR_CODE               IN      VARCHAR2,
 OLD_PDC_FC_AMT                  IN      NUMBER,
 OLD_PDC_LC_AMT                  IN      NUMBER,
 OLD_PDC_NAME                    IN      VARCHAR2,
 OLD_PDC_REF                     IN      VARCHAR2,
 OLD_PDC_STATUS                  IN      VARCHAR2,
 OLD_PDC_TYPE_FLAG               IN      VARCHAR2,
 OLD_PDC_REF_TRAN_CODE           IN      VARCHAR2,
 OLD_PDC_REF_ACNT_YEAR           IN      NUMBER,
 OLD_PDC_REF_DOC_NO              IN      NUMBER,
 OLD_PDC_REF_SEQ_NO              IN      NUMBER,
 OLD_PDC_REF_DOC_DT              IN      DATE,
 OLD_PDC_CDISC_TRAN_CODE         IN      VARCHAR2,
 OLD_PDC_CDISC_DOC_NO            IN      NUMBER,
 OLD_PDC_FC_CDISC_AMT            IN      NUMBER,
 OLD_PDC_LC_CDISC_AMT            IN      NUMBER,
 OLD_PDC_CDISC_ACNT_YEAR         IN      NUMBER,
 OLD_PDC_CR_UID                  IN      VARCHAR2,
 OLD_PDC_CR_DT                   IN      DATE,
 NEW_PDC_COMP_CODE               IN OUT  VARCHAR2,
 NEW_PDC_CHQ_NO                  IN OUT  VARCHAR2,
 NEW_PDC_BANK_ACNT_CODE          IN OUT  VARCHAR2,
 NEW_PDC_BANK_SUB_ACNT_CODE      IN      VARCHAR2,
 NEW_PDC_BANK_DIVN_CODE          IN      VARCHAR2,
 NEW_PDC_BANK_DEPT_CODE          IN      VARCHAR2,
 NEW_PDC_BANK_HEAD_NO_1          IN      NUMBER,
 NEW_PDC_BANK_ANLY_CODE_1        IN      VARCHAR2,
 NEW_PDC_BANK_HEAD_NO_2          IN      NUMBER,
 NEW_PDC_BANK_ANLY_CODE_2        IN      VARCHAR2,
 NEW_PDC_BANK_ACTY_VALUE_CODE_1  IN      VARCHAR2,
 NEW_PDC_BANK_ACTY_VALUE_CODE_2  IN      VARCHAR2,
 NEW_PDC_BANK_CURR_CODE          IN      VARCHAR2,
 NEW_PDC_BANK_FC_AMT             IN      NUMBER,
 NEW_PDC_BANK_NAME               IN OUT  VARCHAR2,
 NEW_PDC_DEPOSIT_BANK            IN OUT  VARCHAR2,
 NEW_PDC_DOC_NO                  IN OUT  NUMBER,
 NEW_PDC_DOC_DT                  IN OUT  DATE,
 NEW_PDC_DOC_CAL_YEAR            IN OUT  NUMBER,
 NEW_PDC_DOC_CAL_MONTH           IN OUT  NUMBER,
 NEW_PDC_DUE_DT                  IN OUT  DATE,
 NEW_PDC_DIVN_CODE               IN OUT  VARCHAR2,
 NEW_PDC_DEPT_CODE               IN OUT  VARCHAR2,
 NEW_PDC_MAIN_ACNT_CODE          IN OUT  VARCHAR2,
 NEW_PDC_SUB_ACNT_CODE           IN OUT  VARCHAR2,
 NEW_PDC_HEAD_NO_1               IN OUT  NUMBER,
 NEW_PDC_ANLY_CODE_1             IN OUT  VARCHAR2,
 NEW_PDC_HEAD_NO_2               IN OUT  NUMBER,
 NEW_PDC_ANLY_CODE_2             IN OUT  VARCHAR2,
 NEW_PDC_ACTY_CODE_1             IN OUT  VARCHAR2,
 NEW_PDC_ACTY_CODE_2             IN OUT  VARCHAR2,
 NEW_PDC_CURR_CODE               IN OUT  VARCHAR2,
 NEW_PDC_FC_AMT                  IN OUT  NUMBER,
 NEW_PDC_LC_AMT                  IN OUT  NUMBER,
 NEW_PDC_NAME                    IN OUT  VARCHAR2,
 NEW_PDC_REF                     IN OUT  VARCHAR2,
 NEW_PDC_STATUS                  IN OUT  VARCHAR2,
 NEW_PDC_TYPE_FLAG               IN OUT  VARCHAR2,
 NEW_PDC_REF_TRAN_CODE           IN OUT  VARCHAR2,
 NEW_PDC_REF_ACNT_YEAR           IN OUT  NUMBER,
 NEW_PDC_REF_DOC_NO              IN OUT  NUMBER,
 NEW_PDC_REF_SEQ_NO              IN OUT  NUMBER,
 NEW_PDC_REF_DOC_DT              IN OUT  DATE,
 NEW_PDC_CDISC_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_PDC_CDISC_DOC_NO            IN OUT  NUMBER,
 NEW_PDC_FC_CDISC_AMT            IN OUT  NUMBER,
 NEW_PDC_LC_CDISC_AMT            IN OUT  NUMBER,
 NEW_PDC_CDISC_ACNT_YEAR         IN OUT  NUMBER,
 NEW_PDC_CR_UID                  IN OUT  VARCHAR2,
 NEW_PDC_CR_DT                   IN OUT  DATE,
 TRG_MODE                        IN OUT  VARCHAR2,
 TRG_ERR_NO                         OUT  NUMBER,
 TRG_ERR_MSG                        OUT  VARCHAR2,
 OLD_PDC_SEQ_NO                     IN   NUMBER,
 NEW_PDC_SEQ_NO                     IN   NUMBER) AS
P_COMP_CODE         VARCHAR2(3);
P_CHQ_NO            VARCHAR2(10);
P_PDC_MAIN_ACNT_CODE VARCHAR2(6);
P_OPEN_ENTRY_FLAG   VARCHAR2(1);
P_PHS_KEY_NO        NUMBER(10) ;
P_ERR_NO            NUMBER(6);
CURSOR SEL_MAIN IS
       SELECT MAIN_OPEN_ENTRY_FLAG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = P_PDC_MAIN_ACNT_CODE;
/* Declare Local procedures for repetitive use within the trigger */
PROCEDURE VALIDATE_CODE_COMBN IS
P_KEY    NUMBER(8);
BEGIN
F_VAL_COMB (NEW_PDC_COMP_CODE, NEW_PDC_DIVN_CODE, NEW_PDC_DEPT_CODE,
            NEW_PDC_MAIN_ACNT_CODE, NEW_PDC_SUB_ACNT_CODE,
            NEW_PDC_ANLY_CODE_1, NEW_PDC_ANLY_CODE_2, P_ERR_NO, P_KEY);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20009, 'Invalid Code combination');
END IF;
END;
PROCEDURE VALIDATE_CODE_COMBN_B IS
P_KEY    NUMBER(8);
BEGIN
F_VAL_COMB (NEW_PDC_COMP_CODE, NEW_PDC_BANK_DIVN_CODE, NEW_PDC_BANK_DEPT_CODE,
            NEW_PDC_BANK_ACNT_CODE, NEW_PDC_BANK_SUB_ACNT_CODE,
            NEW_PDC_BANK_ANLY_CODE_1, NEW_PDC_BANK_ANLY_CODE_2,P_ERR_NO, P_KEY);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20009, 'Invalid Code combination');
END IF;
END;
PROCEDURE INSERT_PDC_OS IS
P_POS_KEY_NO     NUMBER(8);
BEGIN
   P_PDC_MAIN_ACNT_CODE := NEW_PDC_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
           F_PDC_OS(P_POS_KEY_NO);
           INSERT INTO FT_PDC_OS
               (POS_KEY_NO, POS_COMP_CODE, POS_PDC_CHQ_NO,
                POS_MAIN_ACNT_CODE, POS_SUB_ACNT_CODE,
                POS_CURR_CODE, POS_LC_AMT, POS_FC_AMT, POS_DRCR_FLAG,
                POS_CR_UID, POS_CR_DT, POS_PDC_SEQ_NO)
           VALUES
               (P_POS_KEY_NO, NEW_PDC_COMP_CODE, NEW_PDC_CHQ_NO,
                NEW_PDC_MAIN_ACNT_CODE, NEW_PDC_SUB_ACNT_CODE,
                NEW_PDC_CURR_CODE, NEW_PDC_LC_AMT, NEW_PDC_FC_AMT,
                DECODE(NEW_PDC_TYPE_FLAG,'R','C','I','D'),
                NEW_PDC_CR_UID, NEW_PDC_CR_DT, NEW_PDC_SEQ_NO);
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE DELETE_PDC_OS IS
BEGIN
   P_PDC_MAIN_ACNT_CODE := OLD_PDC_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
             DELETE FROM FT_PDC_OS
             WHERE  POS_COMP_CODE = OLD_PDC_COMP_CODE
             AND    POS_PDC_SEQ_NO = OLD_PDC_SEQ_NO;
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE UPDATE_PDC_OS_AMT IS
P_UNMAT_POS_KEY_NO     NUMBER(8);
P_UNMAT_POS_LC_AMT     NUMBER(14,3);
P_UNMAT_POS_FC_AMT     NUMBER(14,3);
P_DIFF_LC_AMT          NUMBER(14,3);
P_DIFF_FC_AMT          NUMBER(14,3);
P_BASE_CURR            VARCHAR2(3) ;
CURSOR SEL_OS IS
       SELECT POS_KEY_NO, POS_LC_AMT, POS_FC_AMT
       FROM   FT_PDC_OS
       WHERE  (POS_COMP_CODE  = OLD_PDC_COMP_CODE)
       AND    (POS_PDC_SEQ_NO = OLD_PDC_SEQ_NO)
       AND    (POS_REF_KEY_NO IS NULL);
CURSOR FET_BASE_CURR IS
       SELECT PARA_VALUE
       FROM FP_PARAMETER
       WHERE PARA_ID = 'BASE.CURR';
BEGIN
     P_DIFF_LC_AMT := NVL(NEW_PDC_LC_AMT,0) - NVL(OLD_PDC_LC_AMT,0);
     P_DIFF_FC_AMT := NVL(NEW_PDC_FC_AMT,0) - NVL(OLD_PDC_FC_AMT,0);
     IF FET_BASE_CURR%ISOPEN THEN
        CLOSE FET_BASE_CURR;
     END IF;
     OPEN FET_BASE_CURR;
     FETCH FET_BASE_CURR INTO P_BASE_CURR ;
     IF FET_BASE_CURR%NOTFOUND THEN
        CLOSE FET_BASE_CURR;
        RAISE_APPLICATION_ERROR(-20999,
             'Base currency parameter not found') ;
     END IF ;
     CLOSE FET_BASE_CURR;
     IF SEL_OS%ISOPEN THEN
        CLOSE SEL_OS;
     END IF;
     OPEN SEL_OS;
     FETCH SEL_OS INTO P_UNMAT_POS_KEY_NO,
                       P_UNMAT_POS_LC_AMT, P_UNMAT_POS_FC_AMT;
     IF SEL_OS%NOTFOUND THEN
        IF P_BASE_CURR = NVL(NEW_PDC_CURR_CODE,OLD_PDC_CURR_CODE) THEN
           IF NVL(NEW_PDC_FC_AMT,0) != NVL(OLD_PDC_FC_AMT,0) OR
              NVL(NEW_PDC_LC_AMT,0) != NVL(OLD_PDC_LC_AMT,0) THEN
              DELETE_PDC_OS;
              INSERT_PDC_OS;
           END IF ;
        ELSE
           IF NVL(NEW_PDC_FC_AMT,0) != NVL(OLD_PDC_FC_AMT,0) THEN
              DELETE_PDC_OS;
              INSERT_PDC_OS;
           END IF ;
        END IF ;
     ELSE
          P_DIFF_LC_AMT := NVL(NEW_PDC_LC_AMT,0) / NVL(NEW_PDC_FC_AMT,0) *
                           (NVL(P_DIFF_FC_AMT,0) + NVL(P_UNMAT_POS_FC_AMT,0));
          IF (NVL(P_UNMAT_POS_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) >= 0) THEN
             IF (NVL(P_UNMAT_POS_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) = 0) THEN
                 DELETE FROM FT_PDC_OS
                 WHERE  POS_KEY_NO = P_UNMAT_POS_KEY_NO
                 AND    NVL(POS_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) = 0 ;
             ELSE
                 UPDATE FT_PDC_OS
                 SET    POS_LC_AMT = NVL(P_DIFF_LC_AMT,0),
                        POS_FC_AMT = NVL(POS_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0)
                 WHERE  POS_KEY_NO = P_UNMAT_POS_KEY_NO;
             END IF;
          ELSE
             DELETE_PDC_OS;
             INSERT_PDC_OS;
          END IF;
     END IF;
     CLOSE SEL_OS;
END;
PROCEDURE TRANSFER_PDC_OS IS
P_ACNT_YEAR      NUMBER(2);
P_CAL_YEAR       NUMBER(2);
P_CAL_MONTH      NUMBER(2);
P_ERR_NO         NUMBER(6);
P_DUMMY          VARCHAR2(1);
CURSOR SEL_PDC_OS IS
SELECT 'X'
FROM   FT_PDC_OS
WHERE  POS_COMP_CODE = NEW_PDC_COMP_CODE
AND    POS_PDC_SEQ_NO = NEW_PDC_SEQ_NO
AND    POS_REF_KEY_NO IS NOT NULL;
BEGIN
F_VAL_OPCL(NEW_PDC_COMP_CODE, NEW_PDC_REF_DOC_DT, P_ERR_NO,
           P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
   RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
END IF;
NEW_PDC_REF_ACNT_YEAR := P_ACNT_YEAR;
IF SEL_PDC_OS%ISOPEN THEN
     CLOSE SEL_PDC_OS;
END IF;
OPEN SEL_PDC_OS;
FETCH SEL_PDC_OS INTO P_DUMMY;
IF SEL_PDC_OS%FOUND THEN
   /* Delete the default entry that will be generated
      by TRG_FT_CUR_TRANS_DETAIL */
   DELETE FROM FT_OS
   WHERE  OST_COMP_CODE = NEW_PDC_COMP_CODE
   AND    OST_ACNT_YEAR = NEW_PDC_REF_ACNT_YEAR
   AND    OST_TRAN_CODE = NEW_PDC_REF_TRAN_CODE
   AND    OST_DOC_NO = NEW_PDC_REF_DOC_NO
   AND    OST_SEQ_NO = NEW_PDC_REF_SEQ_NO
   AND    OST_MAIN_ACNT_CODE = NEW_PDC_MAIN_ACNT_CODE
   AND    OST_SUB_ACNT_CODE = NEW_PDC_SUB_ACNT_CODE;
   /* Insert Fresh entry */
   INSERT INTO FS_MATCH_OS
   (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO, OST_SEQ_NO,
    OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
    OST_DUE_DT, OST_MAIN_ACNT_CODE, OST_SUB_ACNT_CODE, OST_DIVN_CODE,
    OST_DEPT_CODE, OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
    OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2, OST_CURR_CODE,
    OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG, OST_DOC_REF, OST_LC_ORG_AMT,
    OST_FC_ORG_AMT, OST_REF_KEY_NO, OST_TYPE, OST_CR_UID, OST_CR_DT)
   SELECT
    SEQ_OST_KEY_NO.NEXTVAL, POS_COMP_CODE, NEW_PDC_REF_TRAN_CODE,
    NEW_PDC_REF_DOC_NO, NEW_PDC_REF_SEQ_NO, NEW_PDC_REF_ACNT_YEAR,
    NEW_PDC_REF_DOC_DT, P_CAL_YEAR, P_CAL_MONTH, NEW_PDC_REF_DOC_DT,
    POS_MAIN_ACNT_CODE, POS_SUB_ACNT_CODE, NEW_PDC_DIVN_CODE,
    NEW_PDC_DEPT_CODE, NEW_PDC_HEAD_NO_1, NEW_PDC_ANLY_CODE_1,
    NEW_PDC_HEAD_NO_2, NEW_PDC_ANLY_CODE_2, NEW_PDC_ACTY_CODE_1,
    NEW_PDC_ACTY_CODE_2, POS_CURR_CODE, POS_LC_AMT, POS_FC_AMT,
    POS_DRCR_FLAG, NEW_PDC_REF, NEW_PDC_LC_AMT, NEW_PDC_FC_AMT,
    POS_REF_KEY_NO, DECODE(POS_REF_KEY_NO, NULL, NULL, 'R'),
    POS_CR_UID, POS_CR_DT
   FROM FT_PDC_OS
   WHERE  POS_COMP_CODE  = NEW_PDC_COMP_CODE
   AND    POS_PDC_SEQ_NO = NEW_PDC_SEQ_NO;
   STP_FT_OS_AFTER ;
   DELETE FROM FT_PDC_OS
   WHERE  POS_COMP_CODE  = NEW_PDC_COMP_CODE
   AND    POS_PDC_SEQ_NO = NEW_PDC_SEQ_NO;
END IF;
CLOSE SEL_PDC_OS;
DELETE FROM FT_PDC_OS
WHERE  POS_COMP_CODE  = NEW_PDC_COMP_CODE
AND    POS_PDC_SEQ_NO = NEW_PDC_SEQ_NO;
END;
PROCEDURE TRANSFER_TRANS IS
P_ACNT_YEAR      NUMBER(2);
P_CAL_YEAR       NUMBER(2);
P_CAL_MONTH      NUMBER(2);
P_ERR_NO         NUMBER(6);
BEGIN
F_VAL_OPCL(NEW_PDC_COMP_CODE, NEW_PDC_REF_DOC_DT, P_ERR_NO,
           P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
   RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
END IF;
NEW_PDC_REF_ACNT_YEAR := P_ACNT_YEAR;
IF NEW_PDC_REF_SEQ_NO = 1 THEN
      /* Insert into audit trail header */
      SELECT SEQ_PHS_KEY_NO.NEXTVAL
      INTO   P_PHS_KEY_NO
      FROM   DUAL ;
      INSERT INTO FS_PROC_HEADER
             (PHS_KEY_NO, PHS_USER_ID, PHS_PROC_DT, PHS_PROC_STATUS,
              PHS_COMP_CODE, PHS_TRAN_FRM, PHS_TRAN_TO, PHS_TRAN_DT_FRM,
              PHS_TRAN_DT_TO, PHS_DOC_NO_FRM, PHS_DOC_NO_TO,
              PHS_USER_PATTERN, PHS_HEAD_REC_TOT, PHS_DETAIL_REC_TOT,
              PHS_AMT_TOT, PHS_ERROR_NAME, PHS_CR_UID, PHS_CR_DT)
      VALUES (P_PHS_KEY_NO, NEW_PDC_CR_UID, SYSDATE, '', NEW_PDC_COMP_CODE,
              NEW_PDC_REF_TRAN_CODE, NEW_PDC_REF_TRAN_CODE,
              NEW_PDC_REF_DOC_DT, NEW_PDC_REF_DOC_DT, NEW_PDC_REF_DOC_NO,
              NEW_PDC_REF_DOC_NO, NEW_PDC_CR_UID, '1', '', '', '',
              NEW_PDC_CR_UID, NEW_PDC_CR_DT) ;
   /* Insert Header */
    INSERT INTO FT_CUR_TRANS_HEADER
    (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE, TH_DOC_NO, TH_DOC_DT,
     TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH, TH_DOC_DUE_DT, TH_CR_UID, TH_CR_DT,
     TH_DOC_REF, TH_DOC_REF_DT, TH_DESC, TH_CTL_TOTAL)
    VALUES
    (NEW_PDC_COMP_CODE, NEW_PDC_REF_ACNT_YEAR, NEW_PDC_REF_TRAN_CODE,
     NEW_PDC_REF_DOC_NO, NEW_PDC_REF_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
Press <Enter> to continue...
     NEW_PDC_REF_DOC_DT, NEW_PDC_CR_UID, NEW_PDC_CR_DT,
     NEW_PDC_CHQ_NO, NEW_PDC_DUE_DT, DECODE(NEW_PDC_TYPE_FLAG, 'R',
     'CONFIRMATION OF PDC RECEIVED VIDE RECEIPT NO. ',
     'CONFIRMATION OF PDC ISSUED VIDE ISSUE NO. ') ||
      TO_CHAR(NEW_PDC_DOC_NO) || ' DATED ' || TO_CHAR(NEW_PDC_DOC_DT,'DD/MM/YY')
     , P_PHS_KEY_NO);
END IF;
/* Insert Audit Trail record */
INSERT INTO FS_PDC_TRAIL
(PT_PDC_SEQ_NO, PT_PDC_COMP_CODE, PT_PDC_CHQ_NO, PT_ACNT_YEAR,
 PT_TRAN_CODE, PT_DOC_NO, PT_SEQ_NO, PT_CR_UID, PT_CR_DT)
VALUES
(NEW_PDC_SEQ_NO, NEW_PDC_COMP_CODE, NEW_PDC_CHQ_NO, NEW_PDC_REF_ACNT_YEAR,
 NEW_PDC_REF_TRAN_CODE, NEW_PDC_REF_DOC_NO, NEW_PDC_REF_SEQ_NO,
 NEW_PDC_CR_UID, NEW_PDC_CR_DT);
VALIDATE_CODE_COMBN;
/* Insert Debtor or Creditor record */
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_CURR_CODE, TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF,
 TD_DOC_DUE_DT, TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2,
 TD_DESC, TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
VALUES
(NEW_PDC_COMP_CODE, NEW_PDC_REF_ACNT_YEAR, NEW_PDC_REF_TRAN_CODE,
 NEW_PDC_REF_DOC_NO, NEW_PDC_REF_SEQ_NO, NEW_PDC_MAIN_ACNT_CODE,
 NEW_PDC_SUB_ACNT_CODE, NEW_PDC_DIVN_CODE, NEW_PDC_DEPT_CODE,
 NEW_PDC_HEAD_NO_1, NEW_PDC_ANLY_CODE_1, NEW_PDC_HEAD_NO_2,
 NEW_PDC_ANLY_CODE_2, NEW_PDC_CURR_CODE, NEW_PDC_LC_AMT,
 DECODE(NEW_PDC_TYPE_FLAG,'R','C','I','D','X'),
 NEW_PDC_FC_AMT, NEW_PDC_CHQ_NO, NEW_PDC_REF_DOC_DT,
 NEW_PDC_ACTY_CODE_1, NEW_PDC_ACTY_CODE_2, TO_CHAR(NEW_PDC_DOC_NO) ||
 ' ' || NEW_PDC_NAME || ', REF. ' || NEW_PDC_REF,
 'N', 'N', 'N', '0', NEW_PDC_CR_UID, NEW_PDC_CR_DT);
VALIDATE_CODE_COMBN_B;
/* Insert Bank record */
INSERT INTO FT_CUR_TRANS_DETAIL
(TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE, TD_DOC_NO, TD_SEQ_NO,
 TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE, TD_DIVN_CODE, TD_DEPT_CODE,
 TD_HEAD_NO_1, TD_ANLY_CODE_1, TD_HEAD_NO_2, TD_ANLY_CODE_2,
 TD_CURR_CODE, TD_DOC_AMT, TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF,
 TD_DOC_DUE_DT, TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2,
 TD_DESC, TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
 TD_PYMT_APPR_FLAG, TD_CR_UID, TD_CR_DT)
VALUES
(NEW_PDC_COMP_CODE, NEW_PDC_REF_ACNT_YEAR, NEW_PDC_REF_TRAN_CODE,
 NEW_PDC_REF_DOC_NO, NEW_PDC_REF_SEQ_NO + 1, NEW_PDC_BANK_ACNT_CODE,
 NEW_PDC_BANK_SUB_ACNT_CODE, NEW_PDC_BANK_DIVN_CODE, NEW_PDC_BANK_DEPT_CODE,
 NEW_PDC_BANK_HEAD_NO_1, NEW_PDC_BANK_ANLY_CODE_1,
 NEW_PDC_BANK_HEAD_NO_2, NEW_PDC_BANK_ANLY_CODE_2,
 NEW_PDC_BANK_CURR_CODE, NEW_PDC_LC_AMT,
 DECODE(NEW_PDC_TYPE_FLAG,'R','D','I','C','X'),
 NEW_PDC_BANK_FC_AMT, NEW_PDC_CHQ_NO, NEW_PDC_REF_DOC_DT,
 NEW_PDC_ACTY_CODE_1, NEW_PDC_ACTY_CODE_2, TO_CHAR(NEW_PDC_DOC_NO) ||
 ' ' || NEW_PDC_NAME || ', REF. ' || NEW_PDC_REF,
 'N', 'N', 'N', '0', NEW_PDC_CR_UID, NEW_PDC_CR_DT);
END;
BEGIN
/* Main procedure */
P_ERR_NO := 0;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_COMP_CODE := NEW_PDC_COMP_CODE;
    P_CHQ_NO := NEW_PDC_CHQ_NO;
ELSE
    P_COMP_CODE := OLD_PDC_COMP_CODE;
    P_CHQ_NO := OLD_PDC_CHQ_NO;
END IF;
IF TRG_MODE = 'I' THEN
   IF NVL(NEW_PDC_STATUS,'X') != 'P' THEN
      RAISE_APPLICATION_ERROR(-20011, 'PDC must be pending during insert');
   END IF;
   VALIDATE_CODE_COMBN;
   INSERT_PDC_OS;
END IF;
IF TRG_MODE = 'U' THEN
   IF (OLD_PDC_COMP_CODE != NEW_PDC_COMP_CODE) OR
      (OLD_PDC_SEQ_NO != NEW_PDC_SEQ_NO) THEN
      RAISE_APPLICATION_ERROR(-20011, 'Primary key change');
   END IF;
   IF (OLD_PDC_TYPE_FLAG != NEW_PDC_TYPE_FLAG) THEN
      RAISE_APPLICATION_ERROR(-20011, 'PDC Type cannot be changed');
   END IF;
   IF OLD_PDC_STATUS = 'C' THEN
      RAISE_APPLICATION_ERROR(-20011, 'Cannot update a confirmed document');
   END IF;
   IF NEW_PDC_STATUS = 'P' THEN
       /* Non Confirmation updation */
       IF (OLD_PDC_MAIN_ACNT_CODE != NEW_PDC_MAIN_ACNT_CODE) OR
          (NVL(OLD_PDC_SUB_ACNT_CODE,'000000') !=
           NVL(NEW_PDC_SUB_ACNT_CODE,'000000')) OR
          (NVL(OLD_PDC_CURR_CODE,'000') !=
           NVL(NEW_PDC_CURR_CODE,'000')) THEN
            VALIDATE_CODE_COMBN;
            DELETE_PDC_OS;
            INSERT_PDC_OS;
       ELSE
            IF  (NVL(OLD_PDC_DIVN_CODE,'000000') !=
                 NVL(NEW_PDC_DIVN_CODE,'000000')) OR
                (NVL(OLD_PDC_DEPT_CODE,'000000') !=
                 NVL(NEW_PDC_DEPT_CODE,'000000')) OR
                (NVL(OLD_PDC_ANLY_CODE_1,'000000') !=
                 NVL(NEW_PDC_ANLY_CODE_1,'000000')) OR
                (NVL(OLD_PDC_ANLY_CODE_2,'000000') !=
                 NVL(NEW_PDC_ANLY_CODE_2,'000000')) THEN
                 VALIDATE_CODE_COMBN;
                 /* required??? */
                 IF (NVL(OLD_PDC_LC_AMT,0) != NVL(NEW_PDC_LC_AMT,0)) OR
                    (NVL(OLD_PDC_FC_AMT,0) != NVL(NEW_PDC_FC_AMT,0)) THEN
                    UPDATE_PDC_OS_AMT;
                 END IF;
            END IF;
            IF (NVL(OLD_PDC_LC_AMT,0) != NVL(NEW_PDC_LC_AMT,0)) OR
               (NVL(OLD_PDC_FC_AMT,0) != NVL(NEW_PDC_FC_AMT,0)) THEN
               UPDATE_PDC_OS_AMT;
            END IF;
       END IF;
   END IF;
   /* PDC Confirmation */
   IF NEW_PDC_STATUS = 'C' AND OLD_PDC_STATUS = 'P' THEN
       IF (OLD_PDC_MAIN_ACNT_CODE != NEW_PDC_MAIN_ACNT_CODE) OR
          (NVL(OLD_PDC_SUB_ACNT_CODE,'000000') !=
           NVL(NEW_PDC_SUB_ACNT_CODE,'000000')) OR
          (NVL(OLD_PDC_CURR_CODE,'000') !=
           NVL(NEW_PDC_CURR_CODE,'000')) OR
          (NVL(OLD_PDC_DIVN_CODE,'000000') !=
           NVL(NEW_PDC_DIVN_CODE,'000000')) OR
          (NVL(OLD_PDC_DEPT_CODE,'000000') !=
           NVL(NEW_PDC_DEPT_CODE,'000000')) OR
          (NVL(OLD_PDC_ANLY_CODE_1,'000000') !=
           NVL(NEW_PDC_ANLY_CODE_1,'000000')) OR
          (NVL(OLD_PDC_ANLY_CODE_2,'000000') !=
           NVL(NEW_PDC_ANLY_CODE_2,'000000')) THEN
          RAISE_APPLICATION_ERROR(-20010,
                'Cannot initiate confirmation along with Code change');
       END IF;
       IF (NVL(OLD_PDC_LC_AMT,0) != NVL(NEW_PDC_LC_AMT,0)) OR
          (NVL(OLD_PDC_FC_AMT,0) != NVL(NEW_PDC_FC_AMT,0)) THEN
          RAISE_APPLICATION_ERROR(-20010,
                'Cannot initiate confirmation along with Amount change');
       END IF;
       IF NEW_PDC_REF_TRAN_CODE IS NULL OR
          NEW_PDC_REF_ACNT_YEAR IS NULL OR
          NEW_PDC_REF_DOC_NO IS NULL OR
          NEW_PDC_REF_SEQ_NO IS NULL OR
          NEW_PDC_REF_DOC_DT IS NULL THEN
          RAISE_APPLICATION_ERROR(-20010,
          'Cannot initiate confirmation without providing Document reference');
       END IF;
       TRANSFER_TRANS;
       TRANSFER_PDC_OS;
    END IF;
END IF;
IF TRG_MODE = 'D' THEN
   IF OLD_PDC_STATUS = 'C' THEN
      RAISE_APPLICATION_ERROR(-20011, 'Cannot delete a confirmed document');
   END IF;
   DELETE_PDC_OS;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_PDC_OS (
 OLD_POS_KEY_NO            IN      NUMBER,
 OLD_POS_COMP_CODE         IN      VARCHAR2,
 OLD_POS_PDC_CHQ_NO        IN      VARCHAR2,
 OLD_POS_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_POS_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_POS_CURR_CODE         IN      VARCHAR2,
 OLD_POS_LC_AMT            IN      NUMBER,
 OLD_POS_FC_AMT            IN      NUMBER,
 OLD_POS_DRCR_FLAG         IN      VARCHAR2,
 OLD_POS_REF_DUE_DT        IN      DATE,
 OLD_POS_REF_KEY_NO        IN      NUMBER,
 OLD_POS_CR_UID            IN      VARCHAR2,
 OLD_POS_CR_DT             IN      DATE,
 NEW_POS_KEY_NO            IN OUT  NUMBER,
 NEW_POS_COMP_CODE         IN OUT  VARCHAR2,
 NEW_POS_PDC_CHQ_NO        IN OUT  VARCHAR2,
 NEW_POS_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_POS_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_POS_CURR_CODE         IN OUT  VARCHAR2,
 NEW_POS_LC_AMT            IN OUT  NUMBER,
 NEW_POS_FC_AMT            IN OUT  NUMBER,
 NEW_POS_DRCR_FLAG         IN OUT  VARCHAR2,
 NEW_POS_REF_DUE_DT        IN OUT  DATE,
 NEW_POS_REF_KEY_NO        IN OUT  NUMBER,
 NEW_POS_CR_UID            IN OUT  VARCHAR2,
 NEW_POS_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_CHQ_NO            VARCHAR2(10);
P_MAIN_ACNT_CODE    VARCHAR2(6);
P_SUB_ACNT_CODE     VARCHAR2(6);
P_PREV_POS_LC_AMT   NUMBER(14,3);
P_PREV_POS_FC_AMT   NUMBER(14,3);
P_DUMMY             VARCHAR2(1);
P_OST_CURR_CODE     VARCHAR2(3);
P_OST_LC_AMT        NUMBER(14,3);
P_OST_FC_AMT        NUMBER(14,3);
P_OST_LC_ORG_AMT    NUMBER(14,3);
P_OST_FC_ORG_AMT    NUMBER(14,3);
CURSOR SEL_OS IS
  SELECT OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT,
         OST_LC_ORG_AMT, OST_FC_ORG_AMT
  FROM   FT_OS
  WHERE  OST_KEY_NO = NEW_POS_REF_KEY_NO
  AND    NVL(OST_TYPE,'P') = 'P'
  FOR UPDATE OF OST_FC_PDC_AMT, OST_LC_PDC_AMT;
BEGIN
IF TRG_MODE = 'U' THEN
    IF OLD_POS_COMP_CODE != NEW_POS_COMP_CODE OR
       OLD_POS_PDC_CHQ_NO != NEW_POS_PDC_CHQ_NO OR
       OLD_POS_MAIN_ACNT_CODE != NEW_POS_MAIN_ACNT_CODE OR
       OLD_POS_SUB_ACNT_CODE != NEW_POS_SUB_ACNT_CODE  OR
       NVL(OLD_POS_REF_KEY_NO,0) != NVL(NEW_POS_REF_KEY_NO,0) THEN
       RAISE_APPLICATION_ERROR(-20024,'Significant OS fields changed');
    END IF;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NEW_POS_REF_KEY_NO IS NOT NULL THEN
          IF TRG_MODE = 'I' THEN
               P_PREV_POS_LC_AMT := 0;
               P_PREV_POS_FC_AMT := 0;
          ELSE
               P_PREV_POS_LC_AMT := OLD_POS_LC_AMT;
               P_PREV_POS_FC_AMT := OLD_POS_FC_AMT;
          END IF;
          IF SEL_OS%ISOPEN THEN
               CLOSE SEL_OS;
          END IF;
          OPEN SEL_OS;
          FETCH SEL_OS INTO P_OST_CURR_CODE,
                            P_OST_FC_AMT, P_OST_LC_AMT,
                            P_OST_FC_ORG_AMT, P_OST_LC_ORG_AMT;
          IF SEL_OS%NOTFOUND THEN
               CLOSE SEL_OS;
               RAISE_APPLICATION_ERROR(-20029,'Invalid OS Reference');
          END IF;
          IF NVL(P_OST_CURR_CODE,'XXXX') !=
             NVL(NEW_POS_CURR_CODE,'XXXX') THEN
               CLOSE SEL_OS;
               RAISE_APPLICATION_ERROR(-20030,'Currrency mismatch ');
          END IF;
          IF NVL(P_OST_LC_AMT,0) != NVL(P_OST_LC_ORG_AMT,0) OR
             NVL(P_OST_FC_AMT,0) != NVL(P_OST_FC_ORG_AMT,0) THEN
               RAISE_APPLICATION_ERROR
                    (-20031,'Doesnot qualify as parent entry ');
          END IF;
          UPDATE FT_OS
          SET    OST_LC_PDC_AMT     = NVL(OST_LC_PDC_AMT,0) +
                                      NVL(NEW_POS_LC_AMT,0) -
                                      NVL(P_PREV_POS_LC_AMT,0),
                 OST_FC_PDC_AMT     = NVL(OST_FC_PDC_AMT,0) +
                                      NVL(NEW_POS_FC_AMT,0) -
                                      NVL(P_PREV_POS_FC_AMT,0)
          WHERE  CURRENT OF SEL_OS;
          CLOSE SEL_OS;
     END IF;
END IF;
IF TRG_MODE = 'D' THEN
     IF OLD_POS_REF_KEY_NO IS NOT NULL THEN
          UPDATE FT_OS
          SET    OST_LC_PDC_AMT     = NVL(OST_LC_PDC_AMT,0) -
                                      NVL(OLD_POS_LC_AMT,0),
                 OST_FC_PDC_AMT     = NVL(OST_FC_PDC_AMT,0) -
                                      NVL(OLD_POS_FC_AMT,0)
          WHERE  OST_KEY_NO = OLD_POS_REF_KEY_NO;
     END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_PRV_TRANS_DETAIL (
 OLD_TD_COMP_CODE               IN      VARCHAR2,
 OLD_TD_ACNT_YEAR               IN      NUMBER,
 OLD_TD_TRAN_CODE               IN      VARCHAR2,
 OLD_TD_DOC_NO                  IN      NUMBER,
 OLD_TD_SEQ_NO                  IN      NUMBER,
 OLD_TD_MAIN_ACNT_CODE          IN      VARCHAR2,
 OLD_TD_SUB_ACNT_CODE           IN      VARCHAR2,
 OLD_TD_DIVN_CODE               IN      VARCHAR2,
 OLD_TD_DEPT_CODE               IN      VARCHAR2,
 OLD_TD_HEAD_NO_1               IN      NUMBER,
 OLD_TD_ANLY_CODE_1             IN      VARCHAR2,
 OLD_TD_HEAD_NO_2               IN      NUMBER,
 OLD_TD_ANLY_CODE_2             IN      VARCHAR2,
 OLD_TD_CURR_CODE               IN      VARCHAR2,
 OLD_TD_DOC_AMT                 IN      NUMBER,
 OLD_TD_DOC_DRCR_FLAG           IN      VARCHAR2,
 OLD_TD_FC_AMT                  IN      NUMBER,
 OLD_TD_DOC_REF                 IN      VARCHAR2,
 OLD_TD_DOC_DUE_DT              IN      DATE,
 OLD_TD_OTH_REF                 IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_1       IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_2       IN      VARCHAR2,
 OLD_TD_DESC                    IN      VARCHAR2,
 OLD_TD_DBK_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_LED_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_MONTH_PRC_FLAG          IN      VARCHAR2,
 OLD_TD_BILL_FC_AMT             IN      NUMBER,
 OLD_TD_BILL_LC_AMT             IN      NUMBER,
 OLD_TD_BILL_STATUS             IN      VARCHAR2,
 OLD_TD_PYMT_APPR_FLAG          IN      VARCHAR2,
 OLD_TD_CR_UID                  IN      VARCHAR2,
 OLD_TD_CR_DT                   IN      DATE,
 OLD_TD_PYMT_LAST_APPR_FC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_LC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_BANK     IN      VARCHAR2,
 NEW_TD_COMP_CODE               IN OUT  VARCHAR2,
 NEW_TD_ACNT_YEAR               IN OUT  NUMBER,
 NEW_TD_TRAN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_NO                  IN OUT  NUMBER,
 NEW_TD_SEQ_NO                  IN OUT  NUMBER,
 NEW_TD_MAIN_ACNT_CODE          IN OUT  VARCHAR2,
 NEW_TD_SUB_ACNT_CODE           IN OUT  VARCHAR2,
 NEW_TD_DIVN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DEPT_CODE               IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_1               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_1             IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_2               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_2             IN OUT  VARCHAR2,
 NEW_TD_CURR_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_AMT                 IN OUT  NUMBER,
 NEW_TD_DOC_DRCR_FLAG           IN OUT  VARCHAR2,
 NEW_TD_FC_AMT                  IN OUT  NUMBER,
 NEW_TD_DOC_REF                 IN OUT  VARCHAR2,
 NEW_TD_DOC_DUE_DT              IN OUT  DATE,
 NEW_TD_OTH_REF                 IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_1       IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_2       IN OUT  VARCHAR2,
 NEW_TD_DESC                    IN OUT  VARCHAR2,
 NEW_TD_DBK_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_LED_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_MONTH_PRC_FLAG          IN OUT  VARCHAR2,
 NEW_TD_BILL_FC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_LC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_STATUS             IN OUT  VARCHAR2,
 NEW_TD_PYMT_APPR_FLAG          IN OUT  VARCHAR2,
 NEW_TD_CR_UID                  IN OUT  VARCHAR2,
 NEW_TD_CR_DT                   IN OUT  DATE,
 NEW_TD_PYMT_LAST_APPR_FC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_LC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_BANK     IN OUT  VARCHAR2,
 TRG_MODE                       IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_ACNT_YEAR         NUMBER(2);
P_TRAN_CODE         VARCHAR2(3);
P_DOC_NO            NUMBER(6);
P_CUR_ACNT_YEAR     NUMBER(2);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_DOC_DT            DATE;
P_DOC_DUE_DT        DATE;
P_DOC_REF_DT        DATE;
P_TD_MAIN_ACNT_CODE VARCHAR2(6);
P_OPEN_ENTRY_FLAG   VARCHAR2(1);
P_MAIN_ACNT_CATG    VARCHAR2(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
P_PHS_KEY_NO        FS_PROC_HEADER.PHS_KEY_NO%TYPE ;
P_CR_UID            FT_CUR_TRANS_HEADER.TH_CR_UID%TYPE ;
P_CR_DT             FT_CUR_TRANS_HEADER.TH_CR_DT%TYPE ;
P_BAL_AMT           NUMBER(20,3) ;
P_TRAN_AMT          NUMBER(20,3) ;
P_PDS_SEQ_NO        NUMBER(6) ;
P_ERR_NO            NUMBER(6);
CURSOR SEL_TH IS
       SELECT TH_DOC_DT, TH_DOC_CAL_MONTH, TH_DOC_CAL_YEAR,
              TH_DOC_DUE_DT, TH_DOC_REF_DT, TH_CTL_TOTAL,
              TH_CR_UID, TH_CR_DT
       FROM   FT_PRV_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
CURSOR SEL_TH_INFO IS
       SELECT TO_DATE(DBTI_VALUE_1), TO_NUMBER(DBTI_VALUE_2),
              TO_NUMBER(DBTI_VALUE_3), TO_DATE(DBTI_VALUE_4),
              TO_DATE(DBTI_VALUE_5), TO_NUMBER(DBTI_VALUE_10),
              DBTI_VALUE_11, TO_DATE(DBTI_VALUE_12)
       FROM   FP_DBTRG_INTERFACE
       WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
CURSOR SEL_MAIN IS
       SELECT MAIN_OPEN_ENTRY_FLAG, MAIN_ACNT_CATG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = P_TD_MAIN_ACNT_CODE;
CURSOR SEQ_NO IS
       SELECT MAX(PDS_SEQ_NO)
       FROM   FS_PROC_DETAIL
       WHERE  PDS_KEY_NO = P_PHS_KEY_NO ;
/* Declare Local procedures for repetitive use within the trigger */
PROCEDURE VALIDATE_CODE_COMBN IS
P_KEY    NUMBER(8);
BEGIN
F_VAL_COMB (NEW_TD_COMP_CODE, NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
            NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
            NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2, P_ERR_NO, P_KEY);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20016, 'Invalid Code combination');
END IF;
END;
PROCEDURE INSERT_CUR_OS IS
P_OST_KEY_NO     NUMBER(8);
P_OST_REF_KEY_NO NUMBER(8);
P_OST_LC_AMT     NUMBER(14,3);
P_OST_FC_AMT     NUMBEr(14,3);
CURSOR F_OS_DET IS
       SELECT OST_KEY_NO, OST_REF_KEY_NO,
              OST_LC_AMT, OST_FC_AMT
       FROM   FT_UNPOSTED_OS
       WHERE  (OST_COMP_CODE = NEW_TD_COMP_CODE)
       AND    (OST_ACNT_YEAR = NEW_TD_ACNT_YEAR)
       AND    (OST_TRAN_CODE = NEW_TD_TRAN_CODE)
       AND    (OST_DOC_NO    = NEW_TD_DOC_NO)
       AND    (OST_SEQ_NO    = NEW_TD_SEQ_NO);
BEGIN
   P_TD_MAIN_ACNT_CODE := NEW_TD_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG, P_MAIN_ACNT_CATG ;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
           IF F_OS_DET%ISOPEN THEN
                CLOSE F_OS_DET;
           END IF;
           OPEN F_OS_DET;
           FETCH F_OS_DET INTO P_OST_KEY_NO, P_OST_REF_KEY_NO,
                               P_OST_LC_AMT, P_OST_FC_AMT;
           IF F_OS_DET%FOUND THEN
                LOOP
                EXIT WHEN F_OS_DET%NOTFOUND;
                     INSERT INTO FS_MATCH_OS
                     SELECT FT_UNPOSTED_OS.*, 'FIN7',SYSDATE
                     FROM   FT_UNPOSTED_OS
                     WHERE  (OST_KEY_NO = P_OST_KEY_NO);
                     FETCH F_OS_DET INTO P_OST_KEY_NO, P_OST_REF_KEY_NO,
                                         P_OST_LC_AMT, P_OST_FC_AMT;
                END LOOP;
           ELSE
                F_OS(P_OST_KEY_NO);
                INSERT INTO FT_OS
                  (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                   OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                   OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                   OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                   OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                   OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                   OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                   OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                   OST_LC_ORG_AMT, OST_FC_ORG_AMT, OST_TYPE,
                   OST_CR_UID, OST_CR_DT)
                VALUES
                  (P_OST_KEY_NO, NEW_TD_COMP_CODE, NEW_TD_TRAN_CODE,
                   NEW_TD_DOC_NO, NEW_TD_SEQ_NO, NEW_TD_ACNT_YEAR,
                   P_DOC_DT, P_CAL_YEAR, P_CAL_MONTH, NEW_TD_DOC_DUE_DT,
                   NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                   NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE, NEW_TD_HEAD_NO_1,
                   NEW_TD_ANLY_CODE_1, NEW_TD_HEAD_NO_2,
                   NEW_TD_ANLY_CODE_2, NEW_TD_ACTY_VALUE_CODE_1,
                   NEW_TD_ACTY_VALUE_CODE_2,
                   NEW_TD_CURR_CODE, NEW_TD_DOC_AMT, NEW_TD_FC_AMT,
                   NEW_TD_DOC_DRCR_FLAG, NEW_TD_DOC_REF, P_DOC_REF_DT,
                   NEW_TD_OTH_REF, NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NULL,
                   NEW_TD_CR_UID, NEW_TD_CR_DT);
           END IF;
           CLOSE F_OS_DET;
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE UPDATE_CUR_OS_CODES IS
BEGIN
     UPDATE FT_OS
     SET    OST_DIVN_CODE   = NEW_TD_DIVN_CODE,
            OST_DEPT_CODE   = NEW_TD_DEPT_CODE,
            OST_ANLY_CODE_1 = NEW_TD_ANLY_CODE_1,
            OST_ANLY_CODE_2 = NEW_TD_ANLY_CODE_2,
            OST_ACTY_CODE_1 = NEW_TD_ACTY_VALUE_CODE_1,
            OST_ACTY_CODE_2 = NEW_TD_ACTY_VALUE_CODE_2,
            OST_DOC_REF     = NEW_TD_DOC_REF,
            OST_OTH_REF     = NEW_TD_OTH_REF,
            OST_DUE_DT      = NEW_TD_DOC_DUE_DT
     WHERE  (OST_COMP_CODE = OLD_TD_COMP_CODE)
     AND    (OST_ACNT_YEAR = OLD_TD_ACNT_YEAR)
     AND    (OST_TRAN_CODE = OLD_TD_TRAN_CODE)
     AND    (OST_DOC_NO    = OLD_TD_DOC_NO)
     AND    (OST_SEQ_NO    = OLD_TD_SEQ_NO);
END;
PROCEDURE INCREASE_ACNT_BAL IS
BEGIN
   F_UPD_ACNT_BAL (NEW_TD_COMP_CODE, P_ACNT_YEAR,
                   NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                   NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
                   NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2,
                   P_CAL_YEAR, P_CAL_MONTH, NEW_TD_CURR_CODE,
                   NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NEW_TD_DOC_DRCR_FLAG,
                   'P', 'A', NEW_TD_CR_UID, P_ERR_NO);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Error at balance updation');
   END IF;
END;
BEGIN
/* Main procedure */
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TD_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TD_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'U' THEN
   NEW_TD_ACNT_YEAR := OLD_TD_ACNT_YEAR;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_COMP_CODE := NEW_TD_COMP_CODE;
    P_TRAN_CODE := NEW_TD_TRAN_CODE;
    P_ACNT_YEAR := NEW_TD_ACNT_YEAR;
    P_DOC_NO := NEW_TD_DOC_NO;
ELSE
    P_COMP_CODE := OLD_TD_COMP_CODE;
    P_TRAN_CODE := OLD_TD_TRAN_CODE;
    P_ACNT_YEAR := OLD_TD_ACNT_YEAR;
    P_DOC_NO := OLD_TD_DOC_NO;
END IF;
P_DBTI_KEY_FIELD := P_COMP_CODE ||
                    TO_CHAR(P_ACNT_YEAR) ||
                    P_TRAN_CODE ||
                    TO_CHAR(P_DOC_NO);
IF SEL_TH_INFO%ISOPEN THEN
    CLOSE SEL_TH_INFO;
END IF;
OPEN SEL_TH_INFO;
FETCH SEL_TH_INFO INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                    P_DOC_DUE_DT, P_DOC_REF_DT,
                    P_PHS_KEY_NO, P_CR_UID, P_CR_DT ;
IF SEL_TH_INFO%NOTFOUND THEN
     IF SEL_TH%ISOPEN THEN
         CLOSE SEL_TH;
     END IF;
     OPEN SEL_TH;
     FETCH SEL_TH INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                         P_DOC_DUE_DT, P_DOC_REF_DT,
                         P_PHS_KEY_NO, P_CR_UID, P_CR_DT ;
     IF SEL_TH%NOTFOUND THEN
          RAISE_APPLICATION_ERROR(-20017,'Header not found');
     END IF;
     CLOSE SEL_TH;
ELSE
     /* Used for verification in DB triggers corresponding to
        FT_UNPOSTED_OS and FT_OS tables */
     IF TRG_MODE = 'I' OR TRG_MODE = 'U'  THEN
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(NEW_TD_SEQ_NO),
                 DBTI_VALUE_7 = NEW_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = NEW_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     ELSE
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(OLD_TD_SEQ_NO),
                 DBTI_VALUE_7 = OLD_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = OLD_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     END IF;
END IF;
CLOSE SEL_TH_INFO;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NEW_TD_DOC_DUE_DT IS NULL THEN
        NEW_TD_DOC_DUE_DT := P_DOC_DUE_DT;
     END IF;
END IF;
IF TRG_MODE = 'I' THEN
   VALIDATE_CODE_COMBN;
   INCREASE_ACNT_BAL;
   INSERT_CUR_OS;
/* Below are added by Selva on 18/03/95 for Audit trail */
   IF P_PHS_KEY_NO IS NOT NULL THEN
      P_BAL_AMT := 0 ;
      IF NEW_TD_DOC_DRCR_FLAG = 'D' THEN
         P_TRAN_AMT := NEW_TD_DOC_AMT ;
      ELSE
         P_TRAN_AMT := NEW_TD_DOC_AMT * - 1;
      END IF;
      F_GET_LC_BAL (NEW_TD_COMP_CODE       ,
                    NEW_TD_ACNT_YEAR       ,
                    NEW_TD_MAIN_ACNT_CODE  ,
                    NEW_TD_SUB_ACNT_CODE   ,
                    NEW_TD_DIVN_CODE       ,
                    NEW_TD_DEPT_CODE       ,
                    NEW_TD_ANLY_CODE_1     ,
                    NEW_TD_ANLY_CODE_2     ,
                    P_CAL_YEAR             ,
                    P_CAL_MONTH            ,
                    P_BAL_AMT              ,
                    P_ERR_NO);
      IF SEQ_NO%ISOPEN THEN
         CLOSE SEQ_NO ;
      END IF ;
      OPEN SEQ_NO ;
      FETCH SEQ_NO INTO P_PDS_SEQ_NO ;
      IF SEQ_NO%NOTFOUND THEN
         P_PDS_SEQ_NO := 1 ;
      ELSE
         P_PDS_SEQ_NO := NVL(P_PDS_SEQ_NO,0) + 1 ;
      END IF ;
      INSERT INTO FS_PROC_DETAIL
             (PDS_KEY_NO, PDS_SEQ_NO, PDS_COMP_CODE, PDS_CAL_MONTH,
              PDS_CAL_YEAR, PDS_MAIN_ACNT_CODE, PDS_SUB_ACNT_CODE,
              PDS_DIVN_CODE, PDS_DEPT_CODE, PDS_HEAD_NO_1, PDS_ANLY_CODE_1,
              PDS_HEAD_NO_2, PDS_ANLY_CODE_2, PDS_BEFORE_BAL_AMT,
              PDS_AFTER_BAL_AMT, PDS_PROC_UID, PDS_PROC_DT, PDS_PROC_STATUS,
              PDS_CR_UID, PDS_CR_DT)
      VALUES (P_PHS_KEY_NO, P_PDS_SEQ_NO, NEW_TD_COMP_CODE, P_CAL_MONTH,
              P_CAL_YEAR, NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
              NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE, 1, NEW_TD_ANLY_CODE_1,
              2, NEW_TD_ANLY_CODE_2, P_BAL_AMT - P_TRAN_AMT, P_BAL_AMT,
              P_CR_UID, SYSDATE, 'S', P_CR_UID, P_CR_DT) ;
   END IF ;
/* Above are added by Selva on 18/03/95 */
END IF;
IF TRG_MODE = 'U' THEN
   IF (OLD_TD_COMP_CODE != NEW_TD_COMP_CODE) OR
      (OLD_TD_TRAN_CODE != NEW_TD_TRAN_CODE) OR
      (OLD_TD_DOC_NO != NEW_TD_DOC_NO) OR
      (OLD_TD_SEQ_NO != NEW_TD_SEQ_NO) THEN
      RAISE_APPLICATION_ERROR(-20018, 'Primary key change');
   END IF;
   IF     (OLD_TD_MAIN_ACNT_CODE != NEW_TD_MAIN_ACNT_CODE) OR
          (NVL(OLD_TD_SUB_ACNT_CODE,'000000') !=
           NVL(NEW_TD_SUB_ACNT_CODE,'000000')) OR
          (NVL(OLD_TD_DOC_DRCR_FLAG,'0') !=
           NVL(NEW_TD_DOC_DRCR_FLAG,'0')) OR
          (NVL(OLD_TD_CURR_CODE,'000') !=
           NVL(NEW_TD_CURR_CODE,'000')) THEN
          RAISE_APPLICATION_ERROR(-20019, 'Significant codes change');
    ELSE
            IF  (NVL(OLD_TD_DIVN_CODE,'000000') !=
                 NVL(NEW_TD_DIVN_CODE,'000000')) OR
                (NVL(OLD_TD_DEPT_CODE,'000000') !=
                 NVL(NEW_TD_DEPT_CODE,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_1,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_1,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_2,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_2,'000000')) THEN
                    RAISE_APPLICATION_ERROR
                   (-20020, 'Significant codes change');
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0))
                    THEN
                       RAISE_APPLICATION_ERROR(-20021, 'Amount change');
                    END IF;
            ELSE
                    IF (NVL(OLD_TD_DOC_DUE_DT,'01-JAN-90') !=
                        NVL(NEW_TD_DOC_DUE_DT,'01-JAN-90')) OR
                       (NVL(OLD_TD_DOC_REF,' ') !=
                        NVL(NEW_TD_DOC_REF,' ')) OR
                       (NVL(OLD_TD_OTH_REF,' ') !=
                        NVL(NEW_TD_OTH_REF,' ')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_1,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_1,'000000')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_2,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_2,'000000')) THEN
                           VALIDATE_CODE_COMBN;
                           UPDATE_CUR_OS_CODES;
                    END IF;
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0))
                    THEN
                       RAISE_APPLICATION_ERROR(-20022, 'Amount change');
                    END IF;
            END IF;
    END IF;
END IF;
IF TRG_MODE = 'D' THEN
     RAISE_APPLICATION_ERROR(-20023, 'Cannot delete record');
END IF;
IF (TRG_MODE = 'I' AND P_MAIN_ACNT_CATG = 'WI') AND
   (NEW_TD_MONTH_PRC_FLAG != 'O') THEN
   IF NEW_TD_ACTY_VALUE_CODE_1 IS NULL OR
      NEW_TD_DOC_REF IS NULL THEN
      RAISE_APPLICATION_ERROR(-20024, 'WIP A/c should have Job number and Activity code entered') ;
   END IF ;
   INSERT INTO OT_JOB_EXPENSE
          (JEX_SYS_ID, JEX_COMP_CODE, JEX_NO, JEX_DT, JEX_ACNT_YEAR_MTH,
           JEX_JH_NO, JEX_JH_SYS_ID, JEX_JEXP_CODE, JEX_VAL,
           JEX_MAIN_ACNT_CODE, JEX_SUB_ACNT_CODE, JEX_DIVN_CODE,
           JEX_DEPT_CODE, JEX_ANLY_HEAD_NO_1, JEX_ANLY_CODE_1,
           JEX_ANLY_HEAD_NO_2, JEX_ANLY_CODE_2, JEX_ACTY_VALUE_CODE_1,
           JEX_ACTY_VALUE_CODE_2, JEX_TH_TRAN_CODE, JEX_TH_DOC_NO,
           JEX_TH_DOC_DT, JEX_STATUS, JEX_CR_DT, JEX_CR_UID)
   SELECT  JEX_SYS_ID.NEXTVAL, NEW_TD_COMP_CODE, NEW_TD_DOC_NO, P_DOC_DT,
           P_DOC_DT, NULL, NULL, NULL, 0, NULL, NULL, NULL,
           NULL, NULL, NULL, NULL, NULL, NULL, NULL,
           NEW_TD_TRAN_CODE, NEW_TD_DOC_NO,
           P_DOC_DT, 1, NEW_TD_CR_DT, NEW_TD_CR_UID
   FROM    DUAL
   WHERE   NOT EXISTS (SELECT 'X' FROM OT_JOB_EXPENSE
                       WHERE JEX_COMP_CODE    = NEW_TD_COMP_CODE
                       AND   JEX_NO           = NEW_TD_DOC_NO
                       AND   JEX_TH_TRAN_CODE = NEW_TD_TRAN_CODE
                       AND   JEX_TH_DOC_NO    = NEW_TD_DOC_NO) ;
   INSERT INTO OT_JOB_EXPENSE
          (JEX_SYS_ID, JEX_COMP_CODE, JEX_NO, JEX_DT, JEX_ACNT_YEAR_MTH,
           JEX_JH_NO, JEX_JH_SYS_ID, JEX_JEXP_CODE, JEX_VAL,
           JEX_MAIN_ACNT_CODE, JEX_SUB_ACNT_CODE, JEX_DIVN_CODE,
           JEX_DEPT_CODE, JEX_ANLY_HEAD_NO_1, JEX_ANLY_CODE_1,
           JEX_ANLY_HEAD_NO_2, JEX_ANLY_CODE_2, JEX_ACTY_VALUE_CODE_1,
           JEX_ACTY_VALUE_CODE_2, JEX_TH_TRAN_CODE, JEX_TH_DOC_NO,
           JEX_TH_DOC_DT, JEX_STATUS, JEX_CR_DT, JEX_CR_UID)
   SELECT  JEX_SYS_ID.NEXTVAL, NEW_TD_COMP_CODE, NEW_TD_DOC_NO, P_DOC_DT,
           P_DOC_DT, JH_NO, JH_SYS_ID, NEW_TD_ACTY_VALUE_CODE_1,
           (DECODE(NEW_TD_DOC_DRCR_FLAG, 'D', 1, -1) * NVL(NEW_TD_DOC_AMT,0)),
           NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE, NEW_TD_DIVN_CODE,
           NEW_TD_DEPT_CODE, NEW_TD_HEAD_NO_1, NEW_TD_ANLY_CODE_1,
           NEW_TD_HEAD_NO_2, NEW_TD_ANLY_CODE_2, NEW_TD_ACTY_VALUE_CODE_1,
           NEW_TD_ACTY_VALUE_CODE_2, NEW_TD_TRAN_CODE, NEW_TD_DOC_NO,
           P_DOC_DT, 1, NEW_TD_CR_DT, NEW_TD_CR_UID
   FROM    OT_JOB_HEAD
   WHERE   JH_COMP_CODE = NEW_TD_COMP_CODE
   AND     JH_NO        = NEW_TD_DOC_REF ;
END IF ;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_PRV_TRANS_HEADER (
 OLD_TH_COMP_CODE          IN      VARCHAR2,
 OLD_TH_ACNT_YEAR          IN      NUMBER,
 OLD_TH_TRAN_CODE          IN      VARCHAR2,
 OLD_TH_DOC_NO             IN      NUMBER,
 OLD_TH_DOC_DT             IN      DATE,
 OLD_TH_DOC_CAL_YEAR       IN      NUMBER,
 OLD_TH_DOC_CAL_MONTH      IN      NUMBER,
 OLD_TH_DOC_REF            IN      VARCHAR2,
 OLD_TH_DOC_REF_DT         IN      DATE,
 OLD_TH_DOC_DUE_DT         IN      DATE,
 OLD_TH_DIVN_CODE          IN      VARCHAR2,
 OLD_TH_DEPT_CODE          IN      VARCHAR2,
 OLD_TH_CTL_TOTAL          IN      NUMBER,
 OLD_TH_DESC               IN      VARCHAR2,
 OLD_TH_ANNOTATION         IN      VARCHAR2,
 OLD_TH_CR_UID             IN      VARCHAR2,
 OLD_TH_CR_DT              IN      DATE,
 NEW_TH_COMP_CODE          IN OUT  VARCHAR2,
 NEW_TH_ACNT_YEAR          IN OUT  NUMBER,
 NEW_TH_TRAN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DOC_NO             IN OUT  NUMBER,
 NEW_TH_DOC_DT             IN OUT  DATE,
 NEW_TH_DOC_CAL_YEAR       IN OUT  NUMBER,
 NEW_TH_DOC_CAL_MONTH      IN OUT  NUMBER,
 NEW_TH_DOC_REF            IN OUT  VARCHAR2,
 NEW_TH_DOC_REF_DT         IN OUT  DATE,
 NEW_TH_DOC_DUE_DT         IN OUT  DATE,
 NEW_TH_DIVN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DEPT_CODE          IN OUT  VARCHAR2,
 NEW_TH_CTL_TOTAL          IN OUT  NUMBER,
 NEW_TH_DESC               IN OUT  VARCHAR2,
 NEW_TH_ANNOTATION         IN OUT  VARCHAR2,
 NEW_TH_CR_UID             IN OUT  VARCHAR2,
 NEW_TH_CR_DT              IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_ERR_NO            NUMBER(6);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_ACNT_YEAR         NUMBER(2);
P_CUR_ACNT_YEAR     NUMBER(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
PROCEDURE SETUP_DBTRG_INTERFACE IS
BEGIN
          IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
              P_DBTI_KEY_FIELD := OLD_TH_COMP_CODE ||
                                  TO_CHAR(OLD_TH_ACNT_YEAR) ||
                                  OLD_TH_TRAN_CODE ||
                                  TO_CHAR(OLD_TH_DOC_NO) ;
          ELSE
              P_DBTI_KEY_FIELD := NEW_TH_COMP_CODE ||
                                  TO_CHAR(NEW_TH_ACNT_YEAR) ||
                                  NEW_TH_TRAN_CODE ||
                                  TO_CHAR(NEW_TH_DOC_NO) ;
          END IF;
          DELETE FROM FP_DBTRG_INTERFACE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
          IF TRG_MODE = 'D' THEN
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(OLD_TH_DOC_DT),
                      TO_CHAR(OLD_TH_DOC_CAL_MONTH),
                      TO_CHAR(OLD_TH_DOC_CAL_YEAR),
                      TO_CHAR(OLD_TH_DOC_DUE_DT),
                      TO_CHAR(OLD_TH_DOC_REF_DT));
          ELSE
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5,
                      DBTI_VALUE_10, DBTI_VALUE_11, DBTI_VALUE_12)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(NEW_TH_DOC_DT),
                      TO_CHAR(NEW_TH_DOC_CAL_MONTH),
                      TO_CHAR(NEW_TH_DOC_CAL_YEAR),
                      TO_CHAR(NEW_TH_DOC_DUE_DT),
                      TO_CHAR(NEW_TH_DOC_REF_DT),
                      TO_CHAR(NEW_TH_CTL_TOTAL),
                      NEW_TH_CR_UID,
                      NEW_TH_CR_DT);
          END IF;
END;
PROCEDURE VALIDATE_NARRATION IS
BEGIN
    /* Validate the data type of various components of the Narration, if
        Structuring of the narration is used. */
    IF NVL(OLD_TH_DESC,' ') != NVL(NEW_TH_DESC,' ') THEN
        F_VAL_NARRATION(NEW_TH_TRAN_CODE, NEW_TH_DESC, P_ERR_NO);
        IF P_ERR_NO != 0 THEN
            RAISE_APPLICATION_ERROR(-20012, 'Invalid Narration');
        END IF;
    END IF;
END;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TH_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TH_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'I' THEN
    /* Initialise User id. and Date */
    IF NEW_TH_CR_UID IS NULL THEN
         NEW_TH_CR_UID := NVL(NEW_TH_CR_UID,'UNDEF');
    END IF;
    NEW_TH_CR_DT := SYSDATE;
    /* Validate if the document period corresponding to the document date
        is open. */
    F_VAL_OPCL(NEW_TH_COMP_CODE, NEW_TH_DOC_DT, P_ERR_NO,
               P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
    IF P_ERR_NO != 0 THEN
         RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
    END IF;
    NEW_TH_ACNT_YEAR := P_ACNT_YEAR;
    NEW_TH_DOC_CAL_MONTH := P_CAL_MONTH;
    NEW_TH_DOC_CAL_YEAR  := P_CAL_YEAR;
     VALIDATE_NARRATION;
     /* Transfer records from UNPOSTED tables to Permanent tables */
     SETUP_DBTRG_INTERFACE;
     IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
        INSERT INTO FT_CUR_TRANS_DETAIL
        SELECT *
        FROM   FT_UNPOSTED_TRANS_DETAIL
        WHERE  (TD_COMP_CODE = NEW_TH_COMP_CODE)
        AND    (TD_ACNT_YEAR = NEW_TH_ACNT_YEAR)
        AND    (TD_TRAN_CODE = NEW_TH_TRAN_CODE)
        AND    (TD_DOC_NO    = NEW_TH_DOC_NO);
    ELSE
        INSERT INTO FT_PRV_TRANS_DETAIL
        SELECT *
        FROM   FT_UNPOSTED_TRANS_DETAIL
        WHERE  (TD_COMP_CODE = NEW_TH_COMP_CODE)
        AND    (TD_ACNT_YEAR = NEW_TH_ACNT_YEAR)
        AND    (TD_TRAN_CODE    = NEW_TH_TRAN_CODE)
        AND    (TD_DOC_NO    = NEW_TH_DOC_NO);
    END IF;
END IF;
IF TRG_MODE = 'U' THEN
    /* Initialise User id. and Date */
    IF NEW_TH_CR_UID IS NULL THEN
         NEW_TH_CR_UID := NVL(OLD_TH_CR_UID,'UNDEF');
    END IF;
    NEW_TH_CR_DT := SYSDATE;
    IF OLD_TH_COMP_CODE != NEW_TH_COMP_CODE OR
       OLD_TH_TRAN_CODE != NEW_TH_TRAN_CODE OR
       OLD_TH_DOC_NO != NEW_TH_DOC_NO OR
       OLD_TH_ACNT_YEAR != NEW_TH_ACNT_YEAR THEN
       RAISE_APPLICATION_ERROR(-20013, 'Primary key change');
    END IF;
    IF OLD_TH_DOC_NO != NEW_TH_DOC_NO OR
       OLD_TH_DOC_DT != NEW_TH_DOC_DT  OR
       NVL(OLD_TH_DOC_DUE_DT,TO_DATE('01-JAN-1900','DD-MON-YYYY')) !=
       NVL(NEW_TH_DOC_DUE_DT,TO_DATE('01-JAN-1900','DD-MON-YYYY')) THEN
            RAISE_APPLICATION_ERROR
                  (-20014, 'Cannot update Document number or date');
    END IF;
    VALIDATE_NARRATION;
END IF;
IF TRG_MODE = 'D' THEN
RAISE_APPLICATION_ERROR(-20015, 'Cannot Delete record');
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_REVERSAL_JV (
 OLD_RJV_COMP_CODE         IN      VARCHAR2,
 OLD_RJV_ORGL_ACNT_YEAR    IN      NUMBER,
 OLD_RJV_ORGL_TRAN_CODE    IN      VARCHAR2,
 OLD_RJV_ORGL_DOC_NO       IN      NUMBER,
 OLD_RJV_REV_TRAN_CODE     IN      VARCHAR2,
 OLD_RJV_REV_DOC_NO        IN      NUMBER,
 OLD_RJV_REV_DOC_DT        IN      DATE,
 OLD_RJV_CR_UID            IN      VARCHAR2,
 OLD_RJV_CR_DT             IN      DATE,
 OLD_RJV_ORGL_DOC_DT       IN      DATE,
 OLD_RJV_REV_DESC          IN      VARCHAR2,
 NEW_RJV_COMP_CODE         IN OUT  VARCHAR2,
 NEW_RJV_ORGL_ACNT_YEAR    IN OUT  NUMBER,
 NEW_RJV_ORGL_TRAN_CODE    IN OUT  VARCHAR2,
 NEW_RJV_ORGL_DOC_NO       IN OUT  NUMBER,
 NEW_RJV_REV_TRAN_CODE     IN OUT  VARCHAR2,
 NEW_RJV_REV_DOC_NO        IN OUT  NUMBER,
 NEW_RJV_REV_DOC_DT        IN OUT  DATE,
 NEW_RJV_CR_UID            IN OUT  VARCHAR2,
 NEW_RJV_CR_DT             IN OUT  DATE,
 NEW_RJV_ORGL_DOC_DT       IN OUT  DATE,
 NEW_RJV_REV_DESC          IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_ERR_NO            NUMBER(6);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_ACNT_YEAR         NUMBER(2);
P_CUR_ACNT_YEAR     NUMBER(2);
P_PHS_KEY_NO        NUMBER(10) ;
BEGIN
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_RJV_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_RJV_COMP_CODE);
END IF;
P_ERR_NO := 0;
/* Validate if the document period corresponding to the document date
    is open. */
F_VAL_OPCL(NEW_RJV_COMP_CODE, NEW_RJV_REV_DOC_DT, P_ERR_NO,
           P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
END IF;
IF P_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
   IF NEW_RJV_ORGL_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
      /* Insert into audit trail header */
      SELECT SEQ_PHS_KEY_NO.NEXTVAL
      INTO   P_PHS_KEY_NO
      FROM   DUAL ;
      INSERT INTO FS_PROC_HEADER
             (PHS_KEY_NO, PHS_USER_ID, PHS_PROC_DT, PHS_PROC_STATUS,
              PHS_COMP_CODE, PHS_TRAN_FRM, PHS_TRAN_TO, PHS_TRAN_DT_FRM,
              PHS_TRAN_DT_TO, PHS_DOC_NO_FRM, PHS_DOC_NO_TO,
              PHS_USER_PATTERN, PHS_HEAD_REC_TOT, PHS_DETAIL_REC_TOT,
              PHS_AMT_TOT, PHS_ERROR_NAME, PHS_CR_UID, PHS_CR_DT)
      VALUES (P_PHS_KEY_NO, NEW_RJV_CR_UID, SYSDATE, '', NEW_RJV_COMP_CODE,
              NEW_RJV_REV_TRAN_CODE, NEW_RJV_REV_TRAN_CODE,
              NEW_RJV_REV_DOC_DT, NEW_RJV_REV_DOC_DT, NEW_RJV_REV_DOC_NO,
              NEW_RJV_REV_DOC_NO, NEW_RJV_CR_UID, '1', '', '', '',
              NEW_RJV_CR_UID, NEW_RJV_CR_DT) ;
/* If original and reversed JVs are from the current accounting year */
   INSERT INTO FT_CUR_TRANS_HEADER (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE,
          TH_DOC_NO, TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION,
          TH_CR_UID, TH_CR_DT)
   SELECT TH_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, NEW_RJV_REV_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, NEW_RJV_REV_DOC_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, P_PHS_KEY_NO,
          'REVERSAL OF ' || NEW_RJV_ORGL_TRAN_CODE || ' ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_NO) || ' DATED ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_DT,'DD/MM/YY') || ' ' || NEW_RJV_REV_DESC,
          TH_ANNOTATION,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_CUR_TRANS_HEADER
   WHERE  TH_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TH_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TH_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TH_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   INSERT INTO FT_CUR_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT TD_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          DECODE(TD_DOC_DRCR_FLAG,'D','C','D'), TD_FC_AMT, TD_DOC_REF,
          NEW_RJV_REV_DOC_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_CUR_TRANS_DETAIL
   WHERE  TD_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TD_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TD_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TD_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   F_CHK_DRCR_SUM(NEW_RJV_COMP_CODE, P_ACNT_YEAR,
                  NEW_RJV_REV_TRAN_CODE, NEW_RJV_REV_DOC_NO);
Press <Enter> to continue...
   ELSE
/* If original is from prev and the reversed is from current accounting year */
   INSERT INTO FT_CUR_TRANS_HEADER (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE,
          TH_DOC_NO, TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION,
          TH_CR_UID, TH_CR_DT)
   SELECT TH_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, NEW_RJV_REV_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, NEW_RJV_REV_DOC_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, P_PHS_KEY_NO,
          'REVERSAL OF ' || NEW_RJV_ORGL_TRAN_CODE || ' ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_NO) || ' DATED ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_DT,'DD/MM/YY') || ' ' || NEW_RJV_REV_DESC,
          TH_ANNOTATION,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_PRV_TRANS_HEADER
   WHERE  TH_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TH_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TH_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TH_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   INSERT INTO FT_CUR_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT TD_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          DECODE(TD_DOC_DRCR_FLAG,'D','C','D'), TD_FC_AMT, TD_DOC_REF,
          NEW_RJV_REV_DOC_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_PRV_TRANS_DETAIL
   WHERE  TD_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TD_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TD_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TD_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   F_CHK_DRCR_SUM(NEW_RJV_COMP_CODE, P_ACNT_YEAR,
                  NEW_RJV_REV_TRAN_CODE, NEW_RJV_REV_DOC_NO);
   END IF;
ELSE
   IF NEW_RJV_ORGL_ACNT_YEAR = P_CUR_ACNT_YEAR THEN
/* If original is from curr and the reversed is from prev accounting year */
   INSERT INTO FT_PRV_TRANS_HEADER (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE,
          TH_DOC_NO, TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION,
          TH_CR_UID, TH_CR_DT)
   SELECT TH_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, NEW_RJV_REV_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, NEW_RJV_REV_DOC_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL,
          'REVERSAL OF ' || NEW_RJV_ORGL_TRAN_CODE || ' ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_NO) || ' DATED ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_DT,'DD/MM/YY') || ' ' || NEW_RJV_REV_DESC,
          TH_ANNOTATION,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_CUR_TRANS_HEADER
   WHERE  TH_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TH_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TH_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TH_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   INSERT INTO FT_PRV_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT TD_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          DECODE(TD_DOC_DRCR_FLAG,'D','C','D'), TD_FC_AMT, TD_DOC_REF,
          NEW_RJV_REV_DOC_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_CUR_TRANS_DETAIL
   WHERE  TD_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TD_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TD_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TD_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   F_CHK_DRCR_SUM(NEW_RJV_COMP_CODE, P_ACNT_YEAR,
                  NEW_RJV_REV_TRAN_CODE, NEW_RJV_REV_DOC_NO);
   ELSE
/* If original is from prev and the reversed is from prev accounting year */
   INSERT INTO FT_PRV_TRANS_HEADER (TH_COMP_CODE, TH_ACNT_YEAR, TH_TRAN_CODE,
          TH_DOC_NO, TH_DOC_DT, TH_DOC_CAL_YEAR, TH_DOC_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, TH_DOC_DUE_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL, TH_DESC, TH_ANNOTATION,
          TH_CR_UID, TH_CR_DT)
   SELECT TH_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, NEW_RJV_REV_DOC_DT, P_CAL_YEAR, P_CAL_MONTH,
          TH_DOC_REF, TH_DOC_REF_DT, NEW_RJV_REV_DOC_DT, TH_DIVN_CODE,
          TH_DEPT_CODE, TH_CTL_TOTAL,
          'REVERSAL OF ' || NEW_RJV_ORGL_TRAN_CODE || ' ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_NO) || ' DATED ' ||
          TO_CHAR(NEW_RJV_ORGL_DOC_DT,'DD/MM/YY') || ' ' || NEW_RJV_REV_DESC,
          TH_ANNOTATION,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_PRV_TRANS_HEADER
   WHERE  TH_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TH_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TH_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TH_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   INSERT INTO FT_PRV_TRANS_DETAIL (TD_COMP_CODE, TD_ACNT_YEAR, TD_TRAN_CODE,
          TD_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          TD_DOC_DRCR_FLAG, TD_FC_AMT, TD_DOC_REF, TD_DOC_DUE_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          TD_CR_UID, TD_CR_DT)
   SELECT TD_COMP_CODE, P_ACNT_YEAR, NEW_RJV_REV_TRAN_CODE,
          NEW_RJV_REV_DOC_NO, TD_SEQ_NO, TD_MAIN_ACNT_CODE, TD_SUB_ACNT_CODE,
          TD_DIVN_CODE, TD_DEPT_CODE, TD_HEAD_NO_1, TD_ANLY_CODE_1,
          TD_HEAD_NO_2, TD_ANLY_CODE_2, TD_CURR_CODE, TD_DOC_AMT,
          DECODE(TD_DOC_DRCR_FLAG,'D','C','D'), TD_FC_AMT, TD_DOC_REF,
          NEW_RJV_REV_DOC_DT, TD_OTH_REF,
          TD_ACTY_VALUE_CODE_1, TD_ACTY_VALUE_CODE_2, TD_DESC,
          TD_DBK_PRINT_FLAG, TD_LED_PRINT_FLAG, TD_MONTH_PRC_FLAG,
          TD_BILL_FC_AMT, TD_BILL_LC_AMT, TD_BILL_STATUS, TD_PYMT_APPR_FLAG,
          NEW_RJV_CR_UID, NEW_RJV_CR_DT
   FROM   FT_PRV_TRANS_DETAIL
   WHERE  TD_COMP_CODE = NEW_RJV_COMP_CODE
   AND    TD_ACNT_YEAR = NEW_RJV_ORGL_ACNT_YEAR
   AND    TD_TRAN_CODE = NEW_RJV_ORGL_TRAN_CODE
   AND    TD_DOC_NO    = NEW_RJV_ORGL_DOC_NO;
   F_CHK_DRCR_SUM(NEW_RJV_COMP_CODE, P_ACNT_YEAR,
                  NEW_RJV_REV_TRAN_CODE, NEW_RJV_REV_DOC_NO);
   END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_UNPOSTED_OS (
 OLD_OST_KEY_NO            IN      NUMBER,
 OLD_OST_COMP_CODE         IN      VARCHAR2,
 OLD_OST_TRAN_CODE         IN      VARCHAR2,
 OLD_OST_DOC_NO            IN      NUMBER,
 OLD_OST_SEQ_NO            IN      NUMBER,
 OLD_OST_ACNT_YEAR         IN      NUMBER,
 OLD_OST_DOC_DT            IN      DATE,
 OLD_OST_DOC_CAL_YEAR      IN      NUMBER,
 OLD_OST_DOC_CAL_MONTH     IN      NUMBER,
 OLD_OST_DUE_DT            IN      DATE,
 OLD_OST_MAIN_ACNT_CODE    IN      VARCHAR2,
 OLD_OST_SUB_ACNT_CODE     IN      VARCHAR2,
 OLD_OST_DIVN_CODE         IN      VARCHAR2,
 OLD_OST_DEPT_CODE         IN      VARCHAR2,
 OLD_OST_HEAD_NO_1         IN      NUMBER,
 OLD_OST_ANLY_CODE_1       IN      VARCHAR2,
 OLD_OST_HEAD_NO_2         IN      NUMBER,
 OLD_OST_ANLY_CODE_2       IN      VARCHAR2,
 OLD_OST_ACTY_CODE_1       IN      VARCHAR2,
 OLD_OST_ACTY_CODE_2       IN      VARCHAR2,
 OLD_OST_CURR_CODE         IN      VARCHAR2,
 OLD_OST_LC_AMT            IN      NUMBER,
 OLD_OST_FC_AMT            IN      NUMBER,
 OLD_OST_DRCR_FLAG         IN      VARCHAR2,
 OLD_OST_DOC_REF           IN      VARCHAR2,
 OLD_OST_DOC_REF_DT        IN      DATE,
 OLD_OST_OTH_REF           IN      VARCHAR2,
 OLD_OST_LC_ADJ_AMT        IN      NUMBER,
 OLD_OST_FC_ADJ_AMT        IN      NUMBER,
 OLD_OST_LC_PDC_AMT        IN      NUMBER,
 OLD_OST_FC_PDC_AMT        IN      NUMBER,
 OLD_OST_LC_UNP_AMT        IN      NUMBER,
 OLD_OST_FC_UNP_AMT        IN      NUMBER,
 OLD_OST_LC_UNDEP_AMT      IN      NUMBER,
 OLD_OST_FC_UNDEP_AMT      IN      NUMBER,
 OLD_OST_LC_ORG_AMT        IN      NUMBER,
 OLD_OST_FC_ORG_AMT        IN      NUMBER,
 OLD_OST_REF_KEY_NO        IN      NUMBER,
 OLD_OST_REF_COMP_CODE     IN      VARCHAR2,
 OLD_OST_REF_ACNT_YEAR     IN      NUMBER,
 OLD_OST_REF_TRAN_CODE     IN      VARCHAR2,
 OLD_OST_REF_SEQ_NO        IN      NUMBER,
 OLD_OST_REF_DOC_NO        IN      NUMBER,
 OLD_OST_REF_DOC_DT        IN      DATE,
 OLD_OST_REF_DOC_CAL_YEAR  IN      NUMBER,
 OLD_OST_REF_DOC_CAL_MONTH IN      NUMBER,
 OLD_OST_REF_DUE_DT        IN      DATE,
 OLD_OST_LAST_MATCH_DT     IN      DATE,
 OLD_OST_TYPE              IN      VARCHAR2,
 OLD_OST_CR_UID            IN      VARCHAR2,
 OLD_OST_CR_DT             IN      DATE,
 NEW_OST_KEY_NO            IN OUT  NUMBER,
 NEW_OST_COMP_CODE         IN OUT  VARCHAR2,
 NEW_OST_TRAN_CODE         IN OUT  VARCHAR2,
 NEW_OST_DOC_NO            IN OUT  NUMBER,
 NEW_OST_SEQ_NO            IN OUT  NUMBER,
 NEW_OST_ACNT_YEAR         IN OUT  NUMBER,
 NEW_OST_DOC_DT            IN OUT  DATE,
 NEW_OST_DOC_CAL_YEAR      IN OUT  NUMBER,
 NEW_OST_DOC_CAL_MONTH     IN OUT  NUMBER,
 NEW_OST_DUE_DT            IN OUT  DATE,
 NEW_OST_MAIN_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_OST_SUB_ACNT_CODE     IN OUT  VARCHAR2,
 NEW_OST_DIVN_CODE         IN OUT  VARCHAR2,
 NEW_OST_DEPT_CODE         IN OUT  VARCHAR2,
 NEW_OST_HEAD_NO_1         IN OUT  NUMBER,
 NEW_OST_ANLY_CODE_1       IN OUT  VARCHAR2,
 NEW_OST_HEAD_NO_2         IN OUT  NUMBER,
 NEW_OST_ANLY_CODE_2       IN OUT  VARCHAR2,
 NEW_OST_ACTY_CODE_1       IN OUT  VARCHAR2,
 NEW_OST_ACTY_CODE_2       IN OUT  VARCHAR2,
 NEW_OST_CURR_CODE         IN OUT  VARCHAR2,
 NEW_OST_LC_AMT            IN OUT  NUMBER,
 NEW_OST_FC_AMT            IN OUT  NUMBER,
 NEW_OST_DRCR_FLAG         IN OUT  VARCHAR2,
 NEW_OST_DOC_REF           IN OUT  VARCHAR2,
 NEW_OST_DOC_REF_DT        IN OUT  DATE,
 NEW_OST_OTH_REF           IN OUT  VARCHAR2,
 NEW_OST_LC_ADJ_AMT        IN OUT  NUMBER,
 NEW_OST_FC_ADJ_AMT        IN OUT  NUMBER,
 NEW_OST_LC_PDC_AMT        IN OUT  NUMBER,
 NEW_OST_FC_PDC_AMT        IN OUT  NUMBER,
 NEW_OST_LC_UNP_AMT        IN OUT  NUMBER,
 NEW_OST_FC_UNP_AMT        IN OUT  NUMBER,
 NEW_OST_LC_UNDEP_AMT      IN OUT  NUMBER,
 NEW_OST_FC_UNDEP_AMT      IN OUT  NUMBER,
 NEW_OST_LC_ORG_AMT        IN OUT  NUMBER,
 NEW_OST_FC_ORG_AMT        IN OUT  NUMBER,
 NEW_OST_REF_KEY_NO        IN OUT  NUMBER,
 NEW_OST_REF_COMP_CODE     IN OUT  VARCHAR2,
 NEW_OST_REF_ACNT_YEAR     IN OUT  NUMBER,
 NEW_OST_REF_TRAN_CODE     IN OUT  VARCHAR2,
 NEW_OST_REF_SEQ_NO        IN OUT  NUMBER,
 NEW_OST_REF_DOC_NO        IN OUT  NUMBER,
 NEW_OST_REF_DOC_DT        IN OUT  DATE,
 NEW_OST_REF_DOC_CAL_YEAR  IN OUT  NUMBER,
 NEW_OST_REF_DOC_CAL_MONTH IN OUT  NUMBER,
 NEW_OST_REF_DUE_DT        IN OUT  DATE,
 NEW_OST_LAST_MATCH_DT     IN OUT  DATE,
 NEW_OST_TYPE              IN OUT  VARCHAR2,
 NEW_OST_CR_UID            IN OUT  VARCHAR2,
 NEW_OST_CR_DT             IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_ACNT_YEAR         NUMBER(2);
P_TRAN_CODE         VARCHAR2(3);
P_DOC_NO            NUMBER(6);
P_SEQ_NO            NUMBER(3);
P_MAIN_ACNT_CODE    VARCHAR2(6);
P_SUB_ACNT_CODE     VARCHAR2(6);
P_CUR_ACNT_YEAR     NUMBER(2);
P_COPY_DIVN_REF     VARCHAR2(1);
P_COPY_DEPT_REF     VARCHAR2(1);
P_COPY_ANLY_REF_1   VARCHAR2(1);
P_COPY_ANLY_REF_2   VARCHAR2(1);
P_OST_DIVN_CODE     VARCHAR2(6);
P_OST_DEPT_CODE     VARCHAR2(6);
P_OST_ANLY_CODE_1   VARCHAR2(6);
P_OST_ANLY_CODE_2   VARCHAR2(6);
P_OST_CURR_CODE     VARCHAR2(3);
P_PREV_OST_LC_AMT   NUMBER(14,3);
P_PREV_OST_FC_AMT   NUMBER(14,3);
P_DBTI_KEY_FIELD    VARCHAR2(30);
P_DUMMY             VARCHAR2(1);
P_OST_REF_COMP_CODE       VARCHAR2(3);
P_OST_REF_ACNT_YEAR       NUMBER(2);
P_OST_REF_TRAN_CODE       VARCHAR2(3);
P_OST_REF_SEQ_NO          NUMBER(3);
P_OST_REF_DOC_NO          NUMBER(6);
P_OST_REF_DOC_DT          DATE;
P_OST_REF_DOC_CAL_YEAR    NUMBER(2);
P_OST_REF_DOC_CAL_MONTH   NUMBER(2);
P_OST_REF_DUE_DT          DATE;
P_OST_LC_AMT              NUMBER(14,3);
P_OST_FC_AMT              NUMBER(14,3);
P_OST_LC_ORG_AMT          NUMBER(14,3);
P_OST_FC_ORG_AMT          NUMBER(14,3);
CURSOR SEL_CPREF IS
SELECT NVL(SUBSTR(PARA_VALUE,1,1),'N'), NVL(SUBSTR(PARA_VALUE,2,1),'N'),
       NVL(SUBSTR(PARA_VALUE,3,1),'N'), NVL(SUBSTR(PARA_VALUE,4,1),'N')
FROM   FP_PARAMETER
WHERE  PARA_ID = 'COPY.OS.REF';
CURSOR SEL_TD_INFO IS
SELECT 'X'
FROM   FP_DBTRG_INTERFACE
WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
CURSOR SEL_TD IS
SELECT 'X'
FROM   FT_UNPOSTED_TRANS_DETAIL
WHERE  (TD_COMP_CODE = P_COMP_CODE)
AND    (TD_TRAN_CODE = P_TRAN_CODE)
AND    (TD_DOC_NO    = P_DOC_NO)
AND    (TD_ACNT_YEAR = P_ACNT_YEAR)
AND    (TD_SEQ_NO = P_SEQ_NO)
AND    (TD_MAIN_ACNT_CODE = P_MAIN_ACNT_CODE)
AND    (TD_SUB_ACNT_CODE = P_SUB_ACNT_CODE);
CURSOR SEL_OS IS
  SELECT OST_DIVN_CODE, OST_DEPT_CODE,
         OST_ANLY_CODE_1, OST_ANLY_CODE_2,
         OST_COMP_CODE, OST_ACNT_YEAR,
         OST_TRAN_CODE, OST_SEQ_NO,
         OST_DOC_NO, OST_DOC_DT,
         OST_DOC_CAL_YEAR, OST_DOC_CAL_MONTH,
         OST_DUE_DT, OST_CURR_CODE,
         OST_LC_AMT, OST_FC_AMT,
         OST_LC_ORG_AMT, OST_FC_ORG_AMT
  FROM   FT_OS
  WHERE  OST_KEY_NO = NEW_OST_REF_KEY_NO
  AND    NVL(OST_TYPE,'P') = 'P'
  FOR UPDATE OF OST_FC_UNP_AMT, OST_LC_UNP_AMT,
                OST_LAST_MATCH_DT;
BEGIN
DBMS_OUTPUT.PUT_LINE('5' || TRG_MODE) ;
IF SEL_CPREF%ISOPEN THEN
    CLOSE SEL_CPREF;
END IF;
OPEN SEL_CPREF;
FETCH SEL_CPREF INTO P_COPY_DIVN_REF, P_COPY_DEPT_REF,
                       P_COPY_ANLY_REF_1, P_COPY_ANLY_REF_2;
IF SEL_CPREF%NOTFOUND THEN
     P_COPY_DIVN_REF   := 'N';
     P_COPY_DEPT_REF   := 'N';
     P_COPY_ANLY_REF_1 := 'N';
     P_COPY_ANLY_REF_2 := 'N';
END IF;
CLOSE SEL_CPREF;
IF TRG_MODE = 'U' THEN
    IF OLD_OST_COMP_CODE != NEW_OST_COMP_CODE OR
       OLD_OST_TRAN_CODE != NEW_OST_TRAN_CODE OR
       OLD_OST_DOC_NO != NEW_OST_DOC_NO OR
       OLD_OST_SEQ_NO != NEW_OST_SEQ_NO OR
       OLD_OST_MAIN_ACNT_CODE != NEW_OST_MAIN_ACNT_CODE OR
       OLD_OST_SUB_ACNT_CODE != NEW_OST_SUB_ACNT_CODE  OR
       NVL(OLD_OST_REF_KEY_NO,0) != NVL(NEW_OST_REF_KEY_NO,0) OR
       NVL(OLD_OST_TYPE,'X') != NVL(NEW_OST_TYPE,'X') THEN
       RAISE_APPLICATION_ERROR(-20024,'Significant OS fields changed');
    END IF;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
     IF NVL(NEW_OST_TYPE,'R') != 'R' THEN
            RAISE_APPLICATION_ERROR(-20025,'Invalid Document Type');
     END IF;
     P_COMP_CODE      := NEW_OST_COMP_CODE;
     P_TRAN_CODE      := NEW_OST_TRAN_CODE;
     P_DOC_NO         := NEW_OST_DOC_NO;
     P_SEQ_NO         := NEW_OST_SEQ_NO;
     P_ACNT_YEAR      := NEW_OST_ACNT_YEAR;
     P_MAIN_ACNT_CODE := NEW_OST_MAIN_ACNT_CODE;
     P_SUB_ACNT_CODE  := NEW_OST_SUB_ACNT_CODE;
     P_DBTI_KEY_FIELD := P_COMP_CODE ||
                         TO_CHAR(P_ACNT_YEAR) ||
                         P_TRAN_CODE ||
                         TO_CHAR(P_DOC_NO);
     IF SEL_TD_INFO%ISOPEN THEN
         CLOSE SEL_TD_INFO;
     END IF;
     OPEN SEL_TD_INFO;
     FETCH SEL_TD_INFO INTO P_DUMMY;
     IF SEL_TD_INFO%NOTFOUND THEN
          IF SEL_TD%ISOPEN THEN
              CLOSE SEL_TD;
          END IF;
          OPEN SEL_TD;
          FETCH SEL_TD INTO P_DUMMY;
          IF SEL_TD%NOTFOUND THEN
               RAISE_APPLICATION_ERROR(-20026,'Transaction detail not found');
          END IF;
          CLOSE SEL_TD;
     END IF;
     CLOSE SEL_TD_INFO;
     IF NEW_OST_REF_KEY_NO IS NOT NULL THEN
          IF NEW_OST_TYPE IS NULL THEN
               RAISE_APPLICATION_ERROR
                         (-20027,'Doc Type and Ref Key no. inconsistent');
          END IF;
          IF NEW_OST_TYPE = 'P' THEN
               RAISE_APPLICATION_ERROR(-20028,'Cannot insert Parent entry');
          END IF;
          IF TRG_MODE = 'I' THEN
               P_PREV_OST_LC_AMT := 0;
               P_PREV_OST_FC_AMT := 0;
          ELSE
               P_PREV_OST_LC_AMT := OLD_OST_LC_AMT;
               P_PREV_OST_FC_AMT := OLD_OST_FC_AMT;
          END IF;
          IF SEL_OS%ISOPEN THEN
               CLOSE SEL_OS;
          END IF;
          OPEN SEL_OS;
          FETCH SEL_OS INTO P_OST_DIVN_CODE, P_OST_DEPT_CODE,
                       P_OST_ANLY_CODE_1, P_OST_ANLY_CODE_2,
                       P_OST_REF_COMP_CODE, P_OST_REF_ACNT_YEAR,
                       P_OST_REF_TRAN_CODE, P_OST_REF_SEQ_NO,
                       P_OST_REF_DOC_NO, P_OST_REF_DOC_DT,
                       P_OST_REF_DOC_CAL_YEAR, P_OST_REF_DOC_CAL_MONTH,
                       P_OST_REF_DUE_DT, P_OST_CURR_CODE,
                       P_OST_LC_AMT, P_OST_FC_AMT,
                       P_OST_LC_ORG_AMT, P_OST_FC_ORG_AMT;
          IF SEL_OS%NOTFOUND THEN
               RAISE_APPLICATION_ERROR(-20029,'Invalid OS Reference');
          END IF;
          IF NVL(P_OST_CURR_CODE,'XXXX') !=
             NVL(NEW_OST_CURR_CODE,'XXXX') THEN
               CLOSE SEL_OS;
               RAISE_APPLICATION_ERROR(-20030,'Currrency mismatch ');
          END IF;
          IF NVL(P_OST_LC_AMT,0) != NVL(P_OST_LC_ORG_AMT,0) OR
             NVL(P_OST_FC_AMT,0) != NVL(P_OST_FC_ORG_AMT,0) THEN
               CLOSE SEL_OS;
               RAISE_APPLICATION_ERROR
                    (-20031,'Doesnot qualify as parent entry ');
          END IF;
          UPDATE FT_OS
          SET    OST_LC_UNP_AMT     = NVL(OST_LC_UNP_AMT,0) +
                                      NVL(NEW_OST_LC_AMT,0) -
                                      NVL(P_PREV_OST_LC_AMT,0),
                 OST_FC_UNP_AMT     = NVL(OST_FC_UNP_AMT,0) +
                                      NVL(NEW_OST_FC_AMT,0) -
                                      NVL(P_PREV_OST_FC_AMT,0),
                 OST_LAST_MATCH_DT  =
                    GREATEST(NVL(OST_LAST_MATCH_DT,TO_DATE('01-JAN-90')),
                             NEW_OST_DOC_DT)
          WHERE  CURRENT OF SEL_OS;
          CLOSE SEL_OS;
          /* Make sure all reference information is consistent with key */
          NEW_OST_REF_COMP_CODE     := P_OST_REF_COMP_CODE;
          NEW_OST_REF_ACNT_YEAR     := P_OST_REF_ACNT_YEAR;
          NEW_OST_REF_TRAN_CODE     := P_OST_REF_TRAN_CODE;
          NEW_OST_REF_SEQ_NO        := P_OST_REF_SEQ_NO;
          NEW_OST_REF_DOC_NO        := P_OST_REF_DOC_NO;
          NEW_OST_REF_DOC_DT        := P_OST_REF_DOC_DT;
          NEW_OST_REF_DOC_CAL_YEAR  := P_OST_REF_DOC_CAL_YEAR;
          NEW_OST_REF_DOC_CAL_MONTH := P_OST_REF_DOC_CAL_MONTH;
          NEW_OST_REF_DUE_DT        := P_OST_REF_DUE_DT;
          /* Set Allocations of the current entry in line with the
             referenced entry, if so parameterised by the user */
          IF P_COPY_DIVN_REF = 'Y' THEN
               NEW_OST_DIVN_CODE := P_OST_DIVN_CODE;
          END IF;
          IF P_COPY_DEPT_REF = 'Y' THEN
               NEW_OST_DEPT_CODE := P_OST_DEPT_CODE;
          END IF;
          IF P_COPY_ANLY_REF_1 = 'Y' THEN
               NEW_OST_ANLY_CODE_1 := P_OST_ANLY_CODE_1;
          END IF;
          IF P_COPY_ANLY_REF_2 = 'Y' THEN
               NEW_OST_ANLY_CODE_2 := P_OST_ANLY_CODE_2;
          END IF;
     ELSE
          IF NEW_OST_TYPE IS NOT NULL THEN
               RAISE_APPLICATION_ERROR
                         (-20032,'Doc Type and Ref Key no. inconsistent');
          END IF;
          /* Make sure all reference information is null */
          NEW_OST_REF_COMP_CODE       := NULL;
          NEW_OST_REF_ACNT_YEAR       := NULL;
          NEW_OST_REF_TRAN_CODE       := NULL;
          NEW_OST_REF_SEQ_NO          := NULL;
          NEW_OST_REF_DOC_NO          := NULL;
          NEW_OST_REF_DOC_DT          := NULL;
          NEW_OST_REF_DOC_CAL_YEAR    := NULL;
          NEW_OST_REF_DOC_CAL_MONTH   := NULL;
          NEW_OST_REF_DUE_DT          := NULL;
     END IF;
END IF;
IF TRG_MODE = 'D' THEN
     IF OLD_OST_REF_KEY_NO IS NOT NULL THEN
          UPDATE FT_OS
          SET    OST_LC_UNP_AMT     = NVL(OST_LC_UNP_AMT,0) -
                                      NVL(OLD_OST_LC_AMT,0),
                 OST_FC_UNP_AMT     = NVL(OST_FC_UNP_AMT,0) -
                                      NVL(OLD_OST_FC_AMT,0)
          WHERE  OST_KEY_NO = OLD_OST_REF_KEY_NO;
     END IF;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_UNPOSTED_TRANS_DETAIL (
 OLD_TD_COMP_CODE               IN      VARCHAR2,
 OLD_TD_ACNT_YEAR               IN      NUMBER,
 OLD_TD_TRAN_CODE               IN      VARCHAR2,
 OLD_TD_DOC_NO                  IN      NUMBER,
 OLD_TD_SEQ_NO                  IN      NUMBER,
 OLD_TD_MAIN_ACNT_CODE          IN      VARCHAR2,
 OLD_TD_SUB_ACNT_CODE           IN      VARCHAR2,
 OLD_TD_DIVN_CODE               IN      VARCHAR2,
 OLD_TD_DEPT_CODE               IN      VARCHAR2,
 OLD_TD_HEAD_NO_1               IN      NUMBER,
 OLD_TD_ANLY_CODE_1             IN      VARCHAR2,
 OLD_TD_HEAD_NO_2               IN      NUMBER,
 OLD_TD_ANLY_CODE_2             IN      VARCHAR2,
 OLD_TD_CURR_CODE               IN      VARCHAR2,
 OLD_TD_DOC_AMT                 IN      NUMBER,
 OLD_TD_DOC_DRCR_FLAG           IN      VARCHAR2,
 OLD_TD_FC_AMT                  IN      NUMBER,
 OLD_TD_DOC_REF                 IN      VARCHAR2,
 OLD_TD_DOC_DUE_DT              IN      DATE,
 OLD_TD_OTH_REF                 IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_1       IN      VARCHAR2,
 OLD_TD_ACTY_VALUE_CODE_2       IN      VARCHAR2,
 OLD_TD_DESC                    IN      VARCHAR2,
 OLD_TD_DBK_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_LED_PRINT_FLAG          IN      VARCHAR2,
 OLD_TD_MONTH_PRC_FLAG          IN      VARCHAR2,
 OLD_TD_BILL_FC_AMT             IN      NUMBER,
 OLD_TD_BILL_LC_AMT             IN      NUMBER,
 OLD_TD_BILL_STATUS             IN      VARCHAR2,
 OLD_TD_PYMT_APPR_FLAG          IN      VARCHAR2,
 OLD_TD_CR_UID                  IN      VARCHAR2,
 OLD_TD_CR_DT                   IN      DATE,
 OLD_TD_PYMT_LAST_APPR_FC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_LC_AMT   IN      NUMBER,
 OLD_TD_PYMT_LAST_APPR_BANK     IN      VARCHAR2,
 NEW_TD_COMP_CODE               IN OUT  VARCHAR2,
 NEW_TD_ACNT_YEAR               IN OUT  NUMBER,
 NEW_TD_TRAN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_NO                  IN OUT  NUMBER,
 NEW_TD_SEQ_NO                  IN OUT  NUMBER,
 NEW_TD_MAIN_ACNT_CODE          IN OUT  VARCHAR2,
 NEW_TD_SUB_ACNT_CODE           IN OUT  VARCHAR2,
 NEW_TD_DIVN_CODE               IN OUT  VARCHAR2,
 NEW_TD_DEPT_CODE               IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_1               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_1             IN OUT  VARCHAR2,
 NEW_TD_HEAD_NO_2               IN OUT  NUMBER,
 NEW_TD_ANLY_CODE_2             IN OUT  VARCHAR2,
 NEW_TD_CURR_CODE               IN OUT  VARCHAR2,
 NEW_TD_DOC_AMT                 IN OUT  NUMBER,
 NEW_TD_DOC_DRCR_FLAG           IN OUT  VARCHAR2,
 NEW_TD_FC_AMT                  IN OUT  NUMBER,
 NEW_TD_DOC_REF                 IN OUT  VARCHAR2,
 NEW_TD_DOC_DUE_DT              IN OUT  DATE,
 NEW_TD_OTH_REF                 IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_1       IN OUT  VARCHAR2,
 NEW_TD_ACTY_VALUE_CODE_2       IN OUT  VARCHAR2,
 NEW_TD_DESC                    IN OUT  VARCHAR2,
 NEW_TD_DBK_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_LED_PRINT_FLAG          IN OUT  VARCHAR2,
 NEW_TD_MONTH_PRC_FLAG          IN OUT  VARCHAR2,
 NEW_TD_BILL_FC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_LC_AMT             IN OUT  NUMBER,
 NEW_TD_BILL_STATUS             IN OUT  VARCHAR2,
 NEW_TD_PYMT_APPR_FLAG          IN OUT  VARCHAR2,
 NEW_TD_CR_UID                  IN OUT  VARCHAR2,
 NEW_TD_CR_DT                   IN OUT  DATE,
 NEW_TD_PYMT_LAST_APPR_FC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_LC_AMT   IN OUT  NUMBER,
 NEW_TD_PYMT_LAST_APPR_BANK     IN OUT  VARCHAR2,
 TRG_MODE                       IN OUT  VARCHAR2,
 TRG_ERR_NO                     OUT  NUMBER,
 TRG_ERR_MSG                    OUT  VARCHAR2) AS
P_COMP_CODE         VARCHAR2(3);
P_ACNT_YEAR         NUMBER(2);
P_TRAN_CODE         VARCHAR2(3);
P_DOC_NO            NUMBER(6);
P_CUR_ACNT_YEAR     NUMBER(2);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_DOC_DT            DATE;
P_DOC_DUE_DT        DATE;
P_DOC_REF_DT        DATE;
P_TD_MAIN_ACNT_CODE VARCHAR2(6);
P_OPEN_ENTRY_FLAG   VARCHAR2(1);
P_DBTI_KEY_FIELD    VARCHAR2(30);
P_ERR_NO            NUMBER(6);
CURSOR SEL_HEAD IS
       SELECT TH_DOC_DT, TH_DOC_CAL_MONTH, TH_DOC_CAL_YEAR, TH_DOC_DUE_DT,
              TH_DOC_REF_DT
       FROM   FT_UNPOSTED_TRANS_HEADER
       WHERE  TH_COMP_CODE = P_COMP_CODE
       AND    TH_ACNT_YEAR = P_ACNT_YEAR
       AND    TH_TRAN_CODE = P_TRAN_CODE
       AND    TH_DOC_NO    = P_DOC_NO;
CURSOR SEL_HEAD_INFO IS
       SELECT TO_DATE(DBTI_VALUE_1), TO_NUMBER(DBTI_VALUE_2),
              TO_NUMBER(DBTI_VALUE_3), TO_DATE(DBTI_VALUE_4),
              TO_DATE(DBTI_VALUE_5)
       FROM   FP_DBTRG_INTERFACE
       WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
CURSOR SEL_MAIN IS
       SELECT MAIN_OPEN_ENTRY_FLAG
       FROM   FM_MAIN_ACCOUNT
       WHERE  MAIN_ACNT_CODE = P_TD_MAIN_ACNT_CODE;
/* Declare Local procedures for repetitive use within the trigger */
PROCEDURE VALIDATE_CODE_COMBN IS
P_KEY    NUMBER(8);
BEGIN
F_VAL_COMB (NEW_TD_COMP_CODE, NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
            NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
            NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2, P_ERR_NO, P_KEY);
IF P_ERR_NO != 0 THEN
     RAISE_APPLICATION_ERROR(-20009, 'Invalid Code combination');
END IF;
END;
PROCEDURE INSERT_UNPOSTED_OS IS
P_OST_KEY_NO     NUMBER(8);
BEGIN
   P_TD_MAIN_ACNT_CODE := NEW_TD_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
           F_OS(P_OST_KEY_NO);
           INSERT INTO FT_UNPOSTED_OS
               (OST_KEY_NO, OST_COMP_CODE, OST_TRAN_CODE, OST_DOC_NO,
                OST_SEQ_NO, OST_ACNT_YEAR, OST_DOC_DT, OST_DOC_CAL_YEAR,
                OST_DOC_CAL_MONTH, OST_DUE_DT, OST_MAIN_ACNT_CODE,
                OST_SUB_ACNT_CODE, OST_DIVN_CODE, OST_DEPT_CODE,
                OST_HEAD_NO_1, OST_ANLY_CODE_1, OST_HEAD_NO_2,
                OST_ANLY_CODE_2, OST_ACTY_CODE_1, OST_ACTY_CODE_2,
                OST_CURR_CODE, OST_LC_AMT, OST_FC_AMT, OST_DRCR_FLAG,
                OST_DOC_REF, OST_DOC_REF_DT, OST_OTH_REF,
                OST_LC_ORG_AMT, OST_FC_ORG_AMT, OST_TYPE,
                OST_CR_UID, OST_CR_DT)
           VALUES
               (P_OST_KEY_NO, NEW_TD_COMP_CODE, NEW_TD_TRAN_CODE,
                NEW_TD_DOC_NO, NEW_TD_SEQ_NO, NEW_TD_ACNT_YEAR,
                P_DOC_DT, P_CAL_YEAR, P_CAL_MONTH, NEW_TD_DOC_DUE_DT,
                NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE, NEW_TD_HEAD_NO_1,
                NEW_TD_ANLY_CODE_1, NEW_TD_HEAD_NO_2, NEW_TD_ANLY_CODE_2,
                NEW_TD_ACTY_VALUE_CODE_1, NEW_TD_ACTY_VALUE_CODE_2,
                NEW_TD_CURR_CODE, NEW_TD_DOC_AMT, NEW_TD_FC_AMT,
                NEW_TD_DOC_DRCR_FLAG, NEW_TD_DOC_REF, P_DOC_REF_DT,
                NEW_TD_OTH_REF, NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NULL,
                NEW_TD_CR_UID, NEW_TD_CR_DT);
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE DELETE_UNPOSTED_OS IS
BEGIN
   P_TD_MAIN_ACNT_CODE := OLD_TD_MAIN_ACNT_CODE;
   IF SEL_MAIN%ISOPEN THEN
        CLOSE SEL_MAIN;
   END IF;
   OPEN SEL_MAIN;
   FETCH SEL_MAIN INTO P_OPEN_ENTRY_FLAG;
   IF SEL_MAIN%FOUND THEN
        IF P_OPEN_ENTRY_FLAG = 'Y' THEN
             DELETE FROM FT_UNPOSTED_OS
             WHERE  OST_COMP_CODE = OLD_TD_COMP_CODE
             AND    OST_ACNT_YEAR = OLD_TD_ACNT_YEAR
             AND    OST_TRAN_CODE = OLD_TD_TRAN_CODE
             AND    OST_DOC_NO    = OLD_TD_DOC_NO
             AND    OST_SEQ_NO    = OLD_TD_SEQ_NO;
        END IF;
   END IF;
   CLOSE SEL_MAIN;
END;
PROCEDURE UPDATE_UNPOSTED_OS_CODES IS
BEGIN
     UPDATE FT_UNPOSTED_OS
     SET    OST_DIVN_CODE   = NEW_TD_DIVN_CODE,
            OST_DEPT_CODE   = NEW_TD_DEPT_CODE,
            OST_ANLY_CODE_1 = NEW_TD_ANLY_CODE_1,
            OST_ANLY_CODE_2 = NEW_TD_ANLY_CODE_2,
            OST_ACTY_CODE_1 = NEW_TD_ACTY_VALUE_CODE_1,
            OST_ACTY_CODE_2 = NEW_TD_ACTY_VALUE_CODE_2,
            OST_DOC_REF     = NEW_TD_DOC_REF,
            OST_OTH_REF     = NEW_TD_OTH_REF,
            OST_DUE_DT      = NEW_TD_DOC_DUE_DT
     WHERE  (OST_COMP_CODE = OLD_TD_COMP_CODE)
     AND    (OST_ACNT_YEAR = OLD_TD_ACNT_YEAR)
     AND    (OST_TRAN_CODE = OLD_TD_TRAN_CODE)
     AND    (OST_DOC_NO    = OLD_TD_DOC_NO)
     AND    (OST_SEQ_NO    = OLD_TD_SEQ_NO);
END;
PROCEDURE UPDATE_UNPOSTED_OS_AMT IS
P_UNMAT_OST_KEY_NO     NUMBER(8);
P_UNMAT_OST_LC_AMT     NUMBER(14,3);
P_UNMAT_OST_FC_AMT     NUMBER(14,3);
P_DIFF_LC_AMT          NUMBER(14,3);
P_DIFF_FC_AMT          NUMBER(14,3);
CURSOR SEL_OS IS
       SELECT OST_KEY_NO, OST_LC_AMT, OST_FC_AMT
       FROM   FT_UNPOSTED_OS
       WHERE  (OST_COMP_CODE = OLD_TD_COMP_CODE)
       AND    (OST_ACNT_YEAR = OLD_TD_ACNT_YEAR)
       AND    (OST_TRAN_CODE = OLD_TD_TRAN_CODE)
       AND    (OST_DOC_NO    = OLD_TD_DOC_NO)
       AND    (OST_SEQ_NO    = OLD_TD_SEQ_NO)
       AND    (OST_TYPE IS NULL);
BEGIN
     P_DIFF_LC_AMT := NVL(NEW_TD_DOC_AMT,0) - NVL(OLD_TD_DOC_AMT,0);
     P_DIFF_FC_AMT := NVL(NEW_TD_FC_AMT,0) - NVL(OLD_TD_FC_AMT,0);
     IF SEL_OS%ISOPEN THEN
        CLOSE SEL_OS;
     END IF;
     OPEN SEL_OS;
     FETCH SEL_OS INTO P_UNMAT_OST_KEY_NO,
                       P_UNMAT_OST_LC_AMT, P_UNMAT_OST_FC_AMT;
     IF SEL_OS%NOTFOUND THEN
          DELETE_UNPOSTED_OS;
          INSERT_UNPOSTED_OS;
     ELSE
          IF (NVL(P_UNMAT_OST_LC_AMT,0) + NVL(P_DIFF_LC_AMT,0) >= 0) AND
             (NVL(P_UNMAT_OST_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) >= 0) THEN
             IF (NVL(P_UNMAT_OST_LC_AMT,0) + NVL(P_DIFF_LC_AMT,0) = 0) AND
                (NVL(P_UNMAT_OST_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) = 0) THEN
                 DELETE FROM FT_UNPOSTED_OS
                 WHERE  OST_KEY_NO = P_UNMAT_OST_KEY_NO
                 AND    NVL(OST_LC_AMT,0) + NVL(P_DIFF_LC_AMT,0) = 0
                 AND    NVL(OST_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0) = 0;
             ELSE
                 UPDATE FT_UNPOSTED_OS
                 SET    OST_LC_AMT = NVL(OST_LC_AMT,0) + NVL(P_DIFF_LC_AMT,0),
                        OST_FC_AMT = NVL(OST_FC_AMT,0) + NVL(P_DIFF_FC_AMT,0)
                 WHERE  OST_KEY_NO = P_UNMAT_OST_KEY_NO;
             END IF;
             UPDATE FT_UNPOSTED_OS
             SET    OST_LC_ORG_AMT = NEW_TD_DOC_AMT,
                    OST_FC_ORG_AMT = NEW_TD_FC_AMT
             WHERE  (OST_COMP_CODE = OLD_TD_COMP_CODE)
             AND    (OST_ACNT_YEAR = OLD_TD_ACNT_YEAR)
             AND    (OST_TRAN_CODE = OLD_TD_TRAN_CODE)
             AND    (OST_DOC_NO    = OLD_TD_DOC_NO)
             AND    (OST_SEQ_NO    = OLD_TD_SEQ_NO);
          ELSE
             DELETE_UNPOSTED_OS;
             INSERT_UNPOSTED_OS;
          END IF;
     END IF;
     CLOSE SEL_OS;
END;
PROCEDURE REDUCE_ACNT_BAL IS
BEGIN
   F_UPD_ACNT_BAL (OLD_TD_COMP_CODE, P_ACNT_YEAR,
                   OLD_TD_MAIN_ACNT_CODE, OLD_TD_SUB_ACNT_CODE,
                   OLD_TD_DIVN_CODE, OLD_TD_DEPT_CODE,
                   OLD_TD_ANLY_CODE_1, OLD_TD_ANLY_CODE_2,
                   P_CAL_YEAR, P_CAL_MONTH, OLD_TD_CURR_CODE,
                   OLD_TD_DOC_AMT, OLD_TD_FC_AMT, OLD_TD_DOC_DRCR_FLAG,
                   'U', 'S', OLD_TD_CR_UID, P_ERR_NO);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Error at balance updation');
   END IF;
END;
PROCEDURE INCREASE_ACNT_BAL IS
BEGIN
   F_UPD_ACNT_BAL (NEW_TD_COMP_CODE, P_ACNT_YEAR,
                   NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                   NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
                   NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2,
                   P_CAL_YEAR, P_CAL_MONTH, NEW_TD_CURR_CODE,
                   NEW_TD_DOC_AMT, NEW_TD_FC_AMT, NEW_TD_DOC_DRCR_FLAG,
                   'U', 'A', NEW_TD_CR_UID, P_ERR_NO);
   IF P_ERR_NO != 0 THEN
      RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Error at balance updation');
   END IF;
END;
PROCEDURE UPDATE_ACNT_BAL IS
P_DIFF_LC_AMT        NUMBER(14,3);
P_DIFF_FC_AMT        NUMBER(14,3);
BEGIN
     P_DIFF_LC_AMT := NVL(OLD_TD_DOC_AMT,0) - NVL(NEW_TD_DOC_AMT,0);
     P_DIFF_FC_AMT := NVL(OLD_TD_FC_AMT,0) - NVL(NEW_TD_FC_AMT,0);
     F_UPD_ACNT_BAL (NEW_TD_COMP_CODE, P_ACNT_YEAR,
                     NEW_TD_MAIN_ACNT_CODE, NEW_TD_SUB_ACNT_CODE,
                     NEW_TD_DIVN_CODE, NEW_TD_DEPT_CODE,
                     NEW_TD_ANLY_CODE_1, NEW_TD_ANLY_CODE_2,
                     P_CAL_YEAR, P_CAL_MONTH, NEW_TD_CURR_CODE,
                     P_DIFF_LC_AMT, P_DIFF_FC_AMT, NEW_TD_DOC_DRCR_FLAG,
                     'U', 'S', NEW_TD_CR_UID, P_ERR_NO);
     IF P_ERR_NO != 0 THEN
        RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO,
                  'Error at balance updation');
     END IF;
END;
BEGIN
DBMS_OUTPUT.PUT_LINE('6' || TRG_MODE) ;
/* Main procedure */
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TD_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TD_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'U' THEN
   NEW_TD_ACNT_YEAR := OLD_TD_ACNT_YEAR;
END IF;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_COMP_CODE := NEW_TD_COMP_CODE;
    P_TRAN_CODE := NEW_TD_TRAN_CODE;
    P_ACNT_YEAR := NEW_TD_ACNT_YEAR;
    P_DOC_NO := NEW_TD_DOC_NO;
ELSE
    P_COMP_CODE := OLD_TD_COMP_CODE;
    P_TRAN_CODE := OLD_TD_TRAN_CODE;
    P_ACNT_YEAR := OLD_TD_ACNT_YEAR;
    P_DOC_NO := OLD_TD_DOC_NO;
END IF;
P_DBTI_KEY_FIELD := P_COMP_CODE ||
                    TO_CHAR(P_ACNT_YEAR) ||
                    P_TRAN_CODE ||
                    TO_CHAR(P_DOC_NO);
IF SEL_HEAD_INFO%ISOPEN THEN
    CLOSE SEL_HEAD_INFO;
END IF;
OPEN SEL_HEAD_INFO;
FETCH SEL_HEAD_INFO INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                    P_DOC_DUE_DT, P_DOC_REF_DT;
IF SEL_HEAD_INFO%NOTFOUND THEN
     IF SEL_HEAD%ISOPEN THEN
         CLOSE SEL_HEAD;
     END IF;
     OPEN SEL_HEAD;
     FETCH SEL_HEAD INTO P_DOC_DT, P_CAL_MONTH, P_CAL_YEAR,
                         P_DOC_DUE_DT, P_DOC_REF_DT;
     IF SEL_HEAD%NOTFOUND THEN
          RAISE_APPLICATION_ERROR(-20010,'Header not found');
     END IF;
     CLOSE SEL_HEAD;
ELSE
     /* Used for verification in DB triggers corresponding to
        FT_UNPOSTED_OS and FT_OS tables */
     IF TRG_MODE = 'I' OR TRG_MODE = 'U'  THEN
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(NEW_TD_SEQ_NO),
                 DBTI_VALUE_7 = NEW_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = NEW_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     ELSE
          UPDATE FP_DBTRG_INTERFACE
          SET    DBTI_VALUE_6 = TO_CHAR(OLD_TD_SEQ_NO),
                 DBTI_VALUE_7 = OLD_TD_MAIN_ACNT_CODE,
                 DBTI_VALUE_8 = OLD_TD_SUB_ACNT_CODE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
     END IF;
END IF;
CLOSE SEL_HEAD_INFO;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    IF NEW_TD_DOC_DUE_DT IS NULL THEN
       NEW_TD_DOC_DUE_DT := P_DOC_DUE_DT;
    END IF;
END IF;
IF TRG_MODE = 'I' THEN
   VALIDATE_CODE_COMBN;
   INCREASE_ACNT_BAL;
   INSERT_UNPOSTED_OS;
END IF;
IF TRG_MODE = 'U' THEN
   IF (OLD_TD_COMP_CODE != NEW_TD_COMP_CODE) OR
      (OLD_TD_TRAN_CODE != NEW_TD_TRAN_CODE) OR
      (OLD_TD_DOC_NO != NEW_TD_DOC_NO) OR
      (OLD_TD_SEQ_NO != NEW_TD_SEQ_NO) THEN
      RAISE_APPLICATION_ERROR(-20011, 'Primary key change');
   END IF;
   IF     (OLD_TD_MAIN_ACNT_CODE != NEW_TD_MAIN_ACNT_CODE) OR
          (NVL(OLD_TD_SUB_ACNT_CODE,'000000') !=
           NVL(NEW_TD_SUB_ACNT_CODE,'000000')) OR
          (NVL(OLD_TD_DOC_DRCR_FLAG,'0') !=
           NVL(NEW_TD_DOC_DRCR_FLAG,'0')) OR
          (NVL(OLD_TD_CURR_CODE,'000') !=
           NVL(NEW_TD_CURR_CODE,'000')) THEN
            VALIDATE_CODE_COMBN;
            REDUCE_ACNT_BAL;
            INCREASE_ACNT_BAL;
            DELETE_UNPOSTED_OS;
            INSERT_UNPOSTED_OS;
    ELSE
            IF  (NVL(OLD_TD_DIVN_CODE,'000000') !=
                 NVL(NEW_TD_DIVN_CODE,'000000')) OR
                (NVL(OLD_TD_DEPT_CODE,'000000') !=
                 NVL(NEW_TD_DEPT_CODE,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_1,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_1,'000000')) OR
                (NVL(OLD_TD_ANLY_CODE_2,'000000') !=
                 NVL(NEW_TD_ANLY_CODE_2,'000000')) THEN
                    VALIDATE_CODE_COMBN;
                    REDUCE_ACNT_BAL;
                    INCREASE_ACNT_BAL;
                    UPDATE_UNPOSTED_OS_CODES;
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0)) THEN
                       UPDATE_UNPOSTED_OS_AMT;
                    END IF;
            ELSE
                    IF (NVL(OLD_TD_DOC_DUE_DT,'01-JAN-90') !=
                        NVL(NEW_TD_DOC_DUE_DT,'01-JAN-90')) OR
                       (NVL(OLD_TD_DOC_REF,' ') !=
                        NVL(NEW_TD_DOC_REF,' ')) OR
                       (NVL(OLD_TD_OTH_REF,' ') !=
                        NVL(NEW_TD_OTH_REF,' ')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_1,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_1,'000000')) OR
                       (NVL(OLD_TD_ACTY_VALUE_CODE_2,'000000') !=
                        NVL(NEW_TD_ACTY_VALUE_CODE_2,'000000')) THEN
                           VALIDATE_CODE_COMBN;
                           UPDATE_UNPOSTED_OS_CODES;
                    END IF;
                    IF (NVL(OLD_TD_DOC_AMT,0) != NVL(NEW_TD_DOC_AMT,0)) OR
                       (NVL(OLD_TD_FC_AMT,0) != NVL(NEW_TD_FC_AMT,0)) THEN
                       UPDATE_ACNT_BAL;
                       UPDATE_UNPOSTED_OS_AMT;
                    END IF;
            END IF;
    END IF;
END IF;
IF TRG_MODE = 'D' THEN
   REDUCE_ACNT_BAL;
   DELETE_UNPOSTED_OS;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_FT_UNPOSTED_TRANS_HEADER (
 OLD_TH_COMP_CODE          IN      VARCHAR2,
 OLD_TH_ACNT_YEAR          IN      NUMBER,
 OLD_TH_TRAN_CODE          IN      VARCHAR2,
 OLD_TH_DOC_NO             IN      NUMBER,
 OLD_TH_DOC_DT             IN      DATE,
 OLD_TH_DOC_CAL_YEAR       IN      NUMBER,
 OLD_TH_DOC_CAL_MONTH      IN      NUMBER,
 OLD_TH_DOC_REF            IN      VARCHAR2,
 OLD_TH_DOC_REF_DT         IN      DATE,
 OLD_TH_DOC_DUE_DT         IN      DATE,
 OLD_TH_DIVN_CODE          IN      VARCHAR2,
 OLD_TH_DEPT_CODE          IN      VARCHAR2,
 OLD_TH_CTL_TOTAL          IN      NUMBER,
 OLD_TH_DESC               IN      VARCHAR2,
 OLD_TH_ANNOTATION         IN      VARCHAR2,
 OLD_TH_CR_UID             IN      VARCHAR2,
 OLD_TH_CR_DT              IN      DATE,
 NEW_TH_COMP_CODE          IN OUT  VARCHAR2,
 NEW_TH_ACNT_YEAR          IN OUT  NUMBER,
 NEW_TH_TRAN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DOC_NO             IN OUT  NUMBER,
 NEW_TH_DOC_DT             IN OUT  DATE,
 NEW_TH_DOC_CAL_YEAR       IN OUT  NUMBER,
 NEW_TH_DOC_CAL_MONTH      IN OUT  NUMBER,
 NEW_TH_DOC_REF            IN OUT  VARCHAR2,
 NEW_TH_DOC_REF_DT         IN OUT  DATE,
 NEW_TH_DOC_DUE_DT         IN OUT  DATE,
 NEW_TH_DIVN_CODE          IN OUT  VARCHAR2,
 NEW_TH_DEPT_CODE          IN OUT  VARCHAR2,
 NEW_TH_CTL_TOTAL          IN OUT  NUMBER,
 NEW_TH_DESC               IN OUT  VARCHAR2,
 NEW_TH_ANNOTATION         IN OUT  VARCHAR2,
 NEW_TH_CR_UID             IN OUT  VARCHAR2,
 NEW_TH_CR_DT              IN OUT  DATE,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
P_ERR_NO            NUMBER(6);
P_CAL_MONTH         NUMBER(2);
P_CAL_YEAR          NUMBER(2);
P_ACNT_YEAR         NUMBER(2);
P_CUR_ACNT_YEAR     NUMBER(2);
P_DBTI_KEY_FIELD    VARCHAR2(30);
PROCEDURE SETUP_DBTRG_INTERFACE IS
BEGIN
          IF TRG_MODE = 'U' OR TRG_MODE = 'D' THEN
              P_DBTI_KEY_FIELD := OLD_TH_COMP_CODE ||
                                  TO_CHAR(OLD_TH_ACNT_YEAR) ||
                                  OLD_TH_TRAN_CODE ||
                                  TO_CHAR(OLD_TH_DOC_NO) ;
          ELSE
              P_DBTI_KEY_FIELD := NEW_TH_COMP_CODE ||
                                  TO_CHAR(NEW_TH_ACNT_YEAR) ||
                                  NEW_TH_TRAN_CODE ||
                                  TO_CHAR(NEW_TH_DOC_NO) ;
          END IF;
          DELETE FROM FP_DBTRG_INTERFACE
          WHERE  DBTI_KEY_FIELD = P_DBTI_KEY_FIELD;
          IF TRG_MODE = 'D' THEN
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(OLD_TH_DOC_DT),
                      TO_CHAR(OLD_TH_DOC_CAL_MONTH),
                      TO_CHAR(OLD_TH_DOC_CAL_YEAR),
                      TO_CHAR(OLD_TH_DOC_DUE_DT),
                      TO_CHAR(OLD_TH_DOC_REF_DT));
          ELSE
              INSERT INTO FP_DBTRG_INTERFACE
                     (DBTI_KEY_FIELD, DBTI_VALUE_1, DBTI_VALUE_2,
                      DBTI_VALUE_3, DBTI_VALUE_4, DBTI_VALUE_5)
              VALUES (P_DBTI_KEY_FIELD, TO_CHAR(NEW_TH_DOC_DT),
                      TO_CHAR(NEW_TH_DOC_CAL_MONTH),
                      TO_CHAR(NEW_TH_DOC_CAL_YEAR),
                      TO_CHAR(NEW_TH_DOC_DUE_DT),
                      TO_CHAR(NEW_TH_DOC_REF_DT));
          END IF;
END;
BEGIN
DBMS_OUTPUT.PUT_LINE('7' || TRG_MODE) ;
Press <Enter> to continue...
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(NEW_TH_COMP_CODE);
ELSE
    P_CUR_ACNT_YEAR := F_GET_CUR_ACNT_YEAR(OLD_TH_COMP_CODE);
END IF;
P_ERR_NO := 0;
IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
    /* Initialise User id. and Date */
    IF TRG_MODE = 'I' THEN
         IF NEW_TH_CR_UID IS NULL THEN
              NEW_TH_CR_UID := 'UNDEF';
         END IF;
    ELSE
         IF NEW_TH_CR_UID IS NULL THEN
              NEW_TH_CR_UID := NVL(OLD_TH_CR_UID,'UNDEF');
         END IF;
    END IF;
    NEW_TH_CR_DT := SYSDATE;
    /* Validate if the document period corresponding to the document date
        is open. */
    IF (OLD_TH_DOC_DT IS NULL) OR
       (NVL(OLD_TH_DOC_DT,TO_DATE('01-JAN-1900','DD-MON-YYYY')) !=
            NEW_TH_DOC_DT) THEN
         F_VAL_OPCL(NEW_TH_COMP_CODE, NEW_TH_DOC_DT, P_ERR_NO,
                    P_CAL_YEAR, P_CAL_MONTH, P_ACNT_YEAR);
         IF P_ERR_NO != 0 THEN
            RAISE_APPLICATION_ERROR(-20500 - P_ERR_NO, 'Period not open');
         END IF;
         NEW_TH_ACNT_YEAR := P_ACNT_YEAR;
         NEW_TH_DOC_CAL_MONTH := P_CAL_MONTH;
         NEW_TH_DOC_CAL_YEAR  := P_CAL_YEAR;
         SETUP_DBTRG_INTERFACE;
         IF TRG_MODE = 'U' THEN
              IF OLD_TH_DOC_DT != NEW_TH_DOC_DT  OR
                 NVL(OLD_TH_DOC_DUE_DT,
                  TO_DATE('01-JAN-1900','DD-MON-YYYY')) !=
                 NVL(NEW_TH_DOC_DUE_DT,
                  TO_DATE('01-JAN-1900','DD-MON-YYYY')) THEN
                 F_UPD_DOC_DT_CHANGE(OLD_TH_COMP_CODE, OLD_TH_TRAN_CODE,
                     OLD_TH_DOC_NO, OLD_TH_ACNT_YEAR, OLD_TH_DOC_DT,
                     OLD_TH_DOC_DUE_DT, NEW_TH_DOC_DT, NEW_TH_DOC_DUE_DT,
                     NEW_TH_CR_UID, P_ERR_NO);
              END IF;
         END IF;
    END IF;
    /* Validate the data type of various components of the Narration, if
        Structuring of the narration is used. */
    IF NVL(OLD_TH_DESC,' ') != NVL(NEW_TH_DESC,' ') THEN
        F_VAL_NARRATION(NEW_TH_TRAN_CODE, NEW_TH_DESC, P_ERR_NO);
        IF P_ERR_NO != 0 THEN
            RAISE_APPLICATION_ERROR(-20008, 'Invalid Narration');
        END IF;
    END IF;
END IF;
IF TRG_MODE = 'D' THEN
     SETUP_DBTRG_INTERFACE;
     DELETE FROM FT_UNPOSTED_TRANS_DETAIL
     WHERE  TD_COMP_CODE = OLD_TH_COMP_CODE
     AND    TD_TRAN_CODE = OLD_TH_TRAN_CODE
     AND    TD_ACNT_YEAR = OLD_TH_ACNT_YEAR
     AND    TD_DOC_NO    = OLD_TH_DOC_NO;
END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_GET_OLD_PREM_ALLOC(
           M_TOT_RPA_RET_FC_SI    IN OUT  PT_RI_PREM_ALLOC.RPA_RET_FC_SI%TYPE,
           M_TOT_RPA_RI_FC_SI     IN OUT  PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE,
           M_RC_POL_SYS_ID        IN OUT  NUMBER,
           M_CLM_OBJ_SYS_ID       IN      NUMBER,
           M_CLM_LOSS_DT          IN      DATE,
           M_POL_LINK_POL_NO      IN      PT_POLICY.POL_LINK_POL_NO%TYPE,
           M_UW_YEAR              IN      PT_POLICY.POL_UW_YEAR%TYPE,
           M_WAR_YN               IN      CHAR,
           M_POL_ISSUE_DT         IN      DATE,
           M_POL_RI_BASIS         IN      VARCHAR2) IS
M_RPA_RET_FC_SI      PT_RI_PREM_ALLOC.RPA_RET_FC_SI%TYPE;
M_RPA_RI_FC_SI       PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE;
M_END_TYPE           VARCHAR2(3);
M_RC_SYS_ID          PT_RI_CESSION.RC_SYS_ID%TYPE;
X                    VARCHAR2(1);
M_RC_END_NO_IDX      PT_RI_CESSION.RC_POL_SYS_ID%TYPE;
CURSOR C1 IS
       SELECT   NVL(SUM(NVL(RPA_RET_FC_SI,0)),0),
                NVL(SUM(NVL(RPA_RI_FC_SI,0)),0) ,
                RPA_END_NO_IDX
       FROM     PT_RI_PREM_ALLOC
       WHERE    (RPA_DT          <= M_CLM_LOSS_DT OR
                 RPA_END_NO_IDX   = 0)
       AND      RPA_UW_YEAR      = M_UW_YEAR
       AND      RPA_RC_SYS_ID    IN (SELECT RC_SYS_ID
                                     FROM   PT_RI_CESSION
                                     WHERE  RC_POL_SYS_ID       = M_RC_POL_SYS_ID
                                     AND    RC_RISK_SYS_ID      = DECODE(M_POL_RI_BASIS, 'R',
                                                                  M_CLM_OBJ_SYS_ID, RC_RISK_SYS_ID)
                                     AND    NVL(RC_WAR_YN,'N')  = M_WAR_YN)
       GROUP BY RPA_END_NO_IDX;
CURSOR C2 IS
       SELECT POLH_O_END_TYPE
       FROM   PH_POLICY
       WHERE  POLH_SYS_ID     =  M_RC_POL_SYS_ID
       AND    POLH_END_NO_IDX =  M_RC_END_NO_IDX
       UNION
       SELECT POL_END_TYPE
       FROM   PT_POLICY
       WHERE  POL_SYS_ID     =  M_RC_POL_SYS_ID
       AND    POL_END_NO_IDX =  M_RC_END_NO_IDX  ;
CURSOR C3 IS
       SELECT POL_SYS_ID
       FROM   PT_POLICY
       WHERE  POL_NO  = M_POL_LINK_POL_NO ;
BEGIN
   M_TOT_RPA_RET_FC_SI    := 0;
   M_TOT_RPA_RI_FC_SI     := 0;
   IF M_POL_LINK_POL_NO != '0'  THEN
      OPEN C3 ;
      FETCH C3 INTO M_RC_POL_SYS_ID ;
      CLOSE C3 ;
   END IF;
   OPEN C1 ;
   LOOP
      FETCH C1 INTO M_RPA_RET_FC_SI,
                    M_RPA_RI_FC_SI,
                    M_RC_END_NO_IDX ;
      IF C1%NOTFOUND  THEN
         EXIT;
      END IF;
      OPEN C2 ;
      FETCH C2 INTO M_END_TYPE ;
      CLOSE C2 ;
      IF NVL(M_END_TYPE,'N') = '005'  THEN
         M_TOT_RPA_RET_FC_SI    := 0;
         M_TOT_RPA_RI_FC_SI     := 0;
      END IF;
      M_TOT_RPA_RET_FC_SI    := M_TOT_RPA_RET_FC_SI   + M_RPA_RET_FC_SI ;
      M_TOT_RPA_RI_FC_SI     := M_TOT_RPA_RI_FC_SI    + M_RPA_RI_FC_SI ;
   END LOOP;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_GET_OLD_SRNO_ALLOC(
           M_SRNO                 IN      PT_RI_PREM_ALLOC.RPA_SRNO%TYPE,
           M_TOT_RPA_RET_FC_SI    IN OUT  PT_RI_PREM_ALLOC.RPA_RET_FC_SI%TYPE,
           M_TOT_RPA_RI_FC_SI     IN OUT  PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE,
           M_RISK_SYS_ID          IN      NUMBER,
           M_POL_SYS_ID           IN      NUMBER,
           M_POL_LINK_POL_NO      IN      VARCHAR2,
           M_WAR_YN               IN      VARCHAR2,
           M_CLM_LOSS_DT          IN      DATE,
           M_UW_YEAR              IN      NUMBER,
           M_POL_RI_BASIS         IN      VARCHAR2) IS
M_RPA_RET_FC_SI      PT_RI_PREM_ALLOC.RPA_RET_FC_SI%TYPE;
M_RPA_RI_FC_SI       PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE;
M_END_TYPE           VARCHAR2(3);
M_RC_SYS_ID          PT_RI_CESSION.RC_SYS_ID%TYPE;
M_RC_POL_SYS_ID      PT_RI_CESSION.RC_POL_SYS_ID%TYPE;
M_RC_END_NO_IDX      PT_RI_CESSION.RC_POL_SYS_ID%TYPE;
X                    VARCHAR2(1);
CURSOR C1 IS
       SELECT   NVL(SUM(NVL(RPA_RET_FC_SI,0)),0), NVL(SUM(NVL(RPA_RI_FC_SI,0)),0),
                RPA_END_NO_IDX
       FROM     PT_RI_PREM_ALLOC
       WHERE    RPA_RC_SYS_ID       =  M_RC_SYS_ID
       AND      RPA_SRNO            =  M_SRNO
       AND     (RPA_DT             <= M_CLM_LOSS_DT  OR
                RPA_END_NO_IDX      = 0)
       AND      RPA_UW_YEAR         = M_UW_YEAR
       GROUP BY RPA_END_NO_IDX;
CURSOR C2 IS
       SELECT DISTINCT RPA_RC_SYS_ID
       FROM   PT_RI_PREM_ALLOC
       WHERE  RPA_POL_SYS_ID      = M_RC_POL_SYS_ID
       AND    RPA_RISK_SYS_ID     = DECODE(M_POL_RI_BASIS,'R',M_RISK_SYS_ID ,
                                    RPA_RISK_SYS_ID)
       AND    NVL(RPA_WAR_YN,'N') = M_WAR_YN
       AND    (RPA_DT            <= M_CLM_LOSS_DT  OR
              RPA_END_NO_IDX      = 0)
       AND    RPA_UW_YEAR         = M_UW_YEAR ;
CURSOR C3 IS
       SELECT POL_SYS_ID
       FROM   PT_POLICY
       WHERE  POL_NO     = M_POL_LINK_POL_NO ;
CURSOR C4 IS
       SELECT POLH_O_END_TYPE
       FROM   PH_POLICY
       WHERE  POLH_SYS_ID     =  M_RC_POL_SYS_ID
       AND    POLH_END_NO_IDX =  M_RC_END_NO_IDX
       UNION
       SELECT POL_END_TYPE
       FROM   PT_POLICY
       WHERE  POL_SYS_ID     =  M_RC_POL_SYS_ID
       AND    POL_END_NO_IDX =  M_RC_END_NO_IDX  ;
BEGIN
   M_TOT_RPA_RET_FC_SI    := 0;
   M_TOT_RPA_RI_FC_SI     := 0;
   IF M_POL_LINK_POL_NO != '0'  THEN
      OPEN C3;
      FETCH C3 INTO M_RC_POL_SYS_ID;
      CLOSE C3 ;
   ELSE
      M_RC_POL_SYS_ID  := M_POL_SYS_ID ;
   END IF;
   OPEN C2 ;
   LOOP
      FETCH C2 INTO M_RC_SYS_ID ;
      IF C2%NOTFOUND  THEN
         EXIT;
      END IF;
      OPEN C1 ;
      LOOP
         FETCH C1 INTO M_RPA_RET_FC_SI, M_RPA_RI_FC_SI,
                       M_RC_END_NO_IDX;
         IF C1%NOTFOUND  THEN
            EXIT;
         END IF;
         OPEN C4 ;
         FETCH C4 INTO M_END_TYPE ;
         CLOSE C4;
         IF NVL(M_END_TYPE,'N') = '005'  THEN
            M_TOT_RPA_RET_FC_SI    := 0;
            M_TOT_RPA_RI_FC_SI     := 0;
         END IF;
         M_TOT_RPA_RET_FC_SI    := M_TOT_RPA_RET_FC_SI   + M_RPA_RET_FC_SI ;
         M_TOT_RPA_RI_FC_SI     := M_TOT_RPA_RI_FC_SI    + M_RPA_RI_FC_SI ;
      END LOOP;
      CLOSE C1;
   END LOOP ;
   CLOSE C2 ;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_COMPANY(
 OLD_COMP_CODE             IN      VARCHAR2,
 OLD_COMP_NAME             IN      VARCHAR2,
 OLD_COMP_SHORT_NAME       IN      VARCHAR2,
 OLD_COMP_CTL_ACNT_CODE    IN      VARCHAR2,
 OID_COMP_HEADER           IN      VARCHAR2,
 OLD_COMP_ADD_1            IN      VARCHAR2,
 OLD_COMP_ADD_2            IN      VARCHAR2,
 OLD_COMP_ADD_3            IN      VARCHAR2,
 OLD_COMP_DFLT_DIVN_CODE   IN      VARCHAR2,
 OLD_COMP_DFLT_DEPT_CODE   IN      VARCHAR2,
 OLD_COMP_CR_UID           IN      VARCHAR2,
 OLD_COMP_CR_DT            IN      DATE,
 OLD_COMP_FRZ_FLAG         IN      VARCHAR2,
 OLD_COMP_BL_ADD_1         IN      VARCHAR2,
 OLD_COMP_BL_ADD_2         IN      VARCHAR2,
 OLD_COMP_BL_ADD_3         IN      VARCHAR2,
 OLD_COMP_BL_NAME          IN      VARCHAR2,
 OLD_COMP_BL_SHORT_NAME    IN      VARCHAR2,
 NEW_COMP_CODE             IN OUT  VARCHAR2,
 NEW_COMP_NAME             IN OUT  VARCHAR2,
 NEW_COMP_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_COMP_CTL_ACNT_CODE    IN OUT  VARCHAR2,
 NEW_COMP_HEADER           IN OUT  VARCHAR2,
 NEW_COMP_ADD_1            IN OUT  VARCHAR2,
 NEW_COMP_ADD_2            IN OUT  VARCHAR2,
 NEW_COMP_ADD_3            IN OUT  VARCHAR2,
 NEW_COMP_DFLT_DIVN_CODE   IN OUT  VARCHAR2,
 NEW_COMP_DFLT_DEPT_CODE   IN OUT  VARCHAR2,
 NEW_COMP_CR_UID           IN OUT  VARCHAR2,
 NEW_COMP_CR_DT            IN OUT  DATE,
 NEW_COMP_FRZ_FLAG         IN OUT  VARCHAR2,
 NEW_COMP_BL_ADD_1         IN OUT  VARCHAR2,
 NEW_COMP_BL_ADD_2         IN OUT  VARCHAR2,
 NEW_COMP_BL_ADD_3         IN OUT  VARCHAR2,
 NEW_COMP_BL_NAME          IN OUT  VARCHAR2,
 NEW_COMP_BL_SHORT_NAME    IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
BEGIN
   IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
      NEW_COMP_CR_DT := SYSDATE;
      NEW_COMP_CR_UID := NVL(NEW_COMP_CR_UID, NVL(OLD_COMP_CR_UID, 'UNDEF'));
   END IF;
   IF TRG_MODE = 'I' THEN
      INSERT INTO FM_COMPANY(
                    COMP_CODE,
                    COMP_NAME,
                    COMP_SHORT_NAME,
		    COMP_CTL_ACNT_CODE,
		    COMP_HEADER,
                    COMP_ADD_1,
                    COMP_ADD_2,
                    COMP_ADD_3,
                    COMP_DFLT_DIVN_CODE,
                    COMP_DFLT_DEPT_CODE,
                    COMP_CR_UID,
                    COMP_CR_DT,
                    COMP_FRZ_FLAG,
		    COMP_BL_ADD_1,
		    COMP_BL_ADD_2,
		    COMP_BL_ADD_3,
		    COMP_BL_NAME,
		    COMP_BL_SHORT_NAME)
         VALUES(
                    NEW_COMP_CODE,
                    NEW_COMP_NAME,
                    NEW_COMP_SHORT_NAME,
		    NEW_COMP_CTL_ACNT_CODE,
		    NEW_COMP_HEADER,
                    NEW_COMP_ADD_1,
                    NEW_COMP_ADD_2,
                    NEW_COMP_ADD_3,
                    NEW_COMP_DFLT_DIVN_CODE,
                    NEW_COMP_DFLT_DEPT_CODE,
                    NEW_COMP_CR_UID,
                    NEW_COMP_CR_DT,
                    NEW_COMP_FRZ_FLAG,
		    NEW_COMP_BL_ADD_1,
		    NEW_COMP_BL_ADD_2,
		    NEW_COMP_BL_ADD_3,
		    NEW_COMP_BL_NAME,
		    NEW_COMP_BL_SHORT_NAME);
   ELSIF TRG_MODE = 'U' THEN
      UPDATE FM_COMPANY
             SET   COMP_CODE            =  NEW_COMP_CODE,
                   COMP_NAME            =  NEW_COMP_NAME,
                   COMP_SHORT_NAME      =  NEW_COMP_SHORT_NAME,
		   COMP_CTL_ACNT_CODE   =  NEW_COMP_CTL_ACNT_CODE,
		   COMP_HEADER          =  NEW_COMP_HEADER,
                   COMP_ADD_1           =  NEW_COMP_ADD_1,
                   COMP_ADD_2           =  NEW_COMP_ADD_2,
                   COMP_ADD_3           =  NEW_COMP_ADD_3,
                   COMP_DFLT_DIVN_CODE  =  NEW_COMP_DFLT_DIVN_CODE,
                   COMP_DFLT_DEPT_CODE  =  NEW_COMP_DFLT_DEPT_CODE,
                   COMP_CR_UID          =  NEW_COMP_CR_UID,
                   COMP_CR_DT           =  NEW_COMP_CR_DT,
                   COMP_FRZ_FLAG        =  NEW_COMP_FRZ_FLAG,
		   COMP_BL_ADD_1        =  NEW_COMP_BL_ADD_1,
		   COMP_BL_ADD_2        =  NEW_COMP_BL_ADD_2,
		   COMP_BL_ADD_3        =  NEW_COMP_BL_ADD_3,
		   COMP_BL_NAME         =  NEW_COMP_BL_NAME,
		   COMP_BL_SHORT_NAME   =  NEW_COMP_BL_SHORT_NAME
             WHERE COMP_CODE            =  OLD_COMP_CODE;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_COMPANY
                  WHERE COMP_CODE = OLD_COMP_CODE;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_CURRENCY (
 OLD_CURR_CODE             IN      VARCHAR2,
 OLD_CURR_NAME             IN      VARCHAR2,
 OLD_CURR_DECIMAL          IN      NUMBER,
 OLD_CURR_UNIT_NAME        IN      VARCHAR2,
 OLD_CURR_CR_UID           IN      VARCHAR2,
 OLD_CURR_CR_DT            IN      DATE,
 OLD_CURR_FRZ_FLAG         IN      VARCHAR2,
 NEW_CURR_CODE             IN OUT  VARCHAR2,
 NEW_CURR_NAME             IN OUT  VARCHAR2,
 NEW_CURR_DECIMAL          IN OUT  NUMBER,
 NEW_CURR_UNIT_NAME        IN OUT  VARCHAR2,
 NEW_CURR_CR_UID           IN OUT  VARCHAR2,
 NEW_CURR_CR_DT            IN OUT  DATE,
 NEW_CURR_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
 BEGIN
    IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
       NEW_CURR_CR_DT  := SYSDATE;
       NEW_CURR_CR_UID := NVL(NEW_CURR_CR_UID,
                          NVL(OLD_CURR_CR_UID, 'UNDEF'));
    END IF;
    IF TRG_MODE = 'I'  THEN
       INSERT INTO FM_CURRENCY(
                         CURR_CODE,
                         CURR_NAME,
                         CURR_DECIMAL,
                         CURR_UNIT_NAME,
                         CURR_CR_UID,
                         CURR_CR_DT,
                         CURR_FRZ_FLAG)
                   VALUES(
                         NEW_CURR_CODE,
                         NEW_CURR_NAME,
                         NEW_CURR_DECIMAL,
                         NEW_CURR_UNIT_NAME,
                         NEW_CURR_CR_UID,
                         NEW_CURR_CR_DT,
                         NEW_CURR_FRZ_FLAG);
   ELSIF TRG_MODE = 'U'  THEN
      UPDATE FM_CURRENCY
                SET      CURR_NAME      = NEW_CURR_NAME,
                         CURR_DECIMAL   = NEW_CURR_DECIMAL,
                         CURR_UNIT_NAME = NEW_CURR_UNIT_NAME,
                         CURR_CR_UID    = NEW_CURR_CR_UID,
                         CURR_CR_DT     = NEW_CURR_CR_DT,
                         CURR_FRZ_FLAG  = NEW_CURR_FRZ_FLAG
                WHERE    CURR_CODE      = OLD_CURR_CODE;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_CURRENCY WHERE CURR_CODE = OLD_CURR_CODE;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_CUSTOMER (
 OLD_CUST_CODE             IN      VARCHAR2,
 OLD_CUST_CLASS            IN      VARCHAR2,
 OLD_CUST_NAME             IN      VARCHAR2,
 OLD_CUST_SHORT_NAME       IN      VARCHAR2,
 OLD_CUST_ADD_1            IN      VARCHAR2,
 OLD_CUST_ADD_2            IN      VARCHAR2,
 OLD_CUST_ADD_3            IN      VARCHAR2,
 OLD_CUST_COUNTRY          IN      VARCHAR2,
 OLD_CUST_PHONE            IN      VARCHAR2,
 OLD_CUST_FAX	         IN      VARCHAR2,
 OLD_CUST_CONTACT          IN      VARCHAR2,
 OLD_CUST_AREA             IN      VARCHAR2,
 OLD_CUST_CR_UID           IN      VARCHAR2,
 OLD_CUST_CR_DT            IN      DATE,
 OLD_CUST_FRZ_FLAG         IN      VARCHAR2,
 OLD_CUST_BL_NAME	   IN  	   VARCHAR2,
 OLD_CUST_BL_SHORT_NAME	   IN      VARCHAR2,
 OLD_CUST_BL_ADD_1	   IN      VARCHAR2,
 OLD_CUST_BL_ADD_2	   IN	   VARCHAR2,
 OLD_CUST_BL_ADD_3	   IN	   VARCHAR2,
 NEW_CUST_CODE             IN OUT  VARCHAR2,
 NEW_CUST_CLASS            IN OUT  VARCHAR2,
 NEW_CUST_NAME             IN OUT  VARCHAR2,
 NEW_CUST_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_CUST_ADD_1            IN OUT  VARCHAR2,
 NEW_CUST_ADD_2            IN OUT  VARCHAR2,
 NEW_CUST_ADD_3            IN OUT  VARCHAR2,
 NEW_CUST_COUNTRY          IN OUT  VARCHAR2,
 NEW_CUST_PHONE            IN OUT  VARCHAR2,
 NEW_CUST_FAX  	         IN OUT  VARCHAR2,
 NEW_CUST_CONTACT          IN OUT  VARCHAR2,
 NEW_CUST_AREA             IN OUT  VARCHAR2,
 NEW_CUST_CR_UID           IN OUT  VARCHAR2,
 NEW_CUST_CR_DT            IN OUT  DATE,
 NEW_CUST_FRZ_FLAG         IN OUT  VARCHAR2,
 NEW_CUST_BL_NAME	   IN  	   VARCHAR2,
 NEW_CUST_BL_SHORT_NAME	   IN      VARCHAR2,
 NEW_CUST_BL_ADD_1	   IN      VARCHAR2,
 NEW_CUST_BL_ADD_2	   IN	   VARCHAR2,
 NEW_CUST_BL_ADD_3	   IN	   VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                IN OUT  NUMBER,
 TRG_ERR_MSG               IN OUT  VARCHAR2) IS
M_DIVN_CODE                VARCHAR2(6);
M_DEPT_CODE                VARCHAR2(6);
NEW_CUST_MAIN_ACNT_CODE    VARCHAR2(6);
M_COMP_CODE                VARCHAR2(3);
CURSOR CLASS IS
       SELECT CCLAS_CTL_ACNT_CODE
       FROM   PM_CUST_CLASS
       WHERE  CCLAS_CODE     = NEW_CUST_CLASS;
CURSOR COMP IS
       SELECT COMP_CODE
       FROM   PM_COMPANY;
BEGIN
   IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
--      NEW_CUST_CR_DT := SYSDATE;
--      NEW_CUST_CR_UID := NVL(NEW_CUST_CR_UID,
--                             NVL(OLD_CUST_CR_UID, 'UNDEF'));
      OPEN CLASS;
      FETCH CLASS INTO NEW_CUST_MAIN_ACNT_CODE;
      IF CLASS%NOTFOUND  THEN
         RAISE_APPLICATION_ERROR(
         -20011,'Class not available for this customer');
      END IF;
      CLOSE CLASS;
   END IF;
   IF TRG_MODE = 'I'  THEN
      INSERT INTO FM_CUSTOMER(CUST_CODE,
                              CUST_NAME,
                              CUST_SHORT_NAME,
                              CUST_ADD_1,
                              CUST_ADD_2,
                              CUST_ADD_3,
                              CUST_COUNTRY,
                              CUST_PHONE,
                              CUST_FAX,
                              CUST_MAIN_ACNT_CODE,
                              CUST_CONTACT,
                              CUST_AREA,
                              CUST_CR_UID,
                              CUST_CR_DT,
                              CUST_FRZ_FLAG,
			      CUST_BL_NAME,
     			      CUST_BL_SHORT_NAME,
			      CUST_BL_ADD_1,
			      CUST_BL_ADD_2,
			      CUST_BL_ADD_3)
                       VALUES(NEW_CUST_CODE,
                              NEW_CUST_NAME,
                              SUBSTR(NEW_CUST_SHORT_NAME,1,15),
                              NEW_CUST_ADD_1,
                              NEW_CUST_ADD_2,
                              NEW_CUST_ADD_3,
                              NEW_CUST_COUNTRY,
                              NEW_CUST_PHONE,
                              NEW_CUST_FAX,
                              NEW_CUST_MAIN_ACNT_CODE,
                              SUBSTR(NEW_CUST_CONTACT,1,15),
                              NEW_CUST_AREA,
                              NEW_CUST_CR_UID,
                              NEW_CUST_CR_DT,
                              NEW_CUST_FRZ_FLAG,
			      NEW_CUST_BL_NAME,
     			      SUBSTR(NEW_CUST_BL_SHORT_NAME,1,15),
			      NEW_CUST_BL_ADD_1,
			      NEW_CUST_BL_ADD_2,
			      NEW_CUST_BL_ADD_3);
      OPEN COMP;
      LOOP
         FETCH COMP INTO M_COMP_CODE ;
         EXIT  WHEN COMP%NOTFOUND ;
         INSERT INTO FM_SUB_COMP(SCOMP_COMP_CODE,
			         SCOMP_SUB_ACNT_CODE,
       		                 SCOMP_CR_UID, SCOMP_CR_DT)
		          VALUES(M_COMP_CODE,
			         NEW_CUST_CODE,
			         NEW_CUST_CR_UID,
			         NEW_CUST_CR_DT) ;
      END LOOP ;
      CLOSE COMP;
    ELSIF TRG_MODE = 'U'  THEN
       UPDATE FM_CUSTOMER SET CUST_NAME           = NEW_CUST_NAME,
                              CUST_SHORT_NAME     = SUBSTR(NEW_CUST_SHORT_NAME,1,15),
                              CUST_ADD_1          = NEW_CUST_ADD_1,
                              CUST_ADD_2          = NEW_CUST_ADD_2,
                              CUST_ADD_3          = NEW_CUST_ADD_3,
                              CUST_COUNTRY        = NEW_CUST_COUNTRY,
                              CUST_PHONE          = NEW_CUST_PHONE,
                              CUST_FAX      	  = NEW_CUST_FAX,
                              CUST_MAIN_ACNT_CODE = NEW_CUST_MAIN_ACNT_CODE,
                              CUST_CONTACT        = SUBSTR(NEW_CUST_CONTACT,1,15),
                              CUST_AREA           = NEW_CUST_AREA,
                              CUST_CR_UID         = NEW_CUST_CR_UID,
                              CUST_CR_DT          = NEW_CUST_CR_DT,
                              CUST_FRZ_FLAG       = NEW_CUST_FRZ_FLAG,
			      CUST_BL_NAME	  = NEW_CUST_BL_NAME,
     			      CUST_BL_SHORT_NAME  = SUBSTR(NEW_CUST_BL_SHORT_NAME,1,15),
			      CUST_BL_ADD_1	  = NEW_CUST_BL_ADD_1,
			      CUST_BL_ADD_2	  = NEW_CUST_BL_ADD_2,
			      CUST_BL_ADD_3	  = NEW_CUST_BL_ADD_3
                      WHERE   CUST_CODE           = OLD_CUST_CODE;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_SUB_COMP WHERE SCOMP_SUB_ACNT_CODE = OLD_CUST_CODE;
      DELETE FM_CUSTOMER WHERE CUST_CODE           = OLD_CUST_CODE;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_CUST_CURR(
OLD_SCURR_CURR_CODE      IN     VARCHAR2,
OLD_SCURR_SUB_ACNT_CODE  IN     VARCHAR2,
OLD_SCURR_CR_UID         IN     VARCHAR2,
OLD_SCURR_CR_DT          IN     DATE,
NEW_SCURR_CURR_CODE      IN OUT VARCHAR2,
NEW_SCURR_SUB_ACNT_CODE  IN OUT VARCHAR2,
NEW_SCURR_CR_UID         IN OUT VARCHAR2,
NEW_SCURR_CR_DT          IN OUT DATE,
TRG_MODE                 IN OUT VARCHAR2,
TRG_ERR_NO               IN OUT NUMBER,
TRG_ERR_MSG              IN OUT VARCHAR2)
 IS
BEGIN
    IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
       NEW_SCURR_CR_DT  := SYSDATE;
       NEW_SCURR_CR_UID := NVL(NEW_SCURR_CR_UID,
                          NVL(OLD_SCURR_CR_UID, 'UNDEF'));
    END IF;
    IF TRG_MODE = 'I'  THEN
       INSERT INTO FM_SUB_CURR(
                 SCURR_CURR_CODE,
                 SCURR_SUB_ACNT_CODE,
                 SCURR_CR_UID,
                 SCURR_CR_DT)
          VALUES(NEW_SCURR_CURR_CODE,
                 NEW_SCURR_SUB_ACNT_CODE,
                 NEW_SCURR_CR_UID,
                 NEW_SCURR_CR_DT);
   ELSIF TRG_MODE = 'U'  THEN
      UPDATE FM_SUB_CURR
          SET    SCURR_SUB_ACNT_CODE = NEW_SCURR_SUB_ACNT_CODE,
                 SCURR_CR_UID        = NEW_SCURR_CR_UID,
                 SCURR_CR_DT         = NEW_SCURR_CR_DT
          WHERE  SCURR_CURR_CODE     = OLD_SCURR_CURR_CODE
	  AND    SCURR_SUB_ACNT_CODE = OLD_SCURR_SUB_ACNT_CODE ;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_SUB_CURR
      WHERE SCURR_CURR_CODE     = OLD_SCURR_CURR_CODE
      AND   SCURR_SUB_ACNT_CODE = OLD_SCURR_SUB_ACNT_CODE ;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_DEPARTMENT(
 OLD_DEPT_COMP_CODE          IN      VARCHAR2,
 OLD_DEPT_DIVN_CODE          IN      VARCHAR2,
 OLD_DEPT_CODE               IN      VARCHAR2,
 OLD_DEPT_NAME               IN      VARCHAR2,
 OLD_DEPT_SHORT_NAME         IN      VARCHAR2,
 OLD_DEPT_INCHARGE           IN      VARCHAR2,
 OLD_DEPT_CR_UID             IN      VARCHAR2,
 OLD_DEPT_CR_DT              IN      DATE,
 OLD_DEPT_FRZ_FLAG           IN      VARCHAR2,
 NEW_DEPT_COMP_CODE          IN OUT  VARCHAR2,
 NEW_DEPT_DIVN_CODE          IN OUT  VARCHAR2,
 NEW_DEPT_CODE               IN OUT  VARCHAR2,
 NEW_DEPT_NAME               IN OUT  VARCHAR2,
 NEW_DEPT_SHORT_NAME         IN OUT  VARCHAR2,
 NEW_DEPT_INCHARGE           IN OUT  VARCHAR2,
 NEW_DEPT_CR_UID             IN OUT  VARCHAR2,
 NEW_DEPT_CR_DT              IN OUT  DATE,
 NEW_DEPT_FRZ_FLAG           IN OUT  VARCHAR2,
 TRG_MODE                    IN OUT  VARCHAR2,
 TRG_ERR_NO                  IN OUT  NUMBER,
 TRG_ERR_MESG                IN OUT  VARCHAR2)
IS
BEGIN
    IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
      NEW_DEPT_CR_DT := SYSDATE;
      NEW_DEPT_CR_UID := NVL(NEW_DEPT_CR_UID, NVL(OLD_DEPT_CR_UID, 'UNDEF'));
    END IF;
    IF TRG_MODE = 'I'  THEN
       INSERT INTO FM_DEPARTMENT(
                    DEPT_COMP_CODE,
                    DEPT_DIVN_CODE,
                    DEPT_CODE,
                    DEPT_NAME,
                    DEPT_SHORT_NAME,
                    DEPT_INCHARGE,
                    DEPT_CR_UID,
                    DEPT_CR_DT,
		    DEPT_FRZ_FLAG)
            VALUES(
                    NEW_DEPT_COMP_CODE,
                    NEW_DEPT_DIVN_CODE,
                    NEW_DEPT_CODE,
                    NEW_DEPT_NAME,
                    NEW_DEPT_SHORT_NAME,
                    SUBSTR(NEW_DEPT_INCHARGE,1,15),
                    NEW_DEPT_CR_UID,
                    NEW_DEPT_CR_DT,
                    NEW_DEPT_FRZ_FLAG);
   ELSIF TRG_MODE = 'U'  THEN
      UPDATE FM_DEPARTMENT
               SET  DEPT_COMP_CODE = NEW_DEPT_COMP_CODE,
                    DEPT_DIVN_CODE = NEW_DEPT_DIVN_CODE,
                    DEPT_NAME      = NEW_DEPT_NAME,
                    DEPT_SHORT_NAME= NEW_DEPT_SHORT_NAME,
                    DEPT_INCHARGE  = SUBSTR(NEW_DEPT_INCHARGE,1,15),
                    DEPT_CR_UID    = NEW_DEPT_CR_UID,
                    DEPT_FRZ_FLAG  = NEW_DEPT_FRZ_FLAG
            WHERE   DEPT_CODE      = OLD_DEPT_CODE
	    AND     DEPT_DIVN_CODE = OLD_DEPT_DIVN_CODE
	    AND     DEPT_COMP_CODE = OLD_DEPT_COMP_CODE ;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_DEPARTMENT WHERE DEPT_CODE = OLD_DEPT_CODE
			   AND   DEPT_DIVN_CODE = OLD_DEPT_DIVN_CODE
			   AND   DEPT_COMP_CODE = OLD_DEPT_COMP_CODE ;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_PM_DIVISION (
 OLD_DIVN_COMP_CODE        IN      VARCHAR2,
 OLD_DIVN_CODE             IN      VARCHAR2,
 OLD_DIVN_NAME             IN      VARCHAR2,
 OLD_DIVN_SHORT_NAME       IN      VARCHAR2,
 OLD_DIVN_INCHARGE         IN      VARCHAR2,
 OLD_DIVN_CR_UID           IN      VARCHAR2,
 OLD_DIVN_CR_DT            IN      DATE,
 OLD_DIVN_FRZ_FLAG         IN      VARCHAR2,
 NEW_DIVN_COMP_CODE        IN OUT  VARCHAR2,
 NEW_DIVN_CODE             IN OUT  VARCHAR2,
 NEW_DIVN_NAME             IN OUT  VARCHAR2,
 NEW_DIVN_SHORT_NAME       IN OUT  VARCHAR2,
 NEW_DIVN_INCHARGE         IN OUT  VARCHAR2,
 NEW_DIVN_CR_UID           IN OUT  VARCHAR2,
 NEW_DIVN_CR_DT            IN OUT  DATE,
 NEW_DIVN_FRZ_FLAG         IN OUT  VARCHAR2,
 TRG_MODE                  IN OUT  VARCHAR2,
 TRG_ERR_NO                   OUT  NUMBER,
 TRG_ERR_MSG                  OUT  VARCHAR2) AS
BEGIN
   IF TRG_MODE = 'I' OR TRG_MODE = 'U' THEN
      NEW_DIVN_CR_DT := SYSDATE;
      NEW_DIVN_CR_UID := NVL(NEW_DIVN_CR_UID, NVL(OLD_DIVN_CR_UID, 'UNDEF'));
   END IF;
   IF TRG_MODE = 'I'  THEN
      INSERT INTO FM_DIVISION(
                      DIVN_COMP_CODE,
                      DIVN_CODE,
                      DIVN_NAME,
                      DIVN_SHORT_NAME,
                      DIVN_INCHARGE,
                      DIVN_CR_UID,
                      DIVN_CR_DT,
                      DIVN_FRZ_FLAG)
              VALUES( NEW_DIVN_COMP_CODE,
                      NEW_DIVN_CODE,
                      NEW_DIVN_NAME,
                      NEW_DIVN_SHORT_NAME,
                      SUBSTR(NEW_DIVN_INCHARGE,1,15),
                      NEW_DIVN_CR_UID,
                      NEW_DIVN_CR_DT,
                      NEW_DIVN_FRZ_FLAG);
   ELSIF TRG_MODE = 'U'  THEN
      UPDATE FM_DIVISION
             SET      DIVN_COMP_CODE  = NEW_DIVN_COMP_CODE,
                      DIVN_NAME       = NEW_DIVN_NAME,
                      DIVN_SHORT_NAME = NEW_DIVN_SHORT_NAME,
                      DIVN_INCHARGE   = SUBSTR(NEW_DIVN_INCHARGE,1,15),
                      DIVN_CR_UID     = NEW_DIVN_CR_UID,
                      DIVN_CR_DT      = NEW_DIVN_CR_DT,
                      DIVN_FRZ_FLAG   = NEW_DIVN_FRZ_FLAG
             WHERE    DIVN_CODE       = OLD_DIVN_CODE;
   ELSIF TRG_MODE = 'D'  THEN
      DELETE FM_DIVISION WHERE DIVN_CODE = OLD_DIVN_CODE;
   END IF;
END;
/
CREATE OR REPLACE PROCEDURE STP_POL_SI
      (
      M_POL_SYS_ID         IN     PT_POLICY.POL_SYS_ID%TYPE,
      M_BASE_CURR          IN     VARCHAR2,
      M_CLM_OBJ_SYS_ID     IN     NUMBER,
      M_CLM_LOSS_DT        IN     DATE,
      M_POL_END_DT         IN     DATE,
      M_POL_END_NO_IDX     IN     PT_POLICY.POL_END_NO_IDX%TYPE,
      M_POL_LINK_POL_NO    IN     PT_POLICY.POL_LINK_POL_NO%TYPE,
      M_SC_CODE            IN     PT_POLICY.POL_SC_CODE%TYPE,
      M_CLASS_CODE         IN     PM_SUB_CLASS.SC_CLASS_CODE%TYPE,
      M_UW_YEAR            IN     PT_POLICY.POL_UW_YEAR%TYPE,
      M_WAR_YN             IN     CHAR,
      M_POL_ISSUE_DT       IN     DATE,
      M_POL_RI_BASIS       IN     VARCHAR2,
      M_POL_LC_SI          IN OUT NUMBER) IS
M_RC_POL_SYS_ID         NUMBER(10);
M_TOT_FAC_LC_SI         PT_CLAIM_PAID.CP_LC_PAID_AMT%TYPE;
M_TOT_TREATY_FC_SI      PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE ;
M_TOT_TREATY_LC_SI      PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE ;
M_TOT_RPA_RET_FC_SI     PT_RI_PREM_ALLOC.RPA_RET_FC_SI%TYPE := 0;
M_TOT_RPA_RI_FC_SI      PT_RI_PREM_ALLOC.RPA_RI_FC_SI%TYPE := 0;
M_TOT_FAC_PERC          NUMBER(3);
M_FAC_LC_SI             PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_COINS_LC_SI           PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_T_FAC_LC_SI           PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_T_COINS_LC_SI         PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_FAC_FC_SI             PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_COINS_FC_SI           PT_FAC_PART_CUST.FPCU_LC_SI%TYPE := 0;
M_CURR_RATE             PM_PROP_TREATY.PT_CURR_RATE%TYPE;
M_CURR_CODE             PM_PROP_TREATY.PT_CURR_CODE%TYPE;
M_NO_OF_DEC             FM_CURRENCY.CURR_DECIMAL%TYPE;
CURSOR C2 IS
       SELECT NVL(SUM(DECODE(FPCU_COINS_YN, 'Y', NVL(FPCU_LC_SI,0) -
                                                NVL(FPCU_RETRO_LC_SI,0))),0),
              NVL(SUM(DECODE(FPCU_COINS_YN, 'N', NVL(FPCU_LC_SI,0) -
                                                NVL(FPCU_RETRO_LC_SI,0))),0)
       FROM   PT_FAC_PART_CUST, PT_FAC_OUT
       WHERE  FO_POL_SYS_ID         =  M_POL_SYS_ID
       AND    FO_RISK_SYS_ID        =  DECODE(M_POL_RI_BASIS,'R',M_CLM_OBJ_SYS_ID,
                                       FO_RISK_SYS_ID)
       AND    NVL(FO_WAR_YN,'N')    =  M_WAR_YN
       AND    FPCU_FO_SYS_ID        =  FO_SYS_ID
       AND   (M_POL_END_NO_IDX      =  0
       OR     M_CLM_LOSS_DT         >= M_POL_END_DT)
       UNION
       SELECT NVL(SUM(DECODE(FPCUH_COINS_YN, 'Y', NVL(FPCUH_O_LC_SI,0) -
                                                NVL(FPCUH_O_RETRO_LC_SI,0))),0),
              NVL(SUM(DECODE(FPCUH_COINS_YN, 'N', NVL(FPCUH_O_LC_SI,0) -
                                                NVL(FPCUH_O_RETRO_LC_SI,0))),0)
       FROM   PH_FAC_PART_CUST, PH_FAC_OUT
       WHERE  FPCUH_FO_SYS_ID    =  FOH_SYS_ID
       AND    FOH_POL_SYS_ID     =  M_POL_SYS_ID
       AND    FOH_END_NO_IDX     =  FPCUH_END_NO_IDX
       AND    FOH_RISK_SYS_ID    =  DECODE(M_POL_RI_BASIS,'R',M_CLM_OBJ_SYS_ID,
                                    FOH_RISK_SYS_ID)
       AND    NVL(FOH_WAR_YN,'N')= M_WAR_YN
       AND    FOH_END_NO_IDX   = (SELECT MAX(POLH_END_NO_IDX)
                                  FROM  PH_POLICY
                                  WHERE POLH_SYS_ID = M_POL_SYS_ID
                                  AND   NVL(POLH_O_END_DT,POLH_ISSUE_DT) <=M_CLM_LOSS_DT )
       AND   (M_POL_END_NO_IDX    > 0
       AND    M_CLM_LOSS_DT < M_POL_END_DT)
       UNION
       SELECT NVL(SUM(DECODE(FPCUH_COINS_YN, 'Y', NVL(FPCUH_O_LC_SI,0) -
                                                NVL(FPCUH_O_RETRO_LC_SI,0))),0),
              NVL(SUM(DECODE(FPCUH_COINS_YN, 'N', NVL(FPCUH_O_LC_SI,0) -
                                                NVL(FPCUH_O_RETRO_LC_SI,0))),0)
       FROM   PH_FAC_PART_CUST, PH_FAC_OUT
       WHERE  FPCUH_FO_SYS_ID    =  FOH_SYS_ID
       AND    FOH_POL_SYS_ID     =  M_POL_SYS_ID
       AND    FOH_END_NO_IDX     =  FPCUH_END_NO_IDX
       AND    FOH_RISK_SYS_ID    =  DECODE(M_POL_RI_BASIS,'R',M_CLM_OBJ_SYS_ID,
                                    FOH_RISK_SYS_ID)
       AND    NVL(FOH_WAR_YN,'N')= M_WAR_YN
       AND    FOH_END_NO_IDX     = 0
       AND    M_CLM_LOSS_DT < M_POL_ISSUE_DT ;
CURSOR C4 IS
       SELECT PT_CURR_CODE, PT_CURR_RATE
       FROM   PM_PROP_TREATY
       WHERE  PT_UW_YEAR     = M_UW_YEAR
       AND    PT_CLASS_CODE  = M_CLASS_CODE
       AND    PT_WAR_YN      = M_WAR_YN ;
CURSOR C5 IS
       SELECT CURR_DECIMAL
       FROM   FM_CURRENCY
       WHERE  CURR_CODE = M_BASE_CURR ;
BEGIN
   M_RC_POL_SYS_ID := M_POL_SYS_ID ;
   /* To calculate the total facultative amount */
   OPEN C2 ;
   LOOP
      FETCH C2 INTO M_T_COINS_LC_SI,  M_T_FAC_LC_SI ;
      IF C2%NOTFOUND THEN
         EXIT ;
      END IF;
      M_COINS_LC_SI    := NVL(M_COINS_LC_SI,0)   +
                            NVL(M_T_COINS_LC_SI,0) ;
      M_FAC_LC_SI      := NVL(M_FAC_LC_SI,0)     +
                            NVL(M_T_FAC_LC_SI,0) ;
   END LOOP ;
   CLOSE C2 ;
   M_TOT_FAC_LC_SI    := NVL(M_COINS_LC_SI,0) + NVL(M_FAC_LC_SI,0) ;
   OPEN C4 ;
   FETCH C4 INTO M_CURR_CODE,M_CURR_RATE ;
   CLOSE C4;
   OPEN C5 ;
   FETCH C5 INTO M_NO_OF_DEC;
   CLOSE C5 ;
   /*Fetching value from the pt_ri_prem_alloc for treaty value */
   STP_GET_OLD_PREM_ALLOC(M_TOT_RPA_RET_FC_SI,  M_TOT_RPA_RI_FC_SI ,
                        M_RC_POL_SYS_ID, M_CLM_OBJ_SYS_ID,M_CLM_LOSS_DT,
                        M_POL_LINK_POL_NO,M_UW_YEAR,M_WAR_YN,M_POL_ISSUE_DT,
                        M_POL_RI_BASIS) ;
   M_TOT_TREATY_FC_SI    := NVL(M_TOT_RPA_RET_FC_SI,0) +
                       NVL(M_TOT_RPA_RI_FC_SI,0) ;
   /* converting the treaty amount in to local currency */
   M_TOT_TREATY_LC_SI    := M_TOT_TREATY_FC_SI  * M_CURR_RATE ;
   M_TOT_TREATY_LC_SI    := ROUND(M_TOT_TREATY_LC_SI, M_NO_OF_DEC) ;
   M_POL_LC_SI           := (NVL(M_TOT_TREATY_LC_SI,0) + NVL(M_TOT_FAC_LC_SI,0)) ;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_AIRCRAFT(
          P_OLD_AIR_SYS_ID               IN                 NUMBER,
          P_OLD_AIR_POL_SYS_ID           IN                 NUMBER,
          P_OLD_AIR_AIRCRAFT_ID          IN                 VARCHAR2,
          P_OLD_AIR_AIRCRAFT_NAME        IN                VARCHAR2,
          P_OLD_AIR_AIRCRAFT_TYPE        IN                 VARCHAR2,
          P_OLD_AIR_COUNTRY_CODE         IN                VARCHAR2,
          P_OLD_AIR_YEAR                 IN                NUMBER,
          P_OLD_AIR_ENTRY_DT             IN                DATE,
          P_OLD_AIR_EXIT_DT              IN                DATE,
          P_OLD_AIR_OWNER                IN                VARCHAR2,
          P_OLD_AIR_DECL_PASS_CAP        IN                NUMBER,
          P_OLD_AIR_LICN_PASS_CAP        IN                NUMBER,
          P_OLD_AIR_USAGE_CODE           IN                VARCHAR2,
          P_OLD_AIR_TERR_LIMIT           IN                VARCHAR2,
          P_OLD_AIR_NIGHT_FLY_YN         IN                VARCHAR2,
          P_OLD_AIR_MAX_CREW             IN                NUMBER,
          P_OLD_AIR_ENGINE_TYPE          IN                VARCHAR2,
          P_OLD_AIR_NO_ENGINE            IN                NUMBER,
          P_OLD_AIR_CURR_CODE            IN                VARCHAR2,
          P_OLD_AIR_FC_AMT               IN                NUMBER,
          P_OLD_AIR_LC_AMT               IN                NUMBER,
          P_OLD_AIR_DEL_FLAG             IN                VARCHAR2,
          P_OLD_AIR_CR_DT                IN                DATE,
          P_OLD_AIR_CR_UID               IN                VARCHAR2,
          P_OLD_AIR_UPD_DT               IN                DATE,
          P_OLD_AIR_UPD_UID              IN                VARCHAR2,
          P_NEW_AIR_SYS_ID               IN                 NUMBER,
          P_NEW_AIR_POL_SYS_ID           IN                 NUMBER,
          P_NEW_AIR_AIRCRAFT_ID          IN                 VARCHAR2,
          P_NEW_AIR_AIRCRAFT_NAME        IN                VARCHAR2,
          P_NEW_AIR_AIRCRAFT_TYPE        IN                 VARCHAR2,
          P_NEW_AIR_COUNTRY_CODE         IN                VARCHAR2,
          P_NEW_AIR_YEAR                 IN                NUMBER,
          P_NEW_AIR_ENTRY_DT             IN                DATE,
          P_NEW_AIR_EXIT_DT              IN                DATE,
          P_NEW_AIR_OWNER                IN                VARCHAR2,
          P_NEW_AIR_DECL_PASS_CAP        IN                NUMBER,
          P_NEW_AIR_LICN_PASS_CAP        IN                NUMBER,
          P_NEW_AIR_USAGE_CODE           IN                VARCHAR2,
          P_NEW_AIR_TERR_LIMIT           IN                VARCHAR2,
          P_NEW_AIR_NIGHT_FLY_YN         IN                VARCHAR2,
          P_NEW_AIR_MAX_CREW             IN                NUMBER,
          P_NEW_AIR_ENGINE_TYPE          IN                VARCHAR2,
          P_NEW_AIR_NO_ENGINE            IN                NUMBER,
          P_NEW_AIR_CURR_CODE            IN                VARCHAR2,
          P_NEW_AIR_FC_AMT               IN                NUMBER,
          P_NEW_AIR_LC_AMT               IN                NUMBER,
          P_NEW_AIR_DEL_FLAG             IN                VARCHAR2,
          P_NEW_AIR_CR_DT                IN                DATE,
          P_NEW_AIR_CR_UID               IN                VARCHAR2,
          P_NEW_AIR_UPD_DT               IN                DATE,
          P_NEW_AIR_UPD_UID              IN                VARCHAR2,
               P_TRG_MODE                                  IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_AIRCRAFT
       WHERE  AIRH_SYS_ID     = NVL(P_OLD_AIR_SYS_ID, P_NEW_AIR_SYS_ID)
       AND    AIRH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF AIRH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_AIR_POL_SYS_ID, P_NEW_AIR_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_AIRCRAFT(AIRH_SYS_ID, AIRH_END_NO_IDX, AIRH_POL_SYS_ID,
                              AIRH_AIRCRAFT_ID, AIRH_O_AIRCRAFT_TYPE, AIRH_O_AIRCRAFT_NAME,
                              AIRH_O_COUNTRY_CODE, AIRH_O_YEAR, AIRH_O_ENTRY_DT,
                              AIRH_O_EXIT_DT, AIRH_O_OWNER, AIRH_O_DECL_PASS_CAP,
                              AIRH_O_LICN_PASS_CAP, AIRH_O_USAGE_CODE, AIRH_O_TERR_LIMIT,
                              AIRH_O_NIGHT_FLY_YN, AIRH_O_MAX_CREW, AIRH_O_ENGINE_TYPE,
                              AIRH_O_NO_ENGINE, AIRH_O_CURR_CODE, AIRH_O_FC_AMT,
                              AIRH_O_LC_AMT, AIRH_O_DEL_FLAG, AIRH_O_CR_DT, AIRH_O_CR_UID,
                              AIRH_O_UPD_DT, AIRH_O_UPD_UID, AIRH_N_AIRCRAFT_TYPE,
                              AIRH_N_AIRCRAFT_NAME, AIRH_N_COUNTRY_CODE, AIRH_N_YEAR,
                              AIRH_N_ENTRY_DT, AIRH_N_EXIT_DT, AIRH_N_OWNER,
                              AIRH_N_DECL_PASS_CAP, AIRH_N_LICN_PASS_CAP, AIRH_N_USAGE_CODE,
                              AIRH_N_TERR_LIMIT, AIRH_N_NIGHT_FLY_YN, AIRH_N_MAX_CREW,
                              AIRH_N_ENGINE_TYPE, AIRH_N_NO_ENGINE, AIRH_N_CURR_CODE,
                              AIRH_N_FC_AMT, AIRH_N_LC_AMT, AIRH_N_DEL_FLAG, AIRH_N_CR_DT,
                              AIRH_N_CR_UID, AIRH_N_UPD_DT, AIRH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_AIR_SYS_ID, P_NEW_AIR_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_AIR_POL_SYS_ID,
                                     P_NEW_AIR_POL_SYS_ID),
             NVL(P_OLD_AIR_AIRCRAFT_ID, P_NEW_AIR_AIRCRAFT_ID),
                      P_OLD_AIR_AIRCRAFT_TYPE, P_OLD_AIR_AIRCRAFT_NAME, P_OLD_AIR_COUNTRY_CODE,
                      P_OLD_AIR_YEAR, P_OLD_AIR_ENTRY_DT, P_OLD_AIR_EXIT_DT, P_OLD_AIR_OWNER,
                      P_OLD_AIR_DECL_PASS_CAP, P_OLD_AIR_LICN_PASS_CAP, P_OLD_AIR_USAGE_CODE,
                 P_OLD_AIR_TERR_LIMIT, P_OLD_AIR_NIGHT_FLY_YN, P_OLD_AIR_MAX_CREW,
                 P_OLD_AIR_ENGINE_TYPE, P_OLD_AIR_NO_ENGINE, P_OLD_AIR_CURR_CODE,
                 P_OLD_AIR_FC_AMT, P_OLD_AIR_LC_AMT, P_OLD_AIR_DEL_FLAG, P_OLD_AIR_CR_DT,
                 P_OLD_AIR_CR_UID, P_OLD_AIR_UPD_DT, P_OLD_AIR_UPD_UID, P_NEW_AIR_AIRCRAFT_TYPE,
                 P_NEW_AIR_AIRCRAFT_NAME, P_NEW_AIR_COUNTRY_CODE, P_NEW_AIR_YEAR,
                 P_NEW_AIR_ENTRY_DT, P_NEW_AIR_EXIT_DT, P_NEW_AIR_OWNER, P_NEW_AIR_DECL_PASS_CAP,
                 P_NEW_AIR_LICN_PASS_CAP, P_NEW_AIR_USAGE_CODE, P_NEW_AIR_TERR_LIMIT,
                 P_NEW_AIR_NIGHT_FLY_YN, P_NEW_AIR_MAX_CREW, P_NEW_AIR_ENGINE_TYPE,
                 P_NEW_AIR_NO_ENGINE, P_NEW_AIR_CURR_CODE, P_NEW_AIR_FC_AMT, P_NEW_AIR_LC_AMT,
                 P_NEW_AIR_DEL_FLAG, P_NEW_AIR_CR_DT, P_NEW_AIR_CR_UID,
                 P_NEW_AIR_UPD_DT, P_NEW_AIR_UPD_UID);
   ELSE
      UPDATE PH_AIRCRAFT
      SET     AIRH_N_AIRCRAFT_TYPE        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_AIRCRAFT_TYPE,
						P_NEW_AIR_AIRCRAFT_TYPE),
              AIRH_N_AIRCRAFT_NAME        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_AIRCRAFT_NAME,
						P_NEW_AIR_AIRCRAFT_NAME),
              AIRH_N_COUNTRY_CODE        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_COUNTRY_CODE,
						P_NEW_AIR_COUNTRY_CODE),
              AIRH_N_YEAR                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_YEAR,
						P_NEW_AIR_YEAR),
              AIRH_N_ENTRY_DT            = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_ENTRY_DT,
						P_NEW_AIR_ENTRY_DT),
              AIRH_N_EXIT_DT             = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_EXIT_DT,
						P_NEW_AIR_EXIT_DT),
              AIRH_N_OWNER                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_OWNER,
						P_NEW_AIR_OWNER),
              AIRH_N_DECL_PASS_CAP        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_DECL_PASS_CAP,
						P_NEW_AIR_DECL_PASS_CAP),
              AIRH_N_LICN_PASS_CAP        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_LICN_PASS_CAP,
						P_NEW_AIR_LICN_PASS_CAP),
              AIRH_N_USAGE_CODE         = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_USAGE_CODE,
						P_NEW_AIR_USAGE_CODE),
Press <Enter> to continue...
              AIRH_N_TERR_LIMIT          = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_TERR_LIMIT,
						P_NEW_AIR_TERR_LIMIT),
              AIRH_N_NIGHT_FLY_YN        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_NIGHT_FLY_YN,
						P_NEW_AIR_NIGHT_FLY_YN),
              AIRH_N_MAX_CREW                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_MAX_CREW,
						P_NEW_AIR_MAX_CREW),
              AIRH_N_ENGINE_TYPE        = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_ENGINE_TYPE,
						P_NEW_AIR_ENGINE_TYPE),
              AIRH_N_NO_ENGINE                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_NO_ENGINE,
						P_NEW_AIR_NO_ENGINE),
              AIRH_N_CURR_CODE                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_CURR_CODE,
						P_NEW_AIR_CURR_CODE),
              AIRH_N_FC_AMT                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_FC_AMT,
						P_NEW_AIR_FC_AMT),
              AIRH_N_LC_AMT                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_LC_AMT,
						P_NEW_AIR_LC_AMT),
              AIRH_N_DEL_FLAG                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_DEL_FLAG,
						P_NEW_AIR_DEL_FLAG),
              AIRH_N_CR_DT                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_CR_DT,
						P_NEW_AIR_CR_DT),
              AIRH_N_CR_UID                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_CR_UID,
						P_NEW_AIR_CR_UID),
              AIRH_N_UPD_DT                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_UPD_DT,
						P_NEW_AIR_UPD_DT),
              AIRH_N_UPD_UID                = DECODE(P_TRG_MODE, 'D',
                                                 P_OLD_AIR_UPD_UID,
						P_NEW_AIR_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_CONDITION(
        P_OLD_COND_SYS_ID                     IN         NUMBER,
        P_OLD_COND_POL_SYS_ID                 IN         NUMBER,
        P_OLD_COND_SRNO                       IN         NUMBER,
        P_OLD_COND_CODE                       IN         VARCHAR2,
        P_OLD_COND_DESC                       IN         VARCHAR2,
        P_OLD_COND_DEL_FLAG                   IN         VARCHAR2,
        P_OLD_COND_CR_DT                      IN         DATE,
        P_OLD_COND_CR_UID                     IN         VARCHAR2,
        P_OLD_COND_UPD_DT                     IN         DATE,
        P_OLD_COND_UPD_UID                    IN         VARCHAR2,
        P_NEW_COND_SYS_ID                     IN         NUMBER,
        P_NEW_COND_POL_SYS_ID                 IN         NUMBER,
        P_NEW_COND_SRNO                       IN         NUMBER,
        P_NEW_COND_CODE                       IN         VARCHAR2,
        P_NEW_COND_DESC                       IN         VARCHAR2,
        P_NEW_COND_DEL_FLAG                   IN         VARCHAR2,
        P_NEW_COND_CR_DT                      IN         DATE,
        P_NEW_COND_CR_UID                     IN         VARCHAR2,
        P_NEW_COND_UPD_DT                     IN         DATE,
        P_NEW_COND_UPD_UID                    IN         VARCHAR2,
             P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_CONDITION
       WHERE  CONDH_SYS_ID     = NVL(P_OLD_COND_SYS_ID, P_NEW_COND_SYS_ID)
       AND    CONDH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF CONDH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_COND_POL_SYS_ID, P_NEW_COND_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_CONDITION(CONDH_SYS_ID, CONDH_END_NO_IDX, CONDH_POL_SYS_ID,
                                CONDH_O_SRNO, CONDH_O_CODE, CONDH_O_DESC, CONDH_O_DEL_FLAG,
                                CONDH_O_CR_DT, CONDH_O_CR_UID, CONDH_O_UPD_DT, CONDH_O_UPD_UID,
                                CONDH_N_SRNO, CONDH_N_CODE, CONDH_N_DESC, CONDH_N_DEL_FLAG,
                                CONDH_N_CR_DT, CONDH_N_CR_UID, CONDH_N_UPD_DT, CONDH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_COND_SYS_ID, P_NEW_COND_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_COND_POL_SYS_ID,
                                     P_NEW_COND_POL_SYS_ID),
                    P_OLD_COND_SRNO, P_OLD_COND_CODE, P_OLD_COND_DESC, P_OLD_COND_DEL_FLAG,
                    P_OLD_COND_CR_DT, P_OLD_COND_CR_UID, P_OLD_COND_UPD_DT, P_OLD_COND_UPD_UID,
                    P_NEW_COND_SRNO, P_NEW_COND_CODE, P_NEW_COND_DESC, P_NEW_COND_DEL_FLAG,
                    P_NEW_COND_CR_DT, P_NEW_COND_CR_UID, P_NEW_COND_UPD_DT, P_NEW_COND_UPD_UID);
   ELSE
      UPDATE PH_CONDITION
      SET  CONDH_N_SRNO     = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_SRNO,P_NEW_COND_SRNO),
           CONDH_N_CODE     = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_CODE,P_NEW_COND_CODE),
           CONDH_N_DESC     = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_DESC,P_NEW_COND_DESC),
           CONDH_N_DEL_FLAG = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_DEL_FLAG,P_NEW_COND_DEL_FLAG),
           CONDH_N_CR_DT    = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_CR_DT,P_NEW_COND_CR_DT),
           CONDH_N_CR_UID   = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_CR_UID,P_NEW_COND_CR_UID),
           CONDH_N_UPD_DT   = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_UPD_DT,P_NEW_COND_UPD_DT),
           CONDH_N_UPD_UID  = DECODE(P_TRG_MODE, 'D',
                                   P_OLD_COND_UPD_UID,P_NEW_COND_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_COVER_DISCOUNT(
                P_OLD_CD_SYS_ID                       IN         NUMBER,
                P_OLD_CD_COVER_SYS_ID                 IN         NUMBER,
                P_OLD_CD_CODE                         IN         VARCHAR2,
                P_OLD_CD_DESC                         IN         VARCHAR2,
                P_OLD_CD_PERC                         IN         NUMBER,
                P_OLD_CD_FC_DISC                      IN         NUMBER,
                P_OLD_CD_LC_DISC                      IN         NUMBER,
                P_OLD_CD_FC_ORG_DISC                  IN         NUMBER,
                P_OLD_CD_LC_ORG_DISC                  IN         NUMBER,
                P_OLD_CD_DEL_FLAG                     IN         VARCHAR2,
                P_OLD_CD_CR_DT                        IN         DATE,
                P_OLD_CD_CR_UID                       IN         VARCHAR2,
                P_OLD_CD_UPD_DT                       IN         DATE,
                P_OLD_CD_UPD_UID                      IN         VARCHAR2,
                P_OLD_CD_DIM_DISC_YN                  IN         VARCHAR2,
                P_NEW_CD_SYS_ID                       IN         NUMBER,
                P_NEW_CD_COVER_SYS_ID                 IN         NUMBER,
                P_NEW_CD_CODE                         IN         VARCHAR2,
                P_NEW_CD_DESC                         IN         VARCHAR2,
                P_NEW_CD_PERC                         IN         NUMBER,
                P_NEW_CD_FC_DISC                      IN         NUMBER,
                P_NEW_CD_LC_DISC                      IN         NUMBER,
                P_NEW_CD_FC_ORG_DISC                  IN         NUMBER,
                P_NEW_CD_LC_ORG_DISC                  IN         NUMBER,
                P_NEW_CD_DEL_FLAG                     IN         VARCHAR2,
                P_NEW_CD_CR_DT                        IN         DATE,
                P_NEW_CD_CR_UID                       IN         VARCHAR2,
                P_NEW_CD_UPD_DT                       IN         DATE,
                P_NEW_CD_UPD_UID                      IN         VARCHAR2,
                P_NEW_CD_DIM_DISC_YN                  IN         VARCHAR2,
                P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_COVER_DISCOUNT
       WHERE  CDH_SYS_ID     = NVL(P_OLD_CD_SYS_ID, P_NEW_CD_SYS_ID)
       AND    CDH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF CDH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT PCVR_POL_SYS_ID
       FROM   PT_POL_COVER
       WHERE  PCVR_SYS_ID = NVL(P_OLD_CD_COVER_SYS_ID, P_NEW_CD_COVER_SYS_ID) ;
BEGIN
   /* SELECTing Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_COVER_DISCOUNT
	     (CDH_SYS_ID, CDH_END_NO_IDX, CDH_COVER_SYS_ID,
              CDH_O_CODE, CDH_O_DESC, CDH_O_PERC, CDH_O_FC_DISC,
              CDH_O_LC_DISC, CDH_O_DEL_FLAG, CDH_O_CR_DT,
              CDH_O_CR_UID, CDH_O_UPD_DT, CDH_O_UPD_UID,
              CDH_O_DIM_DISC_YN,
              CDH_N_CODE, CDH_N_DESC, CDH_N_PERC, CDH_N_FC_DISC,
              CDH_N_LC_DISC, CDH_N_DEL_FLAG, CDH_N_CR_DT,
              CDH_N_CR_UID, CDH_N_UPD_DT, CDH_N_UPD_UID,
              CDH_N_DIM_DISC_YN)
      VALUES (DECODE(P_TRG_MODE, 'D', P_OLD_CD_SYS_ID, P_NEW_CD_SYS_ID),
              M_END_NO_IDX,
              DECODE(P_TRG_MODE, 'D', P_OLD_CD_COVER_SYS_ID,
                                      P_NEW_CD_COVER_SYS_ID),
              P_OLD_CD_CODE, P_OLD_CD_DESC, P_OLD_CD_PERC, P_OLD_CD_FC_ORG_DISC,
              P_OLD_CD_LC_ORG_DISC, P_OLD_CD_DEL_FLAG, P_OLD_CD_CR_DT,
	      P_OLD_CD_CR_UID, P_OLD_CD_UPD_DT, P_OLD_CD_UPD_UID,
              P_OLD_CD_DIM_DISC_YN,
	      P_NEW_CD_CODE, P_NEW_CD_DESC, P_NEW_CD_PERC, P_NEW_CD_FC_DISC,
	      P_NEW_CD_LC_DISC, P_NEW_CD_DEL_FLAG, P_NEW_CD_CR_DT,
	      P_NEW_CD_CR_UID, P_NEW_CD_UPD_DT, P_NEW_CD_UPD_UID,
              P_NEW_CD_DIM_DISC_YN);
   ELSE
      UPDATE PH_COVER_DISCOUNT
      SET    CDH_N_CODE     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_CODE,P_NEW_CD_CODE),
             CDH_N_DESC     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_DESC,P_NEW_CD_DESC),
             CDH_N_PERC     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_PERC,P_NEW_CD_PERC),
             CDH_N_FC_DISC  = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_FC_DISC,P_NEW_CD_FC_DISC),
             CDH_N_LC_DISC  = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_LC_DISC,P_NEW_CD_LC_DISC),
             CDH_N_DEL_FLAG = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_DEL_FLAG,P_NEW_CD_DEL_FLAG),
             CDH_N_CR_DT    = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_CR_DT,P_NEW_CD_CR_DT),
             CDH_N_CR_UID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_CR_UID,P_NEW_CD_CR_UID),
             CDH_N_UPD_DT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_UPD_DT,P_NEW_CD_UPD_DT),
             CDH_N_UPD_UID  = DECODE(P_TRG_MODE, 'D',
					P_OLD_CD_UPD_UID,P_NEW_CD_UPD_UID),
             CDH_N_DIM_DISC_YN = DECODE (P_TRG_MODE,'D',P_OLD_CD_DIM_DISC_YN,
					P_NEW_CD_DIM_DISC_YN)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_DED_LOSS(
        P_OLD_DL_SYS_ID                       IN         NUMBER,
        P_OLD_DL_POL_SYS_ID                   IN         NUMBER,
        P_OLD_DL_COVER_SYS_ID                 IN         NUMBER,
        P_OLD_DL_CODE                         IN         VARCHAR2,
        P_OLD_DL_DESC                         IN         VARCHAR2,
        P_OLD_DL_TYPE                         IN         VARCHAR2,
        P_OLD_DL_DAYS                         IN         NUMBER,
        P_OLD_DL_PERC                         IN         NUMBER,
        P_OLD_DL_FC_VAL                       IN         NUMBER,
        P_OLD_DL_LC_VAL                       IN         NUMBER,
        P_OLD_DL_DEL_FLAG                     IN         VARCHAR2,
        P_OLD_DL_CR_DT                        IN         DATE,
        P_OLD_DL_CR_UID                       IN         VARCHAR2,
        P_OLD_DL_UPD_DT                       IN         DATE,
        P_OLD_DL_UPD_UID                      IN         VARCHAR2,
        P_NEW_DL_SYS_ID                       IN         NUMBER,
        P_NEW_DL_POL_SYS_ID                   IN         NUMBER,
        P_NEW_DL_COVER_SYS_ID                 IN         NUMBER,
        P_NEW_DL_CODE                         IN         VARCHAR2,
        P_NEW_DL_DESC                         IN         VARCHAR2,
        P_NEW_DL_TYPE                         IN         VARCHAR2,
        P_NEW_DL_DAYS                         IN         NUMBER,
        P_NEW_DL_PERC                         IN         NUMBER,
        P_NEW_DL_FC_VAL                       IN         NUMBER,
        P_NEW_DL_LC_VAL                       IN         NUMBER,
        P_NEW_DL_DEL_FLAG                     IN         VARCHAR2,
        P_NEW_DL_CR_DT                        IN         DATE,
        P_NEW_DL_CR_UID                       IN         VARCHAR2,
        P_NEW_DL_UPD_DT                       IN         DATE,
        P_NEW_DL_UPD_UID                      IN         VARCHAR2,
             P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_DED_LOSS
       WHERE  DLH_SYS_ID     = NVL(P_OLD_DL_SYS_ID, P_NEW_DL_SYS_ID)
       AND    DLH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF DLH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_DL_POL_SYS_ID, P_NEW_DL_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_DED_LOSS
		(DLH_SYS_ID, DLH_END_NO_IDX, DLH_POL_SYS_ID, DLH_COVER_SYS_ID,
		DLH_O_CODE, DLH_O_DESC, DLH_O_TYPE, DLH_O_DAYS,
		DLH_O_PERC, DLH_O_FC_VAL, DLH_O_LC_VAL, DLH_O_DEL_FLAG,
		DLH_O_CR_DT, DLH_O_CR_UID, DLH_O_UPD_DT, DLH_O_UPD_UID,
		DLH_N_CODE, DLH_N_DESC, DLH_N_TYPE, DLH_N_DAYS,
		DLH_N_PERC, DLH_N_FC_VAL, DLH_N_LC_VAL, DLH_N_DEL_FLAG,
		DLH_N_CR_DT, DLH_N_CR_UID, DLH_N_UPD_DT, DLH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_DL_SYS_ID, P_NEW_DL_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D',P_OLD_DL_POL_SYS_ID,P_NEW_DL_POL_SYS_ID),
             DECODE(P_TRG_MODE,'D',P_OLD_DL_COVER_SYS_ID,P_NEW_DL_COVER_SYS_ID),
             P_OLD_DL_CODE, P_OLD_DL_DESC, P_OLD_DL_TYPE, P_OLD_DL_DAYS,
	     P_OLD_DL_PERC, P_OLD_DL_FC_VAL, P_OLD_DL_LC_VAL, P_OLD_DL_DEL_FLAG,
	     P_OLD_DL_CR_DT, P_OLD_DL_CR_UID, P_OLD_DL_UPD_DT, P_OLD_DL_UPD_UID,
	     P_NEW_DL_CODE, P_NEW_DL_DESC, P_NEW_DL_TYPE, P_NEW_DL_DAYS,
	     P_NEW_DL_PERC, P_NEW_DL_FC_VAL, P_NEW_DL_LC_VAL, P_NEW_DL_DEL_FLAG,
	     P_NEW_DL_CR_DT, P_NEW_DL_CR_UID, P_NEW_DL_UPD_DT,
	     P_NEW_DL_UPD_UID);
   ELSE
      UPDATE PH_DED_LOSS
      SET DLH_N_CODE     = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_CODE,P_NEW_DL_CODE),
          DLH_N_DESC     = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_DESC,P_NEW_DL_DESC),
          DLH_N_TYPE     = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_TYPE,P_NEW_DL_TYPE),
          DLH_N_DAYS     = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_DAYS,P_NEW_DL_DAYS),
          DLH_N_PERC     = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_PERC,P_NEW_DL_PERC),
          DLH_N_FC_VAL   = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_FC_VAL,P_NEW_DL_FC_VAL),
          DLH_N_LC_VAL   = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_LC_VAL,P_NEW_DL_LC_VAL),
          DLH_N_DEL_FLAG = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_DEL_FLAG,P_NEW_DL_DEL_FLAG),
          DLH_N_CR_DT    = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_CR_DT,P_NEW_DL_CR_DT),
          DLH_N_CR_UID   = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_CR_UID,P_NEW_DL_CR_UID),
          DLH_N_UPD_DT   = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_UPD_DT,P_NEW_DL_UPD_DT),
          DLH_N_UPD_UID  = DECODE(P_TRG_MODE, 'D',
				P_OLD_DL_UPD_UID,P_NEW_DL_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_DRIVER
      (P_OLD_DRV_SYS_ID          IN NUMBER,
       P_OLD_DRV_POL_SYS_ID      IN NUMBER,
       P_OLD_DRV_NAME            IN VARCHAR2,
       P_OLD_DRV_ENTRY_DT        IN DATE,
       P_OLD_DRV_EXIT_DT         IN DATE,
       P_OLD_DRV_ADDR1           IN VARCHAR2,
       P_OLD_DRV_ADDR2           IN VARCHAR2,
       P_OLD_DRV_ADDR3           IN VARCHAR2,
       P_OLD_DRV_AGE             IN NUMBER,
       P_OLD_DRV_LICN_TYPE       IN VARCHAR2,
       P_OLD_DRV_LICN_NO         IN VARCHAR2,
       P_OLD_DRV_LICN_ISSUE_DT   IN DATE,
       P_OLD_DRV_LICN_EXP_DT     IN DATE,
       P_OLD_DRV_LICN_ISSUE_LOCN IN VARCHAR2,
       P_OLD_DRV_DEL_FLAG        IN VARCHAR2,
       P_OLD_DRV_CR_DT           IN DATE,
       P_OLD_DRV_CR_UID          IN VARCHAR2,
       P_OLD_DRV_UPD_DT          IN DATE,
       P_OLD_DRV_UPD_UID         IN VARCHAR2,
       P_NEW_DRV_SYS_ID          IN NUMBER,
       P_NEW_DRV_POL_SYS_ID      IN NUMBER,
       P_NEW_DRV_NAME            IN VARCHAR2,
       P_NEW_DRV_ENTRY_DT        IN DATE,
       P_NEW_DRV_EXIT_DT         IN DATE,
       P_NEW_DRV_ADDR1           IN VARCHAR2,
       P_NEW_DRV_ADDR2           IN VARCHAR2,
       P_NEW_DRV_ADDR3           IN VARCHAR2,
       P_NEW_DRV_AGE             IN NUMBER,
       P_NEW_DRV_LICN_TYPE       IN VARCHAR2,
       P_NEW_DRV_LICN_NO         IN VARCHAR2,
       P_NEW_DRV_LICN_ISSUE_DT   IN DATE,
       P_NEW_DRV_LICN_EXP_DT     IN DATE,
       P_NEW_DRV_LICN_ISSUE_LOCN IN VARCHAR2,
       P_NEW_DRV_DEL_FLAG        IN VARCHAR2,
       P_NEW_DRV_CR_DT           IN DATE,
       P_NEW_DRV_CR_UID          IN VARCHAR2,
       P_NEW_DRV_UPD_DT          IN DATE,
       P_NEW_DRV_UPD_UID         IN VARCHAR2,
       P_OLD_VEH_SYS_ID          IN NUMBER,
       P_NEW_VEH_SYS_ID          IN NUMBER,
       P_TRG_MODE                IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT  'X'
       FROM   PH_DRIVER
       WHERE  DRVH_SYS_ID     = NVL(P_OLD_DRV_SYS_ID, P_NEW_DRV_SYS_ID)
       AND    DRVH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF DRVH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_DRV_POL_SYS_ID, P_NEW_DRV_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1;
   FETCH C1 INTO M_TEMP;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_DRIVER(DRVH_SYS_ID,
                            DRVH_END_NO_IDX,
                            DRVH_POL_SYS_ID,
                            DRVH_O_NAME, DRVH_O_ENTRY_DT,
                            DRVH_O_EXIT_DT, DRVH_O_ADDR1,
                            DRVH_O_ADDR2, DRVH_O_ADDR3,
                            DRVH_O_AGE, DRVH_O_LICN_TYPE,
                            DRVH_O_LICN_NO, DRVH_O_LICN_ISSUE_DT,
                            DRVH_O_LICN_EXP_DT, DRVH_O_LICN_ISSUE_LOCN,
                            DRVH_O_DEL_FLAG, DRVH_O_CR_DT,
                            DRVH_O_CR_UID, DRVH_O_UPD_DT,
                            DRVH_O_UPD_UID, DRVH_N_NAME,
                            DRVH_N_ENTRY_DT, DRVH_N_EXIT_DT,
                            DRVH_N_ADDR1, DRVH_N_ADDR2,
                            DRVH_N_ADDR3, DRVH_N_AGE,
                            DRVH_N_LICN_TYPE, DRVH_N_LICN_NO,
                            DRVH_N_LICN_ISSUE_DT, DRVH_N_LICN_EXP_DT,
                            DRVH_N_LICN_ISSUE_LOCN, DRVH_N_DEL_FLAG,
                            DRVH_N_CR_DT, DRVH_N_CR_UID,
                            DRVH_N_UPD_DT, DRVH_N_UPD_UID,
                            DRVH_VEH_SYS_ID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_DRV_SYS_ID, P_NEW_DRV_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE,'D', P_OLD_DRV_POL_SYS_ID, P_NEW_DRV_POL_SYS_ID),
             P_OLD_DRV_NAME, P_OLD_DRV_ENTRY_DT,
             P_OLD_DRV_EXIT_DT, P_OLD_DRV_ADDR1,
             P_OLD_DRV_ADDR2, P_OLD_DRV_ADDR3,
             P_OLD_DRV_AGE, P_OLD_DRV_LICN_TYPE,
             P_OLD_DRV_LICN_NO, P_OLD_DRV_LICN_ISSUE_DT,
             P_OLD_DRV_LICN_EXP_DT, P_OLD_DRV_LICN_ISSUE_LOCN,
             P_OLD_DRV_DEL_FLAG, P_OLD_DRV_CR_DT,
             P_OLD_DRV_CR_UID, P_OLD_DRV_UPD_DT,
             P_OLD_DRV_UPD_UID, P_NEW_DRV_NAME,
             P_NEW_DRV_ENTRY_DT, P_NEW_DRV_EXIT_DT,
             P_NEW_DRV_ADDR1, P_NEW_DRV_ADDR2,
             P_NEW_DRV_ADDR3, P_NEW_DRV_AGE,
             P_NEW_DRV_LICN_TYPE, P_NEW_DRV_LICN_NO,
             P_NEW_DRV_LICN_ISSUE_DT, P_NEW_DRV_LICN_EXP_DT,
             P_NEW_DRV_LICN_ISSUE_LOCN, P_NEW_DRV_DEL_FLAG,
             P_NEW_DRV_CR_DT, P_NEW_DRV_CR_UID,
             P_NEW_DRV_UPD_DT, P_NEW_DRV_UPD_UID,
             P_NEW_VEH_SYS_ID);
   ELSE
      UPDATE PH_DRIVER
      SET    DRVH_N_NAME            = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_NAME,
					P_NEW_DRV_NAME),
             DRVH_N_ENTRY_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_ENTRY_DT,
					P_NEW_DRV_ENTRY_DT),
             DRVH_N_EXIT_DT         = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_EXIT_DT,
					P_NEW_DRV_EXIT_DT),
             DRVH_N_ADDR1           = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_ADDR1,
					P_NEW_DRV_ADDR1),
             DRVH_N_ADDR2           = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_ADDR2,
					P_NEW_DRV_ADDR2),
             DRVH_N_ADDR3           = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_ADDR3,
					P_NEW_DRV_ADDR3),
             DRVH_N_AGE             = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_AGE,
					P_NEW_DRV_AGE),
             DRVH_N_LICN_TYPE       = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_LICN_TYPE,
					P_NEW_DRV_LICN_TYPE),
             DRVH_N_LICN_NO         = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_LICN_NO,
					P_NEW_DRV_LICN_NO),
             DRVH_N_LICN_ISSUE_DT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_LICN_ISSUE_DT,
					P_NEW_DRV_LICN_ISSUE_DT),
             DRVH_N_LICN_EXP_DT     = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_LICN_EXP_DT,
					P_NEW_DRV_LICN_EXP_DT),
             DRVH_N_LICN_ISSUE_LOCN = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_LICN_ISSUE_LOCN,
					P_NEW_DRV_LICN_ISSUE_LOCN),
             DRVH_N_DEL_FLAG        = DECODE(P_TRG_MODE, 'D',
					P_OLD_DRV_DEL_FLAG,
					P_NEW_DRV_DEL_FLAG),
             DRVH_N_CR_DT           = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_CR_DT,
					P_NEW_DRV_CR_DT),
             DRVH_N_CR_UID          = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_CR_UID,
					P_NEW_DRV_CR_UID),
             DRVH_N_UPD_DT          = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_UPD_DT,
					P_NEW_DRV_UPD_DT),
             DRVH_N_UPD_UID         = DECODE(P_TRG_MODE, 'D', P_OLD_DRV_UPD_UID,
					P_NEW_DRV_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_CUST_RETRO (
            P_OLD_FCR_SYS_ID         IN   NUMBER,
            P_OLD_FCR_FPCU_SYS_ID    IN   NUMBER,
            P_OLD_FCR_REF_NO         IN   VARCHAR2,
            P_OLD_FCR_CUST_CODE      IN   VARCHAR2,
            P_OLD_FCR_SI_CURR_CODE   IN   VARCHAR2,
            P_OLD_FCR_SHARE_PERC     IN   NUMBER,
            P_OLD_FCR_FC_SI          IN   NUMBER,
            P_OLD_FCR_LC_SI          IN   NUMBER,
            P_OLD_FCR_FC_PREM        IN   NUMBER,
            P_OLD_FCR_LC_PREM        IN   NUMBER,
            P_OLD_FCR_ORG_FC_SI      IN   NUMBER,
            P_OLD_FCR_ORG_LC_SI      IN   NUMBER,
            P_OLD_FCR_ORG_FC_PREM    IN   NUMBER,
            P_OLD_FCR_ORG_LC_PREM    IN   NUMBER,
            P_OLD_FCR_DEL_FLAG       IN   VARCHAR2,
            P_OLD_FCR_CR_DT          IN   DATE,
            P_OLD_FCR_CR_UID         IN   VARCHAR2,
            P_OLD_FCR_UPD_DT         IN   DATE,
            P_OLD_FCR_UPD_UID        IN   VARCHAR2,
            P_NEW_FCR_SYS_ID         IN   NUMBER,
            P_NEW_FCR_FPCU_SYS_ID    IN   NUMBER,
            P_NEW_FCR_REF_NO         IN   VARCHAR2,
            P_NEW_FCR_CUST_CODE      IN   VARCHAR2,
            P_NEW_FCR_SI_CURR_CODE   IN   VARCHAR2,
            P_NEW_FCR_SHARE_PERC     IN   NUMBER,
            P_NEW_FCR_FC_SI          IN   NUMBER,
            P_NEW_FCR_LC_SI          IN   NUMBER,
            P_NEW_FCR_FC_PREM        IN   NUMBER,
            P_NEW_FCR_LC_PREM        IN   NUMBER,
            P_NEW_FCR_ORG_FC_SI      IN   NUMBER,
            P_NEW_FCR_ORG_LC_SI      IN   NUMBER,
            P_NEW_FCR_ORG_FC_PREM    IN   NUMBER,
            P_NEW_FCR_ORG_LC_PREM    IN   NUMBER,
            P_NEW_FCR_DEL_FLAG       IN   VARCHAR2,
            P_NEW_FCR_CR_DT          IN   DATE,
            P_NEW_FCR_CR_UID         IN   VARCHAR2,
            P_NEW_FCR_UPD_DT         IN   DATE,
            P_NEW_FCR_UPD_UID        IN   VARCHAR2,
            P_TRG_MODE               IN   VARCHAR2)  AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE;
M_FAC_CLOSE_FLAG       PT_POLICY.POL_FAC_CLOSE_FLAG%TYPE;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_FAC_CUST_RETRO
       WHERE  FCRH_SYS_ID     = NVL(P_OLD_FCR_SYS_ID, P_NEW_FCR_SYS_ID)
       AND    FCRH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FCRH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS, POL_FAC_CLOSE_FLAG
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT FO_POL_SYS_ID
       FROM   PT_FAC_OUT
       WHERE  FO_SYS_ID IN(SELECT FPCU_FO_SYS_ID
                           FROM   PT_FAC_PART_CUST
                           WHERE  FPCU_SYS_ID =  NVL(P_OLD_FCR_FPCU_SYS_ID, P_NEW_FCR_FPCU_SYS_ID)) ;
BEGIN
   /* Selecting Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* Selecting Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS,M_FAC_CLOSE_FLAG ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF (NVL(M_APPRV_STATUS, 'N') != 'N' AND NVL(M_FAC_CLOSE_FLAG,'N') != 'N' ) THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX,0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX,0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_FAC_CUST_RETRO (
           FCRH_SYS_ID,FCRH_FPCU_SYS_ID,FCRH_END_NO_IDX, FCRH_O_REF_NO,
           FCRH_O_CUST_CODE, FCRH_O_SHARE_PERC, FCRH_O_SI_CURR_CODE,
           FCRH_O_FC_SI, FCRH_O_LC_SI, FCRH_O_FC_PREM, FCRH_O_LC_PREM,
           FCRH_O_DEL_FLAG, FCRH_O_CR_DT, FCRH_O_CR_UID, FCRH_O_UPD_DT,
           FCRH_O_UPD_UID,
           FCRH_N_REF_NO, FCRH_N_CUST_CODE, FCRH_N_SHARE_PERC,
           FCRH_N_SI_CURR_CODE, FCRH_N_FC_SI, FCRH_N_LC_SI, FCRH_N_FC_PREM,
           FCRH_N_LC_PREM, FCRH_N_DEL_FLAG, FCRH_N_CR_DT, FCRH_N_CR_UID,
           FCRH_N_UPD_DT, FCRH_N_UPD_UID)
       VALUES(
           DECODE(P_TRG_MODE, 'D', P_OLD_FCR_SYS_ID, P_NEW_FCR_SYS_ID),
           DECODE(P_TRG_MODE, 'D', P_OLD_FCR_FPCU_SYS_ID, P_NEW_FCR_FPCU_SYS_ID),
           M_END_NO_IDX, P_OLD_FCR_REF_NO, P_OLD_FCR_CUST_CODE,
           P_OLD_FCR_SHARE_PERC, P_OLD_FCR_SI_CURR_CODE, P_OLD_FCR_FC_SI,
           P_OLD_FCR_LC_SI, P_OLD_FCR_FC_PREM, P_OLD_FCR_LC_PREM,
           P_OLD_FCR_DEL_FLAG, P_OLD_FCR_CR_DT, P_OLD_FCR_CR_UID,
           P_OLD_FCR_UPD_DT, P_OLD_FCR_UPD_UID,
           P_NEW_FCR_REF_NO, P_NEW_FCR_CUST_CODE, P_NEW_FCR_SHARE_PERC,
           P_NEW_FCR_SI_CURR_CODE, P_NEW_FCR_FC_SI, P_NEW_FCR_LC_SI,
           P_NEW_FCR_FC_PREM, P_NEW_FCR_LC_PREM, P_NEW_FCR_DEL_FLAG,
           P_NEW_FCR_CR_DT, P_NEW_FCR_CR_UID, P_NEW_FCR_UPD_DT, P_NEW_FCR_UPD_UID);
   ELSE
      UPDATE PH_FAC_CUST_RETRO
      SET   FCRH_N_REF_NO           = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_REF_NO,
						P_NEW_FCR_REF_NO),
            FCRH_N_CUST_CODE        = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_CUST_CODE,
						P_NEW_FCR_CUST_CODE),
	     FCRH_N_SHARE_PERC       = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_SHARE_PERC,
						P_NEW_FCR_SHARE_PERC),
	     FCRH_N_SI_CURR_CODE     = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_SI_CURR_CODE,
						P_NEW_FCR_SI_CURR_CODE),
             FCRH_N_FC_SI            = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_FC_SI,
						P_NEW_FCR_FC_SI),
             FCRH_N_LC_SI            = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_LC_SI,
						P_NEW_FCR_LC_SI),
             FCRH_N_FC_PREM          = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_FC_PREM,
						P_NEW_FCR_FC_PREM),
             FCRH_N_LC_PREM          = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_LC_PREM,
						P_NEW_FCR_LC_PREM),
             FCRH_N_DEL_FLAG         = DECODE(P_TRG_MODE,'D',
						P_OLD_FCR_DEL_FLAG,
						P_NEW_FCR_DEL_FLAG)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_DEDUCTION (
       P_OLD_FD_SYS_ID                       NUMBER,
       P_OLD_FD_FPCU_SYS_ID                  NUMBER,
       P_OLD_FD_TYPE                         VARCHAR2,
       P_OLD_FD_COMM_CODE                    VARCHAR2,
       P_OLD_FD_FAC_RETRO                    VARCHAR2,
       P_OLD_FD_PERC                         NUMBER,
       P_OLD_FD_FC_AMT                       NUMBER,
       P_OLD_FD_LC_AMT                       NUMBER,
       P_OLD_FD_ORG_FC_AMT                   NUMBER,
       P_OLD_FD_ORG_LC_AMT                   NUMBER,
       P_OLD_FD_CR_DT                        DATE,
       P_OLD_FD_DEL_FLAG                     VARCHAR2,
       P_OLD_FD_CR_UID                       VARCHAR2,
       P_OLD_FD_UPD_DT                       DATE,
       P_OLD_FD_UPD_UID                      VARCHAR2,
       P_NEW_FD_SYS_ID                       NUMBER,
       P_NEW_FD_FPCU_SYS_ID                  NUMBER,
       P_NEW_FD_TYPE                         VARCHAR2,
       P_NEW_FD_COMM_CODE                    VARCHAR2,
       P_NEW_FD_FAC_RETRO                    VARCHAR2,
       P_NEW_FD_PERC                         NUMBER,
       P_NEW_FD_FC_AMT                       NUMBER,
       P_NEW_FD_LC_AMT                       NUMBER,
       P_NEW_FD_ORG_FC_AMT                   NUMBER,
       P_NEW_FD_ORG_LC_AMT                   NUMBER,
       P_NEW_FD_CR_DT                        DATE,
       P_NEW_FD_DEL_FLAG                     VARCHAR2,
       P_NEW_FD_CR_UID                       VARCHAR2,
       P_NEW_FD_UPD_DT                       DATE,
       P_NEW_FD_UPD_UID                      VARCHAR2,
       P_TRG_MODE                            VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE;
M_FAC_CLOSE_FLAG       PT_POLICY.POL_FAC_CLOSE_FLAG%TYPE;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_FAC_DEDUCTION
       WHERE  FDH_SYS_ID     = NVL(P_OLD_FD_SYS_ID, P_NEW_FD_SYS_ID)
       AND    FDH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FDH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS, POL_FAC_CLOSE_FLAG
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT FO_POL_SYS_ID
       FROM   PT_FAC_OUT, PT_FAC_PART_CUST
       WHERE  FPCU_SYS_ID = NVL(P_OLD_FD_FPCU_SYS_ID, P_NEW_FD_FPCU_SYS_ID)
       AND    FO_SYS_ID   = FPCU_FO_SYS_ID ;
BEGIN
   /* Selecting Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* Selecting Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS, M_FAC_CLOSE_FLAG ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF (NVL(M_APPRV_STATUS, 'N') != 'N' AND NVL(M_FAC_CLOSE_FLAG,'N') != 'N' ) THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX,0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX,0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_FAC_DEDUCTION (
             FDH_SYS_ID, FDH_END_NO_IDX, FDH_FPCU_SYS_ID, FDH_O_TYPE,
             FDH_O_COMM_CODE, FDH_O_FAC_RETRO, FDH_O_PERC, FDH_O_FC_AMT,
             FDH_O_LC_AMT, FDH_O_CR_DT, FDH_O_DEL_FLAG, FDH_O_CR_UID,
             FDH_O_UPD_DT, FDH_O_UPD_UID, FDH_N_TYPE, FDH_N_COMM_CODE,
             FDH_N_FAC_RETRO, FDH_N_PERC, FDH_N_FC_AMT, FDH_N_LC_AMT,
             FDH_N_CR_DT, FDH_N_DEL_FLAG, FDH_N_CR_UID, FDH_N_UPD_DT,
             FDH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_FD_SYS_ID, P_NEW_FD_SYS_ID),
	     M_END_NO_IDX,
	     DECODE(P_TRG_MODE, 'D', P_OLD_FD_FPCU_SYS_ID,
				     P_NEW_FD_FPCU_SYS_ID),
             P_OLD_FD_TYPE, P_OLD_FD_COMM_CODE, P_OLD_FD_FAC_RETRO,
	     P_OLD_FD_PERC, P_OLD_FD_FC_AMT, P_OLD_FD_LC_AMT, P_OLD_FD_CR_DT,
	     P_OLD_FD_DEL_FLAG, P_OLD_FD_CR_UID, P_OLD_FD_UPD_DT,
	     P_OLD_FD_UPD_UID, P_NEW_FD_TYPE, P_NEW_FD_COMM_CODE,
             P_NEW_FD_FAC_RETRO, P_NEW_FD_PERC, P_NEW_FD_FC_AMT,
	     P_NEW_FD_LC_AMT, P_NEW_FD_CR_DT, P_NEW_FD_DEL_FLAG,
	     P_NEW_FD_CR_UID, P_NEW_FD_UPD_DT, P_NEW_FD_UPD_UID) ;
   ELSE
      UPDATE PH_FAC_DEDUCTION
      SET    FDH_N_TYPE          = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_TYPE,P_NEW_FD_TYPE),
             FDH_N_COMM_CODE     = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_COMM_CODE,P_NEW_FD_COMM_CODE),
             FDH_N_FAC_RETRO     = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_FAC_RETRO,P_NEW_FD_FAC_RETRO),
             FDH_N_PERC          = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_PERC,P_NEW_FD_PERC),
             FDH_N_FC_AMT        = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_FC_AMT,P_NEW_FD_FC_AMT),
             FDH_N_LC_AMT        = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_LC_AMT,P_NEW_FD_LC_AMT),
             FDH_N_CR_DT         = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_CR_DT,P_NEW_FD_CR_DT),
             FDH_N_DEL_FLAG      = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_DEL_FLAG,P_NEW_FD_DEL_FLAG),
             FDH_N_CR_UID        = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_CR_UID,P_NEW_FD_CR_UID),
             FDH_N_UPD_DT        = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_UPD_DT,P_NEW_FD_UPD_DT),
             FDH_N_UPD_UID       = DECODE(P_TRG_MODE,'D',
					P_OLD_FD_UPD_UID,P_NEW_FD_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_IN(
         P_OLD_FI_SYS_ID               IN                 NUMBER,
         P_OLD_FI_POL_SYS_ID           IN                 NUMBER,
         P_OLD_FI_ORG_FC_SI            IN                 NUMBER,
         P_OLD_FI_ORG_LC_SI            IN                 NUMBER,
         P_OLD_FI_ORG_FC_PREM          IN                 NUMBER,
         P_OLD_FI_ORG_LC_PREM          IN                 NUMBER,
         P_OLD_FI_ORG_ORG_FC_SI        IN                 NUMBER,
         P_OLD_FI_ORG_ORG_LC_SI        IN                 NUMBER,
         P_OLD_FI_ORG_ORG_FC_PREM      IN                 NUMBER,
         P_OLD_FI_ORG_ORG_LC_PREM      IN                 NUMBER,
         P_OLD_FI_REF_NO               IN                 VARCHAR2,
         P_OLD_FI_REMARKS              IN                 VARCHAR2,
         P_OLD_FI_SHARE_PERC           IN                 NUMBER,
         P_OLD_FI_SHARE_FC_SI          IN                 NUMBER,
         P_OLD_FI_SHARE_LC_SI          IN                 NUMBER,
         P_OLD_FI_SHARE_FC_PREM        IN                 NUMBER,
         P_OLD_FI_SHARE_LC_PREM        IN                 NUMBER,
         P_OLD_FI_ORG_SHARE_FC_SI      IN                 NUMBER,
         P_OLD_FI_ORG_SHARE_LC_SI      IN                 NUMBER,
         P_OLD_FI_ORG_SHARE_FC_PREM    IN                 NUMBER,
         P_OLD_FI_ORG_SHARE_LC_PREM    IN                 NUMBER,
         P_OLD_FI_CR_DT                IN                 DATE,
         P_OLD_FI_CR_UID               IN                 VARCHAR2,
         P_OLD_FI_UPD_DT               IN                 DATE,
         P_OLD_FI_UPD_UID              IN                 VARCHAR2,
         P_NEW_FI_SYS_ID               IN                 NUMBER,
         P_NEW_FI_POL_SYS_ID           IN                 NUMBER,
         P_NEW_FI_ORG_FC_SI            IN                 NUMBER,
         P_NEW_FI_ORG_LC_SI            IN                 NUMBER,
         P_NEW_FI_ORG_FC_PREM          IN                 NUMBER,
         P_NEW_FI_ORG_LC_PREM          IN                 NUMBER,
         P_NEW_FI_ORG_ORG_FC_SI        IN                 NUMBER,
         P_NEW_FI_ORG_ORG_LC_SI        IN                 NUMBER,
         P_NEW_FI_ORG_ORG_FC_PREM      IN                 NUMBER,
         P_NEW_FI_ORG_ORG_LC_PREM      IN                 NUMBER,
         P_NEW_FI_REF_NO               IN                 VARCHAR2,
         P_NEW_FI_REMARKS              IN                 VARCHAR2,
         P_NEW_FI_SHARE_PERC           IN                 NUMBER,
         P_NEW_FI_SHARE_FC_SI          IN                 NUMBER,
         P_NEW_FI_SHARE_LC_SI          IN                 NUMBER,
         P_NEW_FI_SHARE_FC_PREM        IN                 NUMBER,
         P_NEW_FI_SHARE_LC_PREM        IN                 NUMBER,
         P_NEW_FI_ORG_SHARE_FC_SI      IN                 NUMBER,
         P_NEW_FI_ORG_SHARE_LC_SI      IN                 NUMBER,
         P_NEW_FI_ORG_SHARE_FC_PREM    IN                 NUMBER,
         P_NEW_FI_ORG_SHARE_LC_PREM    IN                 NUMBER,
         P_NEW_FI_CR_DT                IN                 DATE,
         P_NEW_FI_CR_UID               IN                 VARCHAR2,
         P_NEW_FI_UPD_DT               IN                 DATE,
         P_NEW_FI_UPD_UID              IN                 VARCHAR2,
         P_TRG_MODE                    IN                 VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_FAC_IN
       WHERE  FIH_SYS_ID     = NVL(P_OLD_FI_SYS_ID, P_NEW_FI_SYS_ID)
       AND    FIH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FIH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID :=NVL(P_OLD_FI_POL_SYS_ID, P_NEW_FI_POL_SYS_ID) ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_FAC_IN (
	     FIH_SYS_ID, FIH_END_NO_IDX, FIH_POL_SYS_ID,
	     FIH_O_ORG_FC_SI, FIH_O_ORG_LC_SI, FIH_O_ORG_FC_PREM,
	     FIH_O_ORG_LC_PREM, FIH_O_REF_NO, FIH_O_REMARKS, FIH_O_SHARE_PERC,
	     FIH_O_SHARE_FC_SI, FIH_O_SHARE_LC_SI, FIH_O_SHARE_FC_PREM,
	     FIH_O_SHARE_LC_PREM, FIH_O_CR_DT, FIH_O_CR_UID, FIH_O_UPD_DT,
	     FIH_O_UPD_UID, FIH_N_ORG_FC_SI, FIH_N_ORG_LC_SI,
	     FIH_N_ORG_FC_PREM, FIH_N_ORG_LC_PREM, FIH_N_REF_NO,
	     FIH_N_REMARKS, FIH_N_SHARE_PERC, FIH_N_SHARE_FC_SI,
	     FIH_N_SHARE_LC_SI, FIH_N_SHARE_FC_PREM, FIH_N_SHARE_LC_PREM,
	     FIH_N_CR_DT, FIH_N_CR_UID, FIH_N_UPD_DT, FIH_N_UPD_UID)
      VALUES (
	     DECODE(P_TRG_MODE, 'D', P_OLD_FI_SYS_ID, P_NEW_FI_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_FI_POL_SYS_ID, P_NEW_FI_POL_SYS_ID),
             P_OLD_FI_ORG_ORG_FC_SI, P_OLD_FI_ORG_ORG_LC_SI,
	     P_OLD_FI_ORG_ORG_FC_PREM, P_OLD_FI_ORG_ORG_LC_PREM,
	     P_OLD_FI_REF_NO, P_OLD_FI_REMARKS,
             P_OLD_FI_SHARE_PERC, P_OLD_FI_ORG_SHARE_FC_SI,
	     P_OLD_FI_ORG_SHARE_LC_SI, P_OLD_FI_ORG_SHARE_FC_PREM,
	     P_OLD_FI_ORG_SHARE_LC_PREM,
             P_OLD_FI_CR_DT, P_OLD_FI_CR_UID, P_OLD_FI_UPD_DT, P_OLD_FI_UPD_UID,
             P_NEW_FI_ORG_FC_SI, P_NEW_FI_ORG_LC_SI, P_NEW_FI_ORG_FC_PREM,
             P_NEW_FI_ORG_LC_PREM, P_NEW_FI_REF_NO, P_NEW_FI_REMARKS,
	     P_NEW_FI_SHARE_PERC, P_NEW_FI_SHARE_FC_SI, P_NEW_FI_SHARE_LC_SI,
	     P_NEW_FI_SHARE_FC_PREM, P_NEW_FI_SHARE_LC_PREM, P_NEW_FI_CR_DT,
             P_NEW_FI_CR_UID, P_NEW_FI_UPD_DT, P_NEW_FI_UPD_UID);
   ELSE
Press <Enter> to continue...
      UPDATE PH_FAC_IN
      SET    FIH_N_ORG_FC_SI     = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_ORG_FC_SI,P_NEW_FI_ORG_FC_SI),
             FIH_N_ORG_LC_SI     = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_ORG_LC_SI,P_NEW_FI_ORG_LC_SI),
             FIH_N_ORG_FC_PREM   = DECODE(P_TRG_MODE, 'D', P_OLD_FI_ORG_FC_PREM,
					P_NEW_FI_ORG_FC_PREM),
             FIH_N_ORG_LC_PREM   = DECODE(P_TRG_MODE, 'D', P_OLD_FI_ORG_LC_PREM,
					P_NEW_FI_ORG_LC_PREM),
             FIH_N_REF_NO        = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_REF_NO,P_NEW_FI_REF_NO),
             FIH_N_REMARKS       = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_REMARKS,P_NEW_FI_REMARKS),
             FIH_N_SHARE_PERC    = DECODE(P_TRG_MODE, 'D', P_OLD_FI_SHARE_PERC,
					P_NEW_FI_SHARE_PERC),
             FIH_N_SHARE_FC_SI   = DECODE(P_TRG_MODE, 'D', P_OLD_FI_SHARE_FC_SI,
					P_NEW_FI_SHARE_FC_SI),
             FIH_N_SHARE_LC_SI   = DECODE(P_TRG_MODE, 'D', P_OLD_FI_SHARE_LC_SI,
					P_NEW_FI_SHARE_LC_SI),
             FIH_N_SHARE_FC_PREM = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_SHARE_FC_PREM,
					P_NEW_FI_SHARE_FC_PREM),
             FIH_N_SHARE_LC_PREM = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_SHARE_LC_PREM,
					P_NEW_FI_SHARE_LC_PREM),
             FIH_N_CR_DT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_CR_DT,P_NEW_FI_CR_DT),
             FIH_N_CR_UID        = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_CR_UID,P_NEW_FI_CR_UID),
             FIH_N_UPD_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_UPD_DT,P_NEW_FI_UPD_DT),
             FIH_N_UPD_UID       = DECODE(P_TRG_MODE, 'D',
					P_OLD_FI_UPD_UID,P_NEW_FI_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_IN_COMM_TAX(
        P_OLD_FICT_SYS_ID             IN             NUMBER,
        P_OLD_FICT_FI_SYS_ID          IN        NUMBER,
        P_OLD_FICT_TYPE               IN        VARCHAR2,
        P_OLD_FICT_CT_CODE            IN        VARCHAR2,
        P_OLD_FICT_CT_PERC            IN        NUMBER,
        P_OLD_FICT_FC_AMT             IN        NUMBER,
        P_OLD_FICT_LC_AMT             IN        NUMBER,
        P_OLD_FICT_ORG_FC_AMT         IN        NUMBER,
        P_OLD_FICT_ORG_LC_AMT         IN        NUMBER,
        P_OLD_FICT_DEL_FLAG           IN        VARCHAR2,
        P_OLD_FICT_CR_DT              IN        DATE,
        P_OLD_FICT_CR_UID             IN        VARCHAR2,
        P_OLD_FICT_UPD_DT             IN        DATE,
        P_OLD_FICT_UPD_UID            IN        VARCHAR2,
        P_NEW_FICT_SYS_ID             IN        NUMBER,
        P_NEW_FICT_FI_SYS_ID          IN        NUMBER,
        P_NEW_FICT_TYPE               IN        VARCHAR2,
        P_NEW_FICT_CT_CODE            IN        VARCHAR2,
        P_NEW_FICT_CT_PERC            IN        NUMBER,
        P_NEW_FICT_FC_AMT             IN        NUMBER,
        P_NEW_FICT_LC_AMT             IN        NUMBER,
        P_NEW_FICT_ORG_FC_AMT         IN        NUMBER,
        P_NEW_FICT_ORG_LC_AMT         IN        NUMBER,
        P_NEW_FICT_DEL_FLAG           IN        VARCHAR2,
        P_NEW_FICT_CR_DT              IN        DATE,
        P_NEW_FICT_CR_UID             IN        VARCHAR2,
        P_NEW_FICT_UPD_DT             IN        DATE,
        P_NEW_FICT_UPD_UID            IN        VARCHAR2,
        P_TRG_MODE                    IN        VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_FAC_IN_COMM_TAX
       WHERE  FICTH_SYS_ID     = NVL(P_OLD_FICT_SYS_ID, P_NEW_FICT_SYS_ID)
       AND    FICTH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FICTH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT FI_POL_SYS_ID
       FROM   PT_FAC_IN
       WHERE  FI_SYS_ID   = NVL(P_OLD_FICT_FI_SYS_ID, P_NEW_FICT_FI_SYS_ID) ;
BEGIN
   /* SELECTing Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20002,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_FAC_IN_COMM_TAX (
	     FICTH_SYS_ID, FICTH_END_NO_IDX, FICTH_FI_SYS_ID,
             FICTH_O_TYPE, FICTH_O_CT_CODE, FICTH_O_CT_PERC,
             FICTH_O_FC_AMT, FICTH_O_LC_AMT, FICTH_O_DEL_FLAG,
             FICTH_O_CR_DT, FICTH_O_CR_UID, FICTH_O_UPD_DT,
             FICTH_O_UPD_UID, FICTH_N_TYPE, FICTH_N_CT_CODE,
             FICTH_N_CT_PERC, FICTH_N_FC_AMT, FICTH_N_LC_AMT,
             FICTH_N_DEL_FLAG, FICTH_N_CR_DT, FICTH_N_CR_UID,
             FICTH_N_UPD_DT, FICTH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_FICT_SYS_ID, P_NEW_FICT_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_FICT_FI_SYS_ID,
                                     P_NEW_FICT_FI_SYS_ID),
             P_OLD_FICT_TYPE, P_OLD_FICT_CT_CODE, P_OLD_FICT_CT_PERC,
	     P_OLD_FICT_ORG_FC_AMT, P_OLD_FICT_ORG_LC_AMT, P_OLD_FICT_DEL_FLAG,
	     P_OLD_FICT_CR_DT, P_OLD_FICT_CR_UID, P_OLD_FICT_UPD_DT,
	     P_OLD_FICT_UPD_UID, P_NEW_FICT_TYPE, P_NEW_FICT_CT_CODE,
             P_NEW_FICT_CT_PERC, P_NEW_FICT_FC_AMT, P_NEW_FICT_LC_AMT,
             P_NEW_FICT_DEL_FLAG, P_NEW_FICT_CR_DT, P_NEW_FICT_CR_UID,
	     P_NEW_FICT_UPD_DT,
             P_NEW_FICT_UPD_UID);
   ELSE
      UPDATE PH_FAC_IN_COMM_TAX
      SET    FICTH_N_TYPE     = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_TYPE,P_NEW_FICT_TYPE),
             FICTH_N_CT_CODE  = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_CT_CODE,P_NEW_FICT_CT_CODE),
             FICTH_N_CT_PERC  = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_CT_PERC,P_NEW_FICT_CT_PERC),
             FICTH_N_FC_AMT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_FC_AMT,P_NEW_FICT_FC_AMT),
             FICTH_N_LC_AMT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_LC_AMT,P_NEW_FICT_LC_AMT),
             FICTH_N_DEL_FLAG = DECODE(P_TRG_MODE, 'D', P_OLD_FICT_DEL_FLAG,
					P_NEW_FICT_DEL_FLAG),
             FICTH_N_CR_DT    = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_CR_DT,P_NEW_FICT_CR_DT),
             FICTH_N_CR_UID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_CR_UID,P_NEW_FICT_CR_UID),
             FICTH_N_UPD_DT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_UPD_DT,P_NEW_FICT_UPD_DT),
             FICTH_N_UPD_UID  = DECODE(P_TRG_MODE, 'D',
					P_OLD_FICT_UPD_UID,P_NEW_FICT_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_OUT (
       P_OLD_FO_SYS_ID                    IN NUMBER,
       P_OLD_FO_POL_SYS_ID                IN NUMBER,
       P_OLD_FO_RISK_SYS_ID               IN NUMBER,
       P_OLD_FO_RISK_ID                   IN VARCHAR2,
       P_OLD_FO_WAR_YN                    IN VARCHAR2,
       P_OLD_FO_LEVEL                     IN VARCHAR2,
       P_OLD_FO_TYPE                      IN VARCHAR2,
       P_OLD_FO_SI_CURR_CODE              IN VARCHAR2,
       P_OLD_FO_ORG_FC_FAC_SI             IN NUMBER,
       P_OLD_FO_ORG_LC_FAC_SI             IN NUMBER,
       P_OLD_FO_FC_FAC_SI                 IN NUMBER,
       P_OLD_FO_LC_FAC_SI                 IN NUMBER,
       P_OLD_FO_ORG_FC_FAC_PREM           IN NUMBER,
       P_OLD_FO_ORG_LC_FAC_PREM           IN NUMBER,
       P_OLD_FO_FC_FAC_PREM               IN NUMBER,
       P_OLD_FO_LC_FAC_PREM               IN NUMBER,
       P_OLD_FO_FAC_PERC                  IN NUMBER,
       P_OLD_FO_COINS_PERC                IN NUMBER,
       P_OLD_FO_LOCAL_PERC                IN NUMBER,
       P_OLD_FO_DEL_FLAG                  IN VARCHAR2,
       P_OLD_FO_CR_DT                     IN DATE,
       P_OLD_FO_CR_UID                    IN VARCHAR2,
       P_OLD_FO_UPD_DT                    IN DATE,
       P_OLD_FO_UPD_UID                   IN VARCHAR2,
       P_NEW_FO_SYS_ID                    IN NUMBER,
       P_NEW_FO_POL_SYS_ID                IN NUMBER,
       P_NEW_FO_RISK_SYS_ID               IN NUMBER,
       P_NEW_FO_RISK_ID                   IN VARCHAR2,
       P_NEW_FO_WAR_YN                    IN VARCHAR2,
       P_NEW_FO_LEVEL                     IN VARCHAR2,
       P_NEW_FO_TYPE                      IN VARCHAR2,
       P_NEW_FO_SI_CURR_CODE              IN VARCHAR2,
       P_NEW_FO_ORG_FC_FAC_SI             IN NUMBER,
       P_NEW_FO_ORG_LC_FAC_SI             IN NUMBER,
       P_NEW_FO_FC_FAC_SI                 IN NUMBER,
       P_NEW_FO_LC_FAC_SI                 IN NUMBER,
       P_NEW_FO_ORG_FC_FAC_PREM           IN NUMBER,
       P_NEW_FO_ORG_LC_FAC_PREM           IN NUMBER,
       P_NEW_FO_FC_FAC_PREM               IN NUMBER,
       P_NEW_FO_LC_FAC_PREM               IN NUMBER,
       P_NEW_FO_FAC_PERC                  IN NUMBER,
       P_NEW_FO_COINS_PERC                IN NUMBER,
       P_NEW_FO_LOCAL_PERC                IN NUMBER,
       P_NEW_FO_DEL_FLAG                  IN VARCHAR2,
       P_NEW_FO_CR_DT                     IN DATE,
       P_NEW_FO_CR_UID                    IN VARCHAR2,
       P_NEW_FO_UPD_DT                    IN DATE,
       P_NEW_FO_UPD_UID                   IN VARCHAR2,
       P_TRG_MODE                         IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_FAC_CLOSE_FLAG       PT_POLICY.POL_FAC_CLOSE_FLAG%TYPE;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS, POL_FAC_CLOSE_FLAG
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = NVL(P_OLD_FO_POL_SYS_ID, P_NEW_FO_POL_SYS_ID) ;
CURSOR C2 IS
       SELECT 'X'
       FROM   PH_FAC_OUT
       WHERE  FOH_SYS_ID  = NVL(P_OLD_FO_SYS_ID, P_NEW_FO_SYS_ID)
       AND    FOH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FOH_N_LEVEL ;
BEGIN
   IF C1%ISOPEN THEN
      CLOSE C1 ;
   END IF;
   OPEN C1 ;
   FETCH C1 INTO M_END_NO_IDX, M_APPRV_STATUS, M_FAC_CLOSE_FLAG ;
   IF C1%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C1 ;
   /* Nothing is to be done, if it is Approved */
   IF (NVL(M_APPRV_STATUS, 'N') != 'N' AND NVL(M_FAC_CLOSE_FLAG,'N') != 'N' ) THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX,0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX,0) - 1 ;
   IF C2%ISOPEN THEN
      CLOSE C2;
   END IF ;
   OPEN C2 ;
   FETCH C2 INTO M_TEMP ;
   IF C2%NOTFOUND THEN
      INSERT INTO PH_FAC_OUT (
             FOH_SYS_ID, FOH_END_NO_IDX, FOH_POL_SYS_ID, FOH_RISK_SYS_ID,
             FOH_RISK_ID,FOH_WAR_YN, FOH_O_LEVEL, FOH_O_TYPE, FOH_O_SI_CURR_CODE,
             FOH_O_FC_FAC_SI, FOH_O_LC_FAC_SI, FOH_O_FC_FAC_PREM,
             FOH_O_LC_FAC_PREM, FOH_O_FAC_PERC, FOH_O_COINS_PERC,FOH_O_LOCAL_PERC,
             FOH_O_DEL_FLAG, FOH_O_CR_DT, FOH_O_CR_UID, FOH_O_UPD_DT,
             FOH_O_UPD_UID, FOH_N_LEVEL, FOH_N_TYPE, FOH_N_SI_CURR_CODE,
             FOH_N_FC_FAC_SI, FOH_N_LC_FAC_SI, FOH_N_FC_FAC_PREM,
             FOH_N_LC_FAC_PREM, FOH_N_FAC_PERC, FOH_N_COINS_PERC,FOH_N_LOCAL_PERC,
             FOH_N_DEL_FLAG, FOH_N_CR_DT, FOH_N_CR_UID, FOH_N_UPD_DT,
             FOH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_FO_SYS_ID, P_NEW_FO_SYS_ID),
	     M_END_NO_IDX,
	     DECODE(P_TRG_MODE, 'D', P_OLD_FO_POL_SYS_ID,
				     P_NEW_FO_POL_SYS_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_FO_RISK_SYS_ID,
				     P_NEW_FO_RISK_SYS_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_FO_RISK_ID, P_NEW_FO_RISK_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_FO_WAR_YN, P_NEW_FO_WAR_YN),
	     P_OLD_FO_LEVEL, P_OLD_FO_TYPE, P_OLD_FO_SI_CURR_CODE,
	     P_OLD_FO_FC_FAC_SI, P_OLD_FO_LC_FAC_SI, P_OLD_FO_FC_FAC_PREM,
             P_OLD_FO_LC_FAC_PREM, P_OLD_FO_FAC_PERC, P_OLD_FO_COINS_PERC,P_OLD_FO_LOCAL_PERC,
             P_OLD_FO_DEL_FLAG, P_OLD_FO_CR_DT, P_OLD_FO_CR_UID,
	     P_OLD_FO_UPD_DT, P_OLD_FO_UPD_UID,
	     P_NEW_FO_LEVEL, P_NEW_FO_TYPE, P_NEW_FO_SI_CURR_CODE,
             P_NEW_FO_FC_FAC_SI, P_NEW_FO_LC_FAC_SI, P_NEW_FO_FC_FAC_PREM,
             P_NEW_FO_LC_FAC_PREM, P_NEW_FO_FAC_PERC, P_NEW_FO_COINS_PERC, P_NEW_FO_LOCAL_PERC,
             P_NEW_FO_DEL_FLAG, P_NEW_FO_CR_DT, P_NEW_FO_CR_UID,
	     P_NEW_FO_UPD_DT, P_NEW_FO_UPD_UID) ;
   ELSE
      UPDATE PH_FAC_OUT
      SET    FOH_N_LEVEL        = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_LEVEL,P_NEW_FO_LEVEL),
	     FOH_N_TYPE         = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_TYPE,P_NEW_FO_TYPE),
	     FOH_N_SI_CURR_CODE = DECODE(P_TRG_MODE,'D', P_OLD_FO_SI_CURR_CODE,
					P_NEW_FO_SI_CURR_CODE),
         FOH_N_FC_FAC_SI    = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_FC_FAC_SI,P_NEW_FO_FC_FAC_SI),
	     FOH_N_LC_FAC_SI    = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_LC_FAC_SI,P_NEW_FO_LC_FAC_SI),
	     FOH_N_FC_FAC_PREM  = DECODE(P_TRG_MODE,'D', P_OLD_FO_FC_FAC_PREM,
					P_NEW_FO_FC_FAC_PREM),
         FOH_N_LC_FAC_PREM  = DECODE(P_TRG_MODE,'D', P_OLD_FO_LC_FAC_PREM,
					P_NEW_FO_LC_FAC_PREM),
	     FOH_N_FAC_PERC     = DECODE(P_TRG_MODE,'D', P_OLD_FO_FAC_PERC,
					P_NEW_FO_FAC_PERC),
	     FOH_N_COINS_PERC   = DECODE(P_TRG_MODE,'D', P_OLD_FO_COINS_PERC,
					P_NEW_FO_COINS_PERC),
	     FOH_N_LOCAL_PERC   = DECODE(P_TRG_MODE,'D', P_OLD_FO_LOCAL_PERC,
					  P_NEW_FO_LOCAL_PERC),
         FOH_N_DEL_FLAG     = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_DEL_FLAG,P_NEW_FO_DEL_FLAG),
	     FOH_N_CR_DT        = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_CR_DT,P_NEW_FO_CR_DT),
	     FOH_N_CR_UID       = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_CR_UID,P_NEW_FO_CR_UID),
	     FOH_N_UPD_DT       = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_UPD_DT,P_NEW_FO_UPD_DT),
         FOH_N_UPD_UID      = DECODE(P_TRG_MODE,'D',
					P_OLD_FO_UPD_UID,P_NEW_FO_UPD_UID)
      WHERE CURRENT OF C2 ;
   END IF ;
   CLOSE C2 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_FAC_PART_CUST (
       P_OLD_FPCU_SYS_ID                  IN NUMBER,
       P_OLD_FPCU_FO_SYS_ID               IN NUMBER,
       P_OLD_FPCU_RISK_SYS_ID             IN NUMBER,
       P_OLD_FPCU_COINS_YN                IN VARCHAR2,
       P_OLD_FPCU_LOCAL_YN                IN VARCHAR2,
       P_OLD_FPCU_CUST_CODE               IN VARCHAR2,
       P_OLD_FPCU_SHARE_PERC              IN NUMBER,
       P_OLD_FPCU_SI_CURR_CODE            IN VARCHAR2,
       P_OLD_FPCU_ORG_FC_SI               IN NUMBER,
       P_OLD_FPCU_ORG_LC_SI               IN NUMBER,
       P_OLD_FPCU_FC_SI                   IN NUMBER,
       P_OLD_FPCU_LC_SI                   IN NUMBER,
       P_OLD_FPCU_ORG_FC_PREM             IN NUMBER,
       P_OLD_FPCU_ORG_LC_PREM             IN NUMBER,
       P_OLD_FPCU_FC_PREM                 IN NUMBER,
       P_OLD_FPCU_LC_PREM                 IN NUMBER,
       P_OLD_FPCU_DEL_FLAG                IN VARCHAR2,
       P_OLD_FPCU_RETRO_YN                IN VARCHAR2,
       P_OLD_FPCU_RETRO_SHARE_PERC        IN NUMBER,
       P_OLD_FPCU_RETRO_FC_SI             IN NUMBER,
       P_OLD_FPCU_RETRO_LC_SI             IN NUMBER,
       P_OLD_FPCU_RETRO_FC_PREM           IN NUMBER,
       P_OLD_FPCU_RETRO_LC_PREM           IN NUMBER,
       P_OLD_FPCU_ORG_RETRO_FC_SI         IN NUMBER,
       P_OLD_FPCU_ORG_RETRO_LC_SI         IN NUMBER,
       P_OLD_FPCU_ORG_RETRO_FC_PREM       IN NUMBER,
       P_OLD_FPCU_ORG_RETRO_LC_PREM       IN NUMBER,
       P_OLD_FPCU_RETRO_DEL_FLAG          IN VARCHAR2,
       P_OLD_FPCU_CR_DT                   IN DATE,
       P_OLD_FPCU_CR_UID                  IN VARCHAR2,
       P_OLD_FPCU_UPD_DT                  IN DATE,
       P_OLD_FPCU_UPD_UID                 IN VARCHAR2,
       P_NEW_FPCU_SYS_ID                  IN NUMBER,
       P_NEW_FPCU_FO_SYS_ID               IN NUMBER,
       P_NEW_FPCU_RISK_SYS_ID             IN NUMBER,
       P_NEW_FPCU_COINS_YN                IN VARCHAR2,
       P_NEW_FPCU_LOCAL_YN                IN VARCHAR2,
       P_NEW_FPCU_CUST_CODE               IN VARCHAR2,
       P_NEW_FPCU_SHARE_PERC              IN NUMBER,
       P_NEW_FPCU_SI_CURR_CODE            IN VARCHAR2,
       P_NEW_FPCU_ORG_FC_SI               IN NUMBER,
       P_NEW_FPCU_ORG_LC_SI               IN NUMBER,
       P_NEW_FPCU_FC_SI                   IN NUMBER,
       P_NEW_FPCU_LC_SI                   IN NUMBER,
       P_NEW_FPCU_ORG_FC_PREM             IN NUMBER,
       P_NEW_FPCU_ORG_LC_PREM             IN NUMBER,
       P_NEW_FPCU_FC_PREM                 IN NUMBER,
       P_NEW_FPCU_LC_PREM                 IN NUMBER,
       P_NEW_FPCU_DEL_FLAG                IN VARCHAR2,
       P_NEW_FPCU_RETRO_YN                IN VARCHAR2,
       P_NEW_FPCU_RETRO_SHARE_PERC        IN NUMBER,
       P_NEW_FPCU_RETRO_FC_SI             IN NUMBER,
       P_NEW_FPCU_RETRO_LC_SI             IN NUMBER,
       P_NEW_FPCU_RETRO_FC_PREM           IN NUMBER,
       P_NEW_FPCU_RETRO_LC_PREM           IN NUMBER,
       P_NEW_FPCU_ORG_RETRO_FC_SI         IN NUMBER,
       P_NEW_FPCU_ORG_RETRO_LC_SI         IN NUMBER,
       P_NEW_FPCU_ORG_RETRO_FC_PREM       IN NUMBER,
       P_NEW_FPCU_ORG_RETRO_LC_PREM       IN NUMBER,
       P_NEW_FPCU_RETRO_DEL_FLAG          IN VARCHAR2,
       P_NEW_FPCU_CR_DT                   IN DATE,
       P_NEW_FPCU_CR_UID                  IN VARCHAR2,
       P_NEW_FPCU_UPD_DT                  IN DATE,
       P_NEW_FPCU_UPD_UID                 IN VARCHAR2,
       P_TRG_MODE                         IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE;
M_FAC_CLOSE_FLAG       PT_POLICY.POL_FAC_CLOSE_FLAG%TYPE;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_FAC_PART_CUST
       WHERE  FPCUH_SYS_ID     = NVL(P_OLD_FPCU_SYS_ID, P_NEW_FPCU_SYS_ID)
       AND    FPCUH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF FPCUH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS, POL_FAC_CLOSE_FLAG
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT FO_POL_SYS_ID
       FROM   PT_FAC_OUT
       WHERE  FO_SYS_ID = NVL(P_OLD_FPCU_FO_SYS_ID, P_NEW_FPCU_FO_SYS_ID) ;
BEGIN
   /* Selecting Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* Selecting Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS,M_FAC_CLOSE_FLAG ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF (NVL(M_APPRV_STATUS, 'N') != 'N' AND NVL(M_FAC_CLOSE_FLAG,'N') != 'N' ) THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX,0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX,0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_FAC_PART_CUST (
             FPCUH_SYS_ID, FPCUH_FO_SYS_ID, FPCUH_END_NO_IDX,
             FPCUH_RISK_SYS_ID, FPCUH_COINS_YN, FPCUH_O_CUST_CODE,
             FPCUH_O_SHARE_PERC, FPCUH_O_SI_CURR_CODE, FPCUH_O_FC_SI,
             FPCUH_O_LC_SI, FPCUH_O_FC_PREM, FPCUH_O_LC_PREM,
             FPCUH_O_DEL_FLAG, FPCUH_O_RETRO_YN, FPCUH_O_RETRO_SHARE_PERC,
             FPCUH_O_RETRO_FC_SI, FPCUH_O_RETRO_LC_SI, FPCUH_O_RETRO_FC_PREM,
             FPCUH_O_RETRO_LC_PREM, FPCUH_O_RETRO_DEL_FLAG, FPCUH_O_CR_DT,
             FPCUH_O_CR_UID, FPCUH_O_UPD_DT, FPCUH_O_UPD_UID,
             FPCUH_N_CUST_CODE, FPCUH_N_SHARE_PERC, FPCUH_N_SI_CURR_CODE,
             FPCUH_N_FC_SI, FPCUH_N_LC_SI, FPCUH_N_FC_PREM, FPCUH_N_LC_PREM,
             FPCUH_N_DEL_FLAG, FPCUH_N_RETRO_YN, FPCUH_N_RETRO_SHARE_PERC,
             FPCUH_N_RETRO_FC_SI, FPCUH_N_RETRO_LC_SI, FPCUH_N_RETRO_FC_PREM,
             FPCUH_N_RETRO_LC_PREM, FPCUH_N_RETRO_DEL_FLAG, FPCUH_N_CR_DT,
             FPCUH_N_CR_UID, FPCUH_N_UPD_DT, FPCUH_N_UPD_UID,
             FPCUH_LOCAL_YN)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_FPCU_SYS_ID, P_NEW_FPCU_SYS_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_FPCU_FO_SYS_ID,
				     P_NEW_FPCU_FO_SYS_ID),
	     M_END_NO_IDX,
	     DECODE(P_TRG_MODE, 'D', P_OLD_FPCU_RISK_SYS_ID,
				     P_NEW_FPCU_RISK_SYS_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_FPCU_COINS_YN, P_NEW_FPCU_COINS_YN),
             P_OLD_FPCU_CUST_CODE,
             P_OLD_FPCU_SHARE_PERC, P_OLD_FPCU_SI_CURR_CODE, P_OLD_FPCU_FC_SI,
             P_OLD_FPCU_LC_SI, P_OLD_FPCU_FC_PREM, P_OLD_FPCU_LC_PREM,
             P_OLD_FPCU_DEL_FLAG, P_OLD_FPCU_RETRO_YN,
	     P_OLD_FPCU_RETRO_SHARE_PERC, P_OLD_FPCU_RETRO_FC_SI,
	     P_OLD_FPCU_RETRO_LC_SI, P_OLD_FPCU_RETRO_FC_PREM,
             P_OLD_FPCU_RETRO_LC_PREM, P_OLD_FPCU_RETRO_DEL_FLAG,
	     P_OLD_FPCU_CR_DT, P_OLD_FPCU_CR_UID, P_OLD_FPCU_UPD_DT,
	     P_OLD_FPCU_UPD_UID,
             P_NEW_FPCU_CUST_CODE, P_NEW_FPCU_SHARE_PERC,
	     P_NEW_FPCU_SI_CURR_CODE, P_NEW_FPCU_FC_SI,
	     P_NEW_FPCU_LC_SI, P_NEW_FPCU_FC_PREM, P_NEW_FPCU_LC_PREM,
             P_NEW_FPCU_DEL_FLAG, P_NEW_FPCU_RETRO_YN,
	     P_NEW_FPCU_RETRO_SHARE_PERC, P_NEW_FPCU_RETRO_FC_SI,
	     P_NEW_FPCU_RETRO_LC_SI, P_NEW_FPCU_RETRO_FC_PREM,
             P_NEW_FPCU_RETRO_LC_PREM, P_NEW_FPCU_RETRO_DEL_FLAG,
	     P_NEW_FPCU_CR_DT, P_NEW_FPCU_CR_UID, P_NEW_FPCU_UPD_DT,
	     P_NEW_FPCU_UPD_UID,
   	     DECODE(P_TRG_MODE, 'D', P_OLD_FPCU_LOCAL_YN, P_NEW_FPCU_LOCAL_YN)) ;
   ELSE
      UPDATE PH_FAC_PART_CUST
      SET    FPCUH_N_CUST_CODE        = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_CUST_CODE,
						P_NEW_FPCU_CUST_CODE),
	     FPCUH_N_SHARE_PERC       = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_SHARE_PERC,
						P_NEW_FPCU_SHARE_PERC),
	     FPCUH_N_SI_CURR_CODE     = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_SI_CURR_CODE,
						P_NEW_FPCU_SI_CURR_CODE),
             FPCUH_N_FC_SI            = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_FC_SI,
						P_NEW_FPCU_FC_SI),
             FPCUH_N_LC_SI            = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_LC_SI,
						P_NEW_FPCU_LC_SI),
             FPCUH_N_FC_PREM          = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_FC_PREM,
						P_NEW_FPCU_FC_PREM),
             FPCUH_N_LC_PREM          = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_LC_PREM,
						P_NEW_FPCU_LC_PREM),
             FPCUH_N_DEL_FLAG         = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_DEL_FLAG,
						P_NEW_FPCU_DEL_FLAG),
             FPCUH_N_RETRO_YN         = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_YN,
						P_NEW_FPCU_RETRO_YN),
             FPCUH_N_RETRO_SHARE_PERC = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_SHARE_PERC,
						P_NEW_FPCU_RETRO_SHARE_PERC),
             FPCUH_N_RETRO_FC_SI      = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_FC_SI,
						P_NEW_FPCU_RETRO_FC_SI),
             FPCUH_N_RETRO_LC_SI      = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_LC_SI,
						P_NEW_FPCU_RETRO_LC_SI),
             FPCUH_N_RETRO_FC_PREM    = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_FC_PREM,
						P_NEW_FPCU_RETRO_FC_PREM),
             FPCUH_N_RETRO_LC_PREM    = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_LC_PREM,
						P_NEW_FPCU_RETRO_LC_PREM),
             FPCUH_N_RETRO_DEL_FLAG   = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_RETRO_DEL_FLAG,
						P_NEW_FPCU_RETRO_DEL_FLAG),
             FPCUH_N_CR_DT            = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_CR_DT,
						P_NEW_FPCU_CR_DT),
             FPCUH_N_CR_UID           = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_CR_UID,
						P_NEW_FPCU_CR_UID),
             FPCUH_N_UPD_DT           = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_UPD_DT,
						P_NEW_FPCU_UPD_DT),
             FPCUH_N_UPD_UID          = DECODE(P_TRG_MODE,'D',
						P_OLD_FPCU_UPD_UID,
						P_NEW_FPCU_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE  STP_PT_INST_PREM
      (P_OLD_IP_SYS_ID      IN NUMBER,
       P_OLD_IP_POL_SYS_ID  IN NUMBER,
       P_OLD_IP_DUE_DT      IN DATE,
       P_OLD_IP_FC_PREM     IN NUMBER,
       P_OLD_IP_LC_PREM     IN NUMBER,
       P_OLD_IP_GEN_DN_YN   IN VARCHAR2,
       P_OLD_IP_PAID_YN     IN VARCHAR2,
       P_OLD_IP_DEL_FLAG    IN VARCHAR2,
       P_OLD_IP_CR_DT       IN DATE,
       P_OLD_IP_CR_UID      IN VARCHAR2,
       P_OLD_IP_UPD_DT      IN DATE,
       P_OLD_IP_UPD_UID     IN VARCHAR2,
       P_NEW_IP_SYS_ID      IN NUMBER,
       P_NEW_IP_POL_SYS_ID  IN NUMBER,
       P_NEW_IP_DUE_DT      IN DATE,
       P_NEW_IP_FC_PREM     IN NUMBER,
       P_NEW_IP_LC_PREM     IN NUMBER,
       P_NEW_IP_GEN_DN_YN   IN VARCHAR2,
       P_NEW_IP_PAID_YN     IN VARCHAR2,
       P_NEW_IP_DEL_FLAG    IN VARCHAR2,
       P_NEW_IP_CR_DT       IN DATE,
       P_NEW_IP_CR_UID      IN VARCHAR2,
       P_NEW_IP_UPD_DT      IN DATE,
       P_NEW_IP_UPD_UID     IN VARCHAR2,
       P_TRG_MODE           IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_INST_PREM
       WHERE  IPH_SYS_ID     = NVL(P_OLD_IP_SYS_ID, P_NEW_IP_SYS_ID)
       AND    IPH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF IPH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_IP_POL_SYS_ID, P_NEW_IP_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1;
   FETCH C1 INTO M_TEMP;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_INST_PREM( IPH_SYS_ID,
                                IPH_END_NO_IDX,
                                IPH_POL_SYS_ID,
                                IPH_O_DUE_DT, IPH_O_FC_PREM,
                                IPH_O_LC_PREM, IPH_O_GEN_DN_YN,
                                IPH_O_PAID_YN, IPH_O_DEL_FLAG,
                                IPH_O_CR_DT, IPH_O_CR_UID,
                                IPH_O_UPD_DT, IPH_O_UPD_UID,
                                IPH_N_DUE_DT, IPH_N_FC_PREM,
                                IPH_N_LC_PREM, IPH_N_GEN_DN_YN,
                                IPH_N_PAID_YN, IPH_N_DEL_FLAG,
                                IPH_N_CR_DT, IPH_N_CR_UID,
                                IPH_N_UPD_DT, IPH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_IP_SYS_ID, P_NEW_IP_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_IP_POL_SYS_ID, P_NEW_IP_POL_SYS_ID),
             P_OLD_IP_DUE_DT, P_OLD_IP_FC_PREM,
             P_OLD_IP_LC_PREM, P_OLD_IP_GEN_DN_YN,
             P_OLD_IP_PAID_YN, P_OLD_IP_DEL_FLAG,
             P_OLD_IP_CR_DT, P_OLD_IP_CR_UID,
             P_OLD_IP_UPD_DT, P_OLD_IP_UPD_UID,
             P_NEW_IP_DUE_DT, P_NEW_IP_FC_PREM,
             P_NEW_IP_LC_PREM, P_NEW_IP_GEN_DN_YN,
             P_NEW_IP_PAID_YN, P_NEW_IP_DEL_FLAG,
             P_NEW_IP_CR_DT, P_NEW_IP_CR_UID,
             P_NEW_IP_UPD_DT, P_NEW_IP_UPD_UID);
   ELSE
      UPDATE  PH_INST_PREM
      SET     IPH_N_DUE_DT      = DECODE(P_TRG_MODE, 'D', P_OLD_IP_DUE_DT,
                                                          P_NEW_IP_DUE_DT),
              IPH_N_FC_PREM     = DECODE(P_TRG_MODE, 'D', P_OLD_IP_FC_PREM,
                                                          P_NEW_IP_FC_PREM),
              IPH_N_LC_PREM     = DECODE(P_TRG_MODE, 'D', P_OLD_IP_LC_PREM,
                                                          P_NEW_IP_LC_PREM),
              IPH_N_GEN_DN_YN   = DECODE(P_TRG_MODE, 'D', P_OLD_IP_GEN_DN_YN,
                                                          P_NEW_IP_GEN_DN_YN),
              IPH_N_PAID_YN     = DECODE(P_TRG_MODE, 'D', P_OLD_IP_PAID_YN,
                                                          P_NEW_IP_PAID_YN),
              IPH_N_DEL_FLAG    = DECODE(P_TRG_MODE, 'D', P_OLD_IP_DEL_FLAG,
                                                          P_NEW_IP_DEL_FLAG),
              IPH_N_CR_DT       = DECODE(P_TRG_MODE, 'D', P_OLD_IP_CR_DT,
                                                          P_NEW_IP_CR_DT),
              IPH_N_CR_UID      = DECODE(P_TRG_MODE, 'D', P_OLD_IP_CR_UID,
                                                          P_NEW_IP_CR_UID),
              IPH_N_UPD_DT      = DECODE(P_TRG_MODE, 'D', P_OLD_IP_UPD_DT,
                                                          P_NEW_IP_UPD_DT),
              IPH_N_UPD_UID     = DECODE(P_TRG_MODE, 'D', P_OLD_IP_UPD_UID,
                                                          P_NEW_IP_UPD_UID)
       WHERE CURRENT OF C1;
   END IF;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_MAINT_PERIOD(
        P_OLD_MP_SYS_ID               IN        NUMBER,
        P_OLD_MP_POL_SYS_ID           IN        NUMBER,
        P_OLD_MP_DT_ADVISE_YN         IN        VARCHAR2,
        P_OLD_MP_PERIOD_UNIT          IN        VARCHAR2,
        P_OLD_MP_PERIOD               IN        NUMBER,
        P_OLD_MP_START_DT             IN        DATE,
        P_OLD_MP_END_DT               IN        DATE,
        P_OLD_MP_TEST_START_DT        IN        DATE,
        P_OLD_MP_TEST_END_DT          IN        DATE,
        P_OLD_MP_MAINT_DESC           IN        VARCHAR2,
        P_OLD_MP_CR_DT                IN        DATE,
        P_OLD_MP_CR_UID               IN        VARCHAR2,
        P_OLD_MP_UPD_DT               IN        DATE,
        P_OLD_MP_UPD_UID              IN        VARCHAR2,
        P_NEW_MP_SYS_ID               IN        NUMBER,
        P_NEW_MP_POL_SYS_ID           IN        NUMBER,
        P_NEW_MP_DT_ADVISE_YN         IN        VARCHAR2,
        P_NEW_MP_PERIOD_UNIT          IN        VARCHAR2,
        P_NEW_MP_PERIOD               IN        NUMBER,
        P_NEW_MP_START_DT             IN        DATE,
        P_NEW_MP_END_DT               IN        DATE,
        P_NEW_MP_TEST_START_DT        IN        DATE,
        P_NEW_MP_TEST_END_DT          IN        DATE,
        P_NEW_MP_MAINT_DESC           IN        VARCHAR2,
        P_NEW_MP_CR_DT                IN        DATE,
        P_NEW_MP_CR_UID               IN        VARCHAR2,
        P_NEW_MP_UPD_DT               IN        DATE,
        P_NEW_MP_UPD_UID              IN        VARCHAR2,
        P_TRG_MODE                    IN        VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 1
       FROM   PH_MAINT_PERIOD
       WHERE  MPH_SYS_ID =  NVL(P_OLD_MP_SYS_ID, P_NEW_MP_SYS_ID)
       AND    MPH_END_NO_IDX = M_END_NO_IDX
       FOR    UPDATE OF MPH_N_DT_ADVISE_YN;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_MP_POL_SYS_ID, P_NEW_MP_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_MAINT_PERIOD( MPH_SYS_ID,
                                   MPH_END_NO_IDX,
                                   MPH_POL_SYS_ID,
                                   MPH_O_DT_ADVISE_YN, MPH_O_PERIOD_UNIT,
                                   MPH_O_PERIOD, MPH_O_START_DT,
                                   MPH_O_END_DT, MPH_O_TEST_START_DT,
                                   MPH_O_TEST_END_DT, MPH_O_MAINT_DESC,
                                   MPH_O_CR_DT, MPH_O_CR_UID,
                                   MPH_O_UPD_DT, MPH_O_UPD_UID,
                                   MPH_N_DT_ADVISE_YN, MPH_N_PERIOD_UNIT,
                                   MPH_N_PERIOD, MPH_N_START_DT,
                                   MPH_N_END_DT, MPH_N_TEST_START_DT,
                                   MPH_N_TEST_END_DT, MPH_N_MAINT_DESC,
                                   MPH_N_CR_DT, MPH_N_CR_UID,
                                   MPH_N_UPD_DT, MPH_N_UPD_UID)
      VALUES (DECODE(P_TRG_MODE, 'D', P_OLD_MP_SYS_ID, P_NEW_MP_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_MP_POL_SYS_ID, P_NEW_MP_POL_SYS_ID),
             P_OLD_MP_DT_ADVISE_YN, P_OLD_MP_PERIOD_UNIT,
             P_OLD_MP_PERIOD, P_OLD_MP_START_DT,
             P_OLD_MP_END_DT, P_OLD_MP_TEST_START_DT,
             P_OLD_MP_TEST_END_DT, P_OLD_MP_MAINT_DESC,
             P_OLD_MP_CR_DT, P_OLD_MP_CR_UID,
             P_OLD_MP_UPD_DT, P_OLD_MP_UPD_UID,
             P_NEW_MP_DT_ADVISE_YN, P_NEW_MP_PERIOD_UNIT,
             P_NEW_MP_PERIOD, P_NEW_MP_START_DT,
             P_NEW_MP_END_DT, P_NEW_MP_TEST_START_DT,
             P_NEW_MP_TEST_END_DT, P_NEW_MP_MAINT_DESC,
             P_NEW_MP_CR_DT, P_NEW_MP_CR_UID,
             P_NEW_MP_UPD_DT, P_NEW_MP_UPD_UID);
    ELSE
       UPDATE PH_MAINT_PERIOD
       SET MPH_N_DT_ADVISE_YN  = DECODE(P_TRG_MODE, 'D',  P_OLD_MP_DT_ADVISE_YN,
					P_NEW_MP_DT_ADVISE_YN),
           MPH_N_PERIOD_UNIT   = DECODE(P_TRG_MODE, 'D',  P_OLD_MP_PERIOD_UNIT,
					P_NEW_MP_PERIOD_UNIT),
           MPH_N_PERIOD        = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_PERIOD,P_NEW_MP_PERIOD),
           MPH_N_START_DT      = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_START_DT,P_NEW_MP_START_DT),
           MPH_N_END_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_END_DT,P_NEW_MP_END_DT),
           MPH_N_TEST_START_DT = DECODE(P_TRG_MODE, 'D', P_OLD_MP_TEST_START_DT,
					P_NEW_MP_TEST_START_DT),
           MPH_N_TEST_END_DT   = DECODE(P_TRG_MODE, 'D', P_OLD_MP_TEST_END_DT,
					P_NEW_MP_TEST_END_DT),
           MPH_N_MAINT_DESC    = DECODE(P_TRG_MODE, 'D',  P_OLD_MP_MAINT_DESC,
					P_NEW_MP_MAINT_DESC),
           MPH_N_CR_DT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_CR_DT,P_NEW_MP_CR_DT),
           MPH_N_CR_UID        = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_CR_UID,P_NEW_MP_CR_UID),
           MPH_N_UPD_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_UPD_DT,P_NEW_MP_UPD_DT),
           MPH_N_UPD_UID       = DECODE(P_TRG_MODE, 'D',
					P_OLD_MP_UPD_UID,P_NEW_MP_UPD_UID)
           WHERE CURRENT OF C1;
   END IF;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_OPEN_POLICY(
        P_OLD_OP_SYS_ID               IN                NUMBER,
        P_OLD_OP_POL_SYS_ID           IN                NUMBER,
        P_OLD_OP_FM_DT                IN                DATE,
        P_OLD_OP_TO_DT                IN                DATE,
        P_OLD_OP_DEP_PREM             IN                NUMBER,
        P_OLD_OP_PREM_RATE            IN                NUMBER,
        P_OLD_OP_TERR_LIMIT           IN                VARCHAR2,
        P_OLD_OP_FC_MAX_LIABILITY     IN                NUMBER,
        P_OLD_OP_LC_MAX_LIABILITY     IN                NUMBER,
        P_OLD_OP_FC_LIMIT_PER_SHIP    IN                NUMBER,
        P_OLD_OP_LC_LIMIT_PER_SHIP    IN                NUMBER,
        P_OLD_OP_BASIS_VAL            IN                VARCHAR2,
        P_OLD_OP_DESC                 IN                VARCHAR2,
        P_OLD_OP_CR_DT                IN                DATE,
        P_OLD_OP_CR_UID               IN                VARCHAR2,
        P_OLD_OP_UPD_DT               IN                DATE,
        P_OLD_OP_UPD_UID              IN                VARCHAR2,
        P_OLD_OP_BASIS_VAL_PERC       IN                NUMBER,
        P_OLD_OP_POL_DECL_NO          IN                NUMBER,
        P_NEW_OP_SYS_ID               IN                NUMBER,
        P_NEW_OP_POL_SYS_ID           IN                NUMBER,
        P_NEW_OP_FM_DT                IN                DATE,
        P_NEW_OP_TO_DT                IN                DATE,
        P_NEW_OP_DEP_PREM             IN                NUMBER,
        P_NEW_OP_PREM_RATE            IN                NUMBER,
        P_NEW_OP_TERR_LIMIT           IN                VARCHAR2,
        P_NEW_OP_FC_MAX_LIABILITY     IN                NUMBER,
        P_NEW_OP_LC_MAX_LIABILITY     IN                NUMBER,
        P_NEW_OP_FC_LIMIT_PER_SHIP    IN                NUMBER,
        P_NEW_OP_LC_LIMIT_PER_SHIP    IN                NUMBER,
        P_NEW_OP_BASIS_VAL            IN                VARCHAR2,
        P_NEW_OP_DESC                 IN                VARCHAR2,
        P_NEW_OP_CR_DT                IN                DATE,
        P_NEW_OP_CR_UID               IN                VARCHAR2,
        P_NEW_OP_UPD_DT               IN                DATE,
        P_NEW_OP_UPD_UID              IN                VARCHAR2,
        P_NEW_OP_BASIS_VAL_PERC       IN                NUMBER,
        P_NEW_OP_POL_DECL_NO          IN                NUMBER,
        P_TRG_MODE                    IN                VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_OPEN_POLICY
       WHERE  OPH_SYS_ID     = NVL(P_OLD_OP_SYS_ID, P_NEW_OP_SYS_ID)
       AND    OPH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF OPH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_OP_POL_SYS_ID, P_NEW_OP_POL_SYS_ID) ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_OPEN_POLICY(
             OPH_SYS_ID, OPH_END_NO_IDX, OPH_POL_SYS_ID, OPH_O_FM_DT,
              OPH_O_TO_DT, OPH_O_DEP_PREM, OPH_O_PREM_RATE, OPH_O_TERR_LIMIT,
             OPH_O_FC_MAX_LIABILITY, OPH_O_LC_MAX_LIABILITY, OPH_O_FC_LIMIT_PER_SHIP,
             OPH_O_LC_LIMIT_PER_SHIP, OPH_O_BASIS_VAL, OPH_O_DESC, OPH_O_CR_DT,
             OPH_O_CR_UID, OPH_O_UPD_DT, OPH_O_UPD_UID, OPH_N_FM_DT, OPH_N_TO_DT,
             OPH_N_DEP_PREM, OPH_N_PREM_RATE, OPH_N_TERR_LIMIT, OPH_N_FC_MAX_LIABILITY,
             OPH_N_LC_MAX_LIABILITY, OPH_N_FC_LIMIT_PER_SHIP, OPH_N_LC_LIMIT_PER_SHIP,
             OPH_N_BASIS_VAL, OPH_N_DESC, OPH_N_CR_DT, OPH_N_CR_UID,
             OPH_N_UPD_DT, OPH_N_UPD_UID, oph_o_basis_val_perc, oph_n_basis_val_perc,
             oph_o_pol_decl_no, oph_n_pol_decl_no)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_OP_SYS_ID, P_NEW_OP_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_OP_POL_SYS_ID,
                                     P_NEW_OP_POL_SYS_ID),
               P_OLD_OP_FM_DT, P_OLD_OP_TO_DT, P_OLD_OP_DEP_PREM, P_OLD_OP_PREM_RATE,
             P_OLD_OP_TERR_LIMIT, P_OLD_OP_FC_MAX_LIABILITY, P_OLD_OP_LC_MAX_LIABILITY,
             P_OLD_OP_FC_LIMIT_PER_SHIP, P_OLD_OP_LC_LIMIT_PER_SHIP, P_OLD_OP_BASIS_VAL,
             P_OLD_OP_DESC, P_OLD_OP_CR_DT, P_OLD_OP_CR_UID, P_OLD_OP_UPD_DT,
             P_OLD_OP_UPD_UID, P_NEW_OP_FM_DT,
             P_NEW_OP_TO_DT, P_NEW_OP_DEP_PREM, P_NEW_OP_PREM_RATE, P_NEW_OP_TERR_LIMIT,
             P_NEW_OP_FC_MAX_LIABILITY, P_NEW_OP_LC_MAX_LIABILITY, P_NEW_OP_FC_LIMIT_PER_SHIP,
             P_NEW_OP_LC_LIMIT_PER_SHIP, P_NEW_OP_BASIS_VAL, P_NEW_OP_DESC,
             P_NEW_OP_CR_DT, P_NEW_OP_CR_UID, P_NEW_OP_UPD_DT, P_NEW_OP_UPD_UID,
             p_old_op_basis_val_perc, p_new_op_basis_val_perc,
             p_old_op_pol_decl_no, p_new_op_pol_decl_no) ;
   ELSE
      UPDATE PH_OPEN_POLICY
      SET    OPH_N_FM_DT             = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_FM_DT,P_NEW_OP_FM_DT),
             OPH_N_TO_DT             = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_TO_DT,P_NEW_OP_TO_DT),
             OPH_N_DEP_PREM          = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_DEP_PREM,P_NEW_OP_DEP_PREM),
             OPH_N_PREM_RATE         = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_PREM_RATE,P_NEW_OP_PREM_RATE),
             OPH_N_TERR_LIMIT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_TERR_LIMIT,
					P_NEW_OP_TERR_LIMIT),
             OPH_N_FC_MAX_LIABILITY  = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_FC_MAX_LIABILITY,
					P_NEW_OP_FC_MAX_LIABILITY),
             OPH_N_LC_MAX_LIABILITY  = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_LC_MAX_LIABILITY,
					P_NEW_OP_LC_MAX_LIABILITY),
             OPH_N_FC_LIMIT_PER_SHIP = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_FC_LIMIT_PER_SHIP,
					P_NEW_OP_FC_LIMIT_PER_SHIP),
             OPH_N_LC_LIMIT_PER_SHIP = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_LC_LIMIT_PER_SHIP,
					P_NEW_OP_LC_LIMIT_PER_SHIP),
             OPH_N_BASIS_VAL         = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_BASIS_VAL,P_NEW_OP_BASIS_VAL),
             OPH_N_DESC              = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_DESC,P_NEW_OP_DESC),
             OPH_N_CR_DT             = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_CR_DT,P_NEW_OP_CR_DT),
             OPH_N_CR_UID            = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_CR_UID,P_NEW_OP_CR_UID),
             OPH_N_UPD_DT            = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_UPD_DT,P_NEW_OP_UPD_DT),
             OPH_N_UPD_UID           = DECODE(P_TRG_MODE, 'D',
					P_OLD_OP_UPD_UID,P_NEW_OP_UPD_UID),
             oph_n_basis_val_perc    = decode (p_trg_mode, 'D',
                                       p_old_op_basis_val_perc, p_new_op_basis_val_perc),
             oph_n_pol_decl_no       = decode (p_trg_mode, 'D',
                                    P_OLD_OP_POL_DECL_NO, P_NEW_OP_POL_DECL_NO)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_OP_APPL_CUST(
       P_OLD_OPAC_SYS_ID		IN	NUMBER,
       P_OLD_OPAC_POL_SYS_ID		IN	NUMBER,
       P_OLD_OPAC_CUST_CODE		IN	VARCHAR2,
       P_OLD_OPAC_LAST_GEN_DECL_NO	IN	NUMBER,
       P_OLD_OPAC_DEL_FLAG		IN	VARCHAR2,
       P_OLD_OPAC_CR_DT			IN	DATE,
       P_OLD_OPAC_CR_UID		IN	VARCHAR2,
       P_OLD_OPAC_UPD_DT		IN	DATE,
       P_OLD_OPAC_UPD_UID		IN	VARCHAR2,
       P_NEW_OPAC_SYS_ID		IN	NUMBER,
       P_NEW_OPAC_POL_SYS_ID		IN	NUMBER,
       P_NEW_OPAC_CUST_CODE		IN	VARCHAR2,
       P_NEW_OPAC_LAST_GEN_DECL_NO	IN	NUMBER,
       P_NEW_OPAC_DEL_FLAG		IN	VARCHAR2,
       P_NEW_OPAC_CR_DT			IN	DATE,
       P_NEW_OPAC_CR_UID		IN	VARCHAR2,
       P_NEW_OPAC_UPD_DT		IN	DATE,
       P_NEW_OPAC_UPD_UID		IN	VARCHAR2,
       P_TRG_MODE			IN      VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_OP_APPL_CUST
       WHERE  OPACH_SYS_ID     = NVL(P_OLD_OPAC_SYS_ID, P_NEW_OPAC_SYS_ID)
       AND    OPACH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF OPACH_END_NO_IDX ;
CURSOR C2 IS
Press <Enter> to continue...
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTING POLICY SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_OPAC_POL_SYS_ID, P_NEW_OPAC_POL_SYS_ID);
   /* SELECTING ENDORSEMENT INDEX FROM POLICY TABLE */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'INVALID POLICY REFERENCE, CONTACT SOFTWARE SUPPORT') ;
   END IF ;
   CLOSE C2 ;
   /* NOTHING IS TO BE DONE, IF IT IS APPROVED */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* NOTHING IS TO BE DONE, IF IT IS NOT ENDORSEMENT */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_OP_APPL_CUST
            (OPACH_SYS_ID, OPACH_END_NO_IDX, OPACH_POL_SYS_ID,
             OPACH_O_CUST_CODE, OPACH_O_LAST_GEN_DECL_NO, OPACH_O_DEL_FLAG,
             OPACH_O_CR_DT, OPACH_O_CR_UID, OPACH_O_UPD_DT, OPACH_O_UPD_UID,
             OPACH_N_CUST_CODE, OPACH_N_LAST_GEN_DECL_NO, OPACH_N_DEL_FLAG,
             OPACH_N_CR_DT, OPACH_N_CR_UID, OPACH_N_UPD_DT, OPACH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_OPAC_SYS_ID, P_NEW_OPAC_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_OPAC_POL_SYS_ID,
                    P_NEW_OPAC_POL_SYS_ID),
             P_OLD_OPAC_CUST_CODE, P_OLD_OPAC_LAST_GEN_DECL_NO,
             P_OLD_OPAC_DEL_FLAG, P_OLD_OPAC_CR_DT, P_OLD_OPAC_CR_UID,
             P_OLD_OPAC_UPD_DT, P_OLD_OPAC_UPD_UID,
             P_NEW_OPAC_CUST_CODE, P_NEW_OPAC_LAST_GEN_DECL_NO,
             P_NEW_OPAC_DEL_FLAG, P_NEW_OPAC_CR_DT, P_NEW_OPAC_CR_UID,
             P_NEW_OPAC_UPD_DT, P_NEW_OPAC_UPD_UID);
   ELSE
      UPDATE PH_OP_APPL_CUST
      SET    OPACH_N_CUST_CODE    = DECODE (P_TRG_MODE, 'D',
                                    P_OLD_OPAC_CUST_CODE, P_NEW_OPAC_CUST_CODE),
             OPACH_N_LAST_GEN_DECL_NO = DECODE (P_TRG_MODE, 'D',
                                        P_OLD_OPAC_LAST_GEN_DECL_NO,
                                        P_NEW_OPAC_LAST_GEN_DECL_NO),
             OPACH_N_DEL_FLAG     = DECODE(P_TRG_MODE, 'D',
					P_OLD_OPAC_DEL_FLAG,
					P_NEW_OPAC_DEL_FLAG),
             OPACH_N_CR_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_OPAC_CR_DT,P_NEW_OPAC_CR_DT),
             OPACH_N_CR_UID       = DECODE(P_TRG_MODE, 'D', P_OLD_OPAC_CR_UID,
					P_NEW_OPAC_CR_UID),
             OPACH_N_UPD_DT       = DECODE(P_TRG_MODE, 'D', P_OLD_OPAC_UPD_DT,
					P_NEW_OPAC_UPD_DT),
             OPACH_N_UPD_UID      = DECODE(P_TRG_MODE, 'D',
					P_OLD_OPAC_UPD_UID,P_NEW_OPAC_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POLICY_APPL_CURR (
        P_OLD_PAC_SYS_ID           IN            NUMBER,
        P_OLD_PAC_POL_SYS_ID       IN            NUMBER,
        P_OLD_PAC_CURR_CODE        IN            VARCHAR2,
        P_OLD_PAC_CURR_RATE        IN            NUMBER,
        P_OLD_PAC_CR_DT            IN            DATE,
        P_OLD_PAC_CR_UID           IN            VARCHAR2,
        P_OLD_PAC_UPD_DT           IN            DATE,
        P_OLD_PAC_UPD_UID          IN            VARCHAR2,
        P_OLD_PAC_DEL_FLAG         IN            VARCHAR2,
        P_NEW_PAC_SYS_ID           IN            NUMBER,
        P_NEW_PAC_POL_SYS_ID       IN            NUMBER,
        P_NEW_PAC_CURR_CODE        IN            VARCHAR2,
        P_NEW_PAC_CURR_RATE        IN            NUMBER,
        P_NEW_PAC_CR_DT            IN            DATE,
        P_NEW_PAC_CR_UID           IN            VARCHAR2,
        P_NEW_PAC_UPD_DT           IN            DATE,
        P_NEW_PAC_UPD_UID          IN            VARCHAR2,
        P_NEW_PAC_DEL_FLAG         IN            VARCHAR2,
               P_TRG_MODE           IN            VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POLICY_APPL_CURR
       WHERE  PACH_SYS_ID     = NVL(P_OLD_PAC_SYS_ID, P_NEW_PAC_SYS_ID)
       AND    PACH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF PACH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_PAC_POL_SYS_ID, P_NEW_PAC_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_POLICY_APPL_CURR(
             PACH_SYS_ID, PACH_END_NO_IDX, PACH_POL_SYS_ID, PACH_O_CURR_CODE,
             PACH_O_CURR_RATE, PACH_O_CR_DT, PACH_O_CR_UID, PACH_O_UPD_DT,
             PACH_O_UPD_UID, PACH_N_CURR_CODE, PACH_N_CURR_RATE, PACH_N_CR_DT,
             PACH_N_CR_UID, PACH_N_UPD_DT, PACH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_PAC_SYS_ID, P_NEW_PAC_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_PAC_POL_SYS_ID,
                                     P_NEW_PAC_POL_SYS_ID),
             P_OLD_PAC_CURR_CODE, P_OLD_PAC_CURR_RATE, P_OLD_PAC_CR_DT,
             P_OLD_PAC_CR_UID, P_OLD_PAC_UPD_DT, P_OLD_PAC_UPD_UID,
             P_NEW_PAC_CURR_CODE, P_NEW_PAC_CURR_RATE, P_NEW_PAC_CR_DT,
             P_NEW_PAC_CR_UID, P_NEW_PAC_UPD_DT, P_NEW_PAC_UPD_UID ) ;
   ELSE
      UPDATE PH_POLICY_APPL_CURR
      SET    PACH_N_CURR_CODE = DECODE(P_TRG_MODE, 'D', P_OLD_PAC_CURR_CODE,
					P_NEW_PAC_CURR_CODE),
             PACH_N_CURR_RATE = DECODE(P_TRG_MODE, 'D',
					P_OLD_PAC_CURR_RATE,
					P_NEW_PAC_CURR_RATE),
             PACH_N_CR_DT     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PAC_CR_DT,P_NEW_PAC_CR_DT),
             PACH_N_CR_UID    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PAC_CR_UID,P_NEW_PAC_CR_UID),
             PACH_N_UPD_DT    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PAC_UPD_DT,P_NEW_PAC_UPD_DT),
             PACH_N_UPD_UID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_PAC_UPD_UID,P_NEW_PAC_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POLICY_SCHEDULE(
      P_OLD_PSCH_SYS_ID                    IN     NUMBER,
      P_OLD_PSCH_POL_SYS_ID                IN     NUMBER,
	P_OLD_PSCH_FIELD_1		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_2		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_3		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_4		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_5		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_6		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_7		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_8		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_9		       IN  	  VARCHAR2,
	P_OLD_PSCH_FIELD_10		       IN  	  VARCHAR2,
        P_OLD_PSCH_CR_DT                   IN     DATE,
        P_OLD_PSCH_CR_UID                  IN     VARCHAR2,
        P_OLD_PSCH_UPD_DT                  IN     DATE,
        P_OLD_PSCH_UPD_UID                 IN     VARCHAR2,
	P_OLD_PSCH_SRNO			       IN	  NUMBER,
        P_NEW_PSCH_SYS_ID                  IN     NUMBER,
        P_NEW_PSCH_POL_SYS_ID              IN     NUMBER,
	P_NEW_PSCH_FIELD_1		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_2		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_3		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_4		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_5		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_6		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_7		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_8		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_9		       IN  	  VARCHAR2,
	P_NEW_PSCH_FIELD_10		       IN  	  VARCHAR2,
        P_NEW_PSCH_CR_DT                   IN     DATE,
        P_NEW_PSCH_CR_UID                  IN     VARCHAR2,
        P_NEW_PSCH_UPD_DT                  IN     DATE,
        P_NEW_PSCH_UPD_UID                 IN     VARCHAR2,
	P_NEW_PSCH_SRNO			       IN	  NUMBER,
        P_TRG_MODE                         IN     VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POLICY_SCHEDULE
       WHERE  PSCH_SYS_ID     = NVL(P_OLD_PSCH_SYS_ID, P_NEW_PSCH_SYS_ID)
       AND    PSCH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF PSCH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTING POLICY SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_PSCH_POL_SYS_ID, P_NEW_PSCH_POL_SYS_ID);
   /* SELECTING ENDORSEMENT INDEX FROM POLICY TABLE */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'INVALID POLICY REFERENCE, CONTACT SOFTWARE SUPPORT') ;
   END IF ;
   CLOSE C2 ;
   /* NOTHING IS TO BE DONE, IF IT IS APPROVED */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* NOTHING IS TO BE DONE, IF IT IS NOT ENDORSEMENT */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_POLICY_SCHEDULE
	     (PSCH_SYS_ID,    PSCH_END_NO_IDX, PSCH_POL_SYS_ID,
              PSCH_O_FIELD_1, PSCH_O_FIELD_2,  PSCH_O_FIELD_3, PSCH_O_FIELD_4,
	      PSCH_O_FIELD_5, PSCH_O_FIELD_6,  PSCH_O_FIELD_7, PSCH_O_FIELD_8,
	      PSCH_O_FIELD_9, PSCH_O_FIELD_10, PSCH_O_CR_DT,   PSCH_O_CR_UID,
	      PSCH_O_UPD_DT,  PSCH_O_UPD_UID,  PSCH_O_SRNO,    PSCH_N_FIELD_1,
	      PSCH_N_FIELD_2, PSCH_N_FIELD_3,  PSCH_N_FIELD_4, PSCH_N_FIELD_5,
	      PSCH_N_FIELD_6, PSCH_N_FIELD_7,  PSCH_N_FIELD_8,
              PSCH_N_FIELD_9, PSCH_N_FIELD_10, PSCH_N_CR_DT,   PSCH_N_CR_UID,
	      PSCH_N_UPD_DT, PSCH_N_UPD_UID, PSCH_N_SRNO)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_PSCH_SYS_ID, P_NEW_PSCH_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_PSCH_POL_SYS_ID,
                                     P_NEW_PSCH_POL_SYS_ID),
              P_OLD_PSCH_FIELD_1, P_OLD_PSCH_FIELD_2, P_OLD_PSCH_FIELD_3,
	      P_OLD_PSCH_FIELD_4, P_OLD_PSCH_FIELD_5, P_OLD_PSCH_FIELD_6,
	      P_OLD_PSCH_FIELD_7, P_OLD_PSCH_FIELD_8, P_OLD_PSCH_FIELD_9,
	      P_OLD_PSCH_FIELD_10, P_OLD_PSCH_CR_DT, P_OLD_PSCH_CR_UID,
	      P_OLD_PSCH_UPD_DT, P_OLD_PSCH_UPD_UID, P_OLD_PSCH_SRNO,
	      P_NEW_PSCH_FIELD_1, P_NEW_PSCH_FIELD_2, P_NEW_PSCH_FIELD_3,
	      P_NEW_PSCH_FIELD_4, P_NEW_PSCH_FIELD_5, P_NEW_PSCH_FIELD_6,
	      P_NEW_PSCH_FIELD_7, P_NEW_PSCH_FIELD_8, P_NEW_PSCH_FIELD_9,
	      P_NEW_PSCH_FIELD_10, P_NEW_PSCH_CR_DT, P_NEW_PSCH_CR_UID,
	      P_NEW_PSCH_UPD_DT, P_NEW_PSCH_UPD_UID, P_NEW_PSCH_SRNO);
   ELSE
      UPDATE PH_POLICY_SCHEDULE
      SET    PSCH_N_FIELD_1     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_1,P_NEW_PSCH_FIELD_1),
	     PSCH_N_FIELD_2     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_2,P_NEW_PSCH_FIELD_2),
 	     PSCH_N_FIELD_3     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_3,P_NEW_PSCH_FIELD_3),
	     PSCH_N_FIELD_4     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_4,P_NEW_PSCH_FIELD_4),
	     PSCH_N_FIELD_5     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_5,P_NEW_PSCH_FIELD_5),
	     PSCH_N_FIELD_6     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_6,P_NEW_PSCH_FIELD_6),
	     PSCH_N_FIELD_7     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_7,P_NEW_PSCH_FIELD_7),
	     PSCH_N_FIELD_8     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_8,P_NEW_PSCH_FIELD_8),
	     PSCH_N_FIELD_9     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_9,P_NEW_PSCH_FIELD_9),
	     PSCH_N_FIELD_10    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_FIELD_10,P_NEW_PSCH_FIELD_10),
	     PSCH_N_SRNO        = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_SRNO,P_NEW_PSCH_SRNO),
             PSCH_N_CR_DT       = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_CR_DT,P_NEW_PSCH_CR_DT),
             PSCH_N_CR_UID      = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_CR_UID,P_NEW_PSCH_CR_UID),
             PSCH_N_UPD_DT      = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_UPD_DT,P_NEW_PSCH_UPD_DT),
             PSCH_N_UPD_UID     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PSCH_UPD_UID,P_NEW_PSCH_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POL_ASSURED_DTL(
	P_OLD_PAD_POL_SYS_ID		IN NUMBER,
	P_OLD_PAD_SYS_ID		IN NUMBER,
	P_OLD_PAD_NATIONALITY		IN VARCHAR2,
	P_OLD_PAD_CIVIL_ID		IN VARCHAR2,
	P_OLD_PAD_PROFESSION		IN VARCHAR2,
	P_OLD_PAD_GOVERNORATE		IN VARCHAR2,
	P_OLD_PAD_AREA			IN VARCHAR2,
	P_OLD_PAD_BLOCK			IN VARCHAR2,
	P_OLD_PAD_STREET		IN VARCHAR2,
	P_OLD_PAD_AVENUE		IN VARCHAR2,
	P_OLD_PAD_DIVISION		IN VARCHAR2,
	P_OLD_PAD_BUILDING		IN VARCHAR2,
	P_OLD_PAD_FLOOR			IN VARCHAR2,
	P_OLD_PAD_PHONE			IN VARCHAR2,
	P_OLD_PAD_FLAT			IN VARCHAR2,
	P_OLD_PAD_LREP_ID		IN VARCHAR2,
	P_OLD_PAD_LREP_NATIONALITY	IN VARCHAR2,
	P_OLD_PAD_LREP_PROFESSION	IN VARCHAR2,
	P_OLD_PAD_LREP_NAME		IN VARCHAR2,
	P_OLD_PAD_OFFICE_ADDR		IN VARCHAR2,
	P_OLD_PAD_DEL_FLAG		IN VARCHAR2,
	P_OLD_PAD_CR_DT			IN DATE,
	P_OLD_PAD_CR_UID		IN VARCHAR2,
	P_OLD_PAD_UPD_DT		IN DATE,
	P_OLD_PAD_UPD_UID		IN VARCHAR2,
	P_NEW_PAD_POL_SYS_ID		IN NUMBER,
	P_NEW_PAD_SYS_ID		IN NUMBER,
	P_NEW_PAD_NATIONALITY		IN VARCHAR2,
	P_NEW_PAD_CIVIL_ID		IN VARCHAR2,
	P_NEW_PAD_PROFESSION		IN VARCHAR2,
	P_NEW_PAD_GOVERNORATE		IN VARCHAR2,
	P_NEW_PAD_AREA			IN VARCHAR2,
	P_NEW_PAD_BLOCK			IN VARCHAR2,
	P_NEW_PAD_STREET		IN VARCHAR2,
	P_NEW_PAD_AVENUE		IN VARCHAR2,
	P_NEW_PAD_DIVISION		IN VARCHAR2,
	P_NEW_PAD_BUILDING		IN VARCHAR2,
	P_NEW_PAD_FLOOR			IN VARCHAR2,
	P_NEW_PAD_PHONE			IN VARCHAR2,
	P_NEW_PAD_FLAT			IN VARCHAR2,
	P_NEW_PAD_LREP_ID		IN VARCHAR2,
	P_NEW_PAD_LREP_NATIONALITY	IN VARCHAR2,
	P_NEW_PAD_LREP_PROFESSION	IN VARCHAR2,
	P_NEW_PAD_LREP_NAME		IN VARCHAR2,
	P_NEW_PAD_OFFICE_ADDR		IN VARCHAR2,
	P_NEW_PAD_DEL_FLAG		IN VARCHAR2,
	P_NEW_PAD_CR_DT			IN DATE,
	P_NEW_PAD_CR_UID		IN VARCHAR2,
	P_NEW_PAD_UPD_DT		IN DATE,
	P_NEW_PAD_UPD_UID		IN VARCHAR2,
	P_TRG_MODE			IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POL_ASSURED_DTL
       WHERE  PADH_SYS_ID     = NVL(P_OLD_PAD_SYS_ID, P_NEW_PAD_SYS_ID)
       AND    PADH_POL_SYS_ID = NVL(P_OLD_PAD_POL_SYS_ID,P_NEW_PAD_POL_SYS_ID)
       AND    PADH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF PADH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_PAD_POL_SYS_ID,P_NEW_PAD_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
	INSERT INTO PH_POL_ASSURED_DTL(
	PADH_SYS_ID,		 PADH_POL_SYS_ID   ,
	PADH_END_NO_IDX ,	 PADH_O_NATIONALITY  ,
	 PADH_O_CIVIL_ID,	 PADH_O_PROFESSION     ,
	 PADH_O_GOVERNORATE,	 PADH_O_AREA             ,
	 PADH_O_BLOCK,		 PADH_O_STREET    ,
	 PADH_O_AVENUE, PADH_O_DIVISION, PADH_O_BUILDING   ,
	 PADH_O_FLOOR,  PADH_O_PHONE, PADH_O_FLAT      ,
	 PADH_O_LREP_ID  , PADH_O_LREP_NATIONALITY,
	 PADH_O_LREP_PROFESSION , PADH_O_LREP_NAME        ,
	 PADH_O_OFFICE_ADDR       , PADH_O_DEL_FLAG,
	 PADH_O_CR_DT    , PADH_O_CR_UID    ,
	 PADH_O_UPD_DT     , PADH_O_UPD_UID ,
	 PADH_N_NATIONALITY, PADH_N_CIVIL_ID    ,
	 PADH_N_PROFESSION  , PADH_N_GOVERNORATE   ,
	 PADH_N_AREA           , PADH_N_BLOCK      ,
	 PADH_N_STREET  , PADH_N_AVENUE   , PADH_N_DIVISION  ,
	 PADH_N_BUILDING  , PADH_N_FLOOR      , PADH_N_PHONE   ,
	 PADH_N_FLAT     , PADH_N_LREP_ID, PADH_N_LREP_NATIONALITY,
	 PADH_N_LREP_PROFESSION  , PADH_N_LREP_NAME         ,
	 PADH_N_OFFICE_ADDR        , PADH_N_DEL_FLAG, PADH_N_CR_DT    ,
	 PADH_N_CR_UID    , PADH_N_UPD_DT     , PADH_N_UPD_UID     )
 VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_PAD_SYS_ID, P_NEW_PAD_SYS_ID),
	DECODE(P_TRG_MODE, 'D', P_OLD_PAD_POL_SYS_ID, P_NEW_PAD_POL_SYS_ID),
        M_END_NO_IDX,
        P_OLD_PAD_NATIONALITY,
	P_OLD_PAD_CIVIL_ID,
	P_OLD_PAD_PROFESSION,P_OLD_PAD_GOVERNORATE,P_OLD_PAD_AREA,
	P_OLD_PAD_BLOCK,P_OLD_PAD_STREET,	P_OLD_PAD_AVENUE,
	P_OLD_PAD_DIVISION,P_OLD_PAD_BUILDING,P_OLD_PAD_FLOOR,
        P_OLD_PAD_PHONE,P_OLD_PAD_FLAT,P_OLD_PAD_LREP_ID,
	P_OLD_PAD_LREP_NATIONALITY,P_OLD_PAD_LREP_PROFESSION,
	P_OLD_PAD_LREP_NAME	,P_OLD_PAD_OFFICE_ADDR	,P_OLD_PAD_DEL_FLAG,
	P_OLD_PAD_CR_DT		,P_OLD_PAD_CR_UID,P_OLD_PAD_UPD_DT,
	P_OLD_PAD_UPD_UID,P_NEW_PAD_NATIONALITY,P_NEW_PAD_CIVIL_ID,
	P_NEW_PAD_PROFESSION,P_NEW_PAD_GOVERNORATE,P_NEW_PAD_AREA,
	P_NEW_PAD_BLOCK,P_NEW_PAD_STREET,P_NEW_PAD_AVENUE,
	P_NEW_PAD_DIVISION,P_NEW_PAD_BUILDING,P_NEW_PAD_FLOOR,
        P_NEW_PAD_PHONE,P_NEW_PAD_FLAT,P_NEW_PAD_LREP_ID,
	P_NEW_PAD_LREP_NATIONALITY,P_NEW_PAD_LREP_PROFESSION,
	P_NEW_PAD_LREP_NAME,P_NEW_PAD_OFFICE_ADDR,
	P_NEW_PAD_DEL_FLAG,P_NEW_PAD_CR_DT,
	P_NEW_PAD_CR_UID,P_NEW_PAD_UPD_DT,
	P_NEW_PAD_UPD_UID);
   ELSE
      UPDATE PH_POL_ASSURED_DTL
      SET    PADH_N_NATIONALITY     = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_NATIONALITY),
             PADH_N_CIVIL_ID         = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_CIVIL_ID),
             PADH_N_PROFESSION        = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_PROFESSION),
             PADH_N_GOVERNORATE            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_GOVERNORATE),
             PADH_N_AREA            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_AREA),
             PADH_N_BLOCK            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_BLOCK),
             PADH_N_STREET            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_STREET),
             PADH_N_AVENUE            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_AVENUE),
             PADH_N_DIVISION            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_DIVISION),
             PADH_N_BUILDING            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_BUILDING),
             PADH_N_FLOOR            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_FLOOR),
             PADH_N_PHONE            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_PHONE),
             PADH_N_FLAT            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_FLAT),
             PADH_N_LREP_ID            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_LREP_ID),
             PADH_N_LREP_NATIONALITY   = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_LREP_NATIONALITY),
             PADH_N_LREP_PROFESSION            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_LREP_PROFESSION),
             PADH_N_LREP_NAME            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_LREP_NAME),
             PADH_N_OFFICE_ADDR            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_OFFICE_ADDR),
             PADH_N_DEL_FLAG           = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_DEL_FLAG),
             PADH_N_CR_DT              = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_CR_DT),
             PADH_N_CR_UID             = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_CR_UID),
             PADH_N_UPD_DT             = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_UPD_DT),
             PADH_N_UPD_UID            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_PAD_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POL_BROKER(
        P_OLD_PB_SYS_ID                       IN         NUMBER,
        P_OLD_PB_POL_SYS_ID                   IN         NUMBER,
        P_OLD_PB_CUST_CODE                    IN         VARCHAR2,
        P_OLD_PB_COMM_CODE                    IN         VARCHAR2,
        P_OLD_PB_COMM_PERC                    IN         NUMBER,
        P_OLD_PB_COMM_CURR                    IN         VARCHAR2,
        P_OLD_PB_FC_COMM                      IN         NUMBER,
        P_OLD_PB_LC_COMM                      IN         NUMBER,
        P_OLD_PB_FC_ORG_COMM                  IN         NUMBER,
        P_OLD_PB_LC_ORG_COMM                  IN         NUMBER,
        P_OLD_PB_DEL_FLAG                     IN         VARCHAR2,
        P_OLD_PB_CR_DT                        IN         DATE,
        P_OLD_PB_CR_UID                       IN         VARCHAR2,
        P_OLD_PB_UPD_DT                       IN         DATE,
        P_OLD_PB_UPD_UID                      IN         VARCHAR2,
        P_NEW_PB_SYS_ID                       IN         NUMBER,
        P_NEW_PB_POL_SYS_ID                   IN         NUMBER,
        P_NEW_PB_CUST_CODE                    IN         VARCHAR2,
        P_NEW_PB_COMM_CODE                    IN         VARCHAR2,
        P_NEW_PB_COMM_PERC                    IN         NUMBER,
        P_NEW_PB_COMM_CURR                    IN         VARCHAR2,
        P_NEW_PB_FC_COMM                      IN         NUMBER,
        P_NEW_PB_LC_COMM                      IN         NUMBER,
        P_NEW_PB_FC_ORG_COMM                  IN         NUMBER,
        P_NEW_PB_LC_ORG_COMM                  IN         NUMBER,
        P_NEW_PB_DEL_FLAG                     IN         VARCHAR2,
        P_NEW_PB_CR_DT                        IN         DATE,
        P_NEW_PB_CR_UID                       IN         VARCHAR2,
        P_NEW_PB_UPD_DT                       IN         DATE,
        P_NEW_PB_UPD_UID                      IN         VARCHAR2,
             P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POL_BROKER
       WHERE  PBH_SYS_ID     = NVL(P_OLD_PB_SYS_ID, P_NEW_PB_SYS_ID)
       AND    PBH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF PBH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_PB_POL_SYS_ID, P_NEW_PB_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_POL_BROKER (
	     PBH_SYS_ID, PBH_END_NO_IDX, PBH_POL_SYS_ID, PBH_O_CUST_CODE,
             PBH_O_COMM_CODE, PBH_O_COMM_PERC, PBH_O_COMM_CURR,
             PBH_O_FC_COMM, PBH_O_LC_COMM, PBH_O_DEL_FLAG,
             PBH_O_CR_DT, PBH_O_CR_UID, PBH_O_UPD_DT, PBH_O_UPD_UID,
             PBH_N_CUST_CODE, PBH_N_COMM_CODE, PBH_N_COMM_PERC,
             PBH_N_COMM_CURR, PBH_N_FC_COMM, PBH_N_LC_COMM,
             PBH_N_DEL_FLAG, PBH_N_CR_DT, PBH_N_CR_UID,
             PBH_N_UPD_DT, PBH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_PB_SYS_ID, P_NEW_PB_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_PB_POL_SYS_ID,
                                     P_NEW_PB_POL_SYS_ID),
             P_OLD_PB_CUST_CODE, P_OLD_PB_COMM_CODE, P_OLD_PB_COMM_PERC,
             P_OLD_PB_COMM_CURR, P_OLD_PB_FC_ORG_COMM, P_OLD_PB_LC_ORG_COMM,
	     P_OLD_PB_DEL_FLAG, P_OLD_PB_CR_DT, P_OLD_PB_CR_UID,
	     P_OLD_PB_UPD_DT, P_OLD_PB_UPD_UID,
             P_NEW_PB_CUST_CODE, P_NEW_PB_COMM_CODE, P_NEW_PB_COMM_PERC,
             P_NEW_PB_COMM_CURR, P_NEW_PB_FC_COMM, P_NEW_PB_LC_COMM,
	     P_NEW_PB_DEL_FLAG, P_NEW_PB_CR_DT, P_NEW_PB_CR_UID,
	     P_NEW_PB_UPD_DT, P_NEW_PB_UPD_UID);
   ELSE
      UPDATE PH_POL_BROKER
      SET    PBH_N_CUST_CODE = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_CUST_CODE,P_NEW_PB_CUST_CODE),
             PBH_N_COMM_CODE = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_COMM_CODE,P_NEW_PB_COMM_CODE),
             PBH_N_COMM_PERC = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_COMM_PERC,P_NEW_PB_COMM_PERC),
             PBH_N_COMM_CURR = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_COMM_CURR,P_NEW_PB_COMM_CURR),
             PBH_N_FC_COMM   = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_FC_COMM,P_NEW_PB_FC_COMM),
             PBH_N_LC_COMM   = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_LC_COMM,P_NEW_PB_LC_COMM),
             PBH_N_DEL_FLAG  = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_DEL_FLAG,P_NEW_PB_DEL_FLAG),
             PBH_N_CR_DT     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_CR_DT,P_NEW_PB_CR_DT),
             PBH_N_CR_UID    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_CR_UID,P_NEW_PB_CR_UID),
             PBH_N_UPD_DT    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_UPD_DT,P_NEW_PB_UPD_DT),
             PBH_N_UPD_UID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_PB_UPD_UID,P_NEW_PB_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POL_CHARGE(
        P_OLD_CHG_SYS_ID                      IN         NUMBER,
        P_OLD_CHG_POL_SYS_ID                  IN         NUMBER,
        P_OLD_CHG_CODE                        IN         VARCHAR2,
        P_OLD_CHG_DESC                        IN         VARCHAR2,
        P_OLD_CHG_PERC                        IN         NUMBER,
        P_OLD_CHG_FC_VALUE                    IN         NUMBER,
        P_OLD_CHG_LC_VALUE                    IN         NUMBER,
        P_OLD_CHG_FC_ORG_VALUE                IN         NUMBER,
        P_OLD_CHG_LC_ORG_VALUE                IN         NUMBER,
        P_OLD_CHG_CR_DT                       IN         DATE,
        P_OLD_CHG_CR_UID                      IN         VARCHAR2,
        P_OLD_CHG_UPD_DT                      IN         DATE,
        P_OLD_CHG_UPD_UID                     IN         VARCHAR2,
        P_NEW_CHG_SYS_ID                      IN         NUMBER,
        P_NEW_CHG_POL_SYS_ID                  IN         NUMBER,
        P_NEW_CHG_CODE                        IN         VARCHAR2,
        P_NEW_CHG_DESC                        IN         VARCHAR2,
        P_NEW_CHG_PERC                        IN         NUMBER,
        P_NEW_CHG_FC_VALUE                    IN         NUMBER,
        P_NEW_CHG_LC_VALUE                    IN         NUMBER,
        P_NEW_CHG_FC_ORG_VALUE                IN         NUMBER,
        P_NEW_CHG_LC_ORG_VALUE                IN         NUMBER,
        P_NEW_CHG_CR_DT                       IN         DATE,
        P_NEW_CHG_CR_UID                      IN         VARCHAR2,
        P_NEW_CHG_UPD_DT                      IN         DATE,
        P_NEW_CHG_UPD_UID                     IN         VARCHAR2,
             P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POL_CHARGE
       WHERE  CHGH_SYS_ID     = NVL(P_OLD_CHG_SYS_ID, P_NEW_CHG_SYS_ID)
       AND    CHGH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF CHGH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_CHG_POL_SYS_ID, P_NEW_CHG_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_POL_CHARGE
	     (CHGH_SYS_ID, CHGH_END_NO_IDX, CHGH_POL_SYS_ID,
              CHGH_O_CODE, CHGH_O_DESC, CHGH_O_PERC, CHGH_O_FC_VALUE,
              CHGH_O_LC_VALUE, CHGH_O_CR_DT, CHGH_O_CR_UID, CHGH_O_UPD_DT,
              CHGH_O_UPD_UID, CHGH_N_CODE, CHGH_N_DESC, CHGH_N_PERC,
              CHGH_N_FC_VALUE, CHGH_N_LC_VALUE, CHGH_N_CR_DT,
              CHGH_N_CR_UID, CHGH_N_UPD_DT, CHGH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_CHG_SYS_ID, P_NEW_CHG_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_CHG_POL_SYS_ID,
                                     P_NEW_CHG_POL_SYS_ID),
             P_OLD_CHG_CODE, P_OLD_CHG_DESC, P_OLD_CHG_PERC,
	     P_OLD_CHG_FC_ORG_VALUE, P_OLD_CHG_LC_ORG_VALUE, P_OLD_CHG_CR_DT,
	     P_OLD_CHG_CR_UID, P_OLD_CHG_UPD_DT,
             P_OLD_CHG_UPD_UID, P_NEW_CHG_CODE, P_NEW_CHG_DESC,
	     P_NEW_CHG_PERC, P_NEW_CHG_FC_VALUE, P_NEW_CHG_LC_VALUE,
	     P_NEW_CHG_CR_DT, P_NEW_CHG_CR_UID,
             P_NEW_CHG_UPD_DT, P_NEW_CHG_UPD_UID);
   ELSE
      UPDATE PH_POL_CHARGE
      SET    CHGH_N_CODE     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_CODE,P_NEW_CHG_CODE),
             CHGH_N_DESC     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_DESC,P_NEW_CHG_DESC),
             CHGH_N_PERC     = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_PERC,P_NEW_CHG_PERC),
             CHGH_N_FC_VALUE = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_FC_VALUE,P_NEW_CHG_FC_VALUE),
             CHGH_N_LC_VALUE = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_LC_VALUE,P_NEW_CHG_LC_VALUE),
             CHGH_N_CR_DT    = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_CR_DT,P_NEW_CHG_CR_DT),
             CHGH_N_CR_UID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_CR_UID,P_NEW_CHG_CR_UID),
             CHGH_N_UPD_DT   = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_UPD_DT,P_NEW_CHG_UPD_DT),
             CHGH_N_UPD_UID  = DECODE(P_TRG_MODE, 'D',
					P_OLD_CHG_UPD_UID,P_NEW_CHG_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_POL_COVER(
  P_OLD_PCVR_SYS_ID               IN       NUMBER,
  P_OLD_PCVR_POL_SYS_ID           IN       NUMBER,
  P_OLD_PCVR_REF                  IN       VARCHAR2,
  P_OLD_PCVR_REF_SYS_ID           IN       NUMBER,
  P_OLD_PCVR_CODE                 IN       VARCHAR2,
  P_OLD_PCVR_DESC                 IN       VARCHAR2,
  P_OLD_PCVR_SI_CURR_CODE         IN       VARCHAR2,
  P_OLD_PCVR_FC_SI                IN       NUMBER,
  P_OLD_PCVR_LC_SI                IN       NUMBER,
  P_OLD_PCVR_FC_ORG_SI            IN       NUMBER,
  P_OLD_PCVR_LC_ORG_SI            IN       NUMBER,
  P_OLD_PCVR_PREM_RATE            IN       NUMBER,
  P_OLD_PCVR_FC_PREM              IN       NUMBER,
  P_OLD_PCVR_LC_PREM              IN       NUMBER,
  P_OLD_PCVR_FC_ORG_PREM          IN       NUMBER,
  P_OLD_PCVR_LC_ORG_PREM          IN       NUMBER,
  P_OLD_PCVR_DISCOUNT_YN          IN       VARCHAR2,
  P_OLD_PCVR_DED_LOSS_YN          IN       VARCHAR2,
  P_OLD_PCVR_DEL_FLAG             IN       VARCHAR2,
  P_OLD_PCVR_CR_DT                IN       DATE,
  P_OLD_PCVR_CR_UID               IN       VARCHAR2,
  P_OLD_PCVR_UPD_DT               IN       DATE,
  P_OLD_PCVR_UPD_UID              IN       VARCHAR2,
  P_NEW_PCVR_SYS_ID               IN       NUMBER,
  P_NEW_PCVR_POL_SYS_ID           IN       NUMBER,
  P_NEW_PCVR_REF                  IN       VARCHAR2,
  P_NEW_PCVR_REF_SYS_ID           IN       NUMBER,
  P_NEW_PCVR_CODE                 IN       VARCHAR2,
  P_NEW_PCVR_DESC                 IN       VARCHAR2,
  P_NEW_PCVR_SI_CURR_CODE         IN       VARCHAR2,
  P_NEW_PCVR_FC_SI                IN       NUMBER,
  P_NEW_PCVR_LC_SI                IN       NUMBER,
  P_NEW_PCVR_FC_ORG_SI            IN       NUMBER,
  P_NEW_PCVR_LC_ORG_SI            IN       NUMBER,
  P_NEW_PCVR_PREM_RATE            IN       NUMBER,
  P_NEW_PCVR_FC_PREM              IN       NUMBER,
  P_NEW_PCVR_LC_PREM              IN       NUMBER,
  P_NEW_PCVR_FC_ORG_PREM          IN       NUMBER,
  P_NEW_PCVR_LC_ORG_PREM          IN       NUMBER,
  P_NEW_PCVR_DISCOUNT_YN          IN       VARCHAR2,
  P_NEW_PCVR_DED_LOSS_YN          IN       VARCHAR2,
  P_NEW_PCVR_DEL_FLAG             IN       VARCHAR2,
  P_NEW_PCVR_CR_DT                IN       DATE,
  P_NEW_PCVR_CR_UID               IN       VARCHAR2,
  P_NEW_PCVR_UPD_DT               IN       DATE,
  P_NEW_PCVR_UPD_UID              IN       VARCHAR2,
  P_TRG_MODE                      IN       VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_POL_COVER
       WHERE  PCVRH_SYS_ID     = NVL(P_OLD_PCVR_SYS_ID, P_NEW_PCVR_SYS_ID)
       AND    PCVRH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF PCVRH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_PCVR_POL_SYS_ID, P_NEW_PCVR_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO  PH_POL_COVER
            (PCVRH_SYS_ID, PCVRH_END_NO_IDX, PCVRH_POL_SYS_ID,
             PCVRH_O_REF, PCVRH_O_REF_SYS_ID, PCVRH_O_CODE,
             PCVRH_O_DESC, PCVRH_O_SI_CURR_CODE, PCVRH_O_FC_SI,
             PCVRH_O_LC_SI, PCVRH_O_PREM_RATE, PCVRH_O_FC_PREM,
             PCVRH_O_LC_PREM, PCVRH_O_DISCOUNT_YN, PCVRH_O_DED_LOSS_YN,
             PCVRH_O_DEL_FLAG, PCVRH_O_CR_DT, PCVRH_O_CR_UID, PCVRH_O_UPD_DT,
             PCVRH_O_UPD_UID, PCVRH_N_REF, PCVRH_N_REF_SYS_ID,
             PCVRH_N_CODE, PCVRH_N_DESC, PCVRH_N_SI_CURR_CODE,
             PCVRH_N_FC_SI, PCVRH_N_LC_SI, PCVRH_N_PREM_RATE,
             PCVRH_N_FC_PREM, PCVRH_N_LC_PREM, PCVRH_N_DISCOUNT_YN,
             PCVRH_N_DED_LOSS_YN, PCVRH_N_DEL_FLAG, PCVRH_N_CR_DT,
             PCVRH_N_CR_UID, PCVRH_N_UPD_DT, PCVRH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_PCVR_SYS_ID, P_NEW_PCVR_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_PCVR_POL_SYS_ID,
                    P_NEW_PCVR_POL_SYS_ID),
             P_OLD_PCVR_REF, P_OLD_PCVR_REF_SYS_ID, P_OLD_PCVR_CODE,
             P_OLD_PCVR_DESC, P_OLD_PCVR_SI_CURR_CODE, P_OLD_PCVR_FC_ORG_SI,
             P_OLD_PCVR_LC_ORG_SI, P_OLD_PCVR_PREM_RATE, P_OLD_PCVR_FC_ORG_PREM,
             P_OLD_PCVR_LC_ORG_PREM, P_OLD_PCVR_DISCOUNT_YN,
             P_OLD_PCVR_DED_LOSS_YN, P_OLD_PCVR_DEL_FLAG, P_OLD_PCVR_CR_DT,
             P_OLD_PCVR_CR_UID, P_OLD_PCVR_UPD_DT, P_OLD_PCVR_UPD_UID,
             P_NEW_PCVR_REF, P_NEW_PCVR_REF_SYS_ID,
             P_NEW_PCVR_CODE, P_NEW_PCVR_DESC, P_NEW_PCVR_SI_CURR_CODE,
             P_NEW_PCVR_FC_SI, P_NEW_PCVR_LC_SI, P_NEW_PCVR_PREM_RATE,
             P_NEW_PCVR_FC_PREM, P_NEW_PCVR_LC_PREM, P_NEW_PCVR_DISCOUNT_YN,
             P_NEW_PCVR_DED_LOSS_YN, P_NEW_PCVR_DEL_FLAG, P_NEW_PCVR_CR_DT,
             P_NEW_PCVR_CR_UID, P_NEW_PCVR_UPD_DT, P_NEW_PCVR_UPD_UID);
   ELSE
      UPDATE PH_POL_COVER
      SET    PCVRH_N_REF          = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_REF,P_NEW_PCVR_REF),
             PCVRH_N_REF_SYS_ID   = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_REF_SYS_ID,
					P_NEW_PCVR_REF_SYS_ID),
             PCVRH_N_CODE         = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_CODE,P_NEW_PCVR_CODE),
             PCVRH_N_DESC         = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_DESC,P_NEW_PCVR_DESC),
             PCVRH_N_SI_CURR_CODE = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_SI_CURR_CODE,
					P_NEW_PCVR_SI_CURR_CODE),
             PCVRH_N_FC_SI        = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_FC_SI,P_NEW_PCVR_FC_SI),
             PCVRH_N_LC_SI        = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_LC_SI,P_NEW_PCVR_LC_SI),
             PCVRH_N_PREM_RATE    = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_PREM_RATE,
					P_NEW_PCVR_PREM_RATE),
             PCVRH_N_FC_PREM      = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_FC_PREM, P_NEW_PCVR_FC_PREM),
             PCVRH_N_LC_PREM      = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_LC_PREM, P_NEW_PCVR_LC_PREM),
             PCVRH_N_DISCOUNT_YN  = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_DISCOUNT_YN,
					P_NEW_PCVR_DISCOUNT_YN),
             PCVRH_N_DED_LOSS_YN  = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_DED_LOSS_YN,
					P_NEW_PCVR_DED_LOSS_YN),
             PCVRH_N_DEL_FLAG     = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_DEL_FLAG,
					P_NEW_PCVR_DEL_FLAG),
             PCVRH_N_CR_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_CR_DT,P_NEW_PCVR_CR_DT),
             PCVRH_N_CR_UID       = DECODE(P_TRG_MODE, 'D', P_OLD_PCVR_CR_UID,
					P_NEW_PCVR_CR_UID),
             PCVRH_N_UPD_DT       = DECODE(P_TRG_MODE, 'D', P_OLD_PCVR_UPD_DT,
					P_NEW_PCVR_UPD_DT),
             PCVRH_N_UPD_UID      = DECODE(P_TRG_MODE, 'D',
					P_OLD_PCVR_UPD_UID,P_NEW_PCVR_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE  STP_PT_RISK(
        P_OLD_RISK_SYS_ID                     IN          NUMBER,
        P_OLD_RISK_POL_SYS_ID                 IN          NUMBER,
        P_OLD_RISK_CLASS                      IN         VARCHAR2,
        P_OLD_RISK_ENTRY_DT                   IN         DATE,
        P_OLD_RISK_EXIT_DT                    IN         DATE,
        P_OLD_RISK_TYPE                       IN         VARCHAR2,
        P_OLD_RISK_BLD_NO                     IN         VARCHAR2,
        P_OLD_RISK_ROAD_NO                    IN         VARCHAR2,
        P_OLD_RISK_AREA_NO                    IN         VARCHAR2,
        P_OLD_RISK_DESC                       IN          VARCHAR2,
        P_OLD_RISK_SI_CURR_CODE               IN         VARCHAR2,
        P_OLD_RISK_FC_SI                      IN         NUMBER,
        P_OLD_RISK_LC_SI                      IN         NUMBER,
        P_OLD_RISK_FC_ORG_SI                  IN         NUMBER,
        P_OLD_RISK_LC_ORG_SI                  IN         NUMBER,
        P_OLD_RISK_FC_PREM                    IN         NUMBER,
        P_OLD_RISK_LC_PREM                    IN         NUMBER,
        P_OLD_RISK_FC_ORG_PREM                IN         NUMBER,
        P_OLD_RISK_LC_ORG_PREM                IN         NUMBER,
        P_OLD_RISK_DEL_FLAG                   IN         VARCHAR2,
        P_OLD_RISK_CR_DT                      IN         DATE,
        P_OLD_RISK_CR_UID                     IN         VARCHAR2,
        P_OLD_RISK_UPD_DT                     IN         DATE,
        P_OLD_RISK_UPD_UID                    IN         VARCHAR2,
        P_OLD_RISK_PML_PERC                   IN         NUMBER,
        P_OLD_RISK_LC_PML_SI                  IN         NUMBER,
        P_OLD_RISK_FC_PML_SI                  IN         NUMBER,
        P_OLD_RISK_LC_ORG_PML_SI              IN         NUMBER,
        P_OLD_RISK_FC_ORG_PML_SI              IN         NUMBER,
        P_OLD_RISK_LINK_SYS_ID                IN         NUMBER,
        P_NEW_RISK_SYS_ID                     IN          NUMBER,
        P_NEW_RISK_POL_SYS_ID                 IN          NUMBER,
        P_NEW_RISK_CLASS                      IN         VARCHAR2,
        P_NEW_RISK_ENTRY_DT                   IN         DATE,
        P_NEW_RISK_EXIT_DT                    IN         DATE,
        P_NEW_RISK_TYPE                       IN         VARCHAR2,
        P_NEW_RISK_BLD_NO                     IN         VARCHAR2,
        P_NEW_RISK_ROAD_NO                    IN         VARCHAR2,
        P_NEW_RISK_AREA_NO                    IN         VARCHAR2,
        P_NEW_RISK_DESC                       IN          VARCHAR2,
        P_NEW_RISK_SI_CURR_CODE               IN         VARCHAR2,
        P_NEW_RISK_FC_SI                      IN         NUMBER,
        P_NEW_RISK_LC_SI                      IN         NUMBER,
        P_NEW_RISK_FC_ORG_SI                  IN         NUMBER,
        P_NEW_RISK_LC_ORG_SI                  IN         NUMBER,
        P_NEW_RISK_FC_PREM                    IN         NUMBER,
        P_NEW_RISK_LC_PREM                    IN         NUMBER,
        P_NEW_RISK_FC_ORG_PREM                IN         NUMBER,
        P_NEW_RISK_LC_ORG_PREM                IN         NUMBER,
        P_NEW_RISK_DEL_FLAG                   IN         VARCHAR2,
        P_NEW_RISK_CR_DT                      IN         DATE,
        P_NEW_RISK_CR_UID                     IN         VARCHAR2,
        P_NEW_RISK_UPD_DT                     IN         DATE,
        P_NEW_RISK_UPD_UID                    IN         VARCHAR2,
        P_NEW_RISK_PML_PERC                   IN         VARCHAR2,
        P_NEW_RISK_LC_PML_SI                  IN         VARCHAR2,
        P_NEW_RISK_FC_PML_SI                  IN         VARCHAR2,
        P_NEW_RISK_LC_ORG_PML_SI              IN         VARCHAR2,
        P_NEW_RISK_FC_ORG_PML_SI              IN         VARCHAR2,
        P_NEW_RISK_LINK_SYS_ID                IN         NUMBER,
        P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_RISK
       WHERE  RISKH_SYS_ID     = NVL(P_OLD_RISK_SYS_ID, P_NEW_RISK_SYS_ID)
       AND    RISKH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF RISKH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_RISK_POL_SYS_ID, P_NEW_RISK_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
Press <Enter> to continue...
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_RISK (
	     RISKH_SYS_ID, RISKH_END_NO_IDX, RISKH_POL_SYS_ID,
             RISKH_O_CLASS, RISKH_O_TYPE, RISKH_O_BLD_NO, RISKH_O_ROAD_NO,
             RISKH_O_AREA_NO, RISKH_O_ENTRY_DT, RISKH_O_EXIT_DT,
             RISKH_O_DESC, RISKH_O_SI_CURR_CODE, RISKH_O_FC_SI,
             RISKH_O_LC_SI, RISKH_O_FC_PREM, RISKH_O_LC_PREM,
             RISKH_O_DEL_FLAG, RISKH_O_CR_DT, RISKH_O_CR_UID,
             RISKH_O_UPD_DT, RISKH_O_UPD_UID,
             RISKH_O_PML_PERC,  RISKH_O_LC_PML_SI, RISKH_O_FC_PML_SI,
             RISKH_LINK_SYS_ID,
             RISKH_N_CLASS,
             RISKH_N_TYPE, RISKH_N_BLD_NO, RISKH_N_ROAD_NO,
             RISKH_N_AREA_NO, RISKH_N_ENTRY_DT, RISKH_N_EXIT_DT,
             RISKH_N_DESC, RISKH_N_SI_CURR_CODE, RISKH_N_FC_SI,
             RISKH_N_LC_SI, RISKH_N_FC_PREM, RISKH_N_LC_PREM,
             RISKH_N_DEL_FLAG, RISKH_N_CR_DT, RISKH_N_CR_UID,
             RISKH_N_UPD_DT, RISKH_N_UPD_UID,
             RISKH_N_PML_PERC,  RISKH_N_LC_PML_SI, RISKH_N_FC_PML_SI)
      VALUES (
	     DECODE(P_TRG_MODE, 'D', P_OLD_RISK_SYS_ID, P_NEW_RISK_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_RISK_POL_SYS_ID,
                                     P_NEW_RISK_POL_SYS_ID),
             P_OLD_RISK_CLASS, P_OLD_RISK_TYPE, P_OLD_RISK_BLD_NO,
	     P_OLD_RISK_ROAD_NO,
             P_OLD_RISK_AREA_NO, P_OLD_RISK_ENTRY_DT, P_OLD_RISK_EXIT_DT,
             P_OLD_RISK_DESC, P_OLD_RISK_SI_CURR_CODE, P_OLD_RISK_FC_ORG_SI,
             P_OLD_RISK_LC_ORG_SI, P_OLD_RISK_FC_ORG_PREM,
	     P_OLD_RISK_LC_ORG_PREM, P_OLD_RISK_DEL_FLAG, P_OLD_RISK_CR_DT,
             P_OLD_RISK_CR_UID, P_OLD_RISK_UPD_DT, P_OLD_RISK_UPD_UID,
             P_OLD_RISK_PML_PERC, P_OLD_RISK_LC_ORG_PML_SI,
             P_OLD_RISK_FC_ORG_PML_SI,
           DECODE(P_TRG_MODE, 'D', P_OLD_RISK_LINK_SYS_ID, P_NEW_RISK_LINK_SYS_ID),
             P_NEW_RISK_CLASS, P_NEW_RISK_TYPE, P_NEW_RISK_BLD_NO,
	     P_NEW_RISK_ROAD_NO, P_NEW_RISK_AREA_NO, P_NEW_RISK_ENTRY_DT,
	     P_NEW_RISK_EXIT_DT, P_NEW_RISK_DESC, P_NEW_RISK_SI_CURR_CODE,
	     P_NEW_RISK_FC_SI, P_NEW_RISK_LC_SI,
             P_NEW_RISK_FC_PREM, P_NEW_RISK_LC_PREM, P_NEW_RISK_DEL_FLAG,
             P_NEW_RISK_CR_DT, P_NEW_RISK_CR_UID, P_NEW_RISK_UPD_DT,
	     P_NEW_RISK_UPD_UID,
             P_NEW_RISK_PML_PERC, P_NEW_RISK_LC_PML_SI,
             P_NEW_RISK_FC_PML_SI);
   ELSE
      UPDATE PH_RISK
      SET    RISKH_N_CLASS                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_CLASS,
                                                   P_NEW_RISK_CLASS),
             RISKH_N_TYPE                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_TYPE,
                                                 P_NEW_RISK_TYPE),
             RISKH_N_BLD_NO                 = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_BLD_NO,
                                                 P_NEW_RISK_BLD_NO),
             RISKH_N_ROAD_NO                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_ROAD_NO,
                                                 P_NEW_RISK_ROAD_NO),
             RISKH_N_AREA_NO                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_AREA_NO,
                                                 P_NEW_RISK_AREA_NO),
             RISKH_N_ENTRY_DT               = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_ENTRY_DT,
                                                 P_NEW_RISK_ENTRY_DT),
             RISKH_N_EXIT_DT                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_EXIT_DT,
                                                  P_NEW_RISK_EXIT_DT),
             RISKH_N_DESC                   = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_DESC,
                                                 P_NEW_RISK_DESC),
             RISKH_N_SI_CURR_CODE        = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_SI_CURR_CODE,
                                                 P_NEW_RISK_SI_CURR_CODE),
             RISKH_N_FC_SI                  = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_FC_SI,
                                                 P_NEW_RISK_FC_SI),
             RISKH_N_LC_SI                  = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_LC_SI,
                                                 P_NEW_RISK_LC_SI),
             RISKH_N_FC_PREM                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_FC_PREM,
                                                 P_NEW_RISK_FC_PREM),
             RISKH_N_LC_PREM                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_LC_PREM,
                                                 P_NEW_RISK_LC_PREM),
             RISKH_N_DEL_FLAG               = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_DEL_FLAG,
                                                 P_NEW_RISK_DEL_FLAG),
             RISKH_N_CR_DT                  = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_CR_DT,
                                                 P_NEW_RISK_CR_DT),
             RISKH_N_CR_UID                 = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_CR_UID,
                                                 P_NEW_RISK_CR_UID),
             RISKH_N_UPD_DT                 = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_UPD_DT,
                                                 P_NEW_RISK_UPD_DT),
             RISKH_N_UPD_UID                = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_UPD_UID,
                                                 P_NEW_RISK_UPD_UID),
             RISKH_N_PML_PERC               = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_PML_PERC,
                                                 P_NEW_RISK_PML_PERC),
             RISKH_N_LC_PML_SI              = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_LC_PML_SI,
                                                 P_NEW_RISK_LC_PML_SI),
             RISKH_N_FC_PML_SI              = DECODE(P_TRG_MODE, 'D', P_OLD_RISK_FC_PML_SI,
                                                 P_NEW_RISK_FC_PML_SI)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_SHIPMENT(
       P_OLD_SHIP_SYS_ID          IN  NUMBER,
       P_OLD_SHIP_POL_SYS_ID      IN  NUMBER,
       P_OLD_SHIP_SAIL_DT         IN  DATE,
       P_OLD_SHIP_VOYAGE_FM       IN  VARCHAR2,
       P_OLD_SHIP_VOYAGE_TO       IN  VARCHAR2,
       P_OLD_SHIP_CONV_DESC       IN  VARCHAR2,
       P_OLD_SHIP_CONV_TYPE       IN  VARCHAR2,
       P_OLD_SHIP_VES_CODE        IN  VARCHAR2,
       P_OLD_SHIP_VOYAGE_NO       IN  VARCHAR2,
       P_OLD_SHIP_BL_NO           IN  VARCHAR2,
       P_OLD_SHIP_BL_DT           IN  DATE,
       P_OLD_SHIP_ORDER_NO        IN  VARCHAR2,
       P_OLD_SHIP_LC_NO           IN  VARCHAR2,
       P_OLD_SHIP_BANK_NAME       IN  VARCHAR2,
       P_OLD_SHIP_BANK_CODE       IN  VARCHAR2,
       P_OLD_SHIP_ARRIVED_YN      IN  VARCHAR2,
       P_OLD_SHIP_ARRIVED_DT      IN  DATE,
       P_OLD_SHIP_VAL_BASIS       IN  VARCHAR2,
       P_OLD_SHIP_FREIGHT         IN  NUMBER,
       P_OLD_SHIP_CLM_NOTIFY_CUST IN  VARCHAR2,
       P_OLD_SHIP_CR_DT           IN  DATE,
       P_OLD_SHIP_CR_UID          IN  VARCHAR2,
       P_OLD_SHIP_UPD_DT          IN  DATE,
       P_OLD_SHIP_UPD_UID         IN  VARCHAR2,
       P_OLD_SHIP_VES_NAME        IN  VARCHAR2 ,
       P_OLD_SHIP_PORT_FM_NAME    IN  VARCHAR2,
       P_OLD_SHIP_PORT_TO_NAME    IN  VARCHAR2,
       P_NEW_SHIP_SYS_ID          IN  NUMBER,
       P_NEW_SHIP_POL_SYS_ID      IN  NUMBER,
       P_NEW_SHIP_SAIL_DT         IN  DATE,
       P_NEW_SHIP_VOYAGE_FM       IN  VARCHAR2,
       P_NEW_SHIP_VOYAGE_TO       IN  VARCHAR2,
       P_NEW_SHIP_CONV_DESC       IN  VARCHAR2,
       P_NEW_SHIP_CONV_TYPE       IN  VARCHAR2,
       P_NEW_SHIP_VES_CODE        IN  VARCHAR2,
       P_NEW_SHIP_VOYAGE_NO       IN  VARCHAR2,
       P_NEW_SHIP_BL_NO           IN  VARCHAR2,
       P_NEW_SHIP_BL_DT           IN  DATE,
       P_NEW_SHIP_ORDER_NO        IN  VARCHAR2,
       P_NEW_SHIP_LC_NO           IN  VARCHAR2,
       P_NEW_SHIP_BANK_NAME       IN  VARCHAR2,
       P_NEW_SHIP_BANK_CODE       IN  VARCHAR2,
       P_NEW_SHIP_ARRIVED_YN      IN  VARCHAR2,
       P_NEW_SHIP_ARRIVED_DT      IN  DATE,
       P_NEW_SHIP_VAL_BASIS       IN  VARCHAR2,
       P_NEW_SHIP_FREIGHT         IN  NUMBER,
       P_NEW_SHIP_CLM_NOTIFY_CUST IN  VARCHAR2,
       P_NEW_SHIP_CR_DT           IN  DATE,
       P_NEW_SHIP_CR_UID          IN  VARCHAR2,
       P_NEW_SHIP_UPD_DT          IN  DATE,
       P_NEW_SHIP_UPD_UID         IN  VARCHAR2,
       P_NEW_SHIP_VES_NAME        IN  VARCHAR2 ,
       P_NEW_SHIP_PORT_FM_NAME    IN  VARCHAR2,
       P_NEW_SHIP_PORT_TO_NAME    IN  VARCHAR2,
       P_TRG_MODE                 IN  VARCHAR) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_SHIPMENT
       WHERE  SHIPH_SYS_ID     = NVL(P_OLD_SHIP_SYS_ID, P_NEW_SHIP_SYS_ID)
       AND    SHIPH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF SHIPH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
   M_POL_SYS_ID := NVL(P_OLD_SHIP_POL_SYS_ID, P_NEW_SHIP_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1;
   FETCH C1 INTO M_TEMP;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_SHIPMENT(SHIPH_SYS_ID,
                              SHIPH_END_NO_IDX,
                              SHIPH_POL_SYS_ID,
                              SHIPH_O_SAIL_DT, SHIPH_O_VOYAGE_FM,
                              SHIPH_O_VOYAGE_TO, SHIPH_O_CONV_DESC,
                              SHIPH_O_CONV_TYPE, SHIPH_O_VES_CODE,
                              SHIPH_O_VOYAGE_NO, SHIPH_O_BL_NO,
                              SHIPH_O_BL_DT, SHIPH_O_ORDER_NO,
                              SHIPH_O_LC_NO, SHIPH_O_BANK_NAME,
                              SHIPH_O_ARRIVED_YN, SHIPH_O_ARRIVED_DT,
                              SHIPH_O_VAL_BASIS, SHIPH_O_FREIGHT,
                              SHIPH_O_CLM_NOTIFY_CUST, SHIPH_O_CR_DT,
                              SHIPH_O_CR_UID, SHIPH_O_UPD_DT,
                              SHIPH_O_UPD_UID,
 			      SHIPH_O_VES_NAME, SHIPH_O_PORT_FM_NAME  ,
			      SHIPH_O_PORT_TO_NAME   , SHIPH_O_BANK_CODE,
			      SHIPH_N_SAIL_DT,
                              SHIPH_N_VOYAGE_FM, SHIPH_N_VOYAGE_TO,
                              SHIPH_N_CONV_DESC, SHIPH_N_CONV_TYPE,
                              SHIPH_N_VES_CODE, SHIPH_N_VOYAGE_NO,
                              SHIPH_N_BL_NO, SHIPH_N_BL_DT,
                              SHIPH_N_ORDER_NO, SHIPH_N_LC_NO,
                              SHIPH_N_BANK_NAME, SHIPH_N_ARRIVED_YN,
                              SHIPH_N_ARRIVED_DT, SHIPH_N_VAL_BASIS,
                              SHIPH_N_FREIGHT, SHIPH_N_CLM_NOTIFY_CUST,
                              SHIPH_N_CR_DT, SHIPH_N_CR_UID,
                              SHIPH_N_UPD_DT, SHIPH_N_UPD_UID,
                              SHIPH_N_VES_NAME, SHIPH_N_PORT_FM_NAME  ,
			      SHIPH_N_PORT_TO_NAME, SHIPH_N_BANK_CODE   )
      VALUES (DECODE(P_TRG_MODE, 'D', P_OLD_SHIP_SYS_ID, P_NEW_SHIP_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_NEW_SHIP_POL_SYS_ID,
		    P_NEW_SHIP_POL_SYS_ID),
             P_OLD_SHIP_SAIL_DT, P_OLD_SHIP_VOYAGE_FM,
             P_OLD_SHIP_VOYAGE_TO, P_OLD_SHIP_CONV_DESC,
             P_OLD_SHIP_CONV_TYPE, P_OLD_SHIP_VES_CODE,
             P_OLD_SHIP_VOYAGE_NO, P_OLD_SHIP_BL_NO,
             P_OLD_SHIP_BL_DT, P_OLD_SHIP_ORDER_NO,
             P_OLD_SHIP_LC_NO, P_OLD_SHIP_BANK_NAME,
             P_OLD_SHIP_ARRIVED_YN, P_OLD_SHIP_ARRIVED_DT,
             P_OLD_SHIP_VAL_BASIS, P_OLD_SHIP_FREIGHT,
             P_OLD_SHIP_CLM_NOTIFY_CUST, P_OLD_SHIP_CR_DT,
             P_OLD_SHIP_CR_UID, P_OLD_SHIP_UPD_DT,
             P_OLD_SHIP_UPD_UID,
		 P_OLD_SHIP_VES_NAME    ,
		 P_OLD_SHIP_PORT_FM_NAME,
	       P_OLD_SHIP_PORT_TO_NAME, P_OLD_SHIP_BANK_CODE,
		 P_NEW_SHIP_SAIL_DT,
             P_NEW_SHIP_VOYAGE_FM, P_NEW_SHIP_VOYAGE_TO,
             P_NEW_SHIP_CONV_DESC, P_NEW_SHIP_CONV_TYPE,
             P_NEW_SHIP_VES_CODE, P_NEW_SHIP_VOYAGE_NO,
             P_NEW_SHIP_BL_NO, P_NEW_SHIP_BL_DT,
             P_NEW_SHIP_ORDER_NO, P_NEW_SHIP_LC_NO,
             P_NEW_SHIP_BANK_NAME, P_NEW_SHIP_ARRIVED_YN,
             P_NEW_SHIP_ARRIVED_DT, P_NEW_SHIP_VAL_BASIS,
             P_NEW_SHIP_FREIGHT, P_NEW_SHIP_CLM_NOTIFY_CUST,
             P_NEW_SHIP_CR_DT, P_NEW_SHIP_CR_UID,
             P_NEW_SHIP_UPD_DT, P_NEW_SHIP_UPD_UID,
		 P_NEW_SHIP_VES_NAME    ,
		 P_NEW_SHIP_PORT_FM_NAME,
	       P_NEW_SHIP_PORT_TO_NAME, P_NEW_SHIP_BANK_CODE );
   ELSE
      UPDATE PH_SHIPMENT
      SET    SHIPH_N_SAIL_DT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_SAIL_DT,P_NEW_SHIP_SAIL_DT),
             SHIPH_N_VOYAGE_FM       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VOYAGE_FM,
					P_NEW_SHIP_VOYAGE_FM),
             SHIPH_N_VOYAGE_TO       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VOYAGE_TO,
					P_NEW_SHIP_VOYAGE_TO),
             SHIPH_N_CONV_DESC       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_CONV_DESC,
					P_NEW_SHIP_CONV_DESC),
             SHIPH_N_CONV_TYPE       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_CONV_TYPE,
					P_NEW_SHIP_CONV_TYPE),
             SHIPH_N_VES_CODE        = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VES_CODE,
					P_NEW_SHIP_VES_CODE),
             SHIPH_N_VOYAGE_NO       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VOYAGE_NO,
					P_NEW_SHIP_VOYAGE_NO),
             SHIPH_N_BL_NO           = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_BL_NO,P_NEW_SHIP_BL_NO),
             SHIPH_N_BL_DT           = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_BL_DT,P_NEW_SHIP_BL_DT),
             SHIPH_N_ORDER_NO        = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_ORDER_NO,
					P_NEW_SHIP_ORDER_NO),
             SHIPH_N_LC_NO           = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_LC_NO,P_NEW_SHIP_LC_NO),
             SHIPH_N_BANK_NAME       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_BANK_NAME,
					P_NEW_SHIP_BANK_NAME),
             SHIPH_N_ARRIVED_YN      = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_ARRIVED_YN,
					P_NEW_SHIP_ARRIVED_YN),
             SHIPH_N_ARRIVED_DT      = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_ARRIVED_DT,
					P_NEW_SHIP_ARRIVED_DT),
             SHIPH_N_VAL_BASIS       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VAL_BASIS,
					P_NEW_SHIP_VAL_BASIS),
             SHIPH_N_FREIGHT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_FREIGHT,P_NEW_SHIP_FREIGHT),
             SHIPH_N_CLM_NOTIFY_CUST = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_CLM_NOTIFY_CUST,
					P_NEW_SHIP_CLM_NOTIFY_CUST),
             SHIPH_N_CR_DT           = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_CR_DT,P_NEW_SHIP_CR_DT),
             SHIPH_N_CR_UID          = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_CR_UID,P_NEW_SHIP_CR_UID),
             SHIPH_N_UPD_DT          = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_UPD_DT,P_NEW_SHIP_UPD_DT),
             SHIPH_N_UPD_UID          = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_UPD_UID,P_NEW_SHIP_UPD_UID),
		SHIPH_N_VES_NAME    =  DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_VES_NAME  ,
					P_NEW_SHIP_VES_NAME  ),
		SHIPH_N_PORT_FM_NAME  = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_PORT_FM_NAME  ,
					P_NEW_SHIP_PORT_FM_NAME    ),
		SHIPH_N_PORT_TO_NAME  = DECODE(P_TRG_MODE, 'D',
					P_OLD_SHIP_PORT_TO_NAME ,
					P_NEW_SHIP_PORT_TO_NAME ),
            SHIPH_N_BANK_CODE    = DECODE(P_TRG_MODE, 'D', P_OLD_SHIP_BANK_CODE,
                                                           P_NEW_SHIP_BANK_CODE)
      WHERE CURRENT OF C1;
   END IF;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_SHIP_GOOD(
       P_OLD_SG_SYS_ID                IN   NUMBER,
       P_OLD_SG_SHIP_SYS_ID           IN   NUMBER,
       P_OLD_SG_OP_SYS_ID             IN   NUMBER,
       P_OLD_SG_CODE                  IN   VARCHAR2,
       P_OLD_SG_DESC                  IN   VARCHAR2,
       P_OLD_SG_CURR_CODE             IN   VARCHAR2,
       P_OLD_SG_FC_INV_AMT            IN   NUMBER,
       P_OLD_SG_FC_ORG_INV_AMT        IN   NUMBER,
       P_OLD_SG_LC_INV_AMT            IN   NUMBER,
       P_OLD_SG_LC_ORG_INV_AMT        IN   NUMBER,
       P_OLD_SG_FC_SI                 IN   NUMBER,
       P_OLD_SG_LC_SI                 IN   NUMBER,
       P_OLD_SG_FC_ORG_SI             IN   NUMBER,
       P_OLD_SG_LC_ORG_SI             IN   NUMBER,
       P_OLD_SG_PREM_RATE             IN   NUMBER,
       P_OLD_SG_DEL_FLAG              IN   VARCHAR2,
       P_OLD_SG_CR_DT                 IN   DATE,
       P_OLD_SG_CR_UID                IN   VARCHAR2,
       P_OLD_SG_UPD_DT                IN   DATE,
       P_OLD_SG_UPD_UID               IN   VARCHAR2,
       P_NEW_SG_SYS_ID                IN   NUMBER,
       P_NEW_SG_SHIP_SYS_ID           IN   NUMBER,
       P_NEW_SG_OP_SYS_ID             IN   NUMBER,
       P_NEW_SG_CODE                  IN   VARCHAR2,
       P_NEW_SG_DESC                  IN   VARCHAR2,
       P_NEW_SG_CURR_CODE             IN   VARCHAR2,
       P_NEW_SG_FC_INV_AMT            IN   NUMBER,
       P_NEW_SG_FC_ORG_INV_AMT        IN   NUMBER,
       P_NEW_SG_LC_INV_AMT            IN   NUMBER,
       P_NEW_SG_LC_ORG_INV_AMT        IN   NUMBER,
       P_NEW_SG_FC_SI                 IN   NUMBER,
       P_NEW_SG_LC_SI                 IN   NUMBER,
       P_NEW_SG_FC_ORG_SI             IN   NUMBER,
       P_NEW_SG_LC_ORG_SI             IN   NUMBER,
       P_NEW_SG_PREM_RATE             IN   NUMBER,
       P_NEW_SG_DEL_FLAG              IN   VARCHAR2,
       P_NEW_SG_CR_DT                 IN   DATE,
       P_NEW_SG_CR_UID                IN   VARCHAR2,
       P_NEW_SG_UPD_DT                IN   DATE,
       P_NEW_SG_UPD_UID               IN   VARCHAR2,
       P_TRG_MODE                     IN   VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_SHIP_GOOD
       WHERE  SGH_SYS_ID     = NVL(P_OLD_SG_SYS_ID, P_NEW_SG_SYS_ID)
       AND    SGH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF SGH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT SHIP_POL_SYS_ID
       FROM   PT_SHIPMENT
       WHERE  SHIP_SYS_ID = NVL(P_OLD_SG_SHIP_SYS_ID, P_NEW_SG_SHIP_SYS_ID)
       AND    NVL(P_OLD_SG_SHIP_SYS_ID,0) +
	      NVL(P_NEW_SG_SHIP_SYS_ID,0) != 0
       UNION
       SELECT OP_POL_SYS_ID
       FROM   PT_OPEN_POLICY
       WHERE  OP_SYS_ID = NVL(P_OLD_SG_OP_SYS_ID, P_NEW_SG_OP_SYS_ID)
       AND    NVL(P_OLD_SG_OP_SYS_ID,0) +
	      NVL(P_NEW_SG_OP_SYS_ID,0) != 0 ;
BEGIN
   /* SELECTing Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20002,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1;
   FETCH C1 INTO M_TEMP;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_SHIP_GOOD(SGH_SYS_ID,
                               SGH_END_NO_IDX,
                               SGH_SHIP_SYS_ID,
                               SGH_OP_SYS_ID, SGH_O_CODE,
                               SGH_O_DESC, SGH_O_CURR_CODE,
                               SGH_O_FC_INV_AMT, SGH_O_LC_INV_AMT,
                               SGH_O_FC_SI, SGH_O_LC_SI,
                               SGH_O_PREM_RATE, SGH_O_DEL_FLAG,
                               SGH_O_CR_DT, SGH_O_CR_UID,
                               SGH_O_UPD_DT, SGH_O_UPD_UID,
                               SGH_N_CODE, SGH_N_DESC,
                               SGH_N_CURR_CODE, SGH_N_FC_INV_AMT,
                               SGH_N_LC_INV_AMT, SGH_N_FC_SI,
                               SGH_N_LC_SI, SGH_N_PREM_RATE,
                               SGH_N_DEL_FLAG, SGH_N_CR_DT,
                               SGH_N_CR_UID, SGH_N_UPD_DT,
                               SGH_N_UPD_UID)
      VALUES (DECODE(P_TRG_MODE, 'D', P_OLD_SG_SYS_ID, P_NEW_SG_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_SG_SHIP_SYS_ID, P_NEW_SG_SHIP_SYS_ID),
             P_OLD_SG_OP_SYS_ID, P_OLD_SG_CODE,
             P_OLD_SG_DESC, P_OLD_SG_CURR_CODE,
             P_OLD_SG_FC_ORG_INV_AMT, P_OLD_SG_LC_ORG_INV_AMT,
             P_OLD_SG_FC_ORG_SI, P_OLD_SG_LC_ORG_SI,
             P_OLD_SG_PREM_RATE, P_OLD_SG_DEL_FLAG,
             P_OLD_SG_CR_DT, P_OLD_SG_CR_UID,
             P_OLD_SG_UPD_DT, P_OLD_SG_UPD_UID,
             P_NEW_SG_CODE, P_NEW_SG_DESC,
             P_NEW_SG_CURR_CODE, P_NEW_SG_FC_INV_AMT,
             P_NEW_SG_LC_INV_AMT, P_NEW_SG_FC_SI,
             P_NEW_SG_LC_SI, P_NEW_SG_PREM_RATE,
             P_NEW_SG_DEL_FLAG, P_NEW_SG_CR_DT,
             P_NEW_SG_CR_UID, P_NEW_SG_UPD_DT,
             P_NEW_SG_UPD_UID);
   ELSE
      UPDATE PH_SHIP_GOOD
      SET    SGH_N_CODE       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_CODE,P_NEW_SG_CODE),
             SGH_N_DESC       = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_DESC,P_NEW_SG_DESC),
             SGH_N_CURR_CODE  = DECODE(P_TRG_MODE, 'D', P_OLD_SG_CURR_CODE,
					P_NEW_SG_CURR_CODE),
             SGH_N_FC_INV_AMT = DECODE(P_TRG_MODE, 'D', P_OLD_SG_FC_INV_AMT,
					P_NEW_SG_FC_INV_AMT),
             SGH_N_LC_INV_AMT = DECODE(P_TRG_MODE, 'D', P_OLD_SG_LC_INV_AMT,
					P_NEW_SG_LC_INV_AMT),
             SGH_N_FC_SI      = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_FC_SI,P_NEW_SG_FC_SI),
             SGH_N_LC_SI      = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_LC_SI,P_NEW_SG_LC_SI),
             SGH_N_PREM_RATE  = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_PREM_RATE,P_NEW_SG_PREM_RATE),
             SGH_N_DEL_FLAG   = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_DEL_FLAG,P_NEW_SG_DEL_FLAG),
             SGH_N_CR_DT      = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_CR_DT,P_NEW_SG_CR_DT),
             SGH_N_CR_UID     = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_CR_UID,P_NEW_SG_CR_UID),
             SGH_N_UPD_DT     = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_UPD_DT,P_NEW_SG_UPD_DT),
             SGH_N_UPD_UID    = DECODE(P_TRG_MODE, 'D',
					P_OLD_SG_UPD_UID,P_NEW_SG_UPD_UID)
      WHERE  CURRENT OF C1;
   END IF;
   CLOSE C1;
END;
/
CREATE OR REPLACE PROCEDURE STP_PT_VEHICLE(
	P_OLD_VEH_SYS_ID                      IN         NUMBER,
	P_OLD_VEH_POL_SYS_ID                  IN         NUMBER,
	P_OLD_VEH_TYPE                        IN         VARCHAR,
	P_OLD_VEH_VEHICLE_ID                  IN         VARCHAR,
	P_OLD_VEH_CHASSIS_NO                  IN         VARCHAR,
	P_OLD_VEH_ENGINE_NO                   IN         VARCHAR,
	P_OLD_VEH_REGN_NO                     IN         VARCHAR,
	P_OLD_VEH_PLATE_COL_CODE              IN         VARCHAR,
	P_OLD_VEH_DOC_NO                      IN         VARCHAR,
	P_OLD_VEH_ENTRY_DT                    IN         DATE,
	P_OLD_VEH_EXIT_DT                     IN         DATE,
	P_OLD_VEH_YEAR                        IN         NUMBER,
	P_OLD_VEH_CC                          IN         NUMBER,
	P_OLD_VEH_CYL_CODE                    IN         VARCHAR2,
	P_OLD_VEH_MAKE_CODE                   IN         VARCHAR2,
	P_OLD_VEH_WT_CODE                     IN         VARCHAR2,
	P_OLD_VEH_AREA_CODE                   IN         VARCHAR2,
	P_OLD_VEH_EXT_AREA_DESC               IN         VARCHAR2,
	P_OLD_VEH_BODY_TYPE                   IN         VARCHAR2,
	P_OLD_VEH_NO_PASS                     IN         NUMBER,
	P_OLD_VEH_COLOR_CODE                  IN         VARCHAR2,
	P_OLD_VEH_AGENCY_FLAG                 IN         VARCHAR2,
	P_OLD_VEH_CURR_CODE                   IN         VARCHAR2,
	P_OLD_VEH_FC_AMT                      IN         NUMBER,
	P_OLD_VEH_LC_AMT                      IN         NUMBER,
	P_OLD_VEH_MAX_REP_VALUE               IN         NUMBER,
	P_OLD_VEH_DEL_FLAG                    IN         VARCHAR2,
	P_OLD_VEH_CR_DT                       IN         DATE,
	P_OLD_VEH_CR_UID                      IN         VARCHAR2,
	P_OLD_VEH_UPD_DT                      IN         DATE,
	P_OLD_VEH_UPD_UID                     IN         VARCHAR2,
	P_OLD_VEH_LOAD_CAP                     IN         VARCHAR2,
        P_OLD_VEH_CERT_FM_DT                  IN         DATE,
        P_OLD_VEH_CERT_TO_DT                  IN         DATE,
        P_OLD_VEH_BANK_CODE                   IN         VARCHAR2,
	P_NEW_VEH_SYS_ID                      IN         NUMBER,
	P_NEW_VEH_POL_SYS_ID                  IN         NUMBER,
	P_NEW_VEH_TYPE                        IN         VARCHAR,
        P_NEW_VEH_VEHICLE_ID                  IN         VARCHAR,
	P_NEW_VEH_CHASSIS_NO                  IN         VARCHAR,
	P_NEW_VEH_ENGINE_NO                   IN         VARCHAR,
	P_NEW_VEH_REGN_NO                     IN         VARCHAR,
	P_NEW_VEH_PLATE_COL_CODE              IN         VARCHAR,
	P_NEW_VEH_DOC_NO                      IN         VARCHAR,
	P_NEW_VEH_ENTRY_DT                    IN         DATE,
	P_NEW_VEH_EXIT_DT                     IN         DATE,
	P_NEW_VEH_YEAR                        IN         NUMBER,
	P_NEW_VEH_CC                          IN         NUMBER,
	P_NEW_VEH_CYL_CODE                    IN         VARCHAR2,
	P_NEW_VEH_MAKE_CODE                   IN         VARCHAR2,
	P_NEW_VEH_WT_CODE                     IN         VARCHAR2,
	P_NEW_VEH_AREA_CODE                   IN         VARCHAR2,
	P_NEW_VEH_EXT_AREA_DESC               IN         VARCHAR2,
	P_NEW_VEH_BODY_TYPE                   IN         VARCHAR2,
	P_NEW_VEH_NO_PASS                     IN         NUMBER,
	P_NEW_VEH_COLOR_CODE                  IN         VARCHAR2,
	P_NEW_VEH_AGENCY_FLAG                 IN         VARCHAR2,
	P_NEW_VEH_CURR_CODE                   IN         VARCHAR2,
	P_NEW_VEH_FC_AMT                      IN         NUMBER,
	P_NEW_VEH_LC_AMT                      IN         NUMBER,
	P_NEW_VEH_MAX_REP_VALUE               IN         NUMBER,
	P_NEW_VEH_DEL_FLAG                    IN         VARCHAR2,
	P_NEW_VEH_CR_DT                       IN         DATE,
	P_NEW_VEH_CR_UID                      IN         VARCHAR2,
	P_NEW_VEH_UPD_DT                      IN         DATE,
	P_NEW_VEH_UPD_UID                     IN         VARCHAR2,
	P_NEW_VEH_LOAD_CAP                     IN         VARCHAR2,
        P_NEW_VEH_CERT_FM_DT                  IN         DATE,
        P_NEW_VEH_CERT_TO_DT                  IN         DATE,
        P_NEW_VEH_BANK_CODE                   IN         VARCHAR2,
	P_TRG_MODE                            IN         VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_VEHICLE
       WHERE  VEHH_SYS_ID     = NVL(P_OLD_VEH_SYS_ID, P_NEW_VEH_SYS_ID)
       AND    VEHH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF VEHH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_VEH_POL_SYS_ID, P_NEW_VEH_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
	    'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_VEHICLE
	    (VEHH_SYS_ID, VEHH_END_NO_IDX, VEHH_POL_SYS_ID,
	     VEHH_VEHICLE_ID, VEHH_O_TYPE,
	     VEHH_O_CHASSIS_NO, VEHH_O_ENGINE_NO, VEHH_O_REGN_NO,
	     VEHH_O_PLATE_COL_CODE, VEHH_O_DOC_NO, VEHH_O_ENTRY_DT,
	     VEHH_O_EXIT_DT, VEHH_O_YEAR, VEHH_O_CC, VEHH_O_CYL_CODE,
	     VEHH_O_MAKE_CODE, VEHH_O_WT_CODE, VEHH_O_AREA_CODE,
	     VEHH_O_EXT_AREA_DESC, VEHH_O_BODY_TYPE, VEHH_O_NO_PASS,
	     VEHH_O_COLOR_CODE, VEHH_O_AGENCY_FLAG, VEHH_O_CURR_CODE,
	     VEHH_O_FC_AMT, VEHH_O_LC_AMT, VEHH_O_MAX_REP_VALUE,
	     VEHH_O_DEL_FLAG, VEHH_O_CR_DT, VEHH_O_CR_UID, VEHH_O_UPD_DT,
             VEHH_O_UPD_UID, VEHH_O_LOAD_CAP, VEHH_O_CERT_FM_DT,
             VEHH_O_CERT_TO_DT,VEHH_O_BANK_CODE,VEHH_N_TYPE,
	     VEHH_N_CHASSIS_NO, VEHH_N_ENGINE_NO, VEHH_N_REGN_NO,
	     VEHH_N_PLATE_COL_CODE, VEHH_N_DOC_NO, VEHH_N_ENTRY_DT,
	     VEHH_N_EXIT_DT, VEHH_N_YEAR, VEHH_N_CC, VEHH_N_CYL_CODE,
	     VEHH_N_MAKE_CODE, VEHH_N_WT_CODE, VEHH_N_AREA_CODE,
	     VEHH_N_EXT_AREA_DESC, VEHH_N_BODY_TYPE, VEHH_N_NO_PASS,
	     VEHH_N_COLOR_CODE, VEHH_N_AGENCY_FLAG, VEHH_N_CURR_CODE,
	     VEHH_N_FC_AMT, VEHH_N_LC_AMT, VEHH_N_MAX_REP_VALUE,
	     VEHH_N_DEL_FLAG, VEHH_N_CR_DT, VEHH_N_CR_UID,
	     VEHH_N_UPD_DT, VEHH_N_UPD_UID, VEHH_N_LOAD_CAP, VEHH_N_CERT_FM_DT,
             VEHH_N_CERT_TO_DT, VEHH_N_BANK_CODE )
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_VEH_SYS_ID, P_NEW_VEH_SYS_ID),
	     M_END_NO_IDX,
	     DECODE(P_TRG_MODE, 'D', P_OLD_VEH_POL_SYS_ID,
				     P_NEW_VEH_POL_SYS_ID),
	     DECODE(P_TRG_MODE, 'D', P_OLD_VEH_VEHICLE_ID,
				     P_NEW_VEH_VEHICLE_ID),
	     P_OLD_VEH_TYPE,
	     P_OLD_VEH_CHASSIS_NO, P_OLD_VEH_ENGINE_NO, P_OLD_VEH_REGN_NO,
	     P_OLD_VEH_PLATE_COL_CODE, P_OLD_VEH_DOC_NO, P_OLD_VEH_ENTRY_DT,
	     P_OLD_VEH_EXIT_DT, P_OLD_VEH_YEAR, P_OLD_VEH_CC,
	     P_OLD_VEH_CYL_CODE, P_OLD_VEH_MAKE_CODE,
	     P_OLD_VEH_WT_CODE, P_OLD_VEH_AREA_CODE, P_OLD_VEH_EXT_AREA_DESC,
	     P_OLD_VEH_BODY_TYPE, P_OLD_VEH_NO_PASS, P_OLD_VEH_COLOR_CODE,
	     P_OLD_VEH_AGENCY_FLAG, P_OLD_VEH_CURR_CODE, P_OLD_VEH_FC_AMT,
	     P_OLD_VEH_LC_AMT, P_OLD_VEH_MAX_REP_VALUE,
	     P_OLD_VEH_DEL_FLAG, P_OLD_VEH_CR_DT, P_OLD_VEH_CR_UID,
	     P_OLD_VEH_UPD_DT, P_OLD_VEH_UPD_UID, P_OLD_VEH_LOAD_CAP, P_OLD_VEH_CERT_FM_DT,
             P_OLD_VEH_CERT_TO_DT, P_OLD_VEH_BANK_CODE, P_NEW_VEH_TYPE,
	     P_NEW_VEH_CHASSIS_NO, P_NEW_VEH_ENGINE_NO, P_NEW_VEH_REGN_NO,
	     P_NEW_VEH_PLATE_COL_CODE, P_NEW_VEH_DOC_NO,
	     P_NEW_VEH_ENTRY_DT, P_NEW_VEH_EXIT_DT, P_NEW_VEH_YEAR,
	     P_NEW_VEH_CC, P_NEW_VEH_CYL_CODE, P_NEW_VEH_MAKE_CODE,
	     P_NEW_VEH_WT_CODE, P_NEW_VEH_AREA_CODE,
	     P_NEW_VEH_EXT_AREA_DESC, P_NEW_VEH_BODY_TYPE, P_NEW_VEH_NO_PASS,
	     P_NEW_VEH_COLOR_CODE, P_NEW_VEH_AGENCY_FLAG, P_NEW_VEH_CURR_CODE,
	     P_NEW_VEH_FC_AMT, P_NEW_VEH_LC_AMT, P_NEW_VEH_MAX_REP_VALUE,
	     P_NEW_VEH_DEL_FLAG,
	     P_NEW_VEH_CR_DT, P_NEW_VEH_CR_UID, P_NEW_VEH_UPD_DT,
             P_NEW_VEH_UPD_UID, P_NEW_VEH_LOAD_CAP, P_NEW_VEH_CERT_FM_DT, P_NEW_VEH_CERT_TO_DT,
             P_NEW_VEH_BANK_CODE);
   ELSE
      UPDATE PH_VEHICLE
      SET    VEHH_N_TYPE           = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_TYPE,P_NEW_VEH_TYPE),
	     VEHH_N_CHASSIS_NO     = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CHASSIS_NO,
					P_NEW_VEH_CHASSIS_NO),
	     VEHH_N_ENGINE_NO      = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_ENGINE_NO,
					P_NEW_VEH_ENGINE_NO),
	     VEHH_N_REGN_NO        = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_REGN_NO,P_NEW_VEH_REGN_NO),
	     VEHH_N_PLATE_COL_CODE = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_PLATE_COL_CODE,
					P_NEW_VEH_PLATE_COL_CODE),
	     VEHH_N_DOC_NO         = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_DOC_NO,P_NEW_VEH_DOC_NO),
	     VEHH_N_ENTRY_DT       = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_ENTRY_DT,P_NEW_VEH_ENTRY_DT),
	     VEHH_N_EXIT_DT        = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_EXIT_DT,P_NEW_VEH_EXIT_DT),
	     VEHH_N_YEAR           = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_YEAR,P_NEW_VEH_YEAR),
	     VEHH_N_CC             = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CC,P_NEW_VEH_CC),
	     VEHH_N_CYL_CODE       = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CYL_CODE,P_NEW_VEH_CYL_CODE),
	     VEHH_N_MAKE_CODE      = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_MAKE_CODE,
					P_NEW_VEH_MAKE_CODE),
	     VEHH_N_WT_CODE        = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_WT_CODE,P_NEW_VEH_WT_CODE),
	     VEHH_N_AREA_CODE      = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_AREA_CODE,
					P_NEW_VEH_AREA_CODE),
	     VEHH_N_EXT_AREA_DESC  = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_EXT_AREA_DESC,
					P_NEW_VEH_EXT_AREA_DESC),
	     VEHH_N_BODY_TYPE      = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_BODY_TYPE,
					P_NEW_VEH_BODY_TYPE),
	     VEHH_N_NO_PASS        = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_NO_PASS,P_NEW_VEH_NO_PASS),
	     VEHH_N_COLOR_CODE     = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_COLOR_CODE,
					P_NEW_VEH_COLOR_CODE),
	     VEHH_N_AGENCY_FLAG    = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_AGENCY_FLAG,
					P_NEW_VEH_AGENCY_FLAG),
	     VEHH_N_CURR_CODE      = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CURR_CODE,
					P_NEW_VEH_CURR_CODE),
	     VEHH_N_FC_AMT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_FC_AMT,P_NEW_VEH_FC_AMT),
	     VEHH_N_LC_AMT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_LC_AMT,P_NEW_VEH_LC_AMT),
	     VEHH_N_MAX_REP_VALUE  = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_MAX_REP_VALUE,
					P_NEW_VEH_MAX_REP_VALUE),
	     VEHH_N_DEL_FLAG       = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_DEL_FLAG,P_NEW_VEH_DEL_FLAG),
	     VEHH_N_CR_DT          = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CR_DT,P_NEW_VEH_CR_DT),
	     VEHH_N_CR_UID         = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_CR_UID,P_NEW_VEH_CR_UID),
	     VEHH_N_UPD_DT         = DECODE(P_TRG_MODE, 'D',
					P_OLD_VEH_UPD_DT,P_NEW_VEH_UPD_DT),
	     VEHH_N_UPD_UID        = DECODE(P_TRG_MODE, 'D',
                                        P_OLD_VEH_UPD_UID,P_NEW_VEH_UPD_UID),
             VEHH_N_LOAD_CAP      = DECODE(P_TRG_MODE, 'D',
                                        P_OLD_VEH_LOAD_CAP, P_NEW_VEH_LOAD_CAP),
             VEHH_N_CERT_FM_DT     = DECODE(P_TRG_MODE, 'D',
                                        P_OLD_VEH_CERT_FM_DT, P_NEW_VEH_CERT_FM_DT),
             VEHH_N_CERT_TO_DT     = DECODE(P_TRG_MODE, 'D',
                                        P_OLD_VEH_CERT_TO_DT, P_NEW_VEH_CERT_TO_DT),
             VEHH_N_BANK_CODE      = DECODE(P_TRG_MODE, 'D',
                                        P_OLD_VEH_BANK_CODE, P_NEW_VEH_BANK_CODE)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_VEHICLE_ADDL_DTL(
	P_OLD_VAD_VEH_SYS_ID		IN NUMBER,
	P_OLD_VAD_SYS_ID		IN NUMBER,
	P_OLD_VAD_FUEL_TYPE		IN VARCHAR2,
	P_OLD_VAD_MODEL			IN VARCHAR2,
	P_OLD_VAD_USED_UNUSED		IN VARCHAR2,
	P_OLD_VAD_REGN_PURPOSE		IN VARCHAR2,
	P_OLD_VAD_TRANS_TYPE		IN VARCHAR2,
	P_OLD_VAD_CUSTOMS_CERT_NO	IN VARCHAR2,
	P_OLD_VAD_CUSTOMS_CERT_DT	IN DATE,
	P_OLD_VAD_TP_POL_NO		IN VARCHAR2,
	P_OLD_VAD_TP_INS_COMP		IN VARCHAR2,
	P_OLD_VAD_DROP_TYPE		IN VARCHAR2,
	P_OLD_VAD_DROP_DEST		IN VARCHAR2,
	P_OLD_VAD_DEL_FLAG		IN VARCHAR2,
	P_OLD_VAD_BENE_NAME		IN VARCHAR2,
	P_OLD_VAD_SELLER_ID		IN VARCHAR2,
	P_OLD_VAD_SELLER_NAME		IN VARCHAR2,
	P_OLD_VAD_CR_DT			IN DATE,
	P_OLD_VAD_CR_UID		IN VARCHAR2,
	P_OLD_VAD_UPD_DT		IN DATE,
	P_OLD_VAD_UPD_UID		IN VARCHAR2,
	P_NEW_VAD_VEH_SYS_ID		IN NUMBER,
	P_NEW_VAD_SYS_ID		IN NUMBER,
	P_NEW_VAD_FUEL_TYPE		IN VARCHAR2,
	P_NEW_VAD_MODEL			IN VARCHAR2,
	P_NEW_VAD_USED_UNUSED		IN VARCHAR2,
	P_NEW_VAD_REGN_PURPOSE		IN VARCHAR2,
	P_NEW_VAD_TRANS_TYPE		IN VARCHAR2,
	P_NEW_VAD_CUSTOMS_CERT_NO	IN VARCHAR2,
	P_NEW_VAD_CUSTOMS_CERT_DT	IN DATE,
	P_NEW_VAD_TP_POL_NO		IN VARCHAR2,
	P_NEW_VAD_TP_INS_COMP		IN VARCHAR2,
	P_NEW_VAD_DROP_TYPE		IN VARCHAR2,
	P_NEW_VAD_DROP_DEST		IN VARCHAR2,
	P_NEW_VAD_DEL_FLAG		IN VARCHAR2,
	P_NEW_VAD_BENE_NAME		IN VARCHAR2,
	P_NEW_VAD_SELLER_ID		IN VARCHAR2,
	P_NEW_VAD_SELLER_NAME		IN VARCHAR2,
	P_NEW_VAD_CR_DT			IN DATE,
	P_NEW_VAD_CR_UID		IN VARCHAR2,
	P_NEW_VAD_UPD_DT		IN DATE,
	P_NEW_VAD_UPD_UID		IN VARCHAR2,
	P_TRG_MODE			IN VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_VEHICLE_ADDL_DTL
       WHERE  VADH_SYS_ID     = NVL(P_OLD_VAD_SYS_ID, P_NEW_VAD_SYS_ID)
       AND    VADH_VEH_SYS_ID     = NVL(P_OLD_VAD_VEH_SYS_ID, P_NEW_VAD_VEH_SYS_ID)
       AND    VADH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF VADH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
CURSOR C3 IS
       SELECT VEH_POL_SYS_ID
       FROM   PT_VEHICLE
       WHERE  VEH_SYS_ID = NVL(P_OLD_VAD_VEH_SYS_ID, P_NEW_VAD_VEH_SYS_ID);
BEGIN
   /* SELECTing Policy SYS ID */
   IF C3%ISOPEN THEN
      CLOSE C3 ;
   END IF;
   OPEN C3 ;
   FETCH C3 INTO M_POL_SYS_ID ;
   IF C3%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C3 ;
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
	INSERT INTO PH_VEHICLE_ADDL_DTL (
	 VADH_VEH_SYS_ID , VADH_SYS_ID  , VADH_END_NO_IDX ,
	 VADH_O_FUEL_TYPE , VADH_O_MODEL , VADH_O_USED_UNUSED ,
	 VADH_O_REGN_PURPOSE , VADH_O_TRANS_TYPE, VADH_O_CUSTOMS_CERT_NO,
	 VADH_O_CUSTOMS_CERT_DT , VADH_O_TP_POL_NO,
	 VADH_O_TP_INS_COMP       , VADH_O_DROP_TYPE,
	 VADH_O_DROP_DEST , VADH_O_DEL_FLAG   ,
	 VADH_O_CR_DT       , VADH_O_CR_UID       ,
	 VADH_O_UPD_DT        , VADH_O_UPD_UID        ,
	 VADH_N_FUEL_TYPE       , VADH_N_MODEL            ,
	 VADH_N_USED_UNUSED       , VADH_N_REGN_PURPOSE      ,
	 VADH_N_TRANS_TYPE         , VADH_N_CUSTOMS_CERT_NO     ,
	 VADH_N_CUSTOMS_CERT_DT      , VADH_N_TP_POL_NO             ,
	 VADH_N_TP_INS_COMP            , VADH_N_DROP_TYPE               ,
	 VADH_N_DROP_DEST                , VADH_N_DEL_FLAG                  ,
	 VADH_N_CR_DT              , VADH_N_CR_UID                      ,
	 VADH_N_UPD_DT, VADH_N_UPD_UID  )
 VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_VAD_VEH_SYS_ID, P_NEW_VAD_VEH_SYS_ID),
	DECODE(P_TRG_MODE, 'D', P_OLD_VAD_SYS_ID, P_NEW_VAD_SYS_ID),
             M_END_NO_IDX,	P_OLD_VAD_FUEL_TYPE,
	P_OLD_VAD_MODEL	,	P_OLD_VAD_USED_UNUSED,
	P_OLD_VAD_REGN_PURPOSE,	P_OLD_VAD_TRANS_TYPE	,
	P_OLD_VAD_CUSTOMS_CERT_NO,	P_OLD_VAD_CUSTOMS_CERT_DT,
	P_OLD_VAD_TP_POL_NO	,	P_OLD_VAD_TP_INS_COMP,
	P_OLD_VAD_DROP_TYPE	,	P_OLD_VAD_DROP_DEST	,
	P_OLD_VAD_DEL_FLAG	,	P_OLD_VAD_CR_DT,
	P_OLD_VAD_CR_UID,	P_OLD_VAD_UPD_DT,
	P_OLD_VAD_UPD_UID,	P_NEW_VAD_FUEL_TYPE	,
	P_NEW_VAD_MODEL,	P_NEW_VAD_USED_UNUSED,
	P_NEW_VAD_REGN_PURPOSE,	P_NEW_VAD_TRANS_TYPE	,
	P_NEW_VAD_CUSTOMS_CERT_NO,	P_NEW_VAD_CUSTOMS_CERT_DT,
	P_NEW_VAD_TP_POL_NO	,	P_NEW_VAD_TP_INS_COMP,
	P_NEW_VAD_DROP_TYPE	,	P_NEW_VAD_DROP_DEST	,
	P_NEW_VAD_DEL_FLAG	,	P_NEW_VAD_CR_DT,
	P_NEW_VAD_CR_UID,	P_NEW_VAD_UPD_DT,
	P_NEW_VAD_UPD_UID);
   ELSE
      UPDATE PH_VEHICLE_ADDL_DTL
      SET    VADH_N_FUEL_TYPE          = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_FUEL_TYPE),
             VADH_N_MODEL         = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_MODEL),
             VADH_N_USED_UNUSED        = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_USED_UNUSED),
             VADH_N_REGN_PURPOSE            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_REGN_PURPOSE),
             VADH_N_TRANS_TYPE     = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_TRANS_TYPE),
             VADH_N_CUSTOMS_CERT_NO    = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_CUSTOMS_CERT_NO),
             VADH_N_CUSTOMS_CERT_DT     = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_CUSTOMS_CERT_DT),
             VADH_N_TP_POL_NO            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_TP_POL_NO),
             VADH_N_TP_INS_COMP               = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_TP_INS_COMP),
             VADH_N_DROP_TYPE                 = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_DROP_TYPE),
             VADH_N_DROP_DEST           = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_DROP_DEST),
             VADH_N_DEL_FLAG           = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_DEL_FLAG),
             VADH_N_CR_DT              = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_CR_DT),
             VADH_N_CR_UID             = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_CR_UID),
             VADH_N_UPD_DT             = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_UPD_DT),
             VADH_N_UPD_UID            = DECODE(P_TRG_MODE, 'D', NULL,
                                                P_NEW_VAD_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE STP_PT_VESSEL(
         P_OLD_VES_SYS_ID                IN               NUMBER,
        P_OLD_VES_POL_SYS_ID            IN               NUMBER,
         P_OLD_VES_ID                    IN               VARCHAR2,
         P_OLD_VES_NAME                  IN               VARCHAR2,
         P_OLD_VES_OWNER_MGR             IN              VARCHAR2,
         P_OLD_VES_TYPE                  IN                     VARCHAR2,
         P_OLD_VES_ENTRY_DT              IN              DATE,
         P_OLD_VES_EXIT_DT               IN              DATE,
         P_OLD_VES_COUNTRY_CODE          IN              VARCHAR2,
         P_OLD_VES_GRT                   IN              NUMBER,
         P_OLD_VES_DWT                   IN              NUMBER,
         P_OLD_VES_YEAR                  IN              NUMBER,
         P_OLD_VES_CLASSIFICATION_CODE   IN              VARCHAR2,
         P_OLD_VES_NAVIGATION            IN              VARCHAR2,
         P_OLD_VES_CONS_MTL              IN              VARCHAR2,
         P_OLD_VES_LENGTH_MTS            IN              NUMBER,
         P_OLD_VES_BREADTH_MTS           IN              NUMBER,
         P_OLD_VES_DEPTH_MTS             IN              NUMBER,
         P_OLD_VES_HP_CODE               IN              VARCHAR2,
         P_OLD_VES_NO_ENGINE             IN              NUMBER,
         P_OLD_VES_ENGINE_TYPE           IN              VARCHAR2,
         P_OLD_VES_PI_CLUB               IN              VARCHAR2,
         P_OLD_VES_IDLE_DAYS             IN              NUMBER,
         P_OLD_VES_OPER_DAYS             IN              NUMBER,
         P_OLD_VES_MAX_PASS              IN              NUMBER,
         P_OLD_VES_MAX_CREW              IN              NUMBER,
         P_OLD_VES_CURR_CODE             IN              VARCHAR2,
         P_OLD_VES_FC_AMT                IN              NUMBER,
         P_OLD_VES_LC_AMT                IN              NUMBER,
         P_OLD_VES_DEL_FLAG              IN              VARCHAR2,
         P_OLD_VES_CR_DT                 IN              DATE,
         P_OLD_VES_CR_UID                IN              VARCHAR2,
         P_OLD_VES_UPD_DT                IN              DATE,
         P_OLD_VES_UPD_UID               IN              VARCHAR2,
         P_NEW_VES_SYS_ID                IN               NUMBER,
         P_NEW_VES_POL_SYS_ID            IN               NUMBER,
         P_NEW_VES_ID                    IN               VARCHAR2,
         P_NEW_VES_NAME                  IN               VARCHAR2,
         P_NEW_VES_OWNER_MGR             IN              VARCHAR2,
         P_NEW_VES_TYPE                  IN                     VARCHAR2,
         P_NEW_VES_ENTRY_DT              IN              DATE,
         P_NEW_VES_EXIT_DT               IN              DATE,
         P_NEW_VES_COUNTRY_CODE          IN              VARCHAR2,
         P_NEW_VES_GRT                   IN              NUMBER,
         P_NEW_VES_DWT                   IN              NUMBER,
         P_NEW_VES_YEAR                  IN              NUMBER,
         P_NEW_VES_CLASSIFICATION_CODE   IN              VARCHAR2,
         P_NEW_VES_NAVIGATION            IN              VARCHAR2,
         P_NEW_VES_CONS_MTL              IN              VARCHAR2,
         P_NEW_VES_LENGTH_MTS            IN              NUMBER,
         P_NEW_VES_BREADTH_MTS           IN              NUMBER,
         P_NEW_VES_DEPTH_MTS             IN              NUMBER,
         P_NEW_VES_HP_CODE               IN              VARCHAR2,
         P_NEW_VES_NO_ENGINE             IN              NUMBER,
         P_NEW_VES_ENGINE_TYPE           IN              VARCHAR2,
         P_NEW_VES_PI_CLUB               IN              VARCHAR2,
         P_NEW_VES_IDLE_DAYS             IN              NUMBER,
         P_NEW_VES_OPER_DAYS             IN              NUMBER,
         P_NEW_VES_MAX_PASS              IN              NUMBER,
         P_NEW_VES_MAX_CREW              IN              NUMBER,
         P_NEW_VES_CURR_CODE             IN              VARCHAR2,
         P_NEW_VES_FC_AMT                IN              NUMBER,
         P_NEW_VES_LC_AMT                IN              NUMBER,
         P_NEW_VES_DEL_FLAG              IN              VARCHAR2,
Press <Enter> to continue...
         P_NEW_VES_CR_DT                 IN              DATE,
         P_NEW_VES_CR_UID                IN              VARCHAR2,
         P_NEW_VES_UPD_DT                IN              DATE,
         P_NEW_VES_UPD_UID               IN              VARCHAR2,
              P_TRG_MODE                      IN              VARCHAR2) AS
M_END_NO_IDX           PT_POLICY.POL_END_NO_IDX%TYPE ;
M_APPRV_STATUS         PT_POLICY.POL_APPRV_STATUS%TYPE ;
M_POL_SYS_ID           PT_POLICY.POL_SYS_ID%TYPE ;
M_TEMP                 VARCHAR2(1) ;
CURSOR C1 IS
       SELECT 'X'
       FROM   PH_VESSEL
       WHERE  VESH_SYS_ID     = NVL(P_OLD_VES_SYS_ID, P_NEW_VES_SYS_ID)
       AND    VESH_END_NO_IDX = M_END_NO_IDX
       FOR UPDATE OF VESH_END_NO_IDX ;
CURSOR C2 IS
       SELECT POL_END_NO_IDX, POL_APPRV_STATUS
       FROM   PT_POLICY
       WHERE  POL_SYS_ID = M_POL_SYS_ID ;
BEGIN
   /* SELECTing Policy SYS ID */
  M_POL_SYS_ID := NVL(P_OLD_VES_POL_SYS_ID, P_NEW_VES_POL_SYS_ID);
   /* SELECTing Endorsement Index from Policy Table */
   IF C2%ISOPEN THEN
      CLOSE C2 ;
   END IF;
   OPEN C2 ;
   FETCH C2 INTO M_END_NO_IDX, M_APPRV_STATUS ;
   IF C2%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20001,
            'Invalid policy reference, Contact Software Support') ;
   END IF ;
   CLOSE C2 ;
   /* Nothing is to be done, if it is Approved */
   IF NVL(M_APPRV_STATUS, 'N') != 'N' THEN
      RETURN ;
   END IF ;
   /* Nothing is to be done, if it is not endorsement */
   IF NVL(M_END_NO_IDX, 0) = 0 THEN
      RETURN ;
   END IF ;
   M_END_NO_IDX := NVL(M_END_NO_IDX, 0) - 1 ;
   IF C1%ISOPEN THEN
      CLOSE C1;
   END IF ;
   OPEN C1 ;
   FETCH C1 INTO M_TEMP ;
   IF C1%NOTFOUND THEN
      INSERT INTO PH_VESSEL(VESH_SYS_ID, VESH_END_NO_IDX, VESH_POL_SYS_ID,
                            VESH_O_ID, VESH_O_NAME, VESH_O_OWNER_MGR, VESH_O_TYPE,
                            VESH_O_ENTRY_DT, VESH_O_EXIT_DT, VESH_O_COUNTRY_CODE,
                            VESH_O_GRT, VESH_O_DWT, VESH_O_YEAR, VESH_O_CLASSIFICATION_CODE,
                            VESH_O_NAVIGATION, VESH_O_CONS_MTL, VESH_O_LENGTH_MTS,
                            VESH_O_BREADTH_MTS, VESH_O_DEPTH_MTS, VESH_O_HP_CODE,
                            VESH_O_NO_ENGINE, VESH_O_ENGINE_TYPE, VESH_O_PI_CLUB,
                            VESH_O_IDLE_DAYS, VESH_O_OPER_DAYS, VESH_O_MAX_PASS,
                            VESH_O_MAX_CREW, VESH_O_CURR_CODE, VESH_O_FC_AMT,
                            VESH_O_LC_AMT, VESH_O_DEL_FLAG, VESH_O_CR_DT, VESH_O_CR_UID,
                            VESH_O_UPD_DT, VESH_O_UPD_UID, VESH_N_ID, VESH_N_NAME,
                            VESH_N_OWNER_MGR, VESH_N_TYPE, VESH_N_ENTRY_DT, VESH_N_EXIT_DT,
                            VESH_N_COUNTRY_CODE, VESH_N_GRT, VESH_N_DWT, VESH_N_YEAR,
                            VESH_N_CLASSIFICATION_CODE, VESH_N_NAVIGATION, VESH_N_CONS_MTL,
                            VESH_N_LENGTH_MTS, VESH_N_BREADTH_MTS,
                            VESH_N_DEPTH_MTS, VESH_N_HP_CODE, VESH_N_NO_ENGINE,
                            VESH_N_ENGINE_TYPE, VESH_N_PI_CLUB, VESH_N_IDLE_DAYS,
                            VESH_N_OPER_DAYS, VESH_N_MAX_PASS, VESH_N_MAX_CREW,
                            VESH_N_CURR_CODE, VESH_N_FC_AMT, VESH_N_LC_AMT, VESH_N_DEL_FLAG,
                            VESH_N_CR_DT, VESH_N_CR_UID, VESH_N_UPD_DT, VESH_N_UPD_UID)
      VALUES(DECODE(P_TRG_MODE, 'D', P_OLD_VES_SYS_ID, P_NEW_VES_SYS_ID),
             M_END_NO_IDX,
             DECODE(P_TRG_MODE, 'D', P_OLD_VES_POL_SYS_ID,
                                     P_NEW_VES_POL_SYS_ID), P_OLD_VES_ID,
                     P_OLD_VES_NAME, P_OLD_VES_OWNER_MGR, P_OLD_VES_TYPE, P_OLD_VES_ENTRY_DT,
                           P_OLD_VES_EXIT_DT, P_OLD_VES_COUNTRY_CODE, P_OLD_VES_GRT,
                    P_OLD_VES_DWT, P_OLD_VES_YEAR, P_OLD_VES_CLASSIFICATION_CODE,
                    P_OLD_VES_NAVIGATION, P_OLD_VES_CONS_MTL, P_OLD_VES_LENGTH_MTS,
                    P_OLD_VES_BREADTH_MTS, P_OLD_VES_DEPTH_MTS, P_OLD_VES_HP_CODE,
                    P_OLD_VES_NO_ENGINE, P_OLD_VES_ENGINE_TYPE, P_OLD_VES_PI_CLUB,
                    P_OLD_VES_IDLE_DAYS, P_OLD_VES_OPER_DAYS, P_OLD_VES_MAX_PASS,
                    P_OLD_VES_MAX_CREW, P_OLD_VES_CURR_CODE, P_OLD_VES_FC_AMT,
                    P_OLD_VES_LC_AMT, P_OLD_VES_DEL_FLAG, P_OLD_VES_CR_DT, P_OLD_VES_CR_UID,
                    P_OLD_VES_UPD_DT, P_OLD_VES_UPD_UID, P_NEW_VES_ID, P_NEW_VES_NAME,
                    P_NEW_VES_OWNER_MGR, P_NEW_VES_TYPE, P_NEW_VES_ENTRY_DT, P_NEW_VES_EXIT_DT,
                    P_NEW_VES_COUNTRY_CODE, P_NEW_VES_GRT, P_NEW_VES_DWT, P_NEW_VES_YEAR,
                    P_NEW_VES_CLASSIFICATION_CODE, P_NEW_VES_NAVIGATION, P_NEW_VES_CONS_MTL,
                    P_NEW_VES_LENGTH_MTS, P_NEW_VES_BREADTH_MTS, P_NEW_VES_DEPTH_MTS,
                    P_NEW_VES_HP_CODE, P_NEW_VES_NO_ENGINE, P_NEW_VES_ENGINE_TYPE,
                    P_NEW_VES_PI_CLUB, P_NEW_VES_IDLE_DAYS, P_NEW_VES_OPER_DAYS,
                    P_NEW_VES_MAX_PASS, P_NEW_VES_MAX_CREW, P_NEW_VES_CURR_CODE,
                    P_NEW_VES_FC_AMT, P_NEW_VES_LC_AMT, P_NEW_VES_DEL_FLAG, P_NEW_VES_CR_DT,
                    P_NEW_VES_CR_UID, P_NEW_VES_UPD_DT, P_NEW_VES_UPD_UID);
   ELSE
      UPDATE PH_VESSEL
      SET    VESH_N_ID                  = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_ID,P_NEW_VES_ID),
             VESH_N_NAME                = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_NAME,P_NEW_VES_NAME),
             VESH_N_OWNER_MGR           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_OWNER_MGR,
						P_NEW_VES_OWNER_MGR),
             VESH_N_TYPE                = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_TYPE,P_NEW_VES_TYPE),
             VESH_N_ENTRY_DT            = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_ENTRY_DT,
						P_NEW_VES_ENTRY_DT),
             VESH_N_EXIT_DT             = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_EXIT_DT,
						P_NEW_VES_EXIT_DT),
             VESH_N_COUNTRY_CODE        = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_COUNTRY_CODE,
						P_NEW_VES_COUNTRY_CODE),
             VESH_N_GRT                 = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_GRT,P_NEW_VES_GRT),
             VESH_N_DWT                 = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_DWT,P_NEW_VES_DWT),
             VESH_N_YEAR                = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_YEAR,P_NEW_VES_YEAR),
             VESH_N_CLASSIFICATION_CODE = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_CLASSIFICATION_CODE,
						P_NEW_VES_CLASSIFICATION_CODE),
             VESH_N_NAVIGATION          = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_NAVIGATION,
						P_NEW_VES_NAVIGATION),
             VESH_N_CONS_MTL            = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_CONS_MTL,
						P_NEW_VES_CONS_MTL),
             VESH_N_LENGTH_MTS          = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_LENGTH_MTS,
						P_NEW_VES_LENGTH_MTS),
             VESH_N_BREADTH_MTS         = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_BREADTH_MTS,
						P_NEW_VES_BREADTH_MTS),
             VESH_N_DEPTH_MTS           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_DEPTH_MTS,
						P_NEW_VES_DEPTH_MTS),
             VESH_N_HP_CODE             = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_HP_CODE,
						P_NEW_VES_HP_CODE),
             VESH_N_NO_ENGINE           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_NO_ENGINE,
						P_NEW_VES_NO_ENGINE),
             VESH_N_ENGINE_TYPE         = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_ENGINE_TYPE,
						P_NEW_VES_ENGINE_TYPE),
             VESH_N_PI_CLUB             = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_PI_CLUB,
						P_NEW_VES_PI_CLUB),
             VESH_N_IDLE_DAYS           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_IDLE_DAYS,
						P_NEW_VES_IDLE_DAYS),
             VESH_N_OPER_DAYS           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_OPER_DAYS,
						P_NEW_VES_OPER_DAYS),
             VESH_N_MAX_PASS            = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_MAX_PASS,
						P_NEW_VES_MAX_PASS),
             VESH_N_MAX_CREW            = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_MAX_CREW,
						P_NEW_VES_MAX_CREW),
             VESH_N_CURR_CODE           = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_CURR_CODE,
						P_NEW_VES_CURR_CODE),
             VESH_N_FC_AMT              = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_FC_AMT,
						P_NEW_VES_FC_AMT),
             VESH_N_LC_AMT              = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_LC_AMT,
						P_NEW_VES_LC_AMT),
             VESH_N_DEL_FLAG            = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_DEL_FLAG,
						P_NEW_VES_DEL_FLAG),
             VESH_N_CR_DT               = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_CR_DT,
						P_NEW_VES_CR_DT),
             VESH_N_CR_UID              = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_CR_UID,
						P_NEW_VES_CR_UID),
             VESH_N_UPD_DT              = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_UPD_DT,
						P_NEW_VES_UPD_DT),
             VESH_N_UPD_UID             = DECODE(P_TRG_MODE, 'D',
						P_OLD_VES_UPD_UID,
						P_NEW_VES_UPD_UID)
      WHERE CURRENT OF C1 ;
   END IF ;
   CLOSE C1 ;
END ;
/
CREATE OR REPLACE PROCEDURE TEST IS
m_dummy		varchar2(1);
m_pol_sys_id	pt_policy.pol_sys_id%type;
m_pol_no	pt_policy.pol_no%type;
m_end_no_idx	pt_policy.pol_end_no_idx%type;
m_pol_ri_basis	pt_policy.pol_ri_basis%type;
m_pol_fac_yn	pt_policy.pol_fac_yn%type;
m_pol_coins_yn	pt_policy.pol_coins_yn%type;
m_pol_apprv_status	pt_policy.pol_apprv_status%type;
m_pol_status		pt_policy.pol_status%type;
m_pcvr_sys_id		pt_poL_cover.pcvr_sys_id%type;
m_risk_sys_id		pt_risk.risk_sys_id%type;
m_chg_sys_id		pt_pol_charge.chg_sys_id%type;
m_cd_sys_id		pt_cover_discount.cd_sys_id%type;

m_o_fc_si                                  number;
 m_o_lc_si                                  number;
 m_o_fc_prem                                  number;
 m_o_lc_prem                                  number;
m_n_fc_si                                  number;
 m_n_lc_si                                  number;
 m_n_fc_prem                                  number;
 m_n_lc_prem                                  number;

cursor c1 is
   select pol_sys_id, pol_no, pol_end_no_idx, pol_ri_basis, pol_fac_yn, pol_coins_yn,
          pol_apprv_status, pol_status
   from   pt_policy
   where  pol_sys_id = pol_sys_id
   and    pol_fac_yn = 'N'
   and    pol_coins_yn = 'N'
   and    pol_end_no_idx > (select count(*)
                             from   ph_policy
                             where  polh_sys_id = pol_sys_id)
   and    (1 = (select count(*) from pt_pol_cover where pcvr_pol_sys_id = pol_sys_id)
           or pol_end_no_idx > 1)
   and    1 >= (select count(*) from pt_risk where risk_pol_sys_id = pol_sys_id);

cursor c2 is
   select 'x'
   from   ph_policy
   where  polh_sys_id = m_pol_sys_id
   and    polh_end_no_idx = m_end_no_idx - 1;

cursor c3 is
   select nvl(pcvrh_o_fc_si,0), nvl(pcvrh_o_lc_si,0), nvl(pcvrh_o_fc_prem,0), nvl(pcvrh_o_lc_prem,0),
          nvl(pcvrh_n_fc_si,0), nvl(pcvrh_n_lc_si,0), nvl(pcvrh_n_fc_prem,0), nvl(pcvrh_n_lc_prem,0)
   from   ph_pol_cover
   where  pcvrh_pol_sys_id = m_pol_sys_id
   and    pcvrh_end_no_idx = m_end_no_idx - 1
   and    pcvrh_sys_id     = m_pcvr_sys_id;

cursor c4 is
   select pcvr_sys_id, pcvr_fc_si, pcvr_lc_si, pcvr_fc_prem, pcvr_lc_prem
   from   pt_pol_cover
   where  pcvr_pol_sys_id = m_pol_sys_id;

cursor c5 is
   select 'x'
   from   ph_risk
   where  riskh_pol_sys_id = m_pol_sys_id
   and    riskh_end_no_idx = m_end_no_idx - 1
   and    riskh_sys_id     = m_risk_sys_id;

cursor c6 is
   select risk_sys_id, risk_fc_si, risk_lc_si, risk_fc_prem, risk_lc_prem
   from   pt_risk
   where  risk_pol_sys_id = m_pol_sys_id;

cursor c7 is
   select 'x'
   from   ph_pol_charge
   where  chgh_pol_sys_id = m_pol_sys_id
   and    chgh_end_no_idx = m_end_no_idx - 1
   and    chgh_sys_id     = m_chg_sys_id;

cursor c8 is
   select chg_sys_id, chg_fc_value, chg_lc_value
   from   pt_pol_charge
   where  chg_pol_sys_id = m_pol_sys_id;

cursor c9 is
   select 'x'
   from   ph_cover_discount
   where  cdh_end_no_idx = m_end_no_idx - 1
   and    cdh_sys_id     = m_cd_sys_id;

cursor c10 is
   select cd_sys_id, cd_fc_disc, cd_lc_disc
   from   pt_cover_discount
   where  cd_cover_sys_id in (select pcvr_sys_id from pt_pol_cover
                              where  pcvr_pol_sys_id = m_pol_sys_id);

begin
open c1;
loop
   fetch c1 into m_pol_sys_id, m_pol_no, m_end_no_idx, m_pol_ri_basis, m_pol_fac_yn,
                 m_pol_coins_yn, m_pol_apprv_status, m_pol_status;
   exit when c1%notfound;
   if c1%notfound then
      dbms_output.put_line ('Not an INVALID POLICY  - ' || m_pol_no);
   else
      dbms_output.put_line (m_pol_no || '   -   ' ||  m_end_no_idx);
      open c2;
      fetch c2 into m_dummy;
      if c2%found then
         dbms_output.put_line (m_pol_no || ' - Record available in Policy History for Last endorsement !!!');
      else
         insert into ph_policy
         (
         POLH_SYS_ID, POLH_END_NO_IDX, POLH_PDS_CODE, POLH_DIVN_CODE, POLH_DEPT_CODE,
         POLH_SC_CODE, POLH_NO, POLH_ISSUE_DT, POLH_REF_DT_CODE, POLH_REF_NO,
         POLH_PROPOSAL_NO, POLH_REF_SYS_ID, POLH_O_UW_YEAR, POLH_O_ADVISE_DT_YN,
         POLH_O_PERIOD, POLH_O_PERIOD_UNIT, POLH_O_FM_DT, POLH_O_TO_DT,
         POLH_O_PERIOD_DESC, POLH_O_NL_FM_DT, POLH_O_NL_TO_DT, POLH_O_NL_PERIOD_DESC,
         POLH_O_CASH_YN, POLH_O_CUST_CODE, POLH_O_ASSURED_NAME, POLH_O_ADDR1,
         POLH_O_ADDR2, POLH_O_ADDR3, POLH_O_OCC_CODE, POLH_O_INTEREST,
         POLH_O_DFLT_SI_CURR_CODE, POLH_O_LC_SI, POLH_O_CUST_PREM_CURR_CODE,
         POLH_O_FC_PREM, POLH_O_LC_PREM, POLH_O_DISC_CODE, POLH_O_DISC_PERC,
         POLH_O_FC_DISC, POLH_O_LC_DISC, POLH_O_FAC_YN, POLH_O_COINS_YN, POLH_O_RI_TYPE,
         POLH_O_FAC_POOL_CODE, POLH_O_RI_BASIS, POLH_O_STATUS, POLH_O_PREM_PAID_YN,
         POLH_O_FLEET_YN, POLH_O_FAC_CLOSE_FLAG, POLH_O_PRINT_STATUS,
         POLH_O_APPRV_STATUS, POLH_O_APPRV_DATE, POLH_O_APPRV_UID, POLH_O_LINK_YN,
         POLH_O_LINK_POL_NO, POLH_O_CONDITION_YN, POLH_O_SCHEDULE_YN,
         POLH_O_SCH_HDR_TEXT, POLH_O_SCH_FTR_TEXT, POLH_O_COVER_YN, POLH_O_BROKER_YN,
         POLH_O_OPEN_POL_YN, POLH_O_CERT_YN, POLH_O_DISCOUNT_YN, POLH_O_DED_LOSS_YN,
         POLH_O_PREM_INST_YN, POLH_O_VESSEL_YN, POLH_O_VEHICLE_YN, POLH_O_AIRCRAFT_YN,
         POLH_O_RISK_YN, POLH_O_ES_CODE, POLH_O_END_TYPE, POLH_O_END_NO,
         POLH_O_END_NO_IDX, POLH_O_END_DT, POLH_O_END_EFF_FM_DT, POLH_O_END_EFF_TO_DT,
         POLH_O_END_DESC, POLH_O_END_NL_FM_DT, POLH_O_END_NL_TO_DT, POLH_O_FACIN_YN,
         POLH_O_CR_DT, POLH_O_CR_UID, POLH_O_UPD_DT, POLH_O_UPD_UID, POLH_O_PHONE,
         POLH_O_RI_CLOSE_FLAG, POLH_O_PML_FC_SI, POLH_O_PML_LC_SI, POLH_O_PML_PERC,
         POLH_O_PML_BASIS, POLH_O_ASSR_CODE, POLH_O_PREM_GEN_YN, POLH_O_FAC_GEN_YN,
         POLH_O_COINS_GEN_YN, POLH_O_BRK_GEN_YN, POLH_O_DECL_NO, POLH_O_DECL_LOT_NO,
         POLH_O_LOT_REMARKS, POLH_O_COINS_POOL_CODE, POLH_O_AGE
	 )
         select
         m_pol_sys_id, m_end_no_idx - 1, POLH_PDS_CODE, POLH_DIVN_CODE, POLH_DEPT_CODE,
         POLH_SC_CODE, POLH_NO, POLH_ISSUE_DT, POLH_REF_DT_CODE, POLH_REF_NO,
         POLH_PROPOSAL_NO, POLH_REF_SYS_ID, POLH_N_UW_YEAR, POLH_N_ADVISE_DT_YN,
         POLH_N_PERIOD, POLH_N_PERIOD_UNIT, POLH_N_FM_DT, POLH_N_TO_DT,
         POLH_N_PERIOD_DESC, POLH_N_NL_FM_DT, POLH_N_NL_TO_DT, POLH_N_NL_PERIOD_DESC,
         POLH_N_CASH_YN, POLH_N_CUST_CODE, POLH_N_ASSURED_NAME, POLH_N_ADDR1,
         POLH_N_ADDR2, POLH_N_ADDR3, POLH_N_OCC_CODE, POLH_N_INTEREST,
         POLH_N_DFLT_SI_CURR_CODE, POLH_N_LC_SI, POLH_N_CUST_PREM_CURR_CODE,
         POLH_N_FC_PREM, POLH_N_LC_PREM, POLH_N_DISC_CODE, POLH_N_DISC_PERC,
         POLH_N_FC_DISC, POLH_N_LC_DISC, POLH_N_FAC_YN, POLH_N_COINS_YN,POLH_N_RI_TYPE,
         POLH_N_FAC_POOL_CODE, POLH_N_RI_BASIS, POLH_N_STATUS,POLH_N_PREM_PAID_YN,
         POLH_N_FLEET_YN, POLH_N_FAC_CLOSE_FLAG,POLH_N_PRINT_STATUS,
         POLH_N_APPRV_STATUS, POLH_N_APPRV_DATE, POLH_N_APPRV_UID,
         POLH_N_LINK_YN, POLH_N_LINK_POL_NO, POLH_N_CONDITION_YN, POLH_N_SCHEDULE_YN,
         POLH_N_SCH_HDR_TEXT, POLH_N_SCH_FTR_TEXT, POLH_N_COVER_YN, POLH_N_BROKER_YN,
         POLH_N_OPEN_POL_YN, POLH_N_CERT_YN, POLH_N_DISCOUNT_YN, POLH_N_DED_LOSS_YN,
         POLH_N_PREM_INST_YN, POLH_N_VESSEL_YN, POLH_N_VEHICLE_YN, POLH_N_AIRCRAFT_YN,
         POLH_N_RISK_YN, POLH_N_ES_CODE, POLH_N_END_TYPE, POLH_N_END_NO,
         POLH_N_END_NO_IDX, POLH_N_END_DT, POLH_N_END_EFF_FM_DT, POLH_N_END_EFF_TO_DT,
         POLH_N_END_DESC, POLH_N_END_NL_FM_DT, POLH_N_END_NL_TO_DT, POLH_N_FACIN_YN,
         POLH_N_CR_DT, POLH_N_CR_UID, POLH_N_UPD_DT, POLH_N_UPD_UID, POLH_N_PHONE,
         POLH_N_RI_CLOSE_FLAG, POLH_N_PML_FC_SI, POLH_N_PML_LC_SI, POLH_N_PML_PERC,
         POLH_N_PML_BASIS, POLH_N_ASSR_CODE, POLH_N_PREM_GEN_YN, POLH_N_FAC_GEN_YN,
         POLH_N_COINS_GEN_YN, POLH_N_BRK_GEN_YN, POLH_N_DECL_NO, POLH_N_DECL_LOT_NO,
         POLH_N_LOT_REMARKS, POLH_N_COINS_POOL_CODE, POLH_N_AGE
         from  ph_policy
         where polh_sys_id = m_pol_sys_id
         and   polh_end_no_idx = m_end_no_idx - 2
         union
         select
         m_pol_sys_id, m_end_no_idx - 1, POL_PDS_CODE, POL_DIVN_CODE, POL_DEPT_CODE,
         POL_SC_CODE, POL_NO, POL_ISSUE_DT, POL_REF_DT_CODE, POL_REF_NO,
         POL_PROPOSAL_NO, POL_REF_SYS_ID,
             POL_UW_YEAR, POL_ADVISE_DT_YN, POL_PERIOD, POL_PERIOD_UNIT, POL_FM_DT,
             POL_TO_DT, POL_PERIOD_DESC, POL_NL_FM_DT, POL_NL_TO_DT, POL_NL_PERIOD_DESC,
             POL_CASH_YN, POL_CUST_CODE, POL_ASSURED_NAME, POL_ADDR1, POL_ADDR2, POL_ADDR3,
             POL_OCC_CODE, POL_INTEREST, POL_DFLT_SI_CURR_CODE, POL_LC_SI,
             POL_CUST_PREM_CURR_CODE, POL_FC_PREM, POL_LC_PREM, POL_DISC_CODE, POL_DISC_PERC,
             POL_FC_DISC, POL_LC_DISC, POL_FAC_YN, POL_COINS_YN, POL_RI_TYPE,
             POL_FAC_POOL_CODE, POL_RI_BASIS, POL_STATUS, POL_PREM_PAID_YN, POL_FLEET_YN,
             POL_FAC_CLOSE_FLAG, POL_PRINT_STATUS, POL_APPRV_STATUS, POL_APPRV_DATE,
             POL_APPRV_UID, POL_LINK_YN, POL_LINK_POL_NO, POL_CONDITION_YN, POL_SCHEDULE_YN,
             POL_SCH_HDR_TEXT, POL_SCH_FTR_TEXT, POL_COVER_YN, POL_BROKER_YN,
             POL_OPEN_POL_YN, POL_CERT_YN, POL_DISCOUNT_YN, POL_DED_LOSS_YN,
             POL_PREM_INST_YN, POL_VESSEL_YN, POL_VEHICLE_YN, POL_AIRCRAFT_YN, POL_RISK_YN,
             null, null, null, m_END_NO_IDX-1, to_date(null), to_date(null), to_date(null),
             POL_END_DESC, POL_END_NL_FM_DT, POL_END_NL_TO_DT,
             POL_FACIN_YN, POL_CR_DT, POL_CR_UID, POL_UPD_DT, POL_UPD_UID,
             POL_PHONE, POL_RI_CLOSE_FLAG, POL_PML_FC_SI, POL_PML_LC_SI, POL_PML_PERC,
             POL_PML_BASIS, POL_ASSR_CODE, POL_PREM_GEN_YN, POL_FAC_GEN_YN, POL_COINS_GEN_YN,
             POL_BRK_GEN_YN, POL_DECL_NO, POL_DECL_LOT_NO, POL_LOT_REMARKS,
             POL_COINS_POOL_CODE, POL_AGE
             from  pt_policy
             where pol_sys_id = m_pol_sys_id
             and   not exists (select 1 from  ph_policy
                                 where polh_sys_id = m_pol_sys_id
                                 and   polh_end_no_idx = m_end_no_idx - 2);

         update ph_policy
         set (
         POLH_N_UW_YEAR, POLH_N_ADVISE_DT_YN, POLH_N_PERIOD, POLH_N_PERIOD_UNIT,
         POLH_N_FM_DT, POLH_N_TO_DT, POLH_N_PERIOD_DESC, POLH_N_NL_FM_DT,
         POLH_N_NL_TO_DT, POLH_N_NL_PERIOD_DESC, POLH_N_CASH_YN, POLH_N_CUST_CODE,
         POLH_N_ASSURED_NAME, POLH_N_ADDR1, POLH_N_ADDR2, POLH_N_ADDR3, POLH_N_OCC_CODE,
         POLH_N_INTEREST, POLH_N_DFLT_SI_CURR_CODE, POLH_N_LC_SI,
         POLH_N_CUST_PREM_CURR_CODE, POLH_N_FC_PREM, POLH_N_LC_PREM, POLH_N_DISC_CODE,
         POLH_N_DISC_PERC, POLH_N_FC_DISC, POLH_N_LC_DISC, POLH_N_FAC_YN,
         POLH_N_COINS_YN, POLH_N_RI_TYPE, POLH_N_FAC_POOL_CODE, POLH_N_RI_BASIS,
         POLH_N_STATUS, POLH_N_PREM_PAID_YN, POLH_N_FLEET_YN, POLH_N_FAC_CLOSE_FLAG,
         POLH_N_PRINT_STATUS, POLH_N_APPRV_STATUS, POLH_N_APPRV_DATE, POLH_N_APPRV_UID,
         POLH_N_LINK_YN, POLH_N_LINK_POL_NO, POLH_N_CONDITION_YN, POLH_N_SCHEDULE_YN,
         POLH_N_SCH_HDR_TEXT, POLH_N_SCH_FTR_TEXT, POLH_N_COVER_YN, POLH_N_BROKER_YN,
         POLH_N_OPEN_POL_YN, POLH_N_CERT_YN, POLH_N_DISCOUNT_YN, POLH_N_DED_LOSS_YN,
         POLH_N_PREM_INST_YN, POLH_N_VESSEL_YN, POLH_N_VEHICLE_YN, POLH_N_AIRCRAFT_YN,
         POLH_N_RISK_YN, POLH_N_ES_CODE, POLH_N_END_TYPE, POLH_N_END_NO,
         POLH_N_END_NO_IDX, POLH_N_END_DT, POLH_N_END_EFF_FM_DT, POLH_N_END_EFF_TO_DT,
         POLH_N_END_DESC, POLH_N_END_NL_FM_DT, POLH_N_END_NL_TO_DT, POLH_N_FACIN_YN,
         POLH_N_CR_DT, POLH_N_CR_UID, POLH_N_UPD_DT, POLH_N_UPD_UID, POLH_N_PHONE,
         POLH_N_RI_CLOSE_FLAG, POLH_N_PML_FC_SI, POLH_N_PML_LC_SI, POLH_N_PML_PERC,
         POLH_N_PML_BASIS, POLH_N_ASSR_CODE, POLH_N_PREM_GEN_YN, POLH_N_FAC_GEN_YN,
         POLH_N_COINS_GEN_YN, POLH_N_BRK_GEN_YN, POLH_N_DECL_NO, POLH_N_DECL_LOT_NO,
         POLH_N_LOT_REMARKS, POLH_N_COINS_POOL_CODE, POLH_N_AGE)
          =
         (   select
             POL_UW_YEAR, POL_ADVISE_DT_YN, POL_PERIOD, POL_PERIOD_UNIT, POL_FM_DT,
             POL_TO_DT, POL_PERIOD_DESC, POL_NL_FM_DT, POL_NL_TO_DT, POL_NL_PERIOD_DESC,
             POL_CASH_YN, POL_CUST_CODE, POL_ASSURED_NAME, POL_ADDR1, POL_ADDR2, POL_ADDR3,
             POL_OCC_CODE, POL_INTEREST, POL_DFLT_SI_CURR_CODE, POL_LC_SI,
             POL_CUST_PREM_CURR_CODE, POL_FC_PREM, POL_LC_PREM, POL_DISC_CODE, POL_DISC_PERC,
             POL_FC_DISC, POL_LC_DISC, POL_FAC_YN, POL_COINS_YN, POL_RI_TYPE,
             POL_FAC_POOL_CODE, POL_RI_BASIS, POL_STATUS, POL_PREM_PAID_YN, POL_FLEET_YN,
             POL_FAC_CLOSE_FLAG, POL_PRINT_STATUS, POL_APPRV_STATUS, POL_APPRV_DATE,
             POL_APPRV_UID, POL_LINK_YN, POL_LINK_POL_NO, POL_CONDITION_YN, POL_SCHEDULE_YN,
             POL_SCH_HDR_TEXT, POL_SCH_FTR_TEXT, POL_COVER_YN, POL_BROKER_YN,
             POL_OPEN_POL_YN, POL_CERT_YN, POL_DISCOUNT_YN, POL_DED_LOSS_YN,
             POL_PREM_INST_YN, POL_VESSEL_YN, POL_VEHICLE_YN, POL_AIRCRAFT_YN, POL_RISK_YN,
             POL_ES_CODE, POL_END_TYPE, POL_END_NO, POL_END_NO_IDX, POL_END_DT,
             POL_END_EFF_FM_DT, POL_END_EFF_TO_DT, POL_END_DESC, POL_END_NL_FM_DT,
             POL_END_NL_TO_DT, POL_FACIN_YN, POL_CR_DT, POL_CR_UID, POL_UPD_DT, POL_UPD_UID,
             POL_PHONE, POL_RI_CLOSE_FLAG, POL_PML_FC_SI, POL_PML_LC_SI, POL_PML_PERC,
             POL_PML_BASIS, POL_ASSR_CODE, POL_PREM_GEN_YN, POL_FAC_GEN_YN, POL_COINS_GEN_YN,
             POL_BRK_GEN_YN, POL_DECL_NO, POL_DECL_LOT_NO, POL_LOT_REMARKS,
             POL_COINS_POOL_CODE, POL_AGE
             from  pt_policy
             where pol_sys_id = m_pol_sys_id
         )
         where  polh_sys_id = m_pol_sys_id
         and    polh_end_no_idx = m_end_no_idx - 1;

         for c4_rec in c4
         loop
            m_pcvr_sys_id := c4_rec.pcvr_sys_id;
            open c3;
            fetch c3 into m_o_fc_si, m_o_lc_si, m_o_fc_prem, m_o_lc_prem,
                          m_n_fc_si, m_n_lc_si, m_n_fc_prem, m_n_lc_prem;
            if m_o_fc_si = 0 and  m_o_lc_si = 0 and  m_o_fc_prem = 0 and  m_o_lc_prem = 0 and
                          m_n_fc_si = 0 and  m_n_lc_si = 0 and  m_n_fc_prem = 0 and  m_n_lc_prem = 0 then
               dbms_output.put_line ('Deleting Null Cover ...');
               delete from ph_pol_cover
               where  pcvrh_sys_id = m_pcvr_sys_id
               and    pcvrh_end_no_idx = m_end_no_idx - 1
               and    pcvrh_pol_sys_id = m_pol_sys_id;
               close c3;
               open c3;
               fetch c3 into m_o_fc_si, m_o_lc_si, m_o_fc_prem, m_o_lc_prem,
                          m_n_fc_si, m_n_lc_si, m_n_fc_prem, m_n_lc_prem;
            end if;
            if c3%notfound then
               insert into ph_pol_cover
               (
                  PCVRH_SYS_ID, PCVRH_END_NO_IDX, PCVRH_POL_SYS_ID, PCVRH_O_REF, PCVRH_O_REF_SYS_ID,
                  PCVRH_O_CODE, PCVRH_O_DESC, PCVRH_O_SI_CURR_CODE, PCVRH_O_FC_SI, PCVRH_O_LC_SI,
                  PCVRH_O_PREM_RATE, PCVRH_O_FC_PREM, PCVRH_O_LC_PREM, PCVRH_O_DISCOUNT_YN,
                  PCVRH_O_DED_LOSS_YN, PCVRH_O_DEL_FLAG, PCVRH_O_CR_DT, PCVRH_O_CR_UID ,
                  PCVRH_O_UPD_DT , PCVRH_O_UPD_UID
               )
               select
                  PCVRH_SYS_ID, m_end_no_idx - 1, PCVRH_POL_SYS_ID, PCVRH_N_REF, PCVRH_N_REF_SYS_ID,
                  PCVRH_N_CODE, PCVRH_N_DESC, PCVRH_N_SI_CURR_CODE, PCVRH_N_FC_SI, PCVRH_N_LC_SI,
                  PCVRH_N_PREM_RATE, PCVRH_N_FC_PREM, PCVRH_N_LC_PREM, PCVRH_N_DISCOUNT_YN,
                  PCVRH_N_DED_LOSS_YN, PCVRH_N_DEL_FLAG, PCVRH_N_CR_DT, PCVRH_N_CR_UID ,
                  PCVRH_N_UPD_DT , PCVRH_N_UPD_UID
               from  ph_pol_cover
               where pcvrh_pol_sys_id = m_pol_sys_id
               and   pcvrh_end_no_idx = m_end_no_idx - 2
               and   pcvrh_sys_id     = c4_rec.pcvr_sys_id
               union
               select
                  PCVR_SYS_ID, m_end_no_idx - 1, PCVR_POL_SYS_ID, PCVR_REF, PCVR_REF_SYS_ID,
                  PCVR_CODE, PCVR_DESC, PCVR_SI_CURR_CODE, round(pr_lc_si/pac_curr_rate,3) PCVR_FC_SI,
                  pr_lc_si PCVR_LC_SI, PCVR_PREM_RATE, pr_gross_fc_prem PCVR_FC_PREM,
                  pr_gross_lc_prem PCVR_LC_PREM, PCVR_DISCOUNT_YN,
                  PCVR_DED_LOSS_YN, PCVR_DEL_FLAG, PCVR_CR_DT, PCVR_CR_UID ,
                  PCVR_UPD_DT , PCVR_UPD_UID
               from  pt_pol_cover, ps_prem_reg, pt_policy_appl_curr
               where pcvr_pol_sys_id = m_pol_sys_id
               and   pcvr_sys_id     = c4_rec.pcvr_sys_id
               and   pcvr_pol_sys_id = pr_pol_sys_id
               and   pr_end_no_idx   = 0
               and   pcvr_pol_sys_id = pac_pol_sys_id
               and   pcvr_si_curr_code = pac_curr_code
               and   not exists (select 1 from ph_pol_cover
                                 where pcvrh_pol_sys_id = m_pol_sys_id
                                 and   pcvrh_end_no_idx = m_end_no_idx - 2
                                 and   pcvrh_sys_id     = c4_rec.pcvr_sys_id);
            else
              -- History available for cover
               dbms_output.put_line (' Cover History records available !!');
            end if;

            if m_pol_apprv_status = 'A' then
               update ph_pol_cover
               set
                 (PCVRH_N_REF,
                  PCVRH_N_REF_SYS_ID, PCVRH_N_CODE, PCVRH_N_DESC, PCVRH_N_SI_CURR_CODE,
                  PCVRH_N_FC_SI, PCVRH_N_LC_SI, PCVRH_N_PREM_RATE, PCVRH_N_FC_PREM,
                  PCVRH_N_LC_PREM, PCVRH_N_DISCOUNT_YN, PCVRH_N_DED_LOSS_YN, PCVRH_N_DEL_FLAG,
                  PCVRH_N_CR_DT, PCVRH_N_CR_UID , PCVRH_N_UPD_DT , PCVRH_N_UPD_UID)
                   =
                     (select
                         PCVRH_O_REF,
                         PCVRH_O_REF_SYS_ID, PCVRH_O_CODE, PCVRH_O_DESC,
                         PCVRH_O_SI_CURR_CODE, nvl(PCVRH_O_FC_SI,0) + nvl(c4_rec.pcvr_fc_si,0),
                         nvl(PCVRH_O_LC_SI,0)   + nvl(c4_rec.pcvr_lc_si,0), PCVRH_O_PREM_RATE,
                         nvl(PCVRH_O_FC_PREM,0) + nvl(c4_rec.pcvr_fc_prem,0),
                         nvl(PCVRH_O_LC_PREM,0) + nvl(c4_rec.pcvr_fc_prem,0),
                         PCVRH_O_DISCOUNT_YN, PCVRH_O_DED_LOSS_YN,
                         PCVRH_O_DEL_FLAG, PCVRH_O_CR_DT, PCVRH_O_CR_UID , PCVRH_O_UPD_DT ,
                         PCVRH_O_UPD_UID
                      from ph_pol_cover
                      where  pcvrh_pol_sys_id = m_pol_sys_id
                      and    pcvrh_end_no_idx = m_end_no_idx - 1
                      and    pcvrh_sys_id     = c4_rec.pcvr_sys_id
                     )
               where  pcvrh_pol_sys_id = m_pol_sys_id
               and    pcvrh_end_no_idx = m_end_no_idx - 1
               and    pcvrh_sys_id     = c4_rec.pcvr_sys_id;

               update pt_pol_cover
               set    (pcvr_fc_si, pcvr_lc_si, pcvr_fc_prem, pcvr_lc_prem) =
                  (select nvl(pcvrh_n_fc_si,0),
                          nvl(pcvrh_n_lc_si,0),
                          nvl(pcvrh_n_fc_prem,0),
                          nvl(pcvrh_n_lc_prem,0)
                   from   ph_pol_cover
                   where  pcvrh_pol_sys_id = m_pol_sys_id
                   and    pcvrh_end_no_idx = m_end_no_idx - 1
                   and    pcvrh_sys_id     = c4_rec.pcvr_sys_id
                  )
               where  pcvr_sys_id = c4_rec.pcvr_sys_id;
            else      -- if policy is not approved
               update ph_pol_cover
               set
                 (PCVRH_N_REF,
                  PCVRH_N_REF_SYS_ID, PCVRH_N_CODE, PCVRH_N_DESC, PCVRH_N_SI_CURR_CODE,
                  PCVRH_N_FC_SI, PCVRH_N_LC_SI, PCVRH_N_PREM_RATE, PCVRH_N_FC_PREM,
                  PCVRH_N_LC_PREM, PCVRH_N_DISCOUNT_YN, PCVRH_N_DED_LOSS_YN, PCVRH_N_DEL_FLAG,
                  PCVRH_N_CR_DT, PCVRH_N_CR_UID , PCVRH_N_UPD_DT , PCVRH_N_UPD_UID)
                  =
                     (select
                         PCVRH_O_REF,
                         PCVRH_O_REF_SYS_ID, PCVRH_O_CODE, PCVRH_O_DESC,
                         PCVRH_O_SI_CURR_CODE, nvl(c4_rec.pcvr_fc_si,0), nvl(c4_rec.pcvr_lc_si,0),
                         PCVRH_O_PREM_RATE, nvl(c4_rec.pcvr_fc_prem,0),
                         nvl(c4_rec.pcvr_fc_prem,0), PCVRH_O_DISCOUNT_YN,
                         PCVRH_O_DED_LOSS_YN,
                         PCVRH_O_DEL_FLAG, PCVRH_O_CR_DT, PCVRH_O_CR_UID , PCVRH_O_UPD_DT ,
                         PCVRH_O_UPD_UID
                      from ph_pol_cover
                      where  pcvrh_pol_sys_id = m_pol_sys_id
                      and    pcvrh_end_no_idx = m_end_no_idx - 1
                      and    pcvrh_sys_id     = c4_rec.pcvr_sys_id
                     )
               where  pcvrh_pol_sys_id = m_pol_sys_id
               and    pcvrh_end_no_idx = m_end_no_idx - 1
               and    pcvrh_sys_id     = c4_rec.pcvr_sys_id;

               update pt_pol_cover
               set    (pcvr_fc_org_si, pcvr_lc_org_si, pcvr_fc_org_prem, pcvr_lc_org_prem) =
                  (select pcvrh_o_fc_si,
                          pcvrh_o_lc_si,
                          pcvrh_o_fc_prem,
                          pcvrh_o_lc_prem
                   from   ph_pol_cover
                   where  pcvrh_pol_sys_id = m_pol_sys_id
                   and    pcvrh_end_no_idx = m_end_no_idx - 1
                   and    pcvrh_sys_id     = c4_rec.pcvr_sys_id
                  )
               where  pcvr_sys_id = c4_rec.pcvr_sys_id;

            end if;
         end loop;

         -- Now for the risk
         for c6_rec in c6
         loop
            m_risk_sys_id := c6_rec.risk_sys_id;
            open c5;
            fetch c5 into m_dummy;
            if c5%notfound then
               insert into ph_risk
               (
                  RISKH_SYS_ID, RISKH_END_NO_IDX, RISKH_POL_SYS_ID,
                  RISKH_LINK_SYS_ID, RISKH_O_CLASS, RISKH_O_TYPE,
                  RISKH_O_BLD_NO , RISKH_O_ROAD_NO, RISKH_O_AREA_NO,
                  RISKH_O_ENTRY_DT, RISKH_O_EXIT_DT, RISKH_O_DESC,
                  RISKH_O_SI_CURR_CODE, RISKH_O_FC_SI, RISKH_O_LC_SI,
                  RISKH_O_FC_PREM, RISKH_O_LC_PREM, RISKH_O_DEL_FLAG,
                  RISKH_O_CR_DT, RISKH_O_CR_UID , RISKH_O_UPD_DT ,
                  RISKH_O_UPD_UID, RISKH_O_LC_PML_SI, RISKH_O_FC_PML_SI,
                  RISKH_O_PML_PERC
               )
               select
                  RISKH_SYS_ID, m_end_no_idx - 1, RISKH_POL_SYS_ID,
                  RISKH_LINK_SYS_ID, RISKH_N_CLASS, RISKH_N_TYPE,
                  RISKH_N_BLD_NO , RISKH_N_ROAD_NO, RISKH_N_AREA_NO,
                  RISKH_N_ENTRY_DT, RISKH_N_EXIT_DT, RISKH_N_DESC,
                  RISKH_N_SI_CURR_CODE, RISKH_N_FC_SI, RISKH_N_LC_SI,
                  RISKH_N_FC_PREM, RISKH_N_LC_PREM, RISKH_N_DEL_FLAG,
                  RISKH_N_CR_DT, RISKH_N_CR_UID , RISKH_N_UPD_DT ,
                  RISKH_N_UPD_UID, RISKH_N_LC_PML_SI, RISKH_N_FC_PML_SI,
                  RISKH_N_PML_PERC
               from  ph_risk
               where riskh_pol_sys_id = m_pol_sys_id
               and   riskh_end_no_idx = m_end_no_idx - 2
               and   riskh_sys_id     = c6_rec.risk_sys_id
               union
               select
                  RISK_SYS_ID, m_end_no_idx - 1, RISK_POL_SYS_ID,
                  RISK_LINK_SYS_ID, RISK_CLASS, RISK_TYPE,
                  RISK_BLD_NO , RISK_ROAD_NO, RISK_AREA_NO,
                  RISK_ENTRY_DT, RISK_EXIT_DT, RISK_DESC,
                  RISK_SI_CURR_CODE, round(pr_lc_si/pac_curr_rate,3) RISK_FC_SI,
                  pr_lc_si RISK_LC_SI, pr_gross_fc_prem RISK_FC_PREM,
                  pr_gross_lc_prem RISK_LC_PREM, RISK_DEL_FLAG,
                  RISK_CR_DT, RISK_CR_UID , RISK_UPD_DT ,
                  RISK_UPD_UID, RISK_LC_PML_SI, RISK_FC_PML_SI,
                  RISK_PML_PERC
               from  pt_risk, ps_prem_reg, pt_policy_appl_curr
               where risk_pol_sys_id = m_pol_sys_id
               and   risk_sys_id     = c6_rec.risk_sys_id
               and   risk_pol_sys_id = pr_pol_sys_id
               and   pr_end_no_idx   = 0
               and   risk_pol_sys_id = pac_pol_sys_id
               and   risk_si_curr_code = pac_curr_code
               and   not exists (select 1 from ph_risk
                                 where riskh_pol_sys_id = m_pol_sys_id
                                 and   riskh_end_no_idx = m_end_no_idx - 2
                                 and   riskh_sys_id     = c6_rec.risk_sys_id);
            else
              -- History available for risk
               dbms_output.put_line (' risk History records available !!');
            end if;

            if m_pol_apprv_status = 'A' then
               update ph_risk
               set
               (
                  RISKH_N_CLASS, RISKH_N_TYPE,
                  RISKH_N_BLD_NO , RISKH_N_ROAD_NO, RISKH_N_AREA_NO,
                  RISKH_N_ENTRY_DT, RISKH_N_EXIT_DT, RISKH_N_DESC,
                  RISKH_N_SI_CURR_CODE, RISKH_N_FC_SI, RISKH_N_LC_SI,
                  RISKH_N_FC_PREM, RISKH_N_LC_PREM, RISKH_N_DEL_FLAG,
                  RISKH_N_CR_DT, RISKH_N_CR_UID , RISKH_N_UPD_DT ,
                  RISKH_N_UPD_UID, RISKH_N_LC_PML_SI, RISKH_N_FC_PML_SI,
                  RISKH_N_PML_PERC
               )
                   =
                     (select
                         RISKH_O_CLASS, RISKH_O_TYPE,
                         RISKH_O_BLD_NO , RISKH_O_ROAD_NO, RISKH_O_AREA_NO,
                         RISKH_O_ENTRY_DT, RISKH_O_EXIT_DT, RISKH_O_DESC,
                         RISKH_O_SI_CURR_CODE,
                         nvl(RISKH_O_FC_SI,0) + nvl(c6_rec.risk_fc_si,0),
                         nvl(RISKH_O_LC_SI,0) + nvl(c6_rec.risk_lc_si,0),
                         nvl(RISKH_O_FC_PREM,0) + nvl(c6_rec.risk_fc_prem,0),
                         nvl(RISKH_O_LC_PREM,0) + nvl(c6_rec.risk_lc_prem,0), RISKH_O_DEL_FLAG,
                         RISKH_O_CR_DT, RISKH_O_CR_UID , RISKH_O_UPD_DT ,
                         RISKH_O_UPD_UID, RISKH_O_LC_PML_SI, RISKH_O_FC_PML_SI,
                         RISKH_O_PML_PERC
                      from ph_risk
                      where  riskh_pol_sys_id = m_pol_sys_id
                      and    riskh_end_no_idx = m_end_no_idx - 1
                      and    riskh_sys_id     = c6_rec.risk_sys_id
                     )
               where  riskh_pol_sys_id = m_pol_sys_id
               and    riskh_end_no_idx = m_end_no_idx - 1
               and    riskh_sys_id     = c6_rec.risk_sys_id;

               update pt_risk
               set    (risk_fc_si, risk_lc_si, risk_fc_prem, risk_lc_prem) =
                  (select nvl(riskh_n_fc_si,0) - nvl(riskh_o_fc_si,0),
                          nvl(riskh_n_lc_si,0) - nvl(riskh_o_lc_si,0),
                          nvl(riskh_n_fc_prem,0) - nvl(riskh_o_fc_prem,0),
                          nvl(riskh_n_lc_prem,0) - nvl(riskh_o_lc_prem,0)
                   from   ph_risk
                   where  riskh_pol_sys_id = m_pol_sys_id
                   and    riskh_end_no_idx = m_end_no_idx - 1
                   and    riskh_sys_id     = c6_rec.risk_sys_id
                  )
               where  risk_sys_id = c6_rec.risk_sys_id;
            else      -- if policy is not approved
               update ph_risk
               set
                 (
                  RISKH_N_CLASS, RISKH_N_TYPE,
                  RISKH_N_BLD_NO , RISKH_N_ROAD_NO, RISKH_N_AREA_NO,
                  RISKH_N_ENTRY_DT, RISKH_N_EXIT_DT, RISKH_N_DESC,
                  RISKH_N_SI_CURR_CODE, RISKH_N_FC_SI, RISKH_N_LC_SI,
                  RISKH_N_FC_PREM, RISKH_N_LC_PREM, RISKH_N_DEL_FLAG,
                  RISKH_N_CR_DT, RISKH_N_CR_UID , RISKH_N_UPD_DT ,
                  RISKH_N_UPD_UID, RISKH_N_LC_PML_SI, RISKH_N_FC_PML_SI,
                  RISKH_N_PML_PERC
                  )
                  =
                     (select
                         RISKH_O_CLASS, RISKH_O_TYPE,
                         RISKH_O_BLD_NO , RISKH_O_ROAD_NO, RISKH_O_AREA_NO,
                         RISKH_O_ENTRY_DT, RISKH_O_EXIT_DT, RISKH_O_DESC,
                         RISKH_O_SI_CURR_CODE,
                         nvl(c6_rec.risk_fc_si,0), nvl(c6_rec.risk_lc_si,0), nvl(c6_rec.risk_fc_prem,0),
                         nvl(c6_rec.risk_lc_prem,0), RISKH_O_DEL_FLAG,
                         RISKH_O_CR_DT, RISKH_O_CR_UID , RISKH_O_UPD_DT ,
                         RISKH_O_UPD_UID, RISKH_O_LC_PML_SI, RISKH_O_FC_PML_SI,
                         RISKH_O_PML_PERC
                      from ph_risk
                      where  riskh_pol_sys_id = m_pol_sys_id
                      and    riskh_end_no_idx = m_end_no_idx - 1
                      and    riskh_sys_id     = c6_rec.risk_sys_id
                     )
               where  riskh_pol_sys_id = m_pol_sys_id
               and    riskh_end_no_idx = m_end_no_idx - 1
               and    riskh_sys_id     = c6_rec.risk_sys_id;

               update pt_risk
               set    (risk_fc_org_si, risk_lc_org_si, risk_fc_org_prem, risk_lc_org_prem) =
                  (select riskh_o_fc_si,
                          riskh_o_lc_si,
                          riskh_o_fc_prem,
                          riskh_o_lc_prem
                   from   ph_risk
                   where  riskh_pol_sys_id = m_pol_sys_id
                   and    riskh_end_no_idx = m_end_no_idx - 1
                   and    riskh_sys_id     = c6_rec.risk_sys_id
                  )
               where  risk_sys_id = c6_rec.risk_sys_id;

            end if;
         end loop;
         -- Now for the Charges
         for c8_rec in c8
         loop
            m_chg_sys_id := c8_rec.chg_sys_id;
            open c7;
            fetch c7 into m_dummy;
            if c7%notfound then
               insert into ph_pol_charge
               (
                  CHGH_SYS_ID, CHGH_END_NO_IDX, CHGH_POL_SYS_ID, CHGH_O_CODE,
                  CHGH_O_DESC, CHGH_O_PERC, CHGH_O_FC_VALUE, CHGH_O_LC_VALUE,
                  CHGH_O_CR_DT, CHGH_O_CR_UID, CHGH_O_UPD_DT, CHGH_O_UPD_UID
               )
               select
                  CHGH_SYS_ID, m_end_no_idx - 1, CHGH_POL_SYS_ID, CHGH_N_CODE,
                  CHGH_N_DESC, CHGH_N_PERC, CHGH_N_FC_VALUE, CHGH_N_LC_VALUE,
                  CHGH_N_CR_DT, CHGH_N_CR_UID, CHGH_N_UPD_DT, CHGH_N_UPD_UID
               from  ph_pol_charge
               where chgh_pol_sys_id = m_pol_sys_id
               and   chgh_end_no_idx = m_end_no_idx - 2
               and   chgh_sys_id     = c8_rec.chg_sys_id
               union
               select
                  CHG_SYS_ID, m_end_no_idx - 1, CHG_POL_SYS_ID, CHG_CODE,
                  CHG_DESC, CHG_PERC, CHG_FC_VALUE, CHG_LC_VALUE,
                  CHG_CR_DT, CHG_CR_UID, CHG_UPD_DT, CHG_UPD_UID

               from  pt_pol_charge
               where chg_pol_sys_id = m_pol_sys_id
               and   chg_sys_id     = c8_rec.chg_sys_id
               and   not exists (select 1 from ph_pol_charge
                                 where chgh_pol_sys_id = m_pol_sys_id
                                 and   chgh_end_no_idx = m_end_no_idx - 2
                                 and   chgh_sys_id     = c8_rec.chg_sys_id);
            else
              -- History available for charge
               dbms_output.put_line (' charge History records available !!');
            end if;

            if m_pol_apprv_status = 'A' then
               update ph_pol_charge
               set
               (
                  CHGH_N_CODE, CHGH_N_DESC, CHGH_N_PERC, CHGH_N_FC_VALUE, CHGH_N_LC_VALUE,
                  CHGH_N_CR_DT, CHGH_N_CR_UID, CHGH_N_UPD_DT, CHGH_N_UPD_UID
               )
                   =
                     (select
                        CHGH_O_CODE, CHGH_O_DESC, CHGH_O_PERC,
						nvl(CHGH_O_FC_VALUE,0) + nvl(c8_rec.chg_fc_value,0),
                        nvl(CHGH_O_LC_VALUE,0) + nvl(c8_rec.chg_lc_value,0),
                        CHGH_O_CR_DT, CHGH_O_CR_UID, CHGH_O_UPD_DT, CHGH_O_UPD_UID
                      from ph_pol_charge
                      where  chgh_pol_sys_id = m_pol_sys_id
                      and    chgh_end_no_idx = m_end_no_idx - 1
                      and    chgh_sys_id     = c8_rec.chg_sys_id
                     )
               where  chgh_pol_sys_id = m_pol_sys_id
               and    chgh_end_no_idx = m_end_no_idx - 1
               and    chgh_sys_id     = c8_rec.chg_sys_id;

               update pt_pol_charge
               set    (chg_fc_value, chg_lc_value) =
                  (select nvl(chgh_n_fc_value,0),
                          nvl(chgh_n_lc_value,0)
                   from   ph_pol_charge
                   where  chgh_pol_sys_id = m_pol_sys_id
                   and    chgh_end_no_idx = m_end_no_idx - 1
                   and    chgh_sys_id     = c8_rec.chg_sys_id
                  )
               where  chg_sys_id = c8_rec.chg_sys_id;
            else      -- if policy is not approved
               update ph_pol_charge
               set
                 (
                  CHGH_N_CODE, CHGH_N_DESC, CHGH_N_PERC, CHGH_N_FC_VALUE, CHGH_N_LC_VALUE,
                  CHGH_N_CR_DT, CHGH_N_CR_UID, CHGH_N_UPD_DT, CHGH_N_UPD_UID
                  )
                  =
                     (select
                        CHGH_O_CODE, CHGH_O_DESC, CHGH_O_PERC,
                        nvl(c8_rec.chg_fc_value,0), nvl(c8_rec.chg_lc_value,0),
                        CHGH_O_CR_DT, CHGH_O_CR_UID, CHGH_O_UPD_DT, CHGH_O_UPD_UID
                      from ph_pol_charge
                      where  chgh_pol_sys_id = m_pol_sys_id
                      and    chgh_end_no_idx = m_end_no_idx - 1
                      and    chgh_sys_id     = c8_rec.chg_sys_id
                     )
                  where  chgh_pol_sys_id = m_pol_sys_id
                  and    chgh_end_no_idx = m_end_no_idx - 1
                  and    chgh_sys_id     = c8_rec.chg_sys_id;

               update pt_pol_charge
               set    (chg_fc_org_value, chg_lc_org_value) =
                  (select chgh_o_fc_value, chgh_o_lc_value
                   from   ph_pol_charge
                   where  chgh_pol_sys_id = m_pol_sys_id
                   and    chgh_end_no_idx = m_end_no_idx - 1
                   and    chgh_sys_id     = c8_rec.chg_sys_id
                  )
               where  chg_sys_id = c8_rec.chg_sys_id;
            end if;
         end loop;

         -- Now for cover discounts
         for c10_rec in c10
         loop
            m_cd_sys_id := c10_rec.cd_sys_id;
            open c9;
            fetch c9 into m_dummy;
            if c9%notfound then
               insert into ph_cover_discount
               (
                  CDH_SYS_ID, CDH_END_NO_IDX , CDH_COVER_SYS_ID,
                  CDH_O_CODE, CDH_O_DESC, CDH_O_PERC,
                  CDH_O_FC_DISC, CDH_O_LC_DISC, CDH_O_DEL_FLAG ,
                  CDH_O_CR_DT, CDH_O_CR_UID, CDH_O_UPD_DT, CDH_O_UPD_UID,
                  CDH_O_DIM_DISC_YN
			)
               select
                  CDH_SYS_ID, M_END_NO_IDX - 1 , CDH_COVER_SYS_ID, CDH_N_CODE,
                  CDH_N_DESC, CDH_N_PERC, CDH_N_FC_DISC, CDH_N_LC_DISC,
                  CDH_N_DEL_FLAG , CDH_N_CR_DT, CDH_N_CR_UID, CDH_N_UPD_DT,
                  CDH_N_UPD_UID, CDH_N_DIM_DISC_YN
               from  ph_cover_discount
               where cdh_end_no_idx = m_end_no_idx - 2
               and   cdh_sys_id     = c10_rec.cd_sys_id
               union
               select
                  CD_SYS_ID, M_END_NO_IDX - 1 , CD_COVER_SYS_ID, CD_CODE,
                  CD_DESC, CD_PERC, CD_FC_DISC, CD_LC_DISC,
                  CD_DEL_FLAG , CD_CR_DT, CD_CR_UID, CD_UPD_DT,
                  CD_UPD_UID, CD_DIM_DISC_YN
               from  pt_cover_discount
               where cd_sys_id     = c10_rec.cd_sys_id
               and   not exists (select 1 from ph_cover_discount
                                 where cdh_end_no_idx = m_end_no_idx - 2
                                 and   cdh_sys_id     = c10_rec.cd_sys_id);
            else
              -- History available for discount
               dbms_output.put_line (' discount History records available !!');
            end if;

            if m_pol_apprv_status = 'A' then
               update ph_cover_discount
               set
               (
                  CDH_N_CODE, CDH_N_DESC, CDH_N_PERC, CDH_N_FC_DISC, CDH_N_LC_DISC,
                  CDH_N_DEL_FLAG , CDH_N_CR_DT, CDH_N_CR_UID, CDH_N_UPD_DT,
                  CDH_N_UPD_UID, CDH_N_DIM_DISC_YN
               )
                   =
                     (select
                        CDH_O_CODE, CDH_O_DESC, CDH_O_PERC,
                        nvl(CDH_O_FC_DISC,0) + nvl(c10_rec.cd_fc_disc,0),
                        nvl(CDH_O_LC_DISC,0) + nvl(c10_rec.cd_lc_disc,0),
                        CDH_O_DEL_FLAG , CDH_O_CR_DT, CDH_O_CR_UID, CDH_O_UPD_DT,
                        CDH_O_UPD_UID, CDH_O_DIM_DISC_YN
                     from  ph_cover_discount
                     where cdh_end_no_idx = m_end_no_idx - 1
                     and   cdh_sys_id     = c10_rec.cd_sys_id
                     )
                     where cdh_end_no_idx = m_end_no_idx - 1
                     and   cdh_sys_id     = c10_rec.cd_sys_id;

               update pt_cover_discount
               set    (cd_fc_disc, cd_lc_disc) =
                  (select nvl(cdh_n_fc_disc,0),
                          nvl(cdh_n_lc_disc,0)
                   from   ph_cover_discount
                   where  cdh_end_no_idx = m_end_no_idx - 1
                   and    cdh_sys_id     = c10_rec.cd_sys_id
                  )
               where  cd_sys_id = c10_rec.cd_sys_id;
            else      -- if policy is not approved
               update ph_cover_discount
               set
                 (
                  CDH_N_CODE, CDH_N_DESC, CDH_N_PERC, CDH_N_FC_DISC, CDH_N_LC_DISC,
                  CDH_N_DEL_FLAG , CDH_N_CR_DT, CDH_N_CR_UID, CDH_N_UPD_DT,
                  CDH_N_UPD_UID, CDH_N_DIM_DISC_YN
                  )
                  =
                     (select
                        CDH_O_CODE, CDH_O_DESC, CDH_O_PERC,
                        nvl(c10_rec.cd_fc_disc,0),
                        nvl(c10_rec.cd_lc_disc,0),
                        CDH_O_DEL_FLAG , CDH_O_CR_DT, CDH_O_CR_UID, CDH_O_UPD_DT,
                        CDH_O_UPD_UID, CDH_O_DIM_DISC_YN
                     from  ph_cover_discount
                     where cdh_end_no_idx = m_end_no_idx - 1
                     and   cdh_sys_id     = c10_rec.cd_sys_id
                     )
               where cdh_end_no_idx = m_end_no_idx - 1
               and   cdh_sys_id     = c10_rec.cd_sys_id;

               update pt_cover_discount
               set    (cd_fc_org_disc, cd_lc_org_disc) =
                  (select cdh_o_fc_disc, cdh_o_lc_disc
                   from   ph_cover_discount
                   where  cdh_end_no_idx = m_end_no_idx - 1
                   and    cdh_sys_id     = c10_rec.cd_sys_id
                  )
               where  cd_sys_id = c10_rec.cd_sys_id;
            end if;
         end loop;

      end if;
   end if;
end loop;
end;
/
CREATE OR REPLACE PROCEDURE UPDF7NARRATION IS
m_drcr_txn_code	 	varchar2(6) ;
m_drcr_doc_no		number(6) ;
m_drcr_cust_code	varchar2(6) ;
m_drcr_pol_no		varchar2(20) ;
m_drcr_claim_no		varchar2(20) ;
m_drcr_end_no		varchar2(20) ;
m_drcr_int_ent_yn 	varchar2(1) ;
m_cust_bl_Contact	varchar2(1) ;
m_drcr_narration	varchar2(2000) ;
m_pr_dept_code		ps_prem_reg.pr_dept_code%type;
m_pr_assured_name	ps_prem_reg.pr_assured_name%type ;
m_drcr_pol_sys_Id 	number;
m_drcr_end_no_Idx	number;
m_Sc_name		varchar2(60);
m_ctr 			number(6) := 0 ;
m_time			varchar2(20) ;
cursor c1 is
	select 	drcr_txn_code, drcr_doc_no,drcr_cust_code ,
        	drcr_pol_no, drcr_claim_no, drcr_end_no,
		drcr_int_ent_yn, drcr_pol_sys_Id, drcr_end_no_Idx
	from    ps_drcr
	where   drcr_post_yn = 'Y'
	and     drcr_seq_no = '1' ;
cursor c2 is
       select substr(cust_bl_contact,1,1)
       from pm_customer
       where cust_code = m_drcr_cust_code ;
cursor c3 is
       select pr_dept_code, pr_assured_name,
	      decode(nvl(m_cust_bl_contact,'A'),'E',sc_short_name,sc_bl_short_name)
       from  ps_prem_reg, pm_sub_class
       where pr_pol_sys_Id  = m_drcr_pol_sys_id
       and   pr_end_no_Idx = m_drcr_end_no_idx
       and   pr_sc_code = sc_code ;
begin
   select to_char(sysdate, 'hh24:mi:ss')
   into m_time from dual ;
   dbms_output.put_line('Procedure started at' || m_time) ;
   open c1 ;
   loop
   fetch c1 into m_drcr_txn_code, m_drcr_doc_no, m_drcr_cust_code,
        	 m_drcr_pol_no, m_drcr_claim_no, m_drcr_end_no,
		 m_drcr_int_ent_yn, m_drcr_pol_sys_Id,
                 m_drcr_end_no_Idx ;
   exit when c1%notfound ;
   open c2 ;
   fetch c2 into m_cust_bl_contact ;
   close c2;
   open c3 ;
   fetch c3 into m_pr_Dept_code, m_pr_assured_name,m_sc_name ;
   close c3 ;
   IF NVL(M_CUST_BL_CONTACT,'A') != 'E' THEN
Press <Enter> to continue...
         IF M_DRCR_END_NO IS NULL AND M_DRCR_CLAIM_NO IS NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
                               ' ' || M_DRCR_POL_NO ;
         ELSIF M_DRCR_CLAIM_NO IS NOT NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
	                      ' ' || M_DRCR_POL_NO ||
                               '  ' || M_DRCR_CLAIM_NO ;
         ELSIF M_DRCR_END_NO IS NOT NULL AND M_DRCR_CLAIM_NO IS NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
                               ' ' || M_DRCR_POL_NO ||
                               '  ' || M_DRCR_END_NO ;
         END IF;
-- For Policies of Inward Dept. Assured Name to be included (18-MAR-97)
         IF M_PR_DEPT_CODE = '50' THEN
            M_DRCR_NARRATION := M_DRCR_NARRATION || CHR(10) ||
                                M_PR_ASSURED_NAME ;
         END IF ;
      ELSE
         IF M_DRCR_END_NO IS NULL AND M_DRCR_CLAIM_NO IS NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
                               ' ' || M_DRCR_POL_NO ;
         ELSIF M_DRCR_CLAIM_NO IS NOT NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
	                       ' ' || M_DRCR_POL_NO ||
                               ' Clm. ' || M_DRCR_CLAIM_NO ;
         ELSIF M_DRCR_END_NO IS NOT NULL AND M_DRCR_CLAIM_NO IS NULL THEN
            M_DRCR_NARRATION := M_SC_NAME ||
                               ' ' || M_DRCR_POL_NO ||
                               ' Endt. ' || M_DRCR_END_NO ;
         END IF;
         IF M_PR_DEPT_CODE = '50' THEN
            M_DRCR_NARRATION := M_DRCR_NARRATION || CHR(10) ||
                                M_PR_ASSURED_NAME ;
         END IF ;
      END IF ;
  update ft_cur_trans_header
  set th_desc = m_drcr_narration
  where th_comp_code = '001'
  and th_tran_code = m_drcr_txn_code
  and th_doc_no = m_drcr_doc_no ;
  update ft_cur_trans_detail
  set td_desc = m_drcr_narration
  where td_comp_code = '001'
  and td_tran_code = m_drcr_txn_code
  and td_doc_no = m_drcr_doc_no ;
  m_ctr := m_ctr + 1 ;
  if mod(m_ctr,100) = 0 then
     commit ;
     select to_char(sysdate, 'hh24:mi:ss')
     into m_time from dual ;
  end if ;
  if mod(m_ctr,10000) = 0 then
     select to_char(sysdate, 'hh24:mi:ss')
     into m_time from dual ;
     dbms_output.put_line(to_char(m_ctr) || ' rows updated at' ||
                          m_time) ;
  end if ;
  end loop ; -- end of Cursor c1
  close c1 ;
   commit ;
   select to_char(sysdate, 'hh24:mi:ss')
   into m_time from dual ;
   dbms_output.put_line('Procedure completed  at' || m_time ||
                        ' -  ' || to_char(m_ctr) || ' rows updated' ) ;
end;
/
CREATE OR REPLACE PROCEDURE UPDTH
is
cursor c1 is
select distinct drcr_txn_code, drcr_doc_no,drcr_dept_code
from   ps_drcr
where  nvl(drcr_post_yn,'N') = 'Y'
and    nvl(drcr_int_ent_yn,'N') = 'Y';
m_drcr_txn_code varchar2(6);
m_drcr_doc_no   number(6);
m_drcr_dept_code varchar2(6);
ctr  number := 0 ;
begin
  open c1;
  loop
  fetch c1 into  m_drcr_txn_code, m_drcr_doc_no, m_drcr_dept_code ;
  if c1%notfound then
     exit ;
  end if;
  update ft_cur_trans_header
  set    th_dept_code = m_drcr_dept_code
  where  th_comp_code = '001'
  and    th_acnt_year = 2
  and    th_tran_code = m_drcr_txn_code
  and    th_doc_no    = m_drcr_doc_no  ;
  ctr := ctr + 1 ;
  end loop;
  close c1;
  dbms_output.put_line(to_char(ctr) || ' rows updated') ;
end;
/
CREATE OR REPLACE PROCEDURE UPD_FT_CUR_TRANS_DETAIL
is
m_th_tran_code varchar2(3);
m_th_doc_no number ;
m_th_desc varchar2(2000) ;
ctr number := 0;
cursor c1 is
	select th_tran_code, th_doc_no,th_desc
	from ft_cur_trans_header
	where (th_tran_code, th_doc_no) in
        (select drcr_txn_code, drcr_doc_no
         from ps_Drcr) ;
cursor c2 (m_th_tran_code in varchar2, m_th_doc_no in number)is
	select td_tran_code, td_doc_no
	from ft_cur_trans_detail
	where td_tran_code = m_th_tran_code
	and   td_doc_no =  m_th_doc_no
	and   td_sub_acnt_code is not null
        for update of td_desc ;
begin
  for c1_rec in c1
  loop
     m_th_tran_code := c1_rec.th_tran_code ;
     m_th_doc_no := c1_rec.th_doc_no ;
     m_th_desc := c1_rec.th_desc ;
     for c2_rec in c2 (m_th_tran_code, m_th_doc_no)
     loop
        update ft_cur_trans_detail set td_desc = m_th_desc
        where current of c2 ;
     ctr := ctr + 1;
     end loop ;
  end loop;
  commit;
  dbms_output.put_line(to_char(ctr) || ' rows committed');
end;
/
CREATE OR REPLACE PROCEDURE UPD_TTY IS
m_pol_sys_Id  pt_policy.pol_sys_Id%type ;
m_fo_sys_Id   pt_fac_out.fo_sys_Id%type ;
m_risk_sys_id pt_risk.risk_sys_Id%type ;
m_risk_class  pt_risk.risk_class%type ;
ctr1 number := 0;
ctr2 number := 0;
ctr3 number := 0;
ctr4 number := 0;
cursor c1 is
       select pol_sys_Id
       from pt_policy
       where   pol_ri_basis = 'P'
       and   exists (select 1 from pt_fac_out
                     where  fo_pol_sys_Id = pol_sys_Id
                     and fo_risk_sys_Id = 0
                     union
                     select 1 from ph_Fac_out
                     where foh_pol_sys_Id = pol_sys_Id
                     and foh_risk_sys_Id = 0 ) ;
cursor c2(m_pol_sys_Id in varchar2) is
       select fo_sys_Id
       from   pt_fac_out
       where  fo_pol_sys_id = m_pol_sys_Id ;
cursor c3 is
       select pol_sys_Id
       from pt_policy
       where pol_ri_basis = 'R'
       and   pol_sys_Id != 5390
       and   exists (select 1 from pt_fac_out
                     where  fo_pol_sys_Id = pol_sys_Id
                     and nvl(fo_risk_sys_Id,0) = 0
                     union
                     select 1 from ph_Fac_out
                     where foh_pol_sys_Id = pol_sys_Id
                     and nvl(foh_risk_sys_Id,0) = 0 ) ;
cursor c4(m_pol_sys_Id in number) is
       select risk_sys_Id, risk_class
       from pt_risk
       where risk_pol_sys_Id = m_pol_sys_Id ;
cursor c5(m_pol_sys_Id in varchar2) is
       select fo_sys_Id
       from   pt_fac_out
       where  fo_pol_sys_id = m_pol_sys_Id ;
begin
   for c1_rec in c1
   loop
      m_pol_sys_Id := c1_rec.pol_sys_Id ;
      update pt_Fac_out
      set    fo_risk_sys_Id = m_pol_sys_Id
      where  fo_pol_sys_Id = m_pol_sys_Id ;
      update ph_Fac_out
      set    foh_risk_sys_Id = m_pol_sys_Id
      where  foh_pol_sys_Id = m_pol_sys_Id ;
      ctr1 := ctr1 + 1 ;
      for c2_rec in c2(m_pol_sys_Id)
      loop
         m_fo_sys_Id := c2_rec.fo_sys_Id ;
         update pt_fac_part_cust
         set    fpcu_risk_sys_id = m_pol_sys_id
         where  fpcu_fo_sys_id = m_fo_sys_Id ;
         update ph_fac_part_cust
         set    fpcuh_risk_sys_id = m_pol_sys_id
         where  fpcuh_fo_sys_id = m_fo_sys_Id ;
      ctr2 := ctr2 + 1 ;
      end loop ;
      update ps_fac_ri set fr_risk_sys_Id = m_pol_sys_Id
      where  fr_pol_sys_Id = m_pol_sys_Id;
      update pt_ri_cession set rc_risk_sys_Id = m_pol_sys_Id
      where  rc_pol_sys_Id = m_pol_sys_Id;
      update pt_ri_prem_alloc set rpa_risk_sys_Id = m_pol_sys_Id
      where  rpa_pol_sys_Id = m_pol_sys_Id;
      update pt_xl_prem_alloc set xpa_risk_sys_Id = m_pol_sys_Id
      where  xpa_pol_sys_Id = m_pol_sys_Id;
      if mod(ctr1,500) = 0 then
         commit ;
         dbms_output.put_line (to_char(ctr1) || ' rows committed');
      end if ;
   end loop ;
   commit ;
   dbms_output.put_line (to_char(ctr2) || ' rows update in PT_FAC_PART_CUST');
   dbms_output.put_line (to_char(ctr1) || ' rows update in PT_FAC_OUT');
---
   for c3_rec in c3
   loop
      m_pol_sys_Id := c3_rec.pol_sys_Id ;
      open c4 (m_pol_sys_id);
      fetch c4 into  m_risk_sys_Id, m_risk_class ;
      close c4 ;
      update pt_Fac_out
      set    fo_risk_sys_Id = m_risk_sys_Id,
             fo_risk_id     = m_risk_class
      where  fo_pol_sys_Id = m_pol_sys_Id ;
      update ph_Fac_out
      set    foh_risk_sys_Id = m_risk_sys_Id,
             foh_risk_id     = m_risk_class
      where  foh_pol_sys_Id  = m_pol_sys_Id ;
      ctr3 := ctr3 + 1 ;
      for c5_rec in c5(m_pol_sys_Id)
      loop
         m_fo_sys_Id := c5_rec.fo_sys_Id ;
         update pt_fac_part_cust
         set    fpcu_risk_sys_id = m_risk_sys_id
         where  fpcu_fo_sys_id = m_fo_sys_Id ;
         update ph_fac_part_cust
         set    fpcuh_risk_sys_id = m_risk_sys_id
         where  fpcuh_fo_sys_id = m_fo_sys_Id ;
      ctr4 := ctr4 + 1 ;
      end loop ;
      update ps_fac_ri set fr_risk_sys_Id = m_risk_sys_Id ,
                           fr_risk_Id     = m_risk_class
      where  fr_pol_sys_Id = m_pol_sys_Id;
      update pt_ri_cession set rc_risk_sys_Id = m_risk_sys_Id ,
                               rc_risk_Id     = m_risk_class
       where  rc_pol_sys_Id = m_pol_sys_Id;
      update pt_ri_prem_alloc set rpa_risk_sys_Id = m_risk_sys_Id ,
                                  rpa_risk_Id     = m_risk_class
      where  rpa_pol_sys_Id = m_pol_sys_Id;
      update pt_xl_prem_alloc set xpa_risk_sys_Id = m_risk_sys_Id ,
                                  xpa_risk_Id     = m_risk_class
      where  xpa_pol_sys_Id = m_pol_sys_Id;
      if mod(ctr3,100) = 0 then
         commit ;
         dbms_output.put_line (to_char(ctr3) || ' rows committed (Risk Based)');
      end if ;
   end loop ;
   commit ;
   dbms_output.put_line (to_char(ctr4) || ' rows update in PT_FAC_PART_CUST(Risk Based)');
   dbms_output.put_line (to_char(ctr3) || ' rows update in PT_FAC_OUT(Risk Based)');
end;
/
